"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[3322],{43501:function(e,t,i){i.d(t,{a:function(){return u},e:function(){return h},i:function(){return c},n:function(){return f}});var r=i(37762),n=i(74165),a=i(15671),s=i(43144),o=i(93661),u=function(){function e(t){if((0,a.Z)(this,e),this.next=null,Array.isArray(t)){this.data=t[0];for(var i=this,r=1;r<t.length;r++)i.next=new e([t[r]]),i=i.next}else this.data=t}return(0,s.Z)(e,[{key:"values",value:(0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this;case 1:if(!t){e.next=7;break}return e.next=4,t.data;case 4:t=t.next;case 5:e.next=1;break;case 7:case"end":return e.stop()}}),e,this)}))},{key:"forEach",value:function(e){for(var t=this;t;)e(t.data),t=t.next}},{key:"find",value:function(e){var t;return e(this.data)?this:null===(t=this.next)||void 0===t?void 0:t.find(e)}},{key:"max",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this,i=e(this.data)>e(t.data)?this:t;return this.next?this.next.max(e,i):i}},{key:"remove",value:function(e){var t,i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this===e?r?(r.next=this.next,r):this.next:null!==(t=null===(i=this.next)||void 0===i?void 0:i.remove(e,this))&&void 0!==t?t:null}},{key:"last",get:function(){return this.next?this.next.last:this}}]),e}(),h=function(){function e(t){(0,a.Z)(this,e),this._head=null,(0,o.t)(t)||(this._head=new u(t))}return(0,s.Z)(e,[{key:"head",get:function(){return this._head}},{key:"maxAvailableSpace",value:function(){if((0,o.t)(this._head))return 0;var e=this._head.max((function(e){return e.end-e.start}));return e.data.end-e.data.start}},{key:"firstFit",value:function(e){if((0,o.t)(this._head))return null;for(var t=null,i=this._head;i;){var r=i.data.end-i.data.start;if(r===e)return t?t.next=i.next:this._head=i.next,i.data.start;if(r>e){var n=i.data.start;return i.data.start+=e,n}t=i,i=i.next}return null}},{key:"free",value:function(e,t){var i=e+t;if((0,o.t)(this._head)){var r=new u({start:e,end:i});this._head=r}else{if(i<=this._head.data.start){if(i===this._head.data.start)return void(this._head.data.start-=t);var n=new u({start:e,end:i});return n.next=this._head,void(this._head=n)}for(var a=this._head,s=a.next;s;){if(s.data.start>=i){if(a.data.end===e){if(a.data.end+=t,a.data.end===s.data.start){var h=s.data.end-s.data.start;return a.data.end+=h,void(a.next=s.next)}return}if(s.data.start===i)return void(s.data.start-=t);var l=new u({start:e,end:i});return l.next=a.next,void(a.next=l)}a=s,s=s.next}if(e!==a.data.end){var c=new u({start:e,end:i});a.next=c}else a.data.end+=t}}}]),e}(),l=(0,o.h)("esri-2d-log-allocations"),c=function(){function e(t,i){(0,a.Z)(this,e),this._array=t,this._pool=i}return(0,s.Z)(e,[{key:"array",get:function(){return this._array}},{key:"length",get:function(){return this._array.length}},{key:"expand",value:function(e){var t=this._pool.acquire(e);t.set(this._array),this._pool.release(this._array),this._array=t}},{key:"destroy",value:function(){this._pool.release(this._array)}},{key:"set",value:function(e,t){this._array.set(e._array,t)}},{key:"slice",value:function(){var t=this._pool.acquire(this._array.byteLength);return t.set(this._array),new e(t,this._pool)}}],[{key:"create",value:function(t,i){return new e(i.acquire(t),i)}}]),e}(),d=function(){function e(){(0,a.Z)(this,e),this._data=new ArrayBuffer(e.BYTE_LENGTH),this._freeList=new h({start:0,end:this._data.byteLength})}return(0,s.Z)(e,[{key:"buffer",get:function(){return this._data}},{key:"allocate",value:function(e){var t=this._freeList.firstFit(e);return(0,o.t)(t)?null:new Uint32Array(this._data,t,e/Uint32Array.BYTES_PER_ELEMENT)}},{key:"free",value:function(e){this._freeList.free(e.byteOffset,e.byteLength)}}],[{key:"BYTE_LENGTH",get:function(){return 64e6}}]),e}(),f=function(){function e(){(0,a.Z)(this,e),this._bytesAllocated=0,this._pages=[],this._pagesByBuffer=new Map,this._addPage()}return(0,s.Z)(e,[{key:"destroy",value:function(){this._pages=[],this._pagesByBuffer=null}},{key:"_bytesTotal",get:function(){return this._pages.length*d.BYTE_LENGTH}},{key:"acquire",value:function(e){if(this._bytesAllocated+=e,l&&console.log("Allocating ".concat(e,", (").concat(this._bytesAllocated," / ").concat(this._bytesTotal,")")),e>d.BYTE_LENGTH)return new Uint32Array(e/Uint32Array.BYTES_PER_ELEMENT);var t,i=(0,r.Z)(this._pages);try{for(i.s();!(t=i.n()).done;){var n=t.value.allocate(e);if((0,o.r)(n))return n}}catch(a){i.e(a)}finally{i.f()}return(0,o.i)(this._addPage().allocate(e),"Expected to allocate page")}},{key:"release",value:function(e){this._bytesAllocated-=e.byteLength,l&&console.log("Freeing ".concat(e.byteLength,", (").concat(this._bytesAllocated," / ").concat(this._bytesTotal,")"));var t=this._pagesByBuffer.get(e.buffer);t&&t.free(e)}},{key:"_addPage",value:function(){var e=new d;return this._pages.push(e),this._pagesByBuffer.set(e.buffer,e),e}}]),e}()},13385:function(e,t,i){i.d(t,{s:function(){return o}});var r=i(37762),n=i(15671),a=i(43144),s=i(93661),o=function(){function e(t){(0,n.Z)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return(0,a.Z)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,i=(0,r.Z)(this._buffer);try{for(i.s();!(t=i.n()).done;){var n=t.value;if((0,s.r)(n)&&e(n))return n}}catch(a){i.e(a)}finally{i.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,s.r)(t);)e&&e(t),t=this.dequeue()}}]),e}()},33371:function(e,t,i){i.d(t,{i:function(){return l}});var r=i(15671),n=i(43144),a=i(11752),s=i(61120),o=i(60136),u=i(29388),h=i(1206),l=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){return(0,r.Z)(this,i),t.apply(this,arguments)}return(0,n.Z)(i,[{key:"renderChildren",value:function(e){this.attributeView.update(),this.children.some((function(e){return e.hasData}))&&(this.attributeView.bindTextures(e.context,!1),(0,a.Z)((0,s.Z)(i.prototype),"renderChildren",this).call(this,e),e.drawPhase===h.I.MAP&&this._renderChildren(e),this.hasHighlight()&&e.drawPhase===h.I.HIGHLIGHT&&this._renderHighlight(e),this._boundsRenderer&&this._boundsRenderer.doRender(e))}},{key:"_renderHighlight",value:function(e){var t=e.painter.effects.highlight;t.bind(e),this._renderChildren(e,t.defines),t.draw(e),t.unbind()}}]),i}(i(35202).t)},64623:function(e,t,i){i.d(t,{o:function(){return o}});var r=i(6994),n=i(55020),a=function(e){var t="";t+=e[0].toUpperCase();for(var i=1;i<e.length;i++){var r=e[i];r===r.toUpperCase()?(t+="_",t+=r):t+=r.toUpperCase()}return t},s=function(e){var t={};for(var i in e)t[a(i)]=e[i];return(0,n.n)(t)},o=function(e,t,i,n){var a=e+e.substring(e.lastIndexOf("/")),o=t+t.substring(t.lastIndexOf("/")),u=s(n);return{attributes:i,shaders:{vertexShader:u+(0,r.n)("".concat(a,".vert")),fragmentShader:u+(0,r.n)("".concat(o,".frag"))}}}},75257:function(e,t,i){var r,n,a,s,o;i.d(t,{I:function(){return n},L:function(){return o},T:function(){return s}}),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FILL_VERTEX=1]="FILL_VERTEX",e[e.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",e[e.FILL_INDEX=3]="FILL_INDEX",e[e.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",e[e.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",e[e.OUTLINE_INDEX=6]="OUTLINE_INDEX",e[e.LINE_VERTEX=7]="LINE_VERTEX",e[e.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",e[e.LINE_INDEX=9]="LINE_INDEX",e[e.ICON_VERTEX=10]="ICON_VERTEX",e[e.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",e[e.ICON_INDEX=12]="ICON_INDEX",e[e.TEXT_VERTEX=13]="TEXT_VERTEX",e[e.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",e[e.TEXT_INDEX=15]="TEXT_INDEX",e[e.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",e[e.CIRCLE_INDEX=17]="CIRCLE_INDEX"}(r||(r={})),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(n||(n={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.OPAQUE=1]="OPAQUE",e[e.TRANSLUCENT=2]="TRANSLUCENT",e[e.SYMBOLS=3]="SYMBOLS",e[e.HITTEST=4]="HITTEST"}(a||(a={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(s||(s={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(o||(o={}))},16599:function(e,t,i){i.d(t,{e:function(){return a},r:function(){return s}});var r=null,n=!0;function a(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t)}catch(o){n=!1}return u(e,t,i)}function s(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(n)try{return new ImageData(e,t,i)}catch(s){n=!1}var a=u(t,i,r);return a.data.set(e,0),a}function o(){return r||((r=document.createElement("canvas")).width=1,r.height=1),r}function u(e,t,i){return i||(i=o()),i.getContext("2d").createImageData(e,t)}},83322:function(e,t,i){i.r(t),i.d(t,{GraphicContainer:function(){return le.i},GraphicsView2D:function(){return he.o},LabelManager:function(){return ei},MagnifierView2D:function(){return Ti},MapViewNavigation:function(){return bi},Stage:function(){return Vt}});var r=i(93433),n=i(97326),a=i(11752),s=i(61120),o=i(60136),u=i(29388),h=i(29439),l=i(74165),c=i(15861),d=i(37762),f=i(4942),_=i(1413),p=i(15671),v=i(43144),m=i(48848),g=i(93661),y=i(50690),b=i(43066),w=i(13623),T=i(84234),x=i(43501),E=i(1206),k=i(6994),M=i(43830),R=i(1797),B=i(31698),F=i(93122),O=i(4679),P=i(64623),S=i(40558),C=i(82017),I=i(91242),D=i(77956),Z=i(29048),A=i(68136),L=i(18144),z=i(36748),N=i(75833),U=i(35182),G=i(25217),V=i(74337),H=i(54233),q=i(63504),X=i(5430),W=i(27205),Y=i(71802),j=i(26313),K=i(13239),Q=i(11448),J=i(13385),$=i(37856),ee=i(70285),te=i(21932),ie=i(32043),re=i(16599),ne=i(630),ae=i(98598),se=i(62399),oe=i(15529),ue=i(84186),he=i(35202),le=i(33371),ce=i(17455),de=i(82474),fe=(i(74384),i(4397)),_e=i(59389),pe=i(64095),ve=(i(92770),i(13171),i(72448),i(18030),i(33795),i(48200),i(79557),i(5650),i(35602),i(26151),i(91681),i(89794),i(7131),i(92739),i(44954),i(40114),i(60491),i(87917),i(52559),i(56162),i(46817),i(62466),i(75257),i(62312),i(59984),i(21438),i(25456),i(70607),i(63999),i(45184),i(43924),i(97880),i(65703),i(51732),i(66911),i(33563),i(64419),i(35237),i(89181),i(20302),i(69641),i(15436),i(69768),i(62610),i(10309),i(75255),i(55944),i(64854),i(39926),i(6762),i(20675),i(93116),i(65094),i(46337),i(22603),i(85113),i(46737),i(53586),i(52113),i(53921),i(70863),i(57791),i(10464),i(64998),i(25577),i(93314),i(15751),i(60369),i(92072),i(37944),i(86086),i(21385),i(85253),i(93209),i(81556),i(90316),i(95249),i(47855),i(65415),i(3356),i(15870),i(36584),i(42467),i(42667),i(61118),i(45999),i(39769),i(95643),i(43976),i(85700),i(51219),i(66577),i(2959),i(2821),i(33794),i(71147),i(70449),i(56546),i(8141),i(3719),i(32161),i(37686),i(16641),i(21015),i(62642),i(19891),i(23585),i(82396),i(47748),i(70522),i(1685),i(17332),i(50253),i(43955),i(1500),i(19941),i(39994),i(49871),i(63212),i(69717),i(53409),i(51816),i(68781),i(35865),i(90429),i(95399),i(98987),i(99795),i(87753),i(29130),i(12953),i(74797),i(72973),i(62710),i(52721),i(61903),i(23444),i(40811),i(51920),i(63393),i(90442),i(24623),i(64264),i(6379),i(23341),i(41820),i(20086),i(92982),i(61416),i(77880),i(74494),i(77755),i(71645),i(89311),i(67066),i(44513),i(23075),i(62753),i(83948),i(35496),i(26789),i(17327),i(50796),i(18007),i(95415),i(88659),i(87424),i(95414),{shaders:{vertexShader:(0,k.n)("bitBlit/bitBlit.vert"),fragmentShader:(0,k.n)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])}),me=function(){function e(){(0,p.Z)(this,e),this._initialized=!1}return(0,v.Z)(e,[{key:"dispose",value:function(){this._program=(0,g.G)(this._program),this._vertexArrayObject=(0,g.G)(this._vertexArrayObject)}},{key:"render",value:function(e,t,i,r){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA,F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),e.drawArrays(F.E.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=(0,O.e)(e,ve);if(!t)return!1;var i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;var r=ve.attributes,n=new B.b(e,r,R.t,{geometry:B.E.createVertex(e,F.F.STATIC_DRAW,i)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),ge=function(e){return e===E.I.HITTEST||e===E.I.LABEL_ALPHA},ye=function(e,t,i,r){var n=e.rendererInfo,a=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(r.join("."),"-").concat(function(e){return(ge(e)?1:0)|(e===E.I.HIGHLIGHT?2:0)}(a),"-").concat(n.getVariationHash(),"-").concat((0,g.r)(i)&&i.join("."))},be=function(e,t,i,r){var n=r.reduce((function(t,i){return(0,_.Z)((0,_.Z)({},t),{},(0,f.Z)({},i,e.context.driverTest[i]))}),{}),a=(0,_.Z)((0,_.Z)((0,_.Z)({},t.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===E.I.HIGHLIGHT,id:ge(e.drawPhase)},n);if((0,g.r)(i)){var s,o=(0,d.Z)(i);try{for(o.s();!(s=o.n()).done;){a[s.value]=!0}}catch(u){o.e(u)}finally{o.f()}}return a},we=function(){function e(t){(0,p.Z)(this,e),this._rctx=t,this._programByKey=new Map}return(0,v.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getProgram",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=e.vsPath+"."+e.fsPath+JSON.stringify(i)+r.join(".");if(this._programByKey.has(n))return this._programByKey.get(n);var a=r.reduce((function(e,i){return(0,_.Z)((0,_.Z)({},e),{},(0,f.Z)({},i,t._rctx.driverTest[i]))}),{}),s=(0,_.Z)((0,_.Z)({},i.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,t){return(0,_.Z)((0,_.Z)({},e),{},(0,f.Z)({},t.name,t.value))}),{})),a),o=e.vsPath,u=e.fsPath,h=e.attributes,l=(0,P.o)(o,u,h,s),c=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(n,c),c}},{key:"getMaterialProgram",value:function(e,t,i,r,n){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:["ignoresSamplerPrecision"],s=ye(e,t,n,a);if(this._programByKey.has(s))return this._programByKey.get(s);var o=be(e,t,n,a),u=(0,P.o)(i,i,r,o),h=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,h),h}}]),e}(),Te=function(){function e(t,i){(0,p.Z)(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new z.t(0,0,t,i))}return(0,v.Z)(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new z.t;for(var i=null,r=-1,n=0;n<this._free.length;++n){var a=this._free[n];e<=a.width&&t<=a.height&&(null===i||a.y<=i.y&&a.x<=i.x)&&(i=a,r=n)}return null===i?new z.t:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new z.t(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new z.t(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new z.t(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new z.t(i.x,i.y+t,e,i.height-t))),new z.t(i.x,i.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}(),xe=function(e){return Math.floor(e/256)};function Ee(e){var t,i=new Set,r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i.add(xe(n))}}catch(a){r.e(a)}finally{r.f()}return i}function ke(e,t,i){return e.has(t)||e.set(t,i().then((function(){e.delete(t)})).catch((function(i){e.delete(t),(0,m.ag)(i)}))),e.get(t)}var Me=function(){function e(t,i,r){(0,p.Z)(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=r,this._binPack=new Te(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}return(0,v.Z)(e,[{key:"dispose",value:function(){this._binPack=null;var e,t=(0,d.Z)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0,this._glyphData.length=0}},{key:"_initDecorationGlyph",value:function(){for(var e=[117,149,181,207,207,181,149,117],t=[],i=0;i<e.length;i++)for(var r=e[i],n=0;n<11;n++)t.push(r);var a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(a)}},{key:"getGlyphItems",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getGlyphCache(t),e.next=3,this._fetchRanges(t,i,r);case 3:return e.abrupt("return",i.map((function(e){return a._getMosaicItem(n,t,e)})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"bind",value:function(e,t,i,r){var n=this._getTexture(e,i);n.setSamplingMode(t),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(n,r)}},{key:"_getGlyphCache",value:function(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}},{key:"_getTexture",value:function(e,t){return this._textures[t]||(this._textures[t]=new N.E(e,{pixelFormat:F.P.ALPHA,dataType:F.G.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}},{key:"_invalidate",value:function(){this._dirties[this._currentPage]=!0}},{key:"_fetchRanges",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Ee(i),a=[],n.forEach((function(e){a.push(s._fetchRange(t,e,r))})),e.next=4,Promise.all(a);case 4:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_fetchRange",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i>256)){e.next=2;break}return e.abrupt("return",null);case 2:return n=t+i,e.abrupt("return",ke(this._rangePromises,n,(function(){return a._glyphSource.getRange(t,i,r)})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_getMosaicItem",value:function(e,t,i){if(!e[i]){var r=this._glyphSource.getGlyph(t,i);if(!r||!r.metrics)return function(e){return{rect:new z.t(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0}}(i);var n=this._recordGlyph(r),a=this._currentPage,s=r.metrics;e[i]={rect:n,page:a,metrics:s,code:i,sdf:!0},this._invalidate()}return e[i]}},{key:"_recordGlyph",value:function(e){var t,i=e.metrics;if(0===i.width)t=new z.t(0,0,0,0);else{var r=i.width+6,n=i.height+6;(t=this._binPack.allocate(r,n)).isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new Te(this.width-4,this.height-4),t=this._binPack.allocate(r,n));var a,s,o=this._glyphData[this._currentPage],u=e.bitmap;if(u)for(var h=0;h<n;h++){a=r*h,s=this.width*(t.y+h)+t.x;for(var l=0;l<r;l++)o[s+l]=u[a+l]}(0,g.h)("esri-glyph-debug")&&this._showDebugPage(o)}return t}},{key:"_showDebugPage",value:function(e){var t=document.createElement("canvas"),i=t.getContext("2d"),r=new ImageData(this.width,this.height),n=r.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(var a=0;a<e.length;++a)n[4*a+0]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(r,0,0),document.body.appendChild(t)}}]),e}(),Re=function(){function e(t){for((0,p.Z)(this,e),this._metrics=[],this._bitmaps=[];t.next();)if(1===t.tag()){for(var i=t.getMessage();i.next();)if(3===i.tag()){for(var r=i.getMessage(),n=void 0,a=void 0,s=void 0,o=void 0,u=void 0,h=void 0,l=void 0;r.next();)switch(r.tag()){case 1:n=r.getUInt32();break;case 2:a=r.getBytes();break;case 3:s=r.getUInt32();break;case 4:o=r.getUInt32();break;case 5:u=r.getSInt32();break;case 6:h=r.getSInt32();break;case 7:l=r.getUInt32();break;default:r.skip()}r.release(),n&&(this._metrics[n]={width:s,height:o,left:u,top:h,advance:l},this._bitmaps[n]=a)}else i.skip();i.release()}else t.skip()}return(0,v.Z)(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),Be=function(){function e(){(0,p.Z)(this,e),this._ranges=[]}return(0,v.Z)(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),Fe=function(){function e(t){(0,p.Z)(this,e),this._glyphInfo={},this._baseURL=t}return(0,v.Z)(e,[{key:"getRange",value:function(e,t,i){var r=this._getFontStack(e);if(r.getRange(t))return Promise.resolve();var n=256*t,a=n+255,s=this._baseURL.replace("{fontstack}",e).replace("{range}",n+"-"+a);return(0,S.U)(s,(0,_.Z)({responseType:"array-buffer"},i)).then((function(e){r.addRange(t,new Re(new U.n(new Uint8Array(e.data),new DataView(e.data))))}))}},{key:"getGlyph",value:function(e,t){var i=this._getFontStack(e);if(i){var r=Math.floor(t/256);if(!(r>256)){var n=i.getRange(r);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Be),t}}]),e}(),Oe=1e20,Pe=function(){function e(t){(0,p.Z)(this,e),this._svg=null,this.size=t;var i=document.createElement("canvas");i.width=i.height=t,this._context=i.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}return(0,v.Z)(e,[{key:"dispose",value:function(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}},{key:"draw",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:31;this._initSVG();var n=this.createSVGString(e);return new Promise((function(e,a){var s=new Image;s.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n),s.onload=function(){s.onload=null,i._context.clearRect(0,0,i.size,i.size),i._context.drawImage(s,0,0,i.size,i.size);for(var t=i._context.getImageData(0,0,i.size,i.size),n=new Uint8Array(i.size*i.size*4),a=0;a<i.size*i.size;a++){var o=t.data[4*a+3]/255;i._gridOuter[a]=1===o?0:0===o?Oe:Math.pow(Math.max(0,.5-o),2),i._gridInner[a]=1===o?Oe:0===o?0:Math.pow(Math.max(0,o-.5),2)}i._edt(i._gridOuter,i.size,i.size),i._edt(i._gridInner,i.size,i.size);for(var u=0;u<i.size*i.size;u++){var h=i._gridOuter[u]-i._gridInner[u];(0,G.o)(.5-h/(2*r),n,4*u)}e(n)};var o=t&&t.signal;o&&(0,m.v)(o,(function(){return a((0,m.d)())}))}))}},{key:"_initSVG",value:function(){if(!this._svg){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}return this._svg}},{key:"createSVGString",value:function(e){var t=this._initSVG(),i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",e),t.appendChild(i);var r,n,a,s,o=i.getBBox(),u=o.width/o.height,h=this.size/2;if(u>1){n=r=h/o.width;var l=h*(1/u);a=this.size/4,s=h-l/2}else r=n=h/o.height,a=h-h*u/2,s=this.size/4;var c=-o.x*r+a,d=-o.y*n+s;i.setAttribute("style","transform: matrix(".concat(r,", 0, 0, ").concat(n,", ").concat(c,", ").concat(d,")"));var f='<svg style="fill:red;" height="'.concat(this.size,'" width="').concat(this.size,'" xmlns="http://www.w3.org/2000/svg">').concat(t.innerHTML,"</svg>");return t.removeChild(i),f}},{key:"_edt",value:function(e,t,i){for(var r=this._f,n=this._d,a=this._v,s=this._z,o=0;o<t;o++){for(var u=0;u<i;u++)r[u]=e[u*t+o];this._edt1d(r,n,a,s,i);for(var h=0;h<i;h++)e[h*t+o]=n[h]}for(var l=0;l<i;l++){for(var c=0;c<t;c++)r[c]=e[l*t+c];this._edt1d(r,n,a,s,t);for(var d=0;d<t;d++)e[l*t+d]=Math.sqrt(n[d])}}},{key:"_edt1d",value:function(e,t,i,r,n){i[0]=0,r[0]=-Oe,r[1]=+Oe;for(var a=1,s=0;a<n;a++){for(var o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);o<=r[s];)s--,o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);i[++s]=a,r[s]=o,r[s+1]=+Oe}for(var u=0,h=0;u<n;u++){for(;r[h+1]<u;)h++;t[u]=(u-i[h])*(u-i[h])+e[i[h]]}}}]),e}();function Se(e){return e&&"static"===e.type}var Ce=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,p.Z)(this,e),this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,r>0&&(this._maxItemSize=r),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Te(this._pageWidth,this._pageHeight);var n=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}return(0,v.Z)(e,[{key:"getWidth",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}},{key:"getHeight",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}},{key:"getPageTexture",value:function(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}},{key:"has",value:function(e){return this._mosaicRects.has(e)}},{key:"itemCount",get:function(){return this._mosaicRects.size}},{key:"getSpriteItem",value:function(e){return this._mosaicRects.get(e)}},{key:"addSpriteItem",value:function(e,t,i,r,n,a){var s,o,u,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;if(this._mosaicRects.has(e))return this._mosaicRects.get(e);if(Se(i)){var c=this._allocateImage(t[0],t[1]),d=(0,h.Z)(c,3);s=d[0],o=d[1],u=d[2]}else{s=new z.t(0,0,t[0],t[1]),o=this._mosaicPages.length;var f=void 0;this._mosaicPages.push({mosaicsData:i,size:[t[0]+2*L.a,t[1]+2*L.a],dirty:!0,texture:f})}if(s.width<=0||s.height<=0)return null;var _={rect:s,width:t[0],height:t[1],sdf:n,simplePattern:a,pixelRatio:l,page:o};return this._mosaicRects.set(e,_),Se(i)&&this._copy({rect:s,spriteSize:t,spriteData:i.data,page:o,pageSize:u,repeat:r,sdf:n}),_}},{key:"hasItemsToProcess",value:function(){return 0!==this._spriteCopyQueue.length}},{key:"processNextItem",value:function(){var e=this._spriteCopyQueue.pop();e&&this._copy(e)}},{key:"getSpriteItems",value:function(e){var t,i={},r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i[n]=this.getSpriteItem(n)}}catch(a){r.e(a)}finally{r.f()}return i}},{key:"getMosaicItemPosition",value:function(e){var t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;var r=t.width,n=t.height,a=L.a,s=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+a)/s[0],(i.y+a)/s[1]],br:[(i.x+a+r)/s[0],(i.y+a+n)/s[1]],page:t.page}}},{key:"bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=this._mosaicPages[i],a=n.mosaicsData,s=n.texture;s||(s=Ie(e,a,n.size),n.texture=s),s.setSamplingMode(t),Se(a)?(e.bindTexture(s,r),n.dirty&&(s.setData(new Uint8Array(a.data.buffer)),s.generateMipmap())):a.data.bindFrame(e,s,r),n.dirty=!1}},{key:"_copy",value:function(t){if(!(t.page>=this._mosaicPages.length)){var i=this._mosaicPages[t.page],r=i.mosaicsData;if(!Se(i.mosaicsData))throw new m.s("mapview-invalid-resource","unsuitable data type!");var n=t.spriteData,a=r.data;a&&n||console.error("Source or target images are uninitialized!"),e._copyBits(n,t.spriteSize[0],0,0,a,t.pageSize[0],t.rect.x+L.a,t.rect.y+L.a,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0}}},{key:"_allocateImage",value:function(e,t){e+=2*L.a,t+=2*L.a;var i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){var r=Math.pow(2,Math.ceil((0,V.P)(e))),n=Math.pow(2,Math.ceil((0,V.P)(t))),a=new z.t(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[r,n],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[r,n]]}var s=this._binPack.allocate(e,t);if(s.width<=0){var o=this._mosaicPages[this._currentPage];return!o.dirty&&Se(o.mosaicsData)&&(o.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Te(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"dispose",value:function(){this._binPack=null;var e,t=(0,d.Z)(this._mosaicPages);try{for(t.s();!(e=t.n()).done;){var i=e.value,r=i.texture;r&&r.dispose();var n=i.mosaicsData;Se(n)||n.data.destroy()}}catch(a){t.e(a)}finally{t.f()}this._mosaicPages=null,this._mosaicRects.clear()}}],[{key:"_copyBits",value:function(e,t,i,r,n,a,s,o,u,h,l){var c=r*t+i,d=o*a+s;if(l){d-=a;for(var f=-1;f<=h;c=((++f+h)%h+r)*t+i,d+=a)for(var _=-1;_<=u;_++)n[d+_]=e[c+(_+u)%u]}else for(var p=0;p<h;p++){for(var v=0;v<u;v++)n[d+v]=e[c+v];c+=t,d+=a}}}]),e}();function Ie(e,t,i){return Se(t)?new N.E(e,{pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new N.E(e,{pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,samplingMode:F.L.LINEAR,wrapMode:F.D.CLAMP_TO_EDGE,width:i[0],height:i[1]},null)}function De(e){return(0,m.aj)(e.frameDurations.reduce((function(e,t){return e+t}),0))}function Ze(e,t){var i=e.width,r=e.height,n=e.getFrame,a=e.frameDurations.slice(),s=a.pop();return a.push((0,m.aj)(s+t)),{frameDurations:a,getFrame:n,width:i,height:r}}var Ae=function(){function e(t,i,r,n){(0,p.Z)(this,e),this._animation=t,this._repeatType=r,this._onFrameData=n,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];for(var a=0;i>a;)a+=this.timeToFrame,this.nextFrame();var s=this._animation.getFrame(this._currentFrame);this._onFrameData(s)}return(0,v.Z)(e,[{key:"nextFrame",value:function(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case L.d.None:this._currentFrame-=this._direction;break;case L.d.Loop:this._currentFrame=0;break;case L.d.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case L.d.None:this._currentFrame-=this._direction;break;case L.d.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case L.d.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];var e=this._animation.getFrame(this._currentFrame);this._onFrameData(e)}}]),e}();function Le(e,t,i,r){var n,a=t.repeatType;if(null==a&&(a=L.d.Loop),!0===t.reverseAnimation&&(e=function(e){var t=e.width,i=e.height;return{frameDurations:e.frameDurations.reverse(),getFrame:function(t){var i=e.frameDurations.length-1-t;return e.getFrame(i)},width:t,height:i}}(e)),null!=t.duration&&(e=function(e,t){var i=e.width,r=e.height,n=e.getFrame,a=t/De(e);return{frameDurations:e.frameDurations.map((function(e){return(0,m.aj)(e*a)})),getFrame:n,width:i,height:r}}(e,(0,m.aj)(1e3*t.duration))),null!=t.repeatDelay){var s=1e3*t.repeatDelay;a===L.d.Loop?e=Ze(e,(0,m.aj)(s)):a===L.d.Oscillate&&(e=function(e,t){var i=e.width,r=e.height,n=e.getFrame,a=e.frameDurations.slice(),s=a.shift();return a.unshift((0,m.aj)(s+t)),{frameDurations:a,getFrame:n,width:i,height:r}}(Ze(e,(0,m.aj)(s/2)),(0,m.aj)(s/2)))}if(null!=t.startTimeOffset)n=(0,m.aj)(1e3*t.startTimeOffset);else if(null!=t.randomizeStartTime){var o=(0,C.o)(i),u=null!=t.randomizeStartSeed?t.randomizeStartSeed:82749913,h=(0,C.e)(o,u);n=(0,m.aj)(h*De(e))}else n=(0,m.aj)(0);return new Ae(e,n,a,r)}var ze=function(){function e(t,i,r,n){var a=this;(0,p.Z)(this,e),this._animation=t,this._frameData=null;this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=function(e,t,i,r){var n,a=null==t.playAnimation||t.playAnimation,s=Le(e,t,i,r),o=s.timeToFrame;return function e(){n=a&&setTimeout((function(){s.nextFrame(),o=s.timeToFrame,e()}),o)}(),{remove:function(){a&&clearTimeout(n)}}}(this._animation,r,n,(function(e){a._frameData=e,i.requestRender()}))}return(0,v.Z)(e,[{key:"destroy",value:function(){this._playHandle.remove()}},{key:"bindFrame",value:function(e,t,i){e.bindTexture(t,i),(0,g.t)(this._frameData)||(t.updateData(0,L.a,L.a,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}}]),e}();function Ne(e){switch(e.type){case"esriSMS":return"".concat(e.style,".").concat(e.path);case"esriSLS":return"".concat(e.style,".").concat(e.cap);case"esriSFS":return"".concat(e.style);case"esriPFS":case"esriPMS":return e.imageData?"".concat(e.imageData).concat(e.width).concat(e.height):"".concat(e.url).concat(e.width).concat(e.height);default:return"mosaicHash"in e?e.mosaicHash:JSON.stringify(e)}}var Ue=(0,A.n)(),Ge="arial-unicode-ms-regular",Ve=m.a.getLogger("esri.views.2d.engine.webgl.TextureManager");function He(e,t){var i=Math.round((0,D.u)(t)*window.devicePixelRatio),r=i>=128?2:4;return Math.min(e,i*r)}var qe=function(e,t,i){return Ve.error(new m.s(e,t,i))},Xe=function(){function e(t,i,r){(0,p.Z)(this,e),this.mosaicType=t,this.page=i,this.sdf=r}return(0,v.Z)(e,null,[{key:"fromMosaic",value:function(t,i){return new e(t,i.page,i.sdf)}}]),e}(),We=function(){function e(t,i){(0,p.Z)(this,e),this._requestRender=t,this.resourceManager=i,this._invalidFontsMap=new Map,this._sdfConverter=new Pe(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new X.l({concurrency:10,process:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,m.f)(i),e.prev=1,e.next=4,(0,S.U)(t,{responseType:"image",signal:i});case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),(0,m.j)(e.t0)){e.next=11;break}throw new m.s("mapview-invalid-resource","Could not fetch requested resource at ".concat(t),e.t0);case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,null,[[1,7]])})));return function(t,i){return e.apply(this,arguments)}}()}),this._spriteMosaic=new Ce(2048,2048,500),this._glyphSource=new Fe("".concat(g.s.fontsUrl,"/{fontstack}/{range}.pbf")),this._glyphMosaic=new Me(1024,1024,this._glyphSource),this._rasterizer=new w.c(i)}return(0,v.Z)(e,[{key:"dispose",value:function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}},{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}},{key:"rasterizeItem",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r,n){var a,s,o=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,g.t)(t)){e.next=2;break}return e.abrupt("return",(qe("mapview-null-resource","Unable to rasterize null resource"),null));case 2:e.t0=t.type,e.next="text"===e.t0||"esriTS"===e.t0?5:9;break;case 5:return e.next=7,this._rasterizeText(t,r,n);case 7:return a=e.sent,e.abrupt("return",(a.forEach((function(e){return o._setTextureBinding(E.O.GLYPH,e)})),{glyphMosaicItems:a}));case 9:if(!(0,H.N)(t)){e.next=11;break}return e.abrupt("return",(qe("mapview-invalid-type","MapView does not support symbol type: ".concat(t.type),t),null));case 11:return e.next=13,this._rasterizeSpriteSymbol(t,i,n);case 13:return s=e.sent,e.abrupt("return",((0,q.e)(s)&&s&&this._setTextureBinding(E.O.SPRITE,s),{spriteMosaicItem:s}));case 15:case"end":return e.stop()}}),e,this)})));return function(t,i,r,n){return e.apply(this,arguments)}}()},{key:"bindTextures",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==i.textureBinding){var n=this._bindingInfos[i.textureBinding-1],a=n.page,s=r?F.L.LINEAR_MIPMAP_LINEAR:F.L.LINEAR;switch(n.mosaicType){case E.O.SPRITE:var o=this.sprites.getWidth(a),u=this.sprites.getHeight(a),h=(0,Z.r)(Ue,o,u);return this._spriteMosaic.bind(e,s,a,L.y),t.setUniform1i("u_texture",L.y),void t.setUniform2fv("u_mosaicSize",h);case E.O.GLYPH:var l=this.glyphs.width,c=this.glyphs.height,d=(0,Z.r)(Ue,l,c);return this._glyphMosaic.bind(e,s,a,L.z),t.setUniform1i("u_texture",L.z),void t.setUniform2fv("u_mosaicSize",d);default:Ve.error("mapview-texture-manager","Cannot handle unknown type ".concat(n.mosaicType))}}}},{key:"_hashMosaic",value:function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}},{key:"_setTextureBinding",value:function(e,t){var i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){var r=Xe.fromMosaic(e,t),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(r)}t.textureBinding=this._hashToBindingIndex.get(i)}},{key:"_rasterizeText",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"cim"in t?(n=(s=t).fontName,a=s.text):(o=t,n=(0,I.i)(o.font),a=o.text),u=this._invalidFontsMap.has(n),h=i||(0,H.v)((0,C.n)(a)[0]),e.prev=2,e.next=5,this._glyphMosaic.getGlyphItems(u?Ge:n,h,r);case 5:return e.abrupt("return",e.sent);case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return",(qe("mapview-invalid-resource","Couldn't find font ".concat(n,". Falling back to Arial Unicode MS Regular")),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems(Ge,h,r)));case 11:case"end":return e.stop()}}),e,this,[[2,8]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_rasterizeSpriteSymbol",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,d;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,H.M)(t)){e.next=2;break}return e.abrupt("return",null);case 2:if(n=Ne(t),!this._spriteMosaic.has(n)){e.next=5;break}return e.abrupt("return",this._spriteMosaic.getSpriteItem(n));case 5:if(!((0,H.I)(t)||(0,H.T)(t)&&!(0,H.B)(t))){e.next=7;break}return e.abrupt("return",this._handleAsyncResource(n,t,r));case 7:if(a=L.b,!(s=this._rasterizer.rasterizeJSONResource(t,a))){e.next=11;break}return o=s.size,u=s.image,h=s.sdf,c=s.simplePattern,d=s.rasterizationScale,e.abrupt("return",this._addItemToMosaic(n,o,{type:"static",data:u},(0,H._)(t),h,c,d));case 11:return e.abrupt("return",new m.s("TextureManager","unrecognized or null rasterized image"));case 12:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleAsyncResource",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._ongoingRasterizations.has(t)){e.next=2;break}return e.abrupt("return",this._ongoingRasterizations.get(t));case 2:return n=(0,H.I)(i)?this._handleSVG(i,t,r):this._handleImage(i,t,r),this._ongoingRasterizations.set(t,n),e.prev=3,e.next=6,n;case 6:this._ongoingRasterizations.delete(t),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),this._ongoingRasterizations.delete(t);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleSVG",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[126,126],e.next=3,this._sdfConverter.draw(t.path,r);case 3:return a=e.sent,e.abrupt("return",this._addItemToMosaic(i,n,{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleGIFOrPNG",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,d,f,_,p,v;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,H.E)(t),e.next=3,this.resourceManager.fetchResource(n,r);case 3:if(a=this.resourceManager.getResource(n),!(0,g.t)(a)){e.next=6;break}return e.abrupt("return",new m.s("mapview-invalid-resource","Could not fetch requested resource at ".concat(n,".")));case 6:if(!(a instanceof HTMLImageElement)){e.next=11;break}return s=a.width,o=a.height,"esriPMS"===t.type&&(s=Math.round(He(a.width,(0,H.U)(t))),o=Math.round(a.height*(s/a.width))),u="cim"in t?t.cim.colorSubstitutions:void 0,h=this._rasterizer.rasterizeImageResource(s,o,a,u),c=h.size,d=h.sdf,f=h.image,e.abrupt("return",this._addItemToMosaic(i,c,{type:"static",data:f},(0,H._)(t),d,!1));case 11:return _=t.animatedSymbolProperties||{},p=t.objectId,v=new ze(a,this._requestRender,_,p),e.abrupt("return",this._addItemToMosaic(i,[v.width,v.height],{type:"animated",data:v},(0,H._)(t),!1,!1));case 13:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleImage",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,d,f,p,v,y,b,w;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,H.w)(t)&&!(0,H.A)(t)){e.next=2;break}return e.abrupt("return",this._handleGIFOrPNG(t,i,r));case 2:if(n=(0,H.E)(t),e.prev=3,s=this.resourceManager.getResource(n),!((0,g.r)(s)&&s instanceof HTMLImageElement)){e.next=9;break}a=s,e.next=14;break;case 9:return e.next=11,this._imageRequestQueue.push(n,(0,_.Z)({},r));case 11:o=e.sent,u=o.data,a=u;case 14:if((0,H.D)(n)&&("width"in t&&"height"in t?(a.width=(0,D.u)(t.width),a.height=(0,D.u)(t.height)):"cim"in t&&(c=t.cim,a.width=(0,D.u)(null!==(h=c.width)&&void 0!==h?h:c.scaleX*c.size),a.height=(0,D.u)(c.size))),a.width&&a.height){e.next=17;break}return e.abrupt("return",null);case 17:return d=a.width,f=a.height,"esriPMS"===t.type&&(d=Math.round(He(a.width,(0,H.U)(t))),f=Math.round(a.height*(d/a.width))),p="cim"in t?t.cim.colorSubstitutions:void 0,v=this._rasterizer.rasterizeImageResource(d,f,a,p),y=v.size,b=v.sdf,w=v.image,e.abrupt("return",this._addItemToMosaic(i,y,{type:"static",data:w},(0,H._)(t),b,!1));case 23:if(e.prev=23,e.t0=e.catch(3),(0,m.j)(e.t0)){e.next=27;break}return e.abrupt("return",new m.s("mapview-invalid-resource","Could not fetch requested resource at ".concat(n,". ").concat(e.t0.message)));case 27:case"end":return e.stop()}}),e,this,[[3,23]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_addItemToMosaic",value:function(e,t,i,r,n,a,s){return this._spriteMosaic.addSpriteItem(e,t,i,r,n,a,s)}}]),e}(),Ye=function(){function e(t,i){(0,p.Z)(this,e),this._queue=[],this._context=t,this._refreshable=i}return(0,v.Z)(e,[{key:"destroy",value:function(){this._queue=[]}},{key:"enqueueTextureUpdate",value:function(e,t){var i=(0,m.ap)(),r=e,n=L.w,a=Math.ceil(r.height/n);if((0,m.f)(t),this._context.type===W.r.WEBGL1)this._queue.push({type:"no-chunk",request:e,resolver:i,options:t});else for(var s=0;s<a;s++){var o=s*n,u=s===a-1,h=u?r.height-n*s:n;this._queue.push({type:"chunk",request:e,resolver:i,chunk:s,chunkOffset:o,destHeight:h,chunkIsLast:u,options:t})}return(0,m.o)(t,(function(e){return i.reject(e)})),i.promise}},{key:"upload",value:function(){for(var e=0;this._queue.length;){var t=performance.now(),i=this._queue.shift();if(i){if((0,g.r)(i.options.signal)&&i.options.signal.aborted)continue;switch(i.type){case"chunk":this._uploadChunk(i);break;case"no-chunk":this._uploadNoChunk(i)}var r=performance.now()-t;if((e+=r)+r>=L.x)break}}this._queue.length&&this._refreshable.requestRender()}},{key:"_uploadChunk",value:function(e){var t=e.request,i=e.resolver,r=e.chunkOffset,n=e.chunkIsLast,a=e.destHeight,s=t.data,o=t.texture,u=t.width;(0,g.r)(s)&&(o.updateData(0,0,r,u,a,s,r),n&&i.resolve())}},{key:"_uploadNoChunk",value:function(e){var t=e.request,i=e.resolver,r=t.data;t.texture.setData(r),i.resolve()}}]),e}(),je={shaders:{vertexShader:(0,k.n)("stencil/stencil.vert"),fragmentShader:(0,k.n)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},Ke=(0,K.r)(-.5,-.5),Qe=function(){function e(){(0,p.Z)(this,e),this._centerNdc=(0,Y.n)(),this._pxToNdc=(0,Y.n)(),this._worldDimensionsPx=(0,Y.n)(),this._mat3=(0,b.e)(),this._initialized=!1}return(0,v.Z)(e,[{key:"dispose",value:function(){this._program=(0,g.G)(this._program),this._quad=(0,g.G)(this._quad)}},{key:"render",value:function(e,t){var i=e.context;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(F.O.KEEP,F.O.KEEP,F.O.REPLACE),i.setStencilFunction(F.I.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}},{key:"_initialize",value:function(e){if(!this._initialized){var t=(0,O.e)(e,je);t&&(this._program=t,this._quad=new k.a(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}}},{key:"_updateGeometry",value:function(e,t){var i=e.state,r=e.pixelRatio,n=i.size,a=i.rotation,s=Math.round(n[0]*r),o=Math.round(n[1]*r);if(!i.spatialReference.isWrappable)return!1;var u=(0,Y.f)(a),h=Math.abs(Math.cos(u)),l=Math.abs(Math.sin(u)),c=Math.round(s*h+o*l),d=Math.round(i.worldScreenWidth);if(c<=d)return!1;var f=s*l+o*h,_=d*r,p=(t.left-t.right)*r/s,v=(t.bottom-t.top)*r/o;(0,Y.o)(this._worldDimensionsPx,_,f,1),(0,Y.o)(this._pxToNdc,2/s,-2/o,1),(0,Y.o)(this._centerNdc,p,v,1);var m=this._mat3;return(0,j.l)(m,this._centerNdc),(0,j.f)(m,m,this._pxToNdc),0!==a&&(0,j.h)(m,m,u),(0,j.f)(m,m,this._worldDimensionsPx),(0,j.M)(m,m,Ke),!0}}]),e}(),Je=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,p.Z)(this,i),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])},e}return(0,v.Z)(i,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(t.size){var i=e.context,r=e.renderingOptions;this._quad||(this._quad=new k.a(i,[0,0,1,0,0,1,1,1]));var n=i.getBoundFramebufferObject(),a=i.getViewport(),s=a.x,o=a.y,u=a.width,h=a.height;t.bindTextures(i);var l=t.getBlock(L.N);if(!(0,g.t)(l)){var c=l.getFBO(i),d=l.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,r.labelsAnimationTime),this._updateAnimationState(e,d,c),i.bindFramebuffer(n),i.setViewport(s,o,u,h)}}}},{key:"_computeDelta",value:function(e,t,i){var r=e.context,n=e.painter,a=e.displayLevel,s=n.materialManager.getProgram(this._desc,["delta"]);r.bindFramebuffer(t),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(s),s.setUniform1i("u_maskTexture",L.B),s.setUniform1i("u_sourceTexture",L.C),s.setUniform1f("u_timeDelta",e.deltaTime),s.setUniform1f("u_animationTime",i),s.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,i){var r=e.context,n=e.painter.materialManager.getProgram(this._desc,["update"]);r.bindTexture(t.colorTexture,1),r.useProgram(n),n.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),i}(k.t),$e=function(e){return"#define ".concat(function(e){return e.replace("-","_").toUpperCase()}(e),"\n")};function et(e){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:$e(e)+(0,k.n)("blend/blend.vert"),fragmentShader:$e(e)+(0,k.n)("blend/blend.frag")}}}var tt=m.a.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect"),it=function(){function e(){(0,p.Z)(this,e),this._size=[0,0]}return(0,v.Z)(e,[{key:"dispose",value:function(e){this._backBufferTexture=(0,g.G)(this._backBufferTexture),this._quad=(0,g.G)(this._quad)}},{key:"draw",value:function(e,t,i,r,n){var a=e.context,s=e.drawPhase;if(this._setupShader(a),r&&"normal"!==r&&s!==E.I.LABEL)this._drawBlended(e,t,i,r,n);else{var o=et("normal"),u=a.programCache.acquire(o.shaders.vertexShader,o.shaders.fragmentShader,o.attributes);if(u){a.useProgram(u),t.setSamplingMode(i),a.bindTexture(t,0),u.setUniform1i("u_layerTexture",0),u.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA);var h=this._quad;h.draw(),h.unbind(),u.dispose()}else tt.error(new m.s("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'))}}},{key:"_drawBlended",value:function(e,t,i,r,n){var a,s,o=e.context,u=e.state,h=e.pixelRatio,l=e.inFadeTransition,c=u.size,d=o.getBoundFramebufferObject();if((0,g.r)(d)){var f=d.descriptor;a=f.width,s=f.height}else a=Math.round(h*c[0]),s=Math.round(h*c[1]);this._createOrResizeTexture(e,a,s);var _=this._backBufferTexture;d.copyToTexture(0,0,a,s,0,0,_),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);var p=et(r),v=o.programCache.acquire(p.shaders.vertexShader,p.shaders.fragmentShader,p.attributes);if(v){o.useProgram(v),_.setSamplingMode(i),o.bindTexture(_,0),v.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),v.setUniform1i("u_layerTexture",1),v.setUniform1f("u_opacity",n),v.setUniform1f("u_inFadeOpacity",l?1:0),o.setBlendFunction(F.R.ONE,F.R.ZERO);var y=this._quad;y.draw(),y.unbind(),v.dispose(),o.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA)}else tt.error(new m.s("mapview-BlendEffect","Error creating shader program for blend mode ".concat(r)))}},{key:"_setupShader",value:function(e){this._quad||(this._quad=new k.a(e,[-1,-1,1,-1,-1,1,1,1]))}},{key:"_createOrResizeTexture",value:function(e,t,i){var r=e.context;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new N.E(r,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}]),e}(),rt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this)).name=r.constructor.name,r.defines=[e],r}return(0,v.Z)(i,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,i=e.painter;this._prev=t.getBoundFramebufferObject();var r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var i,r=e.context,n=e.painter,a=n.getPostProcessingEffects(t),s=r.getBoundFramebufferObject(),o=(0,d.Z)(a);try{for(o.s();!(i=o.n()).done;){var u=i.value,h=u.postProcessingEffect,l=u.effect;h.draw(e,s,l)}}catch(c){o.e(c)}finally{o.f()}r.bindFramebuffer(this._prev),r.setStencilTestEnabled(!1),n.blitTexture(r,s.colorTexture,F.L.NEAREST),r.setStencilTestEnabled(!0)}}]),i}(k.t),nt=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],at=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],st=256,ot=1.3,ut=.4,ht=.4,lt=0,ct=m.a.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");var dt=[0,0,0,0],ft=function(){function e(){(0,p.Z)(this,e),this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:lt,outlineWidth:ot,innerHaloWidth:ht,outerHaloWidth:ut},this._shadeTexChanged=!0,this._texelData=new Uint8Array(1024),this._minMaxDistance=[0,0]}return(0,v.Z)(e,[{key:"setHighlightOptions",value:function(e){var t=this._convertedHighlightOptions;!function(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=ot,t.outerHaloWidth=ut,t.innerHaloWidth=ht,t.outlinePosition=lt}(e,t);var i,r=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,n=t.outlinePosition-t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2,s=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,o=1*Math.sqrt(Math.PI/2),u=Math.abs(r)>o?Math.round(10*(Math.abs(r)-o))/10:0,l=Math.abs(s)>o?Math.round(10*(Math.abs(s)-o))/10:0;u&&!l?ct.error("The outer rim of the highlight is "+u+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!u&&l?ct.error("The inner rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):u&&l&&ct.error("The highlight is "+Math.max(u,l)+"px away from the edge of the feature; consider reducing some width values.");var c=[void 0,void 0,void 0,void 0];function d(e,t,i){c[0]=(1-i)*e[0]+i*t[0],c[1]=(1-i)*e[1]+i*t[1],c[2]=(1-i)*e[2]+i*t[2],c[3]=(1-i)*e[3]+i*t[3]}for(var f=this._texelData,_=0;_<st;++_){var p,v,m,g;(i=r+_/255*(s-r))<r?(c[4*_+0]=0,c[4*_+1]=0,c[4*_+2]=0,c[4*_+3]=0):i<n?d(dt,t.outlineColor,(i-r)/(n-r)):i<a?(p=t.outlineColor,v=(0,h.Z)(p,4),c[0]=v[0],c[1]=v[1],c[2]=v[2],c[3]=v[3]):i<s?d(t.outlineColor,t.fillColor,(i-a)/(s-a)):(m=t.fillColor,g=(0,h.Z)(m,4),c[4*_+0]=g[0],c[4*_+1]=g[1],c[4*_+2]=g[2],c[4*_+3]=g[3]),f[4*_+0]=255*c[0],f[4*_+1]=255*c[1],f[4*_+2]=255*c[2],f[4*_+3]=255*c[3]}this._minMaxDistance[0]=r,this._minMaxDistance[1]=s,this._shadeTexChanged=!0}},{key:"applyHighlightOptions",value:function(e,t){this._shadeTex||(this._shadeTex=new N.E(e,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,width:st,height:1,samplingMode:F.L.LINEAR})),this._shadeTexChanged&&(this._shadeTex.updateData(0,0,0,st,1,this._texelData),this._shadeTexChanged=!1),e.bindTexture(this._shadeTex,L.J),t.setUniform2fv("u_minMaxDistance",this._minMaxDistance)}},{key:"destroy",value:function(){this._shadeTex&&(this._shadeTex.dispose(),this._shadeTex=null)}}]),e}(),_t={shaders:{vertexShader:(0,k.n)("highlight/textured.vert"),fragmentShader:(0,k.n)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},pt={shaders:{vertexShader:(0,k.n)("highlight/textured.vert"),fragmentShader:(0,k.n)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},vt=function(){function e(){(0,p.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,v.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,L.I),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",nt),e.bindVAO(this._resources.quadVAO),e.drawArrays(F.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,L.I),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",at),e.bindVAO(this._resources.quadVAO),e.drawArrays(F.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,i){e.bindTexture(t,L.I),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),e.drawArrays(F.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=B.E.createVertex(e,F.F.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new B.b(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Q.t("a_position",2,F.C.BYTE,0,4),new Q.t("a_texcoord",2,F.C.UNSIGNED_BYTE,2,4)]},{geometry:r}),a=(0,O.e)(e,_t),s=(0,O.e)(e,pt);e.useProgram(a),a.setUniform1i("u_texture",L.I),a.setUniform1i("u_shade",L.J),a.setUniform1f("u_sigma",1),e.useProgram(s),s.setUniform1i("u_texture",L.I),s.setUniform1f("u_sigma",1),this._resources={quadGeometry:r,quadVAO:n,highlightProgram:a,blurProgram:s}}},{key:"setup",value:function(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}]),e}();function mt(e,t,i){var r=new N.E(e,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,width:t,height:i,samplingMode:F.L.LINEAR});return[r,new B.x(e,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.STENCIL_RENDER_BUFFER},r)]}var gt=function(){function e(){(0,p.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,v.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=(0,g.d)())}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=mt(e,t,i),n=(0,h.Z)(r,2),a=n[0],s=n[1],o=mt(e,t,i),u=(0,h.Z)(o,2),l=u[0],c=u[1];this._resources={sharedBlur1Tex:a,sharedBlur1Fbo:s,sharedBlur2Tex:l,sharedBlur2Fbo:c}}},{key:"setup",value:function(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Tex}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Tex}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}(),yt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,p.Z)(this,i),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new vt,e._hlGradient=new ft,e._width=void 0,e._height=void 0,e._hlSurfaces=new gt,e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new me,e}return(0,v.Z)(i,[{key:"dispose",value:function(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;this.setup(e,n,a),t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,i){var r=e.context;this._width=t,this._height=i;var n=t%4,a=i%4;t+=n<2?-n:4-n,i+=a<2?-a:4-a,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=r.getBoundFramebufferObject();var s=Math.round(1*t),o=Math.round(1*i);this._hlRenderer.setup(r,s,o),this._hlSurfaces.setup(r,s,o)}},{key:"draw",value:function(e){var t=e.context,i=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,F.L.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}},{key:"setHighlightOptions",value:function(e){this._hlGradient.setHighlightOptions(e)}}]),i}(k.t),bt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,p.Z)(this,i),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["hittest"],e}return(0,v.Z)(i,[{key:"dispose",value:function(){(0,g.r)(this._fbo)&&this._fbo.dispose()}},{key:"createOptions",value:function(e,t){var i=e.pixelRatio,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:L.Y;if(!t.length)return null;var n=t.shift(),a=n.x,s=n.y;return this._outstanding=n,{type:"hittest",distance:r*i,position:[a,s]}}},{key:"bind",value:function(e){var t=e.context,i=e.attributeView;if(i.size){var r=i.getBlock(L.O);if(!(0,g.t)(r)){var n=r.getFBO(t);t.setViewport(0,0,i.size,i.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}}}},{key:"unbind",value:function(e){}},{key:"draw",value:function(e){if(!(0,g.t)(this._outstanding)){var t=this._outstanding;this._outstanding=null,this._resolve(e,t.resolvers)}}},{key:"_resolve",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i){var r,n,a,s,o,u,h,c,d,f;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.context,n=t.attributeView,a=n.getBlock(L.O),!(0,g.t)(a)){e.next=3;break}return e.abrupt("return",void i.forEach((function(e){return e.resolve([])})));case 3:return s=a.getFBO(r),o=new Uint8Array(s.width*s.height*4),e.prev=4,e.next=7,s.readPixelsAsync(0,0,s.width,s.height,F.P.RGBA,F.G.UNSIGNED_BYTE,o);case 7:e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(4),e.abrupt("return",void i.forEach((function(e){return e.resolve([])})));case 12:for(u=[],h=0;h<o.length;h+=4)c=o[h],d=o[h+3],c&&u.push({id:h/4,directHits:d});u.sort((function(e,t){return t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits})),f=u.map((function(e){return e.id})),i.forEach((function(e){return e.resolve(f)}));case 17:case"end":return e.stop()}}),e,null,[[4,9]])})));return function(t,i){return e.apply(this,arguments)}}()}]),i}(k.t),wt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,p.Z)(this,i),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e}return(0,v.Z)(i,[{key:"dispose",value:function(){(0,g.r)(this._fbo)&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height;this._boundFBO=t.getBoundFramebufferObject();var s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(e){e.context.bindFramebuffer(this._boundFBO),this._boundFBO=null}},{key:"draw",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*L.Y;this._resolve(e,t,i)}},{key:"_resolve",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,d,f,_=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.context,a=t.state,s=t.pixelRatio,o=n.getBoundFramebufferObject(),u=a.size[1]*s,h=Math.round(r*s),d=h/2,f=h/2,this._ensureBuffer(h),i.forEach(function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,r){var n,a,c,p,v,m,g,y,b,w;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Map,a=Math.floor(r.x*s-h/2),c=Math.floor(u-r.y*s-h/2),e.next=3,o.readPixelsAsync(a,c,h,h,F.P.RGBA,F.G.UNSIGNED_BYTE,_._buf);case 3:for(p=0;p<_._buf32.length;p++)4294967295!==(v=_._buf32[p])&&0!==v&&(m=p%h,g=h-Math.floor(p/h),y=(d-m)*(d-m)+(f-g)*(f-g),b=n.has(v)?n.get(v):4294967295,n.set(v,Math.min(y,b)));w=Array.from(n).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]})),t.resolve(w),i.delete(r);case 6:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),i}(k.t),Tt=[1,0],xt=[0,1],Et=[1,.8,.6,.4,.2],kt=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],Mt=function(){function e(){(0,p.Z)(this,e),this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,v.Z)(e,[{key:"dispose",value:function(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(var e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height,a=e.context,s=e.painter.materialManager,o=a.gl,u=this._programDesc,h=i.strength,l=i.radius,c=i.threshold;this._quad||(this._quad=new k.a(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,r,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);var d=this._quad;d.bind(),a.bindFramebuffer(this._intensityFBO);var f=s.getProgram(u.luminosityHighPass);a.useProgram(f),a.bindTexture(t.colorTexture,0),f.setUniform1i("u_texture",0),f.setUniform3fv("u_defaultColor",[0,0,0]),f.setUniform1f("u_defaultOpacity",0),f.setUniform1f("u_luminosityThreshold",c),f.setUniform1f("u_smoothWidth",.01);var _=[Math.round(r/2),Math.round(n/2)];a.setViewport(0,0,_[0],_[1]),a.setClearColor(0,0,0,0),a.clear(o.COLOR_BUFFER_BIT),d.draw(),a.setBlendingEnabled(!1);for(var p=this._intensityFBO.colorTexture,v=0;v<this._nMips;v++){var m=s.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[v]}]);a.useProgram(m),a.bindTexture(p,v+1),m.setUniform1i("u_colorTexture",v+1),m.setUniform2fv("u_texSize",_),m.setUniform2fv("u_direction",Tt),a.setViewport(0,0,_[0],_[1]);var g=this._mipsFBOs[v];a.bindFramebuffer(g.horizontal),d.draw(),p=g.horizontal.colorTexture,a.bindFramebuffer(g.vertical),a.bindTexture(p,v+1),m.setUniform2fv("u_direction",xt),d.draw(),p=g.vertical.colorTexture,_[0]=Math.round(_[0]/2),_[1]=Math.round(_[1]/2)}a.setViewport(0,0,r,n);var y=s.getProgram(u.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(y),y.setUniform1f("u_bloomStrength",h),y.setUniform1f("u_bloomRadius",l),y.setUniform1fv("u_bloomFactors",Et),y.setUniform3fv("u_bloomTintColors",kt),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),y.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),y.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),y.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),y.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),y.setUniform1i("u_blurTexture5",5),d.draw(),a.bindFramebuffer(t),a.setBlendingEnabled(!0);var b=s.getProgram(u.blit);a.useProgram(b),a.bindTexture(this._compositeFBO.colorTexture,6),b.setUniform1i("u_texture",6),a.setBlendFunction(F.R.ONE,F.R.ONE),d.draw(),d.unbind(),a.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;if(!this._compositeFBO||this._size[0]!==t||this._size[1]!==i){this._size[0]=t,this._size[1]=i;var n=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new B.x(r,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new B.x(r,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:n[0],height:n[1]},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:n[0],height:n[1]});for(var a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new B.x(r,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:n[0],height:n[1]},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:n[0],height:n[1]}),vertical:new B.x(r,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:n[0],height:n[1]},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}]),e}(),Rt=[1,0],Bt=[0,1],Ft=function(){function e(){(0,p.Z)(this,e),this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,v.Z)(e,[{key:"dispose",value:function(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}},{key:"draw",value:function(e,t,i){var r=e.context,n=i.type,a=i.radius;if(0!==a){this._createOrResizeResources(e),this._quad||(this._quad=new k.a(r,[-1,-1,1,-1,-1,1,1,1]));var s=this._quad;s.bind(),"blur"===n?this._gaussianBlur(e,t,a):this._radialBlur(e,t),s.unbind()}}},{key:"_gaussianBlur",value:function(e,t,i){var r=e.context,n=e.state,a=e.painter,s=e.pixelRatio,o=n.size,u=a.materialManager,h=this._programDesc,l=this._quad,c=[Math.round(s*o[0]),Math.round(s*o[1])],d=this._blurFBO,f=u.getProgram(h.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);r.useProgram(f),r.setBlendingEnabled(!1),r.bindFramebuffer(d),r.bindTexture(t.colorTexture,4),f.setUniform1i("u_colorTexture",4),f.setUniform2fv("u_texSize",c),f.setUniform2fv("u_direction",Rt),f.setUniform1f("u_sigma",i),l.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.bindTexture(d.colorTexture,5),f.setUniform1i("u_colorTexture",5),f.setUniform2fv("u_direction",Bt),l.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0)}},{key:"_radialBlur",value:function(e,t){var i=e.context,r=e.painter.materialManager,n=this._programDesc,a=this._quad,s=this._blurFBO;i.bindFramebuffer(s);var o=r.getProgram(n.radialBlur);i.useProgram(o),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),o.setUniform1i("u_colorTexture",4),a.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);var u=r.getProgram(n.blit);i.useProgram(u),i.bindTexture(s.colorTexture,5),u.setUniform1i("u_texture",5),i.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),a.draw()}},{key:"_createOrResizeResources",value:function(e){var t=e.context,i=e.state,r=e.pixelRatio,n=i.size,a=Math.round(r*n[0]),s=Math.round(r*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===s||(this._size[0]=a,this._size[1]=s,this._blurFBO?this._blurFBO.resize(a,s):this._blurFBO=new B.x(t,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:a,height:s},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:a,height:s}))}}]),e}(),Ot=function(){function e(){(0,p.Z)(this,e),this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}return(0,v.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height;this._createOrResizeResources(e,r,n);var a=e.context,s=e.painter.materialManager,o=this._programDesc,u=this._quad,h=i.colorMatrix;u.bind();var l=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,r,n,0,0,l),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);var c=s.getProgram(o);a.useProgram(c),a.bindTexture(l,2),c.setUniformMatrix4fv("u_coefficients",h),c.setUniform1i("u_colorTexture",2),u.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),u.unbind()}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new N.E(r,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:t,height:i}),this._quad||(this._quad=new k.a(r,[-1,-1,1,-1,-1,1,1,1])))}}]),e}(),Pt=[1,0],St=[0,1],Ct=function(){function e(){(0,p.Z)(this,e),this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,v.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}},{key:"draw",value:function(e,t,i){var r=e.context,n=e.state,a=e.painter.materialManager,s=this._programDesc,o=t.width,u=t.height,h=[Math.round(o),Math.round(u)],l=i.blurRadius,c=i.offsetX,d=i.offsetY,f=i.color,_=[(0,D.u)(c),(0,D.u)(d)];this._createOrResizeResources(e,o,u,h);var p=this._horizontalBlurFBO,v=this._verticalBlurFBO;r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1);var m=this._layerFBOTexture;t.copyToTexture(0,0,o,u,0,0,m),this._quad||(this._quad=new k.a(r,[-1,-1,1,-1,-1,1,1,1])),r.setViewport(0,0,h[0],h[1]);var g=this._quad;g.bind(),r.setBlendingEnabled(!1);var y=a.getProgram(s.blur,[{name:"radius",value:Math.ceil(l)}]);r.useProgram(y),r.bindFramebuffer(p),r.bindTexture(t.colorTexture,4),y.setUniform1i("u_colorTexture",4),y.setUniform2fv("u_texSize",h),y.setUniform2fv("u_direction",Pt),y.setUniform1f("u_sigma",l),g.draw(),r.bindFramebuffer(v),r.bindTexture(p.colorTexture,5),y.setUniform1i("u_colorTexture",5),y.setUniform2fv("u_direction",St),g.draw(),r.bindFramebuffer(t),r.setViewport(0,0,o,u);var b=a.getProgram(s.composite);r.useProgram(b),r.bindTexture(v.colorTexture,2),b.setUniform1i("u_blurTexture",2),r.bindTexture(m,3),b.setUniform1i("u_layerFBOTexture",3),b.setUniform4fv("u_shadowColor",[f[3]*(f[0]/255),f[3]*(f[1]/255),f[3]*(f[2]/255),f[3]]),b.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),b.setUniform2fv("u_shadowOffset",_),g.draw(),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!0),r.setBlendFunction(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),g.unbind()}},{key:"_createOrResizeResources",value:function(e,t,i,r){var n=e.context;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(r[0],r[1]):this._horizontalBlurFBO=new B.x(n,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:r[0],height:r[1]},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(r[0],r[1]):this._verticalBlurFBO=new B.x(n,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.NONE,width:r[0],height:r[1]},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new N.E(n,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:t,height:i}))}}]),e}(),It=function(){function e(){(0,p.Z)(this,e),this._size=[0,0]}return(0,v.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height;this._createOrResizeResources(e,r,n);var a=e.context,s=e.painter,o=i.amount,u=a.gl,h=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,r,n,0,0,h),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(u.COLOR_BUFFER_BIT),s.blitTexture(a,h,F.L.NEAREST,o)}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new N.E(r,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.NEAREST,flipped:!1,width:t,height:i}))}}]),e}();function Dt(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var Zt={colorize:function(){return new Ot},blur:function(){return new Ft},bloom:function(){return new Mt},opacity:function(){return new It},"drop-shadow":function(){return new Ct}},At=function(){function e(){(0,p.Z)(this,e),this._effectMap=new Map}return(0,v.Z)(e,[{key:"dispose",value:function(){this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,i=[],r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=Dt(n.type),s=this._effectMap.get(a);s||(s=Zt[a](),this._effectMap.set(a,s)),i.push({postProcessingEffect:s,effect:n})}}catch(o){r.e(o)}finally{r.f()}return i}}]),e}(),Lt=function(){function e(t,i){var r;(0,p.Z)(this,e),this.brushes=t,this.name=i.name,this.drawPhase=i.drawPhase||E.I.MAP,this._targetFn=i.target,this.effects=i.effects||[],this.enableDefaultDraw=null!==(r=i.enableDefaultDraw)&&void 0!==r?r:function(){return!0}}return(0,v.Z)(e,[{key:"render",value:function(e){var t=e.context,i=e.profiler,r=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,r),i.recordPassEnd();var a,s=(0,d.Z)(this.effects);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(o.enable()){var u=o.apply,h=o.args&&o.args(),l=t.getViewport(),c=t.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,u,h),this._doRender(e,r,u.defines),this._drawAndUnbindEffect(e,u,l,c,f,h)}}}catch(_){s.e(_)}finally{s.f()}}}},{key:"_doRender",value:function(e,t,i){if(!(0,g.t)(t)){var r,n=e.profiler,a=e.context,s=(0,d.Z)(this.brushes);try{for(s.s();!(r=s.n()).done;){var o=r.value;if(n.recordBrushStart(o.name),(0,g.r)(o.brushEffect)){var u=a.getViewport(),h=a.getBoundFramebufferObject(),l=e.passOptions;this._bindEffect(e,o.brushEffect),this._drawWithBrush(o,e,t,i),this._drawAndUnbindEffect(e,o.brushEffect,u,h,l)}else this._drawWithBrush(o,e,t,i);n.recordBrushEnd()}}catch(c){s.e(c)}finally{s.f()}}}},{key:"_drawWithBrush",value:function(e,t,i,r){(0,g.V)(i)?(e.prepareState(t,r),e.drawMany(t,i,r)):i.visible&&(e.prepareState(t,r),e.draw(t,i,r))}},{key:"_bindEffect",value:function(e,t,i){e.profiler.recordPassStart(this.name+"."+t.name),t.bind(e,i);var r=t.createOptions(e,i);e.passOptions=r}},{key:"_drawAndUnbindEffect",value:function(e,t,i,r,n,a){var s=e.profiler,o=e.context;e.passOptions=n,s.recordBrushStart(t.name),t.draw(e,a),t.unbind(e,a),o.bindFramebuffer(r);var u=i.x,h=i.y,l=i.width,c=i.height;o.setViewport(u,h,l,c),s.recordBrushEnd(),s.recordPassEnd()}}]),e}();var zt=function(){function e(t,i,r){(0,p.Z)(this,e),this.context=t,this._blitRenderer=new me,this._worldExtentClipRenderer=new Qe,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._vtlMaterialManager=new M.o,this._blendEffect=new it,this._fboPool=[],this.effects={highlight:new yt,hittest:new bt,hittestVTL:new wt,integrate:new Je,insideEffect:new rt("inside"),outsideEffect:new rt("outside")},this.materialManager=new we(t),this.textureManager=new We(i,r),this.textureUploadManager=new Ye(t,i),this._effectsManager=new At}return(0,v.Z)(e,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getRenderTarget",value:function(){return this._renderTarget}},{key:"setRenderTarget",value:function(e){this._renderTarget=e}},{key:"getFbos",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}var r={target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,samplingMode:F.L.NEAREST,wrapMode:F.D.CLAMP_TO_EDGE,width:e,height:t},n={colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.DEPTH_STENCIL_RENDER_BUFFER},a=new B.s(this.context,{width:e,height:t,internalFormat:F.B.DEPTH_STENCIL});this._stencilBuf=a,this._fbos={output:new B.x(this.context,n,r,a),blend:new B.x(this.context,n,r,a),effect0:new B.x(this.context,n,r,a)}}return this._fbos}},{key:"acquireFbo",value:function(e,t){var i,r=(i=this._fboPool.length>0?this._fboPool.pop():new B.x(this.context,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.DEPTH_STENCIL_RENDER_BUFFER},{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,samplingMode:F.L.NEAREST,wrapMode:F.D.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf)).descriptor;return r.width===e&&r.height===t||i.resize(e,t),i}},{key:"releaseFbo",value:function(e){this._fboPool.push(e)}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderLayers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=e.getViewport(),r=i.width,n=i.height;this._prevFBO=e.getBoundFramebufferObject();var a=this.getFbos(r,n);if(e.bindFramebuffer(a.output),e.setColorMask(!0,!0,!0,!0),(0,g.r)(t)){var s=t.color,o=s.r,u=s.g,h=s.b,l=s.a;e.setClearColor(l*o/255,l*u/255,l*h/255,l)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}},{key:"beforeRenderLayer",value:function(e,t,i){var r=e.context,n=e.blendMode,a=e.effects,s=e.requireFBO,o=e.drawPhase;if(s||Nt(o,n,a,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{var u=this._getOutputFBO();r.bindFramebuffer(u)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}},{key:"compositeLayer",value:function(e,t){var i=e.context,r=e.blendMode,n=e.effects,a=e.requireFBO,s=e.drawPhase;if(a||Nt(s,r,n,t)){(0,g.r)(n)&&n.length>0&&s===E.I.MAP&&this._applyEffects(e,n);var o=this._getOutputFBO();i.bindFramebuffer(o),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA,F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);var u=(0,g.t)(r)||s===E.I.HIGHLIGHT?"normal":r;this._blendEffect.draw(e,this._fbos.blend.colorTexture,F.L.NEAREST,u,t)}}},{key:"renderLayers",value:function(e){if(e.bindFramebuffer(this._prevFBO),this._fbos){var t=this._getOutputFBO();e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(F.I.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,F.L.NEAREST)}}},{key:"prepareDisplay",value:function(e,t,i){var r=e.context;if(r.bindFramebuffer(this._prevFBO),r.setColorMask(!0,!0,!0,!0),(0,g.r)(t)){var n=t.color,a=n.r,s=n.g,o=n.b,u=n.a;r.setClearColor(u*a/255,u*s/255,u*o/255,u)}else r.setClearColor(0,0,0,0);r.setStencilWriteMask(255),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,i)}},{key:"dispose",value:function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,g.G)(this._blitRenderer),this._worldExtentClipRenderer=(0,g.G)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();var t,i=(0,d.Z)(this._fboPool);try{for(i.s();!(t=i.n()).done;){t.value.dispose()}}catch(n){i.e(n)}finally{i.f()}if(this._fboPool.length=0,this.effects)for(var r in this.effects)this.effects[r]&&this.effects[r].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,g.G)(this._vtlMaterialManager),this._prevFBO=null}},{key:"getBrush",value:function(e,t){var i=function(e,t){switch(e){case E.E.LINE:return k.b.line;case E.E.TEXT:return k.b.text;case E.E.LABEL:return k.b.label;case E.E.FILL:return t===E.S.DOT_DENSITY?k.b.dotDensity:k.b.fill;case E.E.MARKER:switch(t){case E.S.HEATMAP:return k.b.heatmap;case E.S.PIE_CHART:return k.b.pieChart;default:return k.b.marker}}}(e,t),r=this._brushCache.get(i);return void 0===r&&(r=new i,this._brushCache.set(i,r)),this._brushCache.get(i)}},{key:"renderObject",value:function(e,t,i,r){var n=k.b[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,r),a.draw(e,t,r)}},{key:"renderObjects",value:function(e,t,i,r){var n=k.b[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,r)}},{key:"registerRenderPass",value:function(e){var t=this,i=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new Lt(i,e)}},{key:"setHighlightOptions",value:function(e){this.effects.highlight.setHighlightOptions(e)}},{key:"blitTexture",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA,F.R.ONE,F.R.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,r)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"_getOutputFBO",value:function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}},{key:"_applyEffects",value:function(e,t){var i,r=e.context,n=this._effectsManager.getPostProcessingEffects(t),a=(0,d.Z)(n);try{for(a.s();!(i=a.n()).done;){var s=i.value,o=s.postProcessingEffect,u=s.effect;r.bindFramebuffer(this._fbos.blend),o.draw(e,this._fbos.blend,u)}}catch(h){a.e(h)}finally{a.f()}}}]),e}();function Nt(e,t,i,r){return e!==E.I.HIGHLIGHT&&(1!==r||(0,g.r)(t)&&"normal"!==t||(0,g.r)(i)&&i.length>0)}var Ut=(0,g.h)("esri-2d-profiler"),Gt=function(){function e(t,i){var r=this;if((0,p.Z)(this,e),this._events=new $.n,this._entries=new Map,this._timings=new J.s(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,Ut){this._ext=(0,ee.T)(t.gl,{}),this._debugOutput=i;var n=t.gl;if(this.enableCommandLogging){var a=function(e){if("function"==typeof n[e]){var t=n[e],i=e.includes("draw");n[e]=function(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];return r._events.emit("command",{container:r._currentContainer,pass:r._currentPass,brush:r._currentBrush,method:e,args:s,isDrawCommand:i}),r._currentSummary&&(r._currentSummary.commands++,i&&r._currentSummary.drawCommands++),t.apply(n,s)}}};for(var s in n)a(s)}}}return(0,v.Z)(e,[{key:"enableCommandLogging",get:function(){return!("object"==typeof Ut&&Ut.disableCommands)}},{key:"recordContainerStart",value:function(e){Ut&&(this._currentContainer=e)}},{key:"recordContainerEnd",value:function(){Ut&&(this._currentContainer=null)}},{key:"recordPassStart",value:function(e){Ut&&(this._currentPass=e,this._initSummary())}},{key:"recordPassEnd",value:function(){Ut&&(this._currentPass=null,this._emitSummary())}},{key:"recordBrushStart",value:function(e){Ut&&(this._currentBrush=e)}},{key:"recordBrushEnd",value:function(){Ut&&(this._currentBrush=null)}},{key:"recordStart",value:function(e){if(Ut&&(0,g.r)(this._ext)){if(this._entries.has(e)){var t=this._entries.get(e),i=this._ext.resultAvailable(t.query),r=this._ext.disjoint();if(i&&!r){var n=this._ext.getResult(t.query)/1e6,a=0;if((0,g.r)(this._timings.enqueue(n))){var s,o=this._timings.entries,u=o.length,h=0,l=(0,d.Z)(o);try{for(l.s();!(s=l.n()).done;){h+=s.value}}catch(m){l.e(m)}finally{l.f()}a=h/u}var c=n.toFixed(2),f=a?a.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed("Frame report for ".concat(e,", ").concat(c," ms (").concat(f," last 10 avg)\n").concat(t.commandsLen," Commands (").concat(t.drawCommands," draw)")),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log("Frame report for ".concat(e,", ").concat(c," ms (").concat(f," last 10 avg)")),this._debugOutput.innerHTML="".concat(c," (").concat(f,")")}var _,p=(0,d.Z)(t.handles);try{for(p.s();!(_=p.n()).done;){_.value.remove()}}catch(m){p.e(m)}finally{p.f()}this._ext.deleteQuery(t.query),this._entries.delete(e)}var v={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(v.handles.push(this._events.on("command",(function(e){v.commandsLen++,v.commands.push(e),e.isDrawCommand&&v.drawCommands++}))),v.handles.push(this._events.on("summary",(function(e){v.summaries.push(e)})))),this._ext.beginTimeElapsed(v.query),this._entries.set(e,v)}}},{key:"recordEnd",value:function(e){Ut&&(0,g.r)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}},{key:"_initSummary",value:function(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}},{key:"_emitSummary",value:function(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}]),e}(),Vt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e,r){var a;(0,p.Z)(this,i),(a=t.call(this))._trash=new Set,a._renderRemainingTime=0,a._lastFrameRenderTime=0,a.renderRequested=!1,a.stage=(0,n.Z)(a),a._stationary=!0;var s=r.canvas,o=void 0===s?document.createElement("canvas"):s,u=r.alpha,h=void 0===u||u,l=r.stencil,c=void 0===l||l,d=r.contextOptions,f=void 0===d?{}:d;a._canvas=o;var _=(0,W.o)("2d",o,{alpha:h,antialias:!1,depth:!0,stencil:c});return a.context=new ee.y((0,g.r)(_)?_:null,f),a.resourceManager=new w.o,a.painter=new zt(a.context,(0,n.Z)(a),a.resourceManager),(0,g.h)("esri-2d-profiler")&&(a._debugOutput=document.createElement("div"),a._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(a._debugOutput)),a._renderParameters={drawPhase:0,state:a.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:a.context,painter:a.painter,timeline:r.timeline||new te.e,renderingOptions:r.renderingOptions,requestRender:function(){return a.requestRender()},allowDelayedRender:!1,requireFBO:!1,profiler:new Gt(a.context,a._debugOutput),dataUploadCounter:0},a._taskHandle=(0,m.a7)({render:function(e){return a.renderFrame(e)}}),a._taskHandle.pause(),a._lostWebGLContextHandle=(0,m.C)(o,"webglcontextlost",(function(){a.emit("webgl-error",{error:new m.s("webgl-context-lost")})})),a._bufferPool=new x.n,o.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(o),a}return(0,v.Z)(i,[{key:"destroy",value:function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this._bufferPool.destroy(),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){var t=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,y.l)((function(){var e;return null===(e=t._highlightOptions)||void 0===e?void 0:e.version}),(function(){t.painter.setHighlightOptions(e),t.requestRender()}),y.h))}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}},{key:"renderFrame",value:function(e){var t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}},{key:"_createTransforms",value:function(){return{dvs:(0,b.e)()}}},{key:"renderChildren",value:function(e){var t,i=(0,d.Z)(this.children);try{for(i.s();!(t=i.n()).done;){t.value.beforeRender(e)}}catch(a){i.e(a)}finally{i.f()}this._renderChildren(this.children,e);var r,n=(0,d.Z)(this.children);try{for(n.s();!(r=n.n()).done;){r.value.afterRender(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_renderChildren",value:function(e,t){var i=this.context;this.painter.textureUploadManager.upload(),i.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=E.I.MAP,this.painter.beforeRenderLayers(i,this.background);var r,n=(0,d.Z)(e);try{for(n.s();!(r=n.n()).done;){r.value.processRender(t)}}catch(c){n.e(c)}finally{n.f()}this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(i),t.drawPhase=E.I.HIGHLIGHT,this.painter.beforeRenderLayers(i);var a,s=(0,d.Z)(e);try{for(s.s();!(a=s.n()).done;){a.value.processRender(t)}}catch(c){s.e(c)}finally{s.f()}if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=E.I.LABEL,this.painter.beforeRenderLayers(i);var o,u=(0,d.Z)(e);try{for(u.s();!(o=u.n()).done;){o.value.processRender(t)}}catch(c){u.e(c)}finally{u.f()}this.painter.renderLayers(i)}if((0,g.h)("esri-tiles-debug")){t.drawPhase=E.I.DEBUG,this.painter.beforeRenderLayers(i);var h,l=(0,d.Z)(e);try{for(l.s();!(h=l.n()).done;){h.value.processRender(t)}}catch(c){l.e(c)}finally{l.f()}this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),i.logInfo()}},{key:"doRender",value:function(e){var t=this.context,r=e.state,n=e.pixelRatio;this._resizeCanvas(e),t.setViewport(0,0,n*r.size[0],n*r.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),(0,a.Z)((0,s.Z)(i.prototype),"doRender",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h,c,d,f,p,v;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={framebufferWidth:Math.round(this.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*t.resolutionScale)},r=i.framebufferWidth,n=i.framebufferHeight,1,a=this.context,s=this._state.clone(),null!=t.rotation&&(o=s.viewpoint,s.viewpoint.rotation=t.rotation,s.viewpoint=o),u=(0,_.Z)((0,_.Z)({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:s,pixelRatio:1,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),h=new B.x(a,{colorTarget:F.Y.TEXTURE,depthStencilTarget:F.V.DEPTH_STENCIL_RENDER_BUFFER,width:r,height:n}),c=a.getBoundFramebufferObject(),d=a.getViewport(),a.bindFramebuffer(h),a.setViewport(0,0,r,n),this._renderChildren(t.children,u),f=this._readbackScreenshot(h,(0,_.Z)((0,_.Z)({},t.cropArea),{},{y:n-(t.cropArea.y+t.cropArea.height)})),a.bindFramebuffer(c),a.setViewport(d.x,d.y,d.width,d.height),this.requestRender(),e.next=8,f;case 8:return p=e.sent,e.abrupt("return",(1===t.outputScale?v=p:(v=new ImageData(Math.round(p.width*t.outputScale),Math.round(p.height*t.outputScale)),(0,ie.R)(p,v,!0)),v));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_readbackScreenshot",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i){var r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,re.e)(i.width,i.height,document.createElement("canvas")),e.next=3,t.readPixelsAsync(i.x,i.y,i.width,i.height,F.P.RGBA,F.G.UNSIGNED_BYTE,new Uint8Array(r.data.buffer));case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_resizeCanvas",value:function(e){var t=this._canvas,i=t.style,r=e.state.size,n=e.pixelRatio,a=r[0],s=r[1],o=Math.round(a*n),u=Math.round(s*n);t.width===o&&t.height===u||(t.width=o,t.height=u),i.width=a+"px",i.height=s+"px"}},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,i=e;t<i.length;t++){i[t].processDetach()}}}},{key:"_isLabelDrawPhaseRequired",value:function(e){var t,i=!1,r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(!(n instanceof T.i)){i=i||!1;break}if(n.hasLabels)return!0;i=i||this._isLabelDrawPhaseRequired(n.children)}}catch(a){r.e(a)}finally{r.f()}return i}}]),i}(T.i),Ht=function(){function e(t,i,r){(0,p.Z)(this,e),this._debugMap=new Map,this._width=t*r,this._height=i*r,this._pixelRatio=r;var n=Math.ceil(this._width/1),a=Math.ceil(this._height/1);this._cols=n,this._rows=a,this._cells=se.t.create(n*a)}return(0,v.Z)(e,[{key:"insertMetrics",value:function(e){var t=this._hasCollision(e);return 0===t&&this._markMetrics(e),t}},{key:"getCellId",value:function(e,t){return e+t*this._cols}},{key:"has",value:function(e){return this._cells.has(e)}},{key:"hasRange",value:function(e,t){return this._cells.hasRange(e,t)}},{key:"set",value:function(e){this._cells.set(e)}},{key:"setRange",value:function(e,t){this._cells.setRange(e,t)}},{key:"_collide",value:function(e,t,i,r){var n=e-i/2,a=t-r/2,s=n+i,o=a+r;if(s<0||o<0||n>this._width||a>this._height)return 1;for(var u=(0,Y.a)(Math.floor(n/1),0,this._cols),h=(0,Y.a)(Math.floor(a/1),0,this._rows),l=(0,Y.a)(Math.ceil(s/1),0,this._cols),c=(0,Y.a)(Math.ceil(o/1),0,this._rows),d=h;d<=c;d++)for(var f=u;f<=l;f++){var _=this.getCellId(f,d);if(this.has(_))return 2}return 0}},{key:"_mark",value:function(e,t,i,r,n){for(var a=e-i/2,s=t-r/2,o=a+i,u=s+r,h=(0,Y.a)(Math.floor(a/1),0,this._cols),l=(0,Y.a)(Math.floor(s/1),0,this._rows),c=(0,Y.a)(Math.ceil(o/1),0,this._cols),d=(0,Y.a)(Math.ceil(u/1),0,this._rows),f=l;f<=d;f++)for(var _=h;_<=c;_++){var p=this.getCellId(_,f);this._debugMap.set(p,n),this.set(p)}return!1}},{key:"_hasCollision",value:function(e){var t=e.id,i=0,r=0;e.save();do{var n=e.boundsCount;i+=n;for(var a=0;a<n;a++){var s=e.boundsComputedAnchorX(a),o=e.boundsComputedAnchorY(a),u=(e.boundsWidth(a)+2)*this._pixelRatio,h=(e.boundsHeight(a)+2)*this._pixelRatio;switch(this._collide(s,o,u,h)){case 2:return 2;case 1:r++}}}while(e.peekId()===t&&e.next());return e.restore(),i===r?1:0}},{key:"_markMetrics",value:function(e){var t=e.id;e.save();do{for(var i=e.boundsCount,r=0;r<i;r++){var n=e.boundsComputedAnchorX(r),a=e.boundsComputedAnchorY(r),s=(e.boundsWidth(r)+2)*this._pixelRatio,o=(e.boundsHeight(r)+2)*this._pixelRatio;this._mark(n,a,s,o,e.id)}}while(e.peekId()===t&&e.next());e.restore()}}]),e}(),qt=Math.PI;function Xt(e,t){switch(t.transformationType){case ue.i.Additive:return function(e,t){return e+(Wt(t.minSize,e)||t.minDataValue)}(e,t);case ue.i.Constant:return function(e,t){var i=e.stops,r=i&&i.length&&i[0].size;return null==r&&(r=e.minSize),Wt(r,t)}(t,e);case ue.i.ClampedLinear:return function(e,t){var i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),r=Wt(t.minSize,e),n=Wt(t.maxSize,e);return e<=t.minDataValue?r:e>=t.maxDataValue?n:r+i*(n-r)}(e,t);case ue.i.Proportional:return function(e,t){var i=e/t.minDataValue,r=Wt(t.minSize,e),n=Wt(t.maxSize,e),a=null;return a=i*r,(0,Y.a)(a,r,n)}(e,t);case ue.i.Stops:return function(e,t){var i=function(e,t){if(!t)return;var i=0,r=t.length-1;return t.some((function(t,n){return e<t?(r=n,!0):(i=n,!1)})),[i,r,(e-t[i])/(t[r]-t[i])]}(e,t.cache.ipData),r=(0,h.Z)(i,3),n=r[0],a=r[1],s=r[2];if(n===a)return Wt(t.stops[n].size,e);var o=Wt(t.stops[n].size,e);return o+(Wt(t.stops[a].size,e)-o)*s}(e,t);case ue.i.RealWorldSize:return function(e,t){var i=oe.m[t.valueUnit],r=Wt(t.minSize,e),n=Wt(t.maxSize,e),a=t.valueRepresentation,s=null;return s="area"===a?2*Math.sqrt(e/qt)/i:"radius"===a||"distance"===a?2*e/i:e/i,(0,Y.a)(s,r,n)}(e,t);case ue.i.Identity:return e;case ue.i.Unknown:return null}}function Wt(e,t){return"number"==typeof e?e:Xt(t,e)}var Yt=255;function jt(e,t){var i=[];e.forEachTile((function(e){return i.push(e)})),i.sort((function(e,t){return e.instanceId-t.instanceId})),i.forEach((function(e){(0,g.r)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}function Kt(e){return function(t){return(0,D.u)(Xt(t,e))}}function Qt(e,t){if(function(e){return e.layer&&("feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type)}(t)){var i="subtype-group"===t.layer.type?t.layer.sublayers.items:[t.layer],n=t.layer.geometryType,a=!function(e){var t,i=(0,d.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,a="featureReduction"in n&&n.featureReduction&&"labelingInfo"in n.featureReduction&&n.featureReduction,s=[].concat((0,r.Z)(n.labelingInfo||[]),(0,r.Z)((null===a||void 0===a?void 0:a.labelingInfo)||[]));if(n.labelsVisible&&s.length&&s.some((function(e){return"none"===e.deconflictionStrategy})))return!0}}catch(o){i.e(o)}finally{i.f()}return!1}(i),s={};if("subtype-group"!==t.layer.type){var o;if("heatmap"===(null===(o=t.tileRenderer)||void 0===o?void 0:o.type))return;var u=function(e){var t="visualVariables"in e&&e.visualVariables;if(!t)return null;var i,r=(0,d.Z)(t);try{for(r.s();!(i=r.n()).done;){var n=i.value;if("size"===n.type)return Kt(n)}}catch(a){r.e(a)}finally{r.f()}return null}(t.layer.renderer);s[0]=u}var h=t.tileRenderer;if(!(0,g.t)(h)){var l=t.layer.visible&&!t.suspended;e.push({tileRenderer:h,vvEvaluators:s,deconflictionEnabled:a,geometryType:n,visible:l})}}}var Jt=function(){function e(){(0,p.Z)(this,e)}return(0,v.Z)(e,[{key:"run",value:function(e,t,i){for(var r=[],n=e.length-1;n>=0;n--)Qt(r,e[n]);this._transformMetrics(r),this._runCollision(r,t,i)}},{key:"_runCollision",value:function(e,t,i){var r,n=this,a=(0,h.Z)(t.state.size,2),s=a[0],o=a[1],u=new Ht(s,o,t.pixelRatio),l=(0,d.Z)(e);try{var c=function(){var e=r.value,t=e.tileRenderer,a=e.deconflictionEnabled,s=e.visible,o=t.featuresView.attributeView;a?s?(n._prepare(t),n._collideVisible(u,t,i),n._collideInvisible(u,t)):jt(t,(function(e,t){for(;t.nextId();)o.setLabelMinZoom(t.id,Yt)})):jt(t,(function(e,t){for(;t.nextId();)o.setLabelMinZoom(t.id,0),s&&u.insertMetrics(t)}))};for(l.s();!(r=l.n()).done;)c()}catch(f){l.e(f)}finally{l.f()}}},{key:"_isFiltered",value:function(e,t,i){var r=t.getFilterFlags(e),n=!i.hasFilter||!!(r&L.U),a=(0,g.t)(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(r&L.V);return!(n&&a)}},{key:"_prepare",value:function(e){var t=this,i=e.featuresView.attributeView,r=new Set;jt(e,(function(n,a){for(;a.nextId();)r.has(a.id)||(r.add(a.id),t._isFiltered(a.id,i,e.layerView)?i.setLabelMinZoom(a.id,254):0!==i.getLabelMinZoom(a.id)?i.setLabelMinZoom(a.id,Yt):i.setLabelMinZoom(a.id,0))}))}},{key:"_collideVisible",value:function(e,t,i){var r=t.featuresView.attributeView,n=new Set;jt(t,(function(t,a){for(;a.nextId();)if(!n.has(a.id))if(t.key.level===i){if(0===r.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case 1:break;case 2:r.setLabelMinZoom(a.id,254),n.add(a.id);break;case 0:r.setLabelMinZoom(a.id,0),n.add(a.id)}}else r.setLabelMinZoom(a.id,254)}))}},{key:"_collideInvisible",value:function(e,t){var i=t.featuresView.attributeView,r=new Set;jt(t,(function(t,n){for(;n.nextId();)if(!r.has(n.id)&&i.getLabelMinZoom(n.id)===Yt)switch(e.insertMetrics(n)){case 1:break;case 2:i.setLabelMinZoom(n.id,Yt),r.add(n.id);break;case 0:i.setLabelMinZoom(n.id,0),r.add(n.id)}}))}},{key:"_transformMetrics",value:function(e){var t,i=(0,d.Z)(e);try{var r=function(){var e=t.value,i=e.tileRenderer,r=e.geometryType,n=e.vvEvaluators;jt(i,(function(e,t){var a=i.featuresView.attributeView,s=e.transforms.labelMat2d;s[4]=Math.round(s[4]),s[5]=Math.round(s[5]);for(var o="polyline"===r;t.next();){var u=t.boundsCount,h=t.anchorX,l=t.anchorY,c=t.size,d=n[0];if((0,g.r)(d)){var f=d(a.getVVSize(t.id));c=isNaN(f)||null==f||f===1/0?c:f}for(var _=t.directionX*(c/2),p=t.directionY*(c/2),v=0;v<u;v++){var m=h,y=t.anchorY;if(o){var b=m+t.boundsX(v)+_,w=y+t.boundsY(v)+p;b=s[0]*b+s[2]*w+s[4],w=s[1]*b+s[3]*w+s[5],t.setBoundsComputedAnchorX(v,Math.floor(b)),t.setBoundsComputedAnchorY(v,Math.floor(w))}else{m=s[0]*h+s[2]*l+s[4],y=s[1]*h+s[3]*l+s[5];var T=m+t.boundsX(v)+_,x=y+t.boundsY(v)+p;t.setBoundsComputedAnchorX(v,T),t.setBoundsComputedAnchorY(v,x)}}}}))};for(i.s();!(t=i.n()).done;)r()}catch(n){i.e(n)}finally{i.f()}}}]),e}(),$t=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e))._applyVisibilityPassThrottled=(0,ae.e)(r._applyVisibilityPass,32,(0,n.Z)(r)),r.lastUpdateId=-1,r.updateRequested=!1,r.view=null,r}return(0,v.Z)(i,[{key:"initialize",value:function(){this.collisionEngine=new Jt}},{key:"destroy",value:function(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}},{key:"updating",get:function(){return(0,g.h)("esri-2d-log-updating")&&console.log("Updating LabelManager ".concat(this.updateRequested,":\n-> updateRequested: ").concat(this.updateRequested)),this.updateRequested}},{key:"update",value:function(e){this._applyVisibilityPassThrottled(e)}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"requestUpdate",value:function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}},{key:"processUpdate",value:function(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}},{key:"_applyVisibilityPass",value:function(e){try{var t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,e,t)}catch(i){}}}]),i}((0,ne.a)(m.m));(0,m.e)([(0,m.y)()],$t.prototype,"updateRequested",void 0),(0,m.e)([(0,m.y)({readOnly:!0})],$t.prototype,"updateParameters",void 0),(0,m.e)([(0,m.y)()],$t.prototype,"updating",null),(0,m.e)([(0,m.y)()],$t.prototype,"view",void 0);var ei=$t=(0,m.e)([(0,m.n)("esri.views.2d.layers.labels.LabelManager")],$t),ti="esri-zoom-box__container",ii="esri-zoom-box__overlay",ri="esri-zoom-box__overlay-background",ni="esri-zoom-box__outline",ai="Shift",si="Ctrl",oi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e))._container=null,r._overlay=null,r._backgroundShape=null,r._boxShape=null,r._box={x:0,y:0,width:0,height:0},r._redraw=r._redraw.bind((0,n.Z)(r)),r}return(0,v.Z)(i,[{key:"destroy",value:function(){this.view=null}},{key:"view",set:function(e){var t=this;this._handles&&this._handles.forEach((function(e){e.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",[ai],(function(e){return t._handleDrag(e,1)}),ie.P.INTERNAL),e.on("drag",[ai,si],(function(e){return t._handleDrag(e,-1)}),ie.P.INTERNAL))}},{key:"_start",value:function(){this._createContainer(),this._createOverlay(),this.navigation.begin()}},{key:"_update",value:function(e,t,i,r){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=r,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}},{key:"_end",value:function(e,t,i,r,n){var a=this.view,s=a.toMap((0,D.c)(e+.5*i,t+.5*r)),o=Math.max(i/a.width,r/a.height);-1===n&&(o=1/o),this._destroyOverlay(),this.navigation.end(),a.goTo({center:s,scale:a.scale*o})}},{key:"_updateBox",value:function(e,t,i,r){var n=this._boxShape;n.setAttributeNS(null,"x",""+e),n.setAttributeNS(null,"y",""+t),n.setAttributeNS(null,"width",""+i),n.setAttributeNS(null,"height",""+r),n.setAttributeNS(null,"class",ni)}},{key:"_updateBackground",value:function(e,t,i,r){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,r,this.view.width,this.view.height))}},{key:"_createContainer",value:function(){var e=document.createElement("div");e.className=ti,this.view.root.appendChild(e),this._container=e}},{key:"_createOverlay",value:function(){var e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class",ri);var r=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class",ii),n.appendChild(i),n.appendChild(r),this._container.appendChild(n),this._backgroundShape=i,this._boxShape=r,this._overlay=n}},{key:"_destroyOverlay",value:function(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}},{key:"_toSVGPath",value:function(e,t,i,r,n,a){var s=e+i,o=t+r;return"M 0 0 L "+n+" 0 L "+n+" "+a+" L 0 "+a+" ZM "+e+" "+t+" L "+e+" "+o+" L "+s+" "+o+" L "+s+" "+t+" Z"}},{key:"_handleDrag",value:function(e,t){var i,r,n,a,s=e.x,o=e.y,u=e.origin.x,h=e.origin.y;switch(s>u?(i=u,n=s-u):(i=s,n=u-s),o>h?(r=h,a=o-h):(r=o,a=h-o),e.action){case"start":this._start();break;case"update":this._update(i,r,n,a);break;case"end":this._end(i,r,n,a,t)}e.stopPropagation()}},{key:"_redraw",value:function(){if(this._rafId&&(this._rafId=null,this._overlay)){var e=this._box,t=e.x,i=e.y,r=e.width,n=e.height;this._updateBox(t,i,r,n),this._updateBackground(t,i,r,n),this._rafId=requestAnimationFrame(this._redraw)}}}]),i}(m.m);(0,m.e)([(0,m.y)()],oi.prototype,"navigation",void 0),(0,m.e)([(0,m.y)()],oi.prototype,"view",null);var ui=oi=(0,m.e)([(0,m.n)("esri.views.2d.navigation.ZoomBox")],oi),hi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e)).animationTime=0,r.momentumEstimator=new fe.l(500,6,.92),r.momentum=null,r.tmpMomentum=(0,Y.n)(),r.momentumFinished=!1,r.viewpoint=new ce.u({targetGeometry:new de.w,scale:0,rotation:0}),(0,y.f)((function(){return r.momentumFinished}),(function(){return r.navigation.stop()})),r}return(0,v.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this._previousDrag=t}},{key:"update",value:function(e,t){this.addToEstimator(t);var i=t.center.x,r=t.center.y,n=this._previousDrag;i=n?n.center.x-i:-i,r=n?r-n.center.y:r,e.viewpoint=(0,ie.S)(this.viewpoint,e.viewpoint,[i||0,r||0]),this._previousDrag=t}},{key:"end",value:function(e,t){this.addToEstimator(t);var i=e.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this._previousDrag=null,this.navigation.end()}},{key:"addToEstimator",value:function(e){var t=e.center.x,i=e.center.y,r=(0,D.i)(-t,i),n=(0,Y.c)(-t,i,0);this.momentumEstimator.add(r,n,.001*e.timestamp)}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){t.momentumFinished=!t.momentum||t.momentum.isFinished(t.animationTime);var n=.001*r;if(!t.momentumFinished){var a=t.momentum.valueDelta(t.animationTime,n);(0,Y.g)(t.tmpMomentum,t.momentum.direction,a),(0,ie.S)(i,i,t.tmpMomentum),e.constraints.constrainByGeometry(i)}t.animationTime+=n}))}},{key:"stopMomentumNavigation",value:function(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}}]),i}(m.m);(0,m.e)([(0,m.y)()],hi.prototype,"momentumFinished",void 0),(0,m.e)([(0,m.y)()],hi.prototype,"viewpoint",void 0),(0,m.e)([(0,m.y)()],hi.prototype,"navigation",void 0);var li=hi=(0,m.e)([(0,m.n)("esri.views.2d.navigation.actions.Pan")],hi),ci=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e))._animationTime=0,r._momentumFinished=!1,r._rotationMomentumEstimator=new fe.b(.6,.15,.95),r._rotationDirection=1,r._zoomDirection=1,r._zoomMomentumEstimator=new fe.s,r._zoomOnly=null,r.zoomMomentum=null,r.rotateMomentum=null,r.viewpoint=new ce.u({targetGeometry:new de.w,scale:0,rotation:0}),r.addHandles((0,y.f)((function(){return r._momentumFinished}),(function(){return r.navigation.stop()}))),r}return(0,v.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}},{key:"update",value:function(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);var i=t.angle,r=t.radius,n=t.center,a=Math.abs(180*(i-this._startAngle)/Math.PI),s=Math.abs(r-this._startRadius),o=this._startRadius/r;if(this._previousRadius){var u=r/this._previousRadius,h=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=h>=0?1:-1,this._zoomDirection=u>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=s-a>0),null===this._zoomOnly||this._zoomOnly?h=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):h=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([n.x,n.y],1/u,h,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=r,this._previousCenter=n}},{key:"end",value:function(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}},{key:"addToRotateEstimator",value:function(e,t){this._rotationMomentumEstimator.add(e,.001*t)}},{key:"addToZoomEstimator",value:function(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}},{key:"canZoomIn",value:function(e){var t=e.scale,i=e.constraints.effectiveMaxScale;return 0===i||t>i}},{key:"canZoomOut",value:function(e){var t=e.scale,i=e.constraints.effectiveMinScale;return 0===i||t<i}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){var n=!t.canZoomIn(e)&&t._zoomDirection>1||!t.canZoomOut(e)&&t._zoomDirection<1,a=!t.rotateMomentum||t.rotateMomentum.isFinished(t._animationTime),s=n||!t.zoomMomentum||t.zoomMomentum.isFinished(t._animationTime),o=.001*r;if(t._momentumFinished=a&&s,!t._momentumFinished){var u=t.rotateMomentum?Math.abs(t.rotateMomentum.valueDelta(t._animationTime,o))*t._rotationDirection*180/Math.PI:0,h=t.zoomMomentum?Math.abs(t.zoomMomentum.valueDelta(t._animationTime,o)):1,l=(0,K.n)(),c=(0,K.n)();if(t._previousCenter){(0,Z.r)(l,t._previousCenter.x,t._previousCenter.y),(0,ie._)(c,e.size,e.padding),(0,Z.s)(l,l,c);var d=e.constraints,f=e.scale,_=f*h;h<1&&!d.canZoomInTo(_)?(h=f/d.effectiveMaxScale,t.zoomMomentum=null,t.rotateMomentum=null):h>1&&!d.canZoomOutTo(_)&&(h=f/d.effectiveMinScale,t.zoomMomentum=null,t.rotateMomentum=null),(0,ie.G)(i,e.viewpoint,h,u,l,e.size),e.constraints.constrainByGeometry(i)}}t._animationTime+=o}))}},{key:"stopMomentumNavigation",value:function(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}}]),i}(m.m);(0,m.e)([(0,m.y)()],ci.prototype,"_momentumFinished",void 0),(0,m.e)([(0,m.y)()],ci.prototype,"viewpoint",void 0),(0,m.e)([(0,m.y)()],ci.prototype,"navigation",void 0);var di=ci=(0,m.e)([(0,m.n)("esri.views.2d.navigation.actions.Pinch")],ci),fi=(0,K.n)(),_i=(0,K.n)(),pi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e))._previousCenter=(0,K.n)(),r.viewpoint=new ce.u({targetGeometry:new de.w,scale:0,rotation:0}),r}return(0,v.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),(0,Z.r)(this._previousCenter,t.center.x,t.center.y)}},{key:"update",value:function(e,t){var i=e.state,r=i.size,n=i.padding;(0,Z.r)(fi,t.center.x,t.center.y),(0,ie.$)(_i,r,n),e.viewpoint=(0,ie.a0)(this.viewpoint,e.state.paddedViewState.viewpoint,(0,ie.I)(_i,this._previousCenter,fi)),(0,Z.a)(this._previousCenter,fi)}},{key:"end",value:function(){this.navigation.end()}}]),i}(m.m);(0,m.e)([(0,m.y)()],pi.prototype,"viewpoint",void 0),(0,m.e)([(0,m.y)()],pi.prototype,"navigation",void 0);var vi=pi=(0,m.e)([(0,m.n)("esri.views.2d.actions.Rotate")],pi),mi=new ce.u({targetGeometry:new de.w}),gi=[0,0],yi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,p.Z)(this,i),(r=t.call(this,e))._endTimer=null,r.animationManager=null,r}return(0,v.Z)(i,[{key:"initialize",value:function(){this.pan=new li({navigation:this}),this.rotate=new vi({navigation:this}),this.pinch=new di({navigation:this}),this.zoomBox=new ui({view:this.view,navigation:this})}},{key:"destroy",value:function(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}},{key:"begin",value:function(){this._set("interacting",!0)}},{key:"end",value:function(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}},{key:"zoom",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.length>1&&void 0!==r[1]?r[1]:this._getDefaultAnchor(),this.stop(),this.begin(),!this.view.constraints.snapToZoom||!this.view.constraints.effectiveLODs){e.next=3;break}return e.abrupt("return",t<1?this.zoomIn(i):this.zoomOut(i));case 3:this.setViewpoint(i,t,0,[0,0]);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"zoomIn",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToNextScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"zoomOut",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToPreviousScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setViewpoint",value:function(e,t,i,r){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,r),this.end()}},{key:"setViewpointImmediate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this._getDefaultAnchor();this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,e,t,i)}},{key:"continousRotateClockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){(0,ie.a0)(e,e,-1)}))}},{key:"continousRotateCounterclockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){(0,ie.a0)(e,e,1)}))}},{key:"resetRotation",value:function(){this.view.rotation=0}},{key:"continousPanLeft",value:function(){this._continuousPan([-10,0])}},{key:"continousPanRight",value:function(){this._continuousPan([10,0])}},{key:"continousPanUp",value:function(){this._continuousPan([0,10])}},{key:"continousPanDown",value:function(){this._continuousPan([0,-10])}},{key:"stop",value:function(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}},{key:"_continuousPan",value:function(e){var t=this,i=this.view.viewpoint;this.animationManager.animateContinous(i,(function(i){(0,ie.S)(i,i,e),t.view.constraints.constrainByGeometry(i)}))}},{key:"_startTimer",value:function(e){var t=this;return null!==this._endTimer||(this._endTimer=setTimeout((function(){t._endTimer=null;var e=performance.now()-t._lastEventTimestamp;e<250?t._endTimer=t._startTimer(e):t._set("interacting",!1)}),e)),this._endTimer}},{key:"_getDefaultAnchor",value:function(){var e=this.view,t=e.size,i=e.padding,r=i.left,n=i.right,a=i.top,s=i.bottom;return gi[0]=.5*(t[0]-n+r),gi[1]=.5*(t[1]-s+a),gi}},{key:"_zoomToScale",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h,c,d=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=d.length>1&&void 0!==d[1]?d[1]:this._getDefaultAnchor(),r=this.view,n=r.constraints,a=r.scale,s=r.viewpoint,o=r.size,u=r.padding,h=n.canZoomInTo(t),c=n.canZoomOutTo(t),t<a&&!h||t>a&&!c){e.next=4;break}return e.abrupt("return",((0,ie.a1)(mi,s,t/a,0,i,o,u),n.constrainByGeometry(mi),r.goTo(mi,{animate:!0})));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_scaleRotateTranslateViewpoint",value:function(e,t,i,r,n){var a=this.view,s=a.size,o=a.padding,u=a.constraints,h=a.scale,l=a.viewpoint,c=h*i,d=u.canZoomInTo(c),f=u.canZoomOutTo(c);return(i<1&&!d||i>1&&!f)&&(i=1),(0,ie.S)(l,l,n),(0,ie.a1)(e,l,i,r,t,s,o),u.constrainByGeometry(e)}}]),i}(m.m);(0,m.e)([(0,m.y)()],yi.prototype,"animationManager",void 0),(0,m.e)([(0,m.y)({type:Boolean,readOnly:!0})],yi.prototype,"interacting",void 0),(0,m.e)([(0,m.y)()],yi.prototype,"pan",void 0),(0,m.e)([(0,m.y)()],yi.prototype,"pinch",void 0),(0,m.e)([(0,m.y)()],yi.prototype,"rotate",void 0),(0,m.e)([(0,m.y)()],yi.prototype,"view",void 0),(0,m.e)([(0,m.y)()],yi.prototype,"zoomBox",void 0);var bi=yi=(0,m.e)([(0,m.n)("esri.views.2d.navigation.MapViewNavigation")],yi),wi={shaders:{vertexShader:(0,k.n)("magnifier/magnifier.vert"),fragmentShader:(0,k.n)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var Ti=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,p.Z)(this,i),(e=t.call(this))._handles=new m.X,e._resourcePixelRatio=1,e.visible=!1,e}return(0,v.Z)(i,[{key:"destroy",value:function(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,y.l)((function(){return e.version}),(function(){t.visible=e.visible&&(0,g.r)(e.position)&&e.size>0,t.requestRender()}),y.h),(0,y.l)((function(){return[e.maskUrl,e.overlayUrl]}),(function(){return t._reloadResources()})),(0,y.l)((function(){return e.size}),(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"_createTransforms",value:function(){return{dvs:(0,b.e)()}}},{key:"doRender",value:function(e){var t,i=e.context;if(this._resourcesTask){if(e.drawPhase===E.I.MAP&&this._canRender()){this._updateResources(e);var r=this._magnifier;if(!(0,g.t)(r.position)){var n=e.pixelRatio,a=r.size*n,s=1/r.factor,o=Math.ceil(s*a);this._readbackTexture.resize(o,o);var u=e.state.size,h=n*u[0],l=n*u[1],c=.5*o,d=.5*o,f=(0,Y.a)(n*r.position.x,c,h-c-1),_=(0,Y.a)(l-n*r.position.y,d,l-d-1);i.setBlendingEnabled(!0);var p=f-c,v=_-d,m=this._readbackTexture;i.bindTexture(m,0),i.gl.copyTexImage2D(m.descriptor.target,0,m.descriptor.pixelFormat,p,v,o,o,0);var y=null===(t=this.background)||void 0===t?void 0:t.color,b=y?[y.a*y.r/255,y.a*y.g/255,y.a*y.b/255,y.a]:[1,1,1,1],w=(f+r.offset.x*n)/h*2-1,T=(_-r.offset.y*n)/l*2-1,x=a/h*2,k=a/l*2,M=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(M),M.setUniform4fv("u_background",b),M.setUniform1i("u_readbackTexture",0),M.setUniform1i("u_overlayTexture",6),M.setUniform1i("u_maskTexture",7),M.setUniform4f("u_drawPos",w,T,x,k),M.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),M.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(F.E.TRIANGLE_STRIP,0,4),i.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=(0,g.r)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,g.r)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,_e.j)(function(){var r=(0,c.Z)((0,l.Z)().mark((function r(n){var a,s,o,u,c,d,f;return(0,l.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=(0,g.t)(t)||(0,g.t)(i)?(0,fe.c)(n):null,s=(0,g.r)(t)?(0,S.U)(t,{responseType:"image",signal:n}).then((function(e){return e.data})):a.then((function(e){return e.mask})),o=(0,g.r)(i)?(0,S.U)(i,{responseType:"image",signal:n}).then((function(e){return e.data})):a.then((function(e){return e.overlay})),r.next=5,Promise.all([s,o]);case 5:u=r.sent,c=(0,h.Z)(u,2),d=c[0],f=c[1],e.mask=d,e.overlay=f,e._disposeRenderResources(),e.requestRender();case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=(0,g.G)(this._readbackTexture),this._overlayTexture=(0,g.G)(this._overlayTexture),this._maskTexture=(0,g.G)(this._maskTexture),this._vertexArrayObject=(0,g.G)(this._vertexArrayObject),this._program=(0,g.G)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(e){return(0,O.e)(e,wi)}(t);var r=new Uint16Array([0,1,0,0,1,1,1,0]),n=wi.attributes;this._vertexArrayObject=new B.b(t,n,R.a,{geometry:B.E.createVertex(t,F.F.STATIC_DRAW,r)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new N.E(t,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.NEAREST,flipped:!0,preMultiplyAlpha:!(0,S.I)(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new N.E(t,{target:F.M.TEXTURE_2D,pixelFormat:F.P.ALPHA,internalFormat:F.P.ALPHA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.NEAREST,flipped:!0},this.mask);var a=1/this._magnifier.factor;this._readbackTexture=new N.E(t,{target:F.M.TEXTURE_2D,pixelFormat:F.P.RGBA,internalFormat:F.P.RGBA,dataType:F.G.UNSIGNED_BYTE,wrapMode:F.D.CLAMP_TO_EDGE,samplingMode:F.L.LINEAR,flipped:!1,width:Math.ceil(a*i),height:Math.ceil(a*i)})}}}]),i}(pe.r)},95414:function(e,t,i){i.d(t,{t:function(){return o}});var r=i(74165),n=i(1413),a=i(15861),s=i(40558);function o(e,t){return u.apply(this,arguments)}function u(){return u=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a,o;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.U)(t,(0,n.Z)({responseType:"image"},i));case 2:return a=e.sent,o=a.data,e.abrupt("return",o);case 5:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},4397:function(e,t,i){i.d(t,{a:function(){return p},b:function(){return y},c:function(){return T},l:function(){return m},s:function(){return w},t:function(){return _}});var r=i(74165),n=i(15861),a=i(11752),s=i(61120),o=i(60136),u=i(29388),h=i(15671),l=i(43144),c=i(71802),d=i(48848),f=i(95414),_=function(){function e(t){(0,h.Z)(this,e),this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}return(0,l.Z)(e,[{key:"update",value:function(e){if(this.hasLastValue()){var t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}},{key:"reset",value:function(){this.lastValue=void 0,this.filteredDelta=void 0}},{key:"hasLastValue",value:function(){return void 0!==this.lastValue}},{key:"hasFilteredDelta",value:function(){return void 0!==this.filteredDelta}},{key:"computeDelta",value:function(e){return void 0===this.lastValue?NaN:e-this.lastValue}},{key:"_updateDelta",value:function(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}]),e}(),p=function(){function e(t,i,r){(0,h.Z)(this,e),this._initialVelocity=t,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}return(0,l.Z)(e,[{key:"duration",get:function(){return this._duration}},{key:"isFinished",value:function(e){return e>this.duration}},{key:"friction",get:function(){return this._friction}},{key:"value",value:function(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}},{key:"valueDelta",value:function(e,t){var i=this.value(e);return this.value(e+t)-i}},{key:"valueFromInitialVelocity",value:function(e,t){t=Math.min(t,this.duration);var i=1-this.friction;return e*(Math.pow(i,t)-1)/Math.log(i)}}]),e}(),v=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e,r,n,a,s){var o;return(0,h.Z)(this,i),(o=t.call(this,e,r,n))._sceneVelocity=a,o.direction=s,o}return(0,l.Z)(i,[{key:"value",value:function(e){return(0,a.Z)((0,s.Z)(i.prototype),"valueFromInitialVelocity",this).call(this,this._sceneVelocity,e)}}]),i}(p),m=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,h.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=i,this._friction=r,this.enabled=!0,this._time=new _(.6),this._screen=[new _(.4),new _(.4)],this._scene=[new _(.6),new _(.6),new _(.6)],this._tmpDirection=(0,c.n)()}return(0,l.Z)(e,[{key:"add",value:function(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=null==r||null==i?0:i/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,i){var r,n,a;(0,c.o)(this._tmpDirection,null!==(r=this._scene[0].filteredDelta)&&void 0!==r?r:0,null!==(n=this._scene[1].filteredDelta)&&void 0!==n?n:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);var s=(0,c.s)(this._tmpDirection);s>0&&(0,c.g)(this._tmpDirection,this._tmpDirection,1/s);var o=this._time.filteredDelta;return new v(e,t,i,null==o?0:s/o,this._tmpDirection)}}]),e}(),g=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;(0,h.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=i,this._friction=r,this._maxVelocity=n,this.enabled=!0,this.value=new _(.8),this.time=new _(.3)}return(0,l.Z)(e,[{key:"add",value:function(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){var i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}},{key:"reset",value:function(){this.value.reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;var e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,c.a)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,i){return new p(e,t,i)}}]),e}(),y=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,h.Z)(this,i),t.call(this,e,r,n,a)}return(0,l.Z)(i,[{key:"add",value:function(e,t){var r=this.value.lastValue;if(null!=r){for(var n=e-r;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;e=r+n}(0,a.Z)((0,s.Z)(i.prototype),"add",this).call(this,e,t)}}]),i}(g),b=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e,r,n){return(0,h.Z)(this,i),t.call(this,e,r,n)}return(0,l.Z)(i,[{key:"value",value:function(e){var t=(0,a.Z)((0,s.Z)(i.prototype),"value",this).call(this,e);return Math.exp(t)}},{key:"valueDelta",value:function(e,t){var r=(0,a.Z)((0,s.Z)(i.prototype),"value",this).call(this,e),n=(0,a.Z)((0,s.Z)(i.prototype),"value",this).call(this,e+t)-r;return Math.exp(n)}}]),i}(p),w=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,h.Z)(this,i),t.call(this,e,r,n,a)}return(0,l.Z)(i,[{key:"add",value:function(e,t){(0,a.Z)((0,s.Z)(i.prototype),"add",this).call(this,Math.log(e),t)}},{key:"createMomentum",value:function(e,t,i){return new b(e,t,i)}}]),i}(g);function T(e){return x.apply(this,arguments)}function x(){return x=(0,n.Z)((0,r.Z)().mark((function e(t){var n,a,s,o,u;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.e(221).then(i.bind(i,70221)),a=i.e(2008).then(i.bind(i,62008)),e.t0=f.t,e.next=5,n;case 5:return e.t1=e.sent.default,e.t2={signal:t},s=(0,e.t0)(e.t1,e.t2),e.t3=f.t,e.next=11,a;case 11:return e.t4=e.sent.default,e.t5={signal:t},o=(0,e.t3)(e.t4,e.t5),e.next=16,s;case 16:return e.t6=e.sent,e.next=19,o;case 19:return e.t7=e.sent,u={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,d.f)(t),u));case 22:case"end":return e.stop()}}),e)}))),x.apply(this,arguments)}}}]);
//# sourceMappingURL=3322.317c20a0.chunk.js.map