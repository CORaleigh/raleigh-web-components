"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[2856],{39972:function(e,t,i){i.d(t,{C:function(){return me},D:function(){return xe},F:function(){return _e},S:function(){return be},a:function(){return ne},b:function(){return de},e:function(){return oe},f:function(){return ze},s:function(){return je},t:function(){return He},w:function(){return Ce}});var r,n=i(93433),a=i(29439),s=i(60136),o=i(29388),d=i(74165),u=i(15861),l=i(4942),h=i(37762),c=i(15671),f=i(43144),v=i(50165),g=i(69738),_=i(52155),m=i(73627),y=i(98643),p=i(79146),b=i(27670),x=i(67871),C=i(47672),k=i(2760),N=i(3969),D=i(92692),w=i(35691),I=i(5233),P=i(13994),S=i(71871),L=i(92694),M=i(24695),O=i(6819),F=i(73428),A=i(15820),T=i(77322),R=i(64747),E=i(75272),V=i(40133),U=i(48561),G=i(42),q=i(50252),Z=function(){function e(t){(0,c.Z)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(x.L.I3S_CONTROLLER,this)}return(0,f.Z)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=(0,h.Z)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(i){t.e(i)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this._sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}},{key:"_sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){(0,v.au)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort()}}]),e}(),B=new Map;function H(e,t){var i=B.get(e);return null==i&&(i=new Z(e),B.set(e,i)),i.add(t),{remove:function(){null!=i&&(i.remove(t),i.callbacks.length>0||(B.delete(e),i.destroy()),i=null)}}}var j=(0,f.Z)((function e(t,i,r,n,a){(0,c.Z)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=r,this.ref=n,this.node=a,this.useAsHole=0,this.filterImpact=D.n.NotChecked})),Q=function(){function e(t,i,r,n,a,s,o,d,u,l,h,f,g,_){(0,c.Z)(this,e),this.streamDataController=r,this.viewportQueries=n,this.logger=a,this.holeFilling=s,this._isLoaded=o,this._isReloading=d,this._isSelected=u,this._enable=l,this._needsUpdate=h,this._canRequest=f,this._computeVisibilityObb=g,this._computeNodeFiltering=_,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=D.a.None,this._lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=W(0),this._visibilityCacheVersion=W(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new v.ay({deallocator:null}),this._prefetch=new v.ay({deallocator:null}),this._updates=new K(this._missing),this._imModificationUncategorized=new v.ay({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this._init(i)}return(0,f.Z)(e,[{key:"_init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=D.a.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this.lodMetric=D.a.MaxScreenThreshold,this._lodConversion=se}this._addPage(te(this.rootIndex,this.nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new D.t(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}},{key:"_loadPage",value:function(e){var t=this;this._loading.add(e);var i=this.urlPrefix+e;this.streamDataController.request(i,"json").then((function(i){t._pageQueue.push({pageIndex:e,page:i})})).catch((function(i){t._loading.delete(e),(0,v.I)(i)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),i))}))}},{key:"_addQueuedPages",value:function(e){for(;this._pageQueue.length>0&&!e.done;){var t=this._pageQueue.shift(),i=t.pageIndex,r=t.page;this._addPage(i,r),this._loading.delete(i),e.madeProgress()}this._updateParentsAndLevel()}},{key:"_addPage",value:function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],a=[],s=t.nodes.map((function(t,r){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var d=0;d<o;d++)n.push(t.children[d]);var u="".concat(t.index),l=(0,w.a1)(t.obb),h=(0,N.e)([l.center[0],l.center[1],l.center[2],(0,k.s)(l.halfSize)]),c=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,g={hasSharedResource:!1,hasFeatureData:!!f,attributes:c&&null!=c.resource?"".concat(c.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:v&&null!=v.resource?"".concat(v.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:v?v.definition:-1},_=new D.h(u,e*i.nodesPerPage+r,h,o,0,g,i.lastUpdate,i.lodMetric,i._lodConversion(t.lodThreshold),f?f.featureCount:null);return _.serviceObb=l,_.visibilityObb=i._computeVisibilityObb(_),_.vertexCount=f?f.vertexCount:0,new j(s,o,J(i._visibilityCacheVersion),null,_)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length}},{key:"_updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,r,n){var a=e._getPage(i);if((0,v.r)(a)){var s=ie(i,e.nodesPerPage);a.parents[s]=r;var o=a.nodes[s].node;(0,v.r)(o)&&(o.level=n,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var r=t.pop(),n=this.getNode(r);if((0,v.r)(n))for(var a=0;a<n.childCount;a++)i(this.getChildIndex(n.index,a),r,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"_getPage",value:function(e){return this._nodePages[te(e,this.nodesPerPage)]}},{key:"_getNodeInternal",value:function(e){var t=this._getPage(e);return(0,v.t)(t)?null:t.nodes[ie(e,this.nodesPerPage)]}},{key:"_addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),r=(0,v.r)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);var n=function(e){if(e)for(var t=0;t<e.length;t++){var i,r=(0,h.Z)(re);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){r.e(a)}finally{r.f()}}return{lodMetric:D.a.None,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=(0,v.g)(this._getNodeInternal(t));return o.node=new D.h(e.id,t,(0,N.e)(e.mbs),o.childCount,r,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=(0,w.a1)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,v.r)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"_makeRefNode",value:function(e,t){var i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new j(0,0,J(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),(0,w.ae)(e.renderMbs),(0,w.af)(e.serviceObbInRenderSR),r}},{key:"populateChildren",value:function(e,t){var i=(0,v.g)(this._getNodeInternal(e)),r=(0,v.g)(this._getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(var n=0;n<t.length;n++){var a=this._makeRefNode(t[n],e);r.children.push(a)}}},{key:"getNode",value:function(e){var t=this._getNodeInternal(e);return(0,v.r)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this._forAllNodes((function(i,r){((0,v.r)(i.node)&&i.node.id===e||(0,v.r)(i.ref)&&i.ref.id===e)&&(t=r)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this._getPage(e);if((0,v.t)(i))return-1;var r=i.nodes[ie(e,this.nodesPerPage)];return i.children[r.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this._getPage(e);return(0,v.r)(t)?t.parents[ie(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this._getNodeInternal(e);return(0,v.r)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"removeAllGeometryObbs",value:function(){this._forAllNodes((function(e){(0,v.r)(e.node)&&(e.node.geometryObb=null)}))}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=W(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this._getNodeInternal(e);(0,v.r)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=J(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this._getNodeInternal(e);(0,v.r)(t)&&(X(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"updateElevationChanged",value:function(e){var t=this._getNodeInternal(e);if(!(0,v.t)(t))if(this.needNodeElevationRange){var i=(0,v.r)(t.node)?t.node:t.ref;if(!(0,v.t)(i)){var r=i.elevationRange;(0,v.t)(r)||(r.valid=!1)}}else this.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){var t=this._getNodeInternal(e);(0,v.r)(t)&&(0,v.r)(t.node)&&(t.node.geometryObb=null,(0,w.ae)(t.node.renderMbs),(0,w.af)(t.node.serviceObbInRenderSR))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;(0,v.t)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"_updateElevationRange",value:function(e){var t=this._getNodeInternal(e);if((0,v.t)(t))return null;var i=(0,v.r)(t.node)?t.node:t.ref;if((0,v.t)(i))return null;var r=i.elevationRange;if((0,v.r)(r)&&r.valid)return r;for(var n=new D.i,a=!1,s=0;s<t.childCount;s++){var o=this._updateElevationRange(this.getChildIndex(e,s));(0,v.t)(o)?a=!0:(n.min=Math.min(n.min,o.min),n.max=Math.max(n.max,o.max))}if(0===t.childCount||a&&(0,v.r)(t.node)&&t.node.resources.geometry){var d=this.viewportQueries.getElevationRange(i);(0,v.r)(d)&&(n.min=Math.min(n.min,d.min),n.max=Math.max(n.max,d.max))}return(0,v.r)(r)&&r.min===n.min&&r.max===n.max?(r.valid=!0,r):(n.valid=!0,i.elevationRange=n,this.invalidateBoundingVolumeCache(e),n)}},{key:"isNodeVisible",value:function(e){var t=this._getNodeInternal(e);if((0,v.t)(t)||(0,v.r)(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!$(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,r=(0,v.r)(i)&&((0,v.t)(t.ref)||(0,v.r)(i.visibilityObb))?i:(0,v.r)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,v.r)(i)||(0,v.r)(t.ref))&&t.filterImpact===D.n.NotChecked){var n=(0,v.r)(i)?i.mbs:(0,v.r)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):D.n.Unmodified}var a=(0,v.r)(i)&&t.filterImpact===D.n.Culled,s=!((0,v.r)(i)&&i.imModificationImpact===D.o.Culled)&&(!r||this.viewportQueries.isNodeVisible(r))&&!a;return t.visibilityCache=Y(s,this._visibilityCacheVersion),s}return ee(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this._getNodeInternal(e);return!((0,v.r)(t)&&(0,v.r)(t.node)&&(0,v.r)(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==D.o.NotChecked))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,r,n){var a=this._getPage(e);if(!(0,v.t)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,d=t.childOffset;d<s;++d){var u=a.children[d],l=this._getNodeInternal(u);(0,v.r)(l)&&(0,v.r)(l.node)&&this.isGeometryVisible(u)&&o.push(l)}r/=o.length;for(var h=0,c=o;h<c.length;h++){var f=c[h],g=(0,v.g)(f.node).index;this._isLoaded(g)||this._isReloading(g)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(g,f,i+1,r,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this._getNodeInternal(e);if((0,v.t)(t))return!1;if("always"===this.holeFilling)return!0;if($(t.useAsHole,this._version))return ee(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var r=i.delta*i.coverage<=.5;return t.useAsHole=Y(r,this._version),r}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=W(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this._forAllNodes((function(e){var i=e.node;(0,v.r)(i)&&(i.imModificationImpact=D.o.NotChecked,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this._forAllNodes((function(e){if((0,v.r)(e)){e.filterImpact=D.n.NotChecked;var i=e.node;(0,v.r)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var r=this;if(this._dirty){this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),z.clear();var n=!0,a=new ae,s=new ae,o=this._imModificationUncategorized;o.clear();var d=new Set;this.traverseVisible((function(u,l,h){if((0,v.t)(l)){var c=r._entryPriority(u);c===1/0&&(c=r._entryPriority(h));var f=te(u,r.nodesPerPage);return z.set(f,Math.max(c,z.get(f)||0)),r._loading.has(f)||r._failedPages.has(f)||r._missing.push(f),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,c))}var g=l.node;if(r._updateNodeFeatureEstimate(g,s),(0,v.t)(g)){var _=r._entryPriority(u);return r._loading.has(u)||r._failedNodes.has(u)||(r._missing.push(u),z.set(u,_)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,_))}var m=(0,v.g)(r._getPage(u));if(0===r._missing.length&&0===r.nodesPerPage)for(var y=0;y<l.childCount;y++){var p=m.children[l.childOffset+y],b=r._getNodeInternal(p);!(0,v.r)(b)||b.node||r._loading.has(p)||r._failedNodes.has(p)||(z.set(p,r._entryPriority(p)),r._prefetch.push(p))}if(!g.failed&&g.resources.hasFeatureData)if(d.add(g.id),r._isLoaded(u)){if(a.known+=g.memory,++a.knownNodes,r._isSelected(g)?l.childCount>0&&(n=!1):(a.unremoved+=g.memory,n=!1),r._needsUpdate(g)){var x=r._entryPriority(u);z.set(u,x),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,x),r._updates.update.push(u)}}else if(g.memory&&(a.known+=g.memory,++a.knownNodes),r._isSelected(g)){if(l.childCount>0&&(n=!1),g.memory?(a.missing+=g.memory,a.known+=g.memory,++a.knownNodes):++a.missingNodes,e.includes(g.index))return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r._entryPriority(u)),void(r._updates.cancel=r._updates.cancel.filter((function(e){return e!==g.index})));if(t.done||!r._enable(g)){var C=r._entryPriority(u);z.set(u,C),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,C),r._updates.add.push(u),r.layerHasModifications&&i&&(0,v.r)(g)&&g.imModificationImpact===D.o.NotChecked&&o.push(u)}else t.madeProgress()}else r._isReloading(u)&&r._updates.remove.push(u);else n&&l.childCount>0&&r._isSelected(g)&&(n=!1)}));var u=this._updates.add;u.length>0&&this.layerHasModifications&&(o.length>0&&i(o),u.filterInPlace((function(e){var t=r._getNodeInternal(e),i=(0,v.t)(t)||(0,v.t)(t.node)||t.node.imModificationImpact!==D.o.Culled;return i||r.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||r._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return z.get(e)-z.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=z.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return z.get(e)>=r._maxUnloadedPrio})).sort((function(e,t){return z.get(e)-z.get(t)})),this._updates.update.sort((function(e,t){return z.get(e)-z.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,z.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,s=10;s--;){var o=new ae;if(this._updateFeatureEstimate(r,o),this._computeFeatureEstimate(o)<=e){if(r>=t||o.missingNodes>0||0===s)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return this._version=W(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=W(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate((0,v.r)(r)&&r.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!((0,v.t)(e)||e.failed||(0,v.t)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,v.r)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return z.get(e)-z.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if((0,v.t)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&$(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&i>s.lodLevel}else n=i>0}else n=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=n,t.version=Y(!0,this._version),t):(t=new D.d(r,n,i,Y(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=(0,v.g)(this._getNodeInternal(e)).ref;if((0,v.t)(i))this._failedNodes.add(e);else{var r=i.id,n=this.urlPrefix+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(i){a();var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t._addNode(n,e);t.nodeTraversalState(s)}}),(function(i){a(),(0,v.I)(i)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("#validateNode()",i.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)r("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i.logger.error("#validateNode()",i.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new D.t("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((function(e){(0,v.r)(e.node)&&(e.node.failed=!1)}))}},{key:"_entryPriority",value:function(e){var t=this._getNodeInternal(e),i=this.getParentIndex(e);if((0,v.t)(t)||i<0&&null==t.node)return i<0?1/0:this._entryPriority(i);var r=0;if(t.node&&i>=0){var n=this._nodeTraversalState.get(i);null!=n&&(r=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=(0,v.r)(t.ref)?this.viewportQueries.distToPOI(t.ref):(0,v.r)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-r*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this._getNodeInternal(this.rootIndex);(0,v.t)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,r){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&r(e,i,t);else if(this.isNodeVisible(e)&&(r(e,i,t),null!=i.node)){var n=this.nodeTraversalState(i.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=(0,v.g)(this._getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],d=this._getNodeInternal(o);(0,v.r)(d)?this._traverseVisible(o,e,d,r):r(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,r=this._getNodeInternal(i);(0,v.r)(r)&&this._traverseChildren(i,r,t)}},{key:"_traverseChildren",value:function(e,t,i){var r=this._getPage(e);if(!(0,v.t)(r))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=r.children[a],o=this._getNodeInternal(s);(0,v.r)(o)&&(0,v.r)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateChildrenLoaded",value:function(e,t){for(var i=this.getNode(e);(0,v.r)(i);)i.childrenLoaded+=t,i=this.getParent(i.index)}},{key:"checkChildrenLoadedInvariant",value:function(){var e=this;if((0,v.t)(this.rootNode))return!0;var t=[];return function i(r){var n=e._isLoaded(r.index)||e._isReloading(r.index)?1:0;return e.traverseChildren(r,(function(e){return n+=i(e),!1})),r.childrenLoaded!==n&&t.push(r.index),n}(this.rootNode),t.length&&this.logger.error("childrenLoaded invariant broken at following nodes: "+t.join(",")),t.length>0}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e,t){this.needNodeElevationRange=t&&e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._forAllNodes((function(e){X(e),(0,v.r)(e.node)&&(e.node.elevationRange=null),(0,v.r)(e.ref)&&(e.ref.elevationRange=null)})),this.viewportQueries.updateElevationInfo(e)}},{key:"_forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e._addNode(t,i)}}}}]),e}(),z=new Map,K=function(){function e(t){(0,c.Z)(this,e),this.missing=t,this.update=new v.ay({deallocator:null}),this.add=new v.ay({deallocator:null}),this.remove=new v.ay({deallocator:null}),this.cancel=[]}return(0,f.Z)(e,[{key:"reset",value:function(e){this.add.clear(),this.update.clear(),this.cancel=e}}]),e}();function X(e){(0,v.r)(e.node)&&((0,w.ae)(e.node.renderMbs),(0,w.af)(e.node.serviceObbInRenderSR)),(0,v.r)(e.ref)&&((0,w.ae)(e.ref.renderMbs),(0,w.af)(e.ref.serviceObbInRenderSR))}function J(e){return(0,w.a6)(e,-2)}function W(e){return(0,w.a6)(e,2)}function Y(e,t){return t+(e?1:0)}function $(e,t){return(-2&e)===t}function ee(e){return 1==(1&e)}function te(e,t){return 0===t?0:e/t|0}function ie(e,t){return 0===t?e:e%t}var re=[["maxScreenThreshold",D.a.MaxScreenThreshold],["screenSpaceRelative",D.a.ScreenSpaceRelative],["removedFeatureDiameter",D.a.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",D.a.DistanceRangeFromDefaultCamera]];var ne,ae=(0,f.Z)((function e(){(0,c.Z)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}));function se(e){return Math.sqrt(e*(4/Math.PI))}!function(e){e[e.FadeIn=0]="FadeIn",e[e.FadeOut=1]="FadeOut"}(ne||(ne={}));var oe,de,ue=function(){function e(t){(0,c.Z)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return(0,f.Z)(e,[{key:"startNodeLoading",value:function(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if((0,v.t)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));le.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,this.layerView.nodeCrossfadingEnabled);var r=le.length;this._removeNodes(le,e);var n=le.length<r;return 0!==le.length&&(this._lodGlobalDirty=!0),le.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,i,r){if((0,v.t)(e))return!1;var n=e.index,a=this._index,s=this.layerView,o=a.nodeTraversalState(e),d=this._isChosenMaxLOD(o),u=!e.resources.hasFeatureData;if(d&&u)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;var l=s.isNodeLoaded(n);if(r&&l&&d){var h=!i&&this.hasNoVisibleChildren(e);s.fadeNode(n,ne.FadeIn,!h)}var c=l&&(!s.isNodeFullyFadedIn||s.isNodeFullyFadedIn(n));if(l&&(s.updateNodeState(n,d?D.c.Leaf:D.c.Hole),d))return c&&this._removeChildrenRecursive(e),c;var f=e.childCount>0,g=f;if(f)for(var _=0;_<e.childCount;_++){var m=a.getChildIndex(n,_),y=a.getNode(m);(0,v.r)(y)?a.isGeometryVisible(m)&&!this._lodGlobalHandling(y,t,i||c,r)&&this._isNodeInScaleBounds(y)&&(g=!1):a.isNodeVisible(m)&&(g=!1)}var p=l&&!d&&(g||le.length<t);p&&le.push(n),!r||p||!l||i||g||s.fadeNode(n,ne.FadeIn,!1);var b=!e.resources.hasFeatureData;return g||c&&!p||b}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&le.push(e.index),e.childrenLoaded>0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(t.layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0)})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,(function(e){if(!r||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t._isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(i=!0),t.layerView.isNodeLoaded(e.index)?(r=!1,!1):e.childrenLoaded>0})),r&&i}},{key:"_isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),le=new v.ay({deallocator:null});!function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2"}(oe||(oe={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(de||(de={}));var he=function(){function e(t,i){var r=this;(0,c.Z)(this,e),this._textureRep=t,this._disposed=!1;var n=this._textureRep.acquire(i);(0,v.R)(n)?(n.then((function(e){r._disposed?(0,v.aP)(e):r._textureRef=e})),this.loadPromise=n):this._textureRef=n}return(0,f.Z)(e,[{key:"dispose",value:function(){this._textureRef=(0,v.aP)(this._textureRef),this._disposed=!0}},{key:"glTexture",get:function(){return(0,v.r)(this._textureRef)?this._textureRef.glTexture:null}}]),e}();function ce(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var fe={ktx2:oe.KTX2,basis:oe.Basis,dds:oe.DDS_S3TC,png:oe.PNG,jpg:oe.JPG,"ktx-etc2":oe.KTX_ETC2},ve=(r={},(0,l.Z)(r,L.T.KTX2_ENCODING,oe.Basis),(0,l.Z)(r,L.T.BASIS_ENCODING,oe.Basis),(0,l.Z)(r,L.T.DDS_ENCODING,oe.DDS_S3TC),(0,l.Z)(r,"image/png",oe.PNG),(0,l.Z)(r,"image/jpg",oe.JPG),(0,l.Z)(r,"image/jpeg",oe.JPG),(0,l.Z)(r,"image/ktx",oe.KTX_ETC2),r);function ge(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],n=i&&e.textureDefinitions[i],a=_e();if(null!=r){var s=r.params;s.diffuse&&(a.metallicRoughness.baseColorFactor=[s.diffuse[0],s.diffuse[1],s.diffuse[2],1]),null!=s.doubleSided&&(a.doubleSided=s.doubleSided,a.cullFace=s.doubleSided?M.n.None:M.n.Back),"none"!==s.cullFace&&"front"!==s.cullFace&&"back"!==s.cullFace||(a.cullFace="none"===s.cullFace?M.n.None:"back"===s.cullFace?M.n.Back:M.n.Front),s.transparency&&(a.metallicRoughness.baseColorFactor[3]=(0,k.o)(1-s.transparency,0,1)),(s.useVertexColorAlpha||a.metallicRoughness.baseColorFactor[3]<1)&&(a.alphaMode="blend")}var o=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(a.wrapTextures=!0);var d=de.Color;"rgba"===n.channels&&(a.alphaMode="blend",d|=de.AlphaMask);var u=n.images.length-1,l=n.images[u],h=function(e){return e&&e.split("/").pop()},c=Array.isArray(n.encoding)?ce(n.encoding.map((function(e,t){return{name:h(l.href[t]),encoding:ve[e]||0}}))):[{name:h(l.href),encoding:ve[n.encoding]||0}];o.push({id:0,usage:d,encodings:c}),a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:o}}var _e=function(){return{alphaMode:"opaque",alphaCutoff:L.a0,doubleSided:!0,cullFace:M.n.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function me(e,t,i,r){if((0,v.t)(e)||null==e.data)return null;var n=e.data,a=!(n instanceof HTMLImageElement)||(0,k.ah)(n.width)&&(0,k.ah)(n.height),s=r.renderingContext.parameters.maxMaxAnisotropy,o=i&&!r.capabilities.shaderTextureLOD?1:s,d=a&&!e.downsampled&&o>1,u=i||!t.wrapTextures?ye:pe,l=ke(e.encoding),h=e.usage&de.Color?"opaque"===t.alphaMode?3:4:3;return new L.T(n,{mipmap:d,maxAnisotropy:o,encoding:l,wrap:u,components:h,noUnpackFlip:!0})}var ye={s:O.D.CLAMP_TO_EDGE,t:O.D.CLAMP_TO_EDGE},pe={s:O.D.REPEAT,t:O.D.REPEAT};function be(e,t,i,r,n,a){var s=a.rendererTextureUsage,o=function(e){return function(e,t,i){if((0,v.t)(e)||i===de.None)return null;for(var r=0;r<e.length;r++){var n=e[r];if((0,v.r)(n)&&0!=(n.usage&i)){var a=t[r];return(0,v.r)(a)?a.id:null}}return null}(r,i,e&s)},d=t.metallicRoughness.baseColorFactor,u=(0,k.o)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[d[0],d[1],d[2],u],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=a.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=a.isIntegratedMesh,e.textureAlphaCutoff="mask"===t.alphaMode?t.alphaCutoff:L.a0,e.alphaDiscardMode="opaque"===t.alphaMode?M.C.Opaque:"mask"===t.alphaMode?M.C.Mask:M.C.MaskBlend;var l=[],h=o(de.Color|de.AlphaMask);(0,v.r)(h)&&(e.baseColorTexture=new he(n,h),l.push(e.baseColorTexture.loadPromise));var c=o(de.MetallicRoughness);(0,v.r)(c)&&(e.metallicRoughnessTexture=new he(n,c),l.push(e.metallicRoughnessTexture.loadPromise));var f=o(de.Emissive);(0,v.r)(f)&&(e.emissionTexture=new he(n,f),l.push(e.emissionTexture.loadPromise));var g=o(de.Occlusion);(0,v.r)(g)&&(e.occlusionTexture=new he(n,g),l.push(e.occlusionTexture.loadPromise));var _=o(de.Normal);return(0,v.r)(_)&&(e.normalTexture=new he(n,_),l.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=a.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=(0,w.ag)(a.viewSpatialReference),Promise.all(l)}function xe(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,r=(0,v.c)("disable-feature:i3s-basis")?0:oe.Basis|oe.KTX2,n=oe.JPG|oe.PNG,a=r|oe.DDS_S3TC;return n|(t?a:0)|(i?r:0)}function Ce(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}function ke(e){switch(e){case oe.KTX2:return L.T.KTX2_ENCODING;case oe.Basis:return L.T.BASIS_ENCODING;case oe.DDS_S3TC:return L.T.DDS_ENCODING;case oe.PNG:return"image/png";case oe.JPG:return"image/jpeg";case oe.KTX_ETC2:return"image/ktx";default:return""}}var Ne=function(){function e(t,i,r,n,a,s){if((0,c.Z)(this,e),this.streamDataController=i,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=a,this.options=s,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var o=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return function(e,t){var i=new Map,r=function(e,t){if((0,v.t)(e))return-1;if(i.has(e.id)){var r=i.get(e.id);return r.usage|=t,r.id}var n=i.size;return i.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,s=t.emissiveFactor,o=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),d=o?L.bx[0]:n?n.metallicFactor:1,u=o?L.bx[1]:n?n.roughnessFactor:1,l="mask"===t.alphaMode?de.Color|de.AlphaMask:de.Color,h={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,l),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,de.MetallicRoughness),metallicFactor:d,roughnessFactor:u},c={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?M.n.None:"back"===t.cullFace?M.n.Back:"front"===t.cullFace?M.n.Front:void 0,normalTextureId:r(t.normalTexture,de.Normal),emissiveTextureId:r(t.emissiveTexture,de.Emissive),occlusionTextureId:r(t.occlusionTexture,de.Occlusion),emissiveFactor:s?[s[0],s[1],s[2]]:[0,0,0],metallicRoughness:h,wrapTextures:!1,hasParametersFromSource:o},f=[];return i.forEach((function(t,i){var r=t.usage,n=(0,v.r)(e)&&e[i]&&e[i].formats,a=n?ce(n.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:fe[i]}}))):[];f.push({id:i,usage:r,encodings:a})})),{material:c,textures:f}}(o,e)}))}}return(0,f.Z)(e,[{key:"_load",value:function(e,t,i){return this.streamDataController.request(e,t,i)}},{key:"_loadAttribute",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this._load(r,"binary",i).then((function(e){return(0,S.I)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var r=this;return(0,v.E)(t.map((function(t){return r._loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var n={},a=0;a<t.length;++a)if(i[a].value)n[t[a].name]=i[a].value;else{if((0,v.I)(i[a].error))throw i[a].error;r.logger.error("#loadAttributes",r.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=(0,u.Z)((0,d.Z)().mark((function e(t,i){var r,n,a,s,o,u,l,h,c,f,g,_,m,y,p,b,x,C,k,N,D,w;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this.requiredAttributes&&t.resources.attributes?(0,I.a)(this.loadAttributes(t,this.requiredAttributes,i)):null,n=Se(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,u=o?(0,I.a)(this._loadGeometry(t.resources.geometry,s,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this._loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(l=e.t0,h=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=l?ge(l):null,c=h&&h.material,f=h&&h.textures,g="".concat(t.id),!(_=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this._loadFeatureData(g,i);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(m=e.t1,y=_?we(m):De(c),p=(0,v.t)(y)&&Ie(m),b=null!=f&&f.length>0?(0,I.a)(this.loadTextures(t,f,i)):null,x=null,C=null,!u){e.next=39;break}return e.t2=I.i,e.next=35,u;case 35:e.t3=e.sent,x=(0,e.t2)(e.t3),k=Pe(this.defaultGeometrySchema,l),C=(0,S.w)(a,k);case 39:if(!b){e.next=47;break}return e.t5=I.i,e.next=43,b;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(N=e.t4,!r){e.next=57;break}return e.t8=I.i,e.next=53,r;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:if(D=e.t7,w=D?{attributeData:D,loadedAttributes:this.requiredAttributes}:null,!(0,v.r)(y)){e.next=62;break}return e.abrupt("return",{geometryData:y,attributeDataInfo:w,geometryBuffer:x,geometryDescriptor:C,requiredTextures:f,textureData:N});case 62:if(!(0,v.r)(p)){e.next=64;break}return e.abrupt("return",{pointData:p,attributeDataInfo:w,geometryBuffer:x,geometryDescriptor:C,requiredTextures:f,textureData:N});case 64:throw new Error;case 65:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_loadShared",value:function(t,i){var r="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this._load(r,"json",i).then((function(t){return e._fixTextureEncodings(t),e._addAbsoluteHrefTexture(t,r),t}))}},{key:"_loadTexture",value:function(e,t,i,r,n,a){var s=!1;return n===oe.DDS_S3TC||n===oe.KTX2||n===oe.Basis?this._load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:n,downsampled:s}})):this._load(e,"image",a).then((function(e){var a=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),d=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=o,u.height=d,u.getContext("2d").drawImage(e,0,0,o,d),a=u,s=!0}return{id:t,usage:i,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var r=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Ce(t.encodings,r.options.textureEncodings);if(null==s)return r.logger.error("#loadTextures",r.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,d="".concat(r.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return r._loadTexture(d,t.id,t.usage,n,s.encoding,i)})))}},{key:"_loadFeatureData",value:function(e,t){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this._load(i,"json",t)}},{key:"_loadGeometry",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this._load(r,"binary",i)}}],[{key:"_addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++){var a,s=n[r],o=(0,h.Z)(i[s].images);try{for(o.s();!(a=o.n()).done;){var d=a.value;Array.isArray(d.href)?d.hrefConcat=d.href.map((function(e){return(0,P.Q)(e,t)})):d.hrefConcat=(0,P.Q)(d.href,t)}}catch(u){o.e(u)}finally{o.f()}}}},{key:"_fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a=r.encoding[n];"data:"===a.substring(0,5)&&(r.encoding[n]=a.substring(5))}else{var s=r.encoding;"data:"===s.substring(0,5)&&(r.encoding=s.substring(5))}}}}]),e}();function De(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}function we(e){var t,i=(0,h.Z)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.geometries;if(null!=n){var a,s=(0,h.Z)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[r.id],featureDataPosition:r.position,geometries:[o]}}}catch(d){s.e(d)}finally{s.f()}}}}catch(d){i.e(d)}finally{i.f()}return null}function Ie(e){var t,i=new Array,r=(0,h.Z)(e.featureData);try{for(r.s();!(t=r.n()).done;){var n=t.value;null!=n.position&&i.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){r.e(a)}finally{r.f()}return i}function Pe(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,v.m)(e)).vertexAttributes.region,e}function Se(e,t){var i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;var r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(var n=0;n<r.length;n++){var a=r[n];if(null==a.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=r[n];else if("draco"===a.compressedAttributes.encoding&&!(0,v.c)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=a,i}return i}var Le=function(){function e(t,i){(0,c.Z)(this,e),this.requester=t,this.apiKey=i,this.activeRequests=new Set}return(0,f.Z)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,i){var r=this,n=new AbortController,a=(0,v.Z)(i,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),d={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(d),(0,v.bs)(o,(function(){var e;d.abortController=null,null!==(e=d.abortHandle)&&void 0!==e&&e.remove(),d.abortHandle=null,r.activeRequests.delete(d)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,i;null!==(t=e.abortController)&&void 0!==t&&t.abort(),e.abortController=null,null===(i=e.abortHandle)||void 0===i||i.remove()})),this.activeRequests.clear()}}]),e}(),Me=1e5,Oe=function(){function e(t,i,r,n,a,s,o,d){var u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};(0,c.Z)(this,e),this._indexSR=t,this._renderCoordsHelper=i,this.clippingArea=a,this._elevationProvider=s,this._viewingMode=o,this._options=u,this._frustum=(0,A.H)(),this._useFrustumCulling=!1,this._poi=(0,k.n)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=(0,w.R)(),this._tmp1=(0,k.n)(),this._tmp2=(0,k.n)(),this._tmp3=(0,k.n)(),this._tmp0=(0,k.n)(),this._screenspaceErrorBias=u.screenspaceErrorBias||1,this._progressiveLoadFactor=u.progressiveLoadFactor||1,this.updateCamera(r,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(d),this._tmpPoint=(0,b.v)(0,0,0,t),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||(0,T.T)(this.engineSR)),this._indexSREllipsoidRadius=(0,F.p)(this._indexSR).radius}return(0,f.Z)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=w.ah.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,w.ai)((0,w.o)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&(0,A.s)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}},{key:"updateClippingArea",value:function(e){this.clippingArea=e}},{key:"getElevationRange",value:function(e){if((0,v.t)(this._elevationContext))return null;var t=e.mbs[0],i=e.mbs[1],r=e.mbs[2],n=e.mbs[3],a="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(t,i,r,n,this._indexSR,a);var s=this._elevationProvider.getElevation(t,i,r,this._indexSR,a);return(0,v.r)(s)?{min:s,max:s}:null}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return(0,w.O)(t)||((0,k.B)(t,e.mbs),this._elevationContext&&t[3]<Me&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,w.aj)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,y.b)(t,this._indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if((0,v.r)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb,i=.01*this._indexSREllipsoidRadius;return(0,v.t)(t)||!(0,w.Q)(t)||this._isECEFOBBInLocalMode&&t.halfSize.some((function(e){return e>i}))?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRange),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i,r){if((0,v.t)(t))t=(0,w.R)();else if((0,w.Q)(t))return t;var n=0,a=0;if(this._elevationContext&&(0,v.r)(r)&&Number.isFinite(r.min))switch(this._elevationContext.mode){case"relative-to-ground":n=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+r.min-e.center[2],a=r.max-r.min;break;case"on-the-ground":n=r.min-e.center[2],a=r.max-r.min}else this._elevationContext&&i<Me&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],n=(0,w.aj)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return a>0?((0,w.ak)(e,this._indexSR,this._tmpObb,this.engineSR,n),(0,w.al)(this._tmpObb,0,a,this._viewingMode,t)):(0,w.ak)(e,this._indexSR,t,this.engineSR,n),t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return(0,v.r)(i)?(0,w.am)(i,this._frustum):(0,A.d)(this._frustum,(0,R.C)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return(0,v.r)(t)?(0,w.am)(t,this._frustum):this.isNodeVisible(e)}},{key:"_isMBSinClippingArea",value:function(e){return!!(0,v.t)(this.clippingArea)||(0,w.a4)(this.clippingArea,e)!==w.a5.OUTSIDE}},{key:"_screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),r=Math.sqrt((0,k.p)(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=(0,k.x)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,k.s)(t)+i)/(0,k.x)(t,this._camPos);return Math.min(1,r)}},{key:"hasLOD",value:function(e){return e.lodMetric!==D.a.None}},{key:"_getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"_getDistanceGlobeMode",value:function(e,t){var i=(0,k.s)(t),r=(0,k.s)(e)-i;(0,k.q)(this._tmp0,e,(0,k.P)(e,t)/(0,k.v)(e));var n=(0,k.p)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(r);var s=(0,k.q)(this._tmp0,t,1/i),o=i,d=a*a/2/o,u=(0,k.q)(this._tmp1,s,o-d),l=e,h=(0,k.e)(this._tmp2,l,u),c=(0,k.e)(this._tmp2,h,(0,k.q)(this._tmp3,s,(0,k.P)(s,h))),f=(0,k.u)(this._tmp2,u,(0,k.q)(this._tmp2,c,a/(0,k.s)(c))),v=(0,k.x)(l,f);if(r>=2e5){var g=(0,k.e)(this._tmp1,l,f),_=(0,k.P)(g,s)/(0,k.s)(g);_<.08&&(_=1e-4),v/=_}return v}},{key:"_getDistance",value:function(e,t){return this.engineSR===(0,F.O)(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(e.lodMetric===D.a.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){var t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case D.a.ScreenSpaceRelative:var i=this.getRenderMbs(e),r=this._getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,a=r+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case D.a.MaxScreenThreshold:var s=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case D.a.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case D.a.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return(0,k.x)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return(0,k.x)(this._camPos,this._poi)}}]),e}(),Fe=v.s.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Ae=1e-4,Te=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(e){var r;return(0,c.Z)(this,i),(r=t.call(this,e)).screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leavesReached=!1,r.scaleVisibilityEnabled=!0,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new v.ay({deallocator:null}),r._loadedNodeScales=new Map,r._modificationsNodeFilteringArray=new v.ay,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new g.u,r._idleQueue=new x.i,r._elevationUpdateNodes=new v.ay({deallocator:null}),r._errorCount=0,r}return(0,f.Z)(i,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"useMaximumNumberOfFeatures",get:function(){return!this.isMeshPyramid&&((0,v.t)(this.layer.priority)||"High"===this.layer.priority)}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(w.an.I3S_INDEX);return new Le(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(w.an.I3S_DATA);return new Le(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return(0,w.ao)(this.layer)}},{key:"crsIndex",get:function(){return(0,w.K)(this.layer)}},{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"rootNodeVisible",get:function(){if((0,v.r)(this._index)){var e=this._index.rootNode;if((0,v.r)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this,t=this.layerView,i=this.layer;this._disableMemCache=!t.loadCachedGPUData||!t.addCachedGPUData,this._lodHandling=new ue(t),this._defaultGeometrySchema=i.store.defaultGeometrySchema,this.disableIDBCache=(0,v.c)("disable-feature:idb-cache"),"fields"in i&&(this._fields=i.fields,this._attributeStorageInfo=i.attributeStorageInfo),this.addResolvingPromise(Promise.all([i.indexInfo,i.when(),t.when()]).then((function(r){var n=(0,a.Z)(r,1)[0];if(!e.destroyed&&t&&!t.destroyed){var s=t.view,o=s.resourceController;e._setClippingArea(s.clippingArea),e.own([(0,m.l)((function(){var e,t;return null===s||void 0===s||null===(e=s.pointsOfInterest)||void 0===e||null===(t=e.focus)||void 0===t?void 0:t.renderLocation}),(function(t){return e._pointOfInterestChanged(t)}),m.h),(0,m.l)((function(){return o.memoryController.memoryFactor}),(function(){return e._setCameraDirty()}),m.U),(0,m.l)((function(){return t.suspended}),(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},r=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=r):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,r)}),m.h),H(t.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),(0,m.l)((function(){return t.uncompressedTextureDownsamplingEnabled}),(function(){return e.restartNodeLoading()})),(0,m.l)((function(){return[e.featureTarget,e.fixedFeatureTarget]}),(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),(0,m.l)((function(){var e;return null===(e=s.state)||void 0===e?void 0:e.contentCamera}),(function(){return e._setCameraDirty()})),(0,m.l)((function(){return i.elevationInfo}),(function(t){return e._elevationInfoChanged(t)})),(0,m.l)((function(){return i.effectiveScaleRange}),(function(){return e._scaleBoundsChanged()})),(0,m.l)((function(){return t.lodFactor}),(function(){return e._setCameraDirty()})),(0,m.l)((function(){return t.availableFields}),(function(){return e._requiredFieldsChange()})),(0,m.l)((function(){return t.holeFilling}),(function(t){return(0,v.r)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new Oe(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,e.isMeshPyramid?s.basemapTerrain:s.elevationProvider,(0,C.o)(s.viewingMode),e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new Q(i,n,e.indexStreamController,e._viewportQueries,Fe,t.holeFilling,(function(e){return t.isNodeLoaded(e)}),(function(e){return t.isNodeReloading(e)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,D.c.Leaf)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(e){return t.computeVisibilityObb?t.computeVisibilityObb(e):null}),null!==t&&void 0!==t&&t.computeNodeFiltering?function(e){return t.computeNodeFiltering(e)}:void 0),e._index.updateElevationInfo(e.layer.elevationInfo,e.isMeshPyramid),e._index.imModificationsChanged(!!t.hasModifications),e._startNodeLoading()}}))),this._tmpPoint=(0,b.v)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,r=this.layerView;(0,v.r)(i)&&(null===r||void 0===r?void 0:r.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var r=i.getNode(e);(0,v.r)(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Ee.prune(),(0,v.r)(Re)&&(Re.hide(),Re=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=Ue(e,i),n=Ue(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Ve(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=(0,p.u)();(0,w.m)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){(0,v.r)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),(0,v.r)(this._index)&&(this._index.progressiveLoadPenalty=qe.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),(0,v.r)(this._viewportQueries)&&(0,v.r)(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this._index;if((0,v.t)(i)||(0,v.t)(i.rootNode))return null;var r=this._elevationUpdateNodes;return r.clear(),(0,w.ap)(e,t,i.rootNode,this.crsIndex,i,(function(e){return r.push(e.index)})),r.length&&(r.forAll((function(e){return i.updateElevationChanged(e)})),this._setCameraDirty()),r}},{key:"getParentIndex",value:function(e){return(0,v.r)(this._index)&&this._index.getParentIndex(e)}},{key:"removeAllGeometryObbs",value:function(){(0,v.r)(this._index)&&this._index.removeAllGeometryObbs()}},{key:"_elevationInfoChanged",value:function(e){(0,v.t)(this._index)||(this._index.updateElevationInfo(e,this.isMeshPyramid),this._setCameraDirty())}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t){var i=this,r=this._index;if(!(0,v.t)(r)){var n=r.rootNode;!(0,v.t)(n)&&(0,y.z)(e,t,Ze,this.crsIndex)&&this._loadedNodeScales.forEach((function(e,t){var n=r.getNode(t);(0,v.r)(n)&&(0,p.g)(Ze,n.mbs)&&i._loadedNodeScales.set(t,i._computeScale(n))}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=(0,E.r)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return(0,v.t)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return(0,v.r)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,v.t)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Fe.error("Error during processing: "+i):50===this._errorCount&&Fe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||(0,v.t)(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)})),this._idleQueue.runTask(e),e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating())}},{key:"_processIndex",value:function(e){var t=this;if((0,v.t)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading()||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!((0,v.t)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.useMaximumNumberOfFeatures&&!(0,v.t)(this._index)&&!(0,v.t)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Ae)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Ae)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ae,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if((0,v.t)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);(0,v.r)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,D.c.Hole)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if((0,v.t)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var n=this._index.getNode(r.update.pop());(0,v.r)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if((0,v.t)(a)||a.cacheState!==D.s.Cached&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<w.aq&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=((0,v.r)(this._index)?this._index.getIndexMissing():0)+3*((0,v.r)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!(0,v.t)(this._index)&&!(0,v.t)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,r=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=qe.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return(0,v.r)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){(0,v.r)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){(0,v.r)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){(0,v.r)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){(0,v.r)(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!((0,v.t)(this._index)||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e)}},{key:"_shouldDropNode",value:function(e){if((0,v.t)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||(0,v.t)(t)||(0,v.t)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new Ne(this.layer,this.dataStreamController,Fe,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,Ge.fadeout)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if((0,v.t)(i)||(0,v.t)(this._viewportQueries))return!1;Ee.clear(),this.layerView.getLoadedNodeIndices(Ee);var r=0===this._viewportQueries.maxDistance,n=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return Ee.filterInPlace((function(e){var r=i.getNode(e);return(0,v.t)(r)||!i.isGeometryVisible(e)||n(r)||!t._isNodeInScaleBounds(r)})),Ee.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Ee,e,Ge.pop),!(r&&this.lodDropFactor<1)&&(0===Ee.length||(Ee.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Ee.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Ee,x.w,Ge.pop)}},{key:"_removeNodes",value:function(e,t,i){var r=e.length;if(0!==r&&!t.done){for((0,v.r)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;i===Ge.fadeout&&this.layerView.nodeFadeoutEnabled&&(0,v.r)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,ne.FadeOut,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<r;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=new AbortController;this._updatingNodes.set(e.index,i),(Ve(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r},i.signal)}),i.signal)})).catch((function(r){if(!(0,v.I)(r))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Fe.error("already loading node "+e.index);else{var i=new AbortController;this._loadingNodes.set(e.index,i),this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then((function(r){r&&(0,v.r)(t._index)&&t._loadingNodes.get(e.index)===i&&(t._loadingNodes.delete(e.index),t._index.requestUpdate())})).catch((function(e){if(!(0,v.I)(e))throw e})).finally((function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}}},{key:"_loadAndAddNode",value:function(e,t){return e.cacheState===D.s.Uncached?this._loadUncached(e,t).then((function(){return!1})):this._loadCached(e,t).then((function(t){return!t&&(e.cacheState=D.s.Uncached,!0)})).catch((function(t){return!(0,v.I)(t)&&(e.cacheState=D.s.Uncached,!0)}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||(0,v.t)(this._index))return!1;if(t===D.c.Hole&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return(0,v.r)(t)&&(0,v.r)(t.attributeInfo)&&Ve(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){(0,v.r)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateLoadStatus",value:function(e,t){var i=this._index;(0,v.r)(i)&&i.updateChildrenLoaded(e,t?1:-1)}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,D.c.Leaf))return Promise.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule((function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))}),t).then((function(n){if((0,v.t)(n))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return r.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,r,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=D.s.Cached})).catch((function(t){if(!(0,v.I)(t))throw Fe.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,(0,v.r)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&(0,v.r)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_computeScale",value:function(e){this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=e.mbs[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=(0,E.r)(this.layer),r=i.minScale,n=i.maxScale;return(0,E.c)(t,r,n)}},{key:"updateStats",value:function(e){e.index=(0,v.r)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),(0,v.r)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){(0,v.r)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,v.r)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;(0,v.r)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),i}((0,_.m)(v.y));(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"isMeshPyramid",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"isGraphics3D",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"useMaximumNumberOfFeatures",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"indexStreamController",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"dataStreamController",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"crsVertex",null),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"crsIndex",null),(0,v.e)([(0,v.d)()],Te.prototype,"screenSizeFactor",void 0),(0,v.e)([(0,v.d)()],Te.prototype,"featureTarget",void 0),(0,v.e)([(0,v.d)()],Te.prototype,"fixedFeatureTarget",void 0),(0,v.e)([(0,v.d)()],Te.prototype,"layerView",void 0),(0,v.e)([(0,v.d)()],Te.prototype,"layer",null),(0,v.e)([(0,v.d)({})],Te.prototype,"updating",void 0),(0,v.e)([(0,v.d)({})],Te.prototype,"updatingProgress",void 0),(0,v.e)([(0,v.d)({readOnly:!0})],Te.prototype,"leavesReached",void 0),(0,v.e)([(0,v.d)({constructOnly:!0})],Te.prototype,"scaleVisibilityEnabled",void 0),(0,v.e)([(0,v.d)({readOnly:!0,dependsOn:[]})],Te.prototype,"rootNodeVisible",null),Te=(0,v.e)([(0,v.n)("esri.layers.graphics.controllers.I3SOnDemandController")],Te);var Re,Ee=new v.ay({deallocator:null});function Ve(e,t){return(0,v.r)(e)&&e.length===t.length&&e.every((function(e){return Ue(t,e.name)>=0}))}function Ue(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var Ge,qe={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ze=(0,p.u)();!function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout"}(Ge||(Ge={}));var Be,He=Te,je=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(){var e;return(0,c.Z)(this,i),(e=t.apply(this,arguments))._map=new Map,e}return(0,f.Z)(i,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,i=0;i<e.length;i++){var r=e[i],n=r.objectId,a=this._map.get(n);a?(t.add(n),r!==a&&(e[i]=a),++a.refCount):(r.refCount=1,this._map.set(n,r))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,i=[],r=(0,h.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=n.objectId,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),i.push(n))}}catch(o){r.e(o)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"removeManyByObjectId",value:function(e){var t,i=[],r=(0,h.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=this._map.get(n);null!=a&&--a.refCount<=0&&(this._map.delete(n),i.push(a))}}catch(s){r.e(s)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"toArray",value:function(){return(0,n.Z)(this._map.values())}},{key:"find",value:function(e){var t;return(0,v.aD)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),i}(V.n),Qe=v.s.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),ze=function(){function e(t,i){var r=this;(0,c.Z)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=new AbortController,this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=Je,this.memCache=i.newCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return r.pendingFetchAbortController=null}))}return(0,f.Z)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),(0,v.t)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var i=this.interactiveEditingSessions,r=new Ke(e,{rollback:function(){(0,v.a$)(i,r),0===i.length&&(t.interactiveEditingSessions=null)},commit:function(i){var r,n=(0,h.Z)(i);try{for(n.s();!(r=n.n()).done;){var s=(0,a.Z)(r.value,2),o=s[0],d=s[1];t.updateValue(e,o,d)}}catch(u){n.e(u)}finally{n.f()}}});return i.unshift(r),r}},{key:"apply",value:function(){var e=(0,u.Z)((0,d.Z)().mark((function e(t,i,r){var n,a,s,o,u,l,h;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,v.t)(i)){e.next=2;break}return e.abrupt("return");case 2:if(n=i.loadedAttributes,a=i.attributeData,!(0,v.t)(n)&&0!==n.length&&!(0,v.t)(a)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,(0,v.ao)(this.pendingFetchChangedObjectIds,r);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return s={loadedAttributes:n,attributeData:a},o=this._getOverridesFromCache(t,s,this.changedObjectIds),u=o.objectIds,l=o.fieldNames,e.next=15,this._queryOverridesFromAssociatedLayer(u,l,r);case 15:h=e.sent,(0,v.t)(h)||this._processOverridesFromAssociatedLayer(t,h,l,s);case 17:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,i){this.changedObjectIds.add(e),this._cacheValue(e,t,i)}},{key:"_cacheValue",value:function(e,t,i){this.memCache.put(this._getCacheKey(e,t),i,this._memCacheValueSize(i))}},{key:"_getOverridesFromCache",value:function(e,t,i){var r,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,d=(0,h.Z)(n);try{for(d.s();!(r=d.n()).done;){var u=r.value;o[u.index]=a[u.name]}}catch(y){d.e(y)}finally{d.f()}for(var l=new Set,c=0;c<e.length;c++){var f=e[c];if(i.has(f)){var v,g=(0,h.Z)(n);try{for(g.s();!(v=g.n()).done;){var _=v.value,m=this._fromCache(f,_.index);void 0===m?(s.add(f),l.add(_.name)):o[_.index][c]=m}}catch(y){g.e(y)}finally{g.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(l)}}},{key:"_fromCache",value:function(e,t){var i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var r=this._getCacheKey(e,t);return this.memCache.get(r)}},{key:"_fromInteractiveEditingSession",value:function(e,t){if(!(0,v.t)(this.interactiveEditingSessions)){var i,r=(0,h.Z)(this.interactiveEditingSessions);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){r.e(s)}finally{r.f()}}}},{key:"_getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"_queryOverridesFromAssociatedLayer",value:function(){var e=(0,u.Z)((0,d.Z)().mark((function e(t,i,r){var a,s,o,u;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this._logMaximumObjectsExceededWarning()),a=(0,v.g)(this.layer.associatedLayer),(s=a.createQuery()).where="1=1",s.returnGeometry=!1,s.outFields=[a.objectIdField].concat((0,n.Z)(i)),s.cacheHint=!0,s.objectIds=t,o=(0,q.a)(a),u=t.length>o?(0,v.b3)(t,o).map((function(e){var t=s.clone();return t.objectIds=e,(0,I.u)((0,q.t)(a,t,{signal:r}))})):[(0,I.u)((0,q.t)(a,s,{signal:r}))],e.next=8,Promise.all(u);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,G.m)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),Qe.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"_processOverridesFromAssociatedLayer",value:function(e,t,i,r){var n,a=r.loadedAttributes,s=r.attributeData,o=(0,v.g)(this.layer.associatedLayer).objectIdField,d=i.map((function(e){return s[e]})),u=new Map(a.map((function(e){return[e.name,e.index]}))),l=i.map((function(e){return u.get(e)})),c=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=(0,h.Z)(t);try{for(f.s();!(n=f.n()).done;)for(var g=n.value,_=g.attributes[o],m=0;m<i.length;m++){var y=l[m],p=c.get(_),b=g.attributes[i[m]];d[m][p]=b,this._cacheValue(_,y,b)}}catch(x){f.e(x)}finally{f.f()}}},{key:"_memCacheValueSize",value:function(e){return"string"==typeof e?(0,U.n)(e):(0,U.t)()}},{key:"_fetchChangedObjectIds",value:function(){var e=(0,u.Z)((0,d.Z)().mark((function e(t){var i,r,n,a,s,o,u,l,h,c,f;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.layer,e.next=3,a.load({signal:t});case 3:if(this.changedObjectIds.clear(),!(0,v.t)(a.associatedLayer)&&null!==(i=a.associatedLayer.capabilities)&&void 0!==i&&null!==(r=i.operations)&&void 0!==r&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(s=this._getFetchChangedObjectIdsServerGen(),!(0,v.t)(s)){e.next=9;break}return e.abrupt("return",null);case 9:return o=a.associatedLayer.layerId,e.next=12,(0,I.a)((0,P.U)("".concat(a.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(o),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:o,serverGen:s}])},timeout:Xe,signal:t}));case 12:if(u=e.sent,l=u.ok&&null!==(n=u.value.data)&&void 0!==n&&n.edits?(0,v.aj)(u.value.data.edits[0],"objectIds","updates"):null,(0,v.r)(l))for((h=Math.min(this._maximumNumberOfEditOVerrides,l.length))<l.length&&(this.warnMaximumChangedObjectsExceeded=!0),c=l.sort((function(e,t){return e-t})),f=0;f<h;f++)this.changedObjectIds.add(c[f]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if((0,v.r)(e.serviceUpdateTimeStamp)&&(0,v.r)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return(0,v.r)(t)&&(0,v.r)(t.serverGens)&&(0,v.r)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),Ke=function(){function e(t,i){(0,c.Z)(this,e),this.objectId=t,this.options=i,this.updates=new Map,this.state=Be.ACTIVE}return(0,f.Z)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=Be.ROLLED_BACK,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=Be.COMMITTED,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return this.state===Be.ACTIVE}}]),e}();!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.COMMITTED=1]="COMMITTED",e[e.ROLLED_BACK=2]="ROLLED_BACK"}(Be||(Be={}));var Xe=1e4,Je=5e4},92692:function(e,t,i){i.d(t,{a:function(){return s},c:function(){return o},d:function(){return m},h:function(){return _},i:function(){return g},n:function(){return r},o:function(){return n},s:function(){return a},t:function(){return v}});var r,n,a,s,o,d,u=i(60136),l=i(29388),h=i(43144),c=i(15671),f=i(64747),v=(0,h.Z)((function e(t,i){(0,c.Z)(this,e),this.id=t,this.mbs=i,this.renderMbs=(0,f.L)(0,0,0,-1),this.elevationRange=null})),g=(0,h.Z)((function e(){(0,c.Z)(this,e),this.min=1/0,this.max=-1/0,this.valid=!1}));(d=r||(r={}))[d.Unmodified=0]="Unmodified",d[d.Culled=1]="Culled",d[d.NotChecked=2]="NotChecked",function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(n||(n={}));var _=function(e){(0,u.Z)(i,e);var t=(0,l.Z)(i);function i(e,r,s,o,d,u,l,h,f,v){var g;return(0,c.Z)(this,i),(g=t.call(this,e,s)).index=r,g.childCount=o,g.level=d,g.resources=u,g.version=l,g.lodMetric=h,g.maxError=f,g.numFeatures=v,g.failed=!1,g.cacheState=a.Unknown,g.vertexCount=0,g.memory=0,g.childrenLoaded=0,g.hasModifications=!1,g.imModificationImpact=n.NotChecked,g}return(0,h.Z)(i)}(v);!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(a||(a={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(s||(s={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));var m=(0,h.Z)((function e(t,i,r,n){(0,c.Z)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=r,this.version=n}))},60470:function(e,t,i){i.d(t,{u:function(){return f}});var r=i(15671),n=i(43144),a=i(60136),s=i(29388),o=i(50165),d=i(40133),u=i(22984),l=i(17493),h=i(52155),c=function(e){(0,a.Z)(i,e);var t=(0,s.Z)(i);function i(e){var n;return(0,r.Z)(this,i),(n=t.call(this,e)).layer=null,n.parent=null,n}return(0,n.Z)(i,[{key:"initialize",value:function(){var e=this;this.when().catch((function(t){if("layerview:create-error"!==t.name){var i=e.layer&&e.layer.id||"no id",r=e.layer&&e.layer.title||"no title";o.s.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '".concat(r,"', id: '").concat(i,"')"),t)}}))}},{key:"fullOpacity",get:function(){return(0,o.af)(this.get("layer.opacity"),1)*(0,o.af)(this.get("parent.fullOpacity"),1)}},{key:"suspended",get:function(){return!this.canResume()}},{key:"suspendInfo",get:function(){return this.getSuspendInfo()}},{key:"legendEnabled",get:function(){var e;return!this.suspended&&!0===(null===(e=this.layer)||void 0===e?void 0:e.legendEnabled)}},{key:"updating",get:function(){var e;return!((null===(e=this.updatingHandles)||void 0===e||!e.updating)&&!this.isUpdating())}},{key:"updatingProgress",get:function(){return this.updating?0:1}},{key:"visible",get:function(){var e;return!0===(null===(e=this.layer)||void 0===e?void 0:e.visible)},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}},{key:"canResume",value:function(){var e,t,i;return this.visible&&(null===(e=this.layer)||void 0===e?void 0:e.loaded)&&!(null!==(t=this.parent)&&void 0!==t&&t.suspended)&&(null===(i=this.view)||void 0===i?void 0:i.ready)||!1}},{key:"getSuspendInfo",value:function(){var e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}},{key:"isUpdating",value:function(){return!1}}]),i}((0,u.a)((0,l.s)((0,h.m)(d.n.EventedMixin(o.y)))));(0,o.e)([(0,o.d)()],c.prototype,"fullOpacity",null),(0,o.e)([(0,o.d)()],c.prototype,"layer",void 0),(0,o.e)([(0,o.d)()],c.prototype,"parent",void 0),(0,o.e)([(0,o.d)({readOnly:!0})],c.prototype,"suspended",null),(0,o.e)([(0,o.d)({readOnly:!0})],c.prototype,"suspendInfo",null),(0,o.e)([(0,o.d)({readOnly:!0})],c.prototype,"legendEnabled",null),(0,o.e)([(0,o.d)({type:Boolean,readOnly:!0})],c.prototype,"updating",null),(0,o.e)([(0,o.d)({readOnly:!0})],c.prototype,"updatingProgress",null),(0,o.e)([(0,o.d)()],c.prototype,"visible",null),(0,o.e)([(0,o.d)()],c.prototype,"view",void 0);var f=c=(0,o.e)([(0,o.n)("esri.views.layers.LayerView")],c)},50252:function(e,t,i){i.d(t,{a:function(){return u},t:function(){return o}});var r=i(74165),n=i(15861),a=i(50165),s=i(53089);function o(e,t,i){return d.apply(this,arguments)}function d(){return d=(0,n.Z)((0,r.Z)().mark((function e(t,i,n){var s,o,d,h;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=i.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(i.maxRecordCountFactor=l(t)),s=u(t),o=t.capabilities.query.supportsPagination,i.start=0,i.num=s,d=null;case 4:return e.next=6,t.source.queryFeaturesJSON(i,n);case 6:if(h=e.sent,(0,a.t)(d)?d=h:d.features=d.features.concat(h.features),d.exceededTransferLimit=h.exceededTransferLimit,o&&h.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:i.start+=s;case 10:e.next=4;break;case 12:return e.abrupt("return",d);case 13:case"end":return e.stop()}}),e)}))),d.apply(this,arguments)}function u(e){return l(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function l(e){return e.capabilities.query.supportsMaxRecordCountFactor?s.b.MAX_MAX_RECORD_COUNT_FACTOR:1}}}]);
//# sourceMappingURL=2856.ddd4bfdc.chunk.js.map