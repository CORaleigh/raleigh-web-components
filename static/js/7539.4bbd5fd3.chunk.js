"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[7539],{57686:function(e,t,i){i.d(t,{s:function(){return o}});var r=i(37762),n=i(15671),a=i(43144),s=i(50165),o=function(){function e(t){(0,n.Z)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return(0,a.Z)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,i=(0,r.Z)(this._buffer);try{for(i.s();!(t=i.n()).done;){var n=t.value;if((0,s.r)(n)&&e(n))return n}}catch(a){i.e(a)}finally{i.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,s.r)(t);)e&&e(t),t=this.dequeue()}}]),e}()},55540:function(e,t,i){i.d(t,{i:function(){return l}});var r=i(15671),n=i(43144),a=i(11752),s=i(61120),o=i(60136),u=i(29388),h=i(3441),l=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){return(0,r.Z)(this,i),t.apply(this,arguments)}return(0,n.Z)(i,[{key:"renderChildren",value:function(e){this.attributeView.bindTextures(e.context,!1),this.children.some((function(e){return e.hasData}))&&((0,a.Z)((0,s.Z)(i.prototype),"renderChildren",this).call(this,e),e.drawPhase===h.I.MAP&&this._renderChildren(e),this.hasHighlight()&&e.drawPhase===h.I.HIGHLIGHT&&this._renderHighlight(e),this._boundsRenderer&&this._boundsRenderer.doRender(e))}},{key:"_renderHighlight",value:function(e){var t=e.painter.effects.highlight;t.bind(e),this._renderChildren(e,t.defines),t.draw(e),t.unbind()}}]),i}(i(28372).t)},24695:function(e,t,i){i.d(t,{A:function(){return p},C:function(){return _},D:function(){return m},E:function(){return ce},M:function(){return ae},N:function(){return n},O:function(){return s},S:function(){return de},W:function(){return U},_:function(){return fe},a:function(){return d},b:function(){return O},c:function(){return S},d:function(){return ue},e:function(){return me},f:function(){return pe},g:function(){return _e},h:function(){return f},i:function(){return u},j:function(){return R},k:function(){return B},l:function(){return E},m:function(){return o},n:function(){return r},o:function(){return l},p:function(){return h},q:function(){return a},r:function(){return M},s:function(){return k},t:function(){return se},u:function(){return c},v:function(){return le}});var r,n,a,s,o,u,h,l,c,d,f,p,_,m,v=i(74165),g=i(15861),y=i(1413),b=i(15671),w=i(43144),x=i(13994),T=i(6819);function k(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:T.T.ADD,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[0,0,0,0];return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function E(e,t,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:T.T.ADD,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:T.T.ADD,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[0,0,0,0];return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:n,opAlpha:a,color:{r:s[0],g:s[1],b:s[2],a:s[3]}}}!function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Less=0]="Less",e[e.Lequal=1]="Lequal",e[e.COUNT=2]="COUNT"}(n||(n={})),function(e){e[e.NONE=0]="NONE",e[e.SMAA=1]="SMAA"}(a||(a={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.FrontFace=2]="FrontFace",e[e.NONE=3]="NONE",e[e.COUNT=4]="COUNT"}(s||(s={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.UPDATE=1]="UPDATE"}(o||(o={})),function(e){e[e.NOT_LOADED=0]="NOT_LOADED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(u||(u={})),function(e){e[e.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",e[e.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(h||(h={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(l||(l={})),function(e){e[e.Highlight=0]="Highlight",e[e.MaskOccludee=1]="MaskOccludee",e[e.COUNT=2]="COUNT"}(c||(c={})),function(e){e[e.Triangle=0]="Triangle",e[e.Point=1]="Point",e[e.Line=2]="Line"}(d||(d={})),function(e){e[e.STRETCH=1]="STRETCH",e[e.PAD=2]="PAD"}(f||(f={})),function(e){e[e.CHANGED=0]="CHANGED",e[e.UNCHANGED=1]="UNCHANGED"}(p||(p={})),function(e){e[e.Blend=0]="Blend",e[e.Opaque=1]="Opaque",e[e.Mask=2]="Mask",e[e.MaskBlend=3]="MaskBlend",e[e.COUNT=4]="COUNT"}(_||(_={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(m||(m={}));var M={face:T.N.BACK,mode:T.S.CCW},R={face:T.N.FRONT,mode:T.S.CCW},B=function(e){return e===r.Back?M:e===r.Front?R:null},O={zNear:0,zFar:1},S={r:!0,g:!0,b:!0,a:!0};function F(e){return G.intern(e)}function P(e){return W.intern(e)}function C(e){return V.intern(e)}function A(e){return Y.intern(e)}function I(e){return Q.intern(e)}function Z(e){return J.intern(e)}function D(e){return ee.intern(e)}function z(e){return ie.intern(e)}function U(e){return ne.intern(e)}var L=function(){function e(t,i){(0,b.Z)(this,e),this.makeKey=t,this.makeRef=i,this.interns=new Map}return(0,w.Z)(e,[{key:"intern",value:function(e){if(!e)return null;var t=this.makeKey(e),i=this.interns;return i.has(t)||i.set(t,this.makeRef(e)),i.get(t)}}]),e}();function N(e){return"["+e.join(",")+"]"}var G=new L(H,(function(e){return(0,y.Z)({__tag:"Blending"},e)}));function H(e){return e?N([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}var W=new L(q,(function(e){return(0,y.Z)({__tag:"Culling"},e)}));function q(e){return e?N([e.face,e.mode]):null}var V=new L(j,(function(e){return(0,y.Z)({__tag:"PolygonOffset"},e)}));function j(e){return e?N([e.factor,e.units]):null}var Y=new L(X,(function(e){return(0,y.Z)({__tag:"DepthTest"},e)}));function X(e){return e?N([e.func]):null}var Q=new L(K,(function(e){return(0,y.Z)({__tag:"StencilTest"},e)}));function K(e){return e?N([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}var J=new L($,(function(e){return(0,y.Z)({__tag:"DepthWrite"},e)}));function $(e){return e?N([e.zNear,e.zFar]):null}var ee=new L(te,(function(e){return(0,y.Z)({__tag:"ColorWrite"},e)}));function te(e){return e?N([e.r,e.g,e.b,e.a]):null}var ie=new L(re,(function(e){return(0,y.Z)({__tag:"StencilWrite"},e)}));function re(e){return e?N([e.mask]):null}var ne=new L((function(e){return e?N([H(e.blending),q(e.culling),j(e.polygonOffset),X(e.depthTest),K(e.stencilTest),$(e.depthWrite),te(e.colorWrite),re(e.stencilWrite)]):null}),(function(e){return{blending:F(e.blending),culling:P(e.culling),polygonOffset:C(e.polygonOffset),depthTest:A(e.depthTest),stencilTest:I(e.stencilTest),depthWrite:Z(e.depthWrite),colorWrite:D(e.colorWrite),stencilWrite:z(e.stencilWrite)}}));var ae=function(){function e(t){(0,b.Z)(this,e),this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=t}return(0,w.Z)(e,[{key:"setPipeline",value:function(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}},{key:"invalidateBlending",value:function(){this._blendingInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateCulling",value:function(){this._cullingInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidatePolygonOffset",value:function(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateDepthTest",value:function(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateStencilTest",value:function(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateDepthWrite",value:function(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateColorWrite",value:function(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}},{key:"invalidateStencilWrite",value:function(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}},{key:"_setBlending",value:function(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}},{key:"_setCulling",value:function(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}},{key:"_setPolygonOffset",value:function(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}},{key:"_setDepthTest",value:function(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}},{key:"_setStencilTest",value:function(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}},{key:"_setDepthWrite",value:function(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}},{key:"_setColorWrite",value:function(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}},{key:"_setStencilWrite",value:function(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}},{key:"_setSubState",value:function(e,t,i,r){return(i||e!==t)&&(r(e),this._pipelineInvalid=!0),e}}]),e}();function se(e,t){return oe.apply(this,arguments)}function oe(){return oe=(0,g.Z)((0,v.Z)().mark((function e(t,i){var r,n;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,x.U)(t,(0,y.Z)({responseType:"image"},i));case 2:return r=e.sent,n=r.data,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e)}))),oe.apply(this,arguments)}var ue=E(T.R.SRC_ALPHA,T.R.ONE,T.R.ONE_MINUS_SRC_ALPHA,T.R.ONE_MINUS_SRC_ALPHA),he=k(T.R.ONE,T.R.ONE),le=k(T.R.ZERO,T.R.ONE_MINUS_SRC_ALPHA);function ce(e){return e===s.FrontFace?null:e===s.Alpha?le:he}function de(e){return e===s.FrontFace?O:null}var fe=5e5,pe={factor:-1,units:-2};function _e(e){return e?pe:null}function me(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.I.LESS;return e===s.NONE||e===s.FrontFace?t:T.I.LEQUAL}},34849:function(e,t,i){i.d(t,{m:function(){return l}});var r=i(37762),n=i(29439),a=i(15671),s=i(43144),o=i(33265),u=i(20422),h=i(38511),l=function(){function e(t){(0,a.Z)(this,e),this._resourceManager=t}return(0,s.Z)(e,[{key:"dispose",value:function(){this._rasterizationCanvas=null}},{key:"rasterizeJSONResource",value:function(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===e.type||"esriSFS"===e.type){var r=o.e.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t),a=(0,n.Z)(r,3),s=a[0];return{size:[a[1],a[2]],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if("simple-line"===e.type||"esriSLS"===e.type||"line"===e.type&&e.dashTemplate){var h,l;if("simple-line"===e.type||"esriSLS"===e.type)switch(h=(0,o.m)(e.style,e.cap),e.cap){case"butt":l="Butt";break;case"square":l="Square";break;default:l="Round"}else h=e.dashTemplate,l=e.cim.capStyle;var c=o.e.rasterizeSimpleLine(h,l),d=(0,n.Z)(c,3),f=d[0];return{size:[d[1],d[2]],image:new Uint32Array(f.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}var p,_,m;if("simple-marker"===e.type||"esriSMS"===e.type||"line-marker"===e.type?(p=o.Z.fromSimpleMarker(e),m=(0,u.r)(p)):e.cim&&"CIMHatchFill"===e.cim.type?(p=o.Z.fromCIMHatchFill(e.cim),_=new o.t(p.frame.xmin,-p.frame.ymax,p.frame.xmax-p.frame.xmin,p.frame.ymax-p.frame.ymin)):e.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===e.cim.markerPlacement.type?(p=o.Z.fromCIMInsidePolygon(e.cim),_=new o.t(p.frame.xmin,-p.frame.ymax,p.frame.xmax-p.frame.xmin,p.frame.ymax-p.frame.ymin)):(p=e.cim,m=(0,u.r)(p)),m&&!i){var v=(0,u.a)(m),g=(0,n.Z)(v,3),y=g[0],b=g[1],w=g[2];return y?{size:[b,w],image:new Uint32Array(y.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}var x=o.Z.rasterize(this._rasterizationCanvas,p,_,this._resourceManager,!i),T=(0,n.Z)(x,5),k=T[0],E=T[1],M=T[2],R=T[3],B=T[4];return k?{size:[E,M],image:new Uint32Array(k.buffer),sdf:!1,simplePattern:!1,anchorX:R,anchorY:B}:null}},{key:"rasterizeImageResource",value:function(e,t,i,a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;var s=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?s.putImageData(i,0,0):(i.setAttribute("width","".concat(e,"px")),i.setAttribute("height","".concat(t,"px")),s.drawImage(i,0,0,e,t));var o,u=s.getImageData(0,0,e,t),l=new Uint8Array(u.data);if(a){var c,d=(0,r.Z)(a);try{for(d.s();!(c=d.n()).done;){var f=c.value;if(f&&f.oldColor&&4===f.oldColor.length&&f.newColor&&4===f.newColor.length){var p=(0,n.Z)(f.oldColor,4),_=p[0],m=p[1],v=p[2],g=p[3],y=(0,n.Z)(f.newColor,4),b=y[0],w=y[1],x=y[2],T=y[3];if(_===b&&m===w&&v===x&&g===T)continue;for(var k=0;k<l.length;k+=4)_===l[k]&&m===l[k+1]&&v===l[k+2]&&g===l[k+3]&&(l[k]=b,l[k+1]=w,l[k+2]=x,l[k+3]=T)}}}catch(P){d.e(P)}finally{d.f()}}for(var E=0;E<l.length;E+=4)o=l[E+3]/255,l[E]=l[E]*o,l[E+1]=l[E+1]*o,l[E+2]=l[E+2]*o;var M=l,R=e,B=t,O=512;if(R>=O||B>=O){var S=R/B;S>1?(R=O,B=Math.round(O/S)):(B=O,R=Math.round(O*S)),M=new Uint8Array(4*R*B);var F=new Uint8ClampedArray(M.buffer);(0,h.a)(l,e,t,F,R,B,!1)}return{size:[R,B],image:new Uint32Array(M.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}]),e}()},47614:function(e,t,i){i.d(t,{e:function(){return r},n:function(){return a},o:function(){return n}});var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof i.g?i.g:"undefined"!=typeof self?self:{};function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function a(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}},56864:function(e,t,i){function r(e,t,i){for(var r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function n(e,t){for(var i=e.length,r=0;r<i;++r)s[0]=e[r],t[r]=s[0];return t}function a(e,t){for(var i=e.length,r=0;r<i;++r)s[0]=e[r],s[1]=e[r]-s[0],t[r]=s[1];return t}i.d(t,{o:function(){return n},r:function(){return a},t:function(){return r}});var s=new Float32Array(2)},1388:function(e,t,i){i.d(t,{g:function(){return p},i:function(){return o},m:function(){return d},o:function(){return u},s:function(){return f}});var r=i(74165),n=i(15861),a=i(50165),s=i(13994);function o(e){var t=d(e);return(0,a.r)(t)?t.toDataURL():""}function u(e){return h.apply(this,arguments)}function h(){return h=(0,n.Z)((0,r.Z)().mark((function e(t){var i,n,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=d(t),!(0,a.t)(i)){e.next=3;break}throw new a.a("imageToArrayBuffer","Unsupported image type");case 3:return e.next=5,l(t);case 5:return n=e.sent,e.next=8,new Promise((function(e){return i.toBlob(e,n)}));case 8:if(s=e.sent){e.next=11;break}throw new a.a("imageToArrayBuffer","Failed to encode image");case 11:return e.next=13,s.arrayBuffer();case 13:return e.t0=e.sent,e.t1=n,e.abrupt("return",{data:e.t0,type:e.t1});case 16:case"end":return e.stop()}}),e)}))),h.apply(this,arguments)}function l(e){return c.apply(this,arguments)}function c(){return(c=(0,n.Z)((0,r.Z)().mark((function e(t){var i,n,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t instanceof HTMLImageElement){e.next=2;break}return e.abrupt("return","image/png");case 2:if(i=t.src,!(0,s.X)(i)){e.next=6;break}return n=(0,s.n)(i),a=n.mediaType,e.abrupt("return","image/jpeg"===a?a:"image/png");case 6:return e.abrupt("return",/\.png$/i.test(i)?"image/png":/\.(jpg|jpeg)$/i.test(i)?"image/jpeg":"image/png");case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(e){if(e instanceof HTMLCanvasElement)return e;if(e instanceof HTMLVideoElement)return null;var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");return e instanceof HTMLImageElement?i.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&i.putImageData(e,0,0),t}function f(e){for(var t=[],i=new Uint8Array(e),r=0;r<i.length;r++)t.push(String.fromCharCode(i[r]));return"data:application/octet-stream;base64,"+btoa(t.join(""))}function p(e){if(e.byteLength<8)return!1;var t=new Uint8Array(e);return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}},87539:function(e,t,i){i.r(t),i.d(t,{GraphicContainer:function(){return ue.i},GraphicsView2D:function(){return oe.a},LabelManager:function(){return Ci},MagnifierView2D:function(){return tr},MapViewNavigation:function(){return $i},Stage:function(){return xi}});var r=i(93433),n=i(97326),a=i(11752),s=i(61120),o=i(60136),u=i(29388),h=i(29439),l=i(74165),c=i(15861),d=i(37762),f=i(4942),p=i(1413),_=i(15671),m=i(43144),v=i(50165),g=i(73627),y=i(68634),b=i(33265),w=i(14527),x=i(3441),T=i(35341),k=i(79984),E=i(50463),M=i(48968),R=i(6819),B=i(94640),O=i(46660),S=i(13994),F=i(78880),P=i(87833),C=i(21523),A=i(34849),I=i(45578),Z=i(20422),D=i(20592),z=i(47692),U=i(2815),L=i(44365),N=i(38802),G=i(47614),H=i(1388),W=i(25593),q=i(22494),V=i(2760),j=i(96401),Y=i(84192),X=i(49655),Q=i(57686),K=i(40133),J=i(61377),$=i(54473),ee=i(85490),te=i(26995),ie=i(22984),re=i(15508),ne=i(77639),ae=i(63334),se=i(47642),oe=i(28372),ue=i(55540),he=i(83745),le=i(77322),ce=(i(33530),i(69738)),de=i(99797),fe=(i(73393),i(87110),i(42),i(52155),i(72577),i(61772),i(92870),i(26079),i(17691),i(89031),i(98496),i(32335),i(4483),i(79747),i(75662),i(17493),i(62980),i(16377),i(9887),i(88406),i(66307),i(42488),i(9330),i(96263),i(79146),i(3029),i(42687),i(78330),i(78697),i(78664),i(31278),i(28003),i(64620),i(75366),i(5233),i(36235),i(61340),i(57439),i(59075),i(22225),i(75272),i(60418),i(84539),i(97823),i(49350),i(89354),i(16897),i(38419),i(84231),i(38665),i(32717),i(39853),i(94872),i(3969),i(4197),i(86905),i(64997),i(26208),i(68668),i(2816),i(46237),i(98428),i(5792),i(83172),i(42094),i(85966),i(73428),i(67871),i(49796),i(75097),i(80933),i(47672),i(98643),i(76375),i(99057),i(77372),i(77006),i(3096),i(25346),i(27969),i(66281),i(69754),i(75777),i(14023),i(38969),i(75105),i(69379),i(49510),i(6927),i(82909),i(89324),i(53089),i(49961),i(31412),i(6283),i(98057),i(30594),i(2326),i(50338),i(66156),i(25715),i(18392),i(24695),i(64591),i(56864),i(57405),i(72021),i(95865),i(48561),i(55269),i(86931),i(51613),i(80392),i(10489),i(62298),i(90339),i(82046),i(66270),i(43895),i(73267),i(22628),i(24982),i(46584),i(7093),i(58428),i(8049),i(40858),i(95076),i(56389),i(86738),i(69205),i(33074),i(31134),i(41524),i(55916),i(66319),i(24781),i(2329),i(37243),i(97345),i(39001),i(84913),i(84823),i(9411),i(14826),i(13089),i(29648),i(35650),i(7513),i(48606),i(68792),i(95734),i(48308),i(51386),i(81044),i(40100),i(88533),i(49862),i(37783),{shaders:{vertexShader:(0,T.n)("bitBlit/bitBlit.vert"),fragmentShader:(0,T.n)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])}),pe=function(){function e(){(0,_.Z)(this,e),this._initialized=!1}return(0,m.Z)(e,[{key:"dispose",value:function(){this._program=(0,v.aQ)(this._program),this._vertexArrayObject=(0,v.aQ)(this._vertexArrayObject)}},{key:"render",value:function(e,t,i,r){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA,R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),e.drawArrays(R.E.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=(0,B.a)(e,fe);if(!t)return!1;var i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;var r=fe.attributes,n=new M.f(e,r,E.t,{geometry:M.c.createVertex(e,R.F.STATIC_DRAW,i)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),_e=function(e){var t="";t+=e[0].toUpperCase();for(var i=1;i<e.length;i++){var r=e[i];r===r.toUpperCase()?(t+="_",t+=r):t+=r.toUpperCase()}return t},me=function(e,t,i,r){var n=e+e.substring(e.lastIndexOf("/")),a=t+t.substring(t.lastIndexOf("/")),s=function(e){var t={};for(var i in e)t[_e(i)]=e[i];return(0,O.n)(t)}(r);return{attributes:i,shaders:{vertexShader:s+(0,T.n)("".concat(n,".vert")),fragmentShader:s+(0,T.n)("".concat(a,".frag"))}}},ve=function(e){return e===x.I.HITTEST||e===x.I.LABEL_ALPHA},ge=function(e,t,i,r){var n=e.rendererInfo,a=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(r.join("."),"-").concat(function(e){return(ve(e)?1:0)|(e===x.I.HIGHLIGHT?2:0)}(a),"-").concat(n.getVariationHash(),"-").concat((0,v.r)(i)&&i.join("."))},ye=function(e,t,i,r){var n=r.reduce((function(t,i){return(0,p.Z)((0,p.Z)({},t),{},(0,f.Z)({},i,e.context.driverTest[i]))}),{}),a=(0,p.Z)((0,p.Z)((0,p.Z)({},t.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===x.I.HIGHLIGHT,id:ve(e.drawPhase)},n);if((0,v.r)(i)){var s,o=(0,d.Z)(i);try{for(o.s();!(s=o.n()).done;){a[s.value]=!0}}catch(u){o.e(u)}finally{o.f()}}return a},be=function(){function e(t){(0,_.Z)(this,e),this._rctx=t,this._programByKey=new Map}return(0,m.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getProgram",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=e.vsPath+"."+e.fsPath+JSON.stringify(i)+r.join(".");if(this._programByKey.has(n))return this._programByKey.get(n);var a=r.reduce((function(e,i){return(0,p.Z)((0,p.Z)({},e),{},(0,f.Z)({},i,t._rctx.driverTest[i]))}),{}),s=(0,p.Z)((0,p.Z)({},i.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,t){return(0,p.Z)((0,p.Z)({},e),{},(0,f.Z)({},t.name,t.value))}),{})),a),o=e.vsPath,u=e.fsPath,h=e.attributes,l=me(o,u,h,s),c=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(n,c),c}},{key:"getMaterialProgram",value:function(e,t,i,r,n){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:["ignoresSamplerPrecision"],s=ge(e,t,n,a);if(this._programByKey.has(s))return this._programByKey.get(s);var o=ye(e,t,n,a),u=me(i,i,r,o),h=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,h),h}}]),e}(),we=function(){function e(t,i){(0,_.Z)(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new D.t(0,0,t,i))}return(0,m.Z)(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new D.t;for(var i=null,r=-1,n=0;n<this._free.length;++n){var a=this._free[n];e<=a.width&&t<=a.height&&(null===i||a.y<=i.y&&a.x<=i.x)&&(i=a,r=n)}return null===i?new D.t:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new D.t(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new D.t(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new D.t(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new D.t(i.x,i.y+t,e,i.height-t))),new D.t(i.x,i.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}(),xe=function(e){return Math.floor(e/256)};function Te(e){var t,i=new Set,r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i.add(xe(n))}}catch(a){r.e(a)}finally{r.f()}return i}function ke(e,t,i){return e.has(t)||e.set(t,i().then((function(){e.delete(t)})).catch((function(i){e.delete(t),(0,v.F)(i)}))),e.get(t)}var Ee=function(){function e(t,i,r){(0,_.Z)(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=r,this._binPack=new we(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}return(0,m.Z)(e,[{key:"dispose",value:function(){this._binPack=null;var e,t=(0,d.Z)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0,this._glyphData.length=0}},{key:"_initDecorationGlyph",value:function(){for(var e=[117,149,181,207,207,181,149,117],t=[],i=0;i<e.length;i++)for(var r=e[i],n=0;n<11;n++)t.push(r);var a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(a)}},{key:"getGlyphItems",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getGlyphCache(t),e.next=3,this._fetchRanges(t,i,r);case 3:return e.abrupt("return",i.map((function(e){return a._getMosaicItem(n,t,e)})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"bind",value:function(e,t,i,r){var n=this._getTexture(e,i);n.setSamplingMode(t),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(n,r)}},{key:"_getGlyphCache",value:function(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}},{key:"_getTexture",value:function(e,t){return this._textures[t]||(this._textures[t]=new z.u(e,{pixelFormat:R.P.ALPHA,dataType:R.G.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}},{key:"_invalidate",value:function(){this._dirties[this._currentPage]=!0}},{key:"_fetchRanges",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Te(i),a=[],n.forEach((function(e){a.push(s._fetchRange(t,e,r))})),e.next=4,Promise.all(a);case 4:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_fetchRange",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i>256)){e.next=2;break}return e.abrupt("return",null);case 2:return n=t+i,e.abrupt("return",ke(this._rangePromises,n,(function(){return a._glyphSource.getRange(t,i,r)})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_getMosaicItem",value:function(e,t,i){if(!e[i]){var r=this._glyphSource.getGlyph(t,i);if(!r||!r.metrics)return function(e){return{rect:new D.t(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0}}(i);var n=this._recordGlyph(r),a=this._currentPage,s=r.metrics;e[i]={rect:n,page:a,metrics:s,code:i,sdf:!0},this._invalidate()}return e[i]}},{key:"_recordGlyph",value:function(e){var t,i=e.metrics;if(0===i.width)t=new D.t(0,0,0,0);else{var r=i.width+6,n=i.height+6;(t=this._binPack.allocate(r,n)).isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new we(this.width-4,this.height-4),t=this._binPack.allocate(r,n));var a,s,o=this._glyphData[this._currentPage],u=e.bitmap;if(u)for(var h=0;h<n;h++){a=r*h,s=this.width*(t.y+h)+t.x;for(var l=0;l<r;l++)o[s+l]=u[a+l]}(0,v.c)("esri-glyph-debug")&&this._showDebugPage(o)}return t}},{key:"_showDebugPage",value:function(e){var t=document.createElement("canvas"),i=t.getContext("2d"),r=new ImageData(this.width,this.height),n=r.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(var a=0;a<e.length;++a)n[4*a+0]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(r,0,0),document.body.appendChild(t)}}]),e}(),Me=function(){function e(t){for((0,_.Z)(this,e),this._metrics=[],this._bitmaps=[];t.next();)if(1===t.tag()){for(var i=t.getMessage();i.next();)if(3===i.tag()){for(var r=i.getMessage(),n=void 0,a=void 0,s=void 0,o=void 0,u=void 0,h=void 0,l=void 0;r.next();)switch(r.tag()){case 1:n=r.getUInt32();break;case 2:a=r.getBytes();break;case 3:s=r.getUInt32();break;case 4:o=r.getUInt32();break;case 5:u=r.getSInt32();break;case 6:h=r.getSInt32();break;case 7:l=r.getUInt32();break;default:r.skip()}r.release(),n&&(this._metrics[n]={width:s,height:o,left:u,top:h,advance:l},this._bitmaps[n]=a)}else i.skip();i.release()}else t.skip()}return(0,m.Z)(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),Re=function(){function e(){(0,_.Z)(this,e),this._ranges=[]}return(0,m.Z)(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),Be=function(){function e(t){(0,_.Z)(this,e),this._glyphInfo={},this._baseURL=t}return(0,m.Z)(e,[{key:"getRange",value:function(e,t,i){var r=this._getFontStack(e);if(r.getRange(t))return Promise.resolve();var n=256*t,a=n+255,s=this._baseURL.replace("{fontstack}",e).replace("{range}",n+"-"+a);return(0,S.U)(s,(0,p.Z)({responseType:"array-buffer"},i)).then((function(e){r.addRange(t,new Me(new U.a(new Uint8Array(e.data),new DataView(e.data))))}))}},{key:"getGlyph",value:function(e,t){var i=this._getFontStack(e);if(i){var r=Math.floor(t/256);if(!(r>256)){var n=i.getRange(r);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Re),t}}]),e}(),Oe=1e20,Se=function(){function e(t){(0,_.Z)(this,e),this.size=t;var i=document.createElement("canvas");i.width=i.height=t,this._context=i.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}return(0,m.Z)(e,[{key:"dispose",value:function(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}},{key:"draw",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:31;this._initSVG();var n=this.createSVGString(e);return new Promise((function(e,a){var s=new Image;s.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n),s.onload=function(){s.onload=null,i._context.clearRect(0,0,i.size,i.size),i._context.drawImage(s,0,0,i.size,i.size);for(var t=i._context.getImageData(0,0,i.size,i.size),n=new Uint8Array(i.size*i.size*4),a=0;a<i.size*i.size;a++){var o=t.data[4*a+3]/255;i._gridOuter[a]=1===o?0:0===o?Oe:Math.pow(Math.max(0,.5-o),2),i._gridInner[a]=1===o?Oe:0===o?0:Math.pow(Math.max(0,o-.5),2)}i._edt(i._gridOuter,i.size,i.size),i._edt(i._gridInner,i.size,i.size);for(var u=0;u<i.size*i.size;u++){var h=i._gridOuter[u]-i._gridInner[u];(0,L.o)(.5-h/(2*r),n,4*u)}e(n)};var o=t&&t.signal;o&&(0,v.x)(o,(function(){return a((0,v.v)())}))}))}},{key:"_initSVG",value:function(){if(!this._svg){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}},{key:"createSVGString",value:function(e){this._initSVG();var t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);var i,r,n,a,s=t.getBBox(),o=s.width/s.height,u=this.size/2;if(o>1){r=i=u/s.width;var h=u*(1/o);n=this.size/4,a=u-h/2}else i=r=u/s.height,n=u-u*o/2,a=this.size/4;var l=-s.x*i+n,c=-s.y*r+a;t.setAttribute("style","transform: matrix(".concat(i,", 0, 0, ").concat(r,", ").concat(l,", ").concat(c,")"));var d='<svg style="fill:red;" height="'.concat(this.size,'" width="').concat(this.size,'" xmlns="http://www.w3.org/2000/svg">').concat(this._svg.innerHTML,"</svg>");return this._svg.removeChild(t),d}},{key:"_edt",value:function(e,t,i){for(var r=this._f,n=this._d,a=this._v,s=this._z,o=0;o<t;o++){for(var u=0;u<i;u++)r[u]=e[u*t+o];this._edt1d(r,n,a,s,i);for(var h=0;h<i;h++)e[h*t+o]=n[h]}for(var l=0;l<i;l++){for(var c=0;c<t;c++)r[c]=e[l*t+c];this._edt1d(r,n,a,s,t);for(var d=0;d<t;d++)e[l*t+d]=Math.sqrt(n[d])}}},{key:"_edt1d",value:function(e,t,i,r,n){i[0]=0,r[0]=-Oe,r[1]=+Oe;for(var a=1,s=0;a<n;a++){for(var o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);o<=r[s];)s--,o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);i[++s]=a,r[s]=o,r[s+1]=+Oe}for(var u=0,h=0;u<n;u++){for(;r[h+1]<u;)h++;t[u]=(u-i[h])*(u-i[h])+e[i[h]]}}}]),e}();function Fe(e){return e&&"static"===e.type}var Pe=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,_.Z)(this,e),this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,r>0&&(this._maxItemSize=r),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new we(this._pageWidth,this._pageHeight);var n=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}return(0,m.Z)(e,[{key:"getWidth",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}},{key:"getHeight",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}},{key:"getPageTexture",value:function(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}},{key:"has",value:function(e){return this._mosaicRects.has(e)}},{key:"itemCount",get:function(){return this._mosaicRects.size}},{key:"getSpriteItem",value:function(e){return this._mosaicRects.get(e)}},{key:"addSpriteItem",value:function(e,t,i,r,n,a){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);var s,o,u;if(Fe(i)){var l=this._allocateImage(t[0],t[1]),c=(0,h.Z)(l,3);s=c[0],o=c[1],u=c[2]}else{s=new D.t(0,0,t[0],t[1]),o=this._mosaicPages.length;this._mosaicPages.push({mosaicsData:i,size:[t[0]+2*I.a,t[1]+2*I.a],dirty:!0,texture:void 0})}if(s.width<=0||s.height<=0)return null;var d={rect:s,width:t[0],height:t[1],sdf:n,simplePattern:a,pixelRatio:1,page:o};return this._mosaicRects.set(e,d),Fe(i)&&this._copy({rect:s,spriteSize:t,spriteData:i.data,page:o,pageSize:u,repeat:r,sdf:n}),d}},{key:"hasItemsToProcess",value:function(){return 0!==this._spriteCopyQueue.length}},{key:"processNextItem",value:function(){var e=this._spriteCopyQueue.pop();e&&this._copy(e)}},{key:"getSpriteItems",value:function(e){var t,i={},r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i[n]=this.getSpriteItem(n)}}catch(a){r.e(a)}finally{r.f()}return i}},{key:"getMosaicItemPosition",value:function(e){var t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;var r=t.width,n=t.height,a=I.a,s=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+a)/s[0],(i.y+a)/s[1]],br:[(i.x+a+r)/s[0],(i.y+a+n)/s[1]],page:t.page}}},{key:"bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=this._mosaicPages[i],a=n.mosaicsData,s=n.texture;s||(s=Ce(e,a,n.size),n.texture=s),s.setSamplingMode(t),Fe(a)?(e.bindTexture(s,r),n.dirty&&(s.setData(new Uint8Array(a.data.buffer)),s.generateMipmap())):a.data.bindFrame(e,s,r),n.dirty=!1}},{key:"_copy",value:function(t){if(!(t.page>=this._mosaicPages.length)){var i=this._mosaicPages[t.page],r=i.mosaicsData;if(!Fe(i.mosaicsData))throw new v.a("mapview-invalid-resource","unsuitable data type!");var n=t.spriteData,a=r.data;a&&n||console.error("Source or target images are uninitialized!"),e._copyBits(n,t.spriteSize[0],0,0,a,t.pageSize[0],t.rect.x+I.a,t.rect.y+I.a,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0}}},{key:"_allocateImage",value:function(e,t){e+=2*I.a,t+=2*I.a;var i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){var r=Math.pow(2,Math.ceil((0,N.P)(e))),n=Math.pow(2,Math.ceil((0,N.P)(t))),a=new D.t(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[r,n],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[r,n]]}var s=this._binPack.allocate(e,t);if(s.width<=0){var o=this._mosaicPages[this._currentPage];return!o.dirty&&Fe(o.mosaicsData)&&(o.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new we(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"dispose",value:function(){this._binPack=null;var e,t=(0,d.Z)(this._mosaicPages);try{for(t.s();!(e=t.n()).done;){var i=e.value,r=i.texture;r&&r.dispose();var n=i.mosaicsData;Fe(n)||n.data.destroy()}}catch(a){t.e(a)}finally{t.f()}this._mosaicPages=null,this._mosaicRects.clear()}}],[{key:"_copyBits",value:function(e,t,i,r,n,a,s,o,u,h,l){var c=r*t+i,d=o*a+s;if(l){d-=a;for(var f=-1;f<=h;c=((++f+h)%h+r)*t+i,d+=a)for(var p=-1;p<=u;p++)n[d+p]=e[c+(p+u)%u]}else for(var _=0;_<h;_++){for(var m=0;m<u;m++)n[d+m]=e[c+m];c+=t,d+=a}}}]),e}();function Ce(e,t,i){return Fe(t)?new z.u(e,{pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new z.u(e,{pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,samplingMode:R.L.LINEAR,wrapMode:R.D.CLAMP_TO_EDGE,width:i[0],height:i[1]},null)}function Ae(e){return(0,v.aL)(e.frameDurations.reduce((function(e,t){return e+t}),0))}function Ie(e,t){var i=e.width,r=e.height,n=e.selectFrame,a=e.frameDurations.slice(),s=a.pop();return a.push((0,v.aL)(s+t)),{frameDurations:a,selectFrame:n,width:i,height:r}}var Ze=function(){function e(t,i,r){(0,_.Z)(this,e),this._animation=t,this._repeatType=r,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];for(var n=0;i>n;)n+=this.timeToFrame,this.nextFrame();this._animation.selectFrame(this._currentFrame)}return(0,m.Z)(e,[{key:"nextFrame",value:function(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case I.d.None:this._currentFrame-=this._direction;break;case I.d.Loop:this._currentFrame=0;break;case I.d.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case I.d.None:this._currentFrame-=this._direction;break;case I.d.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case I.d.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame],this._animation.selectFrame(this._currentFrame)}}]),e}();function De(e,t,i){var r,n=t.repeatType;if(null==n&&(n=I.d.Loop),!0===t.reverseAnimation&&(e=function(e){var t=e.width,i=e.height;return{frameDurations:e.frameDurations.reverse(),selectFrame:function(t){var i=e.frameDurations.length-1-t;e.selectFrame(i)},width:t,height:i}}(e)),null!=t.duration&&(e=function(e,t){var i=e.width,r=e.height,n=e.selectFrame,a=t/Ae(e);return{frameDurations:e.frameDurations.map((function(e){return(0,v.aL)(e*a)})),selectFrame:n,width:i,height:r}}(e,(0,v.aL)(1e3*t.duration))),null!=t.repeatDelay){var a=1e3*t.repeatDelay;n===I.d.Loop?e=Ie(e,(0,v.aL)(a)):n===I.d.Oscillate&&(e=function(e,t){var i=e.width,r=e.height,n=e.selectFrame,a=e.frameDurations.slice(),s=a.shift();return a.unshift((0,v.aL)(s+t)),{frameDurations:a,selectFrame:n,width:i,height:r}}(Ie(e,(0,v.aL)(a/2)),(0,v.aL)(a/2)))}if(null!=t.startTimeOffset)r=(0,v.aL)(1e3*t.startTimeOffset);else if(null!=t.randomizeStartTime){var s=(0,Z.o)(i),o=null!=t.randomizeStartSeed?t.randomizeStartSeed:82749913,u=(0,Z.e)(s,o);r=(0,v.aL)(u*Ae(e))}else r=(0,v.aL)(0);return new Ze(e,r,n)}function ze(e,t,i){var r,n=null==t.playAnimation||t.playAnimation,a=De(e,t,i),s=a.timeToFrame;return function e(){r=n&&setTimeout((function(){a.nextFrame(),s=a.timeToFrame,e()}),s)}(),{remove:function(){n&&clearTimeout(r)}}}var Ue,Le=function(){function e(t){(0,_.Z)(this,e),this._requestRender=t,this._frameData=null}return(0,m.Z)(e,[{key:"destroy",value:function(){this._playHandle.remove()}},{key:"bindFrame",value:function(e,t,i){e.bindTexture(t,i),(0,v.t)(this._frameData)||(t.updateData(0,I.a,I.a,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}},{key:"_load",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r,n){var a,s,o=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=function(e){o._frameData=e,o._requestRender.requestRender()},e.next=4,this._loadAnimation(t,a,n);case 4:s=e.sent,this.frameCount=s.frameDurations.length,this.width=s.width,this.height=s.height,this._playHandle=ze(s,i,r),e.next=12;break;case 8:if(e.prev=8,e.t0=e.catch(0),(0,v.I)(e.t0)){e.next=12;break}return e.abrupt("return",new v.a("invalid-resource","Could not parse animated resource."));case 12:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t,i,r,n){return e.apply(this,arguments)}}()}]),e}(),Ne={exports:{}};Ue=function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={exports:{},id:r,loaded:!1};return e[r].call(n.exports,n,n.exports,i),n.loaded=!0,n.exports}return i.m=e,i.c=t,i.p="",i(0)}([function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isNotPNG=function(e){return e===a},t.isNotAPNG=function(e){return e===s},t.default=function(e){var t=new Uint8Array(e);if(Array.prototype.some.call(o,(function(e,i){return e!==t[i]})))return a;var i=!1;if(u(t,(function(e){return!(i="acTL"===e)})),!i)return s;var r=[],h=[],f=null,p=null,_=0,m=new n.APNG;if(u(t,(function(e,t,i,a){var s=new DataView(t.buffer);switch(e){case"IHDR":f=t.subarray(i+8,i+8+a),m.width=s.getUint32(i+8),m.height=s.getUint32(i+12);break;case"acTL":m.numPlays=s.getUint32(i+8+4);break;case"fcTL":p&&(m.frames.push(p),_++),(p=new n.Frame).width=s.getUint32(i+8+4),p.height=s.getUint32(i+8+8),p.left=s.getUint32(i+8+12),p.top=s.getUint32(i+8+16);var o=s.getUint16(i+8+20),u=s.getUint16(i+8+22);0===u&&(u=100),p.delay=1e3*o/u,p.delay<=10&&(p.delay=100),m.playTime+=p.delay,p.disposeOp=s.getUint8(i+8+24),p.blendOp=s.getUint8(i+8+25),p.dataParts=[],0===_&&2===p.disposeOp&&(p.disposeOp=1);break;case"fdAT":p&&p.dataParts.push(t.subarray(i+8+4,i+8+a));break;case"IDAT":p&&p.dataParts.push(t.subarray(i+8,i+8+a));break;case"IEND":h.push(l(t,i,12+a));break;default:r.push(l(t,i,12+a))}})),p&&m.frames.push(p),0==m.frames.length)return s;var v=new Blob(r),g=new Blob(h);return m.frames.forEach((function(e){var t=[];t.push(o),f.set(d(e.width),0),f.set(d(e.height),4),t.push(c("IHDR",f)),t.push(v),e.dataParts.forEach((function(e){return t.push(c("IDAT",e))})),t.push(g),e.imageData=new Blob(t,{type:"image/png"}),delete e.dataParts,t=null})),m};var r=function(e){return e&&e.__esModule?e:{default:e}}(i(1)),n=i(2);var a=new Error("Not a PNG"),s=new Error("Not an animated PNG");var o=new Uint8Array([137,80,78,71,13,10,26,10]);function u(e,t){var i=new DataView(e.buffer),r=8,n=void 0,a=void 0,s=void 0;do{a=i.getUint32(r),s=t(n=h(e,r+4,4),e,r,a),r+=12+a}while(!1!==s&&"IEND"!=n&&r<e.length)}function h(e,t,i){var r=Array.prototype.slice.call(e.subarray(t,t+i));return String.fromCharCode.apply(String,r)}function l(e,t,i){var r=new Uint8Array(i);return r.set(e.subarray(t,t+i)),r}var c=function(e,t){var i=e.length+t.length,n=new Uint8Array(i+8),a=new DataView(n.buffer);a.setUint32(0,t.length),n.set(function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}(e),4),n.set(t,8);var s=(0,r.default)(n,4,i);return a.setUint32(i+4,s),n},d=function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=-1,n=t,a=t+(arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t);n<a;n++)r=r>>>8^i[255&(r^e[n])];return-1^r};for(var i=new Uint32Array(256),r=0;r<256;r++){for(var n=r,a=0;a<8;a++)n=0!=(1&n)?3988292384^n>>>1:n>>>1;i[r]=n}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Frame=t.APNG=void 0;var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=function(e){return e&&e.__esModule?e:{default:e}}(i(3));function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.APNG=function(){function e(){a(this,e),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}return r(e,[{key:"createImages",value:function(){return Promise.all(this.frames.map((function(e){return e.createImage()})))}},{key:"getPlayer",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.createImages().then((function(){return new n.default(t,e,i)}))}}]),e}(),t.Frame=function(){function e(){a(this,e),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}return r(e,[{key:"createImage",value:function(){var e=this;return this.imageElement?Promise.resolve():new Promise((function(t,i){var r=URL.createObjectURL(e.imageData);e.imageElement=document.createElement("img"),e.imageElement.onload=function(){URL.revokeObjectURL(r),t()},e.imageElement.onerror=function(){URL.revokeObjectURL(r),e.imageElement=null,i(new Error("Image creation error"))},e.imageElement.src=r}))}}]),e}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();var n=function(e){function t(e,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.playbackRate=1,n._currentFrameNumber=0,n._ended=!1,n._paused=!0,n._numPlays=0,n._apng=e,n.context=i,n.stop(),r&&n.play(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,0!==this._apng.numPlays&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&1==this._prevFrame.disposeOp?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&2==this._prevFrame.disposeOp&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var e=this.currentFrame;this._prevFrame=e,this._prevFrameData=null,2==e.disposeOp&&(this._prevFrameData=this.context.getImageData(e.left,e.top,e.width,e.height)),0==e.blendOp&&this.context.clearRect(e.left,e.top,e.width,e.height),this.context.drawImage(e.imageElement,e.left,e.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var e=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var t=performance.now()+this.currentFrame.delay/this.playbackRate;requestAnimationFrame((function i(r){if(!e._ended&&!e._paused){if(r>=t){for(;r-t>=e._apng.playTime/e.playbackRate;)t+=e._apng.playTime/e.playbackRate,e._numPlays++;do{e.renderNextFrame(),t+=e.currentFrame.delay/e.playbackRate}while(!e._ended&&r>t)}requestAnimationFrame(i)}}))}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),t}(function(e){return e&&e.__esModule?e:{default:e}}(i(4)).default);t.default=n},function(e,t){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function n(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(e){if(!function(e){return"number"==typeof e}(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},i.prototype.emit=function(e){var t,i,s,o,u,h;if(this._events||(this._events={}),"error"===e&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(a(i=this._events[e]))return!1;if(r(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),i.apply(this,o)}else if(n(i))for(o=Array.prototype.slice.call(arguments,1),s=(h=i.slice()).length,u=0;u<s;u++)h[u].apply(this,o);return!0},i.prototype.addListener=function(e,t){var s;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,n(this._events[e])&&!this._events[e].warned&&(s=a(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(e,t){if(!r(t))throw TypeError("listener must be a function");var i=!1;function n(){this.removeListener(e,n),i||(i=!0,t.apply(this,arguments))}return n.listener=t,this.on(e,n),this},i.prototype.removeListener=function(e,t){var i,a,s,o;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(s=(i=this._events[e]).length,a=-1,i===t||r(i.listener)&&i.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(n(i)){for(o=s;o-- >0;)if(i[o]===t||i[o].listener&&i[o].listener===t){a=o;break}if(a<0)return this;1===i.length?(i.length=0,delete this._events[e]):i.splice(a,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},i.prototype.removeAllListeners=function(e){var t,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r(i=this._events[e]))this.removeListener(e,i);else if(i)for(;i.length;)this.removeListener(e,i[i.length-1]);return delete this._events[e],this},i.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},i.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(r(t))return 1;if(t)return t.length}return 0},i.listenerCount=function(e,t){return e.listenerCount(t)}}])},Ne.exports=Ue();var Ge=(0,G.o)(Ne.exports),He=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){return(0,_.Z)(this,i),t.apply(this,arguments)}return(0,m.Z)(i,[{key:"_loadAnimation",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",We(t,i,r));case 1:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}()}],[{key:"create",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,r,n,a,s){var o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new i(a),e.prev=1,e.next=4,o._load(t,r,n,s);case 4:e.next=10;break;case 6:if(e.prev=6,e.t0=e.catch(1),(0,v.I)(e.t0)){e.next=10;break}return e.abrupt("return",new v.a("invalid-resource","Could not load PNG: ".concat(e.t0.message)));case 10:return e.abrupt("return",o);case 11:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(t,i,r,n,a){return e.apply(this,arguments)}}()}]),i}(Le);function We(e,t,i){return qe.apply(this,arguments)}function qe(){return qe=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,f,p,_,m,g,y,b;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((n=Ge(t))instanceof Error)){e.next=3;break}throw n;case 3:return e.next=5,n.createImages();case 5:(0,v.W)(r),a=n.frames,s=n.width,o=n.height,(u=document.createElement("canvas")).width=s,u.height=o,h=u.getContext("2d"),c=[],f=[],p=(0,d.Z)(a);try{for(p.s();!(_=p.n()).done;)m=_.value,f.push((0,v.aL)(m.delay)),g=m.imageElement,0===m.blendOp?h.globalCompositeOperation="copy":h.globalCompositeOperation="source-over",y=2===m.disposeOp&&h.getImageData(m.left,m.top,m.width,m.height),h.drawImage(g,m.left,m.top),b=h.getImageData(0,0,s,o),c.push(b),0===m.disposeOp||(1===m.disposeOp?h.clearRect(m.left,m.top,m.width,m.height):2===m.disposeOp&&h.putImageData(y,m.left,m.top))}catch(l){p.e(l)}finally{p.f()}return e.abrupt("return",{frameDurations:f,selectFrame:function(e){var t=c[e];i(t)},width:s,height:o});case 12:case"end":return e.stop()}}),e)}))),qe.apply(this,arguments)}var Ve=[137,80,78,71,13,10,26,10];function je(e){var t=new Uint8Array(e);return!Ve.some((function(e,i){return e!==t[i]}))}function Ye(e){if(!je(e))return!1;var t,i=new DataView(e),r=new Uint8Array(e),n=8;do{var a=i.getUint32(n);if("acTL"===(t=String.fromCharCode.apply(String,Array.prototype.slice.call(r.subarray(n+4,n+8)))))return!0;n+=12+a}while("IEND"!==t&&n<r.length);return!1}var Xe={},Qe={},Ke={};Object.defineProperty(Ke,"__esModule",{value:!0}),Ke.loop=Ke.conditional=Ke.parse=void 0;Ke.parse=function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r;if(Array.isArray(i))i.forEach((function(i){return e(t,i,r,n)}));else if("function"==typeof i)i(t,r,n,e);else{var a=Object.keys(i)[0];Array.isArray(i[a])?(n[a]={},e(t,i[a],r,n[a])):n[a]=i[a](t,r,n,e)}return r};Ke.conditional=function(e,t){return function(i,r,n,a){t(i,r,n)&&a(i,e,r,n)}};Ke.loop=function(e,t){return function(i,r,n,a){for(var s=[],o=i.pos;t(i,r,n);){var u={};if(a(i,e,r,u),i.pos===o)break;o=i.pos,s.push(u)}return s}};var Je={};Object.defineProperty(Je,"__esModule",{value:!0}),Je.readBits=Je.readArray=Je.readUnsigned=Je.readString=Je.peekBytes=Je.readBytes=Je.peekByte=Je.readByte=Je.buildStream=void 0;Je.buildStream=function(e){return{data:e,pos:0}};var $e=function(){return function(e){return e.data[e.pos++]}};Je.readByte=$e;Je.peekByte=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return t.data[t.pos+e]}};var et=function(e){return function(t){return t.data.subarray(t.pos,t.pos+=e)}};Je.readBytes=et;Je.peekBytes=function(e){return function(t){return t.data.subarray(t.pos,t.pos+e)}};Je.readString=function(e){return function(t){return Array.from(et(e)(t)).map((function(e){return String.fromCharCode(e)})).join("")}};Je.readUnsigned=function(e){return function(t){var i=et(2)(t);return e?(i[1]<<8)+i[0]:(i[0]<<8)+i[1]}};Je.readArray=function(e,t){return function(i,r,n){for(var a="function"==typeof t?t(i,r,n):t,s=et(e),o=new Array(a),u=0;u<a;u++)o[u]=s(i);return o}};Je.readBits=function(e){return function(t){for(var i=function(e){return e.data[e.pos++]}(t),r=new Array(8),n=0;n<8;n++)r[7-n]=!!(i&1<<n);return Object.keys(e).reduce((function(t,i){var n=e[i];return n.length?t[i]=function(e,t,i){for(var r=0,n=0;n<i;n++)r+=e[t+n]&&Math.pow(2,i-n-1);return r}(r,n.index,n.length):t[i]=r[n.index],t}),{})}},function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=Ke,i=Je,r={blocks:function(e){for(var t=[],r=e.data.length,n=0,a=(0,i.readByte)()(e);0!==a&&a;a=(0,i.readByte)()(e)){if(e.pos+a>=r){var s=r-e.pos;t.push((0,i.readBytes)(s)(e)),n+=s;break}t.push((0,i.readBytes)(a)(e)),n+=a}for(var o=new Uint8Array(n),u=0,h=0;h<t.length;h++)o.set(t[h],u),u+=t[h].length;return o}},n=(0,t.conditional)({gce:[{codes:(0,i.readBytes)(2)},{byteSize:(0,i.readByte)()},{extras:(0,i.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,i.readUnsigned)(!0)},{transparentColorIndex:(0,i.readByte)()},{terminator:(0,i.readByte)()}]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&249===t[1]})),a=(0,t.conditional)({image:[{code:(0,i.readByte)()},{descriptor:[{left:(0,i.readUnsigned)(!0)},{top:(0,i.readUnsigned)(!0)},{width:(0,i.readUnsigned)(!0)},{height:(0,i.readUnsigned)(!0)},{lct:(0,i.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,t.conditional)({lct:(0,i.readArray)(3,(function(e,t,i){return Math.pow(2,i.descriptor.lct.size+1)}))},(function(e,t,i){return i.descriptor.lct.exists})),{data:[{minCodeSize:(0,i.readByte)()},r]}]},(function(e){return 44===(0,i.peekByte)()(e)})),s=(0,t.conditional)({text:[{codes:(0,i.readBytes)(2)},{blockSize:(0,i.readByte)()},{preData:function(e,t,r){return(0,i.readBytes)(r.text.blockSize)(e)}},r]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&1===t[1]})),o=(0,t.conditional)({application:[{codes:(0,i.readBytes)(2)},{blockSize:(0,i.readByte)()},{id:function(e,t,r){return(0,i.readString)(r.blockSize)(e)}},r]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&255===t[1]})),u=(0,t.conditional)({comment:[{codes:(0,i.readBytes)(2)},r]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&254===t[1]})),h=[{header:[{signature:(0,i.readString)(3)},{version:(0,i.readString)(3)}]},{lsd:[{width:(0,i.readUnsigned)(!0)},{height:(0,i.readUnsigned)(!0)},{gct:(0,i.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,i.readByte)()},{pixelAspectRatio:(0,i.readByte)()}]},(0,t.conditional)({gct:(0,i.readArray)(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},(function(e,t){return t.lsd.gct.exists})),{frames:(0,t.loop)([n,o,u,a,s],(function(e){var t=(0,i.peekByte)()(e);return 33===t||44===t}))}];e.default=h}(Qe);var tt={};Object.defineProperty(tt,"__esModule",{value:!0}),tt.deinterlace=void 0;tt.deinterlace=function(e,t){for(var i=new Array(e.length),r=e.length/t,n=function(r,n){var a=e.slice(n*t,(n+1)*t);i.splice.apply(i,[r*t,t].concat(a))},a=[0,4,2,1],s=[8,8,4,2],o=0,u=0;u<4;u++)for(var h=a[u];h<r;h+=s[u])n(h,o),o++;return i};var it={};Object.defineProperty(it,"__esModule",{value:!0}),it.lzw=void 0;it.lzw=function(e,t,i){var r,n,a,s,o,u,h,l,c,d,f,p,_,m,v,g,y=4096,b=i,w=new Array(i),x=new Array(y),T=new Array(y),k=new Array(y+1);for(o=1+(n=1<<(d=e)),r=n+2,h=-1,a=(1<<(s=d+1))-1,l=0;l<n;l++)x[l]=0,T[l]=l;for(f=p=_=m=v=g=0,c=0;c<b;){if(0===m){if(p<s){f+=t[g]<<p,p+=8,g++;continue}if(l=f&a,f>>=s,p-=s,l>r||l==o)break;if(l==n){a=(1<<(s=d+1))-1,r=n+2,h=-1;continue}if(-1==h){k[m++]=T[l],h=l,_=l;continue}for(u=l,l==r&&(k[m++]=_,l=h);l>n;)k[m++]=T[l],l=x[l];_=255&T[l],k[m++]=_,r<y&&(x[r]=h,T[r]=_,0==(++r&a)&&r<y&&(s++,a+=r)),h=u}m--,w[v++]=k[m],c++}for(c=v;c<b;c++)w[c]=0;return w},Object.defineProperty(Xe,"__esModule",{value:!0});var rt=Xe.decompressFrames=Xe.decompressFrame=ht=Xe.parseGIF=void 0,nt=function(e){return e&&e.__esModule?e:{default:e}}(Qe),at=Ke,st=Je,ot=tt,ut=it;var ht=Xe.parseGIF=function(e){var t=new Uint8Array(e);return(0,at.parse)((0,st.buildStream)(t),nt.default)},lt=function(e,t,i){if(e.image){var r=e.image,n=r.descriptor.width*r.descriptor.height,a=(0,ut.lzw)(r.data.minCodeSize,r.data.blocks,n);r.descriptor.lct.interlaced&&(a=(0,ot.deinterlace)(a,r.descriptor.width));var s={pixels:a,dims:{top:e.image.descriptor.top,left:e.image.descriptor.left,width:e.image.descriptor.width,height:e.image.descriptor.height}};return r.descriptor.lct&&r.descriptor.lct.exists?s.colorTable=r.lct:s.colorTable=t,e.gce&&(s.delay=10*(e.gce.delay||10),s.disposalType=e.gce.extras.disposal,e.gce.extras.transparentColorGiven&&(s.transparentIndex=e.gce.transparentColorIndex)),i&&(s.patch=function(e){for(var t=e.pixels.length,i=new Uint8ClampedArray(4*t),r=0;r<t;r++){var n=4*r,a=e.pixels[r],s=e.colorTable[a]||[0,0,0];i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=a!==e.transparentIndex?255:0}return i}(s)),s}console.warn("gif frame does not have associated image.")};Xe.decompressFrame=lt;rt=Xe.decompressFrames=function(e,t){return e.frames.filter((function(e){return e.image})).map((function(i){return lt(i,e.gct,t)}))};var ct=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){return(0,_.Z)(this,i),t.apply(this,arguments)}return(0,m.Z)(i,[{key:"_loadAnimation",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",dt(t,i));case 1:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}()}],[{key:"create",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,r,n,a,s){var o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new i(a),e.prev=1,e.next=4,o._load(t,r,n,s);case 4:e.next=10;break;case 6:if(e.prev=6,e.t0=e.catch(1),(0,v.I)(e.t0)){e.next=10;break}return e.abrupt("return",new v.a("invalid-resource","Could not load GIF: ".concat(e.t0.message)));case 10:return e.abrupt("return",o);case 11:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(t,i,r,n,a){return e.apply(this,arguments)}}()}]),i}(Le);function dt(e,t,i){return ft.apply(this,arguments)}function ft(){return ft=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,f,p,_,m,g,y,b,w,x;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ht(t),a=rt(n,!0),s=n.lsd,o=s.width,u=s.height,(h=document.createElement("canvas")).width=o,h.height=u,c=h.getContext("2d"),f=[],p=[],_=(0,d.Z)(a);try{for(_.s();!(m=_.n()).done;)g=m.value,p.push((0,v.aL)(g.delay)),y=new ImageData(g.patch,g.dims.width,g.dims.height),b=(0,H.m)(y),w=3===g.disposalType&&c.getImageData(g.dims.left,g.dims.top,g.dims.width,g.dims.height),c.drawImage(b,g.dims.left,g.dims.top),x=c.getImageData(0,0,o,u),f.push(x),1===g.disposalType||(2===g.disposalType?c.clearRect(g.dims.left,g.dims.top,g.dims.width,g.dims.height):3===g.disposalType&&c.putImageData(w,g.dims.left,g.dims.top))}catch(r){_.e(r)}finally{_.f()}return e.abrupt("return",{frameDurations:p,selectFrame:function(e){var t=f[e];i(t)},width:o,height:u});case 6:case"end":return e.stop()}}),e)}))),ft.apply(this,arguments)}var pt=[71,73,70];function _t(e){var t=new Uint8Array(e);return!pt.some((function(e,i){return e!==t[i]}))}function mt(e){if(!_t(e))return!1;for(var t=new DataView(e),i=t.getUint8(10),r=13+(128&i?3*Math.pow(2,1+(7&i)):0),n=0,a=!1;!a;){switch(t.getUint8(r++)){case 33:if(!s())return!1;break;case 44:o();break;case 59:a=!0;break;default:return!1}if(n>1)return!0}function s(){switch(t.getUint8(r++)){case 249:r++,r+=4,u();break;case 1:n++,r++,r+=12,u();break;case 254:u();break;case 255:r++,r+=8,r+=3,u();break;default:return!1}return!0}function o(){n++,r+=8;var e=t.getUint8(r++);r+=128&e?3*Math.pow(2,1+(7&e)):0,r++,u()}function u(){for(var e;e=t.getUint8(r++);)r+=e}return!1}function vt(e){switch(e.type){case"esriSMS":return"".concat(e.style,".").concat(e.path);case"esriSLS":return"".concat(e.style,".").concat(e.cap);case"esriSFS":return"".concat(e.style);case"esriPFS":case"esriPMS":return e.imageData?"".concat(e.imageData).concat(e.width).concat(e.height):"".concat(e.url).concat(e.width).concat(e.height);default:return"mosaicHash"in e?e.mosaicHash:JSON.stringify(e)}}var gt=(0,C.n)(),yt="arial-unicode-ms-regular",bt=v.s.getLogger("esri.views.2d.engine.webgl.TextureManager");function wt(e,t){return xt.apply(this,arguments)}function xt(){return xt=(0,c.Z)((0,l.Z)().mark((function e(t,i){var r,n,a,s,o,u,h,c,d,f;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(0,x.E)(t),a=";base64,",!r.includes(a)){e.next=8;break}for(s=r.indexOf(a)+a.length,o=r.substring(s),u=atob(o),h=new Uint8Array(u.length),c=0;c<u.length;c++)h[c]=u.charCodeAt(c);n=h.buffer,e.next=20;break;case 8:return e.prev=8,e.next=11,(0,S.U)(r,(0,p.Z)({responseType:"array-buffer"},i));case 11:d=e.sent,f=d.data,n=f,e.next=20;break;case 16:if(e.prev=16,e.t0=e.catch(8),(0,v.I)(e.t0)){e.next=20;break}return e.abrupt("return",new v.a("mapview-invalid-resource","Could not fetch requested resource at ".concat(r)));case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e,null,[[8,16]])}))),xt.apply(this,arguments)}function Tt(e,t){var i=Math.round((0,F.u)(t)*window.devicePixelRatio),r=i>=128?2:4;return Math.min(e,i*r)}var kt=function(e,t,i){return bt.error(new v.a(e,t,i))},Et=function(){function e(t,i,r){(0,_.Z)(this,e),this.mosaicType=t,this.page=i,this.sdf=r}return(0,m.Z)(e,null,[{key:"fromMosaic",value:function(t,i){return new e(t,i.page,i.sdf)}}]),e}(),Mt=function(){function e(t,i){(0,_.Z)(this,e),this._requestRender=t,this.resourceManager=i,this._invalidFontsMap=new Map,this._sdfConverter=new Se(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new q.a({concurrency:10,process:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,v.W)(i),e.prev=1,e.next=4,(0,S.U)(t,{responseType:"image",signal:i});case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),(0,v.I)(e.t0)){e.next=11;break}throw new v.a("mapview-invalid-resource","Could not fetch requested resource at ".concat(t),e.t0);case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,null,[[1,7]])})));return function(t,i){return e.apply(this,arguments)}}()}),this._spriteMosaic=new Pe(2048,2048,500),this._glyphSource=new Be("".concat(v.f.fontsUrl,"/{fontstack}/{range}.pbf")),this._glyphMosaic=new Ee(1024,1024,this._glyphSource),this._rasterizer=new A.m(i)}return(0,m.Z)(e,[{key:"dispose",value:function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}},{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}},{key:"rasterizeItem",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r,n){var a,s,o=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,v.t)(t)){e.next=2;break}return e.abrupt("return",(kt("mapview-null-resource","Unable to rasterize null resource"),null));case 2:e.t0=t.type,e.next="text"===e.t0||"esriTS"===e.t0?5:9;break;case 5:return e.next=7,this._rasterizeText(t,r,n);case 7:return a=e.sent,e.abrupt("return",(a.forEach((function(e){return o._setTextureBinding(x.O.GLYPH,e)})),{glyphMosaicItems:a}));case 9:if(!(0,x.N)(t)){e.next=11;break}return e.abrupt("return",(kt("mapview-invalid-type","MapView does not support symbol type: ".concat(t.type),t),null));case 11:return e.next=13,this._rasterizeSpriteSymbol(t,i,n);case 13:return s=e.sent,e.abrupt("return",((0,W.e)(s)&&s&&this._setTextureBinding(x.O.SPRITE,s),{spriteMosaicItem:s}));case 15:case"end":return e.stop()}}),e,this)})));return function(t,i,r,n){return e.apply(this,arguments)}}()},{key:"bindTextures",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==i.textureBinding){var n=this._bindingInfos[i.textureBinding-1],a=n.page,s=r?R.L.LINEAR_MIPMAP_LINEAR:R.L.LINEAR;switch(n.mosaicType){case x.O.SPRITE:var o=this.sprites.getWidth(a),u=this.sprites.getHeight(a),h=(0,P.r)(gt,o,u);return this._spriteMosaic.bind(e,s,a,I.y),t.setUniform1i("u_texture",I.y),void t.setUniform2fv("u_mosaicSize",h);case x.O.GLYPH:var l=this.glyphs.width,c=this.glyphs.height,d=(0,P.r)(gt,l,c);return this._glyphMosaic.bind(e,s,a,I.z),t.setUniform1i("u_texture",I.z),void t.setUniform2fv("u_mosaicSize",d);default:bt.error("mapview-texture-manager","Cannot handle unknown type ".concat(n.mosaicType))}}}},{key:"_hashMosaic",value:function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}},{key:"_setTextureBinding",value:function(e,t){var i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){var r=Et.fromMosaic(e,t),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(r)}t.textureBinding=this._hashToBindingIndex.get(i)}},{key:"_rasterizeText",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"cim"in t?(n=(s=t).fontName,a=s.text):(o=t,n=(0,Z.n)(o.font),a=o.text),u=this._invalidFontsMap.has(n),h=i||(0,x.v)((0,b.n)(a)[0]),e.prev=2,e.next=5,this._glyphMosaic.getGlyphItems(u?yt:n,h,r);case 5:return e.abrupt("return",e.sent);case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return",(kt("mapview-invalid-resource","Couldn't find font ".concat(n,". Falling back to Arial Unicode MS Regular")),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems(yt,h,r)));case 11:case"end":return e.stop()}}),e,this,[[2,8]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_rasterizeSpriteSymbol",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,x.M)(t)){e.next=2;break}return e.abrupt("return",null);case 2:if(n=vt(t),!this._spriteMosaic.has(n)){e.next=5;break}return e.abrupt("return",this._spriteMosaic.getSpriteItem(n));case 5:if(!((0,x.a)(t)||(0,x.T)(t)&&!(0,x.B)(t))){e.next=7;break}return e.abrupt("return",this._handleAsyncResource(n,t,r));case 7:if(1,!(a=this._rasterizer.rasterizeJSONResource(t,1))){e.next=11;break}return s=a.size,o=a.image,u=a.sdf,h=a.simplePattern,e.abrupt("return",this._addItemToMosaic(n,s,{type:"static",data:o},(0,x._)(t),u,h));case 11:return e.abrupt("return",new v.a("TextureManager","unrecognized or null rasterized image"));case 12:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleAsyncResource",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._ongoingRasterizations.has(t)){e.next=2;break}return e.abrupt("return",this._ongoingRasterizations.get(t));case 2:return n=(0,x.a)(i)?this._handleSVG(i,t,r):this._handleImage(i,t,r),this._ongoingRasterizations.set(t,n),e.prev=3,e.next=6,n;case 6:this._ongoingRasterizations.delete(t),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),this._ongoingRasterizations.delete(t);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleSVG",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[126,126],e.next=3,this._sdfConverter.draw(t.path,r);case 3:return a=e.sent,e.abrupt("return",this._addItemToMosaic(i,n,{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleGIFOrPNG",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,d,f,p,_,m,g,y,b;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,wt(t,r);case 2:if(n=e.sent,!(0,W.e)(n)){e.next=37;break}if(a=_t(n),s=je(n),a||s){e.next=7;break}return e.abrupt("return",new v.a("mapview-invalid-resource","Image data is neither GIF nor PNG!"));case 7:if(e.prev=7,u=t.animatedSymbolProperties||{},h=t.objectId,!a||!mt(n)){e.next=15;break}return e.next=12,ct.create(n,u,h,this._requestRender,r);case 12:o=e.sent,e.next=20;break;case 15:if(e.t0=s&&Ye(n),!e.t0){e.next=20;break}return e.next=19,He.create(n,u,h,this._requestRender,r);case 19:o=e.sent;case 20:e.next=26;break;case 22:if(e.prev=22,e.t1=e.catch(7),(0,v.I)(e.t1)){e.next=26;break}return e.abrupt("return",new v.a("mapview-invalid-resource","Could not fetch requested resource!"));case 26:if(!o||!(0,W.e)(o)){e.next=28;break}return e.abrupt("return",this._addItemToMosaic(i,[o.width,o.height],{type:"animated",data:o},(0,x._)(t),!1,!1));case 28:return c=new Blob([n],{type:a?"image/gif":"image/png"}),e.next=31,this._imageFromBlob(c);case 31:if(!((d=e.sent)&&d instanceof HTMLImageElement)){e.next=37;break}return f=d.width,p=d.height,"esriPMS"===t.type&&(f=Math.round(Tt(d.width,(0,x.U)(t))),p=Math.round(d.height*(f/d.width))),_="cim"in t?t.cim.colorSubstitutions:void 0,m=this._rasterizer.rasterizeImageResource(f,p,d,_),g=m.size,y=m.sdf,b=m.image,e.abrupt("return",this._addItemToMosaic(i,g,{type:"static",data:b},(0,x._)(t),y,!1));case 37:return e.abrupt("return",new v.a("mapview-invalid-resource","Could not handle resource!"));case 38:case"end":return e.stop()}}),e,this,[[7,22]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_handleImage",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i,r){var n,a,s,o,u,h,c,d,f,_,m,g,y,b;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,x.w)(t)&&!(0,x.b)(t)){e.next=2;break}return e.abrupt("return",this._handleGIFOrPNG(t,i,r));case 2:if(n=(0,x.E)(t),e.prev=3,s=this.resourceManager.getResource(n),!(0,v.r)(s)){e.next=9;break}a=s,e.next=14;break;case 9:return e.next=11,this._imageRequestQueue.push(n,(0,p.Z)({},r));case 11:o=e.sent,u=o.data,a=u;case 14:if((0,x.D)(n)&&("width"in t&&"height"in t?(a.width=(0,F.u)(t.width),a.height=(0,F.u)(t.height)):"cim"in t&&(c=t.cim,a.width=(0,F.u)(null!==(h=c.width)&&void 0!==h?h:c.scaleX*c.size),a.height=(0,F.u)(c.size))),a.width&&a.height){e.next=17;break}return e.abrupt("return",null);case 17:return d=a.width,f=a.height,"esriPMS"===t.type&&(d=Math.round(Tt(a.width,(0,x.U)(t))),f=Math.round(a.height*(d/a.width))),_="cim"in t?t.cim.colorSubstitutions:void 0,m=this._rasterizer.rasterizeImageResource(d,f,a,_),g=m.size,y=m.sdf,b=m.image,e.abrupt("return",this._addItemToMosaic(i,g,{type:"static",data:b},(0,x._)(t),y,!1));case 23:if(e.prev=23,e.t0=e.catch(3),(0,v.I)(e.t0)){e.next=27;break}return e.abrupt("return",new v.a("mapview-invalid-resource","Could not fetch requested resource at ".concat(n,". ").concat(e.t0.message)));case 27:case"end":return e.stop()}}),e,this,[[3,23]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_imageFromBlob",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=window.URL.createObjectURL(t),e.prev=1,e.next=4,this._imageRequestQueue.push(i);case 4:return r=e.sent,n=r.data,e.abrupt("return",(window.URL.revokeObjectURL(i),n));case 9:if(e.prev=9,e.t0=e.catch(1),window.URL.revokeObjectURL(i),(0,v.I)(e.t0)){e.next=13;break}return e.abrupt("return",new v.a("mapview-invalid-resource","Could not fetch requested resource at ".concat(i)));case 13:throw e.t0;case 14:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_addItemToMosaic",value:function(e,t,i,r,n,a){return this._spriteMosaic.addSpriteItem(e,t,i,r,n,a)}}]),e}(),Rt={shaders:{vertexShader:(0,T.n)("stencil/stencil.vert"),fragmentShader:(0,T.n)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},Bt=(0,Y.r)(-.5,-.5),Ot=function(){function e(){(0,_.Z)(this,e),this._centerNdc=(0,V.n)(),this._pxToNdc=(0,V.n)(),this._worldDimensionsPx=(0,V.n)(),this._mat3=(0,y.M)(),this._initialized=!1}return(0,m.Z)(e,[{key:"dispose",value:function(){this._program=(0,v.aQ)(this._program),this._quad=(0,v.aQ)(this._quad)}},{key:"render",value:function(e,t){var i=e.context;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(R.O.KEEP,R.O.KEEP,R.O.REPLACE),i.setStencilFunction(R.I.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}},{key:"_initialize",value:function(e){if(!this._initialized){var t=(0,B.a)(e,Rt);t&&(this._program=t,this._quad=new T.a(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}}},{key:"_updateGeometry",value:function(e,t){var i=e.state,r=e.pixelRatio,n=i.size,a=i.rotation,s=Math.round(n[0]*r),o=Math.round(n[1]*r);if(!i.spatialReference.isWrappable)return!1;var u=(0,V.c)(a),h=Math.abs(Math.cos(u)),l=Math.abs(Math.sin(u)),c=Math.round(s*h+o*l),d=Math.round(i.worldScreenWidth);if(c<=d)return!1;var f=s*l+o*h,p=d*r,_=(t.left-t.right)*r/s,m=(t.bottom-t.top)*r/o;(0,V.f)(this._worldDimensionsPx,p,f,1),(0,V.f)(this._pxToNdc,2/s,-2/o,1),(0,V.f)(this._centerNdc,_,m,1);var v=this._mat3;return(0,j.l)(v,this._centerNdc),(0,j.f)(v,v,this._pxToNdc),0!==a&&(0,j.h)(v,v,u),(0,j.f)(v,v,this._worldDimensionsPx),(0,j.M)(v,v,Bt),!0}}]),e}(),St=function(){function e(){(0,_.Z)(this,e),this.name=this.constructor.name}return(0,m.Z)(e,[{key:"createOptions",value:function(e,t){return null}}]),e}(),Ft=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,_.Z)(this,i),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])},e}return(0,m.Z)(i,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(t.size){var i=e.context,r=e.renderingOptions;this._quad||(this._quad=new T.a(i,[0,0,1,0,0,1,1,1]));var n=i.getBoundFramebufferObject(),a=i.getViewport(),s=a.x,o=a.y,u=a.width,h=a.height;t.bindTextures(i);var l=t.getBlock(I.N);if(!(0,v.t)(l)){var c=l.getFBO(i),d=l.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,r.labelsAnimationTime),this._updateAnimationState(e,d,c),i.bindFramebuffer(n),i.setViewport(s,o,u,h)}}}},{key:"_computeDelta",value:function(e,t,i){var r=e.context,n=e.painter,a=e.displayLevel,s=n.materialManager.getProgram(this._desc,["delta"]);r.bindFramebuffer(t),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(s),s.setUniform1i("u_maskTexture",I.B),s.setUniform1i("u_sourceTexture",I.C),s.setUniform1f("u_timeDelta",e.deltaTime),s.setUniform1f("u_animationTime",i),s.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,i){var r=e.context,n=e.painter.materialManager.getProgram(this._desc,["update"]);r.bindTexture(t.colorTexture,1),r.useProgram(n),n.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),i}(St),Pt=function(e){return"#define ".concat(function(e){return e.replace("-","_").toUpperCase()}(e),"\n")};function Ct(e){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Pt(e)+(0,T.n)("blend/blend.vert"),fragmentShader:Pt(e)+(0,T.n)("blend/blend.frag")}}}var At=v.s.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect"),It=function(){function e(){(0,_.Z)(this,e),this._size=[0,0]}return(0,m.Z)(e,[{key:"dispose",value:function(e){this._backBufferTexture=(0,v.aQ)(this._backBufferTexture),this._quad=(0,v.aQ)(this._quad)}},{key:"draw",value:function(e,t,i,r,n){var a=e.context,s=e.drawPhase;if(this._setupShader(a),r&&"normal"!==r&&s!==x.I.LABEL)this._drawBlended(e,t,i,r,n);else{var o=Ct("normal"),u=a.programCache.acquire(o.shaders.vertexShader,o.shaders.fragmentShader,o.attributes);if(u){a.useProgram(u),t.setSamplingMode(i),a.bindTexture(t,0),u.setUniform1i("u_layerTexture",0),u.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA);var h=this._quad;h.draw(),h.unbind(),u.dispose()}else At.error(new v.a("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'))}}},{key:"_drawBlended",value:function(e,t,i,r,n){var a,s,o=e.context,u=e.state,h=e.pixelRatio,l=e.inFadeTransition,c=u.size,d=o.getBoundFramebufferObject();if((0,v.r)(d)){var f=d.descriptor;a=f.width,s=f.height}else a=Math.round(h*c[0]),s=Math.round(h*c[1]);this._createOrResizeTexture(e,a,s);var p=this._backBufferTexture;d.copyToTexture(0,0,a,s,0,0,p),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);var _=Ct(r),m=o.programCache.acquire(_.shaders.vertexShader,_.shaders.fragmentShader,_.attributes);if(m){o.useProgram(m),p.setSamplingMode(i),o.bindTexture(p,0),m.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),m.setUniform1i("u_layerTexture",1),m.setUniform1f("u_opacity",n),m.setUniform1f("u_inFadeOpacity",l?1:0),o.setBlendFunction(R.R.ONE,R.R.ZERO);var g=this._quad;g.draw(),g.unbind(),m.dispose(),o.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA)}else At.error(new v.a("mapview-BlendEffect","Error creating shader program for blend mode ".concat(r)))}},{key:"_setupShader",value:function(e){this._quad||(this._quad=new T.a(e,[-1,-1,1,-1,-1,1,1,1]))}},{key:"_createOrResizeTexture",value:function(e,t,i){var r=e.context;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new z.u(r,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}]),e}(),Zt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this)).name=r.constructor.name,r.defines=[e],r}return(0,m.Z)(i,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,i=e.painter;this._prev=t.getBoundFramebufferObject();var r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var i,r=e.context,n=e.painter,a=n.getPostProcessingEffects(t),s=r.getBoundFramebufferObject(),o=(0,d.Z)(a);try{for(o.s();!(i=o.n()).done;){var u=i.value,h=u.postProcessingEffect,l=u.effect;h.draw(e,s,l)}}catch(c){o.e(c)}finally{o.f()}r.bindFramebuffer(this._prev),r.setStencilTestEnabled(!1),n.blitTexture(r,s.colorTexture,R.L.NEAREST),r.setStencilTestEnabled(!0)}}]),i}(St),Dt=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],zt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ut=256,Lt=1.3,Nt=.4,Gt=.4,Ht=0,Wt=v.s.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");var qt=[0,0,0,0],Vt=function(){function e(){(0,_.Z)(this,e),this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:Ht,outlineWidth:Lt,innerHaloWidth:Gt,outerHaloWidth:Nt},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}return(0,m.Z)(e,[{key:"setHighlightOptions",value:function(e){var t=this._convertedHighlightOptions;!function(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=Lt,t.outerHaloWidth=Nt,t.innerHaloWidth=Gt,t.outlinePosition=Ht}(e,t);var i,r=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,n=t.outlinePosition-t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2,s=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,o=1*Math.sqrt(Math.PI/2),u=Math.abs(r)>o?Math.round(10*(Math.abs(r)-o))/10:0,l=Math.abs(s)>o?Math.round(10*(Math.abs(s)-o))/10:0;u&&!l?Wt.error("The outer rim of the highlight is "+u+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!u&&l?Wt.error("The inner rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):u&&l&&Wt.error("The highlight is "+Math.max(u,l)+"px away from the edge of the feature; consider reducing some width values.");var c=[void 0,void 0,void 0,void 0];function d(e,t,i){c[0]=(1-i)*e[0]+i*t[0],c[1]=(1-i)*e[1]+i*t[1],c[2]=(1-i)*e[2]+i*t[2],c[3]=(1-i)*e[3]+i*t[3]}for(var f=this.texelData,p=0;p<Ut;++p){var _,m,v,g;(i=r+p/255*(s-r))<r?(c[4*p+0]=0,c[4*p+1]=0,c[4*p+2]=0,c[4*p+3]=0):i<n?d(qt,t.outlineColor,(i-r)/(n-r)):i<a?(_=t.outlineColor,m=(0,h.Z)(_,4),c[0]=m[0],c[1]=m[1],c[2]=m[2],c[3]=m[3]):i<s?d(t.outlineColor,t.fillColor,(i-a)/(s-a)):(v=t.fillColor,g=(0,h.Z)(v,4),c[4*p+0]=g[0],c[4*p+1]=g[1],c[4*p+2]=g[2],c[4*p+3]=g[3]),f[4*p+0]=255*c[0],f[4*p+1]=255*c[1],f[4*p+2]=255*c[2],f[4*p+3]=255*c[3]}this.minMaxDistance[0]=r,this.minMaxDistance[1]=s,this.shadeTexChanged=!0}},{key:"applyHighlightOptions",value:function(e,t){this.shadeTex||(this.shadeTex=new z.u(e,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,width:Ut,height:1,samplingMode:R.L.LINEAR})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,Ut,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,I.J),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}},{key:"destroy",value:function(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}]),e}(),jt={shaders:{vertexShader:(0,T.n)("highlight/textured.vert"),fragmentShader:(0,T.n)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Yt={shaders:{vertexShader:(0,T.n)("highlight/textured.vert"),fragmentShader:(0,T.n)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Xt=function(){function e(){(0,_.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,m.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,I.I),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Dt),e.bindVAO(this._resources.quadVAO),e.drawArrays(R.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,I.I),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",zt),e.bindVAO(this._resources.quadVAO),e.drawArrays(R.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,i){e.bindTexture(t,I.I),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),e.drawArrays(R.E.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=M.c.createVertex(e,R.F.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new M.f(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new X.t("a_position",2,R.C.BYTE,0,4),new X.t("a_texcoord",2,R.C.UNSIGNED_BYTE,2,4)]},{geometry:r}),a=(0,B.a)(e,jt),s=(0,B.a)(e,Yt);e.useProgram(a),a.setUniform1i("u_texture",I.I),a.setUniform1i("u_shade",I.J),a.setUniform1f("u_sigma",1),e.useProgram(s),s.setUniform1i("u_texture",I.I),s.setUniform1f("u_sigma",1),this._resources={quadGeometry:r,quadVAO:n,highlightProgram:a,blurProgram:s}}},{key:"setup",value:function(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}]),e}();function Qt(e,t,i){var r=new z.u(e,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,width:t,height:i,samplingMode:R.L.LINEAR});return[r,new M.D(e,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.STENCIL_RENDER_BUFFER},r)]}var Kt=function(){function e(){(0,_.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,m.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=Qt(e,t,i),n=(0,h.Z)(r,2),a=n[0],s=n[1],o=Qt(e,t,i),u=(0,h.Z)(o,2),l=u[0],c=u[1];this._resources={sharedBlur1Tex:a,sharedBlur1Fbo:s,sharedBlur2Tex:l,sharedBlur2Fbo:c}}},{key:"setup",value:function(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Tex}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Tex}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}(),Jt=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,_.Z)(this,i),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new Xt,e._hlGradient=new Vt,e._width=void 0,e._height=void 0,e._hlSurfaces=new Kt,e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new pe,e}return(0,m.Z)(i,[{key:"dispose",value:function(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;this.setup(e,n,a),t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,i){var r=e.context;this._width=t,this._height=i;var n=t%4,a=i%4;t+=n<2?-n:4-n,i+=a<2?-a:4-a,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=r.getBoundFramebufferObject();var s=Math.round(1*t),o=Math.round(1*i);this._hlRenderer.setup(r,s,o),this._hlSurfaces.setup(r,s,o)}},{key:"draw",value:function(e){var t=e.context,i=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,R.L.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}},{key:"setHighlightOptions",value:function(e){this._hlGradient.setHighlightOptions(e)}}]),i}(St),$t=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,_.Z)(this,i),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["hittest"],e}return(0,m.Z)(i,[{key:"dispose",value:function(){(0,v.r)(this._fbo)&&this._fbo.dispose()}},{key:"createOptions",value:function(e,t){var i=e.pixelRatio,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:I.Y;if(!t.length)return null;var n=t.shift(),a=n.point.x,s=n.point.y;return this._outstanding=n,{type:"hittest",distance:r*i,position:[a,s]}}},{key:"bind",value:function(e){var t=e.context,i=e.attributeView;if(i.size){var r=i.getBlock(I.O);if(!(0,v.t)(r)){var n=r.getFBO(t);t.setViewport(0,0,i.size,i.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}}}},{key:"unbind",value:function(e){}},{key:"draw",value:function(e){var t=e.context,i=e.attributeView.getBlock(I.O);if(!(0,v.t)(this._outstanding)){var r=this._outstanding.resolver;if((0,v.t)(i))return r.resolve([]),void(this._outstanding=null);var n=i.getFBO(t),a=new Uint8Array(n.width*n.height*4);n.readPixels(0,0,n.width,n.height,R.P.RGBA,R.G.UNSIGNED_BYTE,a);for(var s=[],o=0;o<a.length;o+=4){var u=a[o],h=a[o+3];u&&s.push({id:o/4,directHits:h})}this._outstanding=null,s.sort((function(e,t){return t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits})),r.resolve(s.map((function(e){return e.id})))}}}]),i}(St),ei=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,_.Z)(this,i),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e}return(0,m.Z)(i,[{key:"dispose",value:function(){(0,v.r)(this._fbo)&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height;this._boundFBO=t.getBoundFramebufferObject();var s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(e){e.context.bindFramebuffer(this._boundFBO),this._boundFBO=null}},{key:"draw",value:function(e,t){var i=this,r=e.context,n=e.state,a=e.pixelRatio,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*I.Y,o=r.getBoundFramebufferObject(),u=n.size[1]*a,h=Math.round(s*a),l=h/2,c=h/2;this._ensureBuffer(h),t.forEach((function(e,r){var n=new Map,s=Math.floor(r.x*a-h/2),d=Math.floor(u-r.y*a-h/2);o.readPixels(s,d,h,h,R.P.RGBA,R.G.UNSIGNED_BYTE,i._buf);for(var f=0;f<i._buf32.length;f++){var p=i._buf32[f];if(4294967295!==p&&0!==p){var _=f%h,m=h-Math.floor(f/h),v=(l-_)*(l-_)+(c-m)*(c-m),g=n.has(p)?n.get(p):4294967295;n.set(p,Math.min(v,g))}}var y=Array.from(n).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]}));e.resolve(y),t.delete(r)}))}},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),i}(St),ti=[1,0],ii=[0,1],ri=[1,.8,.6,.4,.2],ni=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],ai=function(){function e(){(0,_.Z)(this,e),this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,m.Z)(e,[{key:"dispose",value:function(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(var e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height,a=e.context,s=e.painter.materialManager,o=a.gl,u=this._programDesc,h=i.strength,l=i.radius,c=i.threshold;this._quad||(this._quad=new T.a(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,r,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);var d=this._quad;d.bind(),a.bindFramebuffer(this._intensityFBO);var f=s.getProgram(u.luminosityHighPass);a.useProgram(f),a.bindTexture(t.colorTexture,0),f.setUniform1i("u_texture",0),f.setUniform3fv("u_defaultColor",[0,0,0]),f.setUniform1f("u_defaultOpacity",0),f.setUniform1f("u_luminosityThreshold",c),f.setUniform1f("u_smoothWidth",.01);var p=[Math.round(r/2),Math.round(n/2)];a.setViewport(0,0,p[0],p[1]),a.setClearColor(0,0,0,0),a.clear(o.COLOR_BUFFER_BIT),d.draw(),a.setBlendingEnabled(!1);for(var _=this._intensityFBO.colorTexture,m=0;m<this._nMips;m++){var v=s.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[m]}]);a.useProgram(v),a.bindTexture(_,m+1),v.setUniform1i("u_colorTexture",m+1),v.setUniform2fv("u_texSize",p),v.setUniform2fv("u_direction",ti),a.setViewport(0,0,p[0],p[1]);var g=this._mipsFBOs[m];a.bindFramebuffer(g.horizontal),d.draw(),_=g.horizontal.colorTexture,a.bindFramebuffer(g.vertical),a.bindTexture(_,m+1),v.setUniform2fv("u_direction",ii),d.draw(),_=g.vertical.colorTexture,p[0]=Math.round(p[0]/2),p[1]=Math.round(p[1]/2)}a.setViewport(0,0,r,n);var y=s.getProgram(u.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(y),y.setUniform1f("u_bloomStrength",h),y.setUniform1f("u_bloomRadius",l),y.setUniform1fv("u_bloomFactors",ri),y.setUniform3fv("u_bloomTintColors",ni),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),y.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),y.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),y.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),y.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),y.setUniform1i("u_blurTexture5",5),d.draw(),a.bindFramebuffer(t),a.setBlendingEnabled(!0);var b=s.getProgram(u.blit);a.useProgram(b),a.bindTexture(this._compositeFBO.colorTexture,6),b.setUniform1i("u_texture",6),a.setBlendFunction(R.R.ONE,R.R.ONE),d.draw(),d.unbind(),a.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;if(!this._compositeFBO||this._size[0]!==t||this._size[1]!==i){this._size[0]=t,this._size[1]=i;var n=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new M.D(r,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new M.D(r,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:n[0],height:n[1]},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:n[0],height:n[1]});for(var a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new M.D(r,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:n[0],height:n[1]},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:n[0],height:n[1]}),vertical:new M.D(r,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:n[0],height:n[1]},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}]),e}(),si=[1,0],oi=[0,1],ui=function(){function e(){(0,_.Z)(this,e),this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,m.Z)(e,[{key:"dispose",value:function(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}},{key:"draw",value:function(e,t,i){var r=e.context,n=i.type,a=i.radius;if(0!==a){this._createOrResizeResources(e),this._quad||(this._quad=new T.a(r,[-1,-1,1,-1,-1,1,1,1]));var s=this._quad;s.bind(),"blur"===n?this._gaussianBlur(e,t,a):this._radialBlur(e,t),s.unbind()}}},{key:"_gaussianBlur",value:function(e,t,i){var r=e.context,n=e.state,a=e.painter,s=e.pixelRatio,o=n.size,u=a.materialManager,h=this._programDesc,l=this._quad,c=[Math.round(s*o[0]),Math.round(s*o[1])],d=this._blurFBO,f=u.getProgram(h.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);r.useProgram(f),r.setBlendingEnabled(!1),r.bindFramebuffer(d),r.bindTexture(t.colorTexture,4),f.setUniform1i("u_colorTexture",4),f.setUniform2fv("u_texSize",c),f.setUniform2fv("u_direction",si),f.setUniform1f("u_sigma",i),l.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.bindTexture(d.colorTexture,5),f.setUniform1i("u_colorTexture",5),f.setUniform2fv("u_direction",oi),l.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0)}},{key:"_radialBlur",value:function(e,t){var i=e.context,r=e.painter.materialManager,n=this._programDesc,a=this._quad,s=this._blurFBO;i.bindFramebuffer(s);var o=r.getProgram(n.radialBlur);i.useProgram(o),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),o.setUniform1i("u_colorTexture",4),a.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);var u=r.getProgram(n.blit);i.useProgram(u),i.bindTexture(s.colorTexture,5),u.setUniform1i("u_texture",5),i.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),a.draw()}},{key:"_createOrResizeResources",value:function(e){var t=e.context,i=e.state,r=e.pixelRatio,n=i.size,a=Math.round(r*n[0]),s=Math.round(r*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===s||(this._size[0]=a,this._size[1]=s,this._blurFBO?this._blurFBO.resize(a,s):this._blurFBO=new M.D(t,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:a,height:s},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:a,height:s}))}}]),e}(),hi=function(){function e(){(0,_.Z)(this,e),this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}return(0,m.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height;this._createOrResizeResources(e,r,n);var a=e.context,s=e.painter.materialManager,o=this._programDesc,u=this._quad,h=i.colorMatrix;u.bind();var l=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,r,n,0,0,l),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);var c=s.getProgram(o);a.useProgram(c),a.bindTexture(l,2),c.setUniformMatrix4fv("u_coefficients",h),c.setUniform1i("u_colorTexture",2),u.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),u.unbind()}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new z.u(r,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:t,height:i}),this._quad||(this._quad=new T.a(r,[-1,-1,1,-1,-1,1,1,1])))}}]),e}(),li=[1,0],ci=[0,1],di=function(){function e(){(0,_.Z)(this,e),this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,m.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}},{key:"draw",value:function(e,t,i){var r=e.context,n=e.state,a=e.painter.materialManager,s=this._programDesc,o=t.width,u=t.height,h=[Math.round(o/2),Math.round(u/2)],l=i.blurRadius,c=i.offsetX,d=i.offsetY,f=i.color,p=[(0,F.u)(c/2),(0,F.u)(d/2)];this._createOrResizeResources(e,o,u,h);var _=this._horizontalBlurFBO,m=this._verticalBlurFBO;r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1);var v=this._layerFBOTexture;t.copyToTexture(0,0,o,u,0,0,v),this._quad||(this._quad=new T.a(r,[-1,-1,1,-1,-1,1,1,1])),r.setViewport(0,0,h[0],h[1]);var g=this._quad;g.bind(),r.setBlendingEnabled(!1);var y=a.getProgram(s.blur,[{name:"radius",value:Math.ceil(l)}]);r.useProgram(y),r.bindFramebuffer(_),r.bindTexture(t.colorTexture,4),y.setUniform1i("u_colorTexture",4),y.setUniform2fv("u_texSize",h),y.setUniform2fv("u_direction",li),y.setUniform1f("u_sigma",l),g.draw(),r.bindFramebuffer(m),r.bindTexture(_.colorTexture,5),y.setUniform1i("u_colorTexture",5),y.setUniform2fv("u_direction",ci),g.draw(),r.bindFramebuffer(t),r.setViewport(0,0,o,u);var b=a.getProgram(s.composite);r.useProgram(b),r.bindTexture(m.colorTexture,2),b.setUniform1i("u_blurTexture",2),r.bindTexture(v,3),b.setUniform1i("u_layerFBOTexture",3),b.setUniform4fv("u_shadowColor",[f[3]*(f[0]/255),f[3]*(f[1]/255),f[3]*(f[2]/255),f[3]]),b.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),b.setUniform2fv("u_shadowOffset",p),g.draw(),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!0),r.setBlendFunction(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),g.unbind()}},{key:"_createOrResizeResources",value:function(e,t,i,r){var n=e.context;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(r[0],r[1]):this._horizontalBlurFBO=new M.D(n,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:r[0],height:r[1]},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(r[0],r[1]):this._verticalBlurFBO=new M.D(n,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.NONE,width:r[0],height:r[1]},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:r[0],height:r[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new z.u(n,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:t,height:i}))}}]),e}(),fi=function(){function e(){(0,_.Z)(this,e),this._size=[0,0]}return(0,m.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}},{key:"draw",value:function(e,t,i){var r=t.width,n=t.height;this._createOrResizeResources(e,r,n);var a=e.context,s=e.painter,o=i.amount,u=a.gl,h=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,r,n,0,0,h),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(u.COLOR_BUFFER_BIT),s.blitTexture(a,h,R.L.NEAREST,o)}},{key:"_createOrResizeResources",value:function(e,t,i){var r=e.context;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new z.u(r,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.NEAREST,flipped:!1,width:t,height:i}))}}]),e}();function pi(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var _i={colorize:function(){return new hi},blur:function(){return new ui},bloom:function(){return new ai},opacity:function(){return new fi},"drop-shadow":function(){return new di}},mi=function(){function e(){(0,_.Z)(this,e),this._effectMap=new Map}return(0,m.Z)(e,[{key:"dispose",value:function(){this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,i=[],r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=pi(n.type),s=this._effectMap.get(a);s||(s=_i[a](),this._effectMap.set(a,s)),i.push({postProcessingEffect:s,effect:n})}}catch(o){r.e(o)}finally{r.f()}return i}}]),e}(),vi=function(){function e(t,i){var r;(0,_.Z)(this,e),this.brushes=t,this.name=i.name,this.drawPhase=i.drawPhase||x.I.MAP,this._targetFn=i.target,this.effects=i.effects||[],this.enableDefaultDraw=null!==(r=i.enableDefaultDraw)&&void 0!==r?r:function(){return!0}}return(0,m.Z)(e,[{key:"render",value:function(e){var t=e.context,i=e.profiler,r=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,r),i.recordPassEnd();var a,s=(0,d.Z)(this.effects);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(o.enable()){var u=o.apply;i.recordPassStart(this.name+"."+u.name),i.recordBrushStart(u.name);var h=o.args&&o.args(),l=t.getViewport(),c=l.x,f=l.y,p=l.width,_=l.height,m=t.getBoundFramebufferObject();u.bind(e,h);var v=u.createOptions(e,h),g=e.passOptions;e.passOptions=v,this._doRender(e,r,u.defines),e.passOptions=g,u.draw(e,h),u.unbind(e,h),t.bindFramebuffer(m),t.setViewport(c,f,p,_),i.recordBrushEnd(),i.recordPassEnd()}}}catch(y){s.e(y)}finally{s.f()}}}},{key:"_doRender",value:function(e,t,i){if(!(0,v.t)(t))if((0,v.be)(t)){var r,n=(0,d.Z)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(a.visible){var s,o=(0,d.Z)(this.brushes);try{for(o.s();!(s=o.n()).done;){var u=s.value;e.profiler.recordBrushStart(u.name),u.prepareState(e,a,i),u.draw(e,a,i),e.profiler.recordBrushEnd()}}catch(f){o.e(f)}finally{o.f()}}}}catch(f){n.e(f)}finally{n.f()}}else{var h,l=(0,d.Z)(this.brushes);try{for(l.s();!(h=l.n()).done;){var c=h.value;e.profiler.recordBrushStart(c.name),c.prepareState(e,t,i),c.draw(e,t,i),e.profiler.recordBrushEnd()}}catch(f){l.e(f)}finally{l.f()}}}}]),e}();var gi=function(){function e(t,i,r){(0,_.Z)(this,e),this.context=t,this._blitRenderer=new pe,this._worldExtentClipRenderer=new Ot,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._vtlMaterialManager=new k.o,this._blendEffect=new It,this._fboPool=[],this.effects={highlight:new Jt,hittest:new $t,hittestVTL:new ei,integrate:new Ft,insideEffect:new Zt("inside"),outsideEffect:new Zt("outside")},this.materialManager=new be(t),this.textureManager=new Mt(i,r),this._effectsManager=new mi}return(0,m.Z)(e,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getRenderTarget",value:function(){return this._renderTarget}},{key:"setRenderTarget",value:function(e){this._renderTarget=e}},{key:"getFbos",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}var r={target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,samplingMode:R.L.NEAREST,wrapMode:R.D.CLAMP_TO_EDGE,width:e,height:t},n={colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.DEPTH_STENCIL_RENDER_BUFFER},a=new M.r(this.context,{width:e,height:t,internalFormat:R.B.DEPTH_STENCIL});this._stencilBuf=a,this._fbos={output:new M.D(this.context,n,r,a),blend:new M.D(this.context,n,r,a),effect0:new M.D(this.context,n,r,a)}}return this._fbos}},{key:"acquireFbo",value:function(e,t){var i,r=(i=this._fboPool.length>0?this._fboPool.pop():new M.D(this.context,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.DEPTH_STENCIL_RENDER_BUFFER},{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,samplingMode:R.L.NEAREST,wrapMode:R.D.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf)).descriptor;return r.width===e&&r.height===t||i.resize(e,t),i}},{key:"releaseFbo",value:function(e){this._fboPool.push(e)}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderLayers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=e.getViewport(),r=i.width,n=i.height;this._prevFBO=e.getBoundFramebufferObject();var a=this.getFbos(r,n);if(e.bindFramebuffer(a.output),e.setColorMask(!0,!0,!0,!0),(0,v.r)(t)){var s=t.color,o=s.r,u=s.g,h=s.b,l=s.a;e.setClearColor(l*o/255,l*u/255,l*h/255,l)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}},{key:"beforeRenderLayer",value:function(e,t,i){var r=e.context,n=e.blendMode,a=e.effects,s=e.requireFBO,o=e.drawPhase;if(s||yi(o,n,a,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{var u=this._getOutputFBO();r.bindFramebuffer(u)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}},{key:"compositeLayer",value:function(e,t){var i=e.context,r=e.blendMode,n=e.effects,a=e.requireFBO,s=e.drawPhase;if(a||yi(s,r,n,t)){(0,v.r)(n)&&n.length>0&&s===x.I.MAP&&this._applyEffects(e,n);var o=this._getOutputFBO();i.bindFramebuffer(o),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA,R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);var u=(0,v.t)(r)||s===x.I.HIGHLIGHT?"normal":r;this._blendEffect.draw(e,this._fbos.blend.colorTexture,R.L.NEAREST,u,t)}}},{key:"renderLayers",value:function(e){if(e.bindFramebuffer(this._prevFBO),this._fbos){var t=this._getOutputFBO();e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(R.I.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,R.L.NEAREST)}}},{key:"prepareDisplay",value:function(e,t,i){var r=e.context;if(r.bindFramebuffer(this._prevFBO),r.setColorMask(!0,!0,!0,!0),(0,v.r)(t)){var n=t.color,a=n.r,s=n.g,o=n.b,u=n.a;r.setClearColor(u*a/255,u*s/255,u*o/255,u)}else r.setClearColor(0,0,0,0);r.setStencilWriteMask(255),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,i)}},{key:"dispose",value:function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer=(0,v.aQ)(this._blitRenderer),this._worldExtentClipRenderer=(0,v.aQ)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();var t,i=(0,d.Z)(this._fboPool);try{for(i.s();!(t=i.n()).done;){t.value.dispose()}}catch(n){i.e(n)}finally{i.f()}if(this._fboPool.length=0,this.effects)for(var r in this.effects)this.effects[r]&&this.effects[r].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,v.aQ)(this._vtlMaterialManager),this._prevFBO=null}},{key:"getBrush",value:function(e,t){var i=function(e,t){switch(e){case x.c.LINE:return T.W.line;case x.c.TEXT:return T.W.text;case x.c.LABEL:return T.W.label;case x.c.FILL:return t===x.S.DOT_DENSITY?T.W.dotDensity:T.W.fill;case x.c.MARKER:switch(t){case x.S.HEATMAP:return T.W.heatmap;case x.S.PIE_CHART:return T.W.pieChart;default:return T.W.marker}}}(e,t),r=this._brushCache.get(i);return void 0===r&&(r=new i,this._brushCache.set(i,r)),this._brushCache.get(i)}},{key:"renderObject",value:function(e,t,i,r){var n=T.W[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,t,r),a.draw(e,t,r)}},{key:"renderObjects",value:function(e,t,i,r){var n=T.W[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,r)}},{key:"registerRenderPass",value:function(e){var t=this,i=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new vi(i,e)}},{key:"setHighlightOptions",value:function(e){this.effects.highlight.setHighlightOptions(e)}},{key:"blitTexture",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA,R.R.ONE,R.R.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,r)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"_getOutputFBO",value:function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}},{key:"_applyEffects",value:function(e,t){var i,r=e.context,n=this._effectsManager.getPostProcessingEffects(t),a=(0,d.Z)(n);try{for(a.s();!(i=a.n()).done;){var s=i.value,o=s.postProcessingEffect,u=s.effect;r.bindFramebuffer(this._fbos.blend),o.draw(e,this._fbos.blend,u)}}catch(h){a.e(h)}finally{a.f()}}}]),e}();function yi(e,t,i,r){return e!==x.I.HIGHLIGHT&&(1!==r||(0,v.r)(t)&&"normal"!==t||(0,v.r)(i)&&i.length>0)}var bi=(0,v.c)("esri-2d-profiler"),wi=function(){function e(t,i){var r=this;if((0,_.Z)(this,e),this._events=new K.n,this._entries=new Map,this._timings=new Q.s(10),bi){this._ext=(0,J.d)(t.gl,{}),this._debugOutput=i;var n=t.gl;if(this.enableCommandLogging){var a=function(e){if("function"==typeof n[e]){var t=n[e],i=e.includes("draw");n[e]=function(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];return r._events.emit("command",{container:r._currentContainer,pass:r._currentPass,brush:r._currentBrush,method:e,args:s,isDrawCommand:i}),r._currentSummary&&(r._currentSummary.commands++,i&&r._currentSummary.drawCommands++),t.apply(n,s)}}};for(var s in n)a(s)}}}return(0,m.Z)(e,[{key:"enableCommandLogging",get:function(){return!("object"==typeof bi&&bi.disableCommands)}},{key:"recordContainerStart",value:function(e){bi&&(this._currentContainer=e)}},{key:"recordContainerEnd",value:function(){bi&&(this._currentContainer=null)}},{key:"recordPassStart",value:function(e){bi&&(this._currentPass=e,this._initSummary())}},{key:"recordPassEnd",value:function(){bi&&(this._currentPass=null,this._emitSummary())}},{key:"recordBrushStart",value:function(e){bi&&(this._currentBrush=e)}},{key:"recordBrushEnd",value:function(){bi&&(this._currentBrush=null)}},{key:"recordStart",value:function(e){if(bi&&(0,v.r)(this._ext)){if(this._entries.has(e)){var t=this._entries.get(e),i=this._ext.resultAvailable(t.query),r=this._ext.disjoint();if(i&&!r){var n=this._ext.getResult(t.query)/1e6,a=0;if((0,v.r)(this._timings.enqueue(n))){var s,o=this._timings.entries,u=o.length,h=0,l=(0,d.Z)(o);try{for(l.s();!(s=l.n()).done;){h+=s.value}}catch(g){l.e(g)}finally{l.f()}a=h/u}var c=n.toFixed(2),f=a?a.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed("Frame report for ".concat(e,", ").concat(c," ms (").concat(f," last 10 avg)\n").concat(t.commandsLen," Commands (").concat(t.drawCommands," draw)")),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log("Frame report for ".concat(e,", ").concat(c," ms (").concat(f," last 10 avg)")),this._debugOutput.innerHTML="".concat(c," (").concat(f,")")}var p,_=(0,d.Z)(t.handles);try{for(_.s();!(p=_.n()).done;){p.value.remove()}}catch(g){_.e(g)}finally{_.f()}this._entries.delete(e)}var m={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(m.handles.push(this._events.on("command",(function(e){m.commandsLen++,m.commands.push(e),e.isDrawCommand&&m.drawCommands++}))),m.handles.push(this._events.on("summary",(function(e){m.summaries.push(e)})))),this._ext.beginTimeElapsed(m.query),this._entries.set(e,m)}}},{key:"recordEnd",value:function(e){bi&&(0,v.r)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}},{key:"_initSummary",value:function(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}},{key:"_emitSummary",value:function(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}]),e}(),xi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e,r){var a;(0,_.Z)(this,i),(a=t.call(this))._trash=new Set,a._renderRemainingTime=0,a._lastFrameRenderTime=0,a.renderRequested=!1,a.stage=(0,n.Z)(a),a._stationary=!0;var s=r.canvas,o=void 0===s?document.createElement("canvas"):s,u=r.alpha,h=void 0===u||u,l=r.stencil,c=void 0===l||l,d=r.contextOptions,f=void 0===d?{}:d;a._canvas=o;var p=(0,te.n)("2d",o,{alpha:h,antialias:!1,depth:!0,stencil:c});return a.context=new J.y((0,v.r)(p)?p:null,f),a.resourceManager=new b.s,a.painter=new gi(a.context,(0,n.Z)(a),a.resourceManager),(0,v.c)("esri-2d-profiler")&&(a._debugOutput=document.createElement("div"),a._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(a._debugOutput)),a._renderParameters={drawPhase:0,state:a.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:a.context,painter:a.painter,timeline:r.timeline||new $.e,renderingOptions:r.renderingOptions,requestRender:function(){return a.requestRender()},requireFBO:!1,profiler:new wi(a.context,a._debugOutput),dataUploadCounter:0},a._taskHandle=(0,v.aB)({render:function(e){return a.renderFrame(e)}}),a._taskHandle.pause(),a._lostWebGLContextHandle=(0,v.l)(o,"webglcontextlost",(function(){a.emit("webgl-error",{error:new v.a("webgl-context-lost")})})),o.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(o),a}return(0,m.Z)(i,[{key:"destroy",value:function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){var t=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,g.l)((function(){var e;return null===(e=t._highlightOptions)||void 0===e?void 0:e.version}),(function(){t.painter.setHighlightOptions(e),t.requestRender()}),g.h))}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}},{key:"renderFrame",value:function(e){var t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}},{key:"_createTransforms",value:function(){return{dvs:(0,y.M)()}}},{key:"renderChildren",value:function(e){var t,i=(0,d.Z)(this.children);try{for(i.s();!(t=i.n()).done;){t.value.beforeRender(e)}}catch(a){i.e(a)}finally{i.f()}this._renderChildren(this.children,e);var r,n=(0,d.Z)(this.children);try{for(n.s();!(r=n.n()).done;){r.value.afterRender(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_renderChildren",value:function(e,t){var i=this.context;i.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=x.I.MAP,this.painter.beforeRenderLayers(i,this.background);var r,n=(0,d.Z)(e);try{for(n.s();!(r=n.n()).done;){r.value.processRender(t)}}catch(c){n.e(c)}finally{n.f()}this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(i),t.drawPhase=x.I.HIGHLIGHT,this.painter.beforeRenderLayers(i);var a,s=(0,d.Z)(e);try{for(s.s();!(a=s.n()).done;){a.value.processRender(t)}}catch(c){s.e(c)}finally{s.f()}if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=x.I.LABEL,this.painter.beforeRenderLayers(i);var o,u=(0,d.Z)(e);try{for(u.s();!(o=u.n()).done;){o.value.processRender(t)}}catch(c){u.e(c)}finally{u.f()}this.painter.renderLayers(i)}if((0,v.c)("esri-tiles-debug")){t.drawPhase=x.I.DEBUG,this.painter.beforeRenderLayers(i);var h,l=(0,d.Z)(e);try{for(l.s();!(h=l.n()).done;){h.value.processRender(t)}}catch(c){l.e(c)}finally{l.f()}this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),i.logInfo()}},{key:"doRender",value:function(e){var t=this.context,r=e.state,n=e.pixelRatio;this._resizeCanvas(e),t.setViewport(0,0,n*r.size[0],n*r.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),(0,a.Z)((0,s.Z)(i.prototype),"doRender",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h,c,d,f,_,m;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={framebufferWidth:Math.round(this.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*t.resolutionScale)},r=i.framebufferWidth,n=i.framebufferHeight,1,a=this.context,s=this._state.clone(),null!=t.rotation&&(o=s.viewpoint,s.viewpoint.rotation=t.rotation,s.viewpoint=o),u=(0,p.Z)((0,p.Z)({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:s,pixelRatio:1,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),h=new M.D(a,{colorTarget:R.Y.TEXTURE,depthStencilTarget:R.V.DEPTH_STENCIL_RENDER_BUFFER,width:r,height:n}),c=a.getBoundFramebufferObject(),d=a.getViewport(),a.bindFramebuffer(h),a.setViewport(0,0,r,n),this._renderChildren(t.children,u),f=this._readbackScreenshot(h,(0,p.Z)((0,p.Z)({},t.cropArea),{},{y:n-(t.cropArea.y+t.cropArea.height)})),a.bindFramebuffer(c),a.setViewport(d.x,d.y,d.width,d.height),this.requestRender(),e.next=8,f;case 8:return _=e.sent,e.abrupt("return",(1===t.outputScale?m=_:(m=new ImageData(Math.round(_.width*t.outputScale),Math.round(_.height*t.outputScale)),(0,ee.p)(_,m,!0)),m));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_readbackScreenshot",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,i){var r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,ee.m)(i.width,i.height,document.createElement("canvas")),e.next=3,t.readPixelsAsync(i.x,i.y,i.width,i.height,R.P.RGBA,R.G.UNSIGNED_BYTE,new Uint8Array(r.data.buffer));case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_resizeCanvas",value:function(e){var t=this._canvas,i=t.style,r=e.state.size,n=e.pixelRatio,a=r[0],s=r[1],o=Math.round(a*n),u=Math.round(s*n);t.width===o&&t.height===u||(t.width=o,t.height=u),i.width=a+"px",i.height=s+"px"}},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,i=e;t<i.length;t++){i[t].processDetach()}}}},{key:"_isLabelDrawPhaseRequired",value:function(e){var t,i=!1,r=(0,d.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(!(n instanceof w.s)){i=i||!1;break}if(n.hasLabels)return!0;i=i||this._isLabelDrawPhaseRequired(n.children)}}catch(a){r.e(a)}finally{r.f()}return i}}]),i}(w.s),Ti=function(){function e(t,i){(0,_.Z)(this,e),this.width=t,this.height=i;var r=Math.ceil(t/1),n=Math.ceil(i/1);this._cols=r,this._rows=n,this._cells=ne.t.create(r*n)}return(0,m.Z)(e,[{key:"insertMetrics",value:function(e){var t=this._hasCollision(e);return 0===t&&this._markMetrics(e),t}},{key:"getCellId",value:function(e,t){return e+t*this._cols}},{key:"has",value:function(e){return this._cells.has(e)}},{key:"hasRange",value:function(e,t){return this._cells.hasRange(e,t)}},{key:"set",value:function(e){this._cells.set(e)}},{key:"setRange",value:function(e,t){this._cells.setRange(e,t)}},{key:"_hasCollision",value:function(e){var t=e.id,i=0,r=0;e.save();do{var n=e.boundsCount;i+=n;for(var a=0;a<n;a++){var s=e.boundsComputedAnchorX(a),o=e.boundsComputedAnchorY(a),u=e.boundsWidth(a)+2,h=e.boundsHeight(a)+2;switch(this._collide(s,o,u,h)){case 2:return 2;case 1:r++}}}while(e.peekId()===t&&e.next());return e.restore(),i===r?1:0}},{key:"_collide",value:function(e,t,i,r){var n=e-i/2,a=t-r/2,s=n+i,o=a+r;if(s<0||o<0||n>this.width||a>this.height)return 1;for(var u=(0,V.o)(Math.floor(n/1),0,this._cols),h=(0,V.o)(Math.floor(a/1),0,this._rows),l=(0,V.o)(Math.ceil(s/1),0,this._cols),c=(0,V.o)(Math.ceil(o/1),0,this._rows),d=h;d<=c;d++)for(var f=u;f<=l;f++){var p=this.getCellId(f,d);if(this.has(p))return 2}return 0}},{key:"_mark",value:function(e,t,i,r){for(var n=e-i/2,a=t-r/2,s=n+i,o=a+r,u=(0,V.o)(Math.floor(n/1),0,this._cols),h=(0,V.o)(Math.floor(a/1),0,this._rows),l=(0,V.o)(Math.ceil(s/1),0,this._cols),c=(0,V.o)(Math.ceil(o/1),0,this._rows),d=h;d<=c;d++)for(var f=u;f<=l;f++){var p=this.getCellId(f,d);this.set(p)}return!1}},{key:"_markMetrics",value:function(e){var t=e.id;do{for(var i=e.boundsCount,r=0;r<i;r++){var n=e.boundsComputedAnchorX(r),a=e.boundsComputedAnchorY(r),s=e.boundsWidth(r)+2,o=e.boundsHeight(r)+2;this._mark(n,a,s,o)}}while(e.peekId()===t&&e.next())}}]),e}(),ki=Math.PI;function Ei(e,t){switch(t.transformationType){case se.i.Additive:return function(e,t){return e+(Mi(t.minSize,e)||t.minDataValue)}(e,t);case se.i.Constant:return function(e,t){var i=e.stops,r=i&&i.length&&i[0].size;return null==r&&(r=e.minSize),Mi(r,t)}(t,e);case se.i.ClampedLinear:return function(e,t){var i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),r=Mi(t.minSize,e),n=Mi(t.maxSize,e);return e<=t.minDataValue?r:e>=t.maxDataValue?n:r+i*(n-r)}(e,t);case se.i.Proportional:return function(e,t){var i=e/t.minDataValue,r=Mi(t.minSize,e),n=Mi(t.maxSize,e),a=null;return a=i*r,(0,V.o)(a,r,n)}(e,t);case se.i.Stops:return function(e,t){var i=function(e,t){if(!t)return;var i=0,r=t.length-1;return t.some((function(t,n){return e<t?(r=n,!0):(i=n,!1)})),[i,r,(e-t[i])/(t[r]-t[i])]}(e,t.cache.ipData),r=(0,h.Z)(i,3),n=r[0],a=r[1],s=r[2];if(n===a)return Mi(t.stops[n].size,e);var o=Mi(t.stops[n].size,e);return o+(Mi(t.stops[a].size,e)-o)*s}(e,t);case se.i.RealWorldSize:return function(e,t){var i=ae.a[t.valueUnit],r=Mi(t.minSize,e),n=Mi(t.maxSize,e),a=t.valueRepresentation,s=null;return s="area"===a?2*Math.sqrt(e/ki)/i:"radius"===a||"distance"===a?2*e/i:e/i,(0,V.o)(s,r,n)}(e,t);case se.i.Identity:return e;case se.i.Unknown:return null}}function Mi(e,t){return"number"==typeof e?e:Ei(t,e)}var Ri=255;function Bi(e,t){var i=[];e.forEachTile((function(e){return i.push(e)})),i.sort((function(e,t){return e.instanceId-t.instanceId})),i.forEach((function(e){(0,v.r)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}function Oi(e){return function(t){return(0,F.u)(Ei(t,e))}}function Si(e,t){if(function(e){return e.layer&&("feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type)}(t)){var i="subtype-group"===t.layer.type?t.layer.sublayers.items:[t.layer],n=t.layer.geometryType,a=!function(e){var t,i=(0,d.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,a="featureReduction"in n&&n.featureReduction&&"labelingInfo"in n.featureReduction&&n.featureReduction,s=[].concat((0,r.Z)(n.labelingInfo||[]),(0,r.Z)((null===a||void 0===a?void 0:a.labelingInfo)||[]));if(n.labelsVisible&&s.length&&s.some((function(e){return"none"===e.deconflictionStrategy})))return!0}}catch(o){i.e(o)}finally{i.f()}return!1}(i),s={};if("subtype-group"!==t.layer.type){var o;if("heatmap"===(null===(o=t.tileRenderer)||void 0===o?void 0:o.type))return;var u=function(e){var t="visualVariables"in e&&e.visualVariables;if(!t)return null;var i,r=(0,d.Z)(t);try{for(r.s();!(i=r.n()).done;){var n=i.value;if("size"===n.type)return Oi(n)}}catch(a){r.e(a)}finally{r.f()}return null}(t.layer.renderer);s[0]=u}var h=t.tileRenderer;if(!(0,v.t)(h)){var l=t.layer.visible&&!t.suspended;e.push({tileRenderer:h,vvEvaluators:s,deconflictionEnabled:a,geometryType:n,visible:l})}}}var Fi=function(){function e(){(0,_.Z)(this,e)}return(0,m.Z)(e,[{key:"run",value:function(e,t,i){for(var r=[],n=e.length-1;n>=0;n--)Si(r,e[n]);this._transformMetrics(r,t),this._runCollision(r,t,i)}},{key:"_runCollision",value:function(e,t,i){var r,n=this,a=(0,h.Z)(t.state.size,2),s=a[0],o=a[1],u=new Ti(s*t.pixelRatio,o*t.pixelRatio),l=(0,d.Z)(e);try{var c=function(){var e=r.value,t=e.tileRenderer,a=e.deconflictionEnabled,s=e.visible,o=t.featuresView.attributeView;a?s?(n._prepare(t),n._collideVisible(u,t,i),n._collideInvisible(u,t)):Bi(t,(function(e,t){for(;t.nextId();)o.setLabelMinZoom(t.id,Ri)})):Bi(t,(function(e,t){for(;t.nextId();)o.setLabelMinZoom(t.id,0)}))};for(l.s();!(r=l.n()).done;)c()}catch(f){l.e(f)}finally{l.f()}}},{key:"_isFiltered",value:function(e,t,i){var r=t.getFilterFlags(e),n=!i.hasFilter||!!(r&I.U),a=(0,v.t)(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(r&I.V);return!(n&&a)}},{key:"_prepare",value:function(e){var t=this,i=e.featuresView.attributeView,r=new Set;Bi(e,(function(n,a){for(;a.nextId();)r.has(a.id)||(r.add(a.id),t._isFiltered(a.id,i,e.layerView)?i.setLabelMinZoom(a.id,254):0!==i.getLabelMinZoom(a.id)?i.setLabelMinZoom(a.id,Ri):i.setLabelMinZoom(a.id,0))}))}},{key:"_collideVisible",value:function(e,t,i){var r=t.featuresView.attributeView,n=new Set;Bi(t,(function(t,a){for(;a.nextId();)if(!n.has(a.id))if(t.key.level===i){if(0===r.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case 1:break;case 2:r.setLabelMinZoom(a.id,254),n.add(a.id);break;case 0:r.setLabelMinZoom(a.id,0),n.add(a.id)}}else r.setLabelMinZoom(a.id,254)}))}},{key:"_collideInvisible",value:function(e,t){var i=t.featuresView.attributeView,r=new Set;Bi(t,(function(t,n){for(;n.nextId();)if(!r.has(n.id)&&i.getLabelMinZoom(n.id)===Ri)switch(e.insertMetrics(n)){case 1:break;case 2:i.setLabelMinZoom(n.id,Ri),r.add(n.id);break;case 0:i.setLabelMinZoom(n.id,0),r.add(n.id)}}))}},{key:"_transformMetrics",value:function(e,t){var i,r=(0,d.Z)(e);try{var n=function(){var e=i.value,r=e.tileRenderer,n=e.geometryType,a=e.vvEvaluators;Bi(r,(function(e,i){var s=r.featuresView.attributeView,o=e.transforms.labelMat2d;o[4]=Math.round(o[4]),o[5]=Math.round(o[5]);for(var u=o[4],h=o[5],l="polyline"===n;i.next();){var c=i.boundsCount,d=i.anchorX,f=i.anchorY,p=i.size,_=a[0];if((0,v.r)(_)){var m=_(s.getVVSize(i.id));p=isNaN(m)||null==m||m===1/0?p:m}for(var g=i.directionX*(p/2),y=i.directionY*(p/2),b=0;b<c;b++){var w=d,x=i.anchorY;if(l){var T=w+i.boundsX(b)+g,k=x+i.boundsY(b)+y;t.state.rotation?(T=o[0]*T+o[2]*k+o[4],k=o[1]*T+o[3]*k+o[5]):(T+=u,k+=h),i.setBoundsComputedAnchorX(b,Math.floor(T)),i.setBoundsComputedAnchorY(b,Math.floor(k))}else{t.state.rotation?(w=o[0]*d+o[2]*f+o[4],x=o[1]*d+o[3]*f+o[5]):(w+=u,x+=h);var E=w+i.boundsX(b)+g,M=x+i.boundsY(b)+y;i.setBoundsComputedAnchorX(b,E),i.setBoundsComputedAnchorY(b,M)}}}}))};for(r.s();!(i=r.n()).done;)n()}catch(a){r.e(a)}finally{r.f()}}}]),e}();v.s.getLogger("esri.views.2d.layers.labels.LabelManager");var Pi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e))._applyVisibilityPassThrottled=(0,re.e)(r._applyVisibilityPass,32,(0,n.Z)(r)),r.lastUpdateId=-1,r.updateRequested=!1,r.view=null,r}return(0,m.Z)(i,[{key:"initialize",value:function(){this.collisionEngine=new Fi}},{key:"destroy",value:function(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}},{key:"updating",get:function(){return this.updateRequested}},{key:"update",value:function(e){this._applyVisibilityPassThrottled(e)}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"requestUpdate",value:function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}},{key:"processUpdate",value:function(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}},{key:"_applyVisibilityPass",value:function(e){try{var t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,e,t)}catch(i){}}}]),i}((0,ie.a)(v.y));(0,v.e)([(0,v.d)()],Pi.prototype,"updateRequested",void 0),(0,v.e)([(0,v.d)({readOnly:!0})],Pi.prototype,"updateParameters",void 0),(0,v.e)([(0,v.d)()],Pi.prototype,"updating",null),(0,v.e)([(0,v.d)()],Pi.prototype,"view",void 0);var Ci=Pi=(0,v.e)([(0,v.n)("esri.views.2d.layers.labels.LabelManager")],Pi),Ai="esri-zoom-box__container",Ii="esri-zoom-box__overlay",Zi="esri-zoom-box__overlay-background",Di="esri-zoom-box__outline",zi="Shift",Ui="Ctrl",Li=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e))._container=null,r._overlay=null,r._backgroundShape=null,r._boxShape=null,r._box={x:0,y:0,width:0,height:0},r._redraw=r._redraw.bind((0,n.Z)(r)),r}return(0,m.Z)(i,[{key:"destroy",value:function(){this.view=null}},{key:"view",set:function(e){var t=this;this._handles&&this._handles.forEach((function(e){e.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",[zi],(function(e){return t._handleDrag(e,1)}),y.m.INTERNAL),e.on("drag",[zi,Ui],(function(e){return t._handleDrag(e,-1)}),y.m.INTERNAL))}},{key:"_start",value:function(){this._createContainer(),this._createOverlay(),this.navigation.begin()}},{key:"_update",value:function(e,t,i,r){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=r,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}},{key:"_end",value:function(e,t,i,r,n){var a=this.view,s=a.toMap((0,F.c)(e+.5*i,t+.5*r)),o=Math.max(i/a.width,r/a.height);-1===n&&(o=1/o),this._destroyOverlay(),this.navigation.end(),a.goTo({center:s,scale:a.scale*o})}},{key:"_updateBox",value:function(e,t,i,r){var n=this._boxShape;n.setAttributeNS(null,"x",""+e),n.setAttributeNS(null,"y",""+t),n.setAttributeNS(null,"width",""+i),n.setAttributeNS(null,"height",""+r),n.setAttributeNS(null,"class",Di)}},{key:"_updateBackground",value:function(e,t,i,r){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,r,this.view.width,this.view.height))}},{key:"_createContainer",value:function(){var e=document.createElement("div");e.className=Ai,this.view.root.appendChild(e),this._container=e}},{key:"_createOverlay",value:function(){var e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class",Zi);var r=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class",Ii),n.appendChild(i),n.appendChild(r),this._container.appendChild(n),this._backgroundShape=i,this._boxShape=r,this._overlay=n}},{key:"_destroyOverlay",value:function(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}},{key:"_toSVGPath",value:function(e,t,i,r,n,a){var s=e+i,o=t+r;return"M 0 0 L "+n+" 0 L "+n+" "+a+" L 0 "+a+" ZM "+e+" "+t+" L "+e+" "+o+" L "+s+" "+o+" L "+s+" "+t+" Z"}},{key:"_handleDrag",value:function(e,t){var i,r,n,a,s=e.x,o=e.y,u=e.origin.x,h=e.origin.y;switch(s>u?(i=u,n=s-u):(i=s,n=u-s),o>h?(r=h,a=o-h):(r=o,a=h-o),e.action){case"start":this._start();break;case"update":this._update(i,r,n,a);break;case"end":this._end(i,r,n,a,t)}e.stopPropagation()}},{key:"_redraw",value:function(){if(this._rafId&&(this._rafId=null,this._overlay)){var e=this._box,t=e.x,i=e.y,r=e.width,n=e.height;this._updateBox(t,i,r,n),this._updateBackground(t,i,r,n),this._rafId=requestAnimationFrame(this._redraw)}}}]),i}(v.y);(0,v.e)([(0,v.d)()],Li.prototype,"navigation",void 0),(0,v.e)([(0,v.d)()],Li.prototype,"view",null);var Ni=Li=(0,v.e)([(0,v.n)("esri.views.2d.navigation.ZoomBox")],Li),Gi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e)).animationTime=0,r.momentumEstimator=new J.h(500,6,.92),r.momentum=null,r.tmpMomentum=(0,V.n)(),r.momentumFinished=!1,r.viewpoint=new he.u({targetGeometry:new le.j,scale:0,rotation:0}),(0,g.f)((function(){return r.momentumFinished}),(function(){return r.navigation.stop()})),r}return(0,m.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}},{key:"update",value:function(e,t){this.addToEstimator(t);var i=t.center.x,r=t.center.y,n=this.previousDrag;i=n?n.center.x-i:-i,r=n?r-n.center.y:r,e.viewpoint=(0,y.S)(this.viewpoint,e.viewpoint,[i||0,r||0]),this.previousDrag=t}},{key:"end",value:function(e,t){this.addToEstimator(t);var i=e.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this.previousDrag=null,this.navigation.end()}},{key:"addToEstimator",value:function(e){var t=e.center.x,i=e.center.y,r=(0,F.i)(-t,i),n=(0,V.r)(-t,i,0);this.momentumEstimator.add(r,n,.001*e.timestamp)}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){t.momentumFinished=!t.momentum||t.momentum.isFinished(t.animationTime);var n=.001*r;if(!t.momentumFinished){var a=t.momentum.valueDelta(t.animationTime,n);(0,V.q)(t.tmpMomentum,t.momentum.direction,a),(0,y.S)(i,i,t.tmpMomentum),e.constraints.constrainByGeometry(i)}t.animationTime+=n}))}},{key:"stopMomentumNavigation",value:function(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}}]),i}(v.y);(0,v.e)([(0,v.d)()],Gi.prototype,"momentumFinished",void 0),(0,v.e)([(0,v.d)()],Gi.prototype,"viewpoint",void 0),(0,v.e)([(0,v.d)()],Gi.prototype,"navigation",void 0);var Hi=Gi=(0,v.e)([(0,v.n)("esri.views.2d.navigation.actions.Pan")],Gi),Wi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e))._animationTime=0,r._momentumFinished=!1,r._rotationMomentumEstimator=new J.b(.6,.15,.95),r._rotationDirection=1,r._zoomDirection=1,r._zoomMomentumEstimator=new J.s,r._zoomOnly=null,r.zoomMomentum=null,r.rotateMomentum=null,r.viewpoint=new he.u({targetGeometry:new le.j,scale:0,rotation:0}),r.own((0,g.f)((function(){return r._momentumFinished}),(function(){return r.navigation.stop()}))),r}return(0,m.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}},{key:"update",value:function(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);var i=t.angle,r=t.radius,n=t.center,a=Math.abs(180*(i-this._startAngle)/Math.PI),s=Math.abs(r-this._startRadius),o=this._startRadius/r;if(this._previousRadius){var u=r/this._previousRadius,h=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=h>=0?1:-1,this._zoomDirection=u>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=s-a>0),null===this._zoomOnly||this._zoomOnly?h=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):h=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([n.x,n.y],1/u,h,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=r,this._previousCenter=n}},{key:"end",value:function(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}},{key:"addToRotateEstimator",value:function(e,t){this._rotationMomentumEstimator.add(e,.001*t)}},{key:"addToZoomEstimator",value:function(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}},{key:"canZoomIn",value:function(e){var t=e.scale,i=e.constraints.effectiveMaxScale;return 0===i||t>i}},{key:"canZoomOut",value:function(e){var t=e.scale,i=e.constraints.effectiveMinScale;return 0===i||t<i}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){var n=!t.canZoomIn(e)&&t._zoomDirection>1||!t.canZoomOut(e)&&t._zoomDirection<1,a=!t.rotateMomentum||t.rotateMomentum.isFinished(t._animationTime),s=n||!t.zoomMomentum||t.zoomMomentum.isFinished(t._animationTime),o=.001*r;if(t._momentumFinished=a&&s,!t._momentumFinished){var u=t.rotateMomentum?Math.abs(t.rotateMomentum.valueDelta(t._animationTime,o))*t._rotationDirection*180/Math.PI:0,h=t.zoomMomentum?Math.abs(t.zoomMomentum.valueDelta(t._animationTime,o)):1,l=(0,Y.n)(),c=(0,Y.n)();if(t._previousCenter){(0,P.r)(l,t._previousCenter.x,t._previousCenter.y),(0,y.O)(c,e.size,e.padding),(0,P.s)(l,l,c);var d=e.constraints,f=e.scale,p=f*h;h<1&&!d.canZoomInTo(p)?(h=f/d.effectiveMaxScale,t.zoomMomentum=null,t.rotateMomentum=null):h>1&&!d.canZoomOutTo(p)&&(h=f/d.effectiveMinScale,t.zoomMomentum=null,t.rotateMomentum=null),(0,y.G)(i,e.viewpoint,h,u,l,e.size),e.constraints.constrainByGeometry(i)}}t._animationTime+=o}))}},{key:"stopMomentumNavigation",value:function(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}}]),i}(v.y);(0,v.e)([(0,v.d)()],Wi.prototype,"_momentumFinished",void 0),(0,v.e)([(0,v.d)()],Wi.prototype,"viewpoint",void 0),(0,v.e)([(0,v.d)()],Wi.prototype,"navigation",void 0);var qi=Wi=(0,v.e)([(0,v.n)("esri.views.2d.navigation.actions.Pinch")],Wi),Vi=(0,Y.n)(),ji=(0,Y.n)(),Yi=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e))._previousCenter=(0,Y.n)(),r.viewpoint=new he.u({targetGeometry:new le.j,scale:0,rotation:0}),r}return(0,m.Z)(i,[{key:"begin",value:function(e,t){this.navigation.begin(),(0,P.r)(this._previousCenter,t.center.x,t.center.y)}},{key:"update",value:function(e,t){var i=e.state,r=i.size,n=i.padding;(0,P.r)(Vi,t.center.x,t.center.y),(0,y.$)(ji,r,n),e.viewpoint=(0,y.P)(this.viewpoint,e.state.paddedViewState.viewpoint,(0,y.D)(ji,this._previousCenter,Vi)),(0,P.a)(this._previousCenter,Vi)}},{key:"end",value:function(){this.navigation.end()}}]),i}(v.y);(0,v.e)([(0,v.d)()],Yi.prototype,"viewpoint",void 0),(0,v.e)([(0,v.d)()],Yi.prototype,"navigation",void 0);var Xi=Yi=(0,v.e)([(0,v.n)("esri.views.2d.actions.Rotate")],Yi),Qi=new he.u({targetGeometry:new le.j}),Ki=[0,0],Ji=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(e){var r;return(0,_.Z)(this,i),(r=t.call(this,e))._endTimer=null,r.animationManager=null,r}return(0,m.Z)(i,[{key:"initialize",value:function(){this.pan=new Hi({navigation:this}),this.rotate=new Xi({navigation:this}),this.pinch=new qi({navigation:this}),this.zoomBox=new Ni({view:this.view,navigation:this})}},{key:"destroy",value:function(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}},{key:"begin",value:function(){this._set("interacting",!0)}},{key:"end",value:function(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}},{key:"zoom",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.length>1&&void 0!==r[1]?r[1]:this._getDefaultAnchor(),this.stop(),this.begin(),!this.view.constraints.snapToZoom||!this.view.constraints.effectiveLODs){e.next=3;break}return e.abrupt("return",t<1?this.zoomIn(i):this.zoomOut(i));case 3:this.setViewpoint(i,t,0,[0,0]);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"zoomIn",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToNextScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"zoomOut",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToPreviousScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setViewpoint",value:function(e,t,i,r){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,r),this.end()}},{key:"setViewpointImmediate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this._getDefaultAnchor();this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,e,t,i)}},{key:"continousRotateClockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){(0,y.P)(e,e,-1)}))}},{key:"continousRotateCounterclockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){(0,y.P)(e,e,1)}))}},{key:"resetRotation",value:function(){this.view.rotation=0}},{key:"continousPanLeft",value:function(){this._continuousPan([-10,0])}},{key:"continousPanRight",value:function(){this._continuousPan([10,0])}},{key:"continousPanUp",value:function(){this._continuousPan([0,10])}},{key:"continousPanDown",value:function(){this._continuousPan([0,-10])}},{key:"stop",value:function(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}},{key:"_continuousPan",value:function(e){var t=this,i=this.view.viewpoint;this.animationManager.animateContinous(i,(function(i){(0,y.S)(i,i,e),t.view.constraints.constrainByGeometry(i)}))}},{key:"_startTimer",value:function(e){var t=this;return null!==this._endTimer||(this._endTimer=setTimeout((function(){t._endTimer=null;var e=performance.now()-t._lastEventTimestamp;e<250?t._endTimer=t._startTimer(e):t._set("interacting",!1)}),e)),this._endTimer}},{key:"_getDefaultAnchor",value:function(){var e=this.view,t=e.size,i=e.padding,r=i.left,n=i.right,a=i.top,s=i.bottom;return Ki[0]=.5*(t[0]-n+r),Ki[1]=.5*(t[1]-s+a),Ki}},{key:"_zoomToScale",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h,c,d=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=d.length>1&&void 0!==d[1]?d[1]:this._getDefaultAnchor(),r=this.view,n=r.constraints,a=r.scale,s=r.viewpoint,o=r.size,u=r.padding,h=n.canZoomInTo(t),c=n.canZoomOutTo(t),t<a&&!h||t>a&&!c){e.next=4;break}return e.abrupt("return",((0,y.R)(Qi,s,t/a,0,i,o,u),n.constrainByGeometry(Qi),r.goTo(Qi,{animate:!0})));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_scaleRotateTranslateViewpoint",value:function(e,t,i,r,n){var a=this.view,s=a.size,o=a.padding,u=a.constraints,h=a.scale,l=a.viewpoint,c=h*i,d=u.canZoomInTo(c),f=u.canZoomOutTo(c);return(i<1&&!d||i>1&&!f)&&(i=1),(0,y.S)(l,l,n),(0,y.R)(e,l,i,r,t,s,o),u.constrainByGeometry(e)}}]),i}(v.y);(0,v.e)([(0,v.d)()],Ji.prototype,"animationManager",void 0),(0,v.e)([(0,v.d)({type:Boolean,readOnly:!0})],Ji.prototype,"interacting",void 0),(0,v.e)([(0,v.d)()],Ji.prototype,"pan",void 0),(0,v.e)([(0,v.d)()],Ji.prototype,"pinch",void 0),(0,v.e)([(0,v.d)()],Ji.prototype,"rotate",void 0),(0,v.e)([(0,v.d)()],Ji.prototype,"view",void 0),(0,v.e)([(0,v.d)()],Ji.prototype,"zoomBox",void 0);var $i=Ji=(0,v.e)([(0,v.n)("esri.views.2d.navigation.MapViewNavigation")],Ji),er={shaders:{vertexShader:(0,T.n)("magnifier/magnifier.vert"),fragmentShader:(0,T.n)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var tr=function(e){(0,o.Z)(i,e);var t=(0,u.Z)(i);function i(){var e;return(0,_.Z)(this,i),(e=t.call(this))._handles=new ce.u,e._resourcePixelRatio=1,e.visible=!1,e}return(0,m.Z)(i,[{key:"destroy",value:function(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,g.l)((function(){return e.version}),(function(){t.visible=e.visible&&(0,v.r)(e.position)&&e.size>0,t.requestRender()}),g.h),(0,g.l)((function(){return[e.maskUrl,e.overlayUrl]}),(function(){return t._reloadResources()})),(0,g.l)((function(){return e.size}),(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"_createTransforms",value:function(){return{dvs:(0,y.M)()}}},{key:"doRender",value:function(e){var t,i=e.context;if(this._resourcesTask){if(e.drawPhase===x.I.MAP&&this._canRender()){this._updateResources(e);var r=this._magnifier;if(!(0,v.t)(r.position)){var n=e.pixelRatio,a=r.size*n,s=1/r.factor,o=Math.ceil(s*a);this._readbackTexture.resize(o,o);var u=e.state.size,h=n*u[0],l=n*u[1],c=.5*o,d=.5*o,f=(0,V.o)(n*r.position.x,c,h-c-1),p=(0,V.o)(l-n*r.position.y,d,l-d-1);i.setBlendingEnabled(!0);var _=f-c,m=p-d,g=this._readbackTexture;i.bindTexture(g,0),i.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,_,m,o,o,0);var y=null===(t=this.background)||void 0===t?void 0:t.color,b=y?[y.a*y.r/255,y.a*y.g/255,y.a*y.b/255,y.a]:[1,1,1,1],w=(f+r.offset.x*n)/h*2-1,T=(p-r.offset.y*n)/l*2-1,k=a/h*2,E=a/l*2,M=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(M),M.setUniform4fv("u_background",b),M.setUniform1i("u_readbackTexture",0),M.setUniform1i("u_overlayTexture",6),M.setUniform1i("u_maskTexture",7),M.setUniform4f("u_drawPos",w,T,k,E),M.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),M.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(R.E.TRIANGLE_STRIP,0,4),i.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=(0,v.r)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,v.r)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,v.aK)(function(){var r=(0,c.Z)((0,l.Z)().mark((function r(n){var a,s,o,u,c,d,f;return(0,l.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=(0,v.t)(t)||(0,v.t)(i)?(0,J.c)(n):null,s=(0,v.r)(t)?(0,S.U)(t,{responseType:"image",signal:n}).then((function(e){return e.data})):a.then((function(e){return e.mask})),o=(0,v.r)(i)?(0,S.U)(i,{responseType:"image",signal:n}).then((function(e){return e.data})):a.then((function(e){return e.overlay})),r.next=5,Promise.all([s,o]);case 5:u=r.sent,c=(0,h.Z)(u,2),d=c[0],f=c[1],e.mask=d,e.overlay=f,e._disposeRenderResources(),e.requestRender();case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=(0,v.aQ)(this._readbackTexture),this._overlayTexture=(0,v.aQ)(this._overlayTexture),this._maskTexture=(0,v.aQ)(this._maskTexture),this._vertexArrayObject=(0,v.aQ)(this._vertexArrayObject),this._program=(0,v.aQ)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(e){return(0,B.a)(e,er)}(t);var r=new Uint16Array([0,1,0,0,1,1,1,0]),n=er.attributes;this._vertexArrayObject=new M.f(t,n,E.m,{geometry:M.c.createVertex(t,R.F.STATIC_DRAW,r)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new z.u(t,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.NEAREST,flipped:!0,preMultiplyAlpha:!(0,S.I)(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new z.u(t,{target:R.M.TEXTURE_2D,pixelFormat:R.P.ALPHA,internalFormat:R.P.ALPHA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.NEAREST,flipped:!0},this.mask);var a=1/this._magnifier.factor;this._readbackTexture=new z.u(t,{target:R.M.TEXTURE_2D,pixelFormat:R.P.RGBA,internalFormat:R.P.RGBA,dataType:R.G.UNSIGNED_BYTE,wrapMode:R.D.CLAMP_TO_EDGE,samplingMode:R.L.LINEAR,flipped:!1,width:Math.ceil(a*i),height:Math.ceil(a*i)})}}}]),i}(de.a)}}]);
//# sourceMappingURL=7539.4bbd5fd3.chunk.js.map