"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[2913],{62913:function(e,t,r){r.r(t);var n=r(11752),i=r(61120),a=r(29439),s=r(93433),o=r(1413),l=r(74165),u=r(15861),c=r(15671),f=r(43144),h=r(60136),p=r(29388),d=r(48848),m=r(25577),v=r(14220),y=r(93661),x=r(99795),g=r(50690),b=r(20302),k=r(82474),w=r(45999),I=r(61903),S=r(23444),R=(r(74384),r(40558)),T=r(1685),_=r(12953),Z=r(47546),C=r(3356),M=r(40114),P=r(65094),F=r(85045),O=r(72215),B=r(44954),D=r(31532),z=r(3669),J=r(46817),N=r(21887),E=r(24623),A=r(6379),H=r(23341),L=r(41820),W=r(20086),j=r(69641),q=r(68781),G=r(30496),U=r(67066),V=(r(62610),r(93314),r(37856),r(15751),r(59984),r(53586),r(60369),r(92072),r(56162),r(85113),r(75255),r(46737),r(52113),r(89794),r(48200),r(71802),r(2821),r(37944),r(86086),r(21385),r(85253),r(93209),r(25456),r(46337),r(81556),r(93116),r(66577),r(33794),r(71147),r(84186),r(64998),r(15529),r(47855),r(70449),r(22603),r(63212),r(39994),r(69717),r(95643),r(59389),r(33795),r(79557),r(43976),r(6762),r(73679),r(89181),r(95249),r(65415),r(21015),r(92982),r(15436),r(43955),r(630),r(39926),function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments)).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return(0,f.Z)(r,[{key:"init",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,D.T)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){return e&&e.ioConfig&&(e=(0,o.Z)((0,o.Z)({},e),{},{ioConfig:(0,o.Z)({resolution:null,bandIds:null,sampling:"closest",tileInfo:C.j.create()},e.ioConfig)})),e}},{key:"_isGlobalWrappableSource",get:function(){var e=this.rasterInfo,t=(0,D.U)(e.spatialReference);return(0,y.r)(t)&&e.extent.width>=t/2}},{key:"url",set:function(e){this._set("url",(0,T.S)(e,d.a.getLogger(this.declaredClass)))}},{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new d.s("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.length>3&&void 0!==o[3]?o[3]:{},a=i.tileInfo||this.rasterInfo.storageInfo.tileInfo,s=this.getTileExtentFromTileInfo(t,r,n,a),e.abrupt("return",this.fetchPixels(s,a.size[0],a.size[1],i));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,u,c,f,h,p,m,v,x,g,b,w,I,S,R,T,_,C,M,P,F,B,z,J,N,E,A,H,L=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=L.length>1&&void 0!==L[1]?L[1]:{},t=(0,d.Q)(k.w,t).clone().normalize(),s=(a=i).multidimensionalDefinition,u=a.timeExtent,c=this.rasterInfo,f=c.hasMultidimensionalTranspose,h=c.multidimensionalInfo,p=i.transposedVariableName,(m=(0,y.r)(h)&&f&&(null!=u||(0,Z.f)(s)))&&!p&&(p=(0,y.r)(s)&&s.length>0?null!==(v=s[0].variableName)&&void 0!==v?v:void 0:h.variables[0].name,i=(0,o.Z)((0,o.Z)({},i),{},{transposedVariableName:p})),i=this._getRequestOptionsWithSliceId(i),x=this.rasterInfo,g=x.spatialReference,b=x.extent,w=i.datumTransformation,I=(0,D.j)(t,g,w),b.intersects(I)){e.next=11;break}return e.abrupt("return",{location:I,value:null});case 11:if(!(0,y.r)(this.rasterInfo.transform)){e.next=16;break}if(S=this.rasterInfo.transform.inverseTransform(I),this.rasterInfo.nativeExtent.intersects(S)){e.next=15;break}return e.abrupt("return",{location:S,value:null});case 15:I=S;case 16:if(R=0,T=(0,y.r)(p)&&(0,y.r)(h)&&this.rasterInfo.hasMultidimensionalTranspose){e.next=28;break}if(!i.srcResolution){e.next=23;break}R=(0,D.o)(i.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel,e.next=28;break;case 23:return e.next=25,this.computeBestPyramidLevelForLocation(t,i);case 25:if(null!=(R=e.sent)){e.next=28;break}return e.abrupt("return",{location:I,value:null});case 28:if(null!==(_=this.identifyPixelLocation(I,R,null,T))){e.next=31;break}return e.abrupt("return",{location:I,value:null});case 31:return C=_.row,M=_.col,P=_.rowOffset,F=_.colOffset,B=_.blockWidth,z=null!==(r=p)&&void 0!==r?r:(0,y.e)(i.sliceId),J=(0,O.a)(this.url,z),N="".concat(R,"/").concat(C,"/").concat(M),E=(0,O.x)(J,null,N),(0,y.t)(E)&&(E=this.fetchRawTile(R,C,M,i),(0,O.h)(J,null,N,E)),e.next=36,E;case 36:if(A=e.sent,!(0,y.t)(A)&&null!==(n=A.pixels)&&void 0!==n&&n.length){e.next=39;break}return e.abrupt("return",{location:I,value:null});case 39:return H=P*B+F,e.abrupt("return",this._processIdentifyResult(A,{srcLocation:I,position:H,pyramidLevel:R,useTransposedTile:!!T,requestSomeSlices:m,identifyOptions:i}));case 41:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I,S=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=S.length>3&&void 0!==S[3]?S[3]:{},t=(0,D.n)(t),!(i=this._getRequestOptionsWithSliceId(i)).requestRawData){e.next=3;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 3:if(a=(0,D.U)(t.spatialReference),s=(0,D.Q)(t),!((0,y.t)(a)||0===s||1===s&&this._isGlobalWrappableSource)){e.next=6;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 6:if(!(s>=3)){e.next=8;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 8:for(o=[],c=(u=t).xmin,f=u.xmax,h=Math.round(a/(f-c)*r),p=h-Math.round((a/2-c)/(f-c)*r),d=0,m=[],v=0;v<=s;v++)x=new J.w({xmin:0===v?c:-a/2,xmax:v===s?f-a*v:a/2,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference}),d+=g=0===v?h-p:v===s?r-d:h,m.push(g),b=i.disableWrapAround&&v>0?null:this._fetchPixels(x,g,n,i),o.push(b);return e.next=14,Promise.all(o);case 14:if(k=e.sent.map((function(e){return null===e||void 0===e?void 0:e.pixelBlock})),w=null,I={width:r,height:n},!this.rasterJobHandler){e.next=23;break}return e.next=20,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:k,srcMosaicSize:I,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:m},i);case 20:w=e.sent.pixelBlock,e.next=24;break;case 23:w=(0,B.T)(k,I,{blockWidths:m});case 24:return e.abrupt("return",{extent:t,srcExtent:(0,D.J)(t,this.rasterInfo.spatialReference,i.datumTransformation),pixelBlock:w});case 25:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=w.length>3&&void 0!==w[3]?w[3]:{},r={x:Math.floor(r.x),y:Math.floor(r.y)},e.next=4,this._fetchRawTiles(t,r,n,i);case 4:if(a=e.sent,s=this.rasterInfo,o=s.nativeExtent,u=s.nativePixelSize,c=s.storageInfo,f=Math.pow(2,t),h=u.x*f,p=u.y*f,d=new J.w({xmin:o.xmin+h*r.x,xmax:o.xmin+h*(r.x+n.width-1),ymin:o.ymax-p*(r.y+n.height-1),ymax:o.ymax-p*r.y,spatialReference:o.spatialReference}),a){e.next=15;break}return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:null});case 15:if(m=a.pixelBlocks,v=a.mosaicSize,1!==m.length||!(0,y.r)(m[0])||m[0].width!==n.width||m[0].height!==n.height){e.next=18;break}return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:a.pixelBlocks[0]});case 18:if(x=t>0?c.pyramidBlockWidth:c.blockWidth,g=t>0?c.pyramidBlockHeight:c.blockHeight,b={x:r.x%x,y:r.y%g},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:v,destDimension:n,clipOffset:b,clipSize:n,coefs:null,sampleSpacing:null,interpolation:i.interpolation,alignmentInfo:null,blockWidths:null},i);case 22:k=e.sent.pixelBlock,e.next=26;break;case 25:k=(0,B.T)(m,v,{clipOffset:b,clipSize:n});case 26:return e.abrupt("return",{extent:d,srcExtent:d,pixelBlock:k});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new d.s("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return(0,D.J)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?(0,F.S)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r){var n,i,a,s,u,c,f,h,p=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=p.length>2&&void 0!==p[2]?p[2]:0,s=this.ioConfig.customFetchParameters,u=r.range,c=r.query,f=r.headers,a=null!==(n=null!==(i=a)&&void 0!==i?i:r.retryCount)&&void 0!==n?n:this.ioConfig.retryCount,h=u?{Range:"bytes=".concat(u.from,"-").concat(u.to)}:null,e.prev=4,e.next=7,(0,R.U)(t,(0,o.Z)((0,o.Z)({},r),{},{query:(0,o.Z)((0,o.Z)({},c),s),headers:(0,o.Z)((0,o.Z)({},f),h)}));case 7:return e.abrupt("return",e.sent);case 10:if(e.prev=10,e.t0=e.catch(4),!(a>0)){e.next=14;break}return e.abrupt("return",(a--,this.request(t,r,a)));case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this.rasterInfo.multidimensionalInfo;return(0,y.t)(t)||(0,y.t)(e)||0===e.length?null:(0,Z.g)(e,t)}},{key:"getTileExtentFromTileInfo",value:function(e,t,r,n){var i=(0,y.i)(n.lodAt(e));return this.getTileExtent({x:i.resolution,y:i.resolution},t,r,n.origin,n.spatialReference,n.size)}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,i=e.pixelSize;if(!t.tileInfo){for(var a=[],s=t.maximumPyramidLevel||0,o=Math.max(i.x,i.y),l=1/.0254*96*o,u=0;u<=s;u++)a.push({level:s-u,resolution:o,scale:l}),o*=2,l*=2;var c=new k.w({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new C.j({origin:c,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:a}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,i=e.width,a=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,u=new k.w({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,a))/Math.LN2-8)));var c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new F.e({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===i.length&&a>0)for(var l=(i=(0,s.Z)(i))[0],u=l.x,c=l.y,f=0;f<a;f++)u*=o,c*=o,i.push({x:u,y:c});for(var h=[],p=n.x,d=n.y,m=0;m<i.length;m++){var v=i[m],y=v.x,x=v.y;h.push({minCol:Math.floor((e.xmin-p+.1*y)/t/y),maxCol:Math.floor((e.xmax-p-.1*y)/t/y),minRow:Math.floor((d-e.ymax+.1*x)/r/x),maxRow:Math.floor((d-e.ymin-.1*x)/r/x)})}return h}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,i=r.pyramidScalingFactor;if(0===e)return t;if((0,y.r)(n)&&n.length)return n[e-1];var a=Math.pow(i,e);return{x:t.x*a,y:t.y*a}}},{key:"identifyPixelLocation",value:function(e,t,r,n){var i=this.rasterInfo,a=i.spatialReference,s=i.nativeExtent,o=i.storageInfo,l=o.maximumPyramidLevel,u=o.origin,c=o.transposeInfo,f=n&&(0,y.r)(c)?c.tileSize[0]:o.blockWidth,h=n&&(0,y.r)(c)?c.tileSize[1]:o.blockHeight,p=(0,D.j)(e,a,r);if(!s.intersects(p))return null;if(t<0||t>l)return null;var d=this.getPyramidPixelSize(t),m=d.x,v=d.y,x=(u.y-p.y)/v/h,g=(p.x-u.x)/m/f,b=Math.min(h-1,Math.floor((x-Math.floor(x))*h)),k=Math.min(f-1,Math.floor((g-Math.floor(g))*f));return{pyramidLevel:t,row:Math.floor(x),col:Math.floor(g),rowOffset:b,colOffset:k,blockWidth:f,srcLocation:p}}},{key:"getTileExtent",value:function(e,t,r,n,i,s){var o=(0,a.Z)(s,2),l=o[0],u=o[1],c=n.x+r*l*e.x,f=c+l*e.x,h=n.y-t*u*e.y,p=h-u*e.y;return new J.w({xmin:c,xmax:f,ymin:p,ymax:h,spatialReference:i})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_fetchPixels",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,w,I,S,R,T,_,Z,C,M,P,F,O,J,N,E,A,H,L,W,j=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=j.length>3&&void 0!==j[3]?j[3]:{},!((a=(0,D.Q)(t))>=2)){e.next=4;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 4:if(s=this._getSourceDataInfo(t,r,n,i),o=s.pyramidLevel,u=s.pyramidResolution,c=s.srcResolution,f=s.srcExtent,h=s.srcWidth,p=s.srcHeight,0!==h&&0!==p){e.next=7;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:null});case 7:return d=(0,y.e)(this.rasterInfo.transform),m="gcs-shift"===(null===d||void 0===d?void 0:d.type),v=(0,y.r)((0,D.U)(t.spatialReference)),!m&&v||(a=(0,D.Q)(s.srcExtent,m)),x=this.rasterInfo.storageInfo,g={x:Math.floor((f.xmin-x.origin.x)/u.x+.1),y:Math.floor((x.origin.y-f.ymax)/u.y+.1)},e.next=13,this._fetchRawTiles(o,g,{width:h,height:p,wrapCount:a},i);case 13:if(b=e.sent){e.next=16;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:null});case 16:if(w=o>0?x.pyramidBlockWidth:x.blockWidth,I=o>0?x.pyramidBlockHeight:x.blockHeight,S=w===h&&I===p&&g.x%w==0&&g.y%I==0,R=new k.w({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),T=!t.spatialReference.equals(this.rasterInfo.spatialReference),_=i.datumTransformation,T||!S||1!==b.pixelBlocks.length||w!==r||I!==n||c.x!==R.x||c.y!==R.y){e.next=19;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:b.pixelBlocks[0]});case 19:if(Z=v&&(0,y.r)((0,D.U)(f.spatialReference)),C=i.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"),e.t0=C&&!this.rasterJobHandler,!e.t0){e.next=24;break}return e.next=24,(0,D.T)();case 24:if(!this.rasterJobHandler){e.next=30;break}return e.next=27,this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:t,srcBufferExtent:b.extent,pixelSize:R.toJSON(),datumTransformation:_,rasterTransform:d,hasWrapAround:a>0||Z,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:C},i);case 27:e.t1=e.sent,e.next=31;break;case 30:e.t1=(0,D.$)({projectedExtent:t,srcBufferExtent:b.extent,pixelSize:R,datumTransformation:_,rasterTransform:d,hasWrapAround:a>0||Z,isAdaptive:!1,includeGCSGrid:C});case 31:if(M=e.t1,F=!i.requestRawData,O={rows:M.spacing[0],cols:M.spacing[1]},J=(0,y.e)(this._getRasterTileAlignmentInfo(o,b.extent.xmin)),N=b.pixelBlocks,E=b.mosaicSize,A=b.isPartiallyFilled,H=null,!this.rasterJobHandler){e.next=42;break}return e.next=37,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:N,srcMosaicSize:E,destDimension:F?{width:r,height:n}:null,coefs:F?M.coefficients:null,sampleSpacing:F?O:null,projectDirections:C,gcsGrid:C?M.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:i.interpolation,alignmentInfo:J,blockWidths:null},i);case 37:L=e.sent,P=L.pixelBlock,H=L.localNorthDirections,e.next=44;break;case 42:W=(0,B.T)(N,E,{alignmentInfo:J}),P=F?(0,B.D)(W,{width:r,height:n},M.coefficients,O,i.interpolation):W,C&&M.gcsGrid&&(H=(0,B.j)({width:r,height:n},M.gcsGrid),P=(0,z.m)(P,this.rasterInfo.dataType,H));case 44:return e.abrupt("return",i.requestRawData||C?{srcExtent:f,pixelBlock:P,transformGrid:M,localNorthDirections:H,extent:t,isPartiallyFilled:A}:{srcExtent:f,extent:t,pixelBlock:P});case 45:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchRawTiles",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n,i){var a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I,S,R,T,_,Z,C,M,P,F,O,B,D,z,N,E,A,H,L,W,j=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.rasterInfo.storageInfo,s=a.origin,o=a.blockBoundary,u=this.getBlockWidthHeight(t),c=u.blockWidth,f=u.blockHeight,h=r.x,p=r.y,d=n.width,m=n.height,v=n.wrapCount,x=this._getRasterTileAlignmentInfo(t,0),i.buffer&&(h-=i.buffer.cols,p-=i.buffer.rows,d+=2*i.buffer.cols,m+=2*i.buffer.rows),g=0,b=0,k=0,v&&(0,y.r)(x)&&(b=x.worldColumnCountFromOrigin,k=x.originColumnOffset,g=x.rightPadding,b*x.blockWidth-g>=h+d&&(g=0)),w=Math.floor(h/c),I=Math.floor(p/f),S=Math.floor((h+d+g-1)/c),R=Math.floor((p+m+g-1)/f),T=o[t]){e.next=9;break}return e.abrupt("return",null);case 9:if(_=T.minRow,Z=T.minCol,C=T.maxCol,M=T.maxRow,0!==v||!(R<_||S<Z||I>M||w>C)){e.next=12;break}return e.abrupt("return",null);case 12:for(P=new Array,F=!1,O=null==this.ioConfig.allowPartialFill?i.allowPartialFill:this.ioConfig.allowPartialFill,B=I;B<=R;B++)for(D=w;D<=S;D++)z=D,!i.disableWrapAround&&v&&(0,y.r)(x)&&b<=D&&(z=D-b-k),B>=_&&z>=Z&&M>=B&&C>=z?function(){var e=j._fetchRawTile(t,B,z,i);O?P.push(new Promise((function(t){e.then((function(e){return t(e)})).catch((function(){F=!0,t(null)}))}))):P.push(e)}():P.push(Promise.resolve(null));if(0!==P.length){e.next=18;break}return e.abrupt("return",null);case 18:return e.next=20,Promise.all(P);case 20:return N=e.sent,E={height:(R-I+1)*f,width:(S-w+1)*c},A=this.rasterInfo.spatialReference,H=this.getPyramidPixelSize(t),L=H.x,W=H.y,e.abrupt("return",{extent:new J.w({xmin:s.x+w*c*L,xmax:s.x+(S+1)*c*L,ymin:s.y-(R+1)*f*W,ymax:s.y-I*f*W,spatialReference:A}),pixelBlocks:N,mosaicSize:E,isPartiallyFilled:F});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTile",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);var a=i.minRow,s=i.minCol,l=i.maxCol,u=i.maxRow;if(t<a||r<s||t>u||r>l)return Promise.resolve(null);var c=(0,O.a)(this.url,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),h=(0,O.x)(c,n.registryId,f);if((0,y.t)(h)){var p=new AbortController;h=this.fetchRawTile(e,t,r,(0,o.Z)((0,o.Z)({},n),{},{signal:p.signal})),(0,O.h)(c,n.registryId,f,h,p),h.catch((function(){return(0,O.d)(c,n.registryId,f)}))}return n.signal&&(0,d.v)(n,(function(){(0,O.m)(c,n.registryId,f)})),h}},{key:"_computeMagDirValues",value:function(e){var t,r=this.rasterInfo,n=r.bandCount,i=r.dataType;if((2!==n||"vector-magdir"!==i)&&"vector-uv"!==i||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;var s=e[0].length;if("vector-magdir"===i){var o=e[1].map((function(e){return(e+360)%360}));return[e[0],o]}for(var l=(0,a.Z)(e,2),u=l[0],c=l[1],f=[],h=[],p=0;p<s;p++){var d=(0,z.b)([u[p],c[p]]),m=(0,a.Z)(d,2),v=m[0],y=m[1];f.push(v),h.push(y)}return[f,h]}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=(0,D.V)(this.rasterInfo)),(0,y.t)(this._rasterTileAlighmentInfo.pyramidsInfo)?null:(0,o.Z)({startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform},this._rasterTileAlighmentInfo.pyramidsInfo[e])}},{key:"_getSourceDataInfo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0};n.srcResolution&&(i.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,i));var a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,s=i.srcWidth,o=i.srcHeight,l=i.pyramidLevel,u=s/t,c=o/r,f=l<a&&u*c>=16;if(f||l===a&&(u>8||c>8)||0===s||0===o){var h=new k.w({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),p=(0,D.C)(h,this.rasterInfo.spatialReference,e,i.datumTransformation),d=!p||n.srcResolution&&p.x+p.y<n.srcResolution.x+n.srcResolution.y;if(f&&n.srcResolution&&d){var m=Math.round(Math.log(Math.max(u,c))/Math.LN2)-1;if(a-l+3>=m){var v=Math.pow(2,m);p={x:n.srcResolution.x*v,y:n.srcResolution.y*v}}}p&&(i.srcResolution=p,this._updateSourceDataInfo(e,i))}return(i.srcWidth/t>8||i.srcHeight/r>8)&&(i.srcWidth=0,i.srcHeight=0),i}},{key:"_updateSourceDataInfo",value:function(e,t){t.srcWidth=0,t.srcHeight=0;var r=this.rasterInfo.spatialReference,n=t.srcResolution,i=t.datumTransformation,a=(0,D.o)(n,this.rasterInfo,this.ioConfig.sampling),s=a.pyramidLevel,o=a.pyramidResolution;if(!a.excessiveReading){var l=t.srcExtent||(0,D.J)(e,r,i);if(null!=l){var u=(0,y.e)(this.rasterInfo.transform);u&&(l=u.inverseTransform(l)),t.srcExtent=l;var c=Math.ceil((l.xmax-l.xmin)/o.x-.1),f=Math.ceil((l.ymax-l.ymin)/o.y-.1);t.pyramidLevel=s,t.pyramidResolution=o,t.srcWidth=c,t.srcHeight=f}}}},{key:"_getRequestOptionsWithSliceId",value:function(e){return(0,y.r)(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e=(0,o.Z)((0,o.Z)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}},{key:"_processIdentifyResult",value:function(e,t){var r=t.srcLocation,n=t.position,i=t.pyramidLevel,a=t.useTransposedTile,s=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:r,value:null};var l=this.rasterInfo.multidimensionalInfo;if((0,y.t)(l)||!a){var u=e.pixels.map((function(e){return e[n]})),c={location:r,value:u,pyramidLevel:i},f=this._computeMagDirValues(u.map((function(e){return[e]})));return null!==f&&void 0!==f&&f.length&&(c.magdirValue=f.map((function(e){return e[0]}))),c}var h=e.pixels.map((function(e){return Array.prototype.slice.call(e,n*s,n*s+s)})),p=this._computeMagDirValues(h),d=t.requestSomeSlices,m=t.identifyOptions,v=(0,Z.i)(l,m.transposedVariableName);if(d){var x,g=(0,Z.s)(v,(0,y.e)(m.multidimensionalDefinition),(0,y.e)(m.timeExtent));h=h.map((function(e){return g.map((function(t){return e[t]}))})),p=null===(x=p)||void 0===x?void 0:x.map((function(e){return g.map((function(t){return e[t]}))})),v=g.map((function(e){return v[e]}))}return{location:r,value:null,dataSeries:v.map((function(e,t){var r,n={value:h.map((function(e){return e[t]})),multidimensionalDefinition:e.multidimensionalDefinition.map((function(e){return new Z.p((0,o.Z)((0,o.Z)({},e),{},{isSlice:!0}))}))};return null!==(r=p)&&void 0!==r&&r.length&&(n.magdirValue=[p[0][t],p[1][t]]),n})),pyramidLevel:i}}}]),r}((0,P.m)(M.l)));(0,d.e)([(0,d.y)()],V.prototype,"_rasterTileAlighmentInfo",void 0),(0,d.e)([(0,d.y)({readOnly:!0})],V.prototype,"_isGlobalWrappableSource",null),(0,d.e)([(0,d.y)(_.f)],V.prototype,"url",null),(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],V.prototype,"datasetName",void 0),(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],V.prototype,"datasetFormat",void 0),(0,d.e)([(0,d.y)()],V.prototype,"rasterInfo",void 0),(0,d.e)([(0,d.y)()],V.prototype,"ioConfig",void 0),(0,d.e)([(0,d.y)()],V.prototype,"sourceJSON",void 0);var X=V=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.BaseRaster")],V),Y=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="Function",e.tileType="Raster",e.rasterFunction=null,e._primaryRasters=null,e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return n=this.rasterFunction,i=n.getPrimaryRasters(),a=i.rasters,s=i.rasterIds,o=a.map((function(e){return e.rasterInfo?void 0:e.open(t)})),e.next=5,Promise.all(o);case 5:if(u=a.map((function(e){return e.rasterInfo})),(c=n.bind({rasterInfos:u,rasterIds:s})).success){e.next=8;break}throw new d.s("raster-function:open","cannot bind the function: ".concat(null!==(r=c.error)&&void 0!==r?r:""));case 8:return e.next=10,this.syncJobHandler();case 10:this.set("sourceJSON",a[0].sourceJSON),this.set("rasterInfo",n.rasterInfo);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"syncJobHandler",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.rasterFunction,this._primaryRasters=t.getPrimaryRasters(),!this.rasterJobHandler){e.next=3;break}return e.abrupt("return",this.rasterJobHandler.updateRasterFunction(t));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,u,c,f,h,p,d,m,v,x=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=x.length>3&&void 0!==x[3]?x[3]:{},u=this._primaryRasters,c=u.rasters,f=u.rasterIds,h=c.map((function(e){return e.fetchPixels(t,r,n,s)})),e.next=7,Promise.all(h);case 7:if(p=e.sent,d=p.map((function(e){return e.pixelBlock})),!d.every((function(e){return(0,y.t)(e)}))){e.next=11;break}return e.abrupt("return",p[0]);case 11:if(m=null!==(i=null===(a=p.find((function(e){return(0,y.r)(e.pixelBlock)})))||void 0===a?void 0:a.extent)&&void 0!==i?i:t,!this.rasterJobHandler){e.next=18;break}return e.next=15,this.rasterJobHandler.process({extent:m,primaryPixelBlocks:d,primaryRasterIds:f});case 15:e.t0=e.sent,e.next=19;break;case 18:e.t0=this.rasterFunction.process({extent:m,primaryPixelBlocks:d,primaryRasterIds:f});case 19:return v=e.t0,e.abrupt("return",(0,o.Z)((0,o.Z)({},p[0]),{},{pixelBlock:v}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(X);(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],Y.prototype,"datasetFormat",void 0),(0,d.e)([(0,d.y)()],Y.prototype,"tileType",void 0),(0,d.e)([(0,d.y)()],Y.prototype,"rasterFunction",void 0);var K=Y=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.FunctionRaster")],Y),Q=d.a.getLogger("esri.layers.mixins.ImageryTileMixin");function $(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),a=i.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<a.length;l++)t[a[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:i,features:s}}var ee=function(){function e(){(0,c.Z)(this,e)}return(0,f.Z)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,i=t.getUint32(4,!0),a=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:i,headerByteCount:a,recordByteCount:s},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:(0,F.r)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push((0,F.r)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=s};c.length<i&&e.byteLength-l>s;)f()}return{header:o,fields:u,records:c,recordSet:$({fields:u,records:c})}}}]),e}(),te=new Map;te.set("int16","esriFieldTypeSmallInteger"),te.set("int32","esriFieldTypeInteger"),te.set("int64","esriFieldTypeInteger"),te.set("float32","esriFieldTypeSingle"),te.set("float64","esriFieldTypeDouble"),te.set("text","esriFieldTypeString");var re=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null===t||void 0===t?void 0:t.signal});case 4:if(r=e.sent,n=r.data,this._validateHeader(n)){e.next=8;break}throw new d.s("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=this._parseHeader(n),a=i.storageInfo,"thematic"!==(s=i.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:o=e.sent,s.attributeTable=o;case 15:this._set("storageInfo",a),this._set("rasterInfo",s),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,s,o,u,c,f,h,p,d,m,v,y,x,g,b,k=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=k.length>3&&void 0!==k[3]?k[3]:{},s=this.rasterInfo.storageInfo.transposeInfo,o=i.transposedVariableName,!((c=(u=!(!s||!o))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return f=this._buildCacheFilePath(c,r,n,i.multidimensionalDefinition,o),h=this._getIndexRecordFromBundle(r,n,u),e.next=8,this.request(f,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});case 8:if(p=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(d=new Uint8Array(p.data),0!==(m=this._getTileEndAndContentType(d,h)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(f,{range:{from:m.position,to:m.position+m.recordSize},responseType:"array-buffer",signal:i.signal});case 16:if(v=e.sent){e.next=19;break}return e.abrupt("return",null);case 19:return y=this._getTileSize(u),x=(0,a.Z)(y,2),g=x[0],b=x[1],e.abrupt("return",this.decodePixelBlock(v.data,{width:g,height:b,planes:null,pixelType:null,returnInterleaved:u}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],i=e.bandCount,a=e.histograms,s=e.colormap,o=e.blockWidth,l=e.blockHeight,u=e.firstPyramidLevel,c=e.maximumPyramidLevel,f=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),h=e.extent.spatialReference,p=null===(t=e.geodataXform)||void 0===t?void 0:t.spatialReference,d=new k.k(null!==h&&void 0!==h&&h.wkid||null!==h&&void 0!==h&&h.wkt?h:p),m=new J.w({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:d}),v=new k.w({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:d}),y=Math.round((m.xmax-m.xmin)/v.x),x=Math.round((m.ymax-m.ymin)/v.y),g=this._parseTransform(e.geodataXform),b=g?m:null;g&&(m=g.forwardTransform(m),v.x=(m.xmax-m.xmin)/y,v.y=(m.ymax-m.ymin)/x);var w,I,S,R,T=null!==(r=e.properties)&&void 0!==r?r:{},_=e.format.toLowerCase().replace("cache/",""),Z=new k.w(e.origin.x,e.origin.y,d);if(s&&s.colors)for(w=[],I=0;I<s.colors.length;I++)S=s.colors[I],R=s.values?s.values[I]:I,w.push([R,255&S,S<<16>>>24,S<<8>>>24,S>>>24]);var M=e.LODInfos,P=[];for(I=0;I<M.levels.length;I++)P.push({level:M.levels[I],resolution:M.resolutions[I],scale:96/.0254*M.resolutions[I]});var O=new C.j({dpi:96,lods:P,format:_,origin:Z,size:[o,l],spatialReference:d}),B={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},D=[{maxCol:Math.ceil(y/o)-1,maxRow:Math.ceil(x/l)-1,minCol:0,minRow:0}],z=2;if(c>0)for(I=0;I<c;I++)D.push({maxCol:Math.ceil(y/z/o)-1,maxRow:Math.ceil(x/z/l)-1,minCol:0,minRow:0}),z*=2;var N=e.mdInfo,E=null;if(N&&T._yxs){var A=T._yxs;E={packetSize:A.PacketSize,tileSize:[A.TileXSize,A.TileYSize]}}return{storageInfo:B,rasterInfo:new F.b({width:y,height:x,pixelType:n,bandCount:i,extent:m,nativeExtent:b,transform:g,spatialReference:d,pixelSize:v,keyProperties:T,statistics:f,histograms:a,multidimensionalInfo:N,colormap:w,storageInfo:new F.e({blockWidth:o,blockHeight:l,pyramidBlockWidth:o,pyramidBlockHeight:l,origin:Z,tileInfo:O,transposeInfo:E,firstPyramidLevel:u,maximumPyramidLevel:c,blockBoundary:D})})}}},{key:"_parseTransform",value:function(e){var t,r;if(!(0,N.f)(e))throw new d.s("cloudraster:open","the data contains unsupported geodata transform types");var n=(0,N.i)(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null===(t=n.forwardCoefficients)||void 0===t||!t.length||null===(r=n.inverseCoefficients)||void 0===r||!r.length)throw new d.s("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}},{key:"_fetchAuxiliaryInformation",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),n=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,n]);case 4:return(i=e.sent)[0]&&(s=i[0].fields,o=i[0].values,s&&o&&(s=s.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":te.get(e.type),name:e.name,alias:e.alias||e.name}})),u=o.map((function(e){return{attributes:e}})),s&&o&&(a={fields:s,features:u}))),!a&&i[1]&&(a=ee.parse(i[1]).recordSet),e.abrupt("return",q.default.fromJSON(a));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_buildCacheFilePath",value:function(e,t,r,n,i){var a=this._getPackageSize(!!i),s=Math.floor(t/a)*a,o=Math.floor(r/a)*a,l="R"+this._toHexString4(s)+"C"+this._toHexString4(o),u="L";u+=e>=10?e.toString():"0"+e.toString();var c=this.rasterInfo.multidimensionalInfo,f=null===n||void 0===n?void 0:n[0];if((0,y.t)(c)||!f)return"".concat(this.url,"/_alllayers/").concat(u,"/").concat(l,".bundle");var h="_yxs";if(!i){h=c.variables.find((function(e){return e.name===f.variableName})).dimensions[0].values.indexOf(f.values[0]).toString(16);for(var p=4-h.length,d=0;d<p;d++)h="0"+h;h="S"+h}var m=this._getVariableFolderName(i||f.variableName);return"".concat(this.url,"/_alllayers/").concat(m,"/").concat(h,"/").concat(u,"/").concat(l,".bundle")}},{key:"_getPackageSize",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.rasterInfo.storageInfo.transposeInfo;return t&&(0,y.r)(r)?null!==(e=r.packetSize)&&void 0!==e?e:0:this.storageInfo.packetSize}},{key:"_getTileSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.rasterInfo.storageInfo,r=t.transposeInfo;return e&&(0,y.r)(r)?r.tileSize:t.tileInfo.size}},{key:"_getVariableFolderName",value:function(e){return""===(e=e.trim())?"_v":e.replace(/[\{|\}\-]/g,"_").replace("\\*","_v")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._getPackageSize(r),i=n*(e%n)+t%n;if(i<0)throw"Invalid level / row / col";return 20+i*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),i=0;for(r=0;r<5;r++)i|=(255&n[r])<<8*r;var a=0xffffffffff&i;for(i=0,r=5;r<8;r++)i|=(255&n[r])<<8*(r-5);return{position:a,recordSize:0xffffffffff&i}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),r}(X);(0,d.e)([(0,d.y)({readOnly:!0})],re.prototype,"storageInfo",void 0),(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],re.prototype,"datasetFormat",void 0);var ne=re=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.CloudRaster")],re),ie=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e.data=null,e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h,p,d,m,v,y,x,g,b;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return i=this.data,a=this.data,s=a.pixelBlock,o=a.statistics,u=a.histograms,c=a.name,f=a.keyProperties,h=a.nativeExtent,p=a.transform,d=s.width,m=s.height,v=s.pixelType,y=null!==(r=i.extent)&&void 0!==r?r:new J.w({xmin:-.5,ymin:.5,xmax:d-.5,ymax:m-.5,spatialReference:new k.k({wkid:3857})}),x=null!==(n=i.isPseudoSpatialReference)&&void 0!==n?n:!i.extent,g={x:y.width/d,y:y.height/m},b=new F.b({width:d,height:m,pixelType:v,extent:y,nativeExtent:h,transform:p,pixelSize:g,spatialReference:y.spatialReference,bandCount:3,keyProperties:f||{},statistics:o,isPseudoSpatialReference:x,histograms:u}),this.createRemoteDatasetStorageInfo(b,512,512),this._set("rasterInfo",b),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(s,{width:512,height:512},t);case 8:this.datasetName=c,this.url="/InMemory/"+c;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:s},n):Promise.resolve((0,B.W)(t,r,s)),u=(0,y.r)(this.rasterInfo.statistics),c=(0,y.r)(this.rasterInfo.histograms),f=u?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},n):Promise.resolve((0,F.p)(t)),e.next=7,(0,d.E)([o,f]);case 7:if((h=e.sent)[0].value||!h[1].value){e.next=10;break}throw new d.s("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=h[0].value,u||(this.rasterInfo.statistics=null===(i=h[1].value)||void 0===i?void 0:i.statistics),c||(this.rasterInfo.histograms=null===(a=h[1].value)||void 0===a?void 0:a.histograms);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(X);(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],ie.prototype,"datasetFormat",void 0),(0,d.e)([(0,d.y)()],ie.prototype,"data",void 0);var ae=ie=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.InMemoryRaster")],ie);function se(e,t){if(!e||!t)return[];var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var i=se(e,r),a=0;a<i.length;a++)se(i[a],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item[o]);return n}function oe(e,t){if(!e||!t)return null;var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=se(e,r);return n.length>0?t?oe(n[0],t):n[0]:null}function le(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?oe(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function ue(e,t){return function(e,t){for(var r,n=se(e,t),i=[],a=0;a<n.length;a++)(r=n[a].textContent||n[a].nodeValue)&&""!==(r=r.trim())&&i.push(r);return i}(e,t).map((function(e){return Number(e)}))}function ce(e,t){var r=le(e,t);return Number(r)}function fe(e,t){var r,n=null===e||void 0===e||null===(r=e.nodeName)||void 0===r?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}function he(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function pe(e){var t,r=oe(e,"GeodataXform"),n=me(ce(r,"SpatialReference/WKID")||le(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var i=null!==(t=ce(r,"PolynomialOrder"))&&void 0!==t?t:1,a=ue(r,"CoeffX/Double"),s=ue(r,"CoeffY/Double"),o=ue(r,"InverseCoeffX/Double"),l=ue(r,"InverseCoeffY/Double"),u=he(a,s),c=he(o,l);return{spatialReference:n,transform:u&&c&&u.length&&c.length?new N.m({spatialReference:n,polynomialOrder:i,forwardCoefficients:u,inverseCoefficients:c}):null}}function de(e){var t,r,n,i,a,s=ce(e,"NoDataValue"),o=oe(e,"Histograms/HistItem"),l=ce(o,"HistMin"),u=ce(o,"HistMax"),c=ce(o,"BucketCount"),f=null===(t=le(o,"HistCounts"))||void 0===t?void 0:t.split("|").map((function(e){return Number(e)}));se(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":i=s;break;case"STATISTICS_STDDEV":a=s}}));var h=ce(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!==f&&void 0!==f&&f.length&&null!=l&&null!=u?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:h,statistics:null!=r&&null!=n?{min:r,max:n,avg:i,stddev:a}:null}}function me(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new k.k({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;var r=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),i=n>-1?n:e.indexOf("GEOGCS");if(-1===i)return null;var a=e.slice(i,e.lastIndexOf("]",r)+1).trim(),s=e.slice(r,e.lastIndexOf("]")).trim();t=ve(a);var o=new k.k(t?{wkid:t}:{wkt:a}),l=ve(s);return l&&(o.vcsWkid=l),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=ve(e),new k.k(0!==t?{wkid:t}:{wkt:e})):null}function ve(e){var t,r=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(","),i=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===i||"esri"===i)&&e.endsWith('"]]')){var a=Number(n[1]);if(!isNaN(a)&&0!==a)return a}return 0}function ye(e){var t;if("pamdataset"!==(null===e||void 0===e||null===(t=e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(fe(e,"SRS")){if(!r.spatialReference){var t=le(e);r.spatialReference=me(t)}}else if(fe(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=pe(e),i=n.spatialReference,a=n.transform;r.transform=a,r.spatialReference||(r.spatialReference=i)}else se(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=le(e)}));else if(fe(e,"PAMRasterBand")){var s=de(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n.length){var i=!!n[0].statistics;r.statistics=i?n.map((function(e){return e.statistics})).filter(y.r):null;var a=!!n[0].histogram;r.histograms=a?n.map((function(e){return e.histogram})).filter(y.r):null}return r}var xe=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){return(0,c.Z)(this,r),t.apply(this,arguments)}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h,p,d,m;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return n=e.sent,i=n.spatialReference,a=n.statistics,s=n.histograms,o=n.transform,(u=!i)&&(i=new k.k({wkid:3857})),(null===s||void 0===s?void 0:s.length)&&null==a&&(a=(0,F.j)(s)),c=r.width,f=r.height,h=new J.w({xmin:-.5,ymin:.5-f,xmax:c-.5,ymax:.5,spatialReference:i}),p=o?o.forwardTransform(h):h,!0,o&&(d=o.forwardCoefficients,d&&0===d[1]&&0===d[2]&&(o=null,h=p)),m=new ae({data:{extent:p,nativeExtent:h,transform:o,pixelBlock:r,statistics:a,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:u}}),e.next=22,m.open();case 22:m.data=null,this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 2:if(r=e.sent,n=r.data,"JPG"===(i=(0,F.P)(n).toUpperCase())||"PNG"===i||"GIF"===i||"BMP"===i){e.next=7;break}throw new d.s("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",i),a=i.toLowerCase(),s="gif"===a||"bmp"===a||!(0,y.h)("ios"),e.next=11,this.decodePixelBlock(n,{format:a,useCanvas:s,hasNoZlibMask:!0});case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h,p;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,y.e)(null===t||void 0===t?void 0:t.signal),a=null!==(r=this.ioConfig.skipExtensions)&&void 0!==r?r:[],s=a.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:i}),o=this.datasetFormat,c=(u="JPG"===o?"jgw":"PNG"===o?"pgw":"BMP"===o?"bpw":null)&&a.includes(u)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:i}),e.next=8,(0,d.E)([s,c]);case 8:if(f=e.sent,null===i||void 0===i||!i.aborted){e.next=11;break}throw(0,d.d)();case 11:return(h=ye(null===(n=f[0].value)||void 0===n?void 0:n.data)).transform||(p=f[1].value?f[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,h.transform=6===(null===p||void 0===p?void 0:p.length)?new N.m({forwardCoefficients:[p[4],p[5],p[0],-p[1],p[2],-p[3]]}):null),e.abrupt("return",h);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(X);(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],xe.prototype,"datasetFormat",void 0);var ge=xe=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.ImageAuxRaster")],xe),be=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._tilemapCache=null,e._slices=null,e.datasetFormat="RasterTileServer",e.tileType=null,e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,s,o,u,c,f,h,p,m,v,x,g,b,k,w,I,S,T,_,Z,M,P,O,B,D,z;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(o=t&&t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:o});case 9:e.t0=e.sent;case 10:if((u=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),c=u.data,this.sourceJSON=c,c){e.next=15;break}throw new d.s("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(c.tileInfo){e.next=17;break}throw new d.s("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),f=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=c.cacheType,null==this.tileType&&(f.includes(c.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===c.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=null!==(r=null===(n=c.name)||void 0===n?void 0:n.slice(c.name.indexOf("/")+1))&&void 0!==r?r:"",e.next=22,this._fetchRasterInfo({signal:o});case 22:if(h=e.sent,!(0,y.t)(h)){e.next=25;break}throw new d.s("image-server-raster:open","cannot initialize image service");case 25:p="Map"===this.tileType?(0,G.n)(c.tileInfo,c):C.j.fromJSON(c.tileInfo),(0,y.E)(p),m=this._computeMinMaxLOD(h,p),v=(0,a.Z)(m,2),x=v[0],g=v[1],b=h.extent,k=h.pixelSize,w=.5/h.width*k.x,I=Math.max(k.x,k.y),S=p.lods,("Map"!==this.tileType&&0!==c.maxScale||Math.abs(k.x-k.y)>w||!S.some((function(e){return Math.abs(e.resolution-I)<w})))&&(k.x=k.y=x.resolution,h.width=Math.ceil((b.xmax-b.xmin)/k.x-.1),h.height=Math.ceil((b.ymax-b.ymin)/k.y-.1)),T=x.level-g.level,_=(0,a.Z)(p.size,2),Z=_[0],M=_[1],P=[],S.forEach((function(e){e.level>=g.level&&e.level<=x.level&&P.push({x:e.resolution,y:e.resolution})})),P.sort((function(e,t){return e.x-t.x})),O=this.computeBlockBoundary(b,Z,M,p.origin,P,T),B=P.length>1?P.slice(1):null,c.transposeInfo&&(D={tileSize:[c.transposeInfo.rows,c.transposeInfo.cols],packetSize:null!==(i=null===(s=h.keyProperties)||void 0===s?void 0:s._yxs.PacketSize)&&void 0!==i?i:0}),h.storageInfo=new F.e({blockWidth:p.size[0],blockHeight:p.size[1],pyramidBlockWidth:p.size[0],pyramidBlockHeight:p.size[1],pyramidResolutions:B,compression:p.format,origin:p.origin,firstPyramidLevel:1,maximumPyramidLevel:T,tileInfo:p,transposeInfo:D,blockBoundary:O}),this._fixGCSShift(h),this._set("rasterInfo",h),c.capabilities.toLowerCase().includes("tilemap")&&(z={tileInfo:h.storageInfo.tileInfo,parsedUrl:(0,R.j)(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new G.z({layer:z}));case 33:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I,S,R,T,_,Z,C,M,P,F,O,D=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=D.length>3&&void 0!==D[3]?D[3]:{},a=this.rasterInfo,s=a.storageInfo,o=a.extent,u=s.transposeInfo,c=(0,y.r)(u)&&!!i.transposedVariableName,!this._slices||c||null!=i.sliceId){e.next=4;break}return e.abrupt("return",null);case 4:return f=c?0:s.maximumPyramidLevel-t+this._levelOffset,h="".concat(this.url,"/tile/").concat(f,"/").concat(r,"/").concat(n),p=this._slices?c?{variable:i.transposedVariableName}:{sliceId:i.sliceId||0}:null,e.next=9,this.request(h,{query:p,responseType:"array-buffer",signal:i.signal});case 9:if(d=e.sent,m=d.data){e.next=13;break}return e.abrupt("return",null);case 13:return v=c?u.tileSize:s.tileInfo.size,e.next=16,this.decodePixelBlock(m,{width:v[0],height:v[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:c});case 16:if(x=e.sent,g=s.blockBoundary[t],!("jpg"!==s.compression||n>g.minCol&&n<g.maxCol&&r>g.minRow&&r<g.maxRow)){e.next=20;break}return e.abrupt("return",x);case 20:return b=s.origin,k=s.blockWidth,w=s.blockHeight,I=this.getPyramidPixelSize(t),S=I.x,R=I.y,T=Math.round((o.xmin-b.x)/S)%k,_=Math.round((o.xmax-b.x)/S)%k||k,Z=Math.round((b.y-o.ymax)/R)%w,C=Math.round((b.y-o.ymin)/R)%w||w,M=n===g.minCol?T:0,P=r===g.minRow?Z:0,F=n===g.maxCol?_:k,O=r===g.maxRow?C:w,e.abrupt("return",((0,B.b)(x,{x:M,y:P},{width:F-M,height:O-P}),x));case 22:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(!this._slices||(0,y.t)(e)||0===e.length)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.find((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}));return!r||(Array.isArray(e.values[0])?"".concat(e.values[0][0],"-").concat(e.values[0][1]):e.values[0])!==(Array.isArray(r.values[0])?"".concat(r.values[0][0],"-").concat(r.values[0][1]):r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r){var n,i,a;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),i=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),e.next=4,Promise.all([n,i]);case 4:return a=e.sent,e.abrupt("return",(a[0]&&a[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:a[0]||null,histograms:a[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(n=this.identifyPixelLocation(t,0,(0,y.e)(r.datumTransformation)))){e.next=6;break}return e.abrupt("return",null);case 6:i=0,a=this.rasterInfo.storageInfo.maximumPyramidLevel,s=a-i+this._levelOffset,o=n.srcLocation;case 10:if(!(s>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(s,n.row,n.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(s--,i++,null!==(n=this.identifyPixelLocation(o,i,(0,y.e)(r.datumTransformation)))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===s||null==n?null:i);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,"Map"!==this.tileType){e.next=4;break}return n=r.fullExtent||r.extent,i=Math.ceil((n.xmax-n.xmin)/r.pixelSizeX-.1),a=Math.ceil((n.ymax-n.ymin)/r.pixelSizeY-.1),s=k.k.fromJSON(r.spatialReference||n.spatialReference),o=new k.w({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:s}),e.abrupt("return",new F.b({width:i,height:a,bandCount:3,extent:J.w.fromJSON(n),spatialReference:s,pixelSize:o,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 4:return u=t.signal,c=(0,v.m)(this.url,this.sourceJSON,{signal:u,query:this.ioConfig.customFetchParameters}),f=r.hasMultidimensions?this.request("".concat(this.url,"/slices"),{query:{f:"json"},signal:u}).then((function(e){return e.data&&e.data.slices})).catch((function(){return null})):null,e.next=9,Promise.all([c,f]);case 9:return h=e.sent,e.abrupt("return",(this._slices=h[1],h[0]));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_fixGCSShift",value:function(e){var t=e.extent,r=e.spatialReference;t.xmin>-1&&t.xmax>181&&(null===r||void 0===r?void 0:r.wkid)&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new N.c,e.extent=e.transform.forwardTransform(t))}},{key:"_computeMinMaxLOD",value:function(e,t){var r,n,i,a=e.pixelSize,s=.5/e.width*a.x,o=t.lods,l=t.lodAt(Math.max.apply(null,o.map((function(e){return e.level})))),u=t.lodAt(Math.min.apply(null,o.map((function(e){return e.level})))),c=this.tileType;if("Map"===c)return this._levelOffset=o[0].level,[l,u];if("Raster"===c)return[null!==(i=o.find((function(e){return e.resolution===a.x})))&&void 0!==i?i:l,u];var f=this.sourceJSON,h=f.minScale,p=f.maxScale,d=l;p>0&&(d=o.find((function(e){return Math.abs(e.scale-p)<s})),d||(d=null!==(r=o.filter((function(e){return e.scale>p})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])&&void 0!==r?r:l));var m=u;return h>0&&(m=null!==(n=o.find((function(e){return Math.abs(e.scale-h)<s})))&&void 0!==n?n:u,this._levelOffset=m.level-u.level),[d,m]}}]),r}(X);(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],be.prototype,"datasetFormat",void 0),(0,d.e)([(0,d.y)()],be.prototype,"tileType",void 0);var ke=be=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.ImageServerRaster")],be),we=new Map;we.set("Int8","s8"),we.set("UInt8","u8"),we.set("Int16","s16"),we.set("UInt16","u16"),we.set("Int32","s32"),we.set("UInt32","u32"),we.set("Float32","f32"),we.set("Float64","f32"),we.set("Double64","f32");var Ie=new Map;Ie.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),Ie.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),Ie.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),Ie.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var Se=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I,S,R;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=t?(0,y.e)(t.signal):null,e.next=6,this.request(this.url,{responseType:"xml",signal:n});case 6:if(i=e.sent,a=this._parseHeader(i.data),s=a.rasterInfo,o=a.files,-1!==(null===(r=this.ioConfig.skipExtensions)||void 0===r?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(c=e.sent)&&(s.statistics=null!==(u=c.statistics)&&void 0!==u?u:s.statistics,s.histograms=c.histograms,c.histograms&&(0,y.t)(s.statistics)&&(s.statistics=(0,F.j)(c.histograms)));case 15:return this._set("rasterInfo",s),this._files=o,e.next=18,this.request(o.index,{responseType:"array-buffer",signal:n});case 18:for(f=e.sent,this._storageIndex=this._parseIndex(f.data),h=this.rasterInfo.storageInfo,p=h.blockWidth,d=h.blockHeight,m=this.rasterInfo.storageInfo.pyramidScalingFactor,v=this.rasterInfo,x=v.width,g=v.height,b=[],k=this._getBandSegmentCount(),w=0,I=-1;w<this._storageIndex.length;)I++,S=Math.ceil(x/p/Math.pow(m,I))-1,R=Math.ceil(g/d/Math.pow(m,I))-1,w+=(S+1)*(R+1)*k*4,b.push({maxRow:R,maxCol:S,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=b,I>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=I),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I,S,R,T,_,Z,C,M,P,F,O,D,z,J=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=J.length>3&&void 0!==J[3]?J[3]:{},a=this.rasterInfo.storageInfo,s=a.blockWidth,o=a.blockHeight,u=a.blockBoundary,!(!(c=u[t])||c.maxRow<r||c.maxCol<n||c.minRow>r||c.minCol>n)){e.next=4;break}return e.abrupt("return",null);case 4:if(f=this.rasterInfo,h=f.bandCount,p=f.pixelType,d=this._getTileLocation(t,r,n),m=d.ranges,v=d.actualTileWidth,x=d.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return g=new Uint8Array(s*o),e.abrupt("return",new B.g({width:s,height:o,pixels:null,mask:g,validPixelCount:0}));case 10:for(b=this.ioConfig.bandIds,k=this._getBandSegmentCount(),w=[],I=0,I=0;I<k;I++)(!b||b.indexOf[I]>-1)&&w.push(this.request(this._files.data,{range:{from:m[I].from,to:m[I].to},responseType:"array-buffer",signal:i.signal}));return e.next=15,Promise.all(w);case 15:for(S=e.sent,R=S.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),T=new Uint8Array(R),_=0,I=0;I<k;I++)T.set(new Uint8Array(S[I].data),_),_+=S[I].data.byteLength;return Z=Ie.get(this.rasterInfo.storageInfo.compression).decoderFormat,e.next=23,this.decodePixelBlock(T.buffer,{width:s,height:o,format:Z,planes:(null===b||void 0===b?void 0:b.length)||h,pixelType:p});case 23:if(C=e.sent,(0,y.r)(this.rasterInfo.noDataValue)&&"lerc"!==Z&&!C.mask&&null!=(M=this.rasterInfo.noDataValue[0])){if(P=C.width*C.height,F=new Uint8Array(P),Math.abs(M)>1e24)for(I=0;I<P;I++)Math.abs((C.pixels[0][I]-M)/M)>1e-6&&(F[I]=1);else for(I=0;I<P;I++)C.pixels[0][I]!==M&&(F[I]=1);C.mask=F}if(O=0,D=0,v!==s||x!==o)if(z=C.mask)for(I=0;I<o;I++)if(D=I*s,I<x)for(O=v;O<s;O++)z[D+O]=0;else for(O=0;O<s;O++)z[D+O]=0;else for(z=new Uint8Array(s*o),C.mask=z,I=0;I<x;I++)for(D=I*s,O=0;O<v;O++)z[D+O]=1;return e.abrupt("return",C);case 28:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";var t,r,n,i,a,s;if(F.l){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(s=0;s<4;s++)n[4*a+s]=r[4*a+3-s];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}},{key:"_getBandSegmentCount",value:function(){return Ie.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}},{key:"_getTileLocation",value:function(e,t,r){var n,i,a,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.pyramidScalingFactor,c=this.rasterInfo,f=c.width,h=c.height,p=this._getBandSegmentCount(),d=0,m=0;for(a=0;a<e;a++)m=Math.pow(u,a),d+=(n=Math.ceil(f/o/m))*(i=Math.ceil(h/l/m));m=Math.pow(u,e),n=Math.ceil(f/o/m),i=Math.ceil(h/l/m),d+=t*n+r,d*=4*p;for(var v=this._storageIndex.subarray(d,d+4*p),y=0,x=0,g=[],b=0;b<p;b++)x=(y=v[4*b+0]*Math.pow(2,32)+v[4*b+1])+v[4*b+2]*Math.pow(2,32)+v[4*b+3],g.push({from:y,to:x});return{ranges:g,actualTileWidth:r<n-1?o:Math.ceil(f/m)-o*(n-1),actualTileHeight:t<i-1?l:Math.ceil(h/m)-l*(i-1)}}},{key:"_parseHeader",value:function(e){var t=oe(e,"MRF_META/Raster");if(!t)throw new d.s("mrf:open","not a valid MRF format");var r=oe(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),s=(le(t,"Compression")||"none").toLowerCase();if(!Ie.has(s))throw new d.s("mrf:open","currently does not support compression "+s);var o=le(t,"DataType")||"UInt8",l=we.get(o);if(null==l)throw new d.s("mrf:open","currently does not support pixel type "+o);var u,c,f=oe(t,"PageSize"),h=parseInt(f.getAttribute("x"),10),p=parseInt(f.getAttribute("y"),10),m=oe(t,"DataValues");if(m&&(null!=(c=m.getAttribute("NoData"))&&(u=c.trim().split(" ").map((function(e){return parseFloat(e)})))),oe(e,"MRF_META/CachedSource"))throw new d.s("mrf:open","currently does not support MRF referencing other data files");var v,y=oe(e,"MRF_META/GeoTags"),x=oe(y,"BoundingBox"),g=!1;if(null!=x){var b,w=parseFloat(x.getAttribute("minx")),I=parseFloat(x.getAttribute("miny")),S=parseFloat(x.getAttribute("maxx")),R=parseFloat(x.getAttribute("maxy")),T=le(y,"Projection")||"",_=k.k.WGS84;if("LOCAL_CS[]"!==T)if(T.toLowerCase().startsWith("epsg:")){var Z=Number(T.slice(5));isNaN(Z)||0===Z||(_=new k.k({wkid:Z}))}else _=null!==(b=me(T))&&void 0!==b?b:k.k.WGS84;else g=!0,_=new k.k({wkid:3857});(v=new J.w(w,I,S,R)).spatialReference=_}else g=!0,v=new J.w({xmin:-.5,ymin:.5-i,xmax:n-.5,ymax:.5,spatialReference:new k.k({wkid:3857})});var C=oe(e,"MRF_META/Rsets"),M=parseInt(C&&C.getAttribute("scale")||"2",10),P=v.spatialReference,O=new F.e({origin:new k.w({x:v.xmin,y:v.ymax,spatialReference:P}),blockWidth:h,blockHeight:p,pyramidBlockWidth:h,pyramidBlockHeight:p,compression:s,pyramidScalingFactor:M}),B=new k.w({x:v.width/n,y:v.height/i,spatialReference:P}),D=new F.b({width:n,height:i,extent:v,isPseudoSpatialReference:g,spatialReference:P,bandCount:a,pixelType:l,pixelSize:B,noDataValue:u,storageInfo:O}),z=le(e,"datafile"),N=le(e,"IndexFile");return{rasterInfo:D,files:{mrf:this.url,index:N||this.url.replace(".mrf",".idx"),data:z||this.url.replace(".mrf",Ie.get(s).blobExtension)}}}},{key:"_fetchAuxiliaryData",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",ye(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(X);(0,d.e)([(0,d.y)()],Se.prototype,"_files",void 0),(0,d.e)([(0,d.y)()],Se.prototype,"_storageIndex",void 0),(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],Se.prototype,"datasetFormat",void 0);var Re=Se=(0,d.e)([(0,d.n)("esri.layers.support.rasterIO.MRFRaster")],Se),Te=function(e,t){var r;return null===(r=e.get(t))||void 0===r?void 0:r.values},_e=function(e,t){var r,n;return null===(r=e.get(t))||void 0===r||null===(n=r.values)||void 0===n?void 0:n[0]},Ze=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,c.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return(0,f.Z)(r,[{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,u,c,f,h,p,m,v,x,g;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return r=t?(0,y.e)(t.signal):null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:r});case 5:if(n=e.sent,i=n.data){e.next=9;break}throw new d.s("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),a=(0,F.N)(i),s=a.littleEndian,u=a.firstIFDPos,c=a.isBigTiff,f=[],e.next=13,this._readIFDs(f,i,s,u,0,c?8:4,r);case 13:if(h=this._parseIFDs(f),p=h.imageInfo,m=h.rasterInfo,this._headerInfo=(0,o.Z)({littleEndian:s,isBigTiff:c,ifds:f},p),this._set("rasterInfo",m),p.isSupported){e.next=16;break}throw new d.s("tiffraster:open","this tiff is not supported: "+p.message);case 16:if(p.tileWidth){e.next=18;break}throw new d.s("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");case 18:if(v=this.ioConfig.skipExtensions,(x=void 0===v?[]:v).includes("aux.xml")){e.next=24;break}return e.next=22,this._fetchAuxiliaryMetaData(t);case 22:null!=(g=e.sent)&&this._processPAMInfo(g,m);case 24:if(e.t0=x.includes("vat.dbf")||1!==m.bandCount||"u8"!==m.pixelType,e.t0){e.next=30;break}return e.next=28,this._fetchAuxiliaryTable(t);case 28:m.attributeTable=e.sent,(0,y.r)(m.attributeTable)&&(m.keyProperties.DataType="thematic");case 30:this.updateTileInfo();case 31:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a,s,o,u,c,f,h,p,d,m,v,y,x,g,b,k,w,I,S,R,T,_,Z,C,M=this,P=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=P.length>3&&void 0!==P[3]?P[3]:{},null!==(i=this._headerInfo)&&void 0!==i&&i.isSupported&&!this.isBlockOutside(t,r,n)){e.next=3;break}return e.abrupt("return",null);case 3:if(s=this._getTileLocation(t,r,n)){e.next=6;break}return e.abrupt("return",null);case 6:return o=s.ranges,u=s.actualTileWidth,c=s.actualTileHeight,f=s.ifd,h=o.map((function(e){return M.request(M.url,{range:e,responseType:"array-buffer",signal:a.signal})})),e.next=13,Promise.all(h);case 13:if(p=e.sent,d=p.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===p.length?p[0].data:new ArrayBuffer(d),v=[0],y=[0],p.length>1)for(x=new Uint8Array(m),g=0,b=0;g<p.length;g++)k=p[g].data,x.set(new Uint8Array(k),b),v[g]=b,b+=k.byteLength,y[g]=k.byteLength;return w=this.getBlockWidthHeight(t),I=w.blockWidth,S=w.blockHeight,e.next=24,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:v,sizes:y},width:I,height:S,planes:null,pixelType:null});case 24:if(R=e.sent,u!==I||c!==S)if(C=R.mask)for(T=0;T<S;T++)if(Z=T*I,T<c)for(_=u;_<I;_++)C[Z+_]=0;else for(_=0;_<I;_++)C[Z+_]=0;else for(C=new Uint8Array(I*S),R.mask=C,T=0;T<c;T++)for(Z=T*I,_=0;_<u;_++)C[Z+_]=1;return e.abrupt("return",R);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIFDs",value:function(e){var t,r,n=(0,F.D)(e),i=n.width,a=n.height,s=n.tileWidth,l=n.tileHeight,u=n.planes,c=n.pixelType,f=n.compression,h=n.firstPyramidLevel,p=n.maximumPyramidLevel,d=n.pyramidBlockWidth,m=n.pyramidBlockHeight,v=n.tileBoundary,y=n.affine,x=n.metadata,g=me((null===(t=n.extent.spatialReference)||void 0===t?void 0:t.wkt)||(null===(r=n.extent.spatialReference)||void 0===r?void 0:r.wkid)),b=!1;null==g&&(b=!0,g=new k.k({wkid:3857}));var w=new J.w((0,o.Z)((0,o.Z)({},n.extent),{},{spatialReference:g})),I=new k.w(w?{x:w.xmin,y:w.ymax,spatialReference:g}:{x:0,y:0}),S=new F.e({blockWidth:s,blockHeight:l,pyramidBlockWidth:d,pyramidBlockHeight:m,compression:f,origin:I,firstPyramidLevel:h,maximumPyramidLevel:p,blockBoundary:v}),R=new k.w({x:(w.xmax-w.xmin)/i,y:(w.ymax-w.ymin)/a,spatialReference:g}),T=x?{BandProperties:x.bandProperties,DataType:x.dataType}:{},_=null,Z=_e(e[0],"PHOTOMETRICINTERPRETATION"),C=Te(e[0],"COLORMAP");if(3===Z&&(null===C||void 0===C?void 0:C.length)>3&&C.length%3==0){_=[];for(var M=C.length/3,P=0;P<M;P++)_.push([P,C[P]>>>8,C[P+M]>>>8,C[P+2*M]>>>8])}var O=new F.b({width:i,height:a,bandCount:u,pixelType:c,pixelSize:R,storageInfo:S,spatialReference:g,isPseudoSpatialReference:b,keyProperties:T,extent:w,colormap:_,statistics:x?x.statistics:null});return null!==y&&void 0!==y&&y.length&&(O.nativeExtent=new J.w({xmin:-.5,ymin:.5-a,xmax:i-.5,ymax:.5,spatialReference:g}),O.transform=new N.m({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),O.extent=O.transform.forwardTransform(O.nativeExtent),O.pixelSize=new k.w({x:(w.xmax-w.xmin)/i,y:(w.ymax-w.ymin)/a,spatialReference:g}),S.origin.x=-.5,S.origin.y=.5),{imageInfo:n,rasterInfo:O}}},{key:"_processPAMInfo",value:function(e,t){var r;if(t.statistics=null!==(r=e.statistics)&&void 0!==r?r:t.statistics,t.histograms=e.histograms,e.histograms&&(0,y.t)(t.statistics)&&(t.statistics=(0,F.j)(e.histograms)),e.transform&&(0,y.t)(t.transform)){t.transform=e.transform,t.nativeExtent=t.extent;var n=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new k.w({x:(n.xmax-n.xmin)/t.width,y:(n.ymax-n.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=n}t.spatialReference||(t.spatialReference=e.spatialReference)}},{key:"_readIFDs",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n,i,a){var s,o,u,c=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=c.length>5&&void 0!==c[5]?c[5]:4,o=c.length>6?c[6]:void 0,i){e.next=4;break}return e.abrupt("return",null);case 4:if(!(i>=r.byteLength||i<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:i+a,to:i+a+this._bufferSize},responseType:"array-buffer",signal:o});case 7:r=e.sent.data,a=i+a,i=0;case 10:return e.next=12,this._readIFD(r,n,i,a,F.m.TIFF_TAGS,s,o);case 12:if(u=e.sent,t.push(u.ifd),u.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this._readIFDs(t,r,n,u.nextIFD-a,a,s,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_readIFD",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n,i){var a,s,o,u,c,f,h,p,d,m,v,x,g,b,k,w,I=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=I.length>4&&void 0!==I[4]?I[4]:F.m.TIFF_TAGS,s=I.length>5&&void 0!==I[5]?I[5]:4,o=I.length>6?I[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(u=(0,F.G)(t,r,n,i,a,s)).success){e.next=25;break}if(h=[],null!==(c=u.ifd)&&void 0!==c&&c.forEach((function(e){e.values||h.push(e)})),!(h.length>0)){e.next=16;break}if(p=h.map((function(e){return e.offlineOffsetSize})).filter(y.r),d=Math.min.apply(null,p.map((function(e){return e[0]}))),!(Math.min.apply(null,p.map((function(e){return e[0]+e[1]})))-d<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:d,to:d+this._bufferSize},responseType:"array-buffer",signal:o});case 13:m=e.sent,v=m.data,t=v,i=d,h.forEach((function(e){return(0,F.q)(t,r,e,i)}));case 16:if(null===(f=u.ifd)||void 0===f||!f.has("GEOKEYDIRECTORY")){e.next=24;break}if(x=u.ifd.get("GEOKEYDIRECTORY"),!((g=null===x||void 0===x?void 0:x.values)&&g.length>4)){e.next=24;break}return b=g[0]+"."+g[1]+"."+g[2],e.next=22,this._readIFD(t,r,x.valueOffset+6-i,i,F.m.GEO_KEYS,2,o);case 22:k=e.sent,x.data=k.ifd,x.data&&x.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[b]});case 24:return e.abrupt("return",u);case 25:if(!u.requiredBufferSize||u.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:i,to:i+u.requiredBufferSize+4},responseType:"array-buffer",signal:o});case 28:return w=e.sent,e.abrupt("return",(t=w.data).byteLength<u.requiredBufferSize?null:this._readIFD(t,r,0,i,F.m.TIFF_TAGS,4,o));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getTileLocation",value:function(e,t,r){var n,i=this.rasterInfo.storageInfo,a=i.firstPyramidLevel,s=i.blockBoundary,o=0===e?0:e-(a-1),l=null===(n=this._headerInfo)||void 0===n?void 0:n.ifds[o];if(!l)return null;var u=(0,F.O)(l,this._headerInfo),c=Te(l,"TILEOFFSETS");if(void 0===c)return null;var f=Te(l,"TILEBYTECOUNTS"),h=s[o],p=h.minRow,d=h.minCol,m=h.maxRow,v=h.maxCol;if(t>m||r>v||t<p||r<d)return null;var y=_e(l,"IMAGEWIDTH"),x=_e(l,"IMAGELENGTH"),g=_e(l,"TILEWIDTH"),b=_e(l,"TILELENGTH"),k=u?this.rasterInfo.bandCount:1,w=k*t*(v+1)+r,I=[{from:c[w],to:c[w+k-1]+f[w+k-1]-1}];if(u){for(var S=!0,R=0;R<k;R++)if(c[w+R]+f[w+R]!==c[w+R+1]){S=!1;break}if(!S)for(var T=0;T<k;T++)I[T]={from:c[w+T],to:c[w+T]+f[w+T]-1}}var _=c[w],Z=f[w];return null==_||null==Z?null:{ranges:I,ifd:l,actualTileWidth:r===v&&y%g||g,actualTileHeight:t===m&&x%b||b}}},{key:"_fetchAuxiliaryMetaData",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",ye(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryTable",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,i=ee.parse(n),e.abrupt("return",null!==i&&void 0!==i&&i.recordSet?q.default.fromJSON(i.recordSet):null);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(X);(0,d.e)([(0,d.y)()],Ze.prototype,"_files",void 0),(0,d.e)([(0,d.y)()],Ze.prototype,"_headerInfo",void 0),(0,d.e)([(0,d.y)()],Ze.prototype,"_bufferSize",void 0),(0,d.e)([(0,d.y)({type:String,json:{write:!0}})],Ze.prototype,"datasetFormat",void 0);var Ce=Ze=(0,d.e)([(0,d.n)("esri.layers.support.rasterDatasets.TIFFRaster")],Ze),Me=new Map;Me.set("CRF",{desc:"Cloud Raster Format",constructor:ne}),Me.set("MRF",{desc:"Meta Raster Format",constructor:Re}),Me.set("TIFF",{desc:"GeoTIFF",constructor:Ce}),Me.set("RasterTileServer",{desc:"Raster Tile Server",constructor:ke}),Me.set("JPG",{desc:"JPG Raster Format",constructor:ge}),Me.set("PNG",{desc:"PNG Raster Format",constructor:ge}),Me.set("GIF",{desc:"GIF Raster Format",constructor:ge}),Me.set("BMP",{desc:"BMP Raster Format",constructor:ge});var Pe=function(){function e(){(0,c.Z)(this,e)}return(0,f.Z)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return Me.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s,o,u,c,f,h;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,n=t.ioConfig,i=t.sourceJSON,null==(a=t.datasetFormat)&&r.lastIndexOf(".")&&(a=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===a||"TIF"===a?a="TIFF":"JPG"!==a&&"JPEG"!==a&&"JFIF"!==a||(a="JPG"),r.toLowerCase().includes("/imageserver")&&!r.toLowerCase().includes("/wcsserver")&&(a="RasterTileServer"),s={url:r,sourceJSON:i,datasetFormat:a,ioConfig:null!==n&&void 0!==n?n:{bandIds:null,sampling:null}},!a||!this.supportedFormats.has(a)){e.next=12;break}if("CRF"!==a||null!==n&&void 0!==n&&n.enableCRF){e.next=7;break}throw new d.s("rasterfactory:open","cannot open raster: ".concat(r));case 7:return o=Me.get(a).constructor,u=new o(s),e.next=11,u.open({signal:t.signal});case 11:return e.abrupt("return",u);case 12:if(!a){e.next=14;break}throw new d.s("rasterfactory:open","not a supported format "+a);case 14:return c=Array.from(Me.keys()),f=0,h=function e(){return(a=c[f++])&&("CRF"!==a||null!==n&&void 0!==n&&n.enableCRF)?(o=Me.get(a).constructor,(u=new o(s)).open({signal:t.signal}).then((function(){return u})).catch((function(){return e()}))):null},e.abrupt("return",h());case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){Me.has(e.toUpperCase())||Me.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}(),Fe=function(e){(0,h.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;(0,c.Z)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i))).bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.title=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e}return(0,f.Z)(r,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?(0,o.Z)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=(0,y.r)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(d.w).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e=[new j.y({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})],t=this.rasterInfo,r=t.attributeTable,n=(0,y.r)(r)?r.fields:null;if(n){var i=n.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));e=e.concat(i)}var a=t.dataType,s=t.multidimensionalInfo;if(("vector-magdir"===a||"vector-uv"===a)&&(0,y.r)(s)){var o,l=null===(o=s.variables[0].unit)||void 0===o?void 0:o.trim(),u="Magnitude"+(l?" (".concat(l,")"):"");e.push(new j.y({name:"Raster.Magnitude",alias:u,domain:null,editable:!1,type:"double"})),e.push(new j.y({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return e}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"readRenderer",value:function(e,t,r){var n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,i=(0,v.u)(n,r)||void 0;if(null!=i)return i}},{key:"createPopupTemplate",value:function(e){return(0,U.p)({fields:this.rasterFields,title:this.title},e)}},{key:"write",value:function(e,t){var a=this.raster;if(this.loaded?"RasterTileServer"===a.datasetFormat&&("Raster"===a.tileType||"Map"===a.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return(0,n.Z)((0,i.Z)(r.prototype),"write",this).call(this,e,t);if(t&&t.messages){var s="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new d.s("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(s,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var r,n,i,a,s=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.raster){e.next=8;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=5;break}return e.next=5,this.raster.open();case 5:this.url=this.raster.url,e.next=19;break;case 8:return e.next=10,Pe.open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:(0,o.Z)((0,o.Z)({sampling:"closest"},this.ioConfig),{},{customFetchParameters:this.customParameters}),signal:t});case 10:if(r=e.sent,!this.rasterFunction){e.next=18;break}return n=(0,N.l)(this.rasterFunction.toJSON(),{raster:r}),i=new K({rasterFunction:n}),e.next=15,i.open();case 15:this.raster=i,e.next=19;break;case 18:this.raster=r;case 19:if(this.raster.rasterInfo){e.next=22;break}throw new d.s("imagery-tile-layer:load","cannot load resources on "+this.url);case 22:this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(a="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:(0,o.Z)((0,o.Z)({},this.sourceJSON),{},{minScale:0,maxScale:0}),this.read(a,{origin:"service"})),null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,g.l)((function(){return s.customParameters}),(function(e){s.raster.ioConfig.customFetchParameters=e})));case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}((0,I.n)((0,L.t)((0,E.c)((0,A.v)((0,S.o)(function(e){var t=function(e){(0,h.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,c.Z)(this,n),(e=t.apply(this,arguments))._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},e.bandIds=null,e.copyright=null,e.interpolation="nearest",e.multidimensionalDefinition=null,e.multidimensionalSubset=null,e.raster=null,e.rasterFunction=null,e.sourceJSON=null,e.symbolizer=null,e}return(0,f.Z)(n,[{key:"fullExtent",get:function(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.extent}},{key:"rasterInfo",get:function(){var e;return null===(e=this.raster)||void 0===e?void 0:e.rasterInfo}},{key:"spatialReference",get:function(){var e,t;return null!==(e=null===(t=this.rasterInfo)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:k.k.WGS84}},{key:"tileInfo",get:function(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.storageInfo.tileInfo}},{key:"url",set:function(e){this._set("url",(0,T.S)(e,Q))}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"convertVectorFieldData",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r){var n,i;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,y.t)(t)&&this.rasterInfo){e.next=2;break}return e.abrupt("return",null);case 2:return n=this._rasterJobHandler.instance,i=this.rasterInfo.dataType,e.abrupt("return",n?n.convertVectorFieldData({pixelBlock:t,dataType:i},r):(0,z.d)(t,i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFlowMesh",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r){var n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._rasterJobHandler.instance,e.abrupt("return",n?n.createFlowMesh(t,r):(0,z.f)(t.meshType,t.simulationSettings,t.flowData,(0,y.r)(r.signal)?r.signal:(new AbortController).signal));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"normalizeRasterFetchOptions",value:function(e){var t,r=(null!==(t=this.rasterInfo)&&void 0!==t?t:{}).multidimensionalInfo;if((0,y.t)(r))return e;var n=e.multidimensionalDefinition||this.multidimensionalDefinition;!(0,y.t)(n)&&n.length||(n=(0,Z.c)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));var i=e.timeExtent||this.timeExtent;if((0,y.r)(n)&&(0,y.r)(i)&&((0,y.r)(i.start)||(0,y.r)(i.end))){var s,l;n=n.map((function(e){return e.clone()}));var u=null===(s=r.variables.find((function(e){return e.name===n[0].variableName})))||void 0===s||null===(l=s.dimensions)||void 0===l?void 0:l.find((function(e){return"StdTime"===e.name})),c=n.find((function(e){return"StdTime"===e.dimensionName}));if(!u||!c)return(0,o.Z)((0,o.Z)({},e),{},{multidimensionalDefinition:null});var f=i.start,h=i.end,p=(0,y.t)(f)?null:f.getTime(),d=(0,y.t)(h)?null:h.getTime(),m=null!==p&&void 0!==p?p:d,v=null!==d&&void 0!==d?d:p;if((0,y.r)(u.values)){var x=u.values.filter((function(e){if(Array.isArray(e)){if(m===v)return e[0]<=m&&e[1]>=m;var t=e[0]<=m&&e[1]>m||e[0]<v&&e[1]>=v,r=e[0]>=m&&e[1]<=v||e[0]<m&&e[1]>v;return t||r}return m===v?e===m:e>=m&&e<=v}));if(x.length){var g=x.sort((function(e,t){var r,n,i,a;return m===v?(null!==(r=e[0])&&void 0!==r?r:e)-(null!==(n=t[0])&&void 0!==n?n:t):Math.abs((null!==(i=e[1])&&void 0!==i?i:e)-v)-Math.abs((null!==(a=t[1])&&void 0!==a?a:t)-v)}))[0];c.values=[g]}else n=null}else if(u.hasRegularIntervals&&u.extent){var b=(0,a.Z)(u.extent,2),k=b[0],w=b[1];m>w||v<k?n=null:c.values=m===v?[m]:[Math.max(k,m),Math.min(w,v)]}}return(0,y.r)(n)&&(0,Z.m)(n,this.multidimensionalSubset)?(0,o.Z)((0,o.Z)({},e),{},{multidimensionalDefinition:null}):(0,o.Z)((0,o.Z)({},e),{},{multidimensionalDefinition:n})}},{key:"updateRenderer",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t,r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.loaded,r=this.symbolizer,t&&r){e.next=3;break}return e.abrupt("return");case 3:if(JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer)){e.next=5;break}return e.abrupt("return");case 5:if(n=this._rasterJobHandler.instance,e.t0=n,!e.t0){e.next=13;break}return r.rendererJSON=(0,v.$)(this.renderer.toJSON()),r.bind(),e.next=12,n.updateSymbolizer(r);case 12:this._cachedRendererJson=this.renderer.toJSON();case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r){var n,i,a,s,u;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t&&t.pixelBlock,(0,y.r)(i)&&i.pixels&&i.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(s=this._rasterJobHandler.instance,u=null!==(n=this.bandIds)&&void 0!==n?n:[],!s){e.next=12;break}return e.next=9,s.symbolize((0,o.Z)((0,o.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize((0,o.Z)((0,o.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 13:return a=e.t0,e.abrupt("return",a);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){var n;return"RasterTileServer"===(null===(n=this.raster)||void 0===n?void 0:n.datasetFormat)?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||(0,y.t)(t))return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=(0,k.a)(e);return C.j.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,n,i){var a,s,u,c=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=c.length>3&&void 0!==c[3]?c[3]:{},r(this),!a.requestAsImageElement){e.next=4;break}return s=this.getTileUrl(t,n,i),e.abrupt("return",(0,R.U)(s,{responseType:"image",query:(0,o.Z)((0,o.Z)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:a.signal}).then((function(e){return e.data})));case 4:if(!(0,y.r)(this.rasterInfo.multidimensionalInfo)||(a=this.normalizeRasterFetchOptions(a),!(0,y.t)(a.multidimensionalDefinition))){e.next=7;break}return u=a.tileInfo||this.rasterInfo.storageInfo.tileInfo,e.abrupt("return",{extent:this.raster.getTileExtentFromTileInfo(t,n,i,u),pixelBlock:null});case 7:return e.next=9,this._initJobHandler();case 9:return e.next=11,this._updateRasterFunction();case 11:return"raster-shaded-relief"===this.renderer.type&&(a=(0,o.Z)((0,o.Z)({},a),{},{buffer:{cols:1,rows:1}})),e.abrupt("return",this.raster.fetchTile(t,n,i,a));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t,r,n){var i,a=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.length>3&&void 0!==a[3]?a[3]:{},!(0,y.r)(this.rasterInfo.multidimensionalInfo)||(i=this.normalizeRasterFetchOptions(i),!(0,y.t)(i.multidimensionalDefinition))){e.next=5;break}e.t0={extent:t,pixelBlock:null},e.next=10;break;case 5:return e.next=7,this._initJobHandler();case 7:return e.next=9,this._updateRasterFunction();case 9:e.t0=this.raster.fetchPixels(t,r,n,i);case 10:return e.abrupt("return",e.t0);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(t){var n,i=arguments;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.length>1&&void 0!==i[1]?i[1]:{},r(this),!(0,y.r)(this.rasterInfo.multidimensionalInfo)){e.next=4;break}if(this.rasterInfo.hasMultidimensionalTranspose&&((0,Z.f)(n.multidimensionalDefinition)||n.transposedVariableName||n.timeExtent)||(n=this.normalizeRasterFetchOptions(n),!(0,y.t)(n.multidimensionalDefinition))){e.next=4;break}return e.abrupt("return",{location:t,value:null});case 4:return e.abrupt("return",this.raster.identify(t,n));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t,r,n=null===(e=this.rasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if((0,y.t)(n)||"standard-time"!==(null===(t=this.rasterInfo)||void 0===t?void 0:t.dataType))return!1;var i=this.multidimensionalDefinition,a=null===i||void 0===i||null===(r=i[0])||void 0===r?void 0:r.variableName;return n.variables.some((function(e){return e.name===a&&(!(null!==i&&void 0!==i&&i[0].dimensionName)||e.dimensions.some((function(e){return"StdTime"===e.name})))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"getMultidimensionalSubsetVariables",value:function(e){var t=null!==e&&void 0!==e?e:this.rasterInfo.multidimensionalInfo;return(0,Z.d)(this.multidimensionalSubset,t)}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,Z.c)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new v.n;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){r(e),e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer(),"Function"===e.raster.datasetFormat&&e.raster.syncJobHandler()})).catch((function(){})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e;r(this);var t=(0,v.V)(this.rasterInfo,this.raster.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}},{key:"_configDefaultRenderer",value:function(){r(this);var e=this.raster.rasterInfo;if(this.bandIds||(this.bandIds=(0,v.L)(e)),!this.renderer){var t,n,i,a,s,o=(0,v.j)(e,{bandIds:this.bandIds,variableName:(0,y.r)(this.multidimensionalDefinition)?null===(t=this.multidimensionalDefinition[0])||void 0===t?void 0:t.variableName:null});"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===o.type&&((null!==(n=null===(i=e.statistics)||void 0===i?void 0:i[0].max)&&void 0!==n?n:0)>1e24||(null!==(a=null===(s=e.statistics)||void 0===s?void 0:s[0].min)&&void 0!==a?a:0)<-1e24)&&(o.dynamicRangeAdjustment=!0,o.statistics=null,"none"===o.stretchType&&(o.stretchType="min-max")),this.renderer=o}this.symbolizer?(this.symbolizer.rendererJSON=(0,v.$)(this.renderer.toJSON()),this.symbolizer.rasterInfo=e):this.symbolizer=new F.T({rendererJSON:this.renderer.toJSON(),rasterInfo:e});var l=this.symbolizer.bind();l.success||Q.warn("imagery-tile-mixin",l.error||"The given renderer is not supported by the layer.")}},{key:"_updateRasterFunction",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t,r,n,i,a,s,o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("imagery-tile"===this.type&&JSON.stringify(this.rasterFunction)!==JSON.stringify(this._cachedRasterFunctionJson)){e.next=2;break}return e.abrupt("return");case 2:if(r=this.raster,"Function"===(null===(t=r)||void 0===t?void 0:t.datasetFormat)&&(n=r.rasterFunction.getPrimaryRasters(),r=n.rasters[0]),!(i=this.rasterFunction)){e.next=14;break}return s=(0,N.l)(i.toJSON(),{raster:r}),(o=new K({rasterFunction:s})).rasterJobHandler=this._rasterJobHandler.instance,e.next=10,o.open();case 10:this._cachedRasterFunctionJson=null===(a=this.rasterFunction)||void 0===a?void 0:a.toJSON(),this.raster=o,e.next=15;break;case 14:this.raster=r;case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(e);function r(e){if(!e.raster||!e.rasterInfo)throw new d.s("imagery-tile","no raster")}return(0,d.e)([(0,d.y)()],t.prototype,"_cachedRendererJson",void 0),(0,d.e)([(0,d.y)()],t.prototype,"_cachedRasterFunctionJson",void 0),(0,d.e)([(0,d.y)()],t.prototype,"_compatibleFullExtent",void 0),(0,d.e)([(0,d.y)()],t.prototype,"_rasterJobHandler",void 0),(0,d.e)([(0,d.y)()],t.prototype,"bandIds",void 0),(0,d.e)([(0,d.y)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),(0,d.e)([(0,d.y)({json:{read:!1}})],t.prototype,"fullExtent",null),(0,d.e)([(0,d.y)()],t.prototype,"interpolation",void 0),(0,d.e)([(0,d.y)()],t.prototype,"ioConfig",void 0),(0,d.e)([(0,d.y)({type:[Z.p]})],t.prototype,"multidimensionalDefinition",void 0),(0,d.e)([(0,d.y)({type:v.c,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),(0,d.e)([(0,d.y)()],t.prototype,"raster",void 0),(0,d.e)([(0,d.y)({type:v.w})],t.prototype,"rasterFunction",void 0),(0,d.e)([(0,d.y)()],t.prototype,"rasterInfo",null),(0,d.e)([(0,d.y)()],t.prototype,"sourceJSON",void 0),(0,d.e)([(0,d.y)({json:{read:!1}})],t.prototype,"spatialReference",null),(0,d.e)([(0,d.y)({json:{read:!1}})],t.prototype,"tileInfo",null),(0,d.e)([(0,d.y)(_.f)],t.prototype,"url",null),(0,d.e)([(0,d.y)({types:v.l})],t.prototype,"renderer",null),(0,d.e)([(0,d.y)()],t.prototype,"symbolizer",void 0),t=(0,d.e)([(0,d.n)("esri.layers.ImageryTileMixin")],t)}((0,W.a)((0,H.p)((0,x.O)(w.b))))))))));(0,d.e)([(0,d.y)({type:[d.T],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],Fe.prototype,"bandIds",void 0),(0,d.e)([(0,d.y)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,b.r)(v.o)],Fe.prototype,"interpolation",void 0),(0,d.e)([(0,d.y)({json:{write:!0}})],Fe.prototype,"multidimensionalDefinition",void 0),(0,d.e)([(0,d.y)(_.c)],Fe.prototype,"legendEnabled",void 0),(0,d.e)([(0,d.y)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],Fe.prototype,"isReference",void 0),(0,d.e)([(0,d.y)({type:["show","hide"]})],Fe.prototype,"listMode",void 0),(0,d.e)([(0,d.y)({json:{read:!0,write:!0}})],Fe.prototype,"blendMode",void 0),(0,d.e)([(0,d.y)()],Fe.prototype,"sourceJSON",void 0),(0,d.e)([(0,d.y)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],Fe.prototype,"version",void 0),(0,d.e)([(0,d.y)()],Fe.prototype,"title",void 0),(0,d.e)([(0,d.y)({readOnly:!0,json:{read:!1}})],Fe.prototype,"type",void 0),(0,d.e)([(0,d.y)({type:["ArcGISTiledImageServiceLayer"]})],Fe.prototype,"operationalLayerType",void 0),(0,d.e)([(0,d.y)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],Fe.prototype,"popupEnabled",void 0),(0,d.e)([(0,d.y)({type:m.k,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],Fe.prototype,"popupTemplate",void 0),(0,d.e)([(0,d.y)({readOnly:!0})],Fe.prototype,"defaultPopupTemplate",null),(0,d.e)([(0,d.y)({readOnly:!0,type:[j.y]})],Fe.prototype,"fields",void 0),(0,d.e)([(0,d.y)({readOnly:!0,type:[j.y]})],Fe.prototype,"rasterFields",null),(0,d.e)([(0,d.y)({types:v.l,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:v.a,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type&&"flow"!==e.type}}}}}}})],Fe.prototype,"renderer",null),(0,d.e)([(0,k.o)("renderer")],Fe.prototype,"readRenderer",null);var Oe=Fe=(0,d.e)([(0,d.n)("esri.layers.ImageryTileLayer")],Fe);t.default=Oe},39926:function(e,t,r){r.d(t,{e:function(){return s}});var n=r(15671),i=r(43144),a=r(6762),s=function(){function e(t,r){(0,n.Z)(this,e),this._storage=new a.h,this._storage.maxSize=t,r&&this._storage.registerRemoveFunc("",r)}return(0,i.Z)(e,[{key:"put",value:function(e,t,r){this._storage.put(e,t,r,1)}},{key:"pop",value:function(e){return this._storage.pop(e)}},{key:"get",value:function(e){return this._storage.get(e)}},{key:"clear",value:function(){this._storage.clearAll()}},{key:"destroy",value:function(){this._storage.destroy()}},{key:"maxSize",get:function(){return this._storage.maxSize},set:function(e){this._storage.maxSize=e}}]),e}()},72215:function(e,t,r){r.d(t,{a:function(){return f},d:function(){return y},f:function(){return p},g:function(){return g},h:function(){return v},m:function(){return d},u:function(){return h},x:function(){return m}});var n=r(15671),i=r(43144),a=(r(74384),r(93661)),s=r(31532),o=r(82474),l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;(0,n.Z)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return(0,i.Z)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.refCount--,i.refCount<=0&&(n.delete(r),i.controller&&i.controller.abort()),i.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.ts=Date.now(),i.refCount++,n.delete(r),n.set(r,i),i.block}return null}},{key:"putBlock",value:function(e,t,r,n){var i=this._cachedBlocks,a=e+"/"+t;if(i.has(a)){var s=i.get(a);s.ts=Date.now(),s.refCount++}else i.set(a,{block:r,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this._trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this._clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"_updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),i=0;i<r.length&&r[i][1].ts<=n-e._duration;i++)t.delete(r[i][0]);0===t.size&&e._clearTimer()}),this._interval)}}},{key:"_trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"_clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),u=new Map,c=new l;function f(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function h(e,t){var r={extent:null,rasterInfo:t,cache:new Map},n=u.get(e);return n?(n.push(r),n.length-1):(u.set(e,[r]),0)}function p(e,t){var r=u.get(e);r&&(r[t]=null,r.some((function(e){return null!=e}))||u.delete(e))}function d(e,t,r){var n,i=u.get(e);if(!i)return null==t?c.decreaseRefCount(e,r):0;if(null==t||null==i[t])return c.decreaseRefCount(e,r);var a=null===(n=i[t])||void 0===n?void 0:n.cache,s=null===a||void 0===a?void 0:a.get(r);if(a&&s){if(s.refCount--,0===s.refCount){a.delete(r);for(var o=0;o<i.length;o++){var l;null===(l=i[o])||void 0===l||l.cache.delete(r)}s.controller&&s.controller.abort()}return s.refCount}return 0}function m(e,t,r){var n,i=u.get(e);if(!i)return null==t?c.getBlock(e,r):null;if(null==t||null==i[t]){for(var a=0;a<i.length;a++){var s,o=null===(s=i[a])||void 0===s?void 0:s.cache.get(r);if(o)return o.refCount++,o.block}return c.getBlock(e,r)}var l=null===(n=i[t])||void 0===n?void 0:n.cache.get(r);if(l)return l.refCount++,l.block;for(var f=0;f<i.length;f++){var h;if(f!==t&&i[f]){var p=null===(h=i[f])||void 0===h?void 0:h.cache,d=null===p||void 0===p?void 0:p.get(r);if(p&&d)return d.refCount++,p.set(r,d),d.block}}return null}function v(e,t,r,n){var i,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=u.get(e);if(s)if(null!=t&&null!=s[t]){var o={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return o.isResolved=!0})).catch((function(){return o.isRejected=!0})),null===(i=s[t])||void 0===i||i.cache.set(r,o)}else c.putBlock(e,r,n,a);else null==t&&c.putBlock(e,r,n,a)}function y(e,t,r){var n,i=u.get(e);i?null!=t&&null!=i[t]?null===(n=i[t])||void 0===n||n.cache.delete(r):c.deleteBlock(e,r):null==t&&c.deleteBlock(e,r)}function x(e,t){var r,n=u.get(e);return n&&null!==(r=n[t])&&void 0!==r?r:null}function g(e,t,r,n,i,l){var u,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,f=x(e,t);if(f){var h=f.extent,p=f.cache,d=f.rasterInfo;if(!h||h.xmin!==r.xmin||h.xmax!==r.xmax||h.ymin!==r.ymin||h.ymax!==r.ymax){n=null!==(u=n)&&void 0!==u?u:0;for(var m=r.clone().normalize(),v=d.spatialReference,y=d.transform,g=new Set,b=0;b<m.length;b++){var k=m[b];if(!(k.xmax-k.xmin<=n||k.ymax-k.ymin<=n)){var w=(0,s.J)(k,v,c);(0,a.r)(y)&&(w=y.inverseTransform(w));var I=new o.w({x:n,y:n,spatialReference:k.spatialReference});if(null==i&&!(i=(0,s.C)(I,v,k,c)))return;var S=(0,s.o)(i,d,l||"closest"),R=S.pyramidLevel,T=S.pyramidResolution,_=S.excessiveReading;if(_)return;for(var Z=d.storageInfo,C=Z.origin,M={x:Math.max(0,Math.floor((w.xmin-C.x)/T.x)),y:Math.max(0,Math.floor((C.y-w.ymax)/T.y))},P=Math.ceil((w.xmax-w.xmin)/T.x-.1),F=Math.ceil((w.ymax-w.ymin)/T.y-.1),O=R>0?Z.pyramidBlockWidth:Z.blockWidth,B=R>0?Z.pyramidBlockHeight:Z.blockHeight,D=1,z=Math.max(0,Math.floor(M.x/O)-D),J=Math.max(0,Math.floor(M.y/B)-D),N=Math.floor((M.x+P-1)/O)+D,E=Math.floor((M.y+F-1)/B)+D,A=J;A<=E;A++)for(var H=z;H<=N;H++)g.add("".concat(R,"/").concat(A,"/").concat(H))}}p.forEach((function(e,t){if(!g.has(t)){var r=p.get(t);(null==r||r.isResolved||r.isRejected)&&p.delete(t)}})),f.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}}},63212:function(e,t,r){r.d(t,{U:function(){return M},i:function(){return y},r:function(){return v},s:function(){return x},v:function(){return Z}});var n=r(74165),i=r(1413),a=r(29439),s=r(15861),o=r(37762),l=r(93661),u=r(48848),c=r(74384),f=r(82474),h=r(56162),p=r(40558),d=r(39994),m=r(69717),v={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new c.m({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:f.k.WebMercator}),minus180Line:new c.m({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:f.k.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new c.m({paths:[[[180,-180],[180,180]]],spatialReference:f.k.WGS84}),minus180Line:new c.m({paths:[[[-180,-180],[-180,180]]],spatialReference:f.k.WGS84})}};function y(e,t){return Math.ceil((e-t)/(2*t))}function x(e,t){var r,n=g(e),i=(0,o.Z)(n);try{for(i.s();!(r=i.n()).done;){var a,s=r.value,l=(0,o.Z)(s);try{for(l.s();!(a=l.n()).done;){a.value[0]+=t}}catch(u){l.e(u)}finally{l.f()}}}catch(u){i.e(u)}finally{i.f()}return e}function g(e){return(0,h.y)(e)?e.rings:e.paths}function b(e,t,r,n){return k.apply(this,arguments)}function k(){return k=(0,s.Z)((0,n.Z)().mark((function e(t,r,a,s){var o,l,u,c,f,m,v,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(0,d.f)(t),l=r[0].spatialReference,u=(0,i.Z)((0,i.Z)({},s),{},{query:(0,i.Z)((0,i.Z)({},o.query),{},{f:"json",sr:JSON.stringify(l),target:JSON.stringify({geometryType:(0,h.c)(r[0]),geometries:r}),cutter:JSON.stringify(a)})}),e.next=5,(0,p.U)(o.path+"/cut",u);case 5:return c=e.sent,f=c.data,m=f.cutIndexes,v=f.geometries,y=void 0===v?[]:v,e.abrupt("return",{cutIndexes:m,geometries:y.map((function(e){var t=(0,h.v)(e);return t.spatialReference=l,t}))});case 11:case"end":return e.stop()}}),e)}))),k.apply(this,arguments)}function w(e,t,r){return I.apply(this,arguments)}function I(){return I=(0,s.Z)((0,n.Z)().mark((function e(t,r,a){var s,o,l,u,c,f;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s="string"==typeof t?(0,p.j)(t):t,o=r[0].spatialReference,l=(0,h.c)(r[0]),u=(0,i.Z)((0,i.Z)({},a),{},{query:(0,i.Z)((0,i.Z)({},s.query),{},{f:"json",sr:o.wkid?o.wkid:JSON.stringify(o),geometries:JSON.stringify((0,m.r)(r))})}),e.next=6,(0,p.U)(s.path+"/simplify",u);case 6:return c=e.sent,f=c.data,e.abrupt("return",(0,m.o)(f.geometries,l,o));case 9:case"end":return e.stop()}}),e)}))),I.apply(this,arguments)}var S=u.a.getLogger("esri.geometry.support.normalizeUtils");function R(e,t,r){if(t){var n=function(e,t){if(!(e instanceof c.m||e instanceof c.v)){var r="straightLineDensify: the input geometry is neither polyline nor polygon";throw S.error(r),new u.s(r)}var n,i=g(e),a=[],s=(0,o.Z)(i);try{for(s.s();!(n=s.n()).done;){var l=n.value,f=[];a.push(f),f.push([l[0][0],l[0][1]]);for(var h=0;h<l.length-1;h++){var p=l[h][0],d=l[h][1],m=l[h+1][0],v=l[h+1][1],y=Math.sqrt((m-p)*(m-p)+(v-d)*(v-d)),x=(v-d)/y,b=(m-p)/y,k=y/t;if(k>1){for(var w=1;w<=k-1;w++){var I=w*t,R=b*I+p,T=x*I+d;f.push([R,T])}var _=(y+Math.floor(k-1)*t)/2,Z=b*_+p,C=x*_+d;f.push([Z,C])}f.push([m,v])}}}catch(M){s.e(M)}finally{s.f()}return function(e){return"polygon"===e.type}(e)?new c.v({rings:a,spatialReference:e.spatialReference}):new c.m({paths:a,spatialReference:e.spatialReference})}(e,1e6);e=(0,f.j)(n,!0)}return r&&(e=x(e,r)),e}function T(e,t,r){if(Array.isArray(e)){var n=e[0];if(n>t){var i=y(n,t);e[0]=n+i*(-2*t)}else if(n<r){var a=y(n,r);e[0]=n+a*(-2*r)}}else{var s=e.x;if(s>t){var o=y(s,t);e=e.clone().offset(o*(-2*t),0)}else if(s<r){var l=y(s,r);e=e.clone().offset(l*(-2*r),0)}}return e}function _(e,t){for(var r=-1,n=function(n){for(var i=t.cutIndexes[n],a=t.geometries[n],s=g(a),l=function(e){var t=s[e];t.some((function(r){if(r[0]<180)return!0;for(var n=0,i=0;i<t.length;i++){var s=t[i][0];n=s>n?s:n}for(var o=-360*y(n=Number(n.toFixed(9)),180),l=0;l<t.length;l++){var u=a.getPoint(e,l);a.setPoint(e,l,u.clone().offset(o,0))}return!0}))},u=0;u<s.length;u++)l(u);if(i===r){if(function(e){return"polygon"===e[0].type}(e)){var c,f=(0,o.Z)(g(a));try{for(f.s();!(c=f.n()).done;){var h=c.value;e[i]=e[i].addRing(h)}}catch(v){f.e(v)}finally{f.f()}}else if(function(e){return"polyline"===e[0].type}(e)){var p,d=(0,o.Z)(g(a));try{for(d.s();!(p=d.n()).done;){var m=p.value;e[i]=e[i].addPath(m)}}catch(v){d.e(v)}finally{d.f()}}}else r=i,e[i]=a},i=0;i<t.cutIndexes.length;i++)n(i);return e}function Z(e,t,r){return C.apply(this,arguments)}function C(){return C=(0,s.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,u,h,p,d,m,g,k,I,C,M,P,F,O,B,D,z,J,N,E,A,H,L,W,j,q,G,U,V,X,Y,K,Q,$,ee,te,re,ne,ie,ae;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Array.isArray(t)){e.next=2;break}return e.abrupt("return",Z([t],r));case 2:r&&"string"!=typeof r&&S.warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead"),s="string"==typeof r?r:null!==(a=null===r||void 0===r?void 0:r.url)&&void 0!==a?a:l.s.geometryServiceUrl,C=0,M=[],P=[],F=(0,o.Z)(t);try{for(F.s();!(O=F.n()).done;)B=O.value,(0,l.t)(B)?P.push(B):(u||(u=B.spatialReference,h=(0,f.a)(u),p=u.isWebMercator,d=v[g=p?102100:4326].maxX,m=v[g].minX,k=v[g].plus180Line,I=v[g].minus180Line),h?"mesh"===B.type?P.push(B):"point"===B.type?P.push(T(B.clone(),d,m)):"multipoint"===B.type?((D=B.clone()).points=D.points.map((function(e){return T(e,d,m)})),P.push(D)):"extent"===B.type?(z=B.clone()._normalize(!1,!1,h),P.push(z.rings?new c.v(z):z)):B.extent?(J=B.extent,N=y(J.xmin,m)*(2*d),E=0===N?B.clone():x(B.clone(),N),J.offset(N,0),J.intersects(k)&&J.xmax!==d?(C=J.xmax>C?J.xmax:C,E=R(E,p),M.push(E),P.push("cut")):J.intersects(I)&&J.xmin!==m?(C=J.xmax*(2*d)>C?J.xmax*(2*d):C,E=R(E,p,360),M.push(E),P.push("cut")):P.push(E)):P.push(B.clone()):P.push(B))}catch(n){F.e(n)}finally{F.f()}for(A=y(C,d),H=-90,L=A,W=new c.m;A>0;)j=360*A-180,W.addPath([[j,H],[j,-1*H]]),H*=-1,A--;if(!(M.length>0&&L>0)){e.next=29;break}return e.t0=_,e.t1=M,e.next=16,b(s,M,W,i);case 16:for(e.t2=e.sent,q=(0,e.t0)(e.t1,e.t2),G=[],U=[],V=0;V<P.length;V++)"cut"!==(X=P[V])?U.push(X):(Y=q.shift(),K=t[V],(0,l.r)(K)&&"polygon"===K.type&&K.rings&&K.rings.length>1&&Y.rings.length>=K.rings.length?(G.push(Y),U.push("simplify")):U.push(p?(0,f.R)(Y):Y));if(G.length){e.next=23;break}return e.abrupt("return",U);case 23:return e.next=25,w(s,G,i);case 25:for(Q=e.sent,$=[],ee=0;ee<U.length;ee++)"simplify"!==(te=U[ee])?$.push(te):$.push(p?(0,f.R)(Q.shift()):Q.shift());return e.abrupt("return",$);case 29:for(re=[],ne=0;ne<P.length;ne++)"cut"!==(ie=P[ne])?re.push(ie):(ae=M.shift(),re.push(!0===p?(0,f.R)(ae):ae));return e.abrupt("return",re);case 32:case"end":return e.stop()}}),e)}))),C.apply(this,arguments)}function M(e,t){var r=(0,f.a)(t);if(r){var n=(0,a.Z)(r.valid,2),i=n[0],s=n[1],o=s-i;if(e<i)for(;e<i;)e+=o;if(e>s)for(;e>s;)e-=o}return e}},50690:function(e,t,r){r.d(t,{P:function(){return h},U:function(){return p},a:function(){return l},f:function(){return s},h:function(){return d},j:function(){return u},l:function(){return a},w:function(){return m}});var n=r(48848),i=r(93661);function a(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return o(e,t,r,c)}function s(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return o(e,t,r,f)}function o(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,s=null,o=r.once?function(e,r){a(e)&&((0,i.f)(s),t(e,r))}:function(e,r){a(e)&&t(e,r)};if(s=(0,n.P)(e,o,r.sync,r.equals),r.initial){var l=e();o(l,l)}return s}function l(e,t,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=null,l=null,u=null;function c(){var e;o&&l&&(l.remove(),null!==(e=s.onListenerRemove)&&void 0!==e&&e.call(s,o),o=null,l=null)}function f(e){s.once&&s.once&&(0,i.f)(u),r(e)}var h=a(e,(function(e,r){var i;c(),(0,n.B)(e)&&(o=e,l=(0,n.C)(e,t,f),null===(i=s.onListenerAdd)||void 0===i||i.call(s,e))}),{sync:s.sync,initial:!0});return u=(0,n.D)((function(){h.remove(),c()}))}function u(e,t){return function(e,t,r){if((0,n.p)(r))return Promise.reject((0,n.d)());var a=e();if(null!==t&&void 0!==t&&t(a))return Promise.resolve(a);var s=null;function l(){s=(0,i.f)(s)}return new Promise((function(i,a){s=(0,n.F)([(0,n.v)(r,(function(){l(),a((0,n.d)())})),o(e,(function(e){l(),i(e)}),{sync:!1,once:!0},null!==t&&void 0!==t?t:c)])}))}(e,f,t)}function c(e){return!0}function f(e){return!!e}function h(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=!1,i=a(e,(function(e,r){n||t(e,r)}),r);return{remove:function(){i.remove()},pause:function(){n=!0},resume:function(){n=!1}}}var p={sync:!0},d={initial:!0},m={sync:!0,initial:!0}},69717:function(e,t,r){r.d(t,{o:function(){return a},r:function(){return i}});var n=r(56162);function i(e){return{geometryType:(0,n.c)(e[0]),geometries:e.map((function(e){return e.toJSON()}))}}function a(e,t,r){var i=(0,n.d)(t);return e.map((function(e){var t=i.fromJSON(e);return t.spatialReference=r,t}))}},39994:function(e,t,r){r.d(t,{f:function(){return o},i:function(){return s},s:function(){return l}});var n=r(1413),i=r(93661),a=r(40558);function s(e,t){return t?(0,n.Z)((0,n.Z)({},t),{},{query:(0,n.Z)((0,n.Z)({},e),t.query)}):{query:e}}function o(e){return"string"==typeof e?(0,a.j)(e):(0,i.y)(e)}function l(e,t,r){var n={};for(var i in e)if("declaredClass"!==i){var a=e[i];if(null!=a&&"function"!=typeof a)if(Array.isArray(a)){n[i]=[];for(var s=0;s<a.length;s++)n[i][s]=l(a[s])}else if("object"==typeof a)if(a.toJSON){var o=a.toJSON(r&&r[i]);n[i]=t?o:JSON.stringify(o)}else n[i]=t?a:JSON.stringify(a);else n[i]=a}return n}}}]);
//# sourceMappingURL=2913.b4e51d01.chunk.js.map