"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[3609],{73609:function(e,t,r){r.r(t),r.d(t,{createConnection:function(){return R}});var n=r(1413),o=r(37762),s=r(74165),a=r(15861),i=r(15671),c=r(43144),u=r(60136),l=r(29388),f=r(48848),d=(r(74384),r(40558)),h=r(93661),p=r(65415),v=r(37856),g=r(49871),y=r(35237),k=r(56162),w=r(82474),_=(r(46817),r(47855),r(63212),r(39994),r(69717),r(53409),r(35182),r(62466),r(51816),r(89181),r(40114),r(20302),r(69641),r(15436),r(69768),r(62610),function(e){(0,u.Z)(r,e);var t=(0,l.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,c.Z)(r,[{key:"connectionError",get:function(){return this.errorString?new f.s("stream-connection",this.errorString):null}},{key:"onFeature",value:function(e){this.emit("data-received",e)}}]),r}(v.n.EventedAccessor));(0,f.e)([(0,f.y)({readOnly:!0})],_.prototype,"connectionError",null);var b,m,x=_=(0,f.e)([(0,f.n)("esri.layers.support.StreamConnection")],_);(m=b||(b={}))[m.CONNECTING=0]="CONNECTING",m[m.OPEN=1]="OPEN",m[m.CLOSING=2]="CLOSING",m[m.CLOSED=3]="CLOSED";var S=function(e){(0,u.Z)(r,e);var t=(0,l.Z)(r);function r(e){var n;(0,i.Z)(this,r),(n=t.call(this)).errorString=null;var o=e.geometryType,s=e.spatialReference,a=e.sourceSpatialReference;return n._config=e,n._featureZScaler=(0,p.o)(o,a,s),n._open(),n}return(0,c.Z)(r,[{key:"_open",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,h.r)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if((0,h.t)(this._websocket))return"disconnected";switch(this._websocket.readyState){case b.CONNECTING:case b.OPEN:return"connected";case b.CLOSING:case b.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(){var t,r,n,o,a,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=i.length>0&&void 0!==i[0]?i[0]:this._config.source.path,r=i.length>1&&void 0!==i[1]?i[1]:1e3,n=i.length>2&&void 0!==i[2]?i[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return o=(0,d.B)(t,this._config.customParameters),e.next=9,this._createWebSocket(o);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),a=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(f.a.getLogger(this.declaredClass).error(new f.s("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return f.a.getLogger(this.declaredClass).error(new f.s("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(a,"s"),e.t0)),e.next=23,(0,f.ab)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var o=new WebSocket(e);o.onopen=function(){if(o.onopen=null,t.destroyed)return o.onclose=null,void o.close();o.onclose=function(e){return t._onClose(e)},o.onerror=function(e){return t._onError(e)},o.onmessage=function(e){return t._onMessage(e)},r(o)},o.onclose=function(e){o.onopen=o.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(){var t,r,n,o,a,i,c,u,l=this,d=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=d.length>0&&void 0!==d[0]?d[0]:1e4,r=this._websocket,!(0,h.t)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=(0,f.ap)(),o=r.onmessage,a=this._config,i=a.filter,c=a.outFields,u=a.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,s=null;try{s=JSON.parse(e.data)}catch(_){}s&&"object"==typeof s||(f.a.getLogger(l.declaredClass).error(new f.s("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),l.destroy()),(null===(t=s.spatialReference)||void 0===t?void 0:t.wkid)!==(null===u||void 0===u?void 0:u.wkid)&&(f.a.getLogger(l.declaredClass).error(new f.s("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(u.wkid),e.data)),n.reject(),l.destroy()),"json"!==s.format&&(f.a.getLogger(l.declaredClass).error(new f.s("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),l.destroy()),i&&s.filter!==i&&f.a.getLogger(l.declaredClass).error(new f.s("websocket-connection","Tried to set filter, but server doesn't support it")),c&&s.outFields!==c&&f.a.getLogger(l.declaredClass).error(new f.s("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=o,n.resolve()},r.send(JSON.stringify({filter:i,outFields:c,format:"json",spatialReference:{wkid:u.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new f.s("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=(0,o.Z)(t.features);try{for(n.s();!(r=n.n()).done;){var s=r.value;(0,h.r)(this._featureZScaler)&&this._featureZScaler(s.geometry),this.onFeature(s)}}catch(a){n.e(a)}finally{n.f()}}catch(i){return f.a.getLogger(this.declaredClass).error(new f.s("websocket-connection","Failed to parse message",i)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),f.a.getLogger(this.declaredClass).error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&f.a.getLogger(this.declaredClass).error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(x);(0,f.e)([(0,f.y)()],S.prototype,"connectionStatus",null),(0,f.e)([(0,f.y)()],S.prototype,"errorString",void 0),S=(0,f.e)([(0,f.n)("esri.layers.graphics.sources.connections.WebSocketConnection")],S);var Z={maxQueryDepth:5,maxRecordCountFactor:3},C=function(e){(0,u.Z)(p,e);var t=(0,l.Z)(p);function p(e){return(0,i.Z)(this,p),t.call(this,(0,n.Z)((0,n.Z)({},Z),e))}return(0,c.Z)(p,[{key:"_open",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(){var t,r,n,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||f.a.getLogger(this.declaredClass).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,o=n.filter,a=n.outFields,this.destroyed||this._setFilter(o,a);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),(0,h.r)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void f.a.getLogger(this.declaredClass).error(new f.s("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t){var r,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,n.Z)({f:"json"},this._config.customParameters),o=(0,d.U)(t.path,{query:r,responseType:"json"}),e.next=4,o;case 4:return a=e.sent.data,e.abrupt("return",(this._serviceDefinition=a,a));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,o=r.token,s=this._inferWebSocketBaseUrl(n);return(0,d.B)("".concat(s,"/subscribe"),{outSR:""+t.wkid,token:o})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=(0,o.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.includes("wss"))return n}}catch(s){r.e(s)}finally{r.f()}return f.a.getLogger(this.declaredClass).error(new f.s("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t,r){var n,o,a,i,c,u,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!((0,h.t)(n)||(0,h.t)(t)&&(0,h.t)(r))){e.next=3;break}return e.abrupt("return");case 3:return o=JSON.stringify({filter:this._serializeFilter(t,r)}),a=!1,i=(0,f.ap)(),c=function(){a||(l.destroyed||l._websocket!==n||f.a.getLogger(l.declaredClass).error(new f.s("geoevent-connection","Server timed out when setting filter")),i.reject())},u=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(f.a.getLogger(l.declaredClass).error(new f.s("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),i.reject(t.error)),n.onmessage=l._onMessage.bind(l),a=!0,i.resolve())},e.abrupt("return",(n.onmessage=u,n.send(o),setTimeout(c,1e4),i.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if((0,h.t)(e)&&(0,h.t)(t))return r;if((0,h.r)(e)&&e.geometry)try{var n=(0,k.v)(e.geometry);if("extent"!==n.type)throw new f.s("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(o){f.a.getLogger(this.declaredClass).error(new f.s("geoevent-connection","Encountered an error when setting connection geometryDefinition",o))}return(0,h.r)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),(0,h.r)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return f.a.getLogger(this.declaredClass).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),o=n.attributes,s=n.geometry;for(var a in o)e.attributes[a]=o[a];return s&&(e.geometry=s),e.geometry||e.centroid||f.a.getLogger(this.declaredClass).error(new f.s("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(){var t,r,n,a,i,c,u,l,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,a=this._queryRelatedFeatures(r),i=this._queryArchive(n),e.next=4,a;case 4:return e.next=6,i;case 6:if(c=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=(0,o.Z)(c.features);try{for(u.s();!(l=u.n()).done;)d=l.value,this.onFeature(this._enrich(d))}catch(s){u.e(s)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),f.a.getLogger(this.declaredClass).error(new f.s("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t){var n,o,a,i,c,u,l,f,d,p,v;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(630),r.e(3103),r.e(7944),r.e(5577),r.e(2821),r.e(2959),r.e(5113),r.e(6570),r.e(7093),r.e(4581),r.e(1517),r.e(727),r.e(8987),r.e(1015),r.e(4221)]).then(r.bind(r,98987));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(o=e.sent,a=o.capabilities,i=a.query.supportsMaxRecordCountFactor,c=a.query.supportsPagination,u=a.query.supportsCentroid,l=this._config.maxRecordCountFactor,f=n.capabilities.query.maxRecordCount,d=i?f*l:f,(p=new y.x).outFields=(0,h.v)(this._config.outFields,["*"]),p.where=(0,h.v)((0,h.q)(this._config.filter,"where"),"1=1"),p.returnGeometry=!0,p.returnExceededLimitFeatures=!0,p.outSpatialReference=w.k.fromJSON(this._config.spatialReference),u&&(p.returnCentroid=!0),i&&(p.maxRecordCountFactor=l),!c){e.next=18;break}return e.abrupt("return",(p.num=d,n.destroy(),this._queryPages(t,p)));case 18:return e.next=20,(0,g.c)(t,p,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=(0,a.Z)((0,s.Z)().mark((function e(t,r){var n,o,a,i,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>2&&void 0!==c[2]?c[2]:[],o=c.length>3&&void 0!==c[3]?c[3]:0,r.start=(0,h.r)(r.num)?o*r.num:null,e.next=5,(0,g.c)(t,r,this._config.sourceSpatialReference);case 5:return a=e.sent,i=a.data,e.abrupt("return",i.exceededTransferLimit&&o<this._config.maxQueryDepth?(i.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,o+1)):(n.forEach((function(e){return i.features.push(e)})),i));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,s=this._serviceDefinition.relatedFeatures.joinField,a=(0,o.Z)(n);try{for(a.s();!(t=a.n()).done;){var i=t.value,c=i.attributes[s];r.set(c,i)}}catch(u){a.e(u)}finally{a.f()}this._relatedFeatures=r}}]),p}(S),F=C=(0,f.e)([(0,f.n)("esri.layers.graphics.sources.connections.GeoEventConnection")],C);function R(e,t,r,n,o,s,a,i){var c=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),u={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:o,maxReconnectionAttempts:s,maxReconnectionInterval:a,customParameters:i};return c?new S(u):new F(u)}}}]);
//# sourceMappingURL=3609.91c503e0.chunk.js.map