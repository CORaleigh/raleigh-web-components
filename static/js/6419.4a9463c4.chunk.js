"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[6419],{76419:function(e,t,i){i.d(t,{F:function(){return _e},S:function(){return De},_:function(){return Ue},a:function(){return Oe},l:function(){return Pe},s:function(){return Te}});var r=i(93433),n=i(29439),a=i(97326),s=i(74165),o=i(15861),l=i(11752),h=i(61120),c=i(37762),u=i(15671),d=i(43144),p=i(60136),y=i(29388),f=i(48848),g=(i(74384),i(2821)),v=(i(2959),i(37944)),m=i(93661),_=i(50690),b=i(33794),S=i(71802),C=i(95249),w=i(93209),G=i(25456),x=i(82474),k=i(45999),I=i(43406),E=i(28390),R=i(25874),D=i(59984),O=i(63393),A=i(64854),P=i(70449),L=i(37856),V=i(62466),U=i(44581),j=i(59389),Z=i(90325),T=i(47855),F=i(15529),z=i(25747),M=i(32043),B=i(57791),N=i(47748),H=i(46817),W=i(630),q=i(85700),Y=v.d.fromSimpleMarkerSymbol(O.b),X=v.e.fromSimpleLineSymbol(O.u),J=v.S.fromSimpleFillSymbol(O.d),Q=new v.i({symbolLayers:[new v.G({material:{color:A.e},edges:new v.H({size:"1px",color:A.i})})]});function K(e){if((0,m.t)(e))return null;switch(e.type){case"mesh":return Q;case"point":case"multipoint":return Y;case"polyline":return X;case"polygon":case"extent":return J}return null}var $=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e)).events=new L.n,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.viewSpatialReference=null,r.featureAdapter={getAttribute:function(e,t){return"graphic"in e?e.graphic.attributes[t]:U.i.getAttribute(e,t)},getAttributes:function(e){return"graphic"in e?e.graphic.attributes:U.i.getAttributes(e)},getObjectId:function(e){return"graphic"in e?(0,I.O)(e.graphic,r.objectIdField):U.i.getObjectId(e)},getGeometry:function(e){return"graphic"in e?e.getAsOptimizedGeometry(r.hasZ,r.hasM):U.i.getGeometry(e)},getCentroid:function(e,t){if("graphic"in e){var i=null;(0,m.r)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&(0,C.p)(e.graphic.geometry,ee,r.viewSpatialReference)&&(i=ee);var n=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return(0,m.t)(i)?(n[0]=0,n[1]=0,n[2]=0,n[3]=0):(n[0]=i.x,n[1]=i.y,t.hasZ&&(n[2]=i.hasZ?i.z:0),t.hasM&&(n[t.hasZ?3:2]=i.hasM?i.m:0)),new V.t([],n)}return U.i.getCentroid(e,t)},cloneWithGeometry:function(e,t){return"graphic"in e?new V.s(t,r.featureAdapter.getAttributes(e),null,r.featureAdapter.getObjectId(e)):U.i.cloneWithGeometry(e,t)}},r}return(0,d.Z)(i,[{key:"forEachInBounds",value:function(e,t){this.getSpatialIndex().forEachInBounds(e,t)}},{key:"forEachBounds",value:function(e,t,i){var r,n=this.getSpatialIndex(),a=(0,c.Z)(e);try{for(a.s();!(r=a.n()).done;){var s=r.value,o=this.featureAdapter.getObjectId(s);(0,m.r)(n.getBounds(o,i))&&t(i)}}catch(l){a.e(l)}finally{a.f()}}}]),i}(f.m);(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"getSpatialIndex",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"toArray",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"forEach",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"hasZ",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"hasM",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"objectIdField",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"viewSpatialReference",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],$.prototype,"featureSpatialReference",void 0),$=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],$);var ee={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},te=(0,d.Z)((function e(t){(0,u.Z)(this,e),this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1})),ie=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e,r,n){var a;return(0,u.Z)(this,i),(a=t.call(this,e,r,n))._calloutSymbolLayer=null,a.symbol.hasVisibleCallout()&&(a._calloutSymbolLayer=(0,E.c)(a.symbol,r)),a}return(0,d.Z)(i,[{key:"doLoad",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var r,n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._calloutSymbolLayer?(0,j.b)(this._calloutSymbolLayer.load()):null,e.prev=1,e.next=4,(0,l.Z)((0,h.Z)(i.prototype),"doLoad",this).call(this,t);case 4:(0,f.f)(t),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(1),null!==(n=this._calloutSymbolLayer)&&void 0!==n&&n.abortLoad(),e.t0;case 10:if(e.t1=r,!e.t1){e.next=14;break}return e.next=14,r;case 14:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,l.Z)((0,h.Z)(i.prototype),"destroy",this).call(this),this._calloutSymbolLayer=(0,m.g)(this._calloutSymbolLayer)}},{key:"createGraphics3DGraphic",value:function(e,t){var r=(0,l.Z)((0,h.Z)(i.prototype),"createGraphics3DGraphic",this).call(this,e,t);if((0,m.r)(this._calloutSymbolLayer)&&(0,m.r)(r)){var n=this._createCalloutGraphic(e);(0,m.r)(n)&&r.addAuxiliaryGraphic(n)}return r}},{key:"globalPropertyChanged",value:function(e,t){var r=this;return!!(0,l.Z)((0,h.Z)(i.prototype),"globalPropertyChanged",this).call(this,e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,(function(e){return r._getCalloutGraphicLayer(e)})))}},{key:"updateGeometry",value:function(e,t){var r=(0,l.Z)((0,h.Z)(i.prototype),"updateGeometry",this).call(this,e,t);if(r&&this._calloutSymbolLayer){var n=this._getCalloutGraphicLayer(e);if(n)return this._calloutSymbolLayer.updateGeometry(n,t)}return r}},{key:"_createCalloutGraphic",value:function(e){var t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this._calloutSymbolLayer.createGraphics3DGraphic(e)}},{key:"_getCalloutGraphicLayer",value:function(e){var t,i=(0,c.Z)(e._auxiliaryGraphics);try{for(i.s();!(t=i.n()).done;){var r=t.value;if(r.graphics3DSymbolLayer===this._calloutSymbolLayer)return r}}catch(n){i.e(n)}finally{i.f()}}}]),i}(E.p);var re=function(){function e(t){var i=this;(0,u.Z)(this,e),this._graphicsCore=t,this._idToState=new Map,this._states=new Set;var r=t.owner.layer&&t.owner.layer.objectIdField;r?(this._getGraphicId=function(e){return(0,I.O)(e,r)},this._getGraphics3DGraphicById=function(e){return i._graphicsCore.getGraphics3DGraphicByObjectId(e)}):(this._getGraphicId=function(e){return e.uid},this._getGraphics3DGraphicById=function(e){return i._graphicsCore.getGraphics3DGraphicById(e)})}return(0,d.Z)(e,[{key:"destroy",value:function(){var e=this;this._idToState.clear(),this._states.forEach((function(t,i){return e.remove(i)}))}},{key:"add",value:function(e){var t=this,i={remove:function(){return t.remove(e)}};if(this._states.has(e))return i;var r=this._getGraphicId(e.graphic),n=this._getGraphics3DGraphicById(r);return this._states.has(e)||this._states.add(e),this._ensureStateList(r).push(e),e.displaying=!!(0,m.r)(n)&&n.isVisible(),e.isDraped=!!(0,m.r)(n)&&n.isDraped,e.tracking=!0,(0,m.r)(n)&&e.emit("changed",{}),i}},{key:"remove",value:function(e){if(this._states.has(e)){if(this._idToState.size){var t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&((0,m.C)(i,e),0===i.length&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}},{key:"addGraphic",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}},{key:"removeGraphic",value:function(e){this._forEachState(e,(function(e){e.displaying=!1,e.isDraped=!1}))}},{key:"updateGraphicGeometry",value:function(e){this._forEachState(e,(function(e){e.emit("changed",{})}))}},{key:"updateGraphicVisibility",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible()}))}},{key:"allGraphicsDeleted",value:function(){this._states.forEach((function(e){e.displaying=!1}))}},{key:"_ensureStateList",value:function(e){var t=this._idToState.get(e);if(t)return t;var i=new Array;return this._idToState.set(e,i),i}},{key:"_forEachState",value:function(e,t){if(0!==this._states.size&&0!==this._idToState.size){var i=this._getGraphicId(e.graphic),r=this._idToState.get(i);null!=r&&r.forEach(t)}}}]),e}(),ne=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._index=new Z.h(9,(0,m.h)("esri-csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),r._missing=new Set,r._boundsByFeature=new Map,r.spatialReference=null,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.updating=!1,r}return(0,d.Z)(i,[{key:"setup",value:function(e){this._addMany(e)}},{key:"destroy",value:function(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}},{key:"update",value:function(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}},{key:"updatingRemaining",get:function(){return this._missing.size}},{key:"queryGraphicUIDsInExtent",value:function(e,t,i){!(0,m.t)(t)&&t.equals(this.spatialReference)&&(ae.minX=e[0],ae.minY=e[1],ae.maxX=e[2],ae.maxY=e[3],this.update(),this._index.search(ae,(function(e){return i(e.graphic.uid)})))}},{key:"add",value:function(e){this._missing.add(e),this.updating=!0}},{key:"remove",value:function(e){if(this._missing.delete(e))this.updating=this._missing.size>0;else{this._index.remove(e);var t=(0,I.O)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}}},{key:"_addMany",value:function(e){if(0!==e.length){var t,i=this._get("objectIdField"),r=(0,c.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.computeExtent(this.spatialReference);var a=(0,I.O)(n.graphic,i);null!=a&&this._boundsByFeature.set(a,n.extent)}}catch(s){r.e(s)}finally{r.f()}this._index.load(e)}}},{key:"clear",value:function(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}},{key:"forEachInBounds",value:function(e,t){ae.minX=e[0],ae.minY=e[1],ae.maxX=e[2],ae.maxY=e[3],this.update(),this._index.search(ae,(function(e){t(e)}))}},{key:"getBounds",value:function(e,t){this.update();var i=this._boundsByFeature.get(e);return i?(0,w.G)(t,i):null}}]),i}(f.m);(0,f.e)([(0,f.y)({constructOnly:!0})],ne.prototype,"spatialReference",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],ne.prototype,"hasZ",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],ne.prototype,"hasM",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],ne.prototype,"objectIdField",void 0),(0,f.e)([(0,f.y)()],ne.prototype,"updating",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],ne.prototype,"updatingRemaining",null),ne=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.SpatialIndex2D")],ne);var ae={minX:0,minY:0,maxX:0,maxY:0},se=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._elevationOffset=0,r._layerHandes=new f.X,r}return(0,d.Z)(i,[{key:"spatialReference",get:function(){var e;return null===(e=this.view)||void 0===e?void 0:e.spatialReference}},{key:"initialize",value:function(){var e=this;this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=(0,z.g)(this.view.state.viewingMode),this._intersector.options.store=z.J.MIN;var t=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=t[2],this._zmax=t[5];var i=this.stageLayer.events;this._layerHandes.add([i.on("layerObjectAdded",(function(t){return e._objectChanged(t.object)})),i.on("layerObjectRemoved",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryAdded",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryRemoved",(function(t){return e._objectChanged(t.object)})),i.on("vertexAttrsUpdated",(function(t){return e._objectChanged(t.object)})),i.on("objectTransformation",(function(t){return e._objectChanged(t)}))])}},{key:"dispose",value:function(){this._layerHandes.destroy()}},{key:"elevationInfoChanged",value:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t=(0,T.L)(this.layer.spatialReference),i=(0,F.r)(e.unit);this._elevationOffset=(0,m.v)(e.offset,0)*i/t}else this._elevationOffset=0}},{key:"getElevation",value:function(e,t,i,r){if(de[0]=e,de[1]=t,de[2]=i,!this._renderCoordsHelper.toRenderCoords(de,r,de))return f.a.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;var n=this._elevationOffset,a=this._zmin+n,s=this._zmax+n;this._renderCoordsHelper.setAltitude(pe,s,de),this._renderCoordsHelper.setAltitude(ye,a,de);return this._intersector.reset(pe,ye,null),this._intersector.intersect(this._intersectLayers,null,1,null,(function(e){return e.metadata&&e.metadata.isElevationSource})),this._intersector.results.min.getIntersectionPoint(de)?this._renderCoordsHelper.getAltitude(de):null}},{key:"_objectChanged",value:function(e){var t,i=this.spatialReference;if(null!==(t=e.metadata)&&void 0!==t&&t.isElevationSource&&!(0,m.t)(i)){(0,w.A)(he);var r=e.metadata.lastValidElevationBB;r.isEmpty()||this._expandExtent(i,r.min,r.max,he);var n=e.boundingVolumeWorldSpace,a=n.min,s=n.max;this._expandExtent(i,a,s,he),(0,w.B)(he,ce),this._zmin=Math.min(this._zmin,he[2]),this._zmax=Math.max(this._zmax,he[5]),ue.extent=ce,ue.spatialReference=i,this.emit("elevation-change",ue),(0,S.r)(r.min,a),(0,S.r)(r.max,s)}}},{key:"_computeLayerExtent",value:function(e,t){var i=this;return(0,w.A)(he),(0,m.r)(e)&&t.objects.forAll((function(t){return i._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,he)})),he}},{key:"_expandExtent",value:function(e,t,i,r){for(var n=0;n<8;++n)de[0]=1&n?t[0]:i[0],de[1]=2&n?t[1]:i[1],de[2]=4&n?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(de,de,e),(0,w.c)(r,de);return r}}]),i}(L.n.EventedMixin(f.m));(0,f.e)([(0,f.y)({constructOnly:!0})],se.prototype,"layer",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],se.prototype,"stageLayer",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],se.prototype,"view",void 0),(0,f.e)([(0,f.y)()],se.prototype,"spatialReference",null),se=(0,f.e)([(0,f.n)("esri.views.3d.layers.support.StageLayerElevationProvider")],se);var oe,le,he=(0,w.A)(),ce=(0,G.D)(),ue={spatialReference:null,extent:ce,context:"scene"},de=(0,S.n)(),pe=(0,S.n)(),ye=(0,S.n)(),fe=(0,S.n)(),ge=(0,w.a)(),ve="esri.views.3d.layers.graphics.Graphics3DCore",me=f.a.getLogger(ve),_e=oe=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._propertiesPool=new M.M({computedExtent:H.w},(0,a.Z)(r)),r.computedExtent=null,r.currentRenderer=null,r.rendererHasGeometryOperations=!1,r._graphicStateTracking=null,r.symbolCreationContext=new te((function(e,t){return r._frameTask.schedule(e,t)})),r.graphics3DGraphics=new Map,r.stageLayer=null,r.stage=null,r._graphicsDrapedUids=new Set,r._graphicsBySymbol=new Map,r._symbolConversionCache=new Map,r._symbols=new Map,r._graphicsWithoutSymbol=new Map,r._graphicsWaitingForSymbol=new Map,r._graphicsUpdateId=0,r._handles=new f.X,r._frameTask=N.y,r._suspendSymbolCleanup=!1,r._viewSpatialReference=null,r._arcadeOnDemand=null,r._rendererChangeAbortController=null,r._elevationInfoChangeAbortController=null,r._initializeAbortController=null,r._scaleVisibility=null,r._filterVisibility=null,r._spatialIndex=null,r.extentPadding=0,r._updatingPendingLoadedGraphicsChange=null,r._featureStore=null,r._deconflictor=null,r._labeler=null,r._objectStates=null,r._viewElevationProvider=null,r._stageLayerElevationProvider=null,r._sharedSymbolResourcesOwnerHandle=null,r._whenGraphics3DGraphicRequests={},r._pendingUpdates=new Map,r._numberOfGraphics=0,r._numberOfGraphicsProvidingElevation=0,r._pendingAdds=0,r._pendingRemoves=0,r._loadingSymbols=0,r._pendingUpdatesPool=new f.a6({allocator:function(e){return e||new be},deallocator:function(e){return e.clear(),e}}),r._symbolWarningLogged=!1,r._geometryWarningLogged=!1,r._objectIdInvisibleSet=new Set,r._whenSymbolRemoved=new f.a6,r.preferredUpdatePolicy=B.i.SYNC,r.forcedUpdatePolicy=null,r.elevationFeatureExpressionEnabled=!0,r.owner=null,r.layer=null,r.graphicSymbolSupported=!0,r.getRenderingInfoWithoutRenderer=!1,r.setUidToIdOnAdd=!0,r.hasZ=null,r.hasM=null,r._usedMemory=0,r._visible=void 0,r._startCreateGraphics=!1,r}return(0,d.Z)(i,[{key:"spatialIndex",get:function(){var e;return this._spatialIndex||(this._spatialIndex=new ne({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},{key:"effectiveUpdatePolicy",get:function(){return(0,m.r)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?B.i.ASYNC:(0,m.v)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"updating",get:function(){var e;return!!(this._graphicsWaitingForSymbol.size>0||this.running||null!==(e=this._elevationAlignment)&&void 0!==e&&e.updating||(0,m.r)(this._scaleVisibility)&&this._scaleVisibility.updating||(0,m.r)(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}},{key:"running",get:function(){var e;return this._pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var e;return this.owner.suspended||(null===(e=this.owner.suspendInfo)||void 0===e?void 0:e.outsideOfView)}},{key:"updatingRemaining",get:function(){var e,t;return this.updating?this._pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this._elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.averageSymbolComplexity,a=Math.max(1,(0,m.r)(n)?n.primitivesPerFeature:1),s=(0,m.r)(n)&&n.drawCallsPerFeature>0?i/n.drawCallsPerFeature*.3:i,o=Math.ceil(r/a),l=Math.max(t,Math.min(i,o,s)),h=this._get("displayFeatureLimit");return h&&h.minimumTotalNumberOfFeatures===t&&h.maximumTotalNumberOfFeatures===i&&h.maximumTotalNumberOfPrimitives===r&&h.averageSymbolComplexity===n&&h.maximumNumberOfFeatures===l?h:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:n,maximumNumberOfFeatures:l}}},{key:"averageSymbolComplexity",get:function(){var e=(0,E.d)(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||(0,m.r)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}},{key:"usedMemory",get:function(){var e=(0,m.r)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((function(e,t){return e+t.memory.resourceBytes}),0);return this._usedMemory+e+t}},{key:"usedMemoryPerGraphic",get:function(){if(this._usedMemory&&this._numberOfGraphics)return(this._pendingAdds+this._pendingRemoves)/this._numberOfGraphics>20?0:this._usedMemory/this._numberOfGraphics;if((0,m.r)(this.averageSymbolComplexity)){var e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"_symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"_getConvertedSymbol",value:function(e){var t;if("web-style"===e.type)return e.clone();var i=this._symbolConversionCache.get(e.id);if((0,m.r)(i))return i;var r=(0,P.S)(e,{geometryType:null===(t=this.layer)||void 0===t?void 0:t.geometryType,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),n=r.symbol||null;return(0,m.t)(n)&&r.error&&me.error(r.error.message),this._symbolConversionCache.set(e.id,n),n}},{key:"_getSymbolComplexitiesUsedOrRenderer",value:function(e){if((0,m.t)(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],n=this._getSymbolComplexityUsedOrRenderer(i);(0,m.r)(n)&&r.push(n);var a,s=(0,c.Z)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value,l=this._getSymbolComplexityUsedOrRenderer(o);(0,m.r)(l)&&r.push(l)}}catch(h){s.e(h)}finally{s.f()}return r}},{key:"_getSymbolComplexityUsedOrRenderer",value:function(e){if((0,m.t)(e))return null;var t=this._symbols.get(e.id);if((0,m.r)(t))return t.complexity;var i=this._getConvertedSymbol(e);return(0,m.r)(i)?(0,E.y)(i):null}},{key:"_getSymbolComplexitiesUsed",value:function(){var e=[];return this._symbols.forEach((function(t){(0,m.r)(t)&&e.push(t.complexity)})),e}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"initialize",value:function(){var e=this;this._viewSpatialReference=this.owner.view.spatialReference,this._featureStore=new $({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:function(){return e.spatialIndex},forEach:function(t){return e.graphics3DGraphics.forEach(t)},toArray:function(){return Array.from(e.graphics3DGraphics.values())}});var t=function(t,i,r){return e.spatialIndex.queryGraphicUIDsInExtent(t,i,r)},i=this.componentFactories;if((0,m.r)(i.elevationAlignment)){var r=i.elevationAlignment(this,t);this._elevationAlignment=r}if((0,m.r)(i.scaleVisibility)){var n=i.scaleVisibility(this,t);this._scaleVisibility=n}if((0,m.r)(i.filterVisibility)){var a=i.filterVisibility({featureStore:this._featureStore,getFeatureCount:function(){return e.graphics3DGraphics.size},updateFeatureVisibilities:function(t){return e.modifyGraphics3DGraphicVisibilities((function(i){return i.setVisibilityFlag(E.C.FILTER,t((0,I.O)(i.graphic,e._objectIdField)),E.E.GRAPHIC)}))},setAllFeaturesVisibility:function(t){return e.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(E.C.FILTER,t,E.E.GRAPHIC)}))},clearFeaturesVisibility:function(){return e.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(E.C.FILTER)}))}});this._filterVisibility=a}if((0,m.r)(i.deconflictor)){var s=i.deconflictor(this);this._deconflictor=s}if((0,m.r)(i.labeler)&&(0,m.r)(this._scaleVisibility)){var o=i.labeler(this,this._scaleVisibility);this._labeler=o}if((0,m.r)(i.objectStates)){var l=i.objectStates(this);this._objectStates=l}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}},{key:"_initializeAsync",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(){var t,i,r,n,a,o,l,h=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._initializeAbortController.signal,a=this.owner.view,this._viewElevationProvider=new E.n(this._viewSpatialReference,a),this._initializeStage(a,this.layer.uid),this.symbolCreationContext.sharedResources=a.sharedSymbolResources,this._sharedSymbolResourcesOwnerHandle=a.sharedSymbolResources.addGraphicsOwner(this.owner),(0,m.r)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=a.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=a.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new E.j(a.renderSpatialReference),this.symbolCreationContext.elevationProvider=a.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=function(e){return h.notifyGraphicGeometryChanged(e)},this.symbolCreationContext.notifyGraphicVisibilityChanged=function(e){return h.notifyGraphicVisibilityChanged(e)},o=(0,E.m)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=5,(0,E.u)(o,this._viewSpatialReference,n,me);case 5:if(this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,f.f)(n),this.symbolCreationContext.screenSizePerspectiveEnabled=a.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!(null===(t=this.owner.view.qualitySettings)||void 0===t||!t.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!(null===(i=this.owner.view.qualitySettings)||void 0===i||null===(r=i.graphics3D)||void 0===r||!r.skipHighSymbolLods),!("drapeSourceType"in this.owner)){e.next=14;break}l=this.owner,this.symbolCreationContext.drapeSourceRenderer=a.basemapTerrain.overlayManager.registerGeometryDrapeSource(l),this._handles.add((0,f.D)((function(){return a.basemapTerrain.overlayManager.unregisterDrapeSource(l)})));case 14:this._handles.add([(0,_.l)((function(){return h.suspendedOrOutsideOfView}),(function(){return h._frameTask.reschedule((function(){return h._updateLayerVisibility()}))})),(0,_.l)((function(){var e;return[null===(e=h.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,h.owner.view.screenSizePerspectiveEnabled]}),(function(){var e,t=a.screenSizePerspectiveEnabled&&h.layer.screenSizePerspectiveEnabled;t!==h.symbolCreationContext.screenSizePerspectiveEnabled&&(h.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=h._labeler)&&void 0!==e&&e.reset(),h.recreateAllGraphicsAndSymbols())})),(0,_.l)((function(){return h.owner.slicePlaneEnabled}),(function(e){return h._slicePlaneEnabledChange(!!e)})),(0,_.l)((function(){var e;return null===(e=h.owner.view.state)||void 0===e?void 0:e.pixelRatio}),(function(){return h._pixelRatioChange()})),(0,_.l)((function(){var e;return!(null===(e=h.owner.view.qualitySettings)||void 0===e||!e.physicallyBasedRenderingEnabled)}),(function(e){return h._physicalBasedRenderingChange(e)})),(0,_.l)((function(){var e,t;return!(null===(e=h.owner.view.qualitySettings)||void 0===e||null===(t=e.graphics3D)||void 0===t||!t.skipHighSymbolLods)}),(function(e){return h._skipHighSymbolLoDsChange(e)})),(0,_.f)((function(){var e;return null===(e=a.basemapTerrain)||void 0===e?void 0:e.tilingScheme}),(function(e){if(!e.spatialReference.equals(h.symbolCreationContext.overlaySR)&&(0,m.r)(a.basemapTerrain.spatialReference)&&(h.symbolCreationContext.overlaySR=a.basemapTerrain.spatialReference),h._handles.has("loaded-graphics"))h.recreateAllGraphics();else{h._handles.add([(0,_.a)((function(){var e;return null===(e=h.owner)||void 0===e?void 0:e.loadedGraphics}),"change",(function(e){h._graphicsCollectionChanged(e),h._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:function(){h.recreateAllGraphics(),h._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,_.l)((function(){return h.effectiveUpdatePolicy}),(function(e){(0,m.r)(h.stageLayer)&&(h.stageLayer.updatePolicy=e),h.symbolCreationContext.isAsync=h.effectiveUpdatePolicy===B.i.ASYNC,e===B.i.SYNC&&h.runTask(N.F)}),_.w)]),this._frameTask=a.resourceController.scheduler.registerTask(N.I.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add((0,_.l)((function(){return h.layer.featureReduction}),(function(){return h._deconflictor.featureReductionChange()}))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((function(){})),this._initializeAbortController=null;case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_abortInitialize",value:function(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}},{key:"destroy",value:function(){for(var e in this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._elevationAlignment=(0,m.g)(this._elevationAlignment),this._scaleVisibility=(0,m.g)(this._scaleVisibility),this._filterVisibility=(0,m.g)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,m.g)(this._objectStates),this.clear(),this._featureStore=(0,m.g)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,m.f)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,m.g)(this._graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,m.g)(this._handles),this._frameTask.remove(),this._frameTask=N.y,this._viewSpatialReference=null,this._set("owner",null),this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new f.s("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,m.f)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,m.g)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,m.g)(this._spatialIndex)}},{key:"clear",value:function(){var e,t;null!==(e=this._objectStates)&&void 0!==e&&e.allGraphicsDeleted(),(0,m.r)(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(m.g),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}},{key:"_initializeStage",value:function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new E.l({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);var r=this.stageLayer.events;r.on("objectTransformation",(function(e){return i.notifyGraphicGeometryChanged(e.metadata.graphicUid)})),r.on("visibilityChanged",(function(e){return i.notifyGraphicVisibilityChanged(e.metadata.graphicUid)})),r.on("objectGeometryAdded",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("objectGeometryRemoved",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("vertexAttrsUpdated",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)}))}},{key:"notifyGraphicGeometryChanged",value:function(e){if(!(0,m.t)(this._graphicStateTracking)&&!(0,m.t)(e)){var t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}}},{key:"notifyGraphicVisibilityChanged",value:function(e){if(!(0,m.t)(this._graphicStateTracking)&&!(0,m.t)(e)){var t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}}},{key:"_updateLayerVisibility",value:function(){var e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*Se,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}},{key:"_updateStageLayerVisibility",value:function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}},{key:"getGraphics3DGraphicById",value:function(e){return this.graphics3DGraphics.get(e)}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}},{key:"_getGraphicObjectID",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.owner.layer&&this.owner.layer.objectIdField;return(0,I.O)(e,t)}},{key:"graphics3DGraphicsByObjectID",get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);(0,m.r)(a)&&i.set(a,r)}})),i}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},{key:"updateLabelingInfo",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._deconflictor&&this._deconflictor.labelingInfoChange(t),r=this._labeler&&this._labeler.labelingInfoChange(t),e.next=3,(0,f.E)([i,r]);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateVisibilityInfo",value:function(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}},{key:"symbolUpdateType",get:function(){var e=this;if(this._pendingUpdates.size>0)return"unknown";var t=0,i=0;return(0,f.a9)(this._symbols,(function(r,n){if((0,m.r)(r)){var a=r.getFastUpdateStatus();if(a.loading>0)return!0;e._graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"}},{key:"runTask",value:function(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}},{key:"setObjectIdVisibility",value:function(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);(0,m.r)(i)&&this._updateUserVisibility(i)}},{key:"_findGraphics3DGraphicByObjectId",value:function(e){var t=this;return(0,f.aB)(this.graphics3DGraphics,(function(i){return t._getGraphicObjectID(i.graphic)===e}))}},{key:"_updateUserVisibility",value:function(e){if((0,m.t)(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&((0,m.t)(i)||!this._objectIdInvisibleSet.has(i));return e.setVisibilityFlag(E.C.USER_SETTING,r,E.E.GRAPHIC)}},{key:"_whenGraphics3DGraphic",value:function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);var i=this._whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=(0,f.A)();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}},{key:"_boundsForGraphics3DGraphic",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r,n,a,o,l,h,c,u,d,p;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._viewSpatialReference,n=this.owner.view.renderSpatialReference,a=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return(0,C.x)(e,n,t,e,r,t,i)},l=function(e,t,i){return(0,C.x)(e,a,t,e,r,t,i)},h=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:(0,m.r)(i)&&i.useViewElevation,minDemResolution:(0,m.r)(i)&&i.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,e.next=8,t.getProjectedBoundingBox(o,l,h,(0,m.q)(i,"signal"));case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:return u=c.boundingBox,c.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&((0,w.p)(u,fe),p=(0,m.v)(d.getElevation(fe[0],fe[1],0,r,"ground"),0),u[2]=Math.min(u[2],p),u[5]=Math.max(u[5],p)),e.abrupt("return",{boundingBox:u,screenSpaceObjects:c.screenSpaceObjects});case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"whenGraphicBounds",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r,n,a,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_.j)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}));case 2:if(r=this.owner.layer&&this.owner.layer.objectIdField,n=this.owner.loadedGraphics.find((function(e){return e===t||r&&e.attributes&&t.attributes&&e.attributes[r]===t.attributes[r]})),n){e.next=5;break}throw new f.s("internal:graphic-not-part-of-view","Graphic is not part of this view");case 5:return e.next=7,this._whenGraphics3DGraphic(n);case 7:return a=e.sent,e.abrupt("return",this._boundsForGraphics3DGraphic(a,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,S.o)(Ce,0,0,0);var a=0;if(r.render.num>0){if(!(0,C.j)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,we,t))return null;(0,S.u)(Ce,Ce,we),a++}if(r.draped.num>0){var s=(0,n.Z)(r.draped.origin,2),o=s[0],l=s[1],h=(0,m.v)(this._viewElevationProvider.getElevation(o,l,"ground"),0);if((0,S.o)(we,o,l,h),!(0,C.j)(we,this._viewElevationProvider.spatialReference,we,t))return null;(0,S.u)(Ce,Ce,we),a++}return a>1&&(0,S.g)(Ce,Ce,1/a),new x.w({x:Ce[0],y:Ce[1],z:Ce[2],spatialReference:t})}},{key:"getSymbolLayerSize",value:function(e,t){var i=this._symbols.get(e.id);if((0,m.t)(i))throw new f.s("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new f.s("internal:missing-symbol-layer","Symbol layer is not in symbol");var n=i.getSymbolLayerSize(r);if(null==n)throw new f.s("internal:missing-size","Symbol layer has no valid size");return n}},{key:"_graphicsCollectionChanged",value:function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}},{key:"graphicUpdateHandler",value:function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!(0,m.t)(i)||!(0,m.t)(this._graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e)}}},{key:"_graphicUpdateGeometryHandler",value:function(e,t){var i=t.graphic.geometry;if((0,m.t)(i))this._recreateGraphic(t.graphic);else if((0,m.t)(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this._symbols.get(r);if((0,m.r)(n)&&n.loadStatus===E.g.LOADING)return}this._recreateGraphic(t.graphic)}else{var a=e.graphics3DSymbol;!(0,m.t)(t.newValue)&&a.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i)}}},{key:"_graphicUpdateSymbolHandler",value:function(e,t){var i=t.graphic,r=(0,m.r)(e)?e.graphics3DSymbol:(0,m.r)(t.oldValue)?this._symbols.get(t.oldValue.id):null;if((0,m.t)(r)||(0,m.t)(t.newValue))this._recreateGraphic(i);else{var n=r.symbol,a=this._getConvertedSymbol(t.newValue);if((0,m.r)(a)&&(a.type!==n.type||"web-style"===a.type)||"web-style"===n.type)this._recreateGraphic(i);else{var s=this._graphicsBySymbol.get(n.id);if(s&&1!==s.size)this._recreateGraphic(i);else{var o=(0,b.m)(n,a);if((0,m.t)(o))this._updateSymbolMapping(n.id,a);else{var l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),(0,b.d)(l.diff)){var h=this._getRenderingInfo(i);if((0,m.t)(h))this._recreateGraphic(i);else{var u,d=r.extentPadding,p=(0,c.Z)(l.symbolStatePatches);try{for(p.s();!(u=p.n()).done;){(0,u.value)()}}catch(g){p.e(g)}finally{p.f()}if(d!==r.extentPadding&&this._recomputeExtentPadding(),(0,m.r)(e)){var y,f=(0,c.Z)(l.graphics3DGraphicPatches);try{for(f.s();!(y=f.n()).done;){(0,y.value)(e,h)}}catch(g){f.e(g)}finally{f.f()}}this._updateSymbolMapping(n.id,a)}}else this._recreateGraphic(i)}}}}}},{key:"_graphicUpdateVisibleHandler",value:function(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"_graphicUpdateTransformHandler",value:function(e,t){}},{key:"recreateGraphics",value:function(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===B.i.SYNC&&this._cleanupSymbols()}},{key:"_recreateGraphic",value:function(e){this.recreateGraphics([e])}},{key:"_beginGraphicUpdate",value:function(e){var t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}},{key:"_endGraphicUpdate",value:function(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}},{key:"_recomputeExtentPadding",value:function(){var e=0;this._symbols.forEach((function(t){(0,m.r)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}},{key:"_expandComputedExtent",value:function(e){var t=ge,i=e.spatialReference;(0,I.T)(e,t);var r=this._viewSpatialReference,n=oe.tmpVec;if((0,x.E)(i,r)||(0,C.B)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],(0,C.B)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])){var a=this.computedExtent,s=null,o=isFinite(t[2])&&isFinite(t[5]),l=o&&(!a||null==a.zmin||t[2]<a.zmin),h=o&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||h)&&((s=this._propertiesPool.get("computedExtent")).xmin=Math.min(t[0],a.xmin),s.ymin=Math.min(t[1],a.ymin),s.xmax=Math.max(t[3],a.xmax),s.ymax=Math.max(t[4],a.ymax),s.spatialReference=r):((s=this._propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(l&&(s.zmin=t[2]),h&&(s.zmax=t[5]),this._set("computedExtent",s))}}},{key:"_abortElevationInfoChange",value:function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}},{key:"elevationInfoChange",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(){var t,i,r,n,a=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._abortElevationInfoChange(),r=new AbortController,this._elevationInfoChangeAbortController=r,n=(0,E.m)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=6,(0,E.u)(n,this._viewSpatialReference,r.signal,me);case 6:this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,f.f)(r.signal),this._elevationInfoChangeAbortController=null,null!==(t=this._labeler)&&void 0!==t&&t.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){var t,i=e.graphic,r=e.labelGraphics,n=(0,c.Z)(r);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.graphics3DSymbolLayer.updateGraphicElevationContext(i,a)}}catch(s){n.e(s)}finally{n.f()}})):a._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null===(i=this._elevationAlignment)||void 0===i||i.elevationInfoChange();case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateStageLayerElevationProvider",value:function(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new se({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}},{key:"_clearSymbolsAndGraphics",value:function(){var e,t,i,r;this.clear(),(0,m.r)(this._filterVisibility)&&this._filterVisibility.clear(),null!==(e=this._labeler)&&void 0!==e&&e.reset(),null!==(t=this._deconflictor)&&void 0!==t&&t.clear(),null!==(i=this._elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null)}},{key:"startCreateGraphics",value:function(){this._startCreateGraphics=!0,this.recreateAllGraphics()}},{key:"recreateAllGraphics",value:function(){this._recreateAllGraphics(!1)}},{key:"recreateAllGraphicsAndSymbols",value:function(){this._recreateAllGraphics(!0)}},{key:"_recreateAllGraphics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._startCreateGraphics){var t=this.owner,i=t.loadedGraphics,r=t.view,n=r.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&n||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),n&&(e?this.add(n):this.recreateGraphics(n))}}},{key:"_recreateSymbol",value:function(e){var t=this,i=this._graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var n,a=e.usedMemory;t._conditionalRemove(e,i),null!==(n=t._spatialIndex)&&void 0!==n&&n.remove(e),r.push(e.graphic),e.destroy(),t._removeGraphics3DGraphic(i,a),t._updateLayerVisibility(),t._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(e,new Map));var n=this._symbols.get(e);(0,m.g)(n),this._symbols.delete(e),this.add(r)}},{key:"_recreateGraphicsForSymbol",value:function(e){var t=this._graphicsBySymbol.get(e);if(t){var i=[];t.forEach((function(e){return i.push(e.graphic)})),this.recreateGraphics(i)}}},{key:"_conditionalRemove",value:function(e,t){var i,r,n;this._graphicsDrapedUids.delete(t),null!==(i=this._objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this._labeler)&&void 0!==r&&r.removeGraphic(e),null!==(n=this._deconflictor)&&void 0!==n&&n.removeGraphic(e),(0,m.r)(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(e)}},{key:"add",value:function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===B.i.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):me.error("#add()","Cannot add graphics before terrain surface has been initialized"))}},{key:"_updatePolicyForGraphics",value:function(e){if(this.effectiveUpdatePolicy===B.i.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType)){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;if((0,m.r)(r.geometry)&&"mesh"===r.geometry.type&&!r.geometry.loaded)return B.i.ASYNC}}catch(n){i.e(n)}finally{i.f()}}return this.effectiveUpdatePolicy}},{key:"_addImmediate",value:function(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._addGraphic(r,this._getRenderingInfo(r,me),B.i.SYNC)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}},{key:"_addDelayed",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this._pendingUpdates.get(n);a?a.add?a.state!==le.NEW&&a.abortController.abort():this._pendingAdds++:(a=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(n,a)),a.add=r}}catch(s){i.e(s)}finally{i.f()}this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"remove",value:function(e){this.effectiveUpdatePolicy===B.i.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}},{key:"_removeImmediate",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._removeGraphic(r)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_removeDelayed",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this._pendingUpdates.get(n);if(a)a.add&&(a.remove?a.add=null:this._pendingUpdates.delete(n),a.state===le.LOADING&&a.abortController.abort(),this._pendingAdds--);else{var s=this._pendingUpdatesPool.pushNew();s.remove=r,this._pendingUpdates.set(n,s),this._pendingRemoves++}}}catch(o){i.e(o)}finally{i.f()}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"_finishPendingUpdates",value:function(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&me.warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0}},{key:"_applyPendingUpdates",value:function(e){var t;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)this._spatialIndex.update();else{var i,r=(0,c.Z)(this._pendingUpdates);try{for(r.s();!(i=r.n()).done;){var a=(0,n.Z)(i.value,2),s=a[0],o=a[1];if(e.done)break;o.add&&o.state===le.NEW&&this._processPendingUpdateNew(o);var l=this.effectiveUpdatePolicy;if(!o.remove||o.add&&o.state!==le.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(o.remove),o.remove=null,l=B.i.SYNC),o.add)switch(o.state){case le.READY:this._addGraphic(o.add,o.renderingInfo,l),o.add=null,this._pendingAdds--,e.madeProgress();break;case le.REJECTED:o.add=null,this._pendingAdds--}null==o.remove&&null==o.add&&this._pendingUpdates.delete(s)}}catch(h){r.e(h)}finally{r.f()}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}},{key:"_processPendingUpdateNew",value:function(e){if(e.add){var t=e.add.geometry;(0,m.r)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}else e.state=le.READY}},{key:"_processPendingUpdateNewMesh",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.state=le.LOADING,t.abortController=new AbortController,r=t.abortController.signal,e.prev=2,e.next=5,i.load({signal:r});case 5:e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(2),e.abrupt("return",this._processPendingUpdateNewError(t,e.t0));case 10:t.abortController=null,this._processPendingUpdateNewRenderingInfo(t);case 11:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_processPendingUpdateNewError",value:function(e,t){e.abortController=null,(0,f.j)(t)?e.state=le.NEW:e.state=le.REJECTED}},{key:"_processPendingUpdateNewRenderingInfo",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,m.t)(this.layer.renderer)&&"dictionary"===this.layer.renderer.type){e.next=2;break}return e.abrupt("return",(t.renderingInfo=this._getRenderingInfo(t.add,me),void(t.state=le.READY)));case 2:return t.state=le.LOADING,t.abortController=new AbortController,i=null,e.prev=4,e.next=7,this._getRenderingInfoAsync(t.add,{signal:t.abortController.signal});case 7:i=e.sent,e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(4),e.abrupt("return",(t.abortController=null,void((0,f.j)(e.t0)?t.state=le.NEW:t.state=le.REJECTED)));case 13:(0,m.t)(i)||(0,m.t)(i.symbol)?(me&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,me.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),t.renderingInfo=null):t.renderingInfo=i,t.state=le.READY;case 14:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_addGraphic",value:function(e,t,i){var r=this;if(this._graphicsWithoutSymbol.set(e.uid,e),!(0,m.t)(t)&&!(0,m.t)(t.symbol)&&(0,I.M)(e)){(0,m.h)("enable-feature:objectAndLayerId-rendering")&&this.setUidToIdOnAdd&&this.stage.renderView._objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,this.layer.popupEnabled);var n=t.symbol,a=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(!(0,m.t)(a)){this._expandComputedExtent(e.geometry);var s=this._beginGraphicUpdate(e),o=new E.r(e,t,this.layer),l=!1,h=function(e){e===a.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(h);var c=function(){if(--r._loadingSymbols,!r.destroyed){if(r._whenSymbolRemoved.removeUnordered(h),r._graphicsWaitingForSymbol.get(e.uid)!==s||l||a.destroyed||r.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,r._cleanupSymbols();else{var t=r._createGraphics3DGraphic(a,o);r._spatialIndex&&(0,m.r)(t)&&r._spatialIndex.add(t),--a.referenced,r._endGraphicUpdate(e)}r._featureStore.events.emit("changed"),r._labeler&&r.owner.view.labeler.setDirty()}},u=function(t){--r._loadingSymbols,r.destroyed||(r._whenSymbolRemoved.removeUnordered(h),l||((0,f.j)(t)?r.add([e]):a.destroyed||r._endGraphicUpdate(e)))};++this._loadingSymbols,i===B.i.ASYNC?a.load((function(){return r._frameTask.schedule(c)}),(function(e){return r._frameTask.schedule((function(){return u(e)}))})):a.load(c,u)}}}},{key:"_removeGraphic",value:function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);var n=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);var s=i.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s).delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,n,a),i.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}},{key:"_hasLabelingContext",value:function(e){if(e instanceof v.k||e instanceof v.b){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1}},{key:"_hasValidSymbolCreationContext",value:function(e){return!(e instanceof v.k&&!this._hasLabelingContext(e))||(me.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}},{key:"_getRenderingInfo",value:function(e,t){var i=e.geometry;if((0,m.t)(i))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,C.A)(i.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&(0,m.r)(e.symbol))return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r,n=this.rendererHasGeometryOperations?(0,E.f)(e,this.layer):e;return r=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,m.r)(this.currentRenderer))?this.owner.getRenderingInfo(n,this.currentRenderer,this._arcadeOnDemand):{symbol:n.symbol||K(n.geometry)},(0,m.t)(r)||(0,m.t)(r.symbol)?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):r}},{key:"_getRenderingInfoAsync",value:function(e,t){var i=e.geometry;if((0,m.t)(i))return me&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,me.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&(0,m.r)(e.symbol))return me&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,me.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r=this.rendererHasGeometryOperations?(0,E.f)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,t)}},{key:"_createGraphics3DSymbol",value:function(e,t){var i=this;if(!this._hasValidSymbolCreationContext(e))return null;var r,n=this._getConvertedSymbol(e);if(!n)return null;if((0,m.r)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=(0,P.S)(t.backgroundFillSymbol,{ignoreDrivers:!0});(0,m.r)(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(r=a.symbol.symbolLayers)}var s=function(e,t,i){return new("point-3d"===e.type?ie:E.p)(e,t,i)}(n,this.symbolCreationContext,r);return s.load((function(){var e=s.extentPadding;e>i.extentPadding&&i._set("extentPadding",e),i.notifyChange("averageSymbolComplexity")}),(function(){})),s}},{key:"getOrCreateGraphics3DSymbol",value:function(e,t){var i=this,r=this._symbols.get(e.id);return void 0===r&&(r=e instanceof v.f?new E.h(e,(function(e){return i._frameTask.schedule(e)}),(function(e){return i._createGraphics3DSymbol(e,t)})):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,r)),(0,m.r)(r)&&++r.referenced,r}},{key:"trackGraphicState",value:function(e){return(0,m.t)(this._graphicStateTracking)&&(this._graphicStateTracking=new re(this)),this._graphicStateTracking.add(e)}},{key:"_addGraphics3DGraphic",value:function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_removeGraphics3DGraphic",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,i&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_createGraphics3DGraphic",value:function(e,t){var i,r,n,a=t.graphic;if(this._graphicsWithoutSymbol.delete(a.uid),!this._symbols.has(e.symbol.id))return this.add([a]),null;if(this.graphics3DGraphics.has(a.uid))return null;var s=e.createGraphics3DGraphic(t);if((0,m.t)(s))return null;this._addGraphics3DGraphic(s);var o=e.symbol.id;if(this._graphicsBySymbol.has(o)||this._graphicsBySymbol.set(o,new Map),this._graphicsBySymbol.get(o).set(a.uid,s),s.isDraped&&this._graphicsDrapedUids.add(a.uid),s.centroid=null,(0,m.r)(a.geometry)&&"point"!==a.geometry.type&&(s.centroid=(0,E.A)(a.geometry,this._viewSpatialReference)),this._updateUserVisibility(s),(0,m.r)(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(s),(0,m.r)(this._filterVisibility)){var l=this._filterVisibility.defaultVisibility;s.setVisibilityFlag(E.C.FILTER,l,E.E.GRAPHIC),l||this._filterVisibility.reapply()}null!==(i=this._deconflictor)&&void 0!==i&&i.addGraphic(s),null!==(r=this._labeler)&&void 0!==r&&r.addGraphic(s),null!==(n=this._objectStates)&&void 0!==n&&n.addGraphic(s),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,s),s.initialize(this.stage,this.stageLayer,this.owner),(0,m.r)(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(s);var h=this._whenGraphics3DGraphicRequests[a.uid];return h&&(delete this._whenGraphics3DGraphicRequests[a.uid],h.resolve(s)),s}},{key:"_abortRendererChange",value:function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}},{key:"rendererChange",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i,r,n,a,o,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._abortRendererChange(),t===this.currentRenderer){e.next=37;break}if(this._validateRenderer(t),(0,m.t)(t)&&this._currentRendererChange(null,!1),!(0,R.s)(t)){e.next=36;break}if(!(0,m.r)(t)||!t.arcadeRequired){e.next=25;break}return i=new AbortController,this._rendererChangeAbortController=i,e.next=7,this._ensureArcade();case 7:if(r=e.sent,n=r.arcadeUtils,(0,f.f)(i),a=n.hasGeometryOperations(t),e.t0=a,!e.t0){e.next=16;break}return e.next=15,n.enableGeometryOperations();case 15:(0,f.f)(i);case 16:if(this.effectiveUpdatePolicy!==B.i.ASYNC){e.next=21;break}return e.next=19,this._frameTask.schedule((function(){return l._currentRendererChange(t,a)}),i.signal);case 19:e.next=22;break;case 21:this._currentRendererChange(t,a);case 22:this._rendererChangeAbortController=null,e.next=34;break;case 25:if(this.effectiveUpdatePolicy!==B.i.ASYNC){e.next=33;break}return o=new AbortController,this._rendererChangeAbortController=o,e.next=30,this._frameTask.schedule((function(){return l._currentRendererChange(t,!1)}),o.signal);case 30:this._rendererChangeAbortController=null,e.next=34;break;case 33:this._currentRendererChange(t,!1);case 34:e.next=37;break;case 36:this._currentRendererChange(t,!1);case 37:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_ensureArcade",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,m.t)(this._arcadeOnDemand)){e.next=7;break}return e.next=3,(0,D.i)();case 3:this._arcadeOnDemand=e.sent,e.t0=this._arcadeOnDemand,e.next=8;break;case 7:e.t0=this._arcadeOnDemand;case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_currentRendererChange",value:function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=(0,m.e)(this._arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this._symbolConversionCache.clear(),(0,m.t)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();var r=(0,b.m)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,(0,m.t)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}},{key:"_diffHasSymbolChange",value:function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}},{key:"_applySymbolSetDiff",value:function(e,t,i){var r=this;e=e||[],t=t||[];var n,a=[],s=(0,c.Z)(t);try{var o=function(){var t=n.value,s=r._graphicsBySymbol.get(t.id);s&&s.forEach((function(n,o){var l=n.graphic,h=r.layer instanceof k.b?r.layer:null,c=(0,m.e)(r._arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol((0,E.f)(l,h),{arcade:c})!==i.defaultSymbol){var u=n.usedMemory;e.length||i.defaultSymbol?a.push(l):r._graphicsWithoutSymbol.set(o,l);var d=r.graphics3DGraphics.get(o);r._conditionalRemove(d,o),n.destroy(),s.delete(o),r._removeGraphics3DGraphic(o,u),r._updateLayerVisibility()}})),r._whenSymbolRemoved.forAll((function(e){return e(t.id)}))};for(s.s();!(n=s.n()).done;)o()}catch(l){s.e(l)}finally{s.f()}(e.length||a.length)&&(this._graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this._graphicsWithoutSymbol.clear(),this.add(a)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_applyUniqueValueRendererDiff",value:function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map((function(e){return e.symbol})):[],s=n?n.removed.map((function(e){return e.symbol})):[];if(n)for(var o=0;o<n.changed.length;o++)a.push(n.changed[o].newValue.symbol),s.push(n.changed[o].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&s.push(t.defaultSymbol),this._applySymbolSetDiff(a,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}},{key:"_calculateUnchangedSymbolMapping",value:function(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||(0,m.r)(e)&&"partial"!==e.type)return[];var r,n=function(e){return(0,m.r)(e)?e.id:null},a=e&&e.diff,s=a&&a.defaultSymbol,o=a&&a.uniqueValueInfos;if(o)r=o.unchanged.map((function(e){return{oldId:n(e.oldValue.symbol),newId:n(e.newValue.symbol)}}));else{r=[];var l,h=(0,c.Z)(i.uniqueValueInfos);try{var u=function(){var e=l.value,i=n(e.symbol),a=t.uniqueValueInfos.find((function(t){return t.value===e.value}));a&&i!==n(a.symbol)&&r.push({oldId:i,newId:n(a.symbol)})};for(h.s();!(l=h.n()).done;)u()}catch(d){h.e(d)}finally{h.f()}}return!s&&i.defaultSymbol&&r.push({oldId:n(i.defaultSymbol),newId:n(t.defaultSymbol)}),r}},{key:"_updateSymbolMapping",value:function(e,t){var i=(0,m.r)(t)&&t?"string"==typeof t?t:t.id:null;if(e&&e!==i){var r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(i,r);var n=this._symbols.get(e);if(void 0!==n&&(this._symbols.delete(e),this._symbols.set(i,n),(0,m.r)(n))){var a="string"==typeof t?null:t;(0,m.r)(a)?n.symbol=a:n.symbol.id=i}}}},{key:"_updateUnchangedSymbolMappings",value:function(e,t,i){var r,n=this._calculateUnchangedSymbolMapping(e,t,i),a=(0,c.Z)(n);try{for(a.s();!(r=a.n()).done;){var s=r.value,o=s.oldId,l=s.newId;this._updateSymbolMapping(o,l)}}catch(h){a.e(h)}finally{a.f()}}},{key:"_applyRendererDiff",value:function(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof g.C&&i instanceof g.C&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;var r,a=(0,c.Z)(this._graphicsBySymbol);try{for(a.s();!(r=a.n()).done;){var s=(0,n.Z)(r.value,1)[0],o=this._symbols.get(s);if((0,m.r)(o))switch(o.applyRendererDiff(e,t)){case E.i.Recreate_Symbol:this._recreateSymbol(s);break;case E.i.Recreate_Graphics:this._recreateGraphicsForSymbol(s)}}}catch(l){a.e(l)}finally{a.f()}return!0}},{key:"opacityChange",value:function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this._updateStageLayerVisibility()}},{key:"_slicePlaneEnabledChange",value:function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}},{key:"_physicalBasedRenderingChange",value:function(e){var t=this;this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,i,r){e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||t._recreateSymbol(r)}))}},{key:"_skipHighSymbolLoDsChange",value:function(e){var t=this;this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((function(e,i,r){return t._recreateSymbol(r)}))}},{key:"_pixelRatioChange",value:function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))}},{key:"_signalUpdatingDuringAsyncLoadedGraphicsChange",value:function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,f.k)((function(){e._updatingPendingLoadedGraphicsChange=null}))}},{key:"setClippingExtent",value:function(e,t){var i=this.symbolCreationContext.clippingExtent,r=(0,G.u)();return(0,E.k)(e,r,t)?this.symbolCreationContext.clippingExtent=(0,w.G)((0,w.a)(),r):this.symbolCreationContext.clippingExtent=null,!(0,w.S)(this.symbolCreationContext.clippingExtent,i)}},{key:"modifyGraphics3DGraphicVisibilities",value:function(e){var t,i=!1;this.graphics3DGraphics.forEach((function(t){e(t)&&(i=!0)})),i&&(null!==(t=this.owner.view.labeler)&&void 0!==t&&t.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"forEachGraphics3DSymbol",value:function(e){var t,i=(0,c.Z)(this._symbols);try{for(i.s();!(t=i.n()).done;){var r=(0,n.Z)(t.value,2),a=r[0],s=r[1];if((0,m.t)(s))return;e(s,this._graphicsBySymbol.get(a)||Ge,a)}}catch(o){i.e(o)}finally{i.f()}}},{key:"updateAllGraphicsVisibility",value:function(){var e=this;(0,m.r)(this._filterVisibility)&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=(0,m.r)(e._scaleVisibility)&&e._scaleVisibility.updateVisibility(t);return i||r}))}},{key:"_hideAllGraphics",value:function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(E.C.USER_SETTING,!1,E.E.GRAPHIC)}))}},{key:"_validateRenderer",value:function(e){var t,i=(0,R.u)(e,{geometryType:null===(t=this.layer)||void 0===t?void 0:t.geometryType});if(i){var r="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");me.warn(r,i.message)}}},{key:"_volatileGraphicsUpdated",value:function(){var e;null!==(e=this._labeler)&&void 0!==e&&e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}},{key:"_cleanupSymbols",value:function(){var e=this;if(!(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)){var t=!1;this._symbols.forEach((function(i,r){if(!((0,m.t)(i)||i.referenced>0)){var n=e._graphicsBySymbol.get(r);n&&0!==n.size||(e._graphicsBySymbol.delete(r),e._symbols.delete(r),(0,m.g)(i),t=!0)}})),t&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}},{key:"test",get:function(){var e=this;return{snapshotInternals:function(){return{graphics:(0,r.Z)(e.graphics3DGraphics.keys()).sort(),symbols:(0,r.Z)(e._symbols.keys()).sort(),graphicsBySymbol:(0,r.Z)(e._graphicsBySymbol.keys()).sort().map((function(t){return{symbolId:t,graphics:(0,r.Z)(e._graphicsBySymbol.get(t).keys()).sort()}})),graphicsWithoutSymbol:(0,r.Z)(e._graphicsWithoutSymbol.keys()).sort(),graphicsDrapedUids:(0,r.Z)(e._graphicsDrapedUids).sort(),pendingUpdates:e._pendingUpdates}},symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:function(t){e.forcedUpdatePolicy=t}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}}]),i}(f.m);_e.tmpVec=(0,S.n)(),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"computedExtent",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"currentRenderer",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"rendererHasGeometryOperations",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_frameTask",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_rendererChangeAbortController",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_elevationInfoChangeAbortController",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_initializeAbortController",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_elevationAlignment",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_scaleVisibility",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_filterVisibility",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_initializePromise",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_spatialIndex",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"extentPadding",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_featureStore",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_deconflictor",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_labeler",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_objectStates",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_loadingSymbols",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"preferredUpdatePolicy",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"forcedUpdatePolicy",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"effectiveUpdatePolicy",null),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"elevationFeatureExpressionEnabled",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"owner",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"layer",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"graphicSymbolSupported",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"componentFactories",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"setUidToIdOnAdd",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"featureStore",null),(0,f.e)([(0,f.y)()],_e.prototype,"initializePromise",null),(0,f.e)([(0,f.y)()],_e.prototype,"scaleVisibility",null),(0,f.e)([(0,f.y)()],_e.prototype,"elevationAlignment",null),(0,f.e)([(0,f.y)()],_e.prototype,"objectStates",null),(0,f.e)([(0,f.y)()],_e.prototype,"filterVisibility",null),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"updating",null),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"running",null),(0,f.e)([(0,f.y)({readOnly:!0})],_e.prototype,"suspendedOrOutsideOfView",null),(0,f.e)([(0,f.y)({readOnly:!0,dependsOn:[]})],_e.prototype,"updatingRemaining",null),(0,f.e)([(0,f.y)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],_e.prototype,"displayFeatureLimit",null),(0,f.e)([(0,f.y)({readOnly:!0,dependsOn:[]})],_e.prototype,"averageSymbolComplexity",null),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"hasZ",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],_e.prototype,"hasM",void 0),(0,f.e)([(0,f.y)()],_e.prototype,"_objectIdField",null),_e=oe=(0,f.e)([(0,f.n)(ve)],_e),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(le||(le={}));var be=function(){function e(){(0,u.Z)(this,e),this.add=null,this.renderingInfo=null,this.state=le.NEW,this.remove=null}return(0,d.Z)(e,[{key:"clear",value:function(){this.add=null,this.renderingInfo=null,this.state=le.NEW,this.abortController=null,this.remove=null}}]),e}(),Se=10,Ce=(0,S.n)(),we=(0,S.n)(),Ge=new Map,xe=f.a.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility"),ke=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._scaleRangeActive=!1,r._layerScaleRangeVisibilityQuery=!1,r._extent=null,r.graphicsCoreOwner=null,r.layer=null,r.queryGraphicUIDsInExtent=null,r.graphicsCore=null,r.basemapTerrain=null,r.layerScaleEnabled=!0,r.suspended=!1,r._dirty=!0,r}return(0,d.Z)(i,[{key:"initialize",value:function(){var e=this;this.updateScaleRangeActive();var t=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(t.registerTask(N.I.SCALE_VISIBILITY,this)),this.updatingHandles.add((function(){return e.layer.effectiveScaleRange}),(function(){return e.layerMinMaxScaleChangeHandler()}))}},{key:"destroy",value:function(){this.updatingHandles.removeAll(),this.handles.removeAll(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}},{key:"updating",get:function(){return this._dirty||this.updatingHandles.updating}},{key:"_setDirty",value:function(){this._dirty=!0}},{key:"setExtent",value:function(e){var t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this._extent=e;else{var r=(0,G.u)();(0,C.v)(e,t,r,i)?this._extent=r:this._extent=null}this._setDirty()}},{key:"scaleRangeActive",value:function(){return this._scaleRangeActive}},{key:"updateScaleRangeActive",value:function(){var e=this,t=this.layer,i=t.effectiveScaleRange,r=this.layerScaleEnabled&&Ie(i.minScale,i.maxScale);t.labelingInfo&&!r&&(r=t.labelingInfo.some((function(e){return e&&Ie(e.minScale,e.maxScale)})));var n=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.handles.has(Ee)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),Ee),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(function(){return e._setDirty()})),Ee)):!r&&this.handles.has(Ee)&&this.handles.remove(Ee),n}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}},{key:"runTask",value:function(){var e=this,t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this._layerScaleRangeVisibilityQuery){this._layerScaleRangeVisibilityQuery=!0;var i=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,i.minScale,i.maxScale,(function(t){return e._finishUpdate(t)}))}}else this._finishUpdate(!0)}},{key:"_finishUpdate",value:function(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}},{key:"_visibleAtLayerScale",value:function(e){var t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,q.c)(e,t.minScale||0,t.maxScale||0)}},{key:"_visibleAtLabelScale",value:function(e,t){return(0,q.c)(e,t.minScale||0,t.maxScale||0)}},{key:"_graphicScale",value:function(e){var t;return(0,m.r)(e.centroid)?t=e.centroid:(0,m.r)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}},{key:"_graphicVisible",value:function(e){if(!this.layerScaleEnabled)return!0;var t=this._graphicScale(e);return this._visibleAtLayerScale(t)}},{key:"updateVisibility",value:function(e){if(this._scaleRangeActive){var t=this._graphicVisible(e);return e.setVisibilityFlag(E.C.SCALE_RANGE,t,E.E.GRAPHIC)}return!1}},{key:"updateGraphicLabelScaleVisibility",value:function(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}},{key:"_updateLabelScaleVisibility",value:function(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(E.C.SCALE_RANGE,r,E.E.LABEL))return!0}return!1}},{key:"_scaleUpdateHandler",value:function(e){var t=this;if(this._setDirty(),!this.graphicsCoreOwner.suspended){var i=e.extent,r=e.scale,n=this._visibleAtLayerScale(r),a=!1,s=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if((0,m.t)(o))xe.error("scaleUpdate: Internal error, no SpatialReference given for tiles");else{var l=!o.equals(s);if(!l||(0,C.v)(i,o,Re,s)){var h=l?Re:i;this.queryGraphicUIDsInExtent(h,s,(function(e){var s=t.graphicsCore.getGraphics3DGraphicById(e);if(!(0,m.t)(s)){var o=s.centroid;(0,m.r)(o)&&(i[0]>o.x||i[1]>o.y||i[2]<o.x||i[3]<o.y)||(s.setVisibilityFlag(E.C.SCALE_RANGE,n,E.E.GRAPHIC)&&(a=!0),t._updateLabelScaleVisibility(s,r)&&(a=!0))}})),a&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}else xe.error("scaleUpdate: Internal error, cannot project AABR from "+o+" to wkid "+s)}}}},{key:"layerMinMaxScaleChangeHandler",value:function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(E.C.SCALE_RANGE)})):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}}]),i}(W.d);function Ie(e,t){return e>0||t>0}(0,f.e)([(0,f.y)()],ke.prototype,"graphicsCoreOwner",void 0),(0,f.e)([(0,f.y)()],ke.prototype,"layer",void 0),(0,f.e)([(0,f.y)()],ke.prototype,"queryGraphicUIDsInExtent",void 0),(0,f.e)([(0,f.y)()],ke.prototype,"graphicsCore",void 0),(0,f.e)([(0,f.y)()],ke.prototype,"basemapTerrain",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],ke.prototype,"layerScaleEnabled",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],ke.prototype,"suspended",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],ke.prototype,"updating",null),(0,f.e)([(0,f.y)()],ke.prototype,"_dirty",void 0),ke=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],ke);var Ee="terrain-events",Re=(0,G.u)(),De=ke,Oe=function(){function e(){(0,u.Z)(this,e),this._extents=new f.a6({allocator:function(e){return e||(0,G.u)()}}),this._tmpExtent=(0,G.u)(),this._dirty=!1}return(0,d.Z)(e,[{key:"empty",get:function(){return 0===this._extents.length}},{key:"size",get:function(){return this._extents.length}},{key:"clear",value:function(){this._extents.clear()}},{key:"add",value:function(e){this._contains(e)||(this._removeContained(e),(0,G.a)(this._extents.pushNew(),e),this._dirty=!0)}},{key:"pop",value:function(){return this._dirty&&this._mergeTight(),this._extents.pop()}},{key:"merge",value:function(e){return this._mergeTight(e),e.hasProgressed}},{key:"_mergeTight",value:function(){for(var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:N.F,i=this._extents,r=new Set,n=0;n!==i.length;){i.sort((function(e,t){return e[0]-t[0]})),n=i.length,r.clear();for(var a=function(n){if(t.done)return{v:void 0};var a=i.getItemAt(n);if(a){for(var s=n+1;s<i.length;++s){var o=i.getItemAt(s);if(null==o||o[0]>=a[2])break;r.add(o)}r.forEach((function(n){if(a!==n)if(n[2]<=a[0])r.delete(n);else{var s=(0,G.y)(a),o=(0,G.y)(n),l=e._tmpExtent;(0,G.h)(a,n,l);var h=s+o;((0,G.y)(l)-h)/h<.05&&((0,G.a)(a,l),r.delete(n),i.remove(n),t.madeProgress())}})),r.add(a)}},s=0;s<i.length;++s){var o=a(s);if("object"===typeof o)return o.v}}this._dirty=!1}},{key:"_contains",value:function(e){return this._extents.some((function(t){return(0,G.R)(t,e)}))}},{key:"_removeContained",value:function(e){this._extents.filterInPlace((function(t){return!(0,G.R)(e,t)}))}},{key:"test",get:function(){var e=this;return{containsPoint:function(t){return e._extents.some((function(e){return(0,G.b)(e,t)}))}}}}]),e}(),Ae=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._dirtyExtents=new Oe,r._globalDirty=!1,r._averageExtentUpdateSize=0,r._dirtyGraphicsSet=new Set,r._handles=new f.X,r._updateElevation=!1,r.graphicsCoreOwner=null,r.graphicsCore=null,r.events=new L.n,r}return(0,d.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.elevationProvider,i=this.graphicsCoreOwner.view.resourceController.scheduler;this._handles.add([t.on("elevation-change",(function(t){return e._elevationChanged(t)})),(0,_.l)((function(){return e.graphicsCoreOwner.suspended}),(function(){return e._suspendedChange()})),i.registerTask(N.I.ELEVATION_ALIGNMENT,this)])}},{key:"destroy",value:function(){this._dirtyGraphicsSet.clear(),this._handles.destroy(),this._handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}},{key:"clear",value:function(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}},{key:"_suspendedChange",value:function(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}},{key:"elevationInfoChange",value:function(){this._globalDirty=!0,this.notifyChange("updating")}},{key:"updating",get:function(){return this.running}},{key:"running",get:function(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}},{key:"updatingRemaining",get:function(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}},{key:"runTask",value:function(e){var t=this;for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((function(){return t._dirtyExtents.merge(e)}));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating")}},{key:"_updateDirtyGraphics",value:function(e){var t,i=this.graphicsCoreOwner.view.renderCoordsHelper,r=this.graphicsCore.effectiveUpdatePolicy===B.i.ASYNC,n=(0,c.Z)(this._dirtyGraphicsSet.keys());try{for(n.s();!(t=n.n()).done;){var a=t.value,s=this.graphicsCore.getGraphics3DGraphicById(a);if(this._dirtyGraphicsSet.delete(a),(0,m.r)(s)&&(s.alignWithElevation(this.elevationProvider,i,r),e.madeProgress()),e.done)return}}catch(o){n.e(o)}finally{n.f()}}},{key:"_updateDirtyExtents",value:function(e){for(var t=this;!this._dirtyExtents.empty&&!e.done;){var i=this._dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:i,spatialReference:r});var n=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(i,r,(function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);(0,m.r)(i)&&i.needsElevationUpdates()&&t._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-n)+.9*this._averageExtentUpdateSize,e.madeProgress()}}},{key:"_markAllGraphicsElevationDirty",value:function(){var e=this;this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((function(t,i){return e._dirtyGraphicsSet.add(i)}))}},{key:"_elevationChanged",value:function(e){if("scene"!==e.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var t=e.extent,i=e.spatialReference;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){var r=this.graphicsCore.computedExtent;r&&t[2]>r.xmin&&t[0]<r.xmax&&t[3]>r.ymin&&t[1]<r.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}}}]),i}(f.m);(0,f.e)([(0,f.y)()],Ae.prototype,"graphicsCoreOwner",void 0),(0,f.e)([(0,f.y)()],Ae.prototype,"graphicsCore",void 0),(0,f.e)([(0,f.y)()],Ae.prototype,"queryGraphicUIDsInExtent",void 0),(0,f.e)([(0,f.y)()],Ae.prototype,"elevationProvider",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],Ae.prototype,"updating",null),(0,f.e)([(0,f.y)({readOnly:!0})],Ae.prototype,"updatingRemaining",null);var Pe=Ae=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],Ae),Le=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e)).suspended=!1,r._extent=null,r._extentIntersectionDirty=!0,r._isVisibleBelowSurfaceInternal=!1,r._handles=new f.X,r.graphicsCoreOwner=null,r.updating=!0,r}return(0,d.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.graphicsCoreOwner;this._extentIntersection=new E.N({renderCoordsHelper:t.view.renderCoordsHelper});var i=t.view,r=i.basemapTerrain,n=i.resourceController.scheduler;this._handles.add([i.on("resize",(function(){return e._viewChange()})),(0,_.l)((function(){return i.state.camera}),(function(){return e._viewChange()}),_.U),n.registerTask(N.I.FRUSTUM_VISIBILITY,this),(0,_.l)((function(){return r.visibleElevationBounds}),(function(){return e._elevationBoundsChange()}))]),"local"===i.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([(0,_.l)((function(){var e,t,n;return[r.baseOpacity,r.wireframe,null===(e=i.map)||void 0===e||null===(t=e.ground)||void 0===t||null===(n=t.navigationConstraint)||void 0===n?void 0:n.type]}),(function(){return e._updateIsVisibleBelowSurface()}),_.h)])}},{key:"destroy",value:function(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null,this._handles=(0,m.g)(this._handles)}},{key:"_setDirty",value:function(){this.updating||this._set("updating",!0)}},{key:"setExtent",value:function(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}},{key:"_viewChange",value:function(){this._setDirty()}},{key:"_elevationBoundsChange",value:function(){this._setDirty(),this._extentIntersectionDirty=!0}},{key:"_isVisibleBelowSurface",set:function(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}},{key:"_updateIsVisibleBelowSurface",value:function(){var e=this.graphicsCoreOwner.view,t=e.basemapTerrain,i="local"===e.viewingMode,r=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this._isVisibleBelowSurface=i||!t.opaque||r}},{key:"_updateExtentIntersection",value:function(){if(this._extentIntersectionDirty){this._extentIntersectionDirty=!1;var e,t=this.graphicsCoreOwner.view;if(this._isVisibleBelowSurfaceInternal)e=-.3*(0,T.u)(t.spatialReference).radius;else{var i=t.basemapTerrain.visibleElevationBounds,r=i.min,n=i.max;e=r-Math.max(1,(n-r)*(1.2-1))}this._extentIntersection.update(this._extent,t.spatialReference,e)}}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){if(this._set("updating",!1),this._extent){this._updateExtentIntersection();var e=this.graphicsCoreOwner.view.frustum,t=(0,T.u)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t))}else this._set("suspended",!1)}}]),i}(f.m);(0,f.e)([(0,f.y)({readOnly:!0})],Le.prototype,"suspended",void 0),(0,f.e)([(0,f.y)({constructOnly:!0})],Le.prototype,"graphicsCoreOwner",void 0),(0,f.e)([(0,f.y)({readOnly:!0})],Le.prototype,"updating",void 0);var Ve,Ue=Le=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],Le);!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(Ve||(Ve={}));var je=function(){function e(){(0,u.Z)(this,e),this._items=[]}return(0,d.Z)(e,[{key:"addObject",value:function(e,t){this._items.push({type:Ve.Object,objectStateId:t,object:e})}},{key:"addRenderGeometry",value:function(e,t,i){this._items.push({type:Ve.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}},{key:"addExternal",value:function(e,t){this._items.push({type:Ve.External,objectStateId:t,remove:e})}},{key:"remove",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeObject",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.type===Ve.Object&&i.object===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeRenderGeometry",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.type===Ve.RenderGeometry&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeAll",value:function(){var e=this;this._items.forEach((function(t){e._removeObjectStateItem(t)})),this._items=[]}},{key:"_removeObjectStateItem",value:function(e){switch(e.type){case Ve.Object:e.objectStateId.channel===B.u.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===B.u.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case Ve.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case Ve.External:e.remove(e.objectStateId)}}}]),e}(),Ze=function(){function e(t,i){(0,u.Z)(this,e),this.stateType=t,this.objectIdField=i,this.objectStateSet=new je,this.ids=new Set,this.paused=!1}return(0,d.Z)(e,[{key:"hasGraphic",value:function(e){if(this.objectIdField){var t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}]),e}(),Te=function(){function e(t){(0,u.Z)(this,e),this._graphicsCore=t,this._stateSets=new Array}return(0,d.Z)(e,[{key:"destroy",value:function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()})),this._stateSets=null}},{key:"acquireSet",value:function(e,t){var i=this,r=new Ze(e,t);this._stateSets.push(r);var n=(0,f.D)((function(){return i.releaseSet(r)}));return{set:r,handle:n}}},{key:"releaseSet",value:function(e){e.objectStateSet.removeAll();var t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}},{key:"_addObjectStateSet",value:function(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}},{key:"_removeObjectStateSet",value:function(e,t){e.removeObjectState(t.objectStateSet)}},{key:"setUid",value:function(e,t){e.ids.add(t);var i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}},{key:"setUids",value:function(e,t){var i=this;t.forEach((function(t){return i.setUid(e,t)}))}},{key:"setObjectIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this._initializeSet(e)}},{key:"addGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){!i.paused&&i.hasGraphic(e)&&t._addObjectStateSet(e,i)}))}},{key:"removeGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){i.hasGraphic(e)&&t._removeObjectStateSet(e,i)}))}},{key:"allGraphicsDeleted",value:function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()}))}},{key:"_initializeSet",value:function(e){var t=this,i=this._graphicsCore.graphics3DGraphics;e.objectIdField?i.forEach((function(i){i&&e.hasGraphic(i)&&t._addObjectStateSet(i,e)})):e.ids.forEach((function(r){var n=i.get(r);n&&t._addObjectStateSet(n,e)}))}},{key:"test",get:function(){return{states:this._stateSets}}}]),e}()},25874:function(e,t,i){i.d(t,{s:function(){return o},u:function(){return l}});var r=i(1413),n=i(93661),a=i(48848),s=i(70449);function o(e){return(0,n.t)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function l(e,t){if((0,n.t)(e))return null;if(!o(e))return new a.s("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(e.type||e.declaredClass,"'"),{renderer:e});switch(e.type){case"simple":return h(i=e,(0,s.S)(i.symbol).error);case"unique-value":return function(e,t){var i,a=(0,r.Z)((0,r.Z)({},s.a),t),o=null===(i=e.uniqueValueInfos)||void 0===i?void 0:i.map((function(e){return(0,s.S)(e.symbol,a).error})).filter(n.r),l=(0,s.S)(e.defaultSymbol,a);return l.error&&null!==o&&void 0!==o&&o.unshift(l.error),h(e,o)}(e,t);case"class-breaks":return function(e){var t=e.classBreakInfos.map((function(e){return(0,s.S)(e.symbol).error})).filter(n.r),i=(0,s.S)(e.defaultSymbol);return i.error&&t.unshift(i.error),h(e,t)}(e);case"dictionary":case"heatmap":return null}var i;return null}function h(e,t){if(!t)return null;var i;if((i=Array.isArray(t)?t:[t]).length>0){var r=i.map((function(e){return e.details.symbol.type||e.details.symbol.declaredClass})).filter((function(e){return!!e}));r.sort();var n=[];return r.forEach((function(e,t){0!==t&&e===r[t-1]||n.push(e)})),new a.s("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(n.join(", "),") which are not supported in 3D"),{renderer:e,symbolErrors:i})}return null}}}]);
//# sourceMappingURL=6419.4a9463c4.chunk.js.map