"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[4566,4904,5526,1015],{85026:function(e,t,r){r.d(t,{A:function(){return R},B:function(){return L},C:function(){return W},D:function(){return X},E:function(){return M},F:function(){return Z},G:function(){return Y},H:function(){return Q},I:function(){return N},L:function(){return I},M:function(){return V},O:function(){return A},S:function(){return B},T:function(){return S},U:function(){return F},V:function(){return U},a:function(){return b},b:function(){return w},c:function(){return g},d:function(){return P},g:function(){return E},h:function(){return O},i:function(){return y},j:function(){return z},k:function(){return G},l:function(){return _},m:function(){return C},o:function(){return T},p:function(){return x},q:function(){return H},u:function(){return m},v:function(){return j},w:function(){return D},x:function(){return k},y:function(){return v},z:function(){return q}});var n=r(60136),i=r(29388),a=r(15671),o=r(43144),s=r(29048),l=r(71802),u=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.elementCount=9;var s=this.TypedArrayConstructor;void 0===i&&(i=9*s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"getMat",value:function(e,t){for(var r=e*this.typedBufferStride,n=0;n<9;n++)t[n]=this.typedBuffer[r++];return t}},{key:"setMat",value:function(e,t){for(var r=e*this.typedBufferStride,n=0;n<9;n++)this.typedBuffer[r++]=t[n]}},{key:"get",value:function(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}},{key:"set",value:function(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}},{key:"copyFrom",value:function(e,t,r){for(var n=this.typedBuffer,i=t.typedBuffer,a=e*this.typedBufferStride,o=r*t.typedBufferStride,s=0;s<9;++s)n[a++]=i[o++]}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();u.ElementCount=9;var c=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.elementCount=16;var s=this.TypedArrayConstructor;void 0===i&&(i=16*s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"getMat",value:function(e,t){for(var r=e*this.typedBufferStride,n=0;n<16;n++)t[n]=this.typedBuffer[r++];return t}},{key:"setMat",value:function(e,t){for(var r=e*this.typedBufferStride,n=0;n<16;n++)this.typedBuffer[r++]=t[n]}},{key:"get",value:function(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}},{key:"set",value:function(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}},{key:"copyFrom",value:function(e,t,r){for(var n=this.typedBuffer,i=t.typedBuffer,a=e*this.typedBufferStride,o=r*t.typedBufferStride,s=0;s<16;++s)n[a++]=i[o++]}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();c.ElementCount=16;var h=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.elementCount=1;var s=this.TypedArrayConstructor;void 0===i&&(i=s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.stride=i,this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"get",value:function(e){return this.typedBuffer[e*this.typedBufferStride]}},{key:"set",value:function(e,t){this.typedBuffer[e*this.typedBufferStride]=t}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();h.ElementCount=1;var d=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.elementCount=2;var s=this.TypedArrayConstructor;void 0===i&&(i=2*s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"getVec",value:function(e,t){return e*=this.typedBufferStride,(0,s.r)(t,this.typedBuffer[e],this.typedBuffer[e+1])}},{key:"setVec",value:function(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e]=t[1]}},{key:"get",value:function(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}},{key:"set",value:function(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}},{key:"setValues",value:function(e,t,r){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e]=r}},{key:"copyFrom",value:function(e,t,r){var n=this.typedBuffer,i=t.typedBuffer,a=e*this.typedBufferStride,o=r*t.typedBufferStride;n[a++]=i[o++],n[a]=i[o]}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();d.ElementCount=2;var f=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.elementCount=3;var s=this.TypedArrayConstructor;void 0===i&&(i=3*s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"getVec",value:function(e,t){return e*=this.typedBufferStride,(0,l.o)(t,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}},{key:"setVec",value:function(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e]=t[2]}},{key:"get",value:function(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}},{key:"set",value:function(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}},{key:"setValues",value:function(e,t,r,n){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e]=n}},{key:"copyFrom",value:function(e,t,r){var n=this.typedBuffer,i=t.typedBuffer,a=e*this.typedBufferStride,o=r*t.typedBufferStride;n[a++]=i[o++],n[a++]=i[o++],n[a]=i[o]}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();f.ElementCount=3;var p=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;(0,a.Z)(this,e),this.TypedArrayConstructor=t,this.start=n,this.elementCount=4;var s=this.TypedArrayConstructor;void 0===i&&(i=4*s.BYTES_PER_ELEMENT);var l=0===r.byteLength?0:n;this.typedBuffer=null==o?new s(r,l):new s(r,l,(o-n)/s.BYTES_PER_ELEMENT),this.typedBufferStride=i/s.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}return(0,o.Z)(e,[{key:"sliceBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.count-t,n=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,n,this.stride,n+r*this.stride)}},{key:"getVec",value:function(e,t){return e*=this.typedBufferStride,(0,l.C)(t,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}},{key:"setVec",value:function(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e++]=t[2],this.typedBuffer[e]=t[3]}},{key:"get",value:function(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}},{key:"set",value:function(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}},{key:"setValues",value:function(e,t,r,n,i){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e++]=n,this.typedBuffer[e]=i}},{key:"copyFrom",value:function(e,t,r){var n=this.typedBuffer,i=t.typedBuffer,a=e*this.typedBufferStride,o=r*t.typedBufferStride;n[a++]=i[o++],n[a++]=i[o++],n[a++]=i[o++],n[a]=i[o]}},{key:"buffer",get:function(){return this.typedBuffer.buffer}}]),e}();p.ElementCount=4;var v=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,null,[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);v.ElementType="f32";var m=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);m.ElementType="f32";var y=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);y.ElementType="f32";var g=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);g.ElementType="f32";var _=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(u);_.ElementType="f32";var b=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(u);b.ElementType="f64";var x=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float32Array,e,i,o,s)).elementType="f32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(c);x.ElementType="f32";var w=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(c);w.ElementType="f64";var T=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);T.ElementType="f64";var C=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);C.ElementType="f64";var S=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);S.ElementType="f64";var O=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Float64Array,e,i,o,s)).elementType="f64",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);O.ElementType="f64";var P=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint8Array,e,i,o,s)).elementType="u8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);P.ElementType="u8";var R=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint8Array,e,i,o,s)).elementType="u8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);R.ElementType="u8";var A=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint8Array,e,i,o,s)).elementType="u8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);A.ElementType="u8";var k=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint8Array,e,i,o,s)).elementType="u8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);k.ElementType="u8";var E=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint16Array,e,i,o,s)).elementType="u16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);E.ElementType="u16";var D=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint16Array,e,i,o,s)).elementType="u16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);D.ElementType="u16";var M=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint16Array,e,i,o,s)).elementType="u16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);M.ElementType="u16";var I=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint16Array,e,i,o,s)).elementType="u16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);I.ElementType="u16";var L=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint32Array,e,i,o,s)).elementType="u32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);L.ElementType="u32";var Z=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint32Array,e,i,o,s)).elementType="u32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);Z.ElementType="u32";var N=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint32Array,e,i,o,s)).elementType="u32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);N.ElementType="u32";var F=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Uint32Array,e,i,o,s)).elementType="u32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);F.ElementType="u32";var z=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int8Array,e,i,o,s)).elementType="i8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);z.ElementType="i8";var U=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int8Array,e,i,o,s)).elementType="i8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);U.ElementType="i8";var V=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int8Array,e,i,o,s)).elementType="i8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);V.ElementType="i8";var B=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int8Array,e,i,o,s)).elementType="i8",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);B.ElementType="i8";var G=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int16Array,e,i,o,s)).elementType="i16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);G.ElementType="i16";var H=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int16Array,e,i,o,s)).elementType="i16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);H.ElementType="i16";var j=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int16Array,e,i,o,s)).elementType="i16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);j.ElementType="i16";var q=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int16Array,e,i,o,s)).elementType="i16",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);q.ElementType="i16";var W=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int32Array,e,i,o,s)).elementType="i32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(h);W.ElementType="i32";var X=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int32Array,e,i,o,s)).elementType="i32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(d);X.ElementType="i32";var Y=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int32Array,e,i,o,s)).elementType="i32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(f);Y.ElementType="i32";var Q=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;return(0,a.Z)(this,r),(n=t.call(this,Int32Array,e,i,o,s)).elementType="i32",n}return(0,o.Z)(r,[{key:"slice",value:function(e,t){return this.sliceBuffer(r,e,t)}}],[{key:"fromTypedArray",value:function(e,t){return new r(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}}]),r}(p);Q.ElementType="i32"},1797:function(e,t,r){r.d(t,{A:function(){return D},E:function(){return E},O:function(){return I},T:function(){return k},_:function(){return P},a:function(){return N},b:function(){return L},c:function(){return S},d:function(){return c},g:function(){return A},h:function(){return M},l:function(){return O},m:function(){return C},n:function(){return u},p:function(){return R},r:function(){return h},t:function(){return Z}});var n=r(29439),i=r(13239),a=r(27205),o=r(93122),s=r(75833),l=r(11448);function u(){return new Float32Array(4)}function c(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function h(e,t,r,n){var i=new Float32Array(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=n,i}function d(){return u()}function f(){return h(1,1,1,1)}function p(){return h(1,0,0,0)}function v(){return h(0,1,0,0)}function m(){return h(0,0,1,0)}function y(){return h(0,0,0,1)}var g=d(),_=f(),b=p(),x=v(),w=m(),T=y();function C(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],l=!(i&&"u8"===t.pixelType),u=l?o.G.FLOAT:o.G.UNSIGNED_BYTE,c=null==t.pixels||0===t.pixels.length?null:l?t.getAsRGBAFloat():t.getAsRGBA(),h=null===(r=e.capabilities.textureFloat)||void 0===r?void 0:r.textureFloatLinear,d={width:t.width,height:t.height,target:o.M.TEXTURE_2D,pixelFormat:o.P.RGBA,internalFormat:e.type===a.r.WEBGL2&&l?o.U.RGBA32F:o.P.RGBA,samplingMode:!h||"bilinear"!==n&&"cubic"!==n?o.L.NEAREST:o.L.LINEAR,dataType:u,wrapMode:o.D.CLAMP_TO_EDGE,flipped:!1};return new s.E(e,d,c)}function S(e,t){var r=t.spacing,i=t.offsets,l=t.coefficients,u=(0,n.Z)(t.size,2),c=u[0],h=u[1],d=r[0]>1,f={width:d?4*c:c,height:h,target:o.M.TEXTURE_2D,pixelFormat:o.P.RGBA,internalFormat:e.type===a.r.WEBGL2?o.U.RGBA32F:o.P.RGBA,dataType:o.G.FLOAT,samplingMode:o.L.NEAREST,wrapMode:o.D.CLAMP_TO_EDGE,flipped:!1},p=new Float32Array(d?c*h*16:2*i.length);if(d)for(var v=0,m=0;v<l.length;v++)p[m++]=l[v],v%3==2&&(p[m++]=1);else for(var y=0;y<h;y++)for(var g=0;g<c;g++){var _=4*(y*c+g),b=2*(g*h+y);p[_]=i[b],p[_+1]=i[b+1],p[_+3]=-1===i[b]?0:1}return new s.E(e,f,p)}function O(e,t){var r={width:t.length/4,height:1,target:o.M.TEXTURE_2D,pixelFormat:o.P.RGBA,internalFormat:o.P.RGBA,dataType:o.G.UNSIGNED_BYTE,samplingMode:o.L.NEAREST,wrapMode:o.D.CLAMP_TO_EDGE,flipped:!1};return new s.E(e,r,t)}function P(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return{u_flipY:a,u_applyTransform:!!e,u_opacity:n,u_transformSpacing:e?e.spacing:i.f,u_transformGridSize:e?e.size:i.f,u_targetImageSize:t,u_srcImageSize:r}}function R(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function A(e,t){return{u_scale:e,u_offset:t}}function k(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function E(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}function D(e,t){for(var r,n=e.gl,i=t.glName,a=n.getProgramParameter(i,n.ACTIVE_UNIFORMS),o=new Map,s=0;s<a;s++)(r=n.getActiveUniform(i,s))&&o.set(r.name,{location:n.getUniformLocation(i,r.name),info:r});return o}function M(e,t,r){Object.keys(r).forEach((function(n){var i=t.get(n)||t.get(n+"[0]");i&&function(e,t,r,n){if(null===n||null==r)return!1;var i=n.info;switch(i.type){case o.o.FLOAT:i.size>1?e.setUniform1fv(t,r):e.setUniform1f(t,r);break;case o.o.FLOAT_VEC2:e.setUniform2fv(t,r);break;case o.o.FLOAT_VEC3:e.setUniform3fv(t,r);break;case o.o.FLOAT_VEC4:e.setUniform4fv(t,r);break;case o.o.FLOAT_MAT3:e.setUniformMatrix3fv(t,r);break;case o.o.FLOAT_MAT4:e.setUniformMatrix4fv(t,r);break;case o.o.INT:i.size>1?e.setUniform1iv(t,r):e.setUniform1i(t,r);break;case o.o.BOOL:e.setUniform1i(t,r?1:0);break;case o.o.INT_VEC2:case o.o.BOOL_VEC2:e.setUniform2iv(t,r);break;case o.o.INT_VEC3:case o.o.BOOL_VEC3:e.setUniform3iv(t,r);break;case o.o.INT_VEC4:case o.o.BOOL_VEC4:e.setUniform4iv(t,r);break;default:return!1}}(e,n,r[n],i)}))}function I(e,t,r,n){r.length===n.length&&(n.some((function(e){return null==e}))||r.some((function(e){return null==e}))||r.forEach((function(r,i){t.setUniform1i(r,i),e.bindTexture(n[i],i)})))}Object.freeze(Object.defineProperty({__proto__:null,create:u,clone:c,fromValues:h,createView:function(e,t){return new Float32Array(e,t,4)},zeros:d,ones:f,unitX:p,unitY:v,unitZ:m,unitW:y,ZEROS:g,ONES:_,UNIT_X:b,UNIT_Y:x,UNIT_Z:w,UNIT_W:T},Symbol.toStringTag,{value:"Module"}));var L={geometry:[new l.t("a_pos",2,o.C.BYTE,0,2)]},Z={geometry:[new l.t("a_pos",2,o.C.BYTE,0,4),new l.t("a_tex",2,o.C.BYTE,2,4)]},N={geometry:[new l.t("a_pos",2,o.C.UNSIGNED_SHORT,0,4)]}},64095:function(e,t,r){r.d(t,{r:function(){return h}});var n=r(15671),i=r(43144),a=r(60136),o=r(29388),s=r(37856),l=r(93661),u=r(48848),c=1/(0,l.h)("mapview-transitions-duration"),h=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,n.Z)(this,r),(e=t.apply(this,arguments))._fadeOutResolver=null,e._fadeInResolver=null,e._clips=null,e.computedVisible=!0,e.computedOpacity=1,e.fadeTransitionEnabled=!1,e.inFadeTransition=!1,e._isReady=!1,e._opacity=1,e._stage=null,e._visible=!0,e}return(0,i.Z)(r,[{key:"clips",get:function(){return this._clips},set:function(e){this._clips=e,this.requestRender()}},{key:"isReady",get:function(){return this._isReady}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}},{key:"stage",get:function(){return this._stage},set:function(e){if(this._stage!==e){var t=this._stage;this._stage=e,e?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t.trashDisplayObject(this)}}},{key:"transforms",get:function(){return this._getTransforms()}},{key:"_getTransforms",value:function(){return(0,l.t)(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this.requestRender())}},{key:"fadeIn",value:function(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,u.ap)(),this.requestRender()),this._fadeInResolver.promise}},{key:"fadeOut",value:function(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,u.ap)(),this.requestRender()),this._fadeOutResolver.promise}},{key:"endTransitions",value:function(){var e,t;null!==(e=this._fadeInResolver)&&void 0!==e&&e.call(this),this._fadeInResolver=null,null!==(t=this._fadeOutResolver)&&void 0!==t&&t.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}},{key:"beforeRender",value:function(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}},{key:"afterRender",value:function(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}},{key:"remove",value:function(){var e;null===(e=this.parent)||void 0===e||e.removeChild(this)}},{key:"setTransform",value:function(e){}},{key:"processRender",value:function(e){this.stage&&this.computedVisible&&this.doRender(e)}},{key:"requestRender",value:function(){this.stage&&this.stage.requestRender()}},{key:"processDetach",value:function(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}},{key:"updateTransitionProperties",value:function(e,t){if(this.fadeTransitionEnabled){var r=this._fadeOutResolver||!this.visible?0:this.opacity,n=this.computedOpacity;if(n===r)this.computedVisible=this.visible;else{var i=e*c;this.computedOpacity=n>r?Math.max(r,n-i):Math.min(r,n+i),this.computedVisible=this.computedOpacity>0;var a=r===this.computedOpacity;this.inFadeTransition=!a,a||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}},{key:"onAttach",value:function(){}},{key:"onDetach",value:function(){}},{key:"doRender",value:function(e){}},{key:"ready",value:function(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}]),r}(s.n)},16263:function(e,t,r){r.d(t,{h:function(){return y},p:function(){return m},t:function(){return x}});var n=r(37762),i=r(60136),a=r(29388),o=r(15671),s=r(43144),l=(r(74384),r(93661)),u=r(48848),c=r(47855),h=r(25456),d=r(82474),f=u.a.getLogger("esri.layers.support.ElevationSampler"),p=function(){function e(){(0,o.Z)(this,e)}return(0,s.Z)(e,[{key:"queryElevation",value:function(e){return y(e.clone(),this)}},{key:"on",value:function(){return b}},{key:"projectIfRequired",value:function(e,t){return g(e,t)}}]),e}(),v=function(e){(0,i.Z)(r,e);var t=(0,a.Z)(r);function r(e,n,i){var a;(0,o.Z)(this,r),(a=t.call(this)).tile=e,a.noDataValue=i;var s=e.tile.extent;a.extent=(0,h.f)(s,n.spatialReference),a.extent.zmin=e.zmin,a.extent.zmax=e.zmax,a._aaExtent=s;var l=(0,c.$)(n.spatialReference),u=n.lodAt(e.tile.level).resolution*l;return a.demResolution={min:u,max:u},a}return(0,s.Z)(r,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"contains",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);return!(0,l.t)(t)&&this.containsAt(t.x,t.y)}},{key:"containsAt",value:function(e,t){return(0,h.w)(this._aaExtent,e,t)}},{key:"elevationAt",value:function(e,t){if(!this.containsAt(e,t)){var r=this.extent,n="".concat(r.xmin,", ").concat(r.ymin,", ").concat(r.xmax,", ").concat(r.ymax);return f.warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(n,")")),this.noDataValue}return(0,l.v)(this.tile.sample(e,t),this.noDataValue)}}]),r}(p),m=function(e){(0,i.Z)(r,e);var t=(0,a.Z)(r);function r(e,n,i){var a,s;(0,o.Z)(this,r),a=t.call(this),"number"==typeof n?(a.noDataValue=n,s=null):(s=n,a.noDataValue=i),a.samplers=s?e.map((function(e){return new v(e,s,a.noDataValue)})):e;var l=a.samplers[0];if(l){a.extent=l.extent.clone();var u=l.demResolution,c=u.min,d=u.max;a.demResolution={min:c,max:d};for(var f=1;f<a.samplers.length;f++){var p=a.samplers[f];a.extent.union(p.extent),a.demResolution.min=Math.min(a.demResolution.min,p.demResolution.min),a.demResolution.max=Math.max(a.demResolution.max,p.demResolution.max)}}else a.extent=(0,h.f)((0,h.u)(),s.spatialReference),a.demResolution={min:0,max:0};return a}return(0,s.Z)(r,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"elevationAt",value:function(e,t){var r,i=(0,n.Z)(this.samplers);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.containsAt(e,t))return a.elevationAt(e,t)}}catch(o){i.e(o)}finally{i.f()}return f.warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler")),this.noDataValue}}]),r}(p);function y(e,t){var r=g(e,t.spatialReference);if(!r)return null;switch(e.type){case"point":!function(e,t,r){e.z=r.elevationAt(t.x,t.y)}(e,r,t);break;case"polyline":!function(e,t,r){_.spatialReference=t.spatialReference;for(var n=e.hasM&&!e.hasZ,i=0;i<e.paths.length;i++)for(var a=e.paths[i],o=t.paths[i],s=0;s<a.length;s++){var l=a[s],u=o[s];_.x=u[0],_.y=u[1],n&&(l[3]=l[2]),l[2]=r.elevationAt(_.x,_.y)}e.hasZ=!0}(e,r,t);break;case"multipoint":!function(e,t,r){_.spatialReference=t.spatialReference;for(var n=e.hasM&&!e.hasZ,i=0;i<e.points.length;i++){var a=e.points[i],o=t.points[i];_.x=o[0],_.y=o[1],n&&(a[3]=a[2]),a[2]=r.elevationAt(_.x,_.y)}e.hasZ=!0}(e,r,t)}return e}function g(e,t){if((0,l.t)(e))return null;var r=e.spatialReference;if(r.equals(t))return e;var n=(0,d.M)(e,t);return n||f.error("Cannot project geometry spatial reference (wkid:".concat(r.wkid,") to elevation sampler spatial reference (wkid:").concat(t.wkid,")")),n}var _=new d.w,b={remove:function(){}},x=(0,s.Z)((function e(t,r){var n=t.values,i=t.width,a=t.height,s=t.noDataValue;(0,o.Z)(this,e),this.pixelData=n,this.width=i,this.height=a,this.safeWidth=.99999999*(i-1),this.noDataValue=s,this.dx=(i-1)/(r[2]-r[0]),this.dy=(i-1)/(r[3]-r[1]),this.x0=r[0],this.y1=r[3]}))},59929:function(e,t,r){r.d(t,{h:function(){return d},n:function(){return v}});var n=r(60136),i=r(29388),a=r(37762),o=r(1413),s=r(15671),l=r(43144),u=r(93661),c=r(48848),h=r(85113),d=function(){function e(t,r,n,i){var l=this,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};(0,s.Z)(this,e),this._mainMethod=r,this._transferLists=n,this._listeners=[],this._promise=(0,h.u)(t,(0,o.Z)((0,o.Z)({},u),{},{schedule:i})).then((function(e){if(void 0===l._thread){l._thread=e,l._promise=null,u.hasInitialize&&l.broadcast({},"initialize");var t,r=(0,a.Z)(l._listeners);try{for(r.s();!(t=r.n()).done;){var n=t.value;l._connectListener(n)}}catch(i){r.e(i)}finally{r.f()}}else e.close()})),this._promise.catch((function(e){return c.a.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(t," worker: ").concat(e))}))}return(0,l.Z)(e,[{key:"on",value:function(e,t){var r=this,n={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(n),this._connectListener(n),(0,c.D)((function(){n.removed=!0,(0,u.C)(r._listeners,n),r._thread&&(0,u.r)(n.threadHandle)&&n.threadHandle.remove()}))}},{key:"destroy",value:function(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}},{key:"invoke",value:function(e,t){return this.invokeMethod(this._mainMethod,e,t)}},{key:"invokeMethod",value:function(e,t,r){var n=this;if(this._thread){var i=this._transferLists[e],a=i?i(t):[];return this._thread.invoke(e,t,{transferList:a,signal:r})}return this._promise?this._promise.then((function(){return(0,c.f)(r),n.invokeMethod(e,t,r)})):Promise.reject(null)}},{key:"broadcast",value:function(e,t){var r=this;return this._thread?Promise.all(this._thread.broadcast(t,e)).then((function(){})):this._promise?this._promise.then((function(){return r.broadcast(e,t)})):Promise.reject()}},{key:"promise",get:function(){return this._promise}},{key:"_connectListener",value:function(e){this._thread&&this._thread.on(e.eventName,e.callback).then((function(t){e.removed||(e.threadHandle=t)}))}}]),e}(),f=function(e){(0,n.Z)(r,e);var t=(0,i.Z)(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return(0,s.Z)(this,r),(e=t.call(this,"LercWorker","_decode",{_decode:function(e){return[e.buffer]}},n,{strategy:"dedicated"})).schedule=n,e.ref=0,e}return(0,l.Z)(r,[{key:"decode",value:function(e,t,r){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},r):Promise.resolve(null)}},{key:"release",value:function(){var e=this;--this.ref<=0&&(p.forEach((function(t,r){t===e&&p.delete(r)})),this.destroy())}}]),r}(d),p=new Map;function v(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=p.get((0,u.e)(e));return t||((0,u.r)(e)?(t=new f((function(t){return e.schedule(t)})),p.set(e,t)):(t=new f,p.set(null,t))),++t.ref,t}},46018:function(e,t,r){r.d(t,{a:function(){return z},c:function(){return n},g:function(){return Y},l:function(){return S},m:function(){return D},o:function(){return C},p:function(){return B}});var n,i,a,o=r(1413),s=r(11752),l=r(61120),u=r(15671),c=r(43144),h=r(60136),d=r(29388),f=r(37762),p=r(87917),v=r(74384),m=r(21744),y=r(48848),g=r(40114),_=r(93661),b=r(89794),x=r(16599),w=r(82474),T=r(46337);function C(e){var t,r=S(e.rings,e.hasZ,n.CCW_IS_HOLE),i=new Array,a=0,o=0,s=(0,f.Z)(r.polygons);try{var l=function(){var e=t.value,n=e.count,s=e.index,l=new Float64Array(r.position.buffer,3*s*r.position.BYTES_PER_ELEMENT,3*n),u=e.holeIndices.map((function(e){return e-s})),c=new Uint32Array((0,p.x)(l,u,3));i.push({position:l,faces:c}),a+=l.length,o+=c.length};for(s.s();!(t=s.n()).done;)l()}catch(h){s.e(h)}finally{s.f()}var u=function(e,t,r){if(1===e.length)return e[0];var n,i=new Float64Array(t),a=new Uint32Array(r),o=0,s=0,l=0,u=(0,f.Z)(e);try{for(u.s();!(n=u.n()).done;){for(var c=n.value,d=0;d<c.position.length;d++)i[o++]=c.position[d];for(var p=0;p<c.faces.length;p++)a[s++]=c.faces[p]+l;l=o/3}}catch(h){u.e(h)}finally{u.f()}return{position:i,faces:a}}(i,a,o),c=(0,m.n)(u.position.buffer,6,{originalIndices:u.faces});return u.position=new Float64Array(c.buffer),u.faces=c.indices,u}function S(e,t,r){for(var i=e.length,a=new Array(i),o=new Array(i),s=new Array(i),l=0,u=0,c=0,h=0,d=0;d<i;++d)h+=e[d].length;for(var f=new Float64Array(3*h),p=0,v=i-1;v>=0;v--){var m=e[v],y=r===n.CCW_IS_HOLE&&P(m);if(y&&1!==i)a[l++]=m;else{for(var g=m.length,_=0;_<l;++_)g+=a[_].length;var b={index:p,pathLengths:new Array(l+1),count:g,holeIndices:new Array(l)};b.pathLengths[0]=m.length,m.length>0&&(s[c++]={index:p,count:m.length}),p=y?O(m,m.length-1,-1,f,p,m.length,t):O(m,0,1,f,p,m.length,t);for(var x=0;x<l;++x){var w=a[x];b.holeIndices[x]=p,b.pathLengths[x+1]=w.length,w.length>0&&(s[c++]={index:p,count:w.length}),p=O(w,0,1,f,p,w.length,t)}l=0,b.count>0&&(o[u++]=b)}}for(var T=0;T<l;++T){var C=a[T];C.length>0&&(s[c++]={index:p,count:C.length}),p=O(C,0,1,f,p,C.length,t)}return o.length=u,s.length=c,{position:f,polygons:o,outlines:s}}function O(e,t,r,n,i,a,o){i*=3;for(var s=0;s<a;++s){var l=e[t];n[i++]=l[0],n[i++]=l[1],n[i++]=o?l[2]:0,t+=r}return i/3}function P(e){return!(0,v.h)(e,!1,!1)}(i=n||(n={}))[i.NONE=0]="NONE",i[i.CCW_IS_HOLE=1]="CCW_IS_HOLE";var R=new WeakMap,A=0,k=a=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,u.Z)(this,r),(n=t.call(this,e)).wrap="repeat",n}return(0,c.Z)(r,[{key:"url",get:function(){return this._get("url")||null},set:function(e){this._set("url",e),e&&this._set("data",null)}},{key:"data",get:function(){return this._get("data")||null},set:function(e){this._set("data",e),e&&this._set("url",null)}},{key:"writeData",value:function(e,t,r,n){if(e instanceof HTMLImageElement){var i={type:"image-element",src:(0,T.m)(e.src,n),crossOrigin:e.crossOrigin};t[r]=i}else if(e instanceof HTMLCanvasElement){var a=e.getContext("2d").getImageData(0,0,e.width,e.height),o={type:"canvas-element",imageData:this._encodeImageData(a)};t[r]=o}else if(e instanceof HTMLVideoElement){var s={type:"video-element",src:(0,T.m)(e.src,n),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[r]=s}else{var l={type:"image-data",imageData:this._encodeImageData(e)};t[r]=l}}},{key:"readData",value:function(e){switch(e.type){case"image-element":var t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t;case"canvas-element":var r=this._decodeImageData(e.imageData),n=document.createElement("canvas");return n.width=r.width,n.height=r.height,n.getContext("2d").putImageData(r,0,0),n;case"image-data":return this._decodeImageData(e.imageData);case"video-element":var i=document.createElement("video");return i.src=e.src,i.crossOrigin=e.crossOrigin,i.autoplay=e.autoplay,i.loop=e.loop,i.muted=e.muted,i.preload=e.preload,i;default:return}}},{key:"transparent",get:function(){var e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this._imageDataContainsTransparent(e);if(t){var r=t.substr(t.length-4,4).toLowerCase(),n=t.substr(0,15).toLocaleLowerCase();if(".png"===r||"data:image/png;"===n)return!0}return!1},set:function(e){this._overrideIfSome("transparent",e)}},{key:"contentHash",get:function(){var e=this,t="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?"".concat(this.wrap.horizontal,"/").concat(this.wrap.vertical):"",r=function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return"d:".concat(r,",t:").concat(e.transparent,",w:").concat(t)};return null!=this.url?r(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?r(this.data.src):(R.has(this.data)||R.set(this.data,++A),r(R.get(this.data))):r()}},{key:"clone",value:function(){var e={url:this.url,data:this.data,wrap:this._cloneWrap()};return new a(e)}},{key:"cloneWithDeduplication",value:function(e){var t=e.get(this);if(t)return t;var r=this.clone();return e.set(this,r),r}},{key:"_cloneWrap",value:function(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}},{key:"_encodeImageData",value:function(e){for(var t="",r=0;r<e.data.length;r++)t+=String.fromCharCode(e.data[r]);return{data:btoa(t),width:e.width,height:e.height}}},{key:"_decodeImageData",value:function(e){for(var t=atob(e.data),r=new Uint8ClampedArray(t.length),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return(0,x.r)(r,e.width,e.height)}},{key:"_imageDataContainsTransparent",value:function(e){for(var t=3;t<e.data.length;t+=4)if(255!==e.data[t])return!0;return!1}}],[{key:"from",value:function(e){return"string"==typeof e?new a({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new a({data:e}):(0,y.Q)(a,e)}}]),r}(g.l);(0,y.e)([(0,y.y)({type:String,json:{write:T.f}})],k.prototype,"url",null),(0,y.e)([(0,y.y)({json:{write:{overridePolicy:function(){return{enabled:!this.url}}}}}),(0,y.y)()],k.prototype,"data",null),(0,y.e)([(0,w.r)("data")],k.prototype,"writeData",null),(0,y.e)([(0,w.o)("data")],k.prototype,"readData",null),(0,y.e)([(0,y.y)({type:Boolean,json:{write:{overridePolicy:function(){return{enabled:this._isOverridden("transparent")}}}}})],k.prototype,"transparent",null),(0,y.e)([(0,y.y)({json:{write:!0}})],k.prototype,"wrap",void 0),(0,y.e)([(0,y.y)({readOnly:!0})],k.prototype,"contentHash",null);var E,D=k=a=(0,y.e)([(0,y.n)("esri.geometry.support.MeshTexture")],k),M=E=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,u.Z)(this,r),(n=t.call(this,e)).color=null,n.colorTexture=null,n.normalTexture=null,n.alphaMode="auto",n.alphaCutoff=.5,n.doubleSided=!0,n}return(0,c.Z)(r,[{key:"clone",value:function(){return this.cloneWithDeduplication(null,new Map)}},{key:"cloneWithDeduplication",value:function(e,t){var r=(0,_.r)(e)?e.get(this):null;if(r)return r;var n=new E(this.clonePropertiesWithDeduplication(t));return(0,_.r)(e)&&e.set(this,n),n}},{key:"clonePropertiesWithDeduplication",value:function(e){return{color:(0,_.r)(this.color)?this.color.clone():null,colorTexture:(0,_.r)(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:(0,_.r)(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided,colorTextureTransform:(0,_.r)(this.colorTextureTransform)?this.colorTextureTransform:null,normalTextureTransform:(0,_.r)(this.normalTextureTransform)?this.normalTextureTransform:null}}}]),r}(g.l);(0,y.e)([(0,y.y)({type:b.l,json:{write:!0}})],M.prototype,"color",void 0),(0,y.e)([(0,y.y)({type:D,json:{write:!0}})],M.prototype,"colorTexture",void 0),(0,y.e)([(0,y.y)({type:D,json:{write:!0}})],M.prototype,"normalTexture",void 0),(0,y.e)([(0,y.y)({nonNullable:!0,json:{write:!0}})],M.prototype,"alphaMode",void 0),(0,y.e)([(0,y.y)({nonNullable:!0,json:{write:!0}})],M.prototype,"alphaCutoff",void 0),(0,y.e)([(0,y.y)({nonNullable:!0,json:{write:!0}})],M.prototype,"doubleSided",void 0),(0,y.e)([(0,y.y)()],M.prototype,"colorTextureTransform",void 0),(0,y.e)([(0,y.y)()],M.prototype,"normalTextureTransform",void 0);var I,L=M=E=(0,y.e)([(0,y.n)("esri.geometry.support.MeshMaterial")],M),Z=I=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,u.Z)(this,r),(n=t.call(this,e)).emissiveColor=null,n.emissiveTexture=null,n.occlusionTexture=null,n.metallic=1,n.roughness=1,n.metallicRoughnessTexture=null,n}return(0,c.Z)(r,[{key:"clone",value:function(){return this.cloneWithDeduplication(null,new Map)}},{key:"cloneWithDeduplication",value:function(e,t){var r=(0,_.r)(e)?e.get(this):null;if(r)return r;var n=new I(this.clonePropertiesWithDeduplication(t));return(0,_.r)(e)&&e.set(this,n),n}},{key:"clonePropertiesWithDeduplication",value:function(e){return(0,o.Z)((0,o.Z)({},(0,s.Z)((0,l.Z)(r.prototype),"clonePropertiesWithDeduplication",this).call(this,e)),{},{emissiveColor:(0,_.r)(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:(0,_.r)(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:(0,_.r)(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:(0,_.r)(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null,occlusionTextureTransform:(0,_.r)(this.occlusionTextureTransform)?this.occlusionTextureTransform:null,emissiveTextureTransform:(0,_.r)(this.emissiveTextureTransform)?this.emissiveTextureTransform:null,metallicRoughnessTextureTransform:(0,_.r)(this.metallicRoughnessTextureTransform)?this.metallicRoughnessTextureTransform:null})}}]),r}(L);(0,y.e)([(0,y.y)({type:b.l,json:{write:!0}})],Z.prototype,"emissiveColor",void 0),(0,y.e)([(0,y.y)({type:D,json:{write:!0}})],Z.prototype,"emissiveTexture",void 0),(0,y.e)([(0,y.y)({type:D,json:{write:!0}})],Z.prototype,"occlusionTexture",void 0),(0,y.e)([(0,y.y)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Z.prototype,"metallic",void 0),(0,y.e)([(0,y.y)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Z.prototype,"roughness",void 0),(0,y.e)([(0,y.y)({type:D,json:{write:!0}})],Z.prototype,"metallicRoughnessTexture",void 0),(0,y.e)([(0,y.y)()],Z.prototype,"occlusionTextureTransform",void 0),(0,y.e)([(0,y.y)()],Z.prototype,"emissiveTextureTransform",void 0),(0,y.e)([(0,y.y)()],Z.prototype,"metallicRoughnessTextureTransform",void 0);var N,F,z=Z=I=(0,y.e)([(0,y.n)("esri.geometry.support.MeshMaterialMetallicRoughness")],Z),U="esri.geometry.support.MeshVertexAttributes",V=y.a.getLogger(U),B=N=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,u.Z)(this,r),(n=t.call(this,e)).color=null,n.position=new Float64Array(0),n.uv=null,n.normal=null,n.tangent=null,n}return(0,c.Z)(r,[{key:"castColor",value:function(e){return H(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},V)}},{key:"castPosition",value:function(e){return e&&e instanceof Float32Array&&V.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),H(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},V)}},{key:"castUv",value:function(e){return H(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},V)}},{key:"castNormal",value:function(e){return H(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},V)}},{key:"castTangent",value:function(e){return H(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},V)}},{key:"clone",value:function(){var e={position:(0,_.y)(this.position),uv:(0,_.y)(this.uv),normal:(0,_.y)(this.normal),tangent:(0,_.y)(this.tangent),color:(0,_.y)(this.color)};return new N(e)}},{key:"clonePositional",value:function(){var e={position:(0,_.y)(this.position),normal:(0,_.y)(this.normal),tangent:(0,_.y)(this.tangent),uv:this.uv,color:this.color};return new N(e)}}]),r}(g.l);function G(e,t,r,n){var i=t.loggerTag,a=t.stride;return e.length%a!=0?(n.error(i,"Invalid array length, expected a multiple of ".concat(a)),new r([])):e}function H(e,t,r,n,i){if(!e)return e;if(e instanceof t)return G(e,n,t,i);var a,o=(0,f.Z)(r);try{for(o.s();!(a=o.n()).done;){if(e instanceof a.value)return G(new t(e),n,t,i)}}catch(l){o.e(l)}finally{o.f()}if(Array.isArray(e))return G(new t(e),n,t,i);var s=r.map((function(e){return"'".concat(e.name,"'")}));return i.error("Failed to set property, expected one of ".concat(s,", but got ").concat(e.constructor.name)),new t([])}function j(e,t,r){t[r]=function(e){for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=e[r];return t}(e)}(0,y.e)([(0,y.y)({json:{write:j}})],B.prototype,"color",void 0),(0,y.e)([(0,y.c)("color")],B.prototype,"castColor",null),(0,y.e)([(0,y.y)({nonNullable:!0,json:{write:j}})],B.prototype,"position",void 0),(0,y.e)([(0,y.c)("position")],B.prototype,"castPosition",null),(0,y.e)([(0,y.y)({json:{write:j}})],B.prototype,"uv",void 0),(0,y.e)([(0,y.c)("uv")],B.prototype,"castUv",null),(0,y.e)([(0,y.y)({json:{write:j}})],B.prototype,"normal",void 0),(0,y.e)([(0,y.c)("normal")],B.prototype,"castNormal",null),(0,y.e)([(0,y.y)({json:{write:j}})],B.prototype,"tangent",void 0),(0,y.e)([(0,y.c)("tangent")],B.prototype,"castTangent",null),B=N=(0,y.e)([(0,y.n)(U)],B);var q="esri.geometry.support.MeshComponent",W=y.a.getLogger(q),X=F=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,u.Z)(this,r),(n=t.call(this,e)).faces=null,n.material=null,n.shading="source",n.trustSourceNormals=!1,n}return(0,c.Z)(r,[{key:"castFaces",value:function(e){return H(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},W)}},{key:"castMaterial",value:function(e){return(0,y.Q)(e&&"object"==typeof e&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?z:L,e)}},{key:"clone",value:function(){return new F({faces:(0,_.y)(this.faces),shading:this.shading,material:(0,_.y)(this.material),trustSourceNormals:this.trustSourceNormals})}},{key:"cloneWithDeduplication",value:function(e,t){var r={faces:(0,_.y)(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new F(r)}}],[{key:"from",value:function(e){return(0,y.Q)(F,e)}}]),r}(g.l);(0,y.e)([(0,y.y)({json:{write:!0}})],X.prototype,"faces",void 0),(0,y.e)([(0,y.c)("faces")],X.prototype,"castFaces",null),(0,y.e)([(0,y.y)({type:L,json:{write:!0}})],X.prototype,"material",void 0),(0,y.e)([(0,y.c)("material")],X.prototype,"castMaterial",null),(0,y.e)([(0,y.y)({type:String,json:{write:!0}})],X.prototype,"shading",void 0),(0,y.e)([(0,y.y)({type:Boolean})],X.prototype,"trustSourceNormals",void 0);var Y=X=F=(0,y.e)([(0,y.n)(q)],X)},24648:function(e,t,r){r.d(t,{G:function(){return F}});var n=r(37762),i=r(15671),a=r(43144),o=r(93661),s=r(48848),l=r(71802),u=r(41723),c=r(64772),h=r(87750),d=function(){function e(t,r){(0,i.Z)(this,e),this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new f,this._objectCount=0,r&&(void 0!==r.maximumObjectsPerNode&&(this._maximumObjectsPerNode=r.maximumObjectsPerNode),void 0!==r.maximumDepth&&(this._maximumDepth=r.maximumDepth))}return(0,a.Z)(e,[{key:"bounds",get:function(){return this._root.bounds}},{key:"halfSize",get:function(){return this._root.halfSize}},{key:"root",get:function(){return this._root.node}},{key:"maximumObjectsPerNode",get:function(){return this._maximumObjectsPerNode}},{key:"maximumDepth",get:function(){return this._maximumDepth}},{key:"objectCount",get:function(){return this._objectCount}},{key:"destroy",value:function(){this._degenerateObjects.clear(),f.clearPool(),S[0]=null,k.prune(),Z.prune()}},{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length;this._objectCount+=t,this._grow(e,t);for(var r=f.acquire(),n=0;n<t;n++){var i=e[n];this._isDegenerate(i)?this._degenerateObjects.add(i):(r.init(this._root),this._add(i,r))}f.release(r)}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._objectCount-=e.length;var r,i=f.acquire(),a=(0,n.Z)(e);try{for(a.s();!(r=a.n()).done;){var s=r.value,l=(0,o.r)(t)?t:(0,c._)(this._objectToBoundingSphere(s),E);x(l[3])?(i.init(this._root),this._remove(s,l,i)):this._degenerateObjects.delete(s)}}catch(u){a.e(u)}finally{a.f()}f.release(i),this._shrink()}},{key:"update",value:function(e,t){if(x(t[3])||!this._isDegenerate(e)){var r=function(e){return S[0]=e,S}(e);this.remove(r,t),this.add(r)}}},{key:"forEachAlongRay",value:function(e,t,r){var n=this,i=(0,c.p)(e,t);this._forEachNode(this._root,(function(e){if(!n._intersectsNode(i,e))return!1;var t=e.node;return t.terminals.forAll((function(e){n._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((function(e){n._intersectsObject(i,e)&&r(e)})),!0}))}},{key:"forEachAlongRayWithVerticalOffset",value:function(e,t,r,n){var i=this,a=(0,c.p)(e,t);this._forEachNode(this._root,(function(e){if(!i._intersectsNodeWithOffset(a,e,n))return!1;var t=e.node;return t.terminals.forAll((function(e){i._intersectsObjectWithOffset(a,e,n)&&r(e)})),null!==t.residents&&t.residents.forAll((function(e){i._intersectsObjectWithOffset(a,e,n)&&r(e)})),!0}))}},{key:"forEach",value:function(e){this._forEachNode(this._root,(function(t){var r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}},{key:"forEachDegenerateObject",value:function(e){this._degenerateObjects.forEach(e)}},{key:"findClosest",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){return!0},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0,o=1/0,s=1/0,h=null,d=_(e,t),f=function(l){if(--a,i(l)){var d=n._objectToBoundingSphere(l);if((0,u.i)(r,d)){var f=b(e,t,(0,c.g)(d)),p=f-d[3],v=f+d[3];p<o&&(o=p,s=v,h=l)}}};return this._forEachNodeDepthOrdered(this._root,(function(n){if(a<=0||!(0,u.i)(r,n.bounds))return!1;if((0,l.g)(P,d,n.halfSize),(0,l.u)(P,P,n.bounds),b(e,t,P)>s)return!1;var i=n.node;return i.terminals.forAll((function(e){return f(e)})),null!==i.residents&&i.residents.forAll((function(e){return f(e)})),!0}),e,t),h}},{key:"forEachInDepthRange",value:function(t,r,n,i,a,o,s){var h=this,d=-1/0,f=1/0,p={setRange:function(t){n===e.DepthOrder.FRONT_TO_BACK?(d=Math.max(d,t.near),f=Math.min(f,t.far)):(d=Math.max(d,-t.far),f=Math.min(f,-t.near))}};p.setRange(i);var v=b(r,n,t),m=_(r,n),y=_(r,-n),g=function(e){if(s(e)){var t=h._objectToBoundingSphere(e),i=(0,c.g)(t),l=b(r,n,i)-v,m=l-t[3],y=l+t[3];m>f||y<d||!(0,u.i)(o,t)||a(e,p)}};this._forEachNodeDepthOrdered(this._root,(function(e){if(!(0,u.i)(o,e.bounds))return!1;if((0,l.g)(P,m,e.halfSize),(0,l.u)(P,P,e.bounds),b(r,n,P)-v>f)return!1;if((0,l.g)(P,y,e.halfSize),(0,l.u)(P,P,e.bounds),b(r,n,P)-v<d)return!1;var t=e.node;return t.terminals.forAll((function(e){return g(e)})),null!==t.residents&&t.residents.forAll((function(e){return g(e)})),!0}),r,n)}},{key:"forEachNode",value:function(e){this._forEachNode(this._root,(function(t){return e(t.node,t.bounds,t.halfSize)}))}},{key:"forEachNeighbor",value:function(e,t){var r=this,n=(0,c.T)(t),i=(0,c.g)(t),a=function(t){var a=r._objectToBoundingSphere(t),o=(0,c.T)(a),s=n+o;return!((0,l.p)((0,c.g)(a),i)-s*s<=0)||e(t)},o=!0,s=function(e){o&&(o=a(e))};this._forEachNode(this._root,(function(e){var t=(0,c.T)(e.bounds),r=n+t;if((0,l.p)((0,c.g)(e.bounds),i)-r*r>0)return!1;var a=e.node;return a.terminals.forAll(s),o&&null!==a.residents&&a.residents.forAll(s),o})),o&&this.forEachDegenerateObject(s)}},{key:"_intersectsNode",value:function(e,t){return m(t.bounds,2*-t.halfSize,R),m(t.bounds,2*t.halfSize,A),(0,h.d)(e.origin,e.direction,R,A)}},{key:"_intersectsNodeWithOffset",value:function(e,t,r){return m(t.bounds,2*-t.halfSize,R),m(t.bounds,2*t.halfSize,A),r.applyToMinMax(R,A),(0,h.d)(e.origin,e.direction,R,A)}},{key:"_intersectsObject",value:function(e,t){var r=this._objectToBoundingSphere(t);return!(r[3]>0)||(0,c.V)(r,e)}},{key:"_intersectsObjectWithOffset",value:function(e,t,r){var n=this._objectToBoundingSphere(t);return!(n[3]>0)||(0,c.V)(r.applyToBoundingSphere(n),e)}},{key:"_forEachNode",value:function(e,t){for(var r=f.acquire().init(e),n=[r];0!==n.length;){if(t(r=n.pop())&&!r.isLeaf())for(var i=0;i<r.node.children.length;i++)r.node.children[i]&&n.push(f.acquire().init(r).advance(i));f.release(r)}}},{key:"_forEachNodeDepthOrdered",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.DepthOrder.FRONT_TO_BACK,a=f.acquire().init(t),o=[a];for(g(n,i,N);0!==o.length;){if(r(a=o.pop())&&!a.isLeaf())for(var s=7;s>=0;--s){var l=N[s];a.node.children[l]&&o.push(f.acquire().init(a).advance(l))}f.release(a)}}},{key:"_remove",value:function(e,t,r){k.clear();var n=r.advanceTo(t,(function(e,t){k.push(e.node),k.push(t)}))?r.node.terminals:r.node.residents;if(n.removeUnordered(e),0===n.length)for(var i=k.length-2;i>=0;i-=2){var a=k.data[i],o=k.data[i+1];if(!this._purge(a,o))break}}},{key:"_nodeIsEmpty",value:function(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(var t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}},{key:"_purge",value:function(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new s.a6({shrink:!0})),!0)}},{key:"_add",value:function(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}},{key:"_split",value:function(e){var t=e.node.residents;e.node.residents=null;for(var r=0;r<t.length;r++){var n=f.acquire().init(e);this._add(t.getItemAt(r),n),f.release(n)}}},{key:"_grow",value:function(e,t){var r=this;if(0!==t&&(y(e,t,(function(e){return r._objectToBoundingSphere(e)}),D),x(D[3])&&!this._fitsInsideTree(D)))if(this._nodeIsEmpty(this._root.node))(0,c._)(D,this._root.bounds),this._root.halfSize=1.25*D[3];else{var n=this._rootBoundsForRootAsSubNode(D);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(D,n):this._growRootAsSubNode(n),f.release(n)}}},{key:"_rebuildTree",value:function(e,t){var r=this;(0,l.r)(M,t.bounds),M[3]=t.halfSize,y([e,M],2,(function(e){return e}),I);var n=f.acquire().init(this._root);this._root.initFrom(null,I,1.25*I[3]),this._forEachNode(n,(function(e){return r.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&r.add(e.node.residents.data,e.node.residents.length),!0})),f.release(n)}},{key:"_placingRootViolatesMaxDepth",value:function(e){var t=this,r=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E,n=0;return this._forEachNode(this._root,(function(e){return(n=Math.max(n,e.depth))+r<=t._maximumDepth})),n+r>this._maximumDepth}},{key:"_rootBoundsForRootAsSubNode",value:function(e){for(var t=e[3],r=e,n=-1/0,i=this._root.bounds,a=this._root.halfSize,o=0;o<3;o++){var s=i[o]-a-(r[o]-t),l=r[o]+t-(i[o]+a),u=Math.max(0,Math.ceil(s/(2*a))),c=Math.max(0,Math.ceil(l/(2*a)))+1,h=Math.pow(2,Math.ceil(Math.log(u+c)*Math.LOG2E));n=Math.max(n,h),L[o].min=u,L[o].max=c}for(var d=0;d<3;d++){var p=L[d].min,v=L[d].max,m=(n-(p+v))/2;p+=Math.ceil(m),v+=Math.floor(m);var y=i[d]-a-p*a*2;O[d]=y+(v+p)*a}return O[3]=n*a*C,f.acquire().initFrom(null,O,n*a,0)}},{key:"_growRootAsSubNode",value:function(e){var t=this._root.node;(0,l.r)(D,this._root.bounds),D[3]=this._root.halfSize,this._root.init(e),e.advanceTo(D,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}},{key:"_shrink",value:function(){for(;;){var e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}},{key:"_findShrinkIndex",value:function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;for(var e=null,t=this._root.node.children,r=0,n=0;n<t.length&&null==e;)e=t[r=n++];for(;n<t.length;)if(t[n++])return-1;return r}},{key:"_isDegenerate",value:function(e){return!x(this._objectToBoundingSphere(e)[3])}},{key:"_fitsInsideTree",value:function(e){var t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}}]),e}(),f=function(){function e(){(0,i.Z)(this,e),this.bounds=(0,c.R)(),this.halfSize=0,this.initFrom(null,null,0,0)}return(0,a.Z)(e,[{key:"init",value:function(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}},{key:"initFrom",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.depth;return this.node=(0,o.r)(t)?t:e.createEmptyNode(),(0,o.r)(r)&&(0,c._)(r,this.bounds),this.halfSize=n,this.depth=i,this}},{key:"advance",value:function(t){var r=this.node.children[t];r||(r=e.createEmptyNode(),this.node.children[t]=r),this.node=r,this.halfSize/=2,this.depth++;var n=w[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.bounds[3]=this.halfSize*C,this}},{key:"advanceTo",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}var n=this._childIndex(e);t&&t(this,n),this.advance(n)}}},{key:"isLeaf",value:function(){return null!=this.node.residents}},{key:"isTerminalFor",value:function(e){return e[3]>this.halfSize/2}},{key:"_childIndex",value:function(e){var t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}}],[{key:"createEmptyNode",value:function(){return{children:[null,null,null,null,null,null,null,null],terminals:new s.a6({shrink:!0}),residents:new s.a6({shrink:!0})}}},{key:"acquire",value:function(){return e._pool.acquire()}},{key:"release",value:function(t){e._pool.release(t)}},{key:"clearPool",value:function(){e._pool.prune()}}]),e}();function p(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function v(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function m(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function y(e,t,r,n){if(1===t){var i=r(e[0]);(0,c._)(i,n)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(var a=0;a<t;a++){var o=r(e[a]);x(o[3])&&(p(R,o),v(A,o))}(0,l.A)(n,R,A,.5),n[3]=Math.max(A[0]-R[0],A[1]-R[1],A[2]-R[2])/2}}function g(e,t,r){if(!Z.length)for(var n=0;n<8;++n)Z.push({index:0,distance:0});for(var i=0;i<8;++i){var a=w[i];Z.data[i].index=i,Z.data[i].distance=b(e,t,a)}Z.sort((function(e,t){return e.distance-t.distance}));for(var o=0;o<8;++o)r[o]=Z.data[o].index}function _(e,t){for(var r,n=1/0,i=0;i<8;++i){var a=b(e,t,T[i]);a<n&&(n=a,r=T[i])}return r}function b(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function x(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}f._pool=new s.h(f),function(e){var t;(t=e.DepthOrder||(e.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(d||(d={}));var w=[(0,l.c)(-1,-1,-1),(0,l.c)(1,-1,-1),(0,l.c)(-1,1,-1),(0,l.c)(1,1,-1),(0,l.c)(-1,-1,1),(0,l.c)(1,-1,1),(0,l.c)(-1,1,1),(0,l.c)(1,1,1)],T=[(0,l.c)(-1,-1,-1),(0,l.c)(-1,-1,1),(0,l.c)(-1,1,-1),(0,l.c)(-1,1,1),(0,l.c)(1,-1,-1),(0,l.c)(1,-1,1),(0,l.c)(1,1,-1),(0,l.c)(1,1,1)],C=Math.sqrt(3),S=[null];var O=(0,c.R)(),P=(0,l.n)(),R=(0,l.n)(),A=(0,l.n)(),k=new s.a6,E=(0,c.R)(),D=(0,c.R)(),M=(0,c.R)(),I=(0,c.R)(),L=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],Z=new s.a6,N=[0,0,0,0,0,0,0,0],F=d},21015:function(e,t,r){r.r(t);var n=r(74165),i=r(15861),a=r(1413),o=r(15671),s=r(43144),l=r(60136),u=r(29388),c=r(48848),h=r(75255),d=r(40114),f=r(93661),p=r(93116),v=r(40558),m=r(82474),y=r(46817),g=(r(65094),function(e){(0,l.Z)(h,e);var t=(0,u.Z)(h);function h(e){var r;return(0,o.Z)(this,h),(r=t.call(this,e)).portalItem=null,r}return(0,s.Z)(h,[{key:"normalizeCtorArgs",value:function(e){return e&&e.portalItem&&e.path?(0,a.Z)((0,a.Z)({},e),{},{path:this._normalizePath(e.path,e.portalItem)}):e}},{key:"path",set:function(e){(0,f.r)(e)&&(0,v.K)(e)?c.a.getLogger(this.declaredClass).error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}},{key:"_castPath",value:function(e){return this._normalizePath(e,this.portalItem)}},{key:"url",get:function(){return this.portalItem&&this.path?"".concat(this.portalItem.itemUrl,"/resources/").concat(this.path):null}},{key:"itemRelativeUrl",get:function(){return this.portalItem&&this.path?"./resources/".concat(this.path):null}},{key:"fetch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"json",t=arguments.length>1?arguments[1]:void 0,r=this.url;if((0,f.t)(r))throw new c.s("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal._request(r,{responseType:e,query:{token:this.portalItem.apiKey},signal:(0,f.q)(t,"signal")})}},{key:"update",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(682).then(r.bind(r,90682));case 2:return e.abrupt("return",e.sent.addOrUpdateResource(this,"update",t,i));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"hasPath",value:function(){return(0,f.r)(this.path)}},{key:"_normalizePath",value:function(e,t){return(0,f.t)(e)?e:(e=e.replace(/^\/+/,""),(0,f.r)(t)&&(0,v.K)(e)&&(e=(0,v._)(e,t.itemUrl)),e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}}]),h}(c.m));(0,c.e)([(0,c.y)()],g.prototype,"portalItem",void 0),(0,c.e)([(0,c.y)({type:String,value:null})],g.prototype,"path",null),(0,c.e)([(0,c.c)("path")],g.prototype,"_castPath",null),(0,c.e)([(0,c.y)({type:String,readOnly:!0})],g.prototype,"url",null),(0,c.e)([(0,c.y)({type:String,readOnly:!0})],g.prototype,"itemRelativeUrl",null);var _=g=(0,c.e)([(0,c.n)("esri.portal.PortalItemResource")],g),b=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e)).created=null,n.rating=null,n}return(0,s.Z)(r)}(c.m);(0,c.e)([(0,c.y)()],b.prototype,"created",void 0),(0,c.e)([(0,c.y)()],b.prototype,"rating",void 0);var x,w=b=(0,c.e)([(0,c.n)("esri.portal.PortalRating")],b),T=new Set(["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","GeoJson","CSV","KML","WFS","WMTS","WMS","Feed"]),C=new Set(["KML","GeoJson","CSV"]),S=x=function(e){(0,l.Z)(d,e);var t=(0,u.Z)(d);function d(e){var r;return(0,o.Z)(this,d),(r=t.call(this,e)).access=null,r.accessInformation=null,r.apiKey=null,r.applicationProxies=null,r.avgRating=null,r.categories=null,r.created=null,r.culture=null,r.description=null,r.extent=null,r.groupCategories=null,r.id=null,r.itemControl=null,r.licenseInfo=null,r.modified=null,r.name=null,r.numComments=null,r.numRatings=null,r.numViews=null,r.owner=null,r.ownerFolder=null,r.portal=null,r.screenshots=null,r.size=null,r.snippet=null,r.sourceJSON=null,r.spatialReference=null,r.tags=null,r.title=null,r.type=null,r.typeKeywords=null,r.url=null,r}return(0,s.Z)(d,[{key:"destroy",value:function(){this.portal=null}},{key:"displayName",get:function(){var e=this.type,t=this.typeKeywords||[],r=e;return"Feature Service"===e||"Feature Collection"===e?r=t.includes("Table")?"Table":t.includes("Route Layer")?"Route Layer":t.includes("Markup")?"Markup":"Feature Layer":"Image Service"===e?r=t.includes("Elevation 3D Layer")?"Elevation Layer":t.includes("Tiled Imagery")?"Tiled Imagery Layer":"Imagery Layer":"Scene Service"===e?r="Scene Layer":"Video Service"===e?r="Video Layer":"Scene Package"===e?r="Scene Layer Package":"Stream Service"===e?r="Feature Layer":"Geoprocessing Service"===e&&this.portal&&this.portal.isPortal?r=t.includes("Web Tool")?"Tool":"Geoprocessing Service":"Geocoding Service"===e?r="Locator":"Geoenrichment Service"===e?r="GeoEnrichment Service":"Microsoft Powerpoint"===e?r="Microsoft PowerPoint":"GeoJson"===e?r="GeoJSON":"Globe Service"===e?r="Globe Layer":"Vector Tile Service"===e?r="Tile Layer":"netCDF"===e?r="NetCDF":"Map Service"===e?r=t.includes("Spatiotemporal")||!t.includes("Hosted Service")&&!t.includes("Tiled")||t.includes("Relational")?"Map Image Layer":"Tile Layer":e&&e.toLowerCase().includes("add in")?r=e.replace(/(add in)/gi,"Add-In"):"datastore catalog service"===e?r="Big Data File Share":"Compact Tile Package"===e?r="Tile Package (tpkx)":"OGCFeatureServer"===e?r="OGC Feature Layer":"web mapping application"===e&&t.includes("configurableApp")&&(r="Instant App"),r}},{key:"readExtent",value:function(e){return e&&e.length?new y.w(e[0][0],e[0][1],e[1][0],e[1][1]):null}},{key:"iconUrl",get:function(){var e,t=this.type&&this.type.toLowerCase()||"",r=this.typeKeywords||[],n=!1,i=!1,a=!1,o=!1,s=!1,l=!1;return t.indexOf("service")>0||"feature collection"===t||"kml"===t||"wms"===t||"wmts"===t||"wfs"===t?(n=r.includes("Hosted Service"),"feature service"===t||"feature collection"===t||"kml"===t||"wfs"===t?(i=r.includes("Table"),a=r.includes("Route Layer"),o=r.includes("Markup"),s=r.includes("Spatiotemporal"),l=r.includes("UtilityNetwork"),e=s&&i?"spatiotemporaltable":i?"table":a?"routelayer":o?"markup":s?"spatiotemporal":n?"featureshosted":l?"utilitynetwork":"features"):e="map service"===t||"wms"===t||"wmts"===t?n||r.includes("Tiled")||"wmts"===t?"maptiles":"mapimages":"scene service"===t?r.includes("Line")?"sceneweblayerline":r.includes("3DObject")?"sceneweblayermultipatch":r.includes("Point")?"sceneweblayerpoint":r.includes("IntegratedMesh")?"sceneweblayermesh":r.includes("PointCloud")?"sceneweblayerpointcloud":r.includes("Polygon")?"sceneweblayerpolygon":r.includes("Building")?"sceneweblayerbuilding":r.includes("Voxel")?"sceneweblayervoxel":"sceneweblayer":"image service"===t?r.includes("Elevation 3D Layer")?"elevationlayer":r.includes("Tiled Imagery")?"tiledimagerylayer":"imagery":"stream service"===t?"streamlayer":"video service"===t?"mediaservice":"vector tile service"===t?"vectortile":"datastore catalog service"===t?"datastorecollection":"geocoding service"===t?"geocodeservice":"geoprocessing service"===t?r.includes("Web Tool")&&this.portal&&this.portal.isPortal?"tool":"layers":"geodata service"===t?"geodataservice":"layers"):e="web map"===t||"cityengine web scene"===t?"maps":"web scene"===t?r.includes("ViewingMode-Local")?"webscenelocal":"websceneglobal":"web mapping application"===t&&r.includes("configurableApp")?"instantapps":"web mapping application"===t||"mobile application"===t||"application"===t||"operation view"===t||"desktop application"===t?"apps":"map document"===t||"map package"===t||"published map"===t||"scene document"===t||"globe document"===t||"basemap package"===t||"mobile basemap package"===t||"mobile map package"===t||"project package"===t||"project template"===t||"pro map"===t||"layout"===t||"layer"===t&&r.includes("ArcGIS Pro")||"explorer map"===t&&r.indexOf("Explorer Document")?"mapsgray":"service definition"===t||"csv"===t||"shapefile"===t||"cad drawing"===t||"geojson"===t||"360 vr experience"===t||"netcdf"===t||"administrative report"===t?"datafiles":"explorer add in"===t||"desktop add in"===t||"windows viewer add in"===t||"windows viewer configuration"===t?"appsgray":"arcgis pro add in"===t||"arcgis pro configuration"===t?"addindesktop":"rule package"===t||"file geodatabase"===t||"sqlite geodatabase"===t||"csv collection"===t||"kml collection"===t||"windows mobile package"===t||"map template"===t||"desktop application template"===t||"gml"===t||"arcpad package"===t||"code sample"===t||"form"===t||"document link"===t||"earth configuration"===t||"operations dashboard add in"===t||"rules package"===t||"image"===t||"workflow manager package"===t||"explorer map"===t&&r.includes("Explorer Mapping Application")||r.includes("Document")?"datafilesgray":"network analysis service"===t||"geoprocessing service"===t||"geodata service"===t||"geometry service"===t||"geoprocessing package"===t||"locator package"===t||"geoprocessing sample"===t||"workflow manager service"===t?"toolsgray":"layer"===t||"layer package"===t||"explorer layer"===t?"layersgray":"scene package"===t?"scenepackage":"mobile scene package"===t?"mobilescenepackage":"tile package"===t||"compact tile package"===t?"tilepackage":"task file"===t?"taskfile":"report template"===t?"report-template":"statistical data collection"===t?"statisticaldatacollection":"insights workbook"===t?"workbook":"insights model"===t?"insightsmodel":"insights page"===t?"insightspage":"insights theme"===t?"insightstheme":"hub initiative"===t?"hubinitiative":"hubpage"===t?"hubpage":"hub event"===t?"hubevent":"hub site application"===t?"hubsite":"hub project"===t?"hubproject":"relational database connection"===t?"relationaldatabaseconnection":"big data file share"===t?"datastorecollection":"image collection"===t?"imagecollection":"style"===t?"style":"desktop style"===t?"desktopstyle":"dashboard"===t?"dashboard":"raster function template"===t?"rasterprocessingtemplate":"vector tile package"===t?"vectortilepackage":"ortho mapping project"===t?"orthomappingproject":"ortho mapping template"===t?"orthomappingtemplate":"solution"===t?"solutions":"geopackage"===t?"geopackage":"deep learning package"===t?"deeplearningpackage":"real time analytic"===t?"realtimeanalytics":"big data analytic"===t?"bigdataanalytics":"feed"===t?"feed":"excalibur imagery project"===t?"excaliburimageryproject":"notebook"===t?"notebook":"storymap"===t?"storymap":"survey123 add in"===t?"survey123addin":"mission"===t?"mission":"mission report"===t?"missionreport":"quickcapture project"===t?"quickcaptureproject":"pro report"===t?"proreport":"pro report template"===t?"proreporttemplate":"urban model"===t?"urbanmodel":"web experience"===t?"experiencebuilder":"web experience template"===t?"webexperiencetemplate":"experience builder widget"===t?"experiencebuilderwidget":"experience builder widget package"===t?"experiencebuilderwidgetpackage":"workflow"===t?"workflow":"insights script"===t?"insightsscript":"kernel gateway connection"===t?"kernelgatewayconnection":"hub initiative template"===t?"hubinitiativetemplate":"storymap theme"===t?"storymaptheme":"knowledge graph"===t?"knowledgegraph":"native application"===t?"nativeapp":"native application installer"===t?"nativeappinstaller":"link chart"===t?"linkchart":"investigation"===t?"investigation":"ogcfeatureserver"===t?"features":"pro project"===t?"proproject":"insights workbook package"===t?"insightsworkbookpackage":"apache parquet"===t?"apacheparquet":"notebook code snippets"===t||"notebook code snippet library"===t?"notebookcodesnippets":"suitability model"===t?"suitabilitymodel":"esri classifier definition"===t?"classifierdefinition":"esri classification schema"===t?"classificationschema":"insights data engineering workbook"===t?"dataengineeringworkbook":"insights data engineering model"===t?"dataengineeringmodel":"deep learning studio project"===t?"deeplearningproject":"discussion"===t?"discussion":"maps",e?(0,h.a)("esri/images/portal/"+e+"16.png"):null}},{key:"isLayer",get:function(){return null!=this.type&&T.has(this.type)}},{key:"itemPageUrl",get:function(){var e,t=null===(e=this.portal)||void 0===e?void 0:e.itemPageUrl;return t&&this.id?"".concat(t,"?id=").concat(this.id):null}},{key:"itemUrl",get:function(){var e,t=null===(e=this.portal)||void 0===e?void 0:e.restUrl;return t&&this.id?"".concat(t,"/content/items/").concat(this.id):null}},{key:"thumbnailUrl",get:function(){var e,t,r=this.itemUrl,n=this.thumbnail;return r&&n&&null!==(e=null===(t=this.portal)||void 0===t?void 0:t._normalizeUrl("".concat(r,"/info/").concat(n,"?f=json")))&&void 0!==e?e:null}},{key:"userItemUrl",get:function(){var e=this.get("portal.restUrl");if(!e)return null;var t=this.owner||this.get("portal.user.username");return t?"".concat(e,"/content/users/").concat(this.ownerFolder?"".concat(t,"/").concat(this.ownerFolder):t,"/items/").concat(this.id):null}},{key:"load",value:function(e){var t,r=this,n=null!==(t=this.portal)&&void 0!==t?t:this.portal=p.j.getDefault(),i=n.load(e).then((function(){return r.sourceJSON?r.sourceJSON:r.id&&r.itemUrl?n._request(r.itemUrl,{signal:(0,f.r)(e)?e.signal:null,query:{token:r.apiKey}}):{}})).then((function(e){r.sourceJSON=e,r.read(e)}));return this.addResolvingPromise(i),Promise.resolve(this)}},{key:"addRating",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={method:"post",query:{}},t instanceof w&&(t=t.rating),null==t||isNaN(t)||"number"!=typeof t||(r.query.rating=t),!this.portal){e.next=9;break}return e.next=6,this.portal._request(this.itemUrl+"/addRating",r);case 6:e.t0=new w({rating:t,created:new Date}),e.next=10;break;case 9:e.t0=null;case 10:return e.abrupt("return",e.t0);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"clone",value:function(){var e={access:this.access,accessInformation:this.accessInformation,applicationProxies:(0,f.y)(this.applicationProxies),avgRating:this.avgRating,categories:(0,f.y)(this.categories),created:(0,f.y)(this.created),culture:this.culture,description:this.description,extent:(0,f.y)(this.extent),groupCategories:(0,f.y)(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:(0,f.y)(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:(0,f.y)(this.screenshots),size:this.size,snippet:this.snippet,spatialReference:this.spatialReference,tags:(0,f.y)(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:(0,f.y)(this.typeKeywords),url:this.url};return this.loaded&&(e.loadStatus="loaded"),new x({sourceJSON:this.sourceJSON}).set(e)}},{key:"createPostQuery",value:function(){for(var e=this.toJSON(),t=0,r=["tags","typeKeywords","categories"];t<r.length;t++){var n=r[t];e[n]&&(e[n]=e[n].join(", "))}var i=e.extent;return i&&(e.extent=JSON.stringify(i)),e}},{key:"deleteRating",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.i)(this.portal)._request(this.itemUrl+"/deleteRating",{method:"post"});case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"json",t=arguments.length>1?arguments[1]:void 0;return(0,f.i)(this.portal)._request(this.itemUrl+"/data",(0,a.Z)((0,a.Z)({responseType:e},t),{},{query:{token:this.apiKey}}))}},{key:"fetchRating",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.i)(this.portal)._request(this.itemUrl+"/rating",(0,a.Z)({query:{token:this.apiKey}},t));case 2:return r=e.sent,e.abrupt("return",null!=r.rating?(r.created=new Date(r.created),new w(r)):null);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRelatedItems",value:function(e,t){return(0,f.i)(this.portal)._requestToTypedArray(this.itemUrl+"/relatedItems",(0,a.Z)({query:(0,a.Z)((0,a.Z)({},e),{},{token:this.apiKey})},t),x)}},{key:"getThumbnailUrl",value:function(e){var t=this.thumbnailUrl;return t&&e&&(t+="&w=".concat(e)),t}},{key:"reload",value:function(){var e,t=this;return(0,f.i)(this.portal)._request(null!==(e=this.itemUrl)&&void 0!==e?e:"",{cacheBust:!0,query:{token:this.apiKey}}).then((function(e){return t.sourceJSON=e,t.read(e),t}))}},{key:"update",value:function(e){var t=this;return this.id?this.load().then((function(){return(0,f.i)(t.portal)._signIn()})).then((function(){var r=e&&e.data,n={method:"post"};for(var i in n.query=t.createPostQuery(),n.query)null===n.query[i]&&(n.query[i]="");return n.query.clearEmptyFields=!0,null!=r&&("string"==typeof r?n.query.text=r:"object"==typeof r&&(n.query.text=JSON.stringify(r))),t.portal._request("".concat(t.userItemUrl,"/update"),n).then((function(){return t.reload()}))})):Promise.reject(new c.s("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}},{key:"updateThumbnail",value:function(e){var t=this;return this.id?this.load().then((function(){return t.portal._signIn()})).then((function(){var r=e.thumbnail,n=e.filename,i={method:"post"};if("string"==typeof r)(0,v.X)(r)?i.query={data:r}:i.query={url:(0,v.Q)(r)},(0,f.r)(n)&&(i.query.filename=n);else{var a=new FormData;(0,f.r)(n)?a.append("file",r,n):a.append("file",r),i.body=a}return t.portal._request("".concat(t.userItemUrl,"/updateThumbnail"),i).then((function(){return t.reload()}))})):Promise.reject(new c.s("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}},{key:"fetchResources",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){var t,i,a=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},i=a.length>1?a[1]:void 0,e.next=4,r.e(682).then(r.bind(r,90682));case 4:return e.abrupt("return",e.sent.fetchResources(this,t,i));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"addResource",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,i,a){var o;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(682).then(r.bind(r,90682));case 2:return o=e.sent,e.abrupt("return",(t.portalItem=this,o.addOrUpdateResource(t,"add",i,a)));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"removeResource",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,i){var a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(682).then(r.bind(r,90682));case 2:if(a=e.sent,!t.portalItem||t.portalItem.itemUrl===this.itemUrl){e.next=5;break}throw new c.s("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");case 5:return e.abrupt("return",a.removeResource(this,t,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeAllResources",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(682).then(r.bind(r,90682));case 2:return e.abrupt("return",e.sent.removeAllResources(this,t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resourceFromPath",value:function(e){return new _({portalItem:this,path:e})}},{key:"toJSON",value:function(){var e=this.extent,t={accessInformation:this.accessInformation,categories:(0,f.y)(this.categories),created:this.created&&this.created.getTime(),description:this.description,extent:e&&[[e.xmin,e.ymin],[e.xmax,e.ymax]],id:this.id,licenseInfo:this.licenseInfo,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,spatialReference:this.spatialReference,tags:(0,f.y)(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:(0,f.y)(this.typeKeywords),url:this.url};return(0,f.p)(t)}},{key:"_getPostQuery",value:function(){var e=this.toJSON();for(var t in e)"tags"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"typeKeywords"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"extent"===t&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}}],[{key:"from",value:function(e){return(0,c.Q)(x,e)}},{key:"fromJSON",value:function(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new x({sourceJSON:e})}}]),d}((0,d.u)(p.m));(0,c.e)([(0,c.y)({type:["private","shared","org","public"]})],S.prototype,"access",void 0),(0,c.e)([(0,c.y)()],S.prototype,"accessInformation",void 0),(0,c.e)([(0,c.y)({type:String})],S.prototype,"apiKey",void 0),(0,c.e)([(0,c.y)({json:{read:{source:"appProxies"}}})],S.prototype,"applicationProxies",void 0),(0,c.e)([(0,c.y)()],S.prototype,"avgRating",void 0),(0,c.e)([(0,c.y)()],S.prototype,"categories",void 0),(0,c.e)([(0,c.y)({type:Date})],S.prototype,"created",void 0),(0,c.e)([(0,c.y)()],S.prototype,"culture",void 0),(0,c.e)([(0,c.y)()],S.prototype,"description",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"displayName",null),(0,c.e)([(0,c.y)({type:y.w})],S.prototype,"extent",void 0),(0,c.e)([(0,m.o)("extent")],S.prototype,"readExtent",null),(0,c.e)([(0,c.y)()],S.prototype,"groupCategories",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"iconUrl",null),(0,c.e)([(0,c.y)()],S.prototype,"id",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"isLayer",null),(0,c.e)([(0,c.y)()],S.prototype,"itemControl",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"itemPageUrl",null),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"itemUrl",null),(0,c.e)([(0,c.y)()],S.prototype,"licenseInfo",void 0),(0,c.e)([(0,c.y)({type:Date})],S.prototype,"modified",void 0),(0,c.e)([(0,c.y)()],S.prototype,"name",void 0),(0,c.e)([(0,c.y)()],S.prototype,"numComments",void 0),(0,c.e)([(0,c.y)()],S.prototype,"numRatings",void 0),(0,c.e)([(0,c.y)()],S.prototype,"numViews",void 0),(0,c.e)([(0,c.y)()],S.prototype,"owner",void 0),(0,c.e)([(0,c.y)()],S.prototype,"ownerFolder",void 0),(0,c.e)([(0,c.y)({type:p.j})],S.prototype,"portal",void 0),(0,c.e)([(0,c.y)()],S.prototype,"screenshots",void 0),(0,c.e)([(0,c.y)()],S.prototype,"size",void 0),(0,c.e)([(0,c.y)()],S.prototype,"snippet",void 0),(0,c.e)([(0,c.y)()],S.prototype,"sourceJSON",void 0),(0,c.e)([(0,c.y)({type:String})],S.prototype,"spatialReference",void 0),(0,c.e)([(0,c.y)()],S.prototype,"tags",void 0),(0,c.e)([(0,c.y)()],S.prototype,"thumbnail",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"thumbnailUrl",null),(0,c.e)([(0,c.y)()],S.prototype,"title",void 0),(0,c.e)([(0,c.y)()],S.prototype,"type",void 0),(0,c.e)([(0,c.y)()],S.prototype,"typeKeywords",void 0),(0,c.e)([(0,c.y)({type:String,json:{read:function(e,t){if(C.has(t.type)){var r,n=null===(r=this.portal)||void 0===r?void 0:r.restUrl;e||(e=n&&this.id?"".concat(n,"/content/items/").concat(this.id,"/data"):null)}return e}}})],S.prototype,"url",void 0),(0,c.e)([(0,c.y)({readOnly:!0})],S.prototype,"userItemUrl",null);var O=S=x=(0,c.e)([(0,c.n)("esri.portal.PortalItem")],S);t.default=O},28390:function(e,t,r){r.r(t),r.d(t,{$:function(){return BS},A:function(){return PT},B:function(){return Zk},C:function(){return Ix},D:function(){return kR},E:function(){return Mx},F:function(){return PR},G:function(){return fp},H:function(){return Dh},I:function(){return uH},J:function(){return RG},K:function(){return MT},L:function(){return _H},M:function(){return bC},N:function(){return aZ},O:function(){return hC},P:function(){return UT},Q:function(){return bN},R:function(){return CN},S:function(){return iU},T:function(){return GS},U:function(){return Ih},V:function(){return aA},W:function(){return mA},X:function(){return oR},Y:function(){return xT},Z:function(){return zT},_:function(){return qT},a:function(){return MS},a$:function(){return fj},a0:function(){return eS},a1:function(){return MZ},a2:function(){return IU},a3:function(){return dF},a4:function(){return fF},a5:function(){return xE},a6:function(){return tS},a7:function(){return jO},a8:function(){return sE},a9:function(){return Yk},aA:function(){return CV},aB:function(){return SV},aC:function(){return Dd},aD:function(){return Ld},aE:function(){return Jd},aF:function(){return mf},aG:function(){return vf},aH:function(){return yf},aI:function(){return Nf},aJ:function(){return Ff},aK:function(){return Qf},aL:function(){return Yf},aM:function(){return Kf},aN:function(){return Pp},aO:function(){return iv},aP:function(){return dw},aQ:function(){return pw},aR:function(){return _B},aS:function(){return xB},aT:function(){return CH},aU:function(){return SH},aV:function(){return $H},aW:function(){return ej},aX:function(){return aj},aY:function(){return oj},aZ:function(){return uj},a_:function(){return cj},aa:function(){return ST},ab:function(){return mp},ac:function(){return IO},ad:function(){return FT},ae:function(){return up},af:function(){return fE},ag:function(){return LO},ah:function(){return fO},ai:function(){return Jy},aj:function(){return OT},ak:function(){return Fg},al:function(){return NI},am:function(){return DE},an:function(){return Kx},ao:function(){return ww},ap:function(){return hp},aq:function(){return Qx},ar:function(){return DX},as:function(){return MX},at:function(){return NX},au:function(){return BX},av:function(){return VX},aw:function(){return zg},ax:function(){return vp},ay:function(){return yp},az:function(){return pp},b:function(){return WA},b0:function(){return pj},b1:function(){return Tf},b2:function(){return Cf},b3:function(){return lS},b4:function(){return kU},b5:function(){return AU},b6:function(){return RU},b7:function(){return EU},b8:function(){return FO},b9:function(){return zO},ba:function(){return Qj},bb:function(){return eq},bc:function(){return tq},bd:function(){return iq},be:function(){return aq},bf:function(){return gq},bg:function(){return xq},bh:function(){return _q},bi:function(){return zq},bj:function(){return tW},bk:function(){return iW},bl:function(){return uW},bm:function(){return xR},bn:function(){return Oq},bo:function(){return RW},bp:function(){return uE},bq:function(){return OE},br:function(){return zM},bs:function(){return BI},bt:function(){return EI},bu:function(){return eZ},bv:function(){return zW},bw:function(){return iY},c:function(){return OS},d:function(){return VC},e:function(){return VS},f:function(){return bT},g:function(){return RC},h:function(){return RL},i:function(){return TC},j:function(){return _P},k:function(){return IZ},l:function(){return _O},m:function(){return mC},n:function(){return tN},o:function(){return vb},p:function(){return OL},q:function(){return cz},r:function(){return RS},s:function(){return ZS},t:function(){return hz},u:function(){return dC},v:function(){return cF},w:function(){return aR},x:function(){return xN},y:function(){return zC},z:function(){return kT}});var n,i,a,o,s,l,u,c,h,d,f,p,v,m,y,g,_,b,x,w,T,C,S,O,P,R,A,k,E,D,M,I,L,Z,N,F,z,U,V,B,G,H,j,q,W,X,Y,Q,K,J,$,ee,te,re,ne,ie,ae,oe,se,le,ue,ce,he,de,fe,pe,ve,me,ye,ge,_e,be,xe,we,Te,Ce,Se,Oe,Pe,Re,Ae,ke,Ee,De,Me,Ie,Le,Ze,Ne,Fe,ze,Ue,Ve,Be,Ge,He,je,qe,We,Xe,Ye,Qe,Ke,Je,$e,et,tt,rt,nt,it,at,ot,st,lt,ut,ct,ht,dt,ft,pt,vt,mt,yt,gt,_t,bt,xt,wt,Tt,Ct,St,Ot,Pt,Rt,At,kt,Et,Dt,Mt,It,Lt,Zt,Nt,Ft,zt,Ut,Vt,Bt,Gt,Ht,jt,qt,Wt,Xt,Yt,Qt,Kt,Jt,$t,er,tr,rr,nr,ir,ar,or,sr,lr,ur,cr,hr,dr,fr,pr,vr,mr,yr,gr,_r,br,xr,wr,Tr,Cr,Sr,Or,Pr,Rr,Ar,kr,Er,Dr,Mr,Ir,Lr,Zr,Nr,Fr,zr,Ur,Vr,Br,Gr,Hr,jr,qr,Wr,Xr,Yr,Qr,Kr,Jr,$r,en,tn,rn,nn,an,on,sn,ln,un,cn,hn,dn,fn,pn,vn,mn,yn,gn,_n,bn,xn,wn,Tn,Cn,Sn,On,Pn,Rn,An,kn,En,Dn,Mn,In,Ln,Zn,Nn,Fn,zn,Un,Vn,Bn,Gn,Hn,jn,qn,Wn,Xn,Yn,Qn,Kn,Jn,$n,ei,ti,ri,ni,ii,ai,oi,si,li,ui,ci,hi,di,fi,pi,vi,mi,yi,gi,_i,bi,xi,wi,Ti,Ci,Si,Oi,Pi,Ri,Ai,ki,Ei,Di,Mi,Ii,Li,Zi,Ni,Fi,zi,Ui,Vi,Bi,Gi,Hi,ji,qi,Wi,Xi,Yi,Qi,Ki,Ji,$i,ea,ta,ra,na,ia,aa,oa,sa,la,ua,ca,ha,da,fa,pa,va,ma,ya,ga,_a,ba,xa,wa,Ta,Ca,Sa,Oa,Pa,Ra,Aa,ka,Ea,Da,Ma,Ia,La,Za,Na,Fa,za,Ua,Va,Ba,Ga,Ha,ja,qa,Wa,Xa,Ya,Qa,Ka,Ja,$a,eo,to,ro,no,io,ao,oo,so,lo,uo,co,ho,fo,po,vo,mo,yo,go,_o,bo,xo,wo,To,Co,So,Oo,Po,Ro,Ao,ko,Eo,Do,Mo,Io,Lo,Zo,No,Fo,zo,Uo,Vo,Bo,Go,Ho,jo,qo,Wo,Xo,Yo,Qo,Ko,Jo,$o,es,ts,rs,ns,is,as,os,ss,ls,us,cs,hs,ds,fs,ps,vs,ms,ys,gs,_s,bs,xs,ws,Ts,Cs,Ss,Os,Ps,Rs,As,ks,Es,Ds,Ms,Is,Ls,Zs,Ns,Fs,zs,Us,Vs,Bs,Gs,Hs,js,qs,Ws,Xs,Ys,Qs,Ks,Js,$s,el,tl,rl,nl,il,al,ol,sl,ll,ul,cl,hl,dl,fl,pl,vl,ml,yl,gl,_l,bl,xl,wl,Tl,Cl,Sl,Ol,Pl,Rl,Al,kl,El,Dl,Ml,Il,Ll,Zl,Nl,Fl,zl,Ul,Vl,Bl,Gl,Hl,jl,ql,Wl,Xl,Yl,Ql,Kl,Jl,$l,eu,tu,ru,nu,iu,au,ou,su,lu,uu,cu,hu,du,fu,pu,vu=r(5647),mu=r(93433),yu=r(4942),gu=r(97326),_u=r(11752),bu=r(61120),xu=r(29439),wu=r(30168),Tu=r(1413),Cu=r(37762),Su=r(74165),Ou=r(15861),Pu=r(60136),Ru=r(29388),Au=r(15671),ku=r(43144),Eu=r(48848),Du=r(17455),Mu=r(74384),Iu=r(64998),Lu=r(93314),Zu=r(42467),Nu=r(93661),Fu=r(50690),zu=r(77956),Uu=r(85113),Vu=r(71802),Bu=r(23585),Gu=r(82396),Hu=r(95249),ju=r(25456),qu=r(25747),Wu=r(79557),Xu=r(47855),Yu=r(82474),Qu=r(64772),Ku=r(6189),Ju=r(32043),$u=r(13405),ec=r(37856),tc=r(46817),rc=r(16263),nc=r(3356),ic=r(17332),ac=r(59389),oc=r(630),sc=r(89794),lc=r(91681),uc=r(29048),cc=r(13239),hc=r(49228),dc=r(70381),fc=r(43345),pc=r(93122),vc=r(57791),mc=r(26313),yc=r(87424),gc=r(37077),_c=r(31698),bc=r(47748),xc=r(87440),wc=r(94777),Tc=r(24093),Cc=r(42233),Sc=r(87750),Oc=r(75833),Pc=r(75255),Rc=r(18936),Ac=r(32161),kc=r(41723),Ec=r(1500),Dc=r(67430),Mc=r(76291),Ic=r(20846),Lc=r(4397),Zc=r(85026),Nc=r(25217),Fc=r(27205),zc=r(56162),Uc=r(43406),Vc=r(72361),Bc=r(37944),Gc=r(93209),Hc=r(15529),jc=r(59984),qc=r(22159),Wc=r(68136),Xc=r(43955),Yc=r(52559),Qc=r(87917),Kc=r(33973),Jc=r(58492),$c=r(2821),eh=r(46018),th=r(70863),rh=r(24648),nh=r(6762),ih=r(40558),ah=r(95643),oh=r(63999),sh=r(86086),lh=r(4937),uh=(r(69641),r(1797)),ch=r(5526),hh=r(2473),dh=r(90316),fh=r(23341),ph=r(59929),vh=r(2467),mh=r(43066),yh=r(95414),gh=r(2851),_h=r(70285),bh=r(16599),xh=r(85700),wh=(0,Su.Z)().mark(cT),Th=(0,Su.Z)().mark(hT);function Ch(e){return{operations:e,value:e.create()}}function Sh(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ch(e);return r.operations=e,e.copy(t,r.value),r}var Oh=Math.pow(2,50);function Ph(e,t,r,n){return e.operations.setAltitudeAt(e.value,t,r,n)}function Rh(e,t,r){return e.operations.elevate(e.value,t,r.value)}var Ah=(0,Vu.n)();function kh(e,t,r,n,i){return i[0]=(0,Vu.P)(e,t),i[1]=(0,Vu.P)(e,r),i[2]=(0,Vu.P)(e,n),i}function Eh(e,t,r,n,i){(0,Vu.r)(r,e),(0,Vu.r)(Mh,t),(0,Vu.z)(Mh,Mh),(0,Vu._)(n,Mh,r),(0,Vu._)(i,n,r)}function Dh(e,t){return e?(0,Xu.c)(t):t.isGeographic?Yu.k.PlateCarree:t}var Mh=(0,Vu.n)(),Ih=function(){function e(t){(0,Au.Z)(this,e);var r=e.checkUnsupported(t);if((0,Nu.r)(r))throw r;var n=(0,Nu.e)(t);this.spatialReference=n.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,Hu.R)(this.spatialReference)||(0,Yu.P)(this.spatialReference)||(0,Yu.c)(this.spatialReference),this.origin=[n.origin.x,n.origin.y],this.pixelSize=n.size[0],this.dpi=n.dpi;var i=n.lods.reduce((function(e,t,r){return t.level<e.min&&(e.min=t.level,e.minIndex=r),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),a=n.lods[i.minIndex],o=Math.pow(2,a.level),s=a.resolution*o,l=a.scale*o;this.levels=new Array(i.max+1);for(var u=0;u<this.levels.length;u++)this.levels[u]={resolution:s,scale:l,tileSize:[s*n.size[0],s*n.size[1]]},s/=2,l/=2}return(0,ku.Z)(e,[{key:"clone",value:function(){return new e(this.toTileInfo())}},{key:"toTileInfo",value:function(){return new nc.j({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((function(e,t){return{level:t,scale:e.scale,resolution:e.resolution}}))})}},{key:"getExtent",value:function(e,t,r,n){var i=this.levels[e],a=i.tileSize[0],o=i.tileSize[1];n[0]=this.origin[0]+r*a,n[2]=this.origin[0]+(r+1)*a,n[3]=this.origin[1]-t*o,n[1]=this.origin[1]-(t+1)*o}},{key:"convertExtentToRadians",value:function(e,t){this._isWebMercator?(t[0]=(0,Yu.i)(e[0]),t[1]=(0,Yu.l)(e[1]),t[2]=(0,Yu.i)(e[2]),t[3]=(0,Yu.l)(e[3])):this._isGCS&&(t[0]=(0,Vu.m)(e[0]),t[1]=(0,Vu.m)(e[1]),t[2]=(0,Vu.m)(e[2]),t[3]=(0,Vu.m)(e[3]))}},{key:"getExtentGeometry",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new tc.w;return this.getExtent(e,t,r,Zh),n.spatialReference=this.spatialReference,n.xmin=Zh[0],n.ymin=Zh[1],n.xmax=Zh[2],n.ymax=Zh[3],n.zmin=void 0,n.zmax=void 0,n}},{key:"ensureMaxLod",value:function(e){if(null==e)return!1;for(var t=!1;this.levels.length<=e;){var r=this.levels[this.levels.length-1],n=r.resolution/2;this.levels.push({resolution:n,scale:r.scale/2,tileSize:[n*this.pixelSize,n*this.pixelSize]}),t=!0}return t}},{key:"capMaxLod",value:function(e){this.levels.length>e+1&&(this.levels.length=e+1)}},{key:"getMaxLod",value:function(){return this.levels.length-1}},{key:"scaleAtLevel",value:function(e){return this.levels[0].scale/Math.pow(2,e)}},{key:"levelAtScale",value:function(e){var t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}},{key:"resolutionAtLevel",value:function(e){return this.levels[0].resolution/Math.pow(2,e)}},{key:"compatibleWith",value:function(t){if(!(t instanceof e)){if(e.checkUnsupported(t))return!1;t=new e(t)}if(!t.spatialReference.equals(this.spatialReference))return!1;if(t.pixelSize!==this.pixelSize)return!1;var r=Math.min(this.levels.length,t.levels.length)-1,n=this.levels[r].resolution,i=.5*n;return!(!(0,Vu.T)(t.origin[0],this.origin[0],i)||!(0,Vu.T)(t.origin[1],this.origin[1],i))&&(i=.5*n/Math.pow(2,r)/this.pixelSize*12,(0,Vu.T)(n,t.levels[r].resolution,i))}},{key:"rootTilesInExtent",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,i=new Array,a=this.levels[0].tileSize;if((0,Nu.t)(t)||0===a[0]||0===a[1])return i;e.computeRowColExtent(t,a,this.origin,Zh);var o=Zh[1],s=Zh[3],l=Zh[0],u=Zh[2],c=u-l,h=s-o;if(c*h>n){var d=Math.floor(Math.sqrt(n));h>d&&(s=(o=o+Math.floor(.5*h)-Math.floor(.5*d))+d),c>d&&(u=(l=l+Math.floor(.5*c)-Math.floor(.5*d))+d)}for(var f=o;f<s;f++)for(var p=l;p<u;p++)i.push([0,f,p]);return(0,Nu.r)(r)&&(r[0]=this.origin[0]+l*a[0],r[1]=this.origin[1]-s*a[1],r[2]=this.origin[0]+u*a[0],r[3]=this.origin[1]-o*a[1]),i}},{key:"test",get:function(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}],[{key:"computeRowColExtent",value:function(e,t,r,n){var i=.001*(e[2]-e[0]+(e[3]-e[1]));n[0]=Math.max(0,Math.floor((e[0]+i-r[0])/t[0])),n[2]=Math.max(0,Math.ceil((e[2]-i-r[0])/t[0])),n[1]=Math.max(0,Math.floor((r[1]-e[3]+i)/t[1])),n[3]=Math.max(0,Math.ceil((r[1]-e[1]-i)/t[1]))}},{key:"isPowerOfTwo",value:function(e){var t=e.lods,r=t[0].resolution*Math.pow(2,t[0].level);return!t.some((function(e){return!(0,Vu.V)(e.resolution,r/Math.pow(2,e.level))}))}},{key:"hasGapInLevels",value:function(e){var t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(var r=1;r<t.length;r++)if(t[r]!==t[0]+r)return!0;return!1}},{key:"tileSizeSupported",value:function(e){var t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}},{key:"hasOriginPerLODs",value:function(e){var t=e.origin;return e.lods.some((function(e){return null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)}))}},{key:"getMissingTileInfoError",value:function(){return new Eu.s("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}},{key:"checkUnsupported",value:function(t){return(0,Nu.t)(t)?Lh():t.lods.length<1?new Eu.s("tilingscheme:generic","Tiling scheme must have at least one level"):e.isPowerOfTwo(t)?e.hasGapInLevels(t)?new Eu.s("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):e.tileSizeSupported(t)?e.hasOriginPerLODs(t)?new Eu.s("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new Eu.s("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new Eu.s("tilingscheme:power-of-two","Tiling scheme must be power of two")}},{key:"fromExtent",value:function(t,r){var n=t[2]-t[0],i=t[3]-t[1],a=(0,Xu.$)(r),o=1.2*Math.max(n,i),s=256,l=new e(new nc.j({size:[s,s],origin:{x:t[0]-.5*(o-n),y:t[3]+.5*(o-i)},lods:[{level:0,resolution:o/s,scale:1/(s/96*.0254/(o*a))}],spatialReference:r}));return l.ensureMaxLod(20),l}},{key:"makeWebMercatorAuxiliarySphere",value:function(t){var r=new e(e.WebMercatorAuxiliarySphereTileInfo);return r.ensureMaxLod(t),r}},{key:"makeGCSWithTileSize",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,i=256/r,a=new e(new nc.j({size:[r,r],origin:{x:-180,y:90,spatialReference:t},spatialReference:t,lods:[{level:0,resolution:.703125*i,scale:295497598.570834*i}]}));return a.ensureMaxLod(n),a}}]),e}();function Lh(){return new Eu.s("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}Ih.WebMercatorAuxiliarySphereTileInfo=new nc.j({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:Yu.k.WebMercator},spatialReference:Yu.k.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),Ih.WebMercatorAuxiliarySphere=Ih.makeWebMercatorAuxiliarySphere(19);var Zh=(0,ju.u)(),Nh=64,Fh=512,zh=(0,Vu.W)(Vu.X/10),Uh=(0,ju.u)();Ih.WebMercatorAuxiliarySphere.getExtent(0,0,0,Uh);var Vh=(0,ju.u)([-180,-90,180,90]),Bh=function(e){return e<4?3:4},Gh=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).demResolution={min:-1,max:-1},n.noDataValue=zh,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this.view.basemapTerrain.on("elevation-change",(function(){return e.emit("changed",{})}))}},{key:"extent",get:function(){var e=this.view.basemapTerrain;if((0,Nu.t)(e.extent)||(0,Nu.t)(e.spatialReference))return null;var t=(0,ju.f)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}},{key:"spatialReference",get:function(){return(0,Nu.v)(this.view.basemapTerrain.spatialReference,Yu.k.WGS84)}},{key:"elevationAt",value:function(e,t){if((0,Nu.t)(this.extent)||!(0,tc.f)(this.extent,e,t)){var r=(0,Nu.r)(this.extent)?"".concat(this.extent.xmin,", ").concat(this.extent.ymin,", ").concat(this.extent.xmax,", ").concat(this.extent.ymax):null;return Eu.a.getLogger(this.declaredClass).warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(r,")")),this.noDataValue}return(0,Nu.v)(this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,"ground"),this.noDataValue)}},{key:"queryElevation",value:function(e){return(0,rc.h)(e.clone(),this)}}]),r}(ec.n.EventedAccessor);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Gh.prototype,"demResolution",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Gh.prototype,"extent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Gh.prototype,"noDataValue",void 0),(0,Eu.e)([(0,Eu.y)()],Gh.prototype,"spatialReference",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Gh.prototype,"view",void 0);var Hh=Gh=(0,Eu.e)([(0,Eu.n)("esri.views.support.GroundViewElevationSampler")],Gh),jh=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n.view=null,n.layerViews=new Lu.j,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add((0,Fu.f)((function(){var t,r;return null===(t=e.view)||void 0===t||null===(r=t.map)||void 0===r?void 0:r.ground}),(function(e){return e.load()}))),this._handles.add(this.layerViews.on("after-changes",(function(){return e._layerViewsAfterChangesHandler()})))}},{key:"destroy",value:function(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null)}},{key:"elevationSampler",get:function(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new Hh({view:this.view}):null:null}},{key:"updating",get:function(){return!this.suspended&&this.layerViews.some((function(e){return e.updating}))}},{key:"suspended",get:function(){return!this.view||this.view.suspended}},{key:"_layerViewsAfterChangesHandler",value:function(){var e=this;this._handles.remove("updating"),this._handles.add(this.layerViews.map((function(t){return(0,Fu.l)((function(){return t.updating}),(function(){return e._updateUpdating()}),Fu.U)})).toArray(),"updating"),this._updateUpdating()}},{key:"_updateUpdating",value:function(){this.notifyChange("updating")}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],jh.prototype,"elevationSampler",null),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],jh.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],jh.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({type:Lu.j,readOnly:!0})],jh.prototype,"layerViews",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],jh.prototype,"suspended",null);var qh=jh=(0,Eu.e)([(0,Eu.n)("esri.views.GroundView")],jh),Wh=function(){return r.e(8803).then(r.bind(r,8803))},Xh=function(){return r.e(2273).then(r.bind(r,72273))},Yh={"base-dynamic":function(){return Promise.all([r.e(3602),r.e(142)]).then(r.bind(r,30142))},"base-elevation":Xh,"base-tile":Wh,"bing-maps":Wh,"building-scene":function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(666),r.e(5922),r.e(345),r.e(261),r.e(9092)]).then(r.bind(r,29092))},csv:function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(3891)]).then(r.bind(r,73891))},dimension:function(){return r.e(6433).then(r.bind(r,56433))},elevation:Xh,feature:function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(2862)]).then(r.bind(r,22862))},geojson:function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(298)]).then(r.bind(r,20298))},graphics:function(){return Promise.all([r.e(6419),r.e(9809),r.e(1628)]).then(r.bind(r,31628))},group:function(){return r.e(7801).then(r.bind(r,17801))},imagery:function(){return Promise.all([r.e(3602),r.e(1072)]).then(r.bind(r,61072))},"integrated-mesh":function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(666),r.e(5922),r.e(440)]).then(r.bind(r,60440))},"line-of-sight":function(){return r.e(9350).then(r.bind(r,39350))},"map-image":function(){return Promise.all([r.e(3602),r.e(7650),r.e(2734)]).then(r.bind(r,12734))},media:function(){return r.e(456).then(r.bind(r,90456))},"ogc-feature":function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(8357)]).then(r.bind(r,58357))},"open-street-map":Wh,"oriented-imagery":function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(2862)]).then(r.bind(r,22862))},"point-cloud":function(){return Promise.all([r.e(1475),r.e(2831)]).then(r.bind(r,22831)).then((function(e){return e.P}))},voxel:function(){return r.e(3226).then(r.bind(r,13226))},route:function(){return Promise.all([r.e(6419),r.e(647),r.e(9809),r.e(1207)]).then(r.bind(r,81207))},scene:function(e){return null==e.profile||"mesh-pyramids"===e.profile?Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(666),r.e(5922),r.e(261),r.e(2364),r.e(9460)]).then(r.bind(r,9460)):Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(666),r.e(2364),r.e(8068)]).then(r.bind(r,58068))},stream:function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(830),r.e(3609),r.e(9251)]).then(r.bind(r,9899))},tile:Wh,"imagery-tile":function(){return Promise.all([r.e(1532),r.e(2911)]).then(r.bind(r,22911))},"vector-tile":function(){return Promise.all([r.e(8090),r.e(4495),r.e(7340),r.e(3830),r.e(4e3)]).then(r.bind(r,47475))},wcs:function(){return Promise.all([r.e(1532),r.e(2911)]).then(r.bind(r,22911))},"web-tile":Wh,wfs:function(){return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(8420),r.e(6593),r.e(6419),r.e(469),r.e(830),r.e(8882),r.e(4365)]).then(r.bind(r,4365))},wms:function(){return Promise.all([r.e(3602),r.e(4781)]).then(r.bind(r,24781))},wmts:function(){return r.e(8846).then(r.bind(r,38846))},"geo-rss":null,kml:null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};var Qh,Kh,Jh=function(e){return(0,Nu.r)(Yh[e.type])},$h=function(e){var t=Yh[e.type];if((0,Nu.t)(t))throw function(e){var t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",r=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Eu.s("".concat(r,":view-not-supported"),"".concat(t," is not supported in 3D"))}(e);return t(e)},ed="analyses-owner-handles";!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(Qh||(Qh={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(Kh||(Kh={}));var td=function(e){(0,Pu.Z)(n,e);var t=(0,Ru.Z)(n);function n(e){var r;return(0,Au.Z)(this,n),(r=t.call(this,e))._allAnalysisViews=new Lu.j,r._creatingViewCount=0,r._items=new Map,r._scheduledUpdateHandle=null,r._attachedToViewResolver=rd(),r._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}},r}return(0,ku.Z)(n,[{key:"destroy",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,Eu.d)("AnalysisViewManager was destroyed"))}},{key:"attach",value:function(){this._connectOwners(),this._attachedToViewResolver.resolve()}},{key:"detach",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,Eu.d)()),this._attachedToViewResolver=rd()}},{key:"updating",get:function(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((function(e){return e.updating}))}},{key:"testInfo",get:function(){return{allAnalysisViews:this._allAnalysisViews}}},{key:"whenAnalysisView",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._attachedToViewResolver.promise;case 2:if(r=this._items.get(t),!(0,Nu.t)(r)&&r.state.list!==Kh.REMOVED){e.next=5;break}throw new Eu.s("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 5:return e.abrupt("return",r.createAnalysisViewTask.promise);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_connectOwners",value:function(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),ed)}},{key:"_disconnectOwners",value:function(){this.handles.remove(ed),this._update(),this._creatingViewCount=0}},{key:"_connectAnalysesCollection",value:function(e){var t,r=this,n=(0,Cu.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;this._addAnalysis(i)}}catch(s){n.e(s)}finally{n.f()}var a=e.on("after-add",(function(e){return r._addAnalysis(e.item)})),o=e.on("after-remove",(function(e){return r._removeAnalysis(e.item)}));return{remove:function(){a.remove(),o.remove();var t,n=(0,Cu.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;r._removeAnalysis(i)}}catch(s){n.e(s)}finally{n.f()}}}}},{key:"_addAnalysis",value:function(e){var t=this,r=this._items.get(e);if(null==r){var n={state:{view:Qh.PENDING,list:Kh.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,n),n.createAnalysisViewTask=(0,ac.j)((function(e){return t._createAnalysisViewPromise(n,e)}))}else r.state.list=Kh.ADDED}},{key:"_removeAnalysis",value:function(e){var t=this._items.get(e);null!=t?(t.state.list=Kh.REMOVED,this._scheduleUpdate()):Eu.a.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}},{key:"_scheduleUpdate",value:function(){var e=this;(0,Nu.r)(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=(0,Eu.k)((function(){return e._update()})))}},{key:"_update",value:function(){var e=this;this._scheduledUpdateHandle=(0,Nu.f)(this._scheduledUpdateHandle),this._items.forEach((function(t){if(t.state.list===Kh.REMOVED)switch(e._items.delete(t.analysis),t.state.view){case Qh.PENDING:t.createAnalysisViewTask=(0,Nu.l)(t.createAnalysisViewTask);break;case Qh.CREATED:(0,Nu.r)(t.view)&&(e._allAnalysisViews.remove(t.view),t.view=(0,Nu.g)(t.view),t.createAnalysisViewTask=null)}}))}},{key:"_createAnalysisViewPromise",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.analysis,i=n.type,a=this._analysisModules[i],this._creatingViewCount+=1,!(0,Nu.t)(a.module)){e.next=11;break}return e.prev=2,e.next=5,this._loadAnalysisModule(i);case 5:a.module=e.sent,e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(2),this._creatingViewCount-=1,e.t0;case 11:if(!(0,Eu.p)(r)){e.next=13;break}throw this._creatingViewCount-=1,(0,Eu.d)("AnalysisView creation aborted");case 13:return o=new a.module.default({analysis:n,view:this.view}),e.prev=14,e.next=17,o.when();case 17:e.next=22;break;case 19:throw e.prev=19,e.t1=e.catch(14),this._creatingViewCount-=1,e.t1;case 22:if(!(0,Eu.p)(r)){e.next=24;break}throw this._creatingViewCount-=1,o.destroy(),(0,Eu.d)("AnalysisView creation aborted");case 24:return e.abrupt("return",(t.view=o,t.state.view=Qh.CREATED,this._allAnalysisViews.add(o),this._creatingViewCount-=1,o));case 25:case"end":return e.stop()}}),e,this,[[2,8],[14,19]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_loadAnalysisModule",value:function(e){switch(e){case"area-measurement":return Promise.all([r.e(6951),r.e(8586),r.e(5132),r.e(7521),r.e(5717)]).then(r.bind(r,15717)).then((function(e){return e.A}));case"dimension":return Promise.all([r.e(2470),r.e(4622),r.e(2352),r.e(2299),r.e(8586),r.e(5132),r.e(1386),r.e(1078)]).then(r.bind(r,21078)).then((function(e){return e.D}));case"direct-line-measurement":return Promise.all([r.e(6951),r.e(8586),r.e(7521),r.e(1132)]).then(r.bind(r,61132)).then((function(e){return e.D}));case"line-of-sight":return Promise.all([r.e(2299),r.e(1386),r.e(6296)]).then(r.bind(r,56296));case"slice":return Promise.all([r.e(2299),r.e(345),r.e(3920)]).then(r.bind(r,98541)).then((function(e){return e.S}))}}}]),n}(oc.d);function rd(){var e=(0,Eu.ap)();return e.promise.catch((function(){})),e}(0,Eu.e)([(0,Eu.y)()],td.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],td.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],td.prototype,"_allAnalysisViews",void 0),(0,Eu.e)([(0,Eu.y)()],td.prototype,"_creatingViewCount",void 0);var nd=td=(0,Eu.e)([(0,Eu.n)("esri.views.3d.analysis.AnalysisViewManager3D")],td),id=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).collision=new ld,n.distance=1/0,n.minimumPoiDistance=4,n.tilt=null,n}return(0,ku.Z)(r,[{key:"altitude",get:function(){return this.mode===ic.l.Local?null:this._get("altitude")||null},set:function(e){this.mode!==ic.l.Local?this._set("altitude",e):Eu.a.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}},{key:"clampAltitude",value:function(e){return this.altitude?(0,Vu.a)(e,this.altitude.min,this.altitude.max):e}},{key:"clampTilt",value:function(e,t){if(!this.tilt)return t;var r=this.tilt(e);return(0,Vu.a)(t,r.min,r.max)}},{key:"clampDistance",value:function(e){return Math.min(e,this.distance)}},{key:"createDefaultTilt",value:function(){return this.mode===ic.l.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}},{key:"createConstantMaxTilt",value:function(e){return function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sd;return r.min=od.min,r.max=e,r}}},{key:"_createDefaultTiltLocal",value:function(){var e=this.collision.enabled?(0,qu.U)([[4e3,od.max],[1e4,(0,Vu.m)(88)],[6e6,(0,Vu.m)(88)]]):function(){return od.max};return function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sd;return r.min=od.min,r.max=e(t),r}}},{key:"_createDefaultTiltGlobal",value:function(){var e=this.collision.enabled?(0,qu.U)([[4e3,od.max],[5e4,(0,Vu.m)(88)],[6e6,(0,Vu.m)(88)],[2e7,od.min]]):(0,qu.U)([[3e5,od.max],[3e6,(0,Vu.m)(88)],[6e6,(0,Vu.m)(88)],[2e7,od.min]]);return function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:sd;return r.min=od.min,r.max=e(t),r}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],id.prototype,"altitude",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],id.prototype,"collision",void 0),(0,Eu.e)([(0,Eu.y)()],id.prototype,"distance",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],id.prototype,"minimumPoiDistance",void 0),(0,Eu.e)([(0,Eu.y)()],id.prototype,"tilt",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],id.prototype,"mode",void 0),id=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.Constraints")],id);var ad=function(e){return{min:-2e5,max:4*e.radius}}(Yu.s),od={min:(0,Vu.m)(.5),max:(0,Vu.m)(179.5)},sd={min:0,max:0},ld=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).enabled=!0,e.elevationMargin=5,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:Boolean})],ld.prototype,"enabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Number})],ld.prototype,"elevationMargin",void 0),ld=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.Constraints.CollisionConstraint")],ld);var ud=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).min=ad.min,e.max=ad.max,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:Number})],ud.prototype,"min",void 0),(0,Eu.e)([(0,Eu.y)({type:Number})],ud.prototype,"max",void 0),ud=(0,Eu.e)([(0,Eu.n)("esri.views.3d.constraints.AltitudeConstraint")],ud);var cd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).mode="auto",e}return(0,ku.Z)(r,[{key:"near",get:function(){return this._get("near")},set:function(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}},{key:"castNear",value:function(e){return Math.max(1e-8,e)}},{key:"far",get:function(){return this._get("far")},set:function(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}},{key:"castFar",value:function(e){return Math.max(1e-8,e)}},{key:"autoUpdate",value:function(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:Number,value:1e-8})],cd.prototype,"near",null),(0,Eu.e)([(0,Eu.c)("near")],cd.prototype,"castNear",null),(0,Eu.e)([(0,Eu.y)({type:Number,value:1e-8})],cd.prototype,"far",null),(0,Eu.e)([(0,Eu.c)("far")],cd.prototype,"castFar",null),(0,Eu.e)([(0,Eu.y)({type:["auto","manual"]})],cd.prototype,"mode",void 0),cd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.constraints.ClipDistanceConstraint")],cd);var hd={min:(0,Vu.b)(od.min),max:(0,Vu.b)(od.max)},dd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).mode="auto",e}return(0,ku.Z)(r,[{key:"max",get:function(){return this._get("max")},set:function(e){this._set("max",e),this.mode="manual"}},{key:"castMax",value:function(e){return(0,Vu.a)(e,hd.min,hd.max)}},{key:"autoUpdate",value:function(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:["auto","manual"]})],dd.prototype,"mode",void 0),(0,Eu.e)([(0,Eu.y)({type:Number,value:hd.max})],dd.prototype,"max",null),(0,Eu.e)([(0,Eu.c)("max")],dd.prototype,"castMax",null),dd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.constraints.TiltConstraint")],dd);var fd,pd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).tilt=new dd,e.altitude=new ud,e.clipDistance=new cd,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:dd})],pd.prototype,"tilt",void 0),(0,Eu.e)([(0,Eu.y)({type:ud})],pd.prototype,"altitude",void 0),(0,Eu.e)([(0,Eu.y)({type:cd})],pd.prototype,"clipDistance",void 0),pd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.constraints.Constraints")],pd);var vd=fd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;(0,Au.Z)(this,r),(n=t.call(this,e)).cameraTrackingEnabled=!0,n.ambientOcclusionEnabled=!1,n.waterReflectionEnabled=!1,n.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};var i=(new Date).getFullYear(),a=new Date("March 15, "+i+" 12:00:00 UTC");return n._set("defaultDate",a),n._set("date",a),n}return(0,ku.Z)(r,[{key:"defaultDate",get:function(){return new Date(this._get("defaultDate").getTime())},set:function(e){var t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}},{key:"date",set:function(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}},{key:"autoUpdate",value:function(e,t){var r=fd.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;var n=null;(0,Nu.r)(e)&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(n=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(n=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));var i=fd.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==i&&(yd.target=this,yd.timezoneOffset=i,this.emit("timezone-will-change",yd)),(0,Nu.r)(e))return!!isNaN(e.getTime())||n!==e.getTime()}},{key:"clone",value:function(){var e=this._get("date")===this._get("defaultDate"),t=new fd((0,Tu.Z)((0,Tu.Z)({},this.cloneConstructProperties()),{},{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new fd(e.cloneConstructProperties())}}]),r}(ec.n.EventedMixin(qu.p));(0,Eu.e)([(0,Eu.y)({type:Boolean})],vd.prototype,"cameraTrackingEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],vd.prototype,"ambientOcclusionEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],vd.prototype,"waterReflectionEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Date})],vd.prototype,"defaultDate",null),(0,Eu.e)([(0,Eu.y)({type:Date})],vd.prototype,"date",null),function(e){e.calculateTimezoneOffset=function(e){var t=e.hours,r=e.minutes,n=e.seconds;return Math.round(t+r/60+n/3600)}}((vd=fd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.SunLighting")],vd))||(vd={}));var md,yd={target:null,timezoneOffset:0},gd=vd,_d=md=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).ambientOcclusionEnabled=!1,n.waterReflectionEnabled=!1,n.cameraTrackingEnabled=!0,n}return(0,ku.Z)(r,[{key:"clone",value:function(){return new md((0,Tu.Z)((0,Tu.Z)({},this.cloneConstructProperties()),{},{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}))}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new md(e.cloneConstructProperties())}}]),r}(ec.n.EventedMixin(qu.b));(0,Eu.e)([(0,Eu.y)({type:Boolean})],_d.prototype,"ambientOcclusionEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],_d.prototype,"waterReflectionEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],_d.prototype,"cameraTrackingEnabled",void 0);var bd,xd,wd=_d=md=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.VirtualLighting")],_d),Td={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:gd,virtual:wd}},Cd=bd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"quality",set:function(e){["low","high"].includes(e)&&this._set("quality",e)}},{key:"clone",value:function(){return new bd({quality:this.quality})}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:["low","high"],value:"low"})],Cd.prototype,"quality",null),Cd=bd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.SceneViewAtmosphere")],Cd);var Sd=xd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).atmosphere=new Cd,n.lighting=new gd,n.cachedCameraTrackingEnabled=null,n}return(0,ku.Z)(r,[{key:"castLighting",value:function(e){return this._convertLighting(e)}},{key:"applyLighting",value:function(e){this.lighting=this._convertLighting(e)}},{key:"_convertLighting",value:function(e){var t,r;return e?e instanceof gd||e instanceof wd?e:e instanceof qu.p?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new gd((0,Tu.Z)((0,Tu.Z)({},e.cloneConstructProperties()),null===(t=this.lighting)||void 0===t?void 0:t.cloneNonPersistentConstructProperties())):e instanceof qu.b?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new wd((0,Tu.Z)((0,Tu.Z)({},e.cloneConstructProperties()),null===(r=this.lighting)||void 0===r?void 0:r.cloneNonPersistentConstructProperties())):(0,Eu.S)(Td,e):new gd}},{key:"clone",value:function(){return new xd({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Nu.y)(this.background)})}},{key:"cloneWithWebsceneEnvironment",value:function(e){return new xd((0,Tu.Z)((0,Tu.Z)({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Nu.y)(this.background)},e.cloneConstructProperties()),{},{lighting:this._getLighting(e)}))}},{key:"_getLighting",value:function(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):gd.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):wd.fromWebsceneLighting(e.lighting);default:return gd.fromWebsceneLighting(e.lighting)}}}],[{key:"fromWebsceneEnvironment",value:function(e){var t=e.cloneConstructProperties();return new xd((0,Tu.Z)((0,Tu.Z)({},t),{},{lighting:"virtual"===t.lighting.type?wd.fromWebsceneLighting(t.lighting):gd.fromWebsceneLighting(t.lighting)}))}}]),r}(qu.j);(0,Eu.e)([(0,Eu.y)({type:Cd,json:{read:!1},nonNullable:!0})],Sd.prototype,"atmosphere",void 0),(0,Eu.e)([(0,Eu.y)({nonNullable:!0})],Sd.prototype,"lighting",void 0),(0,Eu.e)([(0,Eu.c)("lighting")],Sd.prototype,"castLighting",null);var Od,Pd=Sd=xd=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.SceneViewEnvironment")],Sd);function Rd(e){var t=1e5;return Math.min(1,Math.max(0,(e-t)/9e5))}!function(e){e[e.Simple=0]="Simple",e[e.Realistic=1]="Realistic",e[e.Panoramic=2]="Panoramic",e[e.None=3]="None"}(Od||(Od={}));var Ad=1e4,kd=1e5;function Ed(e){e.fragment.code.add((0,dc.n)(n||(n=(0,wu.Z)(["const float GAMMA = 2.2;\nconst float INV_GAMMA = 0.4545454545;\nvec4 delinearizeGamma(vec4 color) {\nreturn vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n}\nvec3 linearizeGamma(vec3 color) {\nreturn pow(color, vec3(GAMMA));\n}"]))))}var Dd=(0,Vu.c)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),Md=(0,Vu.c)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),Id=(0,Vu.c)(parseFloat(Number(Dd[0]+Md[0]).toFixed(6)),parseFloat(Number(Dd[1]+Md[1]).toFixed(6)),parseFloat(Number(Dd[2]+Md[2]).toFixed(6)));function Ld(e){var t=new dc.o;t.attributes.add(fc.O.POSITION,"vec2"),t.include(dc.a,{textureCoordinateType:dc.d.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");var r=t.vertex,n=t.fragment;return r.uniforms.add([new dc.e("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new dc.e("inverseViewMatrix",(function(e,t){return(0,Wu.h)(Zd,t.camera.viewMatrix)}))]),r.code.add((0,dc.n)(i||(i=(0,wu.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),n.uniforms.add([new dc.b("radii",(function(e){return e.radii})),new dc.c("cameraPosition",(function(e,t){return t.camera.eye})),new dc.f("heightParameters",(function(e){return e.heightParameters})),new dc.g("innerFadeDistance",(function(e){return e.innerFadeDistance})),new dc.g("altitudeFade",(function(e){return e.altitudeFade})),new dc.h("depthTex",(function(e){return e.depthTex})),new dc.g("hazeStrength",(function(e){return e.hazeStrength}))]),n.constants.add("betaRayleigh","vec3",Dd),n.constants.add("betaCombined","vec3",Id),n.constants.add("betaMie","float",3996e-9),n.constants.add("scaleHeight","float",8500),(0,dc.i)(n),t.include(Ed),e.haze&&(n.include(dc.j),n.uniforms.add(new dc.b("nearFar",(function(e,t){return t.camera.nearFar})))),n.code.add((0,dc.n)(a||(a=(0,wu.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = planet ? heightParameters[1] - radius * radius : heightParameters[2];\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),n.code.add((0,dc.n)(o||(o=(0,wu.Z)(["float chapmanApproximation(float X, float h, float cosZenith) {\nfloat c = sqrt(X + h);\nfloat cExpH = c * exp(-h);\nif (cosZenith >= 0.0) {\nreturn cExpH / (c * cosZenith + 1.0);\n} else {\nfloat x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);\nfloat c0 = sqrt(x0);\nreturn 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);\n}\n}"])))),n.code.add((0,dc.n)(s||(s=(0,wu.Z)(["float getOpticalDepth(vec3 position, vec3 dir, float h) {\nreturn scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));\n}"])))),n.code.add((0,dc.n)(l||(l=(0,wu.Z)(["\n    const int STEPS = 6;\n\n    float getGlow(float dist, float radius, float intensity) {\n      return pow(radius / max(dist, 1e-6), intensity);\n    }\n\n    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {\n      float reducedPlanetRadius = radii[0] - 20000.0;\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);\n      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);\n      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;\n      bool insideAtmosphere = heightParameters[0] < radii[1];\n\n      if (!(hitsAtmosphere || insideAtmosphere)) {\n        return vec3(0);\n      }\n\n      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;\n\n      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;\n\n      if (heightParameters[0] < reducedPlanetRadius) {\n        // Long light rays from the night side of the planet lead to numerical instability\n        // Do not render the atmosphere in such cases\n        if (dot(rayDir, normalize(cameraPos)) < -0.025) {\n          return vec3(0);\n        }\n        start = rayPlanetIntersect.y;\n      }\n\n      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;\n      float maxEnd = end;\n\n      ","\n\n      vec3 samplePoint = cameraPos + rayDir * end;\n      float multiplier = hitsPlanet ? -1.0 : 1.0;\n\n      vec3 scattering = vec3(0);\n      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);\n      float stepSize = (end - start) / float(STEPS);\n      for (int i = 0; i < STEPS; i++) {\n        samplePoint -= stepSize * rayDir;\n        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);\n\n        if (i > 0) {\n          scattering *= "," exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));\n        }\n\n        if (dot(normalize(samplePoint), lightDir) > -0.3) {\n\n          float scale = exp(-scaleFract);\n          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);\n\n          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);\n          ","\n        }\n\n        lastOpticalDepth = opticalDepth;\n\n      }\n\n      float mu = dot(rayDir, lightDir);\n      float mumu = 1.0 + mu * mu;\n\n      float phaseRayleigh = 0.0596831 * mumu;\n\n      ","\n    }\n\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);\n      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {\n        return fragColor;\n      }\n\n      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));\n      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);\n      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;\n      if (relDist > 1.0) {\n        return surfaceColor;\n      }\n\n      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n      ","\n\n      ","\n      col = tonemapACES(col);\n      gl_FragColor = delinearizeGamma(vec4(col, alpha));\n      ","\n    }\n  "])),e.haze?(0,dc.n)(u||(u=(0,wu.Z)(["if (terrainDepth != -1.0) { end = terrainDepth; }"]))):"",e.haze?(0,dc.n)(c||(c=(0,wu.Z)([""]))):" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * ",e.haze?"":(0,dc.n)(h||(h=(0,wu.Z)(["scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);"]))),e.haze?(0,dc.n)(d||(d=(0,wu.Z)(["return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;"]))):(0,dc.n)(f||(f=(0,wu.Z)(["\n            const float g = 0.8;\n            const float gg = g * g;\n            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;\n            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));\n            phaseMie = clamp(phaseMie, 0.0, 128.0);\n            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);"]))),e.haze?(0,dc.n)(p||(p=(0,wu.Z)(["\n          vec4 depthSample = texture2D(depthTex, vuv0).rgba;\n          if (depthSample != vec4(0)) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);\n            terrainDepth = max(0.0, length(cameraSpaceRay));\n          }"]))):(0,dc.n)(v||(v=(0,wu.Z)(["\n          float depthSample = texture2D(depthTex, vuv0).r;\n          if (depthSample != 1.0) {\n            gl_FragColor = vec4(0);\n            return;\n          }"]))),e.haze?(0,dc.n)(m||(m=(0,wu.Z)(["\n            vec3 col = vec3(0);\n            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);\n            if(depthSample != vec4(0)){\n              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            }\n            float alpha = 1.0 - fadeOut;"]))):(0,dc.n)(y||(y=(0,wu.Z)(["\n            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;\n            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));"]))),e.haze?"":(0,dc.n)(g||(g=(0,wu.Z)(["\n          if (depthSample == 1.0) {\n            gl_FragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, gl_FragColor);\n          }"]))))),t}var Zd=(0,hc.e)(),Nd=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:Dd,build:Ld},Symbol.toStringTag,{value:"Module"})),Fd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).heightParameters=(0,lc.n)(),e.radii=(0,cc.n)(),e.innerFadeDistance=0,e.altitudeFade=0,e.hazeStrength=1,e}return(0,ku.Z)(r)}(dc.t),zd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return this.configuration.haze?(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ZERO,pc.R.ONE_MINUS_SRC_COLOR,pc.R.ONE),colorWrite:vc._}):(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);zd.shader=new dc.m(Nd,(function(){return r.e(6454).then(r.bind(r,66454))}));var Ud=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).haze=!1,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)()],Ud.prototype,"haze",void 0);var Vd,Bd,Gd=function(){function e(t){(0,Au.Z)(this,e),this._view=t,this.type=Od.Realistic,this._passParameters=new Fd,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=Yu.s.radius,this._fadeHaze=0,this._updateRadius(Yu.s.radius)}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._atmosphereTechnique=(0,Nu.F)(this._atmosphereTechnique),this._atmosphereHazeTechnique=(0,Nu.F)(this._atmosphereHazeTechnique),this._vao=(0,Nu.G)(this._vao),this._handles=(0,Nu.g)(this._handles)}},{key:"initializeRenderContext",value:function(e){var t=this,r=e.renderContext.rctx,n=this._handles=new Eu.X;this._updateRootTileElevationBounds(),n.add((0,Fu.l)((function(){return t._view.basemapTerrain.rootTileElevationBounds}),(function(){return t._updateRootTileElevationBounds()}))),n.add((0,Fu.l)((function(){return t._view.basemapTerrain.visibleElevationBounds}),(function(){return t._updateVisibleElevationBounds()})));var i=new Ud;i.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRepository.acquire(zd,i),i.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRepository.acquire(zd,i),this._vao=(0,dc.u)(r,dc.A)}},{key:"render",value:function(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}},{key:"renderHaze",value:function(e,t){this._fadeHaze=t,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}},{key:"_render",value:function(e,t,r){var n=this;if(!(0,Nu.t)(r)){this._update(e.bindParameters.camera),this._passParameters.depthTex=r;var i=e.rctx.bindTechnique(t,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached((function(){n._renderCommon(i,e)}))}}},{key:"_renderCommon",value:function(e,t){(0,Nu.t)(this._vao)||(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(pc.E.TRIANGLE_STRIP,0,4))}},{key:"_adjustRadiusForTesselation",value:function(e){return e*Math.cos(Math.PI/16/16)}},{key:"_updateRootTileElevationBounds",value:function(){var e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=Yu.s.radius,this._updateVisibleElevationBounds())}},{key:"_updateVisibleElevationBounds",value:function(){var e=this._adjustRadiusForTesselation(Yu.s.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}},{key:"_updateRadius",value:function(e){this._lowerBoundEarthRadius=e,(0,uc.r)(this._passParameters.radii,e,e+kd),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-Ad)*Ad)}},{key:"_update",value:function(e){if(!(0,Nu.t)(e)){var t=(0,Vu.s)(e.eye),r=t*t,n=r-this._passParameters.radii[1]*this._passParameters.radii[1],i=Math.min(1,Math.max(0,(t-this._passParameters.radii[0])/kd));(0,Vu.C)(this._passParameters.heightParameters,t,r,n,i),this._passParameters.altitudeFade=Rd(t-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=(0,Vu.Z)((0,Vu.Z)(.6,1,(0,Vu.$)(9500,10500,t-Yu.s.radius)),1,this._fadeHaze)}}}],[{key:"isSupported",value:function(e){return e.renderContext.rctx.capabilities.depthTexture}}]),e}();function Hd(e){return(0,Nu.r)(e)&&!e.running}!function(e){e[e.RENDERING=0]="RENDERING",e[e.FINISHED_RENDERING=1]="FINISHED_RENDERING",e[e.FADING_TEXTURE_CHANNELS=2]="FADING_TEXTURE_CHANNELS",e[e.SWITCH_CHANNELS=3]="SWITCH_CHANNELS",e[e.FINISHED=4]="FINISHED"}(Vd||(Vd={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(Bd||(Bd={}));var jd,qd,Wd,Xd=function(){function e(){(0,Au.Z)(this,e),this.readChannels=Bd.RG,this.renderingStage=Vd.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,Vu.n)(),this.isCameraPositionFinal=!0,this.parallax=new Yd,this.parallaxNew=new Yd,this.crossFade={enabled:!1,factor:1,distanceThresholdFactor:.3},this.fadeInOut={stage:qd.FINISHED,factor:1,distanceThresholdFactor:.6},this.fadeIn={stage:jd.FINISHED,factor:1,distanceThresholdFactor:2},this.fadeInOutHeight={stage:Wd.FINISHED,factor:-1}}return(0,ku.Z)(e,[{key:"isFading",get:function(){return this.fadeInOut.stage===qd.FADE_OUT||this.fadeInOut.stage===qd.FADE_IN||this.fadeIn.stage===jd.FADE_IN||this.fadeInOutHeight.stage!==Wd.FINISHED||this.renderingStage===Vd.FADING_TEXTURE_CHANNELS}}]),e}();!function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(jd||(jd={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.SWITCH=2]="SWITCH",e[e.FADE_IN=3]="FADE_IN"}(qd||(qd={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(Wd||(Wd={}));var Yd=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.anchorPointClouds=(0,Vu.n)(),this.cloudsHeight=1e5,this.radiusCurvatureCorrectionFactor=0,this.transform=(0,hc.e)()})),Qd=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){return(0,Au.Z)(this,r),t.call(this,e,"samplerCube",dc.s.Pass,(function(t,r,i){return t.bindTexture(e,n(r,i))}))}return(0,ku.Z)(r)}(dc.r);function Kd(e){var t=e.fragment;t.uniforms.add([new dc.e("rotationMatrixClouds",(function(e,t){return t.cloudsFade.parallax.transform})),new dc.e("rotationMatrixCloudsCrossFade",(function(e,t){return t.cloudsFade.parallaxNew.transform})),new dc.c("anchorPosition",(function(e,t){return t.cloudsFade.parallax.anchorPointClouds})),new dc.c("anchorPositionCrossFade",(function(e,t){return t.cloudsFade.parallaxNew.anchorPointClouds})),new dc.g("cloudsHeight",(function(e,t){return t.cloudsFade.parallax.cloudsHeight})),new dc.g("radiusCurvatureCorrectionFactor",(function(e,t){return t.cloudsFade.parallax.radiusCurvatureCorrectionFactor})),new dc.g("totalFadeInOut",(function(e,t){return t.cloudsFade.fadeInOut.stage===qd.FINISHED?t.cloudsFade.fadeInOutHeight.factor+1-t.cloudsFade.fadeIn.factor:t.cloudsFade.fadeInOutHeight.factor+1-t.cloudsFade.fadeInOut.factor})),new dc.g("crossFadeAnchorFactor",(function(e,t){return(0,Vu.a)(t.cloudsFade.crossFade.factor,0,1)})),new Qd("cubeMap",(function(e,t){return(0,Nu.r)(t.cloudsFade.data)&&(0,Nu.r)(t.cloudsFade.data.cubeMap)?t.cloudsFade.data.cubeMap.colorTexture:null})),new dc.v("crossFade",(function(e,t){return t.cloudsFade.crossFade.enabled})),new dc.v("readChannelsRG",(function(e,t){return t.cloudsFade.readChannels===Bd.RG})),new dc.v("fadeTextureChannels",(function(e,t){return t.cloudsFade.renderingStage===Vd.FADING_TEXTURE_CHANNELS}))]),t.constants.add("planetRadius","float",Yu.s.radius),t.code.add((0,dc.n)(_||(_=(0,wu.Z)(["vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)\n{\nfloat radiusClouds = planetRadius + cloudsHeight;\nfloat B = 2.0 * dot(cameraPosition, dir);\nfloat C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;\nfloat det = B * B - 4.0 * C;\nfloat pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));\nvec3 intersectionPont = cameraPosition + dir * pointIntDist;\nintersectionPont =  intersectionPont - spherePos;\nreturn intersectionPont;\n}"])))),t.code.add((0,dc.n)(b||(b=(0,wu.Z)(["vec3 correctForPlanetCurvature(vec3 dir)\n{\ndir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;\nreturn dir;\n}"])))),t.code.add((0,dc.n)(x||(x=(0,wu.Z)(["vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)\n{\nreturn (rotMat * vec4(inVec, 0.0)).xyz;\n}"])))),(0,dc.i)(t),(0,dc.w)(t),t.code.add((0,dc.n)(w||(w=(0,wu.Z)(["const float SUNSET_TRANSITION_FACTOR = 0.3;\nconst vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);\nconst float RIM_SCATTERING_FACTOR = 140.0;\nconst float BACKLIGHT_FACTOR = 0.2;\nconst float BACKLIGHT_SCATTERING_FACTOR = 10.0;\nconst float BACKLIGHT_TRANSITION_FACTOR = 0.3;\nvec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)\n{\nfloat upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));\nfloat dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);\nfloat sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);\nvec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);\nvec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);\nvec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));\nvec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));\nfloat scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);\nfloat rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);\nvec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;\nfloat additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;\nreturn vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);\n}"])))),t.code.add((0,dc.n)(T||(T=(0,wu.Z)(["vec4 getCloudData(vec3 rayDir, bool readOtherChannel)\n{\nvec4 cloudData = textureCube(cubeMap, rayDir);\nfloat mu = dot(rayDir, vec3(0, 0, 1));\nbool readChannels = readChannelsRG ^^ readOtherChannel;\nif (readChannels) {\ncloudData = vec4(vec3(cloudData.r), cloudData.g);\n} else {\ncloudData = vec4(vec3(cloudData.b), cloudData.a);\n}\nif (length(cloudData) == 0.0) {\nreturn vec4(cloudData.rgb, 1.0);\n}\nreturn cloudData;\n}"])))),t.code.add((0,dc.n)(C||(C=(0,wu.Z)(["vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nfloat totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudData.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);\n}"])))),t.code.add((0,dc.n)(S||(S=(0,wu.Z)(["vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nvec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\nintersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);\nworldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));\nworldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\ncloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);\nvec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\ncloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);\nfloat totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudColor.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(cloudColor.rgb, totalTransmittance);\n}"])))),t.code.add((0,dc.n)(O||(O=(0,wu.Z)(["vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)\n{\nreturn crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);\n}"]))))}function Jd(){var e=new dc.o;e.attributes.add(fc.O.POSITION,"vec2"),e.varyings.add("worldRay","vec3");var t=e.vertex,r=e.fragment;return t.uniforms.add([new dc.e("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new dc.e("inverseViewMatrix",(function(e,t){return(0,Wu.h)($d,t.camera.viewMatrix)}))]),t.code.add((0,dc.n)(P||(P=(0,wu.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;\ngl_Position = vec4(position, 1.0, 1.0);\n}"])))),r.include(dc.x),r.include(dc.y),e.include(dc.z,{pbrMode:dc.B.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(dc.C),e.include(Ed),e.include(dc.D,{useLegacyTerrainShading:!1}),e.include(Kd,{instancedDoublePrecision:!1,useLegacyTerrainShading:!1}),r.uniforms.add([new dc.c("cameraPosition",(function(e,t){return t.camera.eye}))]),r.code.add((0,dc.n)(R||(R=(0,wu.Z)(["void main() {\nvec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);\ngl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);\n}"])))),e}var $d=(0,hc.e)(),ef=Object.freeze(Object.defineProperty({__proto__:null,build:Jd},Symbol.toStringTag,{value:"Module"})),tf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),n=t.call(this,e,new dc.q,(function(){return n.destroy()}))}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.SRC_ALPHA),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);tf.shader=new dc.m(ef,(function(){return r.e(6945).then(r.bind(r,66945))}));var rf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._technique=new tf(e),n._vao=(0,dc.u)(e.rctx),n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._technique=(0,Nu.F)(this._technique),this._vao=(0,Nu.G)(this._vao)}},{key:"render",value:function(e){var t=e.bindParameters.cloudsFade;if(!(0,Nu.t)(this._vao)&&!(0,Nu.t)(t.data))if(this._technique.compiled){var r=e.rctx.bindTechnique(this._technique,af,e.bindParameters);e.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(pc.E.TRIANGLE_STRIP,0,4)}else this.requestRender()}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rf.prototype,"rctx",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rf.prototype,"viewingMode",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rf.prototype,"planetRadius",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rf.prototype,"requestRender",void 0),rf=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.CloudsComposition")],rf);var nf,af=new dc.t;!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(nf||(nf={}));var of=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).steps=nf.SIXTEEN,e.writeTextureChannels=Bd.RG,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)({count:nf.COUNT})],of.prototype,"steps",void 0),(0,Eu.e)([(0,dc.p)({constValue:(0,Nu.h)("esri-mobile")?1024:2048})],of.prototype,"cubeMapSize",void 0),(0,Eu.e)([(0,dc.p)()],of.prototype,"writeTextureChannels",void 0);var sf=(0,ku.Z)((function e(t,r,n,i,a,o,s,l){var u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;(0,Au.Z)(this,e),this.coverage=t,this.density=r,this.absorption=n,this.cloudSize=i,this.detailSize=a,this.smoothness=o,this.cloudHeight=s,this.raymarchingSteps=l,this.median=u})),lf=new sf([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],nf.SIXTEEN),uf={sunny:lf,cloudy:new sf([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],nf.TWOHUNDRED,.6),rainy:new sf([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],nf.TWOHUNDRED,.4),snowy:new sf([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],nf.HUNDRED,.65),foggy:new sf([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],nf.SIXTEEN),default:lf},cf=(0,Nu.h)("esri-mobile")?64:128,hf=cf/128,df=Math.ceil(Math.sqrt(cf)),ff=(cf+2)*df,pf=ff/1560,vf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).cloudRadius=0,e.cloudSize=0,e.detailSize=0,e.absorption=0,e.density=0,e.smoothness=0,e.cloudHeight=0,e.coverage=0,e.raymarchingSteps=uf.default.raymarchingSteps,e.weatherTile=(0,cc.n)(),e}return(0,ku.Z)(r)}(dc.t),mf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).viewMatrix=(0,gc.e)(),e}return(0,ku.Z)(r)}(dc.t);function yf(e){var t=new dc.o;t.include(dc.F,!1);var r=t.fragment;return r.uniforms.add([new dc.g("cloudRadius",(function(e){return e.cloudRadius})),new dc.g("power",(function(e){return(0,Vu.Z)(35,120,e.absorption)})),new dc.g("sigmaE",(function(e){return 1+e.absorption})),new dc.g("density",(function(e){return(0,Vu.Z)(0,.3,e.density)})),new dc.g("cloudSize",(function(e){return(0,Vu.Z)(0,.02,Math.max(.01,1-e.cloudSize))})),new dc.g("detailSize",(function(e){return(0,Vu.Z)(0,.2,Math.max(.01,1-e.detailSize))})),new dc.g("smoothness",(function(e){return(0,Vu.Z)(0,.5,1-e.smoothness)})),new dc.g("cloudHeight",(function(e){return(0,Vu.Z)(0,1500,e.cloudHeight)})),new dc.g("coverage",(function(e){return e.coverage})),new dc.G("view",(function(e){return e.viewMatrix})),new dc.h("cloudShapeTexture",(function(e){return(0,Nu.r)(e.noiseTexture)?e.noiseTexture.textureAtlas:null})),new dc.b("cloudVariables",(function(e){return(0,uc.r)(_f,e.coverage,e.absorption)}))]),r.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),r.code.add((0,dc.n)(A||(A=(0,wu.Z)(["\n    const int STEPS = ",";\n    const int STEPS_LIGHT = 6;\n    const float stepL = 300.0 / float(STEPS_LIGHT);\n    const float cloudStart = 1500.0;\n\n    vec3 rayDirection(vec2 fragCoord) {\n      vec2 xy = fragCoord - halfCubeMapSize;\n      return normalize(vec3(-xy, -halfCubeMapSize));\n    }\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }"])),e.steps===nf.SIXTEEN?(0,dc.n)(k||(k=(0,wu.Z)(["16"]))):e.steps===nf.HUNDRED?(0,dc.n)(E||(E=(0,wu.Z)(["100"]))):(0,dc.n)(D||(D=(0,wu.Z)(["200"]))))),r.code.add((0,dc.n)(M||(M=(0,wu.Z)(["\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = ",";\n      const float dataWidth = ",";\n      const float tileRows = ",";\n      const vec3 atlasDimensions = vec3(",", ",", tileRows * tileRows);\n\n      //Change from Y being height to Z being height\n      vec3 p = float(",") * pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }\n\n    float getCloudMap(vec2 p){\n      // Non-power-of-two textures can't be tiled using WebGL1\n      // Get fractional part of uv to tile\n      // Shift the texture center to origin to avoid seam artifacts\n      vec2 uv = fract(("," * p) / "," + 0.5);\n\n      return texture2D(cloudShapeTexture, uv).a;\n    }\n    "])),dc.n.float(ff),dc.n.float(ff),dc.n.float(df),dc.n.float(cf),dc.n.float(cf),dc.n.float(hf),dc.n.float(pf),dc.n.float(ff))),r.code.add((0,dc.n)(I||(I=(0,wu.Z)(["float clouds(vec3 p) {\nfloat cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat cloudMap = getCloudMap(cloudSize * p.xy);\ncloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat shape = getCloudShape(8.0 * cloudSize * p, 0.0);\ncloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\ncloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nreturn density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n}"])))),r.code.add((0,dc.n)(L||(L=(0,wu.Z)(["vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = dot(start, start) - (radius * radius);\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}\nfloat HenyeyGreenstein(float g, float costh) {\nreturn (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n}"])))),r.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),r.code.add((0,dc.n)(Z||(Z=(0,wu.Z)(["float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\nfloat lightRayDensity = clouds(p);\nlightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\nfloat beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\nreturn mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n}"])))),r.code.add((0,dc.n)(N||(N=(0,wu.Z)(["float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\nif (dir.z < 0.0) {\nreturn 0.0;\n}\ntotalTransmittance = 1.0;\nfloat stepS = totalDistance / float(STEPS);\nfloat cameraHeight = length(org);\nfloat mu = 0.5 + 0.5 * dot(sunDirection, dir);\nfloat phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\nvec3 p = org + distToStart  * dir;\nfloat dist = distToStart;\nfloat shading = 0.0;\nfor (int i = 0; i < STEPS; i++) {\nfloat sampleDensity = clouds(p);\nfloat sampleSigmaE = sampleDensity * sigmaE;\nif (sampleDensity > 0.0 ) {\nfloat ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\nfloat luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\nfloat transmittance = exp(-sampleSigmaE * stepS);\nshading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\ntotalTransmittance *= transmittance;\nif (totalTransmittance <= 0.001) {\ntotalTransmittance = 0.0;\nbreak;\n}\n}\ndist += stepS;\np = org + dir * dist;\n}\nreturn shading;\n}"])))),r.code.add((0,dc.n)(F||(F=(0,wu.Z)(["void main() {\nif (coverage ==  0.0) {\ngl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\nreturn;\n}\nvec3 rayDir = rayDirection(gl_FragCoord.xy);\nrayDir = normalize(view * rayDir);\nvec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\nbool hitsPlanet = rayDir.z < 0.0;\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat totalTransmittance = 1.0;\nfloat shading = 0.0;\nif (hitsPlanet) {\nshading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);\ntotalTransmittance = hazeFactor;\ngl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\nreturn;\n}\nvec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\nvec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\nfloat distToStart = rayStartIntersect.y;\nfloat totalDistance = rayEndIntersect.y - distToStart;\nvec3 sunDirection = normalize(vec3(0, 0, 1));\nshading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);\nshading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);\ntotalTransmittance = mix(0.0, totalTransmittance, hazeFactor);\ngl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\n}"])))),t}var gf,_f=(0,cc.n)(),bf=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:vf,CloudsDrawParameters:mf,build:yf},Symbol.toStringTag,{value:"Module"})),xf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),i=t.call(this,e,n,(function(){return i.destroy()}))}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.s)(pc.R.CONSTANT_COLOR,pc.R.ONE_MINUS_CONSTANT_COLOR,pc.T.ADD,this.configuration.writeTextureChannels===Bd.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);xf.shader=new dc.m(bf,(function(){return r.e(4225).then(r.bind(r,84225))})),function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(gf||(gf={}));var wf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).mode=gf.Full,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)({count:gf.COUNT})],wf.prototype,"mode",void 0);var Tf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).weatherTile=(0,cc.r)(0,0),e}return(0,ku.Z)(r)}(dc.t);function Cf(e){var t=new dc.o;if(t.include(dc.F,!1),t.fragment.code.add((0,dc.n)(z||(z=(0,wu.Z)(["float remap(float x, float low1, float high1, float low2, float high2) {\nreturn low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n}"])))),e.mode===gf.Full){t.fragment.code.add((0,dc.n)(U||(U=(0,wu.Z)(["\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    // Safer modulo for positive and negative values\n    vec3 modulo(vec3 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec3 hash(vec3 p3, float frequency){\n      p3 = modulo(p3, frequency);\n      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yxz + 33.33);\n      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);\n    }\n\n    // 5th order polynomial interpolation\n    vec3 fade(vec3 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec3 p, float frequency){\n      // Cell point is in\n      vec3 i = floor(p);\n\n      // Position in the cell in [0, 1]\n      vec3 f = fract(p);\n\n      // Interpolation value for gradient mixing\n      vec3 u = fade(f);\n\n      // Trilinear interpolation of gradients at cube vertices around point\n      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),\n                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),\n                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),\n                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),\n                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      float octaveFrequencyFactor = 2.0;\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * gradientNoise(p, frequency);\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv) {\n      vec2 tile = floor(uv);\n      float z = floor("," * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPointPerlinWorley(vec3 p) {\n      float perlinNoise = getPerlinNoise(p, ",");\n\n      float worley0 = worley(p, "," * 2.0);\n      float worley1 = worley(p, "," * 8.0);\n      float worley2 = worley(p, "," * 14.0);\n\n      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n    }\n\n    float getTextureForPointWorley(vec3 p) {\n      float worley0 = worley(p, ",");\n      float worley1 = worley(p, "," * 2.0);\n      float worley2 = worley(p, "," * 4.0);\n      float worley3 = worley(p, "," * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "])),dc.n.float(df),dc.n.float(8),dc.n.float(2),dc.n.float(2),dc.n.float(2),dc.n.float(2),dc.n.float(2),dc.n.float(2),dc.n.float(2)))}return t.fragment.uniforms.add(new dc.b("weatherTile",(function(e){return e.weatherTile}))),t.fragment.code.add((0,dc.n)(V||(V=(0,wu.Z)(["\n    vec2 modulo(vec2 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec2 hash(vec2 p){\n      // Get position of p in weather tile\n      p = modulo(p, ",");\n\n      // Get global coordinates of p\n      p += weatherTile * ",";\n\n      // Limit position to avoid numerical instability\n      p = modulo(p, ",");\n\n      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;\n    }\n\n    vec2 fade(vec2 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec2 p){\n      vec2 i = floor( p );\n      vec2 f = fract( p );\n\n      vec2 u = fade(f);\n\n      // Bilinear interpolation of gradients at cell vertices around point\n      return  mix(\n                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),\n                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),\n                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),\n                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),\n                u.y);\n    }\n\n    float worley(vec2 p){\n      float d = 1.0e10;\n      for (int x = -1; x <= 1; x++){\n        for (int y = -1; y <= 1; y++){\n                vec2 tp = floor(p) + vec2(x, y);\n                tp = p - tp - (0.5 + 0.5 * hash(tp));\n                d = min(d, dot(tp, tp));\n            }\n        }\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n  "])),dc.n.float(128),dc.n.float(128),dc.n.float(1e5))),t.fragment.code.add((0,dc.n)(B||(B=(0,wu.Z)(["void main() {"])))),e.mode===gf.Full&&t.fragment.code.add((0,dc.n)(G||(G=(0,wu.Z)(["\n        float padWidth = 1.0;\n        float paddedSize = "," + 2.0 * padWidth;\n        float tileCount = "," * ",";\n        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n        bool padCell = false;\n        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        bool startPadX = false;\n        bool startPadY = false;\n        bool endPadX = false;\n        bool endPadY = false;\n\n        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n          startPadX = true;\n        }\n\n        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n          startPadY = true;\n        }\n\n        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n          endPadX = true;\n        }\n\n        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n          endPadY = true;\n        }\n\n        vec2 padding = vec2(2.0 * padWidth) * tile;\n        vec2 uv;\n\n        if (padCell) {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n          if (startPadX) {\n            pixel.x += ",";\n          }\n\n          if (startPadY) {\n            pixel.y += ",";\n          }\n\n          if (endPadX) {\n            pixel.x -= ",";\n          }\n\n          if (endPadY) {\n            pixel.y -= ",";\n          }\n\n          uv = vec2(pixel.xy / ",");\n        } else {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n          uv = vec2(pixel.xy / ",");\n        }\n\n        vec3 p_ = get3Dfrom2D(uv);\n        vec3 p = p_;\n        p.z /= ("," * ",");\n\n        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        float worleyNoise = getTextureForPointWorley(p);\n\n        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n        p_ = mod(p_ + 1.0, "," * ",");\n        p = p_;\n        p.z /= ("," * ",");\n\n        worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        worleyNoise = getTextureForPointWorley(p);\n\n        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n      "])),dc.n.float(cf),dc.n.float(df),dc.n.float(df),dc.n.float(cf),dc.n.float(cf),dc.n.float(cf),dc.n.float(cf),dc.n.float(cf),dc.n.float(cf),dc.n.float(df),dc.n.float(df),dc.n.float(df),dc.n.float(df),dc.n.float(df),dc.n.float(df))),t.fragment.code.add((0,dc.n)(H||(H=(0,wu.Z)(["\n      vec2 mapUV = "," * (gl_FragCoord.xy / ",");\n      float map = abs(gradientNoise(mapUV));\n      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);\n\n      ",";\n    }\n  "])),dc.n.float(128),dc.n.float(ff),e.mode===gf.Full?(0,dc.n)(j||(j=(0,wu.Z)(["gl_FragColor.ba = vec2(0.0, map);"]))):(0,dc.n)(q||(q=(0,wu.Z)(["gl_FragColor = vec4(map);"]))))),t}var Sf=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Tf,build:Cf},Symbol.toStringTag,{value:"Module"})),Of=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:this.configuration.mode===gf.Full?(0,vc.s)(pc.R.ONE,pc.R.ZERO):(0,vc.l)(pc.R.ZERO,pc.R.ONE,pc.R.ONE,pc.R.ZERO),depthTest:{func:pc.I.ALWAYS},colorWrite:vc._})}}]),r}(dc.k);Of.shader=new dc.m(Sf,(function(){return r.e(6718).then(r.bind(r,96718))}));var Pf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._needsRender=!0,n._passParameters=new Tf,n._frameBuffer=new _c.x(e.context.renderContext.rctx,{colorTarget:pc.Y.TEXTURE,width:ff,height:ff},{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,hasMipmap:!1,width:ff,height:ff}),n._vao=(0,dc.u)(e.context.renderContext.rctx),n}return(0,ku.Z)(r,[{key:"_techniqueRepository",get:function(){return this.context.shaderTechniqueRepository}},{key:"textureAtlas",get:function(){return(0,Nu.r)(this._texture)?(0,Nu.r)(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(gf.WeatherMap)):(0,Nu.r)(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(gf.Full)),this._texture}},{key:"_setDirty",value:function(){this._needsRender=!0}},{key:"updateWeatherMap",value:function(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||((0,uc.a)(this._passParameters.weatherTile,e),this._setDirty())}},{key:"destroy",value:function(){this._fullTechniqueCached=(0,Nu.F)(this._fullTechniqueCached),this._weatherMapTechniqueCached=(0,Nu.F)(this._weatherMapTechniqueCached),this._frameBuffer=(0,Nu.G)(this._frameBuffer),this._vao=(0,Nu.G)(this._vao)}},{key:"_fullTechnique",get:function(){if((0,Nu.t)(this._fullTechniqueCached)){var e=new wf;e.mode=gf.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Of,e)}return this._fullTechniqueCached}},{key:"_weatherMapTechnique",get:function(){if((0,Nu.t)(this._weatherMapTechniqueCached)){var e=new wf;e.mode=gf.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Of,e)}return this._weatherMapTechniqueCached}},{key:"_render",value:function(e){if((0,Nu.t)(this._vao)||(0,Nu.t)(this._frameBuffer))return null;var t=e===gf.Full?this._fullTechnique:this._weatherMapTechnique,r=this.context.renderContext.rctx,n=r.getViewport();r.setViewport(0,0,ff,ff),r.bindFramebuffer(this._frameBuffer);var i=r.bindTechnique(t,this._passParameters,null);return r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.setViewport(n.x,n.y,n.width,n.height),this._needsRender=!1,this._frameBuffer.colorTexture}}]),r}(Eu.m);function Rf(e){e.include(dc.j),e.uniforms.add([new dc.h("geometryDepthTexture",(function(e,t){return t.multipassGeometry.linearDepthTexture})),new dc.b("nearFar",(function(e,t){return t.camera.nearFar}))]),e.code.add((0,dc.n)(W||(W=(0,wu.Z)(["bool geometryDepthTest(vec2 pos, float elementDepth) {\nfloat geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);\nreturn (elementDepth < (geometryDepth - 1.0));\n}"]))))}(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Pf.prototype,"context",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Pf.prototype,"_techniqueRepository",null),Pf=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.NoiseTextureAtlas")],Pf);var Af=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.enabled=!1}));function kf(e,t){var r=e.fragment;r.include(dc.j),r.uniforms.add(new dc.b("nearFar",(function(e,t){return t.camera.nearFar}))),r.uniforms.add(new dc.h("depthMap",(function(e,t){return t.linearDepthTexture}))),r.uniforms.add(new dc.e("proj",(function(e,t){return t.ssr.camera.projectionMatrix}))),r.uniforms.add(new dc.g("invResolutionHeight",(function(e,t){return 1/t.ssr.camera.height}))),r.uniforms.add(new dc.e("reprojectionMatrix",(function(e,t){return t.ssr.reprojectionMatrix}))),r.code.add((0,dc.n)(X||(X=(0,wu.Z)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy * 0.5 + 0.5;\n  }\n\n  const int maxSteps = ",";\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n        return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150":"75"))}var Ef=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.reprojectionMatrix=(0,hc.e)()})),Df=function(){function e(t,r,n){(0,Au.Z)(this,e),this.shadowMap=t,this.ssaoHelper=r,this.slicePlane=n,this.slot=dc.H.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this._inverseViewport=(0,cc.n)(),this.oldLighting=new dc.L,this.newLighting=new dc.L,this._fadedLighting=new dc.L,this._lighting=this.newLighting,this.ssr=new Ef,this.multipassTerrain=new dc.I,this.multipassGeometry=new Af,this.overlays=[],this.cloudsFade=new Xd}return(0,ku.Z)(e,[{key:"camera",get:function(){return this._camera},set:function(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}},{key:"inverseViewport",get:function(){return this._inverseViewport}},{key:"lighting",get:function(){return this._lighting}},{key:"weatherFading",get:function(){return this._lighting===this._fadedLighting}},{key:"fadeLighting",value:function(e){var t=this.oldLighting,r=this.newLighting;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(t,r,e),this._lighting=this._fadedLighting)}}]),e}(),Mf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).runOncePerFrame=!0,n._handles=new Eu.X,n._techniques=new Array,n._techniqueConfiguration=new of,n._bindParameters=new Df(null,null,null),n._passParameters=new vf,n._drawParameters=new mf,n._weatherTile=(0,cc.n)(),n._weatherTileCount=128,n._faceIndex=0,n._tileIndex=0,n.coverage=(0,Vu.Z)(uf.default.coverage[0],uf.default.coverage[1],.5),n.density=(0,Vu.Z)(uf.default.density[0],uf.default.density[1],.5),n.absorption=(0,Vu.Z)(uf.default.absorption[0],uf.default.absorption[1],.5),n.cloudSize=(0,Vu.Z)(uf.default.cloudSize[0],uf.default.cloudSize[1],.5),n.detailSize=(0,Vu.Z)(uf.default.detailSize[0],uf.default.detailSize[1],.5),n.smoothness=(0,Vu.Z)(uf.default.smoothness[0],uf.default.smoothness[1],.5),n.cloudHeight=(0,Vu.Z)(uf.default.cloudHeight[0],uf.default.cloudHeight[1],.5),n.raymarchingSteps=uf.default.raymarchingSteps,n._viewMatrix=(0,hc.e)(),n._dirty=!1,n.running=!1,n}return(0,ku.Z)(r,[{key:"_getTechnique",value:function(e){var t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,r=t===Bd.RG?2*e:2*e+1;return this._techniques[r]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[r]=new xf({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[r])}},{key:"updateWeatherTile",value:function(){var e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;(0,uc.r)(this._weatherTile,(e+90)/180,(t+180)/360);var r=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-r)*this._weatherTile[1]);var n=0,i=0;if((0,Nu.r)(this.view.environment)&&"virtual"!==this.view.environment.lighting.type&&(0,Nu.r)(this.view.environment.lighting.date)){var a=new Date(this.view.environment.lighting.date);a.setUTCHours(this.view.environment.lighting.date.getUTCHours()+this.view.environment.lighting.displayUTCOffset),n=31*a.getUTCMonth()+a.getUTCDate(),i=a.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+n)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+i%100)%(4*this._weatherTileCount),(0,uc.k)(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}},{key:"initialize",value:function(){var e=this;this._vao=(0,dc.u)(this.context.renderContext.rctx);var t=(0,Xu.u)(this.view.spatialReference);this._passParameters.cloudRadius=.5*t.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(bc.I.CLOUDS_GENERATOR,this),(0,Fu.l)((function(){return[e.coverage,e.density,e.absorption,e.cloudSize,e.detailSize,e.smoothness,e.cloudHeight,e.raymarchingSteps]}),(function(){return e.setDirty()}),Fu.h)])}},{key:"destroy",value:function(){this._handles.destroy(),this._techniques.forEach((function(e){return(0,Nu.F)(e)})),this._frameBufferCube=(0,Nu.G)(this._frameBufferCube),this._techniques.length=0,this._vao=(0,Nu.G)(this._vao),this._passParameters.noiseTexture=(0,Nu.g)(this._passParameters.noiseTexture)}},{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case nf.SIXTEEN:return 1;case nf.HUNDRED:return 4;case nf.COUNT:case nf.TWOHUNDRED:return 8}}},{key:"_ensureNoiseTexture",value:function(){if((0,Nu.r)(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{var e=this.context;this._passParameters.noiseTexture=new Pf({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return(0,Nu.r)(this._passParameters.noiseTexture.textureAtlas)}},{key:"_ensureFrameBufferCube",value:function(e){if((0,Nu.t)(this._frameBufferCube)){var t={target:pc.M.TEXTURE_CUBE_MAP,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new _c.x(this.context.renderContext.rctx,{colorTarget:pc.Y.CUBEMAP,width:e,height:e},t)}return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}},{key:"destroyFrameBufferCube",value:function(){this._frameBufferCube=(0,Nu.G)(this._frameBufferCube)}},{key:"applyPreset",value:function(e,t){var r=e.median,n=function(e){var n=(0,Vu.Z)(e[0],e[1],r);return t<.5?(0,Vu.Z)(e[0],n,2*t):(0,Vu.Z)(n,e[1],2*(t-.5))};this.coverage=n(e.coverage),this.density=n(e.density),this.absorption=n(e.absorption),this.cloudSize=n(e.cloudSize),this.detailSize=n(e.detailSize),this.smoothness=n(e.smoothness),this.cloudHeight=n(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}},{key:"setDirty",value:function(){this._dirty=this.running=!0}},{key:"runTask",value:function(e){if((0,Nu.t)(this._vao))return this._dirty=this.running=!1,void(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Vd.FINISHED_RENDERING);0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),(0,uc.a)(this._passParameters.weatherTile,this._weatherTile));var t=this._getTechnique(this._passParameters.raymarchingSteps);if(t.compiled&&this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal&&!this.context.renderContext.bindParameters.cloudsFade.isFading&&this._ensureNoiseTexture()){0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Vd.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);var r=this.context.renderContext.rctx,n=r.bindTechnique(t,this._passParameters,this._bindParameters);r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao);var i=r.getViewport(),a=t.configuration.cubeMapSize,o=a/this._tilesPerFace,s=this._tileIndex*o;r.setViewport(0,s,a,o);var l=this._ensureFrameBufferCube(a);r.bindFramebuffer(l);var u=If[this._faceIndex],c=Lf[this._faceIndex];(0,Wu.k)(this._viewMatrix,Zf,u,c),(0,mc.a)(this._drawParameters.viewMatrix,this._viewMatrix);var h=pc.M.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;l.setColorTextureTarget(h),n.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush(),r.setViewport(i.x,i.y,i.width,i.height),this.requestRender(),e.madeProgress(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Vd.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0)}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Mf.prototype,"context",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Mf.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Mf.prototype,"requestRender",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"coverage",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"density",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"absorption",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"cloudSize",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"detailSize",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"smoothness",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"cloudHeight",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"raymarchingSteps",void 0),(0,Eu.e)([(0,Eu.y)()],Mf.prototype,"running",void 0),Mf=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.CloudsGenerator")],Mf);var If=[(0,yc.r)(1,0,0),(0,yc.r)(-1,0,0),(0,yc.r)(0,1,0),(0,yc.r)(0,-1,0),(0,yc.r)(0,0,1)],Lf=[(0,yc.r)(0,1,0),(0,yc.r)(0,1,0),(0,yc.r)(0,0,-1),(0,yc.r)(0,0,1),(0,yc.r)(0,1,0)],Zf=(0,yc.a)(),Nf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).fogColor=(0,Vu.n)(),e.hazeColor=(0,Vu.n)(),e.fogStrength=4e-6,e.hazeStrength=4e-6,e.atmosphereC=1,e}return(0,ku.Z)(r)}(dc.t);function Ff(e){var t=new dc.o;t.attributes.add(fc.O.POSITION,"vec2"),t.include(dc.a,{textureCoordinateType:dc.d.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");var r=t.vertex,n=t.fragment;return r.uniforms.add([new dc.e("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new dc.e("inverseViewMatrix",(function(e,t){return(0,Wu.h)(zf,t.camera.viewMatrix)}))]),r.code.add((0,dc.n)(Y||(Y=(0,wu.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),n.uniforms.add(new dc.g("atmosphereC",(function(e){return e.atmosphereC}))),n.uniforms.add(new dc.c("cameraPosition",(function(e,t){return t.camera.eye}))),n.uniforms.add(new dc.b("nearFar",(function(e,t){return t.camera.nearFar}))),n.uniforms.add(new dc.h("depthTex",(function(e){return e.depthTexture}))),n.uniforms.add(new dc.g("fogStrength",(function(t){return e.haze?t.hazeStrength:t.fogStrength}))),n.uniforms.add(new dc.g("fogAmount",(function(t){return e.haze?t.hazeAmount:t.fogAmount}))),n.uniforms.add(new dc.c("fogColor",(function(t){return e.haze?t.hazeColor:t.fogColor}))),t.include(Ed),n.include(dc.j),n.code.add((0,dc.n)(Q||(Q=(0,wu.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat d = (b * b) - 4.0 * a * atmosphereC;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),n.code.add((0,dc.n)(K||(K=(0,wu.Z)(["vec4 applyFog(float dist, vec3 rayDir){\nif(dist == -1.0){\nvec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);\ndist = 0.055 * rayAtmosphereIntersect.y;\n}\nfloat fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));\nreturn vec4(fogAmount * fogColor, fogAmount);\n}"])))),n.code.add((0,dc.n)(J||(J=(0,wu.Z)(["\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n\n      float depthSample = texture2D(depthTex, vuv0).r;\n      float zNorm = 2.0 * depthSample - 1.0;\n      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));\n      if(depthSample < 1.0 && depthSample > 0.0){\n        vec3 cameraSpaceRay = normalize(eyeDir);\n        cameraSpaceRay /= cameraSpaceRay.z;\n        cameraSpaceRay *= linDepth;\n        terrainDepth = max(0.0, length(cameraSpaceRay));\n      }\n\n      ","\n\n      vec4 fog = applyFog(terrainDepth, rayDir);\n\n      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));\n    }\n  "])),e.haze?(0,dc.n)($||($=(0,wu.Z)(["\n          if(terrainDepth == -1.0){\n            gl_FragColor = vec4(0);\n            return;\n          }"]))):"")),t}var zf=(0,hc.e)(),Uf=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:Nf,build:Ff},Symbol.toStringTag,{value:"Module"})),Vf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return this.configuration.haze?(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ZERO,pc.R.ONE_MINUS_SRC_COLOR,pc.R.ONE),colorWrite:vc._}):(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ZERO,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE),colorWrite:vc._})}}]),r}(dc.k);Vf.shader=new dc.m(Uf,(function(){return r.e(4743).then(r.bind(r,4743))}));var Bf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).haze=!1,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)()],Bf.prototype,"haze",void 0);var Gf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;(0,Au.Z)(this,r),(n=t.call(this,e))._passParameters=new Nf;var i=e.context.renderContext.rctx;n._vao=(0,dc.u)(i,dc.A);var a=(0,Xu.u)(e.view.spatialReference);return n._planetRadius=a.radius,n._atmosphereRadius=a.radius+kd,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._thickFogTechniqueCached=(0,Nu.F)(this._thickFogTechniqueCached),this._vao=(0,Nu.G)(this._vao)}},{key:"_shaderTechniqueRepository",get:function(){return this.context.shaderTechniqueRepository}},{key:"strength",get:function(){return this._passParameters.fogStrength},set:function(e){this._passParameters.fogStrength=e}},{key:"_thickFogTechnique",get:function(){if((0,Nu.t)(this._thickFogTechniqueCached)){var e=new Bf;e.haze=!1,this._thickFogTechniqueCached=this._shaderTechniqueRepository.acquire(Vf,e)}return this._thickFogTechniqueCached}},{key:"render",value:function(e,t){var r=this;if(this._update(e,t),!(this._passParameters.fogAmount<=0)){var n=this._thickFogTechnique;if(n.compiled){var i=e.offscreenRenderingHelper;i.renderDepthDetached((function(){r._passParameters.depthTexture=i.depthTexture;var t=e.rctx.bindTechnique(n,r._passParameters,e.bindParameters);r._renderFog(t,e)}))}else this.context.requestRender()}}},{key:"_renderFog",value:function(e,t){if(!(0,Nu.t)(this._vao)){var r=t.rctx;r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(pc.E.TRIANGLE_STRIP,0,4)}}},{key:"_update",value:function(e,t){var r=e.bindParameters.camera;(0,Vu.z)(qf,r.eye);var n=Math.max(0,(0,Vu.P)(qf,e.bindParameters.lighting.mainLight.direction)),i=t.color;(0,Vu.g)(Wf,i,.1),(0,Vu.A)(this._passParameters.fogColor,Wf,i,n);var a=(0,Vu.s)(r.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-(0,Vu.$)(.95*qu.e,1*qu.e,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}}],[{key:"isSupported",value:function(e){return e.capabilities.depthTexture}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Gf.prototype,"context",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Gf.prototype,"view",void 0),Gf=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.Fog")],Gf);var Hf,jf=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.color=(0,Vu.n)(),this.strength=0,this.amount=0})),qf=(0,Vu.n)(),Wf=(0,Vu.n)();!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(Hf||(Hf={}));var Xf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).geometry=Hf.Cone,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:Hf.COUNT})],Xf.prototype,"geometry",void 0);var Yf=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).texV=(0,cc.n)(),e.altitudeFade=0,e.innerScale=0,e.undergroundFadeAlpha=0,e.silhouette=new Qf,e}return(0,ku.Z)(r)}(dc.t),Qf=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.center=(0,Vu.n)(),this.v1=(0,Vu.n)(),this.v2=(0,Vu.n)()}));function Kf(e){var t=new dc.o,r=t.vertex,n=t.fragment;if((0,dc.i)(r),e.geometry===Hf.Underground)t.attributes.add(fc.O.POSITION,"vec2"),t.varyings.add("color","vec4"),r.uniforms.add([new dc.c("cameraPosition",(function(e,t){return t.camera.eye})),new dc.g("undergroundFadeAlpha",(function(e){return e.undergroundFadeAlpha}))]),r.code.add((0,dc.n)(ee||(ee=(0,wu.Z)(["void main(void) {\nfloat ndotl = dot(normalize(cameraPosition), mainLightDirection);\nfloat lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\ncolor = vec4(vec3(lighting), undergroundFadeAlpha);\ngl_Position = vec4(position.xy, 1.0, 1.0);\n}"])))),n.code.add((0,dc.n)(te||(te=(0,wu.Z)(["void main() {\ngl_FragColor = color;\n}"]))));else{t.include(dc.K,e),t.attributes.add(fc.O.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");var i=e.geometry===Hf.Cylinder;r.uniforms.add([new dc.e("proj",(function(e,t){return t.camera.projectionMatrix})),new dc.e("view",(function(e,t){return t.camera.viewMatrix}))]),i||(t.varyings.add("innerFactor","float"),r.uniforms.add(new dc.c("silCircleCenter",(function(e){return e.silhouette.center}))),r.uniforms.add(new dc.c("silCircleV1",(function(e){return e.silhouette.v1}))),r.uniforms.add(new dc.c("silCircleV2",(function(e){return e.silhouette.v2}))),r.uniforms.add(new dc.b("texV",(function(e){return e.texV}))),r.uniforms.add(new dc.g("innerScale",(function(e){return e.innerScale}))));var a=1/128;r.code.add((0,dc.n)(re||(re=(0,wu.Z)(["\n\t\tvoid main(void) {\n      ","\n      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\n\n\t\t  gl_Position = transformPosition(proj, view, pos);\n\t\t  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane\n    }\n\t  "])),i?(0,dc.n)(ne||(ne=(0,wu.Z)(["\n      vec3 pos = position;\n      float ndotl = mainLightDirection.z;\n      vtc = vec2(0.0, position.z + 0.05);"]))):(0,dc.n)(ie||(ie=(0,wu.Z)(["\n      innerFactor = clamp(-position.z, 0.0, 1.0);\n      float scale = position.y * (1.0 + innerFactor * innerScale);\n      float phi = position.x * "," + 1.0;\n      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;\n      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);\n      vtc.x = position.x  * ",";\n      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;\n      "])),dc.n.float(6.2831853*a),dc.n.float(a)))),n.uniforms.add(new dc.h("tex",(function(e){return e.texture}))),i||n.uniforms.add(new dc.g("altitudeFade",(function(e){return e.altitudeFade}))),n.code.add((0,dc.n)(ae||(ae=(0,wu.Z)(["\n\t\tvoid main() {\n\t\t\tvec4 atmosphereColor = texture2D(tex, vtc) * falloff;\n      ","\n    }"])),i?(0,dc.n)(oe||(oe=(0,wu.Z)(["gl_FragColor = atmosphereColor;"]))):(0,dc.n)(se||(se=(0,wu.Z)(["\n\t\t\tvec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);\n\t\t\tgl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));\n      "])))))}return t}var Jf=Object.freeze(Object.defineProperty({__proto__:null,SimpleAtmospherePassParameters:Yf,SilhouetteCircle:Qf,build:Kf},Symbol.toStringTag,{value:"Module"})),$f=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return this.configuration.geometry===Hf.Cylinder?(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),culling:vc.r,depthTest:{func:pc.I.LEQUAL},colorWrite:vc._}):(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);$f.shader=new dc.m(Jf,(function(){return r.e(6943).then(r.bind(r,26943))}));var ep,tp=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);!function(e){e.length=function(e,t){var r=e[t],n=e[t+1],i=e[t+2];return Math.sqrt(r*r+n*n+i*i)},e.normalize=function(e,t){var r=e[t],n=e[t+1],i=e[t+2],a=1/Math.sqrt(r*r+n*n+i*i);e[t]*=a,e[t+1]*=a,e[t+2]*=a},e.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},e.add=function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(i=i||e)[a]=e[t]+r[n],i[a+1]=e[t+1]+r[n+1],i[a+2]=e[t+2]+r[n+2]},e.subtract=function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(i=i||e)[a]=e[t]-r[n],i[a+1]=e[t+1]-r[n+1],i[a+2]=e[t+2]-r[n+2]}}(ep||(ep={}));var rp,np,ip,ap=ep;!function(e){for(var t=.5,r=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],n=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i=[0,0,1,0,1,1,0,1],a=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],o=new Array(36),s=0;s<6;s++)for(var l=0;l<6;l++)o[6*s+l]=s;for(var u=new Array(36),c=0;c<6;c++)u[6*c+0]=0,u[6*c+1]=1,u[6*c+2]=2,u[6*c+3]=2,u[6*c+4]=3,u[6*c+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(24),s=0;s<8;s++)t[3*s]=r[s][0]*e[0],t[3*s+1]=r[s][1]*e[1],t[3*s+2]=r[s][2]*e[2];return new dc.M([[fc.O.POSITION,{size:3,data:t,exclusive:!0}],[fc.O.NORMAL,{size:3,data:n}],[fc.O.UV0,{size:2,data:i}]],[[fc.O.POSITION,a],[fc.O.NORMAL,o],[fc.O.UV0,u]])}}(rp||(rp={})),function(e){var t=.5,r=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],n=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],i=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],a=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(18),o=0;o<6;o++)t[3*o]=r[o][0]*e[0],t[3*o+1]=r[o][1]*e[1],t[3*o+2]=r[o][2]*e[2];return new dc.M([[fc.O.POSITION,{size:3,data:t,exclusive:!0}],[fc.O.NORMAL,{size:3,data:n}]],[[fc.O.POSITION,i],[fc.O.NORMAL,a]])}}(np||(np={})),function(e){var t=.5,r=(0,yc.r)(-t,0,-t),n=(0,yc.r)(t,0,-t),i=(0,yc.r)(0,0,t),a=(0,yc.r)(0,.5,0),o=(0,yc.n)(),s=(0,yc.n)(),l=(0,yc.n)(),u=(0,yc.n)(),c=(0,yc.n)();(0,Vu.e)(o,r,a),(0,Vu.e)(s,r,n),(0,Vu._)(l,o,s),(0,Vu.z)(l,l),(0,Vu.e)(o,n,a),(0,Vu.e)(s,n,i),(0,Vu._)(u,o,s),(0,Vu.z)(u,u),(0,Vu.e)(o,i,a),(0,Vu.e)(s,i,r),(0,Vu._)(c,o,s),(0,Vu.z)(c,c);var h=[r,n,i,a],d=[0,-1,0,l[0],l[1],l[2],u[0],u[1],u[2],c[0],c[1],c[2]],f=[0,1,2,3,1,0,3,2,1,3,0,2],p=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(12),r=0;r<4;r++)t[3*r]=h[r][0]*e[0],t[3*r+1]=h[r][1]*e[1],t[3*r+2]=h[r][2]*e[2];return new dc.M([[fc.O.POSITION,{size:3,data:t,exclusive:!0}],[fc.O.NORMAL,{size:3,data:d}]],[[fc.O.POSITION,f],[fc.O.NORMAL,p]])}}(ip||(ip={}));var op=rp.createGeometry,sp=np.createGeometry,lp=ip.createGeometry;function up(e,t,r){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{uv:!0},i=-Math.PI,a=2*Math.PI,o=-Math.PI/2,s=Math.PI,l=Math.max(3,Math.floor(t)),u=Math.max(2,Math.floor(r)),c=(l+1)*(u+1),h=new Float32Array(3*c),d=new Float32Array(3*c),f=new Float32Array(2*c),p=[],v=0,m=0;m<=u;m++){for(var y=[],g=m/u,_=o+g*s,b=Math.cos(_),x=0;x<=l;x++){var w=x/l,T=i+w*a,C=Math.cos(T)*b,S=Math.sin(_),O=-Math.sin(T)*b;h[3*v]=C*e,h[3*v+1]=S*e,h[3*v+2]=O*e,d[3*v]=C,d[3*v+1]=S,d[3*v+2]=O,f[2*v]=w,f[2*v+1]=g,y.push(v),++v}p.push(y)}for(var P=new Array,R=0;R<u;R++)for(var A=0;A<l;A++){var k=p[R][A],E=p[R][A+1],D=p[R+1][A+1],M=p[R+1][A];0===R?(P.push(k),P.push(D),P.push(M)):R===u-1?(P.push(k),P.push(E),P.push(D)):(P.push(k),P.push(E),P.push(D),P.push(D),P.push(M),P.push(k))}var I=[[fc.O.POSITION,P],[fc.O.NORMAL,P]],L=[[fc.O.POSITION,{size:3,data:h,exclusive:!0}],[fc.O.NORMAL,{size:3,data:d,exclusive:!0}]];return n.uv&&(L.push([fc.O.UV0,{size:2,data:f,exclusive:!0}]),I.push([fc.O.UV0,P])),n.offset&&(I[0][0]=fc.O.OFFSET,L[0][0]=fc.O.OFFSET,I.push([fc.O.POSITION,new Array(P.length).fill(0)]),L.push([fc.O.POSITION,{size:3,data:Float64Array.from(n.offset),exclusive:!0}])),new dc.M(L,I)}function cp(e,t,r){var n,i,a=e;if(r)n=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],i=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{var o=a*(1+Math.sqrt(5))/2;n=[-a,o,0,a,o,0,-a,-o,0,a,-o,0,0,-a,o,0,a,o,0,-a,-o,0,a,-o,o,0,-a,o,0,a,-o,0,-a,-o,0,a],i=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(var s=0;s<n.length;s+=3)ap.scale(n,s,e/ap.length(n,s));var l={};function u(t,r){var i;t>r&&(t=(i=[r,t])[0],r=i[1]);var a=t.toString()+"."+r.toString();if(l[a])return l[a];var o=n.length;return n.length+=3,ap.add(n,3*t,n,3*r,n,o),ap.scale(n,o,e/ap.length(n,o)),o/=3,l[a]=o,o}for(var c=0;c<t;c++){for(var h=i.length,d=new Array(4*h),f=0;f<h;f+=3){var p=i[f],v=i[f+1],m=i[f+2],y=u(p,v),g=u(v,m),_=u(m,p),b=4*f;d[b]=p,d[b+1]=y,d[b+2]=_,d[b+3]=v,d[b+4]=g,d[b+5]=y,d[b+6]=m,d[b+7]=_,d[b+8]=g,d[b+9]=y,d[b+10]=g,d[b+11]=_}i=d,l={}}for(var x=new Float32Array(n),w=0;w<x.length;w+=3)ap.normalize(x,w);var T=[[fc.O.POSITION,i],[fc.O.NORMAL,i]],C=[[fc.O.POSITION,{size:3,data:new Float32Array(n),exclusive:!0}],[fc.O.NORMAL,{size:3,data:x,exclusive:!0}]];return new dc.M(C,T)}function hp(e,t,r,n,i,a,o,s){var l=t?[t[0],t[1],t[2]]:[0,0,0],u=e?[e[0],e[1],e[2]]:[0,0,1];a=a||[0,0];var c=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],h=null!=n&&2===n.length?n:[1,1],d=[[fc.O.POSITION,{size:3,data:l,exclusive:!0}],[fc.O.NORMAL,{size:3,data:u,exclusive:!0}],[fc.O.UV0,{size:a.length,data:a}],[fc.O.COLOR,{size:4,data:c,exclusive:!0}],[fc.O.SIZE,{size:2,data:h}]];if(null!=i){var f=new Float32Array([i[0],i[1],i[2],i[3]]);d.push([fc.O.AUXPOS1,{size:4,data:f}])}if(null!=o){var p=new Float32Array([o[0],o[1],o[2],o[3]]);d.push([fc.O.AUXPOS2,{size:4,data:p}])}return new dc.M(d,null,vc.a.Point,s)}var dp=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function fp(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp,t=new Array(12),r=0;r<4;r++)for(var n=0;n<3;n++)t[3*r+n]=e[r][n];var i=[0,1,2,2,3,0],a=[0,0,1],o=[0,0,0,0,0,0],s=[0,0,1,0,1,1,0,1],l=[255,255,255,255],u=[[fc.O.POSITION,i],[fc.O.NORMAL,o],[fc.O.UV0,i],[fc.O.COLOR,o]],c=[[fc.O.POSITION,{size:3,data:t,exclusive:!0}],[fc.O.NORMAL,{size:3,data:a,exclusive:!0}],[fc.O.UV0,{size:2,data:s,exclusive:!0}],[fc.O.COLOR,{size:4,data:l,exclusive:!0}]];return new dc.M(c,u)}function pp(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=0,s=t,l=e,u=(0,yc.r)(0,o,0),c=(0,yc.r)(0,o+l,0),h=(0,yc.r)(0,-1,0),d=(0,yc.r)(0,1,0);n&&(o=l,c=(0,yc.r)(0,0,0),u=(0,yc.r)(0,o,0),h=(0,yc.r)(0,1,0),d=(0,yc.r)(0,-1,0));var f=[c,u],p=[h,d],v=r+2,m=Math.sqrt(l*l+s*s);if(n)for(var y=r-1;y>=0;y--){var g=y*(2*Math.PI/r),_=(0,yc.r)(Math.cos(g)*s,o,Math.sin(g)*s);f.push(_);var b=(0,yc.r)(l*Math.cos(g)/m,-s/m,l*Math.sin(g)/m);p.push(b)}else for(var x=0;x<r;x++){var w=x*(2*Math.PI/r),T=(0,yc.r)(Math.cos(w)*s,o,Math.sin(w)*s);f.push(T);var C=(0,yc.r)(l*Math.cos(w)/m,s/m,l*Math.sin(w)/m);p.push(C)}var S=new Array,O=new Array;if(i){for(var P=3;P<f.length;P++)S.push(1),S.push(P-1),S.push(P),O.push(0),O.push(0),O.push(0);S.push(f.length-1),S.push(2),S.push(1),O.push(0),O.push(0),O.push(0)}if(a){for(var R=3;R<f.length;R++)S.push(R),S.push(R-1),S.push(0),O.push(R),O.push(R-1),O.push(1);S.push(0),S.push(2),S.push(f.length-1),O.push(1),O.push(2),O.push(p.length-1)}for(var A=new Float32Array(3*v),k=0;k<v;k++)A[3*k]=f[k][0],A[3*k+1]=f[k][1],A[3*k+2]=f[k][2];for(var E=new Float32Array(3*v),D=0;D<v;D++)E[3*D]=p[D][0],E[3*D+1]=p[D][1],E[3*D+2]=p[D][2];var M=[[fc.O.POSITION,S],[fc.O.NORMAL,O]],I=[[fc.O.POSITION,{size:3,data:A,exclusive:!0}],[fc.O.NORMAL,{size:3,data:E,exclusive:!0}]];return new dc.M(I,M)}function vp(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:(0,yc.r)(0,0,0),o=e.length,s=new Float32Array(t.length*o*3+(6*r.length||0)),l=new Float32Array(t.length*o*3+(r?6:0)),u=new Array,c=new Array,h=0,d=0,f=(0,yc.n)(),p=(0,yc.n)(),v=(0,yc.n)(),m=(0,yc.n)(),y=(0,yc.n)(),g=(0,yc.n)(),_=(0,yc.n)(),b=(0,Vu.n)(),x=(0,yc.n)(),w=(0,yc.n)(),T=(0,yc.n)(),C=(0,yc.n)(),S=(0,yc.n)(),O=(0,Tc.p)();(0,Vu.o)(x,0,1,0),(0,Vu.e)(p,t[1],t[0]),(0,Vu.z)(p,p),i?((0,Vu.u)(b,t[0],a),(0,Vu.z)(v,b)):(0,Vu.o)(v,0,0,1),bp(p,v,x,x,y,v,xp),(0,Vu.r)(m,v),(0,Vu.r)(C,y);for(var P=0;P<r.length;P++)(0,Vu.g)(g,y,r[P][0]),(0,Vu.g)(b,v,r[P][2]),(0,Vu.u)(g,g,b),(0,Vu.u)(g,g,t[0]),s[h++]=g[0],s[h++]=g[1],s[h++]=g[2];l[d++]=-p[0],l[d++]=-p[1],l[d++]=-p[2];for(var R=0;R<n.length;R++)u.push(n[R][0]>0?n[R][0]:-n[R][0]-1+r.length),u.push(n[R][1]>0?n[R][1]:-n[R][1]-1+r.length),u.push(n[R][2]>0?n[R][2]:-n[R][2]-1+r.length),c.push(0),c.push(0),c.push(0);for(var A=r.length,k=r.length-1,E=0;E<t.length;E++){var D=!1;E>0&&((0,Vu.r)(f,p),E<t.length-1?((0,Vu.e)(p,t[E+1],t[E]),(0,Vu.z)(p,p)):D=!0,(0,Vu.u)(w,f,p),(0,Vu.z)(w,w),(0,Vu.u)(T,t[E-1],m),(0,Tc._)(t[E],w,O),(0,Tc.q)(O,(0,Qu.p)(T,f),b)?((0,Vu.e)(b,b,t[E]),(0,Vu.z)(v,b),(0,Vu._)(y,w,v),(0,Vu.z)(y,y)):bp(w,m,C,x,y,v,xp),(0,Vu.r)(m,v),(0,Vu.r)(C,y)),i&&((0,Vu.u)(b,t[E],a),(0,Vu.z)(S,b));for(var M=0;M<o;M++)if((0,Vu.g)(g,y,e[M][0]),(0,Vu.g)(b,v,e[M][1]),(0,Vu.u)(g,g,b),(0,Vu.z)(_,g),l[d++]=_[0],l[d++]=_[1],l[d++]=_[2],(0,Vu.u)(g,g,t[E]),s[h++]=g[0],s[h++]=g[1],s[h++]=g[2],!D){var I=(M+1)%o;u.push(A+M),u.push(A+o+M),u.push(A+I),u.push(A+I),u.push(A+o+M),u.push(A+o+I);for(var L=0;L<6;L++){var Z=u.length-6;c.push(u[Z+L]-k)}}A+=o}for(var N=t[t.length-1],F=0;F<r.length;F++)(0,Vu.g)(g,y,r[F][0]),(0,Vu.g)(b,v,r[F][1]),(0,Vu.u)(g,g,b),(0,Vu.u)(g,g,N),s[h++]=g[0],s[h++]=g[1],s[h++]=g[2];var z=d/3;l[d++]=p[0],l[d++]=p[1],l[d++]=p[2];for(var U=A-o,V=0;V<n.length;V++)u.push(n[V][0]>=0?A+n[V][0]:-n[V][0]-1+U),u.push(n[V][2]>=0?A+n[V][2]:-n[V][2]-1+U),u.push(n[V][1]>=0?A+n[V][1]:-n[V][1]-1+U),c.push(z),c.push(z),c.push(z);var B=[[fc.O.POSITION,u],[fc.O.NORMAL,c]],G=[[fc.O.POSITION,{size:3,data:s,exclusive:!0}],[fc.O.NORMAL,{size:3,data:l,exclusive:!0}]];return new dc.M(G,B)}function mp(e,t,r){(0,Sc.e)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,Sc.e)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),(0,Sc.e)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),(0,Sc.e)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");for(var n=new Float64Array(3*e.length),i=new Array(2*(e.length-1)),a=0,o=0,s=0;s<e.length;s++){for(var l=0;l<3;l++)n[a++]=e[s][l];s>0&&(i[o++]=s-1,i[o++]=s)}var u=[],c=[];if(u.push([fc.O.POSITION,i]),c.push([fc.O.POSITION,{size:3,data:n,exclusive:!0}]),t){for(var h=new Float32Array(3*t.length),d=0,f=0;f<e.length;f++)for(var p=0;p<3;p++)h[d++]=t[f][p];u.push([fc.O.NORMAL,i]),c.push([fc.O.NORMAL,{size:3,data:h,exclusive:!0}])}return r&&(c.push([fc.O.COLOR,{size:4,data:r}]),u.push([fc.O.COLOR,(0,Cc.u)(r.length/4)])),new dc.M(c,u,vc.a.Line)}function yp(e,t,r,n){for(var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=new Array(18),o=[[-t,i,n/2],[r,i,n/2],[0,e+i,n/2],[-t,i,-n/2],[r,i,-n/2],[0,e+i,-n/2]],s=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],l=0;l<6;l++)a[3*l]=o[l][0],a[3*l+1]=o[l][1],a[3*l+2]=o[l][2];return new dc.M([[fc.O.POSITION,{size:3,data:a,exclusive:!0}]],[[fc.O.POSITION,s]])}function gp(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=e.vertexAttributes,n=r.get(fc.O.POSITION).data,i=r.get(fc.O.NORMAL).data;if(i)for(var a=t.getMutableAttribute(fc.O.NORMAL).data,o=0;o<i.length;o+=3){var s=i[o+1];a[o+1]=-i[o+2],a[o+2]=s}if(n)for(var l=t.getMutableAttribute(fc.O.POSITION).data,u=0;u<n.length;u+=3){var c=n[u+1];l[u+1]=-n[u+2],l[u+2]=c}return t}function _p(e,t,r,n,i){return!(Math.abs((0,Vu.P)(t,e))>i)&&((0,Vu._)(r,e,t),(0,Vu.z)(r,r),(0,Vu._)(n,r,e),(0,Vu.z)(n,n),!0)}function bp(e,t,r,n,i,a,o){return _p(e,t,i,a,o)||_p(e,r,i,a,o)||_p(e,n,i,a,o)}var xp=.99619469809,wp=function(){function e(){(0,Au.Z)(this,e),this.type=Od.Panoramic,this._configuration=new Xf,this._passParameters=new Yf}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._passParameters.texture=(0,Nu.G)(this._passParameters.texture),this._vao=(0,Nu.G)(this._vao)}},{key:"initializeRenderContext",value:function(e){this._configuration.geometry=Hf.Cylinder,this._technique=e.shaderTechniqueRepository.acquire($f,this._configuration);var t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=(0,_c.n)(this._vao,"geometry"),this._passParameters.texture=new Oc.E(t,{pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,flipped:!0,width:1,height:512},tp),e.requestRender()}},{key:"render",value:function(e){if(!(0,Nu.t)(this._vao)&&!(0,Nu.t)(this._passParameters.texture)){var t=e.rctx,r=t.bindTechnique(this._technique,this._passParameters,e.bindParameters);(function(e,t){(0,Wu.n)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1})(Cp,e.bindParameters.camera.viewMatrix),r.setUniformMatrix4fv("view",Cp),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(pc.E.TRIANGLES,0,this._vaoCount)}}},{key:"renderHaze",value:function(){return!1}},{key:"_createVertexArrayObject",value:function(e){for(var t=cp(1,2,!1),r=t.indices.get(fc.O.POSITION),n=0;n<r.length;n+=3){var i=r[n];r[n]=r[n+2],r[n+2]=i}for(var a=t.vertexAttributes.get(fc.O.POSITION).data,o=Sp.createBuffer(r.length),s=o.position,l=0;l<r.length;++l){var u=3*r[l];s.set(l,0,a[u]),s.set(l,1,a[u+1]),s.set(l,2,a[u+2])}return new dc.N(e,dc.E,{geometry:(0,xc.o)(Sp)},{geometry:_c.E.createVertex(e,pc.F.STATIC_DRAW,o.buffer)})}}]),e}();var Tp,Cp=(0,hc.e)(),Sp=(0,wc.T)().vec3f(fc.O.POSITION);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(Tp||(Tp={}));var Op=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).type=Tp.Rain,e}return(0,ku.Z)(r)}(dc.q);function Pp(e){var t=new dc.o;return t.attributes.add(fc.O.POSITION,"vec3"),t.attributes.add(fc.O.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new dc.c("cameraPosition",(function(e,t){return t.camera.eye}))),t.vertex.uniforms.add(new dc.c("offset",(function(e,t){return function(e,t){var r=t.camera.eye,n=.5*e.width,i=1/e.width,a=(0,Vu.a1)(Rp,(0,Vu.o)(Rp,(r[0]+n)*i,(r[1]+n)*i,(r[2]+n)*i));return(0,Vu.a0)(a,r,(0,Vu.g)(a,a,e.width))}(e,t)}))),t.vertex.uniforms.add(new dc.g("width",(function(e){return e.width}))),t.vertex.uniforms.add(new dc.e("proj",(function(e,t){return t.camera.projectionMatrix}))),t.vertex.uniforms.add(new dc.e("view",(function(e,t){return t.camera.viewMatrix}))),t.vertex.uniforms.add(new dc.g("time",(function(e){return e.time}))),t.varyings.add("vUv","vec2"),t.vertex.code.add((0,dc.n)(le||(le=(0,wu.Z)(["\n    vec3 hash31(float p){\n      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n\n    float hash11(float p){\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);\n    }\n\n    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/\n    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){\n      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;\n    }\n\n    void main(void) {\n\n      vUv = position.xz;\n\n      vec3 rand = hash31(instanceFeatureAttribute);\n\n      // Set random position for all particles\n      // The hash function space is not high resolution so offset particles by an additional random value\n      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width\n      // overlaying multiple identical but offset grids\n      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;\n\n      // Random orientation of rain drops\n      float angle = 3.1415 * hash11(instanceFeatureAttribute);\n\n      vec3 up = vec3(0, 0, 1);\n\n      // Gravity and wind direction\n      vec3 direction = normalize(cameraPosition);\n\n      vec3 tangent = normalize(cross(direction, up));\n\n      // Gravity\n      vec3 animatedPos = randomPosition + direction * -time;\n\n      // Rain particles fall straight down and are randomly oriented\n      // Snow particles have random sinusoid trajectories and are rotated to face the camera\n      ","\n    }\n  "])),e.type===Tp.Rain?(0,dc.n)(ue||(ue=(0,wu.Z)(["\n            // Random rotation for particle\n            vec3 rotationAxis = up;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);\n\n            // Rotate particle to planetary position\n            rotationAxis = tangent;\n            angle = 0.5 * -acos(dot(direction, up));\n            quat = vec4(rotationAxis * sin(angle), cos(angle));\n            transformedPos = rotateVectorByQuaternion(transformedPos, quat);\n\n            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * pos;\n      "]))):(0,dc.n)(ce||(ce=(0,wu.Z)(["\n            vec3 rotationAxis = direction;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n\n            tangent = rotateVectorByQuaternion(tangent, quat);\n            // Random sinusoid from friction\n            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));\n            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);\n      "]))))),t.fragment.uniforms.add([new dc.g("opacity",(function(e){return e.opacity})),new dc.c("particleColor",(function(t,r){return function(e,t){var r=t.type===Tp.Rain?Ep:kp,n=(0,Vu.g)(Rp,r,Dp),i=e.camera.eye;(0,Vu.z)(Ap,i);var a=Math.max(0,(0,Vu.P)(Ap,e.lighting.mainLight.direction));return(0,Vu.A)(n,n,r,a)}(r,e)}))]),t.fragment.code.add((0,dc.n)(he||(he=(0,wu.Z)(["\n    void main() {\n\n      // Cut off corners of the triangle\n      if(vUv.x < 0.0 || vUv.y < 0.0){\n        discard;\n      }\n\n      float d = length(vUv - vec2(0.5));\n\n      ","\n      gl_FragColor = opacity * vec4(particleColor * d, d);\n    }\n  "])),e.type===Tp.Rain?(0,dc.n)(de||(de=(0,wu.Z)(["d = 0.35 * smoothstep(0.5, 0.0, d);"]))):(0,dc.n)(fe||(fe=(0,wu.Z)(["d = smoothstep(0.5, 0.1, d);"]))))),t}(0,Eu.e)([(0,dc.p)({count:Tp.COUNT})],Op.prototype,"type",void 0);var Rp=(0,Vu.n)(),Ap=(0,Vu.n)(),kp=(0,Vu.c)(1,1,1),Ep=(0,Vu.c)(.85,.85,.85),Dp=.7,Mp=Object.freeze(Object.defineProperty({__proto__:null,build:Pp},Symbol.toStringTag,{value:"Module"})),Ip=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).time=0,e.radius=1,e.width=500,e.opacity=1,e}return(0,ku.Z)(r)}(dc.t),Lp=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),Zp)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);Lp.shader=new dc.m(Mp,(function(){return r.e(1022).then(r.bind(r,21022))}));var Zp=new Map([[fc.O.POSITION,0],[fc.O.INSTANCEFEATUREATTRIBUTE,1]]),Np=function(){function e(){(0,Au.Z)(this,e),this.enabled=!0,this._time=(0,Eu.aj)(0)}return(0,ku.Z)(e,[{key:"time",get:function(){return this._time}},{key:"advance",value:function(e){return this._time!==e.time&&(this._time=e.time,!0)}}]),e}(),Fp=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._numParticles=25e4,n._rainSpeed=.1,n._snowSpeed=.01,n._passParameters=new Ip,n._animation=new Np,n._updatingTracking=new oc.c,n._passParameters.time=0,n._passParameters.radius=(0,Xu.u)(e.view.spatialReference).radius,n._shaderTechniqueRepository=e.context.shaderTechniqueRepository,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=(0,Nu.F)(this._snowTechniqueCached),this._rainTechniqueCached=(0,Nu.F)(this._rainTechniqueCached),this._vao=(0,Nu.G)(this._vao),this._instanceIdBuffer=(0,Nu.G)(this._instanceIdBuffer)}},{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if((0,Nu.t)(this._rainTechniqueCached)){var e=new Op;e.type=Tp.Rain,this._rainTechniqueCached=this._shaderTechniqueRepository.acquire(Lp,e)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if((0,Nu.t)(this._snowTechniqueCached)){var e=new Op;e.type=Tp.Snow,this._snowTechniqueCached=this._shaderTechniqueRepository.acquire(Lp,e)}return this._snowTechniqueCached}},{key:"update",value:function(e){return this._animation.advance(e)}},{key:"render",value:function(e,t,r){var n="rainy"===r?this._rainTechnique:this._snowTechnique;if(n.compiled){var i=e.rctx;if(this._ensureResources(i),!((0,Nu.t)(n)||(0,Nu.t)(this._vao)||(0,Nu.t)(this._instanceIdBuffer))&&((0,Nu.r)(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),!(this._passParameters.opacity<=0))){t=t<.5?(0,Vu.Z)(0,.35,2*t):(0,Vu.Z)(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===r?this._rainSpeed:this._snowSpeed)*(0,Eu.aq)(this._animation.time)%1e5;var a=i.bindTechnique(n,this._passParameters,e.bindParameters);i.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),(0,_c.R)(i,Zp,this._instanceIdBuffer,Up,0),i.capabilities.instancing.drawArraysInstanced(pc.E.TRIANGLES,0,3,this._numParticles*t),(0,_c.a)(i,Zp,this._instanceIdBuffer,Up)}}else this.context.requestRender()}},{key:"_ensureResources",value:function(e){(0,Nu.t)(this._vao)&&(this._vao=this._createVertexArrayObject(e)),(0,Nu.t)(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}},{key:"_createInstanceIndices",value:function(e){for(var t=[],r=0;r<this._numParticles;r++)t.push(r);return _c.E.createVertex(e,pc.F.STATIC_DRAW,new Float32Array(t))}},{key:"_createVertexArrayObject",value:function(e){var t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new dc.N(e,Zp,{geometry:(0,xc.o)(zp)},{geometry:_c.E.createVertex(e,pc.F.STATIC_DRAW,t)})}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Fp.prototype,"context",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Fp.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Fp.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],Fp.prototype,"_updatingTracking",void 0),Fp=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.Precipitation")],Fp);var zp=(0,wc.T)().vec3f(fc.O.POSITION),Up=(0,xc.o)((0,wc.T)().f32(fc.O.INSTANCEFEATUREATTRIBUTE),1),Vp=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),Bp=128,Gp=-Ad,Hp=(0,qu.U)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]),jp=function(){function e(t){(0,Au.Z)(this,e),this.view=t,this.type=Od.Simple,this._passParameters=new Yf,this._fadeVaoCount=0,this._texV1=1,this._isOnMars=(0,Yu.P)(t.spatialReference);var r=(0,Xu.u)(t.spatialReference);this._planetRadius=r.radius,this._outerRimWidth=r.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+Gp)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._cameraChangeHandle=(0,Nu.f)(this._cameraChangeHandle),this._passParameters.texture=(0,Nu.G)(this._passParameters.texture),this._fadeVao=(0,Nu.G)(this._fadeVao),this._vao=(0,Nu.G)(this._vao)}},{key:"initializeRenderContext",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._shaderTechniqueRepository=t.shaderTechniqueRepository,r=t.renderContext.rctx,this._cameraChangeHandle=(0,Fu.l)((function(){var e;return null===(e=i.view.state)||void 0===e?void 0:e.camera}),(function(){return t.requestRender()}),Fu.w),this._vao=this._createRibbon(r),this._vaoCount=(0,_c.n)(this._vao,"geometry"),this._fadeVao=(0,dc.u)(r),this._fadeVaoCount=(0,_c.n)(this._fadeVao,"geometry"),n=this._isOnMars?Vp:tp,this._passParameters.texture=new Oc.E(r,{pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,flipped:!0,width:1,height:512},n),t.requestRender();case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_coneTechnique",get:function(){if((0,Nu.t)(this._coneTechniqueCached)){var e=new Xf;e.geometry=Hf.Cone,this._coneTechniqueCached=this._shaderTechniqueRepository.acquire($f,e)}return this._coneTechniqueCached}},{key:"_undergroundTechnique",get:function(){if((0,Nu.t)(this._undergroundTechniqueCached)){var e=new Xf;e.geometry=Hf.Underground,this._undergroundTechniqueCached=this._shaderTechniqueRepository.acquire($f,e)}return this._undergroundTechniqueCached}},{key:"render",value:function(e){if(!(0,Nu.t)(this._vao)&&!(0,Nu.t)(this._passParameters.texture)){var t=e.bindParameters.camera;this._update(t);var r=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(r.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),r.bindVAO(this._vao),r.drawArrays(pc.E.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(r.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),r.bindVAO(this._fadeVao),r.drawArrays(pc.E.TRIANGLE_STRIP,0,this._fadeVaoCount))}}},{key:"renderHaze",value:function(){}},{key:"_update",value:function(e){var t=(0,Vu.n)(),r=this._planetRadius,n=(0,Vu.s)(e.eye),i=n-r;if(i<0){var a=Math.min(-i/5e3,1);this._passParameters.undergroundFadeAlpha=a}else this._passParameters.undergroundFadeAlpha=0;var o=Math.max(50,i),s=r+Gp;this._passParameters.innerScale=function(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}(r+o,r,s)-1,this._passParameters.altitudeFade=Rd(i),(0,Vu.g)(t,e.eye,(r+50)/n),qp(t,e.center,e.up,r,this._passParameters.silhouette);var l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),u=1-511/512,c=Hp(i),h=this._texV0+u*this._texVScale,d=this._texV0+l*c*this._texVScale;if(i>50){qp(e.eye,e.center,e.up,r,this._passParameters.silhouette);var f=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),p=(0,Vu.a)((f-1.5)/(l-1.5),0,1);h=this._texV0+p*u*this._texVScale,d=this._texV0+(0,Vu.Z)(this._texV1,l*c,p)*this._texVScale}(0,uc.r)(this._passParameters.texV,h,d)}},{key:"_createRibbon",value:function(e){var t=new Float32Array(1155),r=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(var n=0;n<Bp;n++){var i=9*n+3;t[i+0]=n,t[i+1]=this._innerRimFactor,t[i+2]=-1,t[i+3]=n,t[i+4]=this._middleRimFactor,t[i+5]=0,t[i+6]=n,t[i+7]=this._outerRimFactor,t[i+8]=1;var a=3*n+1,o=127===n?1:a+3,s=15*n;r[s+0]=a,r[s+1]=a+1,r[s+2]=o+1,r[s+3]=o+1,r[s+4]=o,r[s+5]=a,r[s+6]=a+1,r[s+7]=a+2,r[s+8]=o+2,r[s+9]=o+2,r[s+10]=o+1,r[s+11]=a+1,r[s+12]=a,r[s+13]=o,r[s+14]=0}for(var l=Qp.createBuffer(r.length),u=l.position,c=0;c<r.length;++c){var h=3*r[c];u.set(c,0,t[h]),u.set(c,1,t[h+1]),u.set(c,2,t[h+2])}return new dc.N(e,dc.E,{geometry:(0,xc.o)(Qp)},{geometry:_c.E.createVertex(e,pc.F.STATIC_DRAW,l.buffer)})}},{key:"_computeScreenRimWidth",value:function(e,t,r,n){return(0,Vu.u)(Xp,n.center,n.v2),(0,Vu.g)(Yp,Xp,this._outerRimFactor),(0,Wu.Q)(Wp,t,Xp,r),(0,Sc.i)(Xp,Wp,e.projectionMatrix,e.viewport),(0,Sc.i)(Yp,Wp,e.projectionMatrix,e.viewport),(0,Vu.x)(Xp,Yp)/e.height}}]),e}();function qp(e,t,r,n,i){var a=(0,Vu.s)(e),o=n*Math.sqrt(a*a-n*n)/a,s=Math.sqrt(n*n-o*o),l=i.v1,u=i.v2;return(0,Vu.g)(i.center,e,s/a),(0,Vu._)(l,e,t),(0,Vu.v)(l)<1&&(0,Vu._)(l,e,r),(0,Vu.g)(l,l,o/(0,Vu.s)(l)),(0,Vu._)(u,l,e),(0,Vu.g)(u,u,o/(0,Vu.s)(u)),o}var Wp=(0,hc.e)(),Xp=(0,Vu.n)(),Yp=(0,Vu.n)();var Qp=(0,wc.T)().vec3f(fc.O.POSITION),Kp=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ZERO,pc.R.ONE_MINUS_SRC_COLOR,pc.R.ONE),colorWrite:vc._})}}]),r}(dc.k);Kp.shader=new dc.m(Uf,(function(){return r.e(4743).then(r.bind(r,4743))}));var Jp=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;(0,Au.Z)(this,r),(n=t.call(this,e))._passParameters=new Nf;var i=e.context.renderContext.rctx;n._vao=(0,dc.u)(i,dc.A);var a=(0,Xu.u)(e.view.spatialReference);return n._planetRadius=a.radius,n._atmosphereRadius=a.radius+kd,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._hazeTechniqueCached=(0,Nu.F)(this._hazeTechniqueCached),this._vao=(0,Nu.G)(this._vao)}},{key:"_shaderTechniqueRepository",get:function(){return this.context.shaderTechniqueRepository}},{key:"strength",get:function(){return this._passParameters.hazeStrength},set:function(e){this._passParameters.hazeStrength=e}},{key:"_hazeTechnique",get:function(){if((0,Nu.t)(this._hazeTechniqueCached)){var e=new Bf;e.haze=!0,this._hazeTechniqueCached=this._shaderTechniqueRepository.acquire(Kp,e)}return this._hazeTechniqueCached}},{key:"render",value:function(e,t){var r=this;if(0!==this.view.basemapTerrain.baseOpacity&&(this._update(e,t),!(this._passParameters.hazeAmount<=0))){var n=this._hazeTechnique;if(n.compiled){var i=e.offscreenRenderingHelper;i.renderDepthDetached((function(){r._passParameters.depthTexture=i.depthTexture;var t=e.rctx.bindTechnique(n,r._passParameters,e.bindParameters);r._renderSimpleHaze(t,e)}))}else this.context.requestRender()}}},{key:"_renderSimpleHaze",value:function(e,t){if(!(0,Nu.t)(this._vao)){var r=t.rctx;r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(pc.E.TRIANGLE_STRIP,0,4)}}},{key:"_update",value:function(e,t){var r=e.bindParameters.camera;(0,Vu.z)(tv,r.eye);var n=Math.max(0,(0,Vu.P)(tv,e.bindParameters.lighting.mainLight.direction)),i=ev;(0,Vu.g)(rv,i,0),(0,Vu.A)(this._passParameters.hazeColor,rv,i,n);var a=(0,Vu.s)(r.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-(0,Vu.$)(.7*qu.e,1*qu.e,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}}],[{key:"isSupported",value:function(e){return e.capabilities.depthTexture}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Jp.prototype,"context",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Jp.prototype,"view",void 0),Jp=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.SimpleHaze")],Jp);var $p=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.strength=0,this.amount=0})),ev=(0,Vu.c)(.24,.44,.8),tv=(0,Vu.n)(),rv=(0,Vu.n)();function nv(e){var t=(0,dc.n)(pe||(pe=(0,wu.Z)(["vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {\nvec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"]))),r=(0,dc.n)(ve||(ve=(0,wu.Z)(["vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {\nvec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"])));e.vertex.code.add(t),e.vertex.code.add(r),e.fragment.code.add(t),e.fragment.code.add(r)}function iv(){var e=new dc.o;return e.attributes.add(fc.O.POSITION,"vec3"),e.attributes.add(fc.O.COLOR,"vec4"),e.attributes.add(fc.O.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add([new dc.e("transform",(function(e,t){return function(e,t){var r=24e-8;return(0,Wu.n)(av,t.camera.projectionMatrix),av[10]=r-1,av[11]=-1,av[14]=(r-2)*t.camera.near,(0,Wu.u)(av,av,t.camera.viewMatrix),(0,Wu.u)(av,av,e.modelMatrix)}(e,t)})),new dc.f("viewport",(function(e,t){return t.camera.fullViewport})),new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),e.include(nv),e.vertex.code.add((0,dc.n)(me||(me=(0,wu.Z)(["void main(void) {\nvec4 posProj = transform * vec4(position, 0);\ngl_Position = alignToPixelCenter(posProj, viewport.zw);\nvcolor = color / 1.2;\nvsize = size * 5.0 * pixelRatio;\ngl_PointSize = vsize;\n}"])))),e.fragment.code.add((0,dc.n)(ye||(ye=(0,wu.Z)(["void main() {\nfloat cap = 0.7;\nfloat scale = 1.0 / cap;\nfloat helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);\nfloat alpha = clamp((cap - helper) * scale, 0.0, 1.0);\nfloat intensity = alpha * alpha * alpha;\nif (vsize < 3.0) {\nintensity *= 0.5;\n}\ngl_FragColor = vec4(vcolor.xyz, intensity);\n}"])))),e}var av=(0,hc.e)(),ov=Object.freeze(Object.defineProperty({__proto__:null,build:iv},Symbol.toStringTag,{value:"Module"})),sv=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).modelMatrix=(0,hc.e)(),e}return(0,ku.Z)(r)}(dc.t),lv=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),n=t.call(this,e,new dc.q,(function(){return n.destroy()}))}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._})}}]),r}(dc.k);lv.shader=new dc.m(ov,(function(){return r.e(9).then(r.bind(r,20009))}));var uv=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._loadDataTask=null,n._numPoints=0,n._renderParameter=new sv,n._updatingTracking=new oc.c,n}return(0,ku.Z)(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return(0,Nu.r)(this._loadDataTask)&&!this._loadDataTask.finished}},{key:"initialize",value:function(){this._loadDataTask=this._createLoadDataTask()}},{key:"destroy",value:function(){this._loadDataTask=(0,Nu.l)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,Nu.F)(this._technique),this._vao=(0,Nu.G)(this._vao)}},{key:"render",value:function(e){var t=e.rctx;if(this._ensureResources(t),!(0,Nu.t)(this._technique)&&!(0,Nu.t)(this._vao))if(this._technique.compiled){var r=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(pc.E.POINTS,0,this._numPoints)}else this.requestRender()}},{key:"_ensureResources",value:function(e){var t=this;if(!(0,Nu.r)(this._technique)&&!(0,Nu.t)(vv)){this._technique=new lv({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=vv.byteLength/fv;var r=new Float32Array(vv,0,2*this._numPoints),n=new Uint8Array(vv,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,r,n,this._numPoints),this._updatingTracking.add((function(){return"virtual"!==t.view.environment.lighting.type?t.view.environment.lighting.date:null}),(function(e){return t._update(e)}),Fu.h)}}},{key:"_computeDayDuration",value:function(e){var t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}},{key:"_update",value:function(e){if(e){var t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),n=(0,Wu.n)(this._renderParameter.modelMatrix,dv);(0,Wu.m)(n,n,-r*Math.PI),(0,Wu.u)(n,hv,n),(0,Wu.m)(n,n,-t*Math.PI),this.requestRender()}}},{key:"_hexToRGB",value:function(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}},{key:"_unpackUint8Attributes",value:function(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}},{key:"_createVertexArrayObject",value:function(e,t,r,n){for(var i=pv.createBuffer(n),a=i.position,o=i.color,s=i.size,l=0;l<n;l++){var u=t[2*l+0],c=t[2*l+1];a.set(l,0,-Math.cos(u)*Math.sin(c)),a.set(l,1,-Math.sin(u)*Math.sin(c)),a.set(l,2,-Math.cos(c));var h=this._unpackUint8Attributes(r[l]),d=this._hexToRGB(cv[h[1]]);o.set(l,0,255*d[0]),o.set(l,1,255*d[1]),o.set(l,2,255*d[2]),o.set(l,3,255),s.set(l,h[0])}return new dc.N(e,dc.E,{geometry:(0,xc.o)(pv)},{geometry:_c.E.createVertex(e,pc.F.STATIC_DRAW,i.buffer)})}},{key:"_createLoadDataTask",value:function(){var e=this;if((0,Nu.r)(vv))return null;var t=(0,ac.j)(function(){var t=(0,Ou.Z)((0,Su.Z)().mark((function t(r){var n,i;return(0,Su.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,Pc.n)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:r});case 2:n=t.sent,i=n.data,e._verifyStarData(i),vv=i;case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());return t.promise.catch((function(t){(0,Eu.j)(t)||Eu.a.getLogger(e.declaredClass).error(t)})).then((function(){e.destroyed||(e.requestRender(),e.notifyChange("updating"))})),t}},{key:"_verifyStarData",value:function(e){if(!e)throw new Eu.s("stars:no-data-received","Failed to create stars because star catalogue is missing");var t=e.byteLength/fv;if(t%1!=0||t>5e4||t<5e3)throw new Eu.s("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],uv.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],uv.prototype,"requestRender",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],uv.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],uv.prototype,"_loadDataTask",void 0),(0,Eu.e)([(0,Eu.y)()],uv.prototype,"_updatingTracking",void 0),uv=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.Stars")],uv);var cv=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],hv=(0,hc.t)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),dv=(0,hc.t)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),fv=9,pv=(0,wc.T)().vec3f(fc.O.POSITION).vec4u8(fc.O.COLOR).f32(fc.O.SIZE),vv=null;function mv(e,t,r,n){var i=e.fadeInOutHeight,a=i.stage===Wd.FINISHED?r:e.startTimeHeightFade;if(0!==n){var o=(r-a)/(Pv*n);i.factor+=t?-o:o}else i.factor=t?0:1;e.startTimeHeightFade=r,i.factor=(0,Vu.a)(i.factor,0,1),i.stage=Wd.HEIGHT_FADE}function yv(e,t,r,n,i){e.renderingStage===Vd.FINISHED_RENDERING&&(e.renderingStage=Vd.FADING_TEXTURE_CHANNELS);var a=(0,Vu.s)(t.eye);e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=a-Yu.s.radius>qu.e?1:0),e.isCameraPositionFinal=(0,Vu.a2)(e.cameraPositionLastFrame,t.eye),(0,Vu.z)(wv,t.eye),(0,Vu.g)(wv,wv,Yu.s.radius);var o=e.parallax;0===o.anchorPointClouds[0]&&0===o.anchorPointClouds[1]&&0===o.anchorPointClouds[2]&&(0,Vu.r)(o.anchorPointClouds,wv);var s=(0,Vu.s)((0,Vu.e)(Tv,o.anchorPointClouds,wv)),l=!0;s>e.fadeIn.distanceThresholdFactor*o.cloudsHeight||e.fadeIn.stage!==jd.FINISHED?function(e,t,r){var n=e.parallax.anchorPointClouds;e.fadeIn.stage===jd.FINISHED&&(e.fadeIn.factor=0,(0,Vu.r)(n,wv),e.fadeIn.stage=jd.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=qd.FINISHED),e.fadeIn.stage===jd.CHANGE_ANCHOR&&e.isCameraPositionFinal&&(Hd(e.data)&&e.renderingStage!==Vd.RENDERING||e.renderingStage===Vd.FADING_TEXTURE_CHANNELS)&&((0,Vu.r)(n,wv),e.fadeIn.stage=jd.FADE_IN,e.startTime=t,e.renderingStage===Vd.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Vd.SWITCH_CHANNELS)),e.fadeIn.factor<1&&e.fadeIn.stage===jd.FADE_IN?e.fadeIn.factor=r?(0,Vu.a)((t-e.startTime)/(Cv*r),0,1):1:e.fadeIn.factor>=1&&e.fadeIn.stage===jd.FADE_IN&&(e.fadeIn.stage=jd.FINISHED,e.fadeIn.factor=1)}(e,n,i):s>e.fadeInOut.distanceThresholdFactor*o.cloudsHeight||e.fadeInOut.stage!==qd.FINISHED?function(e,t,r){var n=e.fadeInOut,i=e.crossFade;n.stage===qd.FINISHED&&(e.startTime=t,n.factor=1,n.stage=qd.FADE_OUT),n.factor>0&&n.stage===qd.FADE_OUT?n.factor=r?1-(0,Vu.a)((t-e.startTime)/(Sv*r),0,1):0:(n.factor<=0&&n.stage===qd.FADE_OUT&&(n.factor=0,(0,Vu.r)(e.parallax.anchorPointClouds,wv)),n.factor<=0&&n.stage===qd.FADE_OUT&&e.isCameraPositionFinal&&(n.factor=0,n.stage=qd.SWITCH,e.crossFade.enabled=!1,i.factor=1),n.stage===qd.SWITCH&&(Hd(e.data)&&e.renderingStage!==Vd.RENDERING||e.renderingStage===Vd.FADING_TEXTURE_CHANNELS)&&(e.startTime=t,n.factor=0,n.stage=qd.FADE_IN,(0,Vu.r)(e.parallax.anchorPointClouds,wv),e.crossFade.enabled=!1,i.factor=1,e.renderingStage===Vd.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Vd.SWITCH_CHANNELS)),n.factor<1&&n.stage===qd.FADE_IN?n.factor=r?(0,Vu.a)((t-e.startTime)/(Cv*r),0,1):1:n.factor>=1&&n.stage===qd.FADE_IN&&(n.stage=qd.FINISHED,n.factor=1))}(e,n,i):s>e.crossFade.distanceThresholdFactor*o.cloudsHeight||e.crossFade.enabled||e.renderingStage===Vd.FADING_TEXTURE_CHANNELS?function(e,t,r,n){var i=e.crossFade,a=e.parallax.anchorPointClouds;e.crossFade.enabled&&!n||((0,Vu.r)(e.parallaxNew.anchorPointClouds,wv),e.startTime=t,i.factor=0,e.crossFade.enabled=!0),i.factor<1&&e.crossFade.enabled?i.factor=r?(0,Vu.a)((t-e.startTime)/(Ov*r),0,1):1:i.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,i.factor=1,(0,Vu.r)(a,e.parallaxNew.anchorPointClouds),e.renderingStage===Vd.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Vd.SWITCH_CHANNELS))}(e,n,i,(r!==bc.a.IDLE||!Hd(e.data))&&e.renderingStage!==Vd.FADING_TEXTURE_CHANNELS):l=!1;var u=a-Yu.s.radius;if((u>1.7*qu.e||u<-qu.e)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(u>qu.e||u<-.35*qu.e)&&e.fadeInOutHeight.factor<1?mv(e,!1,n,i):u<qu.e&&u>-.35*qu.e&&e.fadeInOutHeight.factor>0?mv(e,!0,n,i):e.fadeInOutHeight.stage=Wd.FINISHED,e.renderingStage===Vd.SWITCH_CHANNELS&&(e.readChannels=1-e.readChannels,e.renderingStage=Vd.FINISHED),o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(a*a-Yu.s.radius*Yu.s.radius,0))/a,(0,Rc.q)(bv,o.anchorPointClouds,xv),(0,Wu.f)(o.transform,hc.o,xv[3],(0,Rc.g)(xv)),l){var c=e.parallaxNew;(0,Rc.q)(bv,c.anchorPointClouds,xv),(0,Wu.f)(c.transform,hc.o,xv[3],(0,Rc.g)(xv))}(0,Vu.r)(e.cameraPositionLastFrame,t.eye)}var gv,_v,bv=(0,Vu.c)(0,0,1),xv=(0,Rc.a)(),wv=(0,Vu.n)(),Tv=(0,Vu.n)(),Cv=1,Sv=.5,Ov=1.3,Pv=1;!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(gv||(gv={}));var Rv=[dc.H.POSTPROCESSING_ENVIRONMENT_OPAQUE,dc.H.POSTPROCESSING_ENVIRONMENT_TRANSPARENT],Av=_v=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n._context=null,n._atmosphere=null,n._oldWeatherParameters=new Iv,n._newWeatherParameters=new Iv,n._fadedWeatherParameters=new Iv,n._weatherParameters=n._newWeatherParameters,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){this.view._stage.addRenderPlugin(Rv,this)}},{key:"destroy",value:function(){var e;null!=(null===(e=this.view)||void 0===e?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._handles=(0,Nu.g)(this._handles),this._set("view",null)}},{key:"atmosphereType",get:function(){return(0,Nu.r)(this._atmosphere)?this._atmosphere.type:Od.None}},{key:"canRender",get:function(){var e;return!(null===(e=this.view.basemapTerrain)||void 0===e||!e.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return(0,Nu.r)(this._atmosphere)&&this._atmosphere.type===Od.Realistic}},{key:"updateAnimation",value:function(e){return!!(0,Nu.r)(this._precipitation)&&this._precipitation.update(e)}},{key:"updating",get:function(){return(0,Nu.r)(this._stars)&&this._stars.updating||(0,Nu.r)(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return(0,Vu.s)(this.view.state.camera.eye)-(0,Xu.u)(this.view.spatialReference).radius<=qu.e}},{key:"_stars",get:function(){var e,t,r=this,n=this.view,i=null!==(e=null===(t=n.environment)||void 0===t?void 0:t.starsEnabled)&&void 0!==e&&e,a=this._get("_stars");return!i||(0,Nu.t)(this._context)?((0,Nu.g)(a),null):(0,Nu.r)(a)?a:new uv({view:n,requestRender:function(){return r._setNeedsRender()}})}},{key:"_precipitation",get:function(){var e=this._get("_precipitation");if(!this._precipitationEnabled||(0,Nu.t)(this._context))return(0,Nu.g)(e),null;var t=this.view,r=this._context;return(0,Nu.r)(e)&&e.context===r?e:((0,Nu.g)(e),new Fp({context:r,view:t}))}},{key:"_clouds",get:function(){var e=this,t=this._get("_clouds");if(!this.weatherEnabled||(0,Nu.t)(this._context))return(0,Nu.g)(t),null;if((0,Nu.r)(t))return t;var r=this.view,n=this._context;return(0,Nu.g)(t),new Mf({context:n,view:r,requestRender:function(){return e._setNeedsRender()}})}},{key:"_cloudsComposition",get:function(){var e=this,t=this._get("_cloudsComposition");if(!this.weatherEnabled||(0,Nu.t)(this._context))return(0,Nu.g)(t),null;var r=this.view.state.viewingMode,n=this._context.renderContext.rctx,i=(0,Xu.u)(this.view.spatialReference).radius;return(0,Nu.r)(t)&&t.viewingMode===r&&t.planetRadius===i?t:((0,Nu.g)(t),new rf({rctx:n,viewingMode:r,planetRadius:i,requestRender:function(){return e._setNeedsRender()}}))}},{key:"_fog",get:function(){var e=this._get("_fog");if(!this.weatherEnabled||(0,Nu.t)(this._context))return(0,Nu.g)(e),null;if((0,Nu.r)(e))return e;var t=this.view,r=this._context;return new Gf({context:r,view:t})}},{key:"_simpleHaze",get:function(){var e=this._get("_simpleHaze");if(!this.weatherEnabled||(0,Nu.t)(this._context))return(0,Nu.g)(e),null;if((0,Nu.r)(e))return e;var t=this.view,r=this._context;return new Jp({context:r,view:t})}},{key:"weatherEnabled",get:function(){var e,t;return!(null===(e=this.view)||void 0===e||null===(t=e.environmentManager)||void 0===t||!t.weatherEnabled)}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"initializeRenderContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._context=t;var r=function(){return e._setNeedsRender()};this._handles.add([(0,Fu.f)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.basemapTerrain}),(function(){return e._updateBasemapTerrain()}),Fu.w),(0,Fu.l)((function(){return{viewingMode:e.view.viewingMode,atmosphereEnabled:e.view.environment.atmosphereEnabled,atmosphereQuality:e.view.environment.atmosphere.quality}}),(function(){return e._updateAtmosphere()}),Fu.w),(0,Fu.l)((function(){return e._stars}),r),(0,Fu.l)((function(){return e._precipitation}),r),(0,Fu.l)((function(){return e._clouds}),(function(){return e._updateWeather()}),Fu.h),(0,Fu.l)((function(){return e._fog}),(function(){return e._updateFogHaze()}),Fu.h),(0,Fu.l)((function(){return e._simpleHaze}),(function(){return e._updateFogHaze()}),Fu.h),(0,Fu.l)((function(){return e._weatherUpdateParameters}),(function(){e._updateWeather(),e._updateFogHaze()}),Fu.w)])}},{key:"uninitializeRenderContext",value:function(){this._context=null,this._atmosphere=(0,Nu.g)(this._atmosphere),this._set("_stars",(0,Nu.g)(this._stars)),this._set("_precipitation",(0,Nu.g)(this._precipitation)),this._set("_clouds",(0,Nu.g)(this._clouds)),this._set("_cloudsComposition",(0,Nu.g)(this._cloudsComposition)),this._set("_fog",(0,Nu.g)(this._fog)),this._set("_simpleHaze",(0,Nu.g)(this._simpleHaze))}},{key:"prepareRender",value:function(e){e.bindParameters.cloudsFade.data=function(e){return(0,Nu.r)(e)&&(0,Nu.r)(e.cubeMap)}(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&(yv(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,_v.test.time||e.time,this.view.qualitySettings.weatherFadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===Vd.FINISHED&&(0,Nu.r)(this._clouds)&&0===this._clouds.coverage&&!1===this._clouds.running&&this._clouds.destroyFrameBufferCube())}},{key:"render",value:function(e){if(e.output===dc.O.Color)switch(e.bindParameters.slot){case dc.H.POSTPROCESSING_ENVIRONMENT_OPAQUE:(0,Nu.r)(this._stars)&&this._stars.render(e),(0,Nu.r)(this._atmosphere)&&(this._atmosphere.render(e),(0,Nu.r)(this._cloudsComposition)&&(0,Nu.r)(e.bindParameters.cloudsFade.data)&&(this.weatherVisible&&(0,Nu.r)(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),function(e){return e.crossFade.enabled||e.fadeInOut.stage!==qd.FINISHED||e.fadeIn.stage!==jd.FINISHED||e.fadeInOutHeight.stage!==Wd.FINISHED||e.renderingStage!==Vd.FINISHED}(e.bindParameters.cloudsFade)&&(0,Nu.r)(this._context)&&this._context.requestRender());break;case dc.H.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if((0,Nu.r)(this._atmosphere)&&(this._atmosphere.renderHaze(e,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._selectAtmosphereType()!==Od.Realistic&&(0,Nu.r)(this._simpleHaze)&&this._simpleHaze.render(e,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&(0,Nu.r)(this._fog)&&this._fog.render(e,this._weatherParameters.fog),(0,Nu.r)(this._precipitation))){var t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}},{key:"updateLightSources",value:function(e,t,r,n){if((0,Nu.r)(this._context)){var i=this._context.renderContext;i.bindParameters.oldLighting.copyFrom(i.bindParameters.lighting),i.bindParameters.newLighting.noonFactor=t,i.bindParameters.newLighting.globalFactor=r,i.bindParameters.newLighting.set(e),n===gv.Faded||i.bindParameters.weatherFading?i.bindParameters.fadeLighting(0):i.bindParameters.fadeLighting(1),this._context.requestRender()}}},{key:"_weatherUpdateParameters",get:function(){var e=this.weatherEnabled?this.view.environment.weather:null;return(0,Nu.t)(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"_updateWeatherFading",value:function(e){if(e.weatherFading){var t=e.cloudsFade;return t.fadeIn.stage===jd.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===qd.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))}}},{key:"_fadeWeather",value:function(e){var t=this._newWeatherParameters,r=this._oldWeatherParameters;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(r,t,e),this._weatherParameters=this._fadedWeatherParameters)}},{key:"_updateWeather",value:function(){var e=this._weatherUpdateParameters;(0,Nu.t)(e)||(0,Nu.t)(this._clouds)||(this._clouds.applyPreset(uf[e.type],e.weatherAdjustment),this._setNeedsRender())}},{key:"_setNeedsRender",value:function(){(0,Nu.r)(this._context)&&this._context.requestRender()}},{key:"_updateFogHaze",value:function(){var e=this._weatherUpdateParameters;if(!((0,Nu.t)(this._fog)||(0,Nu.t)(this._simpleHaze)||(0,Nu.t)(e)||(0,Nu.t)(this._context))){var t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=(0,Vu.Z)(3e-5,.005,Math.pow(e.weatherAdjustment,3)),(0,Vu.r)(this._newWeatherParameters.fog.color,Zv),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._selectAtmosphereType()===Od.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=(0,Vu.Z)(4e-6,2e-4,Math.pow(e.effect,3)),(0,Vu.r)(this._newWeatherParameters.fog.color,Lv),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=(0,Vu.Z)(4e-6,2e-4,Math.pow(e.effect,3)),(0,Vu.r)(this._newWeatherParameters.fog.color,Zv),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._selectAtmosphereType()===Od.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}}},{key:"_updateAtmosphere",value:function(){var e=this._selectAtmosphereType();if(this.atmosphereType!==e){var t=this._getAtmosphereClass();if(!t)return(0,Nu.r)(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();(0,Nu.r)(this._context)&&((0,Nu.g)(this._atmosphere),this._atmosphere=new t(this.view),this._atmosphere.initializeRenderContext(this._context),this._setNeedsRender(),this._updateBasemapTerrain())}}},{key:"_getAtmosphereClass",value:function(){switch(this._selectAtmosphereType()){case Od.None:return null;case Od.Realistic:return Gd;case Od.Panoramic:return wp;case Od.Simple:return jp;default:return}}},{key:"_selectAtmosphereType",value:function(){var e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),r=this.view.viewingMode;return!e||null==t||(0,Yu.c)(this.view.spatialReference)?Od.None:"local"===r?Od.Panoramic:"high"===t&&(0,Nu.r)(this._context)&&Gd.isSupported(this._context)&&(0,Yu.A)(this.view.spatialReference)?Od.Realistic:Od.Simple}},{key:"_updateBasemapTerrain",value:function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=(0,Nu.r)(this._atmosphere)&&this.atmosphereType===Od.Simple)}},{key:"test",get:function(){var e=this;return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:function(){return e._selectAtmosphereType()},stubGetAtmosphereClass:function(e){kv=_v.prototype._getAtmosphereClass,_v.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:function(){_v.prototype._getAtmosphereClass=kv}}}}]),r}(Eu.m);Av.test={time:(0,Eu.aj)(0)},(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Av.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],Av.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"weatherVisible",null),(0,Eu.e)([(0,Eu.y)()],Av.prototype,"_context",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_stars",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_precipitation",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_clouds",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_cloudsComposition",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_fog",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_simpleHaze",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"weatherEnabled",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_precipitationEnabled",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Av.prototype,"_weatherUpdateParameters",null),Av=_v=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.EnvironmentRenderer")],Av);var kv,Ev,Dv,Mv,Iv=function(){function e(){(0,Au.Z)(this,e),this.fog=new jf,this.haze=new $p}return(0,ku.Z)(e,[{key:"copyFrom",value:function(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,(0,Vu.r)(this.fog.color,e.fog.color)}},{key:"lerp",value:function(e,t,r){this.fog.amount=(0,Vu.Z)(e.fog.amount,t.fog.amount,r),this.haze.amount=(0,Vu.Z)(e.haze.amount,t.haze.amount,r),this.fog.strength=(0,Vu.Z)(e.fog.strength,t.fog.strength,r),this.haze.strength=(0,Vu.Z)(e.haze.strength,t.haze.strength,r),(0,Vu.A)(this.fog.color,e.fog.color,t.fog.color,r)}}]),e}(),Lv=(0,Vu.c)(.5,.5,.5),Zv=(0,Vu.c)(1.5,1.5,1.5),Nv={exports:{}};Ev=Nv,Dv=function(){var e=Math.PI,t=Math.sin,r=Math.cos,n=Math.tan,i=Math.asin,a=Math.atan2,o=Math.acos,s=e/180,l=864e5,u=2440588,c=2451545,h={dec:0,ra:0};function d(e){return new Date((e+.5-u)*l)}function f(e){return function(e){return e.valueOf()/l-.5+u}(e)-c}var p=23.4397*s;function v(e,i){return a(t(e)*r(p)-n(i)*t(p),r(e))}function m(e,n){return i(t(n)*r(p)+r(n)*t(p)*t(e))}function y(e,i,o){return a(t(e),r(e)*t(i)-n(o)*r(i))}function g(e,n,a){return i(t(n)*t(a)+r(n)*r(a)*r(e))}function _(e,t){return s*(280.16+360.9856235*e)-t}function b(e){return s*(357.5291+.98560028*e)}function x(e){return s*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function w(t,r){return t+r+102.9372*s+e}function T(e,t){var r=b(e),n=w(r,x(r));return t||(t={dec:0,ra:0}),t.dec=m(n,0),t.ra=v(n,0),t}var C={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,r,n){var i=s*-r,a=s*t,o=f(e),l=T(o,h),u=_(o,i)-l.ra;return n||(n={azimuth:0,altitude:0}),n.azimuth=y(u,a,l.dec),n.altitude=g(u,a,l.dec),n}},S=[[-.83,"sunrise","sunset"]];C.addTime=function(e,t,r){S.push([e,t,r])};var O=9e-4;function P(t,r){return Math.round(t-O-r/(2*e))}function R(t,r,n){return O+(t+r)/(2*e)+n}function A(e,r,n){return c+e+.0053*t(r)-.0069*t(2*n)}function k(e,n,i){return o((t(e)-t(n)*t(i))/(r(n)*r(i)))}function E(e){var n=s*(134.963+13.064993*e),i=s*(93.272+13.22935*e),a=s*(218.316+13.176396*e)+6.289*s*t(n),o=5.128*s*t(i),l=385001-20905*r(n);return{ra:v(a,o),dec:m(a,o),dist:l}}return C.getTimes=function(e,n,i){var a=s*-i,o=s*n,l=P(f(e),a),u=R(0,a,l),c=b(u),h=x(c),p=w(c,h),v=m(p,0),y=A(u,c,p);function g(e){return A(R(k(e,o,v),a,l),c,p)}var _,T,O,E,D,M={solarNoon:d(y),nadir:d(y-.5),polarException:C.PolarException.NORMAL};for(_=0,T=S.length;_<T;_+=1)D=y-((E=g((O=S[_])[0]*s))-y),M[O[1]]=d(D),M[O[2]]=d(E);return M.polarException=function(e){var n=(t(e)-t(o)*t(v))/(r(o)*r(v));return n<-1?C.PolarException.MIDNIGHT_SUN:n>1?C.PolarException.POLAR_NIGHT:C.PolarException.NORMAL}(S[0][0]*s),M},C.getMoonPosition=function(e,t,r){var i=s*-r,a=s*t,o=f(e),l=E(o),u=_(o,i)-l.ra,c=g(u,a,l.dec);return c+=.017*s/n(c+10.26*s/(c+5.1*s)),{azimuth:y(u,a,l.dec),altitude:c,distance:l.dist}},C.getMoonFraction=function(e){var n=f(e),i=T(n),s=E(n),l=149598e3,u=o(t(i.dec)*t(s.dec)+r(i.dec)*r(s.dec)*r(i.ra-s.ra)),c=a(l*t(u),s.dist-l*r(u));return(1+r(c))/2},C},void 0!==(Mv=Dv())&&(Ev.exports=Mv);var Fv=Nv.exports,zv={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function Uv(e,t,r,n,i,a){(0,Vu.o)(a.ambient.color,1,1,1),a.ambient.intensity=zv.global.ambient,(0,Vu.o)(a.direct.color,1,1,1),a.direct.intensity=zv.global.direct;var o,s=t[2],l=(0,Vu.a)((Math.abs(s)-zv.local.altitude)/(zv.global.altitude-zv.local.altitude),0,1);if(a.globalFactor=l,(0,Nu.r)(e)&&(o=Fv.getTimes(e,t[1],t[0])),l<1){var u;if((0,Nu.r)(e))u=function(e,t,r){var n,i,a=e.valueOf();t.polarException===Fv.PolarException.MIDNIGHT_SUN?(n=a-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,i=n+432e6):t.polarException===Fv.PolarException.POLAR_NIGHT?(n=a-2,i=a-1):(n=t.sunrise.valueOf(),i=t.sunset.valueOf());var o,s,l=i-n,u=n+l/2,c=l/4,h=u-c,d=u+c,f=.06*l,p=n-f/2,v=n+f/2,m=i-f/2,y=i+f/2,g=zv.local,_=[.01,g.ambientAtNight],b=[.8,.8,1],x=[.01,.01,.01],w=[g.directAtTwilight,g.ambientAtTwilight],T=[1,.6,.5],C=[.8,.8,1],S=[.9*g.directAtNoon,g.ambientAtNoon],O=[1,.98,.98],P=[.98,.98,1],R=[g.directAtNoon,g.ambientAtNoon],A=[1,1,1],k=[1,1,1],E=S,D=O,M=P,I=w,L=T,Z=C,N=[0,0],F=[0,0,0],z=[0,0,0];a<p||a>y?(N=_,F=x,z=b,s="night"):a<v?(N=Xv(a-p,o=v-p,_,w),F=Xv(a-p,o,x,T),z=Xv(a-p,o,b,C),s="sun rising"):a<h?(N=Xv(a-v,o=h-v,w,S),F=Xv(a-v,o,T,O),z=Xv(a-v,o,C,P),s="early morning"):a<u?(N=Xv(a-h,o=u-h,S,R),F=Xv(a-h,o,O,A),z=Xv(a-h,o,P,k),s="late morning"):a<d?(N=Xv(a-u,o=d-u,R,E),F=Xv(a-u,o,A,D),z=Xv(a-u,o,k,M),s="early afternoon"):a<m?(N=Xv(a-d,o=m-d,E,I),F=Xv(a-d,o,D,L),z=Xv(a-d,o,M,Z),s="late afternoon"):a<y&&(N=Xv(a-m,o=y-m,I,_),F=Xv(a-m,o,L,x),z=Xv(a-m,o,Z,b),s="sun setting");var U=0;switch(r){case"rainy":case"foggy":U=.9;case"snowy":U=.5}U>0&&(F=Wv(F,U),z=Wv(z,U));var V=(0,Vu.c)(F[0],F[1],F[2]),B=(0,Vu.c)(z[0],z[1],z[2]),G=qv(r);return{direct:{intensity:N[0]*G.direct,color:V},ambient:{intensity:N[1]*G.ambient,color:B},timeOfDay:s}}(e,o,n);else{var c=qv(n);u={direct:{intensity:zv.local.directAtNoon*c.direct,color:(0,Vu.c)(1,1,1)},ambient:{intensity:zv.local.ambientAtNoon*c.ambient,color:(0,Vu.c)(1,1,1)},timeOfDay:"early afternoon"}}(0,Vu.A)(a.ambient.color,u.ambient.color,a.ambient.color,l),a.ambient.intensity=(0,Vu.Z)(u.ambient.intensity,a.ambient.intensity,l),(0,Vu.A)(a.direct.color,u.direct.color,a.direct.color,l),a.direct.intensity=(0,Vu.Z)(u.direct.intensity,a.direct.intensity,l),a.specularStrength="rainy"===n||"snowy"===n||"foggy"===n?0:1,a.environmentStrength="rainy"===n?.7:"snowy"===n||"foggy"===n?.75:1}a.noonFactor=(0,Nu.r)(e)?function(e,t){var r,n,i=e.valueOf();t.polarException===Fv.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=r+432e6):t.polarException===Fv.PolarException.POLAR_NIGHT?(r=i-2,n=i-1):(r=t.sunrise.valueOf(),n=t.sunset.valueOf());var a=r+(n-r)/2;return 1-(0,Vu.a)(Math.abs(i-a)/432e5,0,1)}(e,o):1,(0,Nu.r)(e)?function(e,t,r,n){var i=jv,a=(0,Wu.r)(Hv);if(r===ic.l.Global)Fv.getPosition(e,0,0,i),(0,Vu.o)(n,0,0,-1),(0,Wu.b)(a,a,-i.azimuth),(0,Wu.l)(a,a,-i.altitude),(0,Vu.O)(n,n,a);else{var o=zv.planarDirection,s=o.globalAngles,l=t[2],u=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);(u=(0,Vu.a)(u,0,1))<1?(Fv.getPosition(e,t[1],t[0],i),i.azimuth=(1-u)*i.azimuth+u*s.azimuth,i.altitude=(1-u)*i.altitude+u*s.altitude):(i.azimuth=s.azimuth,i.altitude=s.altitude),(0,Vu.o)(n,0,-1,0),(0,Wu.m)(a,a,-i.azimuth),(0,Wu.b)(a,a,-i.altitude),(0,Vu.O)(n,n,a)}}(e,t,r,a.direct.directionToLightSource):Vv(i,r,a.direct.directionToLightSource)}function Vv(e,t,r){t===ic.l.Global?(0,Vu.z)(Qv,e.eye):(0,Vu.o)(Qv,0,0,1),(0,Vu.g)(Kv,e.viewForward,-1);var n=(0,qu.x)(Kv,Qv),i=Math.max(n-2*$v,0),a=.85*i/(i+1),o=Math.max($v,n-$v-a);(0,Wu.g)(Yv,-o,e.viewRight),(0,Vu.O)(r,Kv,Yv),(0,Vu.u)(r,r,(0,Vu.g)(Jv,e.viewRight,em)),(0,Vu.z)(r,r)}var Bv=(0,Vu.c)(.5773502691896258,-.5773502691896258,.5773502691896258),Gv=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.ambient={color:(0,Vu.c)(1,1,1),intensity:.55},this.direct={color:(0,Vu.c)(1,1,1),intensity:.55,directionToLightSource:(0,Vu.t)(Bv)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1})),Hv=(0,hc.e)(),jv={azimuth:0,altitude:0};function qv(e){switch(e){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function Wv(e,t){for(var r=(e[0]+e[1]+e[2])/3,n=0;n<3;n++)e[n]=e[n]+(r-e[n])*t;return e}function Xv(e,t,r,n){for(var i=[],a=0;a<r.length;a++)i[a]=(n[a]-r[a])*e/t+r[a];return i}var Yv=(0,hc.e)(),Qv=(0,Vu.n)(),Kv=(0,Vu.n)(),Jv=(0,Vu.n)(),$v=.25,em=.2,tm=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.call(this))._referencePointUpdateDelay=200,e._referencePointUpdateInterval=3e3,e._referencePointUpdateDistThreshold=1e6,e._referencePosUpdateQuery=null,e._referencePosMapCoordsRequested=null,e._viewHandles=new Eu.X,e._preserveAbsoluteDateTime=!1,e._trackingEnabled=!1,e._referencePosResetPreserveAbsoluteTime=!1,e._referencePosUpdateTimer=null,e._referencePosMapCoords=null,e._mainLight=new dc.P,e._ambientLight=new dc.Q,e._moonLight=new dc.R,e.disableQueries=!1,e._disableWeather=!1,e._renderer=null,e._referencePosWGS84Comparable=null,e._resetReferencePosition(),e}return(0,ku.Z)(r,[{key:"destroy",value:function(){this.disconnectView(),this._viewHandles.destroy()}},{key:"_view",get:function(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.view}},{key:"updating",get:function(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&(null===(e=this._renderer)||void 0===e||!e.updating))}},{key:"weatherEnabled",get:function(){var e,t,r;return(null===(e=this._view)||void 0===e?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&(null===(t=this._view)||void 0===t||null===(r=t.state)||void 0===r?void 0:r.viewingMode)===ic.l.Global&&(0,Yu.A)(this._view.spatialReference)}},{key:"weatherVisible",get:function(){var e;return this.weatherEnabled&&(null===(e=this._renderer)||void 0===e?void 0:e.weatherVisible)}},{key:"referencePositionWGS84Comparable",get:function(){return this._referencePosWGS84Comparable}},{key:"connectView",value:function(e){var t=this;if(!this._renderer){this._renderer=new Av({view:e});var r=function(){return t._updateRenderParameters()},n=function(){return t._cameraHandler()};this._viewHandles.add([(0,Fu.l)((function(){return e.environment.lighting}),(function(e){return t._updateLightingHandler(e)}),Fu.U),(0,Fu.l)((function(){return"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null}),(function(e){return t._lightingDateHandler(e)}),Fu.U),(0,Fu.l)((function(){return e.stationary}),(function(){return t._interactingStationaryHandler()})),(0,Fu.l)((function(){return e.environment.lighting.directShadowsEnabled}),r,Fu.U),(0,Fu.l)((function(){return e.environment.lighting.ambientOcclusionEnabled}),r,Fu.U),(0,Fu.l)((function(){return e.environment.lighting.waterReflectionEnabled}),r,Fu.U),(0,Fu.l)((function(){var t;return null===(t=e.environment.background)||void 0===t?void 0:t.color}),r,Fu.U),(0,Fu.l)((function(){return e.spatialReference}),(function(){return t._resetReferencePosition(!0)}),Fu.U),(0,Fu.l)((function(){return e.environment.weather.type}),(function(){return t._updateLighting(null,gv.Faded)}),Fu.U),(0,Fu.l)((function(){return t.weatherEnabled}),(function(){return t._updateLighting(null,gv.Faded)}),Fu.U),(0,Fu.l)((function(){return e.viewingMode}),(function(){return t._resetReferencePosition(!0)}),Fu.w),(0,Fu.l)((function(){return"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled}),(function(e){return t._updateCameraTracking(e)}),Fu.w),(0,Fu.l)((function(){return e.state.camera}),n,Fu.w),(0,Fu.l)((function(){return t.disableQueries}),n)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}}},{key:"disconnectView",value:function(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=(0,Nu.g)(this._renderer)}},{key:"_updateLightingHandler",value:function(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}},{key:"_updateCameraTracking",value:function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{var t=this._view.environment.lighting;"virtual"!==(null===t||void 0===t?void 0:t.type)&&(t.positionTimezoneInfo.autoUpdated=!1)}}},{key:"_lightingDateHandler",value:function(e){var t=this._view.environment.lighting;if("virtual"!==(null===t||void 0===t?void 0:t.type)){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var r=this._view.spatialReference;if(!(0,Hu.R)(r)){var n=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(n))return void this._requestReferencePositionUpdate(n)}if(this._preupdateTracking(e),(0,Nu.r)(this._referencePosWGS84Comparable)){var i=(0,qu.h)(this._referencePosWGS84Comparable,lm);(0,Nu.r)(i)&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}},{key:"_preupdateTracking",value:function(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}},{key:"_cameraHandler",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._view;if(t.ready){var r=t.stateManager.camera;r&&(this._cameraHandlerClientSide(r,e)||this._cameraHandlerServerSide(r))}}},{key:"_cameraHandlerClientSide",value:function(e,t){var r=(0,Yu.A)(this._view.spatialReference);if(r&&!(0,Hu.R)(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;var n=e.position;return(0,Nu.t)(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=(0,Vu.n)()),r?(0,Hu.y)(n,this._referencePosWGS84Comparable):(0,Vu.o)(this._referencePosWGS84Comparable,n.longitude,n.latitude,n.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}},{key:"_cameraHandlerServerSide",value:function(e){var t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}},{key:"_interactingStationaryHandler",value:function(){this._view.stationary&&this._executePendingReferencePositionUpdate()}},{key:"_updateLighting",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:gv.Immediate,r=this._view;e=e||("virtual"===r.environment.lighting.type?null:r.environment.lighting.date);var n=this._referencePosWGS84Comparable,i=(0,Nu.r)(n)?am:om,a=this.weatherVisible?r.environment.weather.type:"disabled";(0,Nu.r)(n)?Uv(e,n,r.state.viewingMode,a,r.state.camera,i):"virtual"===r.environment.lighting.type&&Vv(r.state.camera,r.state.viewingMode,i.direct.directionToLightSource);var o=this._mainLight,s=i.direct;(0,Vu.g)(o.intensity,s.color,s.intensity*Math.PI),(0,Vu.r)(o.direction,s.directionToLightSource),o.specularStrength=i.specularStrength,o.environmentStrength=i.environmentStrength;var l=this._ambientLight;(0,Vu.g)(l.intensity,i.ambient.color,i.ambient.intensity);var u=this._moonLight;(0,Vu.A)(u.intensity,um,cm,i.globalFactor);var c=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));(0,Vu.g)(u.intensity,u.intensity,c),(0,Vu.r)(u.direction,s.directionToLightSource),this._renderer.updateLightSources([o,l,u],i.noonFactor,i.globalFactor,t),this._updateRenderParameters()}},{key:"_autoUpdateTimezone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||(0,Nu.t)(e))return!1;var r=sm;r.setTime((t||this._view.environment.lighting.date).getTime());var n=(0,qu.h)(e,lm);if((0,Nu.t)(n))return!1;var i=this._view.environment.lighting.positionTimezoneInfo;if(i.autoUpdated){if(i.hours===n.hours&&i.minutes===n.minutes&&i.seconds===n.seconds)return!1}else i=n;var a=r.getUTCHours()-(n.hours-i.hours),o=r.getUTCMinutes()-(n.minutes-i.minutes),s=r.getUTCSeconds()-(n.seconds-i.seconds);return r.setUTCHours(a),r.setUTCMinutes(o),r.setUTCSeconds(s),!t&&this._view.environment.lighting.autoUpdate(r,n)}},{key:"_updateRenderParameters",value:function(){var e=this,t=this._view._stage;if(t){var r=(0,Nu.u)(this._referencePosWGS84Comparable,!0,(function(t){return function(e,t){if(t===ic.l.Global)return!0;var r=zv.planarDirection;return Math.abs(e)<r.localAltitude}(t[2],e._view.state.viewingMode)})),n=this._view.environment.background,i=n instanceof qu.f?{type:"color",color:(0,lc.e)(sc.l.toUnitRGBA(n.color))}:{type:"color",color:(0,lc.r)(0,0,0,1)};t.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,background:i,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}}},{key:"_resetReferencePosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}},{key:"_requestReferencePositionUpdate",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!r,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){var n=this._referencePosUpdateQuery=(0,Eu.ab)(this._referencePointUpdateDelay).then((function(){if(t._referencePosUpdateQuery===n){return t._doReferencePositionUpdateQuery((function(){return t._referencePosUpdateQuery!==n}))}})).catch((function(e){"mapcoordshelper:missing-geometry-service"===e.name&&(t.disableQueries=!0)})).then((function(){t._referencePosUpdateQuery===n&&(t._referencePosUpdateQuery=null,t._referencePosUpdateTimer||t._executePendingReferencePositionUpdate(),t.notifyChange("updating"))})),i=this._referencePosUpdateTimer=(0,Eu.ab)(this._referencePointUpdateInterval).then((function(){t._referencePosUpdateTimer===i&&(t._referencePosUpdateTimer=null,t._referencePosUpdateQuery||t._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}},{key:"_doReferencePositionUpdateQuery",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null,e.next=3,this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);case 3:r=e.sent,t()||isNaN(r[0])||isNaN(r[1])||(n=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=r[0],this._referencePosWGS84Comparable[1]=r[1],this._referencePosWGS84Comparable[2]=n):this._referencePosWGS84Comparable=[r[0],r[1],n],this._referencePosChanged());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_executePendingReferencePositionUpdate",value:function(){var e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}},{key:"_referencePosChanged",value:function(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}},{key:"_exceedsReferencePosDistThreshold",value:function(e){if(this._referencePosMapCoords){var t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}},{key:"_cancelReferencePosUpdates",value:function(){var e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}},{key:"test",get:function(){var e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}}]),r}(ec.n.EventedAccessor);(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],tm.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"disableQueries",void 0),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"_disableWeather",void 0),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"weatherEnabled",null),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"weatherVisible",null),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"referencePositionWGS84Comparable",null),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"_renderer",void 0),(0,Eu.e)([(0,Eu.y)()],tm.prototype,"_referencePosWGS84Comparable",void 0),tm=(0,Eu.e)([(0,Eu.n)("esri.views.3d.environment.SceneViewEnvironmentManager")],tm);var rm,nm,im,am=new Gv,om=new Gv,sm=new Date,lm={hours:0,minutes:0,seconds:0},um=(0,Vu.c)(.22,.22,.33),cm=(0,Vu.c)(.22,.22,.22);function hm(e,t){return 0!=(e&t)}function dm(e,t,r,n,i,a){0!==e&&(r?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=n?(a.min-=Math.max(0,(t-a.min)*(1-n)),a.max+=Math.max(0,(t-a.max)*(1-n))):i&&(a.min-=Math.max(0,t-a.min-i),a.max+=Math.max(0,t-a.max-i)))}!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(rm||(rm={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(nm||(nm={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(im||(im={}));var fm={selection:rm.NONE,interactionType:nm.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:im.TUMBLE};function pm(e,t,r,n){return t=t||e.viewForward,(0,Vu.r)(n,t),(0,Vu.g)(n,n,Math.sign((0,Vu.P)(t,r))),n}function vm(e,t,r,n){return function(e,t,r,n){n.clip[0]=0,n.clip[1]=r?n.len:Number.MAX_VALUE;for(var i=0;i<e.length;i++)if(!gm(e[i],t,n))return!1;return!0}(e,t,r,function(e,t,r,n){var i=ym;return e?(r&&n&&(i.len=(0,Vu.x)(t,r)),(0,Vu.r)(i.dir,e)):n?(i.len=(0,Vu.x)(t,r),(0,Vu.e)(i.dir,r,t),(0,Vu.g)(i.dir,i.dir,1/i.len)):((0,Vu.e)(i.dir,r,t),(0,Vu.z)(i.dir,i.dir)),i}(n,t,r,!0))}function mm(e,t,r,n){var i=(0,Vu.P)(r,(0,Vu.e)(e,n,t));return(0,Vu.u)(e,t,(0,Vu.g)(e,r,i))}var ym={dir:(0,Vu.n)(),len:0,clip:(0,cc.n)()};function gm(e,t,r){var n=(0,Vu.P)((0,Tc.Y)(e),r.dir),i=-(0,Tc.R)(e,t);if(i<0&&n>=0)return!1;if(n>-1e-6&&n<1e-6)return i>0;if((i<0||n<0)&&!(i<0&&n<0))return!0;var a=i/n;return n>0?a<r.clip[1]&&(r.clip[1]=a):a>r.clip[0]&&(r.clip[0]=a),r.clip[0]<=r.clip[1]}function _m(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm;if(!bm(e,r))return 0;var n=Tm(e.state.constraints.altitude,Cm);xm(e,r,n);var i=e.renderCoordsHelper.getAltitude(t.eye),a=(0,Vu.a)(i,n.min,n.max)-i;return Math.abs(a)<=1e-6?0:a}function bm(e,t){var r=e.state.constraints.altitude;return!(!e.state.isGlobal||!r)&&(t.interactionType!==nm.TUMBLE||!hm(t.selection,rm.TILT))}function xm(e,t,r){var n=t.interactionType;if(n!==nm.NONE){var i=r.min,a=r.max,o=t.interactionStartCamera,s=t.interactionFactor,l=n===nm.TUMBLE||n===nm.ZOOM,u=_m(e,o),c=0===u?0:e.renderCoordsHelper.getAltitude(o.eye);r.min=i,r.max=a,dm(u,c,l,s,.05*c,r)}}function wm(e,t,r,n){return e.renderCoordsHelper.worldUpAtPosition(t.eye,n),(0,Vu.g)(n,n,r),n}function Tm(e,t){return t.min=e.min,t.max=e.max,t}var Cm={min:0,max:0},Sm=(0,Vu.n)(),Om=(0,Vu.n)(),Pm=(0,Vu.n)(),Rm=(0,Vu.n)();function Am(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm;if(!e.state.isLocal)return 0;var n=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||n===1/0)return 0;Im.min=0,Im.max=n,km(e,r,Im);var i=Em(e,t),a=Im.max-i;return a>=-1e-6?0:a}function km(e,t,r){var n=t.interactionType;if(n!==nm.NONE){var i=r.min,a=r.max,o=t.interactionStartCamera,s=t.interactionFactor,l=n===nm.ZOOM||n===nm.PAN,u=Am(e,o),c=0===u?0:Em(e,o);r.min=i,r.max=a,dm(u,c,l,s,.05*c,r)}}function Em(e,t){var r=e.pointsOfInterest.surfaceOrigin;return(0,Vu.x)(t.eye,r.renderLocation)}function Dm(e,t,r){var n=e.pointsOfInterest.surfaceOrigin;return(0,Vu.H)(r,t.eye,n.renderLocation)}var Mm,Im={min:0,max:0},Lm=(0,Vu.n)(),Zm=(0,Vu.n)(),Nm=(0,Vu.n)(),Fm=(0,Vu.n)(),zm=(0,Vu.n)();function Um(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mm.EYE,n=e.state.constraints;if(!n.collision.enabled)return!1;var i=(0,qu.m)(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),o=i+n.collision.elevationMargin;if(a>=o)return!1;var s=(0,Vu.s)(t.eye);if((0,Vu.e)(Vm,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Bm,o,t.eye),r===Mm.EYE_AND_CENTER)t.center=(0,Vu.u)(Vm,t.eye,Vm);else if(r===Mm.EYE_AND_CENTER_SCALE){var l=(s-a+o)/s;t.center=(0,Vu.g)(Vm,t.center,l)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Mm||(Mm={}));var Vm=(0,Vu.n)(),Bm=(0,Vu.n)();function Gm(e,t,r){e.worldUpAtPosition(t,Hm),(0,Vu.e)(jm,r,t);var n=(0,Vu.s)(jm);return 0===n?0:(0,Vu.i)((0,Vu.P)(jm,Hm)/n)}var Hm=(0,Vu.n)(),jm=(0,Vu.n)();function qm(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:fm,i=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;var a=t.distance,o=e.state.constraints.tilt(a,ny);return Km(e,r,o),n.interactionType===nm.TUMBLE&&hm(n.selection,rm.ALTITUDE)&&Jm(e,n.interactionStartCamera,o),r.tiltMode===im.LOOK_AROUND||n.tiltMode===im.LOOK_AROUND?Xm(e,t,o,i):Wm(e,t,o)}function Wm(e,t,r){var n=Gm(e.renderCoordsHelper,t.center,t.eye),i=n-(0,Vu.a)(n,r.min,r.max);return Ym(i)?i:0}function Xm(e,t,r,n){switch(n&&(n.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,r,n){var i,a,o=function(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,i=n+(0,Xu.u)(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,n,ty);return r.eyeCenterDistance=t.distance,r.centerIsOnSurface=!1,(0,Nu.r)(a)?(r.eyeCenterDistance=(0,Vu.x)(t.eye,a),r.tiltAtCenter=Gm(e.renderCoordsHelper,a,t.eye),r.centerIsOnSurface=!0):e.state.isLocal?r.tiltAtCenter=Gm(e.renderCoordsHelper,t.center,t.eye):((0,Qu.Y)((0,Qu.O)(Qu.W,i),t.ray,ty),r.eyeCenterDistance=(0,Vu.x)(t.eye,ty),r.tiltAtCenter=(0,Vu.i)(-(0,Vu.P)(t.viewForward,(0,Vu.z)(ty,ty)))),r.radius=i,r.eyeRadius=(0,Vu.s)(t.eye),r.constraints=e.state.constraints,r}(e,t,iy),s=(0,Vu.a)(o.tiltAtCenter,r.min,r.max);return Ym(o.tiltAtCenter-s)?(o.centerIsOnSurface?(i=function(e){var t=e.constraints,r=e.eyeCenterDistance,n=e.tiltAtCenter,i=n,a=t.clampTilt(r,n),o=Qm(e,a);if(t.clampTilt(o,n)===a)return a;for(var s=0;s<10&&Ym(a-i);){var l=(i+a)/2,u=Qm(e,l);Ym(t.clampTilt(u,l)-l)?i=l:a=l,s++}return a}(o),a=function(e,t){var r=(0,Vu.N)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),n=(0,Vu.N)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-n:n-r}(o,i)):(i=o.constraints.clampTilt(o.eyeCenterDistance,o.tiltAtCenter),n&&i<Math.PI/2&&(n.requiresTwoSteps=!0,i=Math.PI/2-1e-5),a=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(o,i)),n&&(n.eyeCenterDistance=Qm(o,i)),a):0}(e,t,r,n);case"local":return function(e,t,r,n){var i=Gm(e.renderCoordsHelper,t.center,t.eye),a=(0,Vu.a)(i,r.min,r.max),o=i-a;if(!Ym(o))return 0;if(n){var s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-s,u=Math.cos(a);Math.abs(u)>1e-4?n.eyeCenterDistance=l/u:n.eyeCenterDistance=t.distance}return o}(e,t,r,n);default:return void(0,Ac.n)()}}function Ym(e){return Math.abs(e)>1e-9}function Qm(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;var r=Math.PI-(0,Vu.a)(t,0,Math.PI),n=(0,Vu.N)(e.radius/e.eyeRadius*Math.sin(r)),i=Math.PI-r-n,a=Math.sin(i)/Math.sin(r);if(e.eyeRadius<e.radius&&a>1){var o=Math.PI-n,s=Math.PI-r-o;return Math.sin(s)/Math.sin(r)*e.eyeRadius}return a*e.eyeRadius}function Km(e,t,r){if(t.interactionType!==nm.NONE){var n=t.interactionStartCamera,i=t.interactionFactor,a=r.min,o=r.max,s=qm(e,n,fm,t),l=0===s?0:Gm(e.renderCoordsHelper,n.center,n.eye);r.min=a,r.max=o,t.interactionType===nm.TUMBLE?(hm(t.selection,rm.ALTITUDE)&&Jm(e,n,r),dm(s,l,!0,i,ry,r)):dm(s,l,!1,i,ry,r)}}function Jm(e,t,r){if(!e.state.isLocal){var n=e.state.constraints;if(n.altitude){var i=(0,Vu.v)(t.center),a=Math.sqrt(i),o=t.distance,s=(0,Xu.u)(e.spatialReference).radius,l=n.altitude.min+s,u=n.altitude.max+s,c=(l*l-o*o-i)/(-2*a*o),h=(u*u-o*o-i)/(-2*a*o);r.min=Math.max(r.min,Math.min(Math.PI-(0,Vu.i)(h),r.max)),r.max=Math.min(r.max,Math.PI-(0,Vu.i)(c))}}}var $m=(0,Vu.n)(),ey=(0,hc.e)(),ty=(0,Vu.n)(),ry=(0,Vu.m)(5),ny={min:0,max:0},iy={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},ay={eyeCenterDistance:0,requiresTwoSteps:!1};var oy=function(e){return e*e},sy=function(e){return 1-oy(1-e)},ly=function(e){return e*e*e},uy=function(e){return 1-ly(1-e)},cy=function(e){return e<.5?ly(2*e)/2:(uy(2*(e-.5))+1)/2},hy=function(e){return e*e*e*e},dy=function(e){return 1-hy(1-e)},fy=function(e){return e*e*e*e*e},py=function(e){return 1-fy(1-e)},vy=function(e){return 1-Math.cos(e*Math.PI/2)},my=function(e){return 1-vy(1-e)},yy=function(e){return Math.pow(2,10*(e-1))},gy=function(e){return 1-yy(1-e)},_y=function(e){return-(Math.sqrt(1-e*e)-1)},by=function(e){return 1-_y(1-e)};function xy(e){var t=2*(e-Math.sqrt((e-1)*e)),r=t/2/e;return function(n){return n<r?e*n*n:t*n-t+1}}function wy(e,t){return function(r,n){return r<t?t*e(r/t,n):1-e((1-r)/(1-t),n)*(1-t)}}var Ty=wy(xy(1),1),Cy=wy(xy(1),0),Sy=wy(xy(1),.5),Oy=wy(xy(2),1),Py=wy(xy(2),0),Ry=wy(xy(2),.5),Ay=wy(xy(3),1),ky=wy(xy(3),0),Ey=wy(xy(3),.5),Dy=wy(xy(4),1),My=wy(xy(4),0),Iy=wy(xy(4),.5),Ly={linear:function(e){return e},"in-quad":oy,"out-quad":sy,"in-out-quad":function(e){return e<.5?oy(2*e)/2:(sy(2*(e-.5))+1)/2},"in-coast-quad":Ty,"out-coast-quad":Cy,"in-out-coast-quad":Sy,"in-cubic":ly,"out-cubic":uy,"in-out-cubic":cy,"in-coast-cubic":Oy,"out-coast-cubic":Py,"in-out-coast-cubic":Ry,"in-quart":hy,"out-quart":dy,"in-out-quart":function(e){return e<.5?hy(2*e)/2:(dy(2*(e-.5))+1)/2},"in-coast-quart":Ay,"out-coast-quart":ky,"in-out-coast-quart":Ey,"in-quint":fy,"out-quint":py,"in-out-quint":function(e){return e<.5?fy(2*e)/2:(py(2*(e-.5))+1)/2},"in-coast-quint":Dy,"out-coast-quint":My,"in-out-coast-quint":Iy,"in-sine":vy,"out-sine":my,"in-out-sine":function(e){return e<.5?vy(2*e)/2:(my(2*(e-.5))+1)/2},"in-expo":yy,"out-expo":gy,"in-out-expo":function(e){return e<.5?yy(2*e)/2:(gy(2*(e-.5))+1)/2},"in-circ":_y,"out-circ":by,"in-out-circ":function(e){return e<.5?_y(2*e)/2:(by(2*(e-.5))+1)/2}};function Zy(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Vy,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;n!==t&&n.copyFrom(t),n.computeUp(e.state.viewingMode);for(var i=!1,a=0;a<By;a++){var o,s=0,l=(0,Cu.Z)(Uy);try{for(l.s();!(o=l.n()).done;){var u=o.value;if(hm(r.selection,u.type)){var c=Math.abs(u.error(e,n,r));u.apply(e,n,r)&&(i=!0,s+=c)}}}catch(f){l.e(f)}finally{l.f()}if(0===s)break}var h=hm(r.selection,rm.COLLISION),d=Ny(r.interactionType,e);return h&&Um(e,n,d)&&(i=!0),i&&n.computeUp(e.state.viewingMode),i}function Ny(e,t){switch(e){case nm.PAN:return Mm.EYE_AND_CENTER;case nm.ASCEND:return t.state.isGlobal?Mm.EYE_AND_CENTER_SCALE:Mm.EYE_AND_CENTER;default:return Mm.EYE}}function Fy(e){var t=Math.min(1,e/150);return cy(t)}var zy,Uy=[{type:rm.TILT,error:function(e,t,r){return qm(e,t,r)*t.distance},apply:function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];ay.eyeCenterDistance=0,ay.requiresTwoSteps=!1;var a=qm(t,r,n,void 0,ay);if(0===a)return!1;switch((0,Wu.g)(ey,-a,r.viewRight),n.tiltMode){case im.LOOK_AROUND:(0,Vu.O)($m,r.viewForward,ey),(0,Vu.g)($m,$m,ay.eyeCenterDistance),r.center=(0,Vu.u)(ty,r.eye,$m);break;case im.TUMBLE:(0,Vu.e)($m,r.center,r.eye),(0,Vu.O)($m,$m,ey),r.eye=(0,Vu.e)(ty,r.center,$m)}return r.up=(0,Vu.O)(ty,r.up,ey),!ay.requiresTwoSteps||!i||e(t,r,n,!1)}},{type:rm.ALTITUDE,error:_m,apply:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm,n=_m(e,t,r);if(0===n)return!1;var i=e.renderCoordsHelper,a=i.getAltitude(t.eye)+n,o=pm(t,r.interactionDirection,wm(e,t,Math.sign(n),Om),Sm),s=(0,Vu.r)(Pm,t.viewForward),l=i.intersectInfiniteManifold((0,Qu.p)(t.eye,o),a,Rm);return t.eye=(0,Nu.r)(l)?l:i.setAltitude(Rm,a,t.eye),t.center=mm(Rm,t.eye,s,t.center),!0}},{type:rm.DISTANCE,error:Am,apply:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fm,n=Am(e,t,r);if(0===n)return!1;var i=e.pointsOfInterest.surfaceOrigin,a=Em(e,t)+n,o=(0,Vu.r)(Lm,t.eye),s=pm(t,r.interactionDirection,Dm(e,t,Fm),Nm);if(!(0,Qu.z)((0,Qu.q)(i.renderLocation,a),(0,Qu.p)(t.eye,s),zm))return!1;t.eye=zm;var l=(0,Vu.e)(Zm,t.eye,o);t.center=(0,Vu.u)(zm,t.center,l);var u=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,u,zm);return(0,Nu.r)(c)&&(t.center=c),!0}}],Vy={selection:rm.ALL,interactionType:nm.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:im.TUMBLE},By=5,Gy=(0,Vu.n)(),Hy=(0,Vu.n)(),jy=(0,Vu.n)(),qy=(0,Vu.n)(),Wy=(0,Vu.n)(),Xy=(0,Vu.n)(),Yy={upward:(0,Vu.c)(0,0,1),forward:(0,Vu.c)(0,1,0),sideway:(0,Vu.c)(1,0,0)},Qy=(0,gc.e)(),Ky=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ic.l.Global;(0,Au.Z)(this,e),this.viewingMode=t,this.center=(0,Vu.n)(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=(0,Vu.t)(Yy.forward)}return(0,ku.Z)(e,[{key:"pixelsPerPanAtZoom",value:function(e){return this.size/2/(this._zoomToPanScale*e)}},{key:"zoomAtPixelsPerPan",value:function(e){return this.size/2/(this._zoomToPanScale*e)}},{key:"pixelsPerRotateAtZoom",value:function(){var e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}},{key:"compareTo",value:function(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===ic.l.Global){var r=((0,Vu.s)(this.center)+(0,Vu.s)(e.center))/2;t.pan=(0,qu.x)(this.center,e.center)*r}else t.pan=(0,Vu.x)(this.center,e.center);var n=Math.abs(e.yaw-this.yaw);n>=Math.PI&&(n=2*Math.PI-n);var i=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(n,i),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}},{key:"interpolate",value:function(e,t,r){this.viewingMode===ic.l.Global?(0,qu.k)(e.center,t.center,r.pan,this.center):(0,Vu.A)(this.center,e.center,t.center,r.pan),this.distance=isFinite(t.distance)?(0,Vu.Z)(e.distance,t.distance,r.zoom):e.distance,this.pitch=(0,Vu.Z)(e.pitch,t.pitch,r.rotate);var n=e.yaw,i=t.yaw;Math.abs(i-n)>=Math.PI&&(n+=2*(n<i?1:-1)*Math.PI),this.yaw=(0,Vu.Z)(n,i,r.rotate)}},{key:"copyFrom",value:function(e){(0,Vu.r)(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,(0,Vu.r)(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}},{key:"copyFromRenderCamera",value:function(e){var t=this._lookAtOrientation(e.center,Qy);(0,Vu.r)(this.center,e.center),(0,Vu.e)(qy,e.center,e.eye),(0,Vu.S)(qy,qy,t),(0,Vu.S)(Wy,e.up,t),this.distance=(0,Vu.s)(qy),0!==this.distance&&(qy[0]/=this.distance,qy[1]/=this.distance,qy[2]/=this.distance),this.pitch=this._eyeUpToPitch(qy),this.yaw=this._eyeUpToYaw(qy,Wy),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}},{key:"copyFromCommon",value:function(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}},{key:"copyToRenderCamera",value:function(e){var t=this._lookAtOrientation(this.center,Qy);(0,mc.o)(t,t),this._axisAngleVec3(Yy.sideway,this.pitch-Math.PI/2,Yy.forward,qy),this._axisAngleVec3(Yy.upward,this.yaw,qy),this._axisAngleVec3(Yy.sideway,this.pitch-Math.PI/2,Yy.upward,Wy),this._axisAngleVec3(Yy.upward,this.yaw,Wy),(0,Vu.g)(qy,qy,this.distance),(0,Vu.S)(qy,qy,t),(0,Vu.S)(Wy,Wy,t),e.center=this.center,e.eye=(0,Vu.e)(qy,this.center,qy),e.up=Wy}},{key:"_axisAngleVec3",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,i=Math.cos(t),a=Math.sin(t);return(0,Vu.g)(Gy,r,i),(0,Vu._)(Hy,e,r),(0,Vu.g)(Hy,Hy,a),(0,Vu.g)(jy,e,(1-i)*(0,Vu.P)(e,r)),(0,Vu.u)(n,(0,Vu.u)(n,Gy,Hy),jy)}},{key:"_lookAtOrientation",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,gc.e)();return this._upAtLookAt(e,jy),(0,Vu._)(Gy,this.lookAtDirection,jy),(0,Vu.z)(Gy,Gy),0===Gy[0]&&0===Gy[1]&&0===Gy[2]&&(0,Vu.r)(Gy,Yy.sideway),(0,Vu._)(Hy,jy,Gy),(0,Vu.z)(Hy,Hy),t[0]=Gy[0],t[1]=Hy[0],t[2]=jy[0],t[3]=Gy[1],t[4]=Hy[1],t[5]=jy[1],t[6]=Gy[2],t[7]=Hy[2],t[8]=jy[2],t}},{key:"_upAtLookAt",value:function(e,t){return this.viewingMode===ic.l.Local?(0,Vu.r)(t,Yy.upward):(0,Vu.z)(t,e)}},{key:"_eyeUpToPitch",value:function(e){return Math.PI-(0,qu.x)(Yy.upward,e)}},{key:"_eyeUpToYaw",value:function(e,t){var r=Xy;return Math.abs(t[2])<.5?((0,Vu.r)(r,t),e[2]>0&&(0,Vu.g)(r,r,-1)):(0,Vu.r)(r,e),(0,Vu._)(Hy,r,Yy.upward),(0,Vu.z)(Hy,Hy),(0,qu.x)(Yy.sideway,Hy,Yy.upward)}}]),e}(),Jy=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,Au.Z)(this,e),this._viewUp=(0,Vu.n)(),this._viewForward=(0,Vu.n)(),this._viewRight=(0,Vu.n)(),this._ray=(0,Qu.d)(),this._viewport=(0,lc.r)(0,0,1,1),this._padding=(0,lc.r)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,cc.r)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,hc.e)(),this._projectionDirty=!0,this._projectionMatrix=(0,hc.e)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,hc.e)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,hc.e)(),this._inverseProjectionDirty=!0,this._inverseProjectionMatrix=null,this._frustumDirty=!0,this._frustum=(0,kc.H)(),this._fullViewport=(0,lc.n)(),this._pixelRatio=1,this.relativeElevation=0,(0,Nu.r)(t)&&(0,Vu.r)(this._ray.origin,t),this._center=(0,Nu.r)(r)?(0,Vu.t)(r):(0,Vu.n)(),this._up=(0,Nu.r)(n)?(0,Vu.t)(n):(0,Vu.c)(0,0,1)}return(0,ku.Z)(e,[{key:"pixelRatio",get:function(){return this._pixelRatio},set:function(e){this._pixelRatio=e>0?e:1}},{key:"eye",get:function(){return this._ray.origin},set:function(e){this._compareAndSetView(e,this._ray.origin)}},{key:"center",get:function(){return this._center},set:function(e){this._compareAndSetView(e,this._center)}},{key:"ray",get:function(){return(0,Vu.e)(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(e){this._compareAndSetView(e,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(e){(0,Wu.n)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(e){e+=this._padding[zy.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(e){e+=this._padding[zy.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[zy.RIGHT]+this._padding[zy.LEFT]},set:function(e){this.width=e-(this._padding[zy.RIGHT]+this._padding[zy.LEFT])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[zy.TOP]+this._padding[zy.BOTTOM]},set:function(e){this.height=e-(this._padding[zy.TOP]+this._padding[zy.BOTTOM])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[zy.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[zy.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding[zy.TOP]===e[zy.TOP]&&this._padding[zy.RIGHT]===e[zy.RIGHT]&&this._padding[zy.BOTTOM]===e[zy.BOTTOM]&&this._padding[zy.LEFT]===e[zy.LEFT]||(this._viewport[0]+=e[zy.LEFT]-this._padding[zy.LEFT],this._viewport[1]+=e[zy.BOTTOM]-this._padding[zy.BOTTOM],this._viewport[2]-=e[zy.RIGHT]+e[zy.LEFT]-(this._padding[zy.RIGHT]+this._padding[zy.LEFT]),this._viewport[3]-=e[zy.TOP]+e[zy.BOTTOM]-(this._padding[zy.TOP]+this._padding[zy.BOTTOM]),(0,Vu.B)(this._padding,e),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&((0,Wu.u)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){var e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2),n=r*this.aspect;(0,Wu.A)(this._projectionMatrix,-n*(1+2*this._padding[zy.LEFT]/e),n*(1+2*this._padding[zy.RIGHT]/e),-r*(1+2*this._padding[zy.BOTTOM]/t),r*(1+2*this._padding[zy.TOP]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(e){(0,Wu.n)(this._projectionMatrix,e),this._projectionDirty=!1,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"inverseProjectionMatrix",get:function(){return(0,Nu.t)(this._inverseProjectionMatrix)&&(this._inverseProjectionMatrix=(0,hc.e)()),this._inverseProjectionDirty&&(0,Wu.h)(this._inverseProjectionMatrix,this.projectionMatrix),this._inverseProjectionMatrix}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return(0,Sc.g)(this._fov,this.width,this.height)},set:function(e){this._fov=(0,Sc.l)(e,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return(0,Sc.k)(this._fov,this.width,this.height)},set:function(e){this._fov=(0,Sc.m)(e,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return(0,Vu.x)(this._center,this.eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,Wu.h)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,Wu.o)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"depthNDCToWorld",value:function(e){var t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this._pixelRatio}},{key:"aboveGround",get:function(){return null!=this.relativeElevation&&this.relativeElevation>=0}},{key:"copyFrom",value:function(e){(0,Vu.r)(this._ray.origin,e.eye),(0,Vu.r)(this._center,e.center),(0,Vu.r)(this._up,e.up),(0,Vu.B)(this._viewport,e.viewport),(0,Vu.B)(this._padding,e.padding),(0,uc.a)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;var t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,Wu.n)(this._viewMatrix,e.viewMatrix),(0,Vu.r)(this._viewRight,e.viewRight),(0,Vu.r)(this._viewUp,e.viewUp),(0,Vu.r)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,Wu.n)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._inverseProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,kc.u)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,Wu.n)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,Vu.B)(this._fullViewport,e.fullViewport),this._pixelRatio=e.pixelRatio,this}},{key:"copyViewFrom",value:function(e){this.eye=e.eye,this.center=e.center,this.up=e.up}},{key:"clone",value:function(){return(new e).copyFrom(this)}},{key:"equals",value:function(e){return(0,Vu.F)(this.eye,e.eye)&&(0,Vu.F)(this._center,e.center)&&(0,Vu.F)(this._up,e.up)&&(0,Vu.Q)(this._viewport,e.viewport)&&(0,Vu.Q)(this._padding,e.padding)&&(0,uc.E)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this._pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}},{key:"almostEquals",value:function(e){if(this._pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;var t=5e-4;(0,Vu.a0)(tg,e.eye,e.center),(0,Vu.a0)(rg,this.eye,this._center);var r=(0,Vu.P)(tg,rg),n=(0,Vu.a5)(tg),i=(0,Vu.a5)(rg);return r*r>=(1-1e-10)*n*i&&(0,Vu.a3)(e.eye,this.eye)<Math.max(n,i)*t*t&&(0,Vu.a4)(e.padding,this._padding)<.5&&(0,Vu.a4)(e.viewport,this._viewport)<.5}},{key:"computeRenderPixelSizeAt",value:function(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}},{key:"computeRenderPixelSizeAtDist",value:function(e){return e*this.perRenderPixelRatio}},{key:"computeScreenPixelSizeAt",value:function(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}},{key:"_viewDirectionDistance",value:function(e){return Math.abs((0,Qu.f)(this.viewForward,(0,Vu.e)(tg,e,this.eye)))}},{key:"computeScreenPixelSizeAtDist",value:function(e){return e*this.perScreenPixelRatio}},{key:"computeDistanceFromRadius",value:function(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}},{key:"getScreenCenter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,zu.i)();return e[0]=(this.padding[zy.LEFT]+this.width/2)/this._pixelRatio,e[1]=(this.padding[zy.TOP]+this.height/2)/this._pixelRatio,e}},{key:"getRenderCenter",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e[0]=this.padding[zy.LEFT]+this.width*t,e[1]=this.padding[zy.BOTTOM]+this.height*r,e[2]=.5,e}},{key:"setGLViewport",value:function(e){var t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}},{key:"applyProjection",value:function(e,t){e!==$y&&(0,Vu.r)($y,e),$y[3]=1,(0,Vu.w)($y,$y,this.projectionMatrix);var r=Math.abs($y[3]);(0,Vu.g)($y,$y,1/r);var n=this.fullViewport;t[0]=(0,Vu.Z)(0,n[0]+n[2],.5+.5*$y[0]),t[1]=(0,Vu.Z)(0,n[1]+n[3],.5+.5*$y[1]),t[2]=.5*($y[2]+1),t[3]=r}},{key:"unapplyProjection",value:function(e,t){var r=this.fullViewport;$y[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],$y[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],$y[2]=(2*e[2]-1)*e[3],$y[3]=e[3],(0,Vu.w)($y,$y,this.inverseProjectionMatrix),t[0]=$y[0],t[1]=$y[1],t[2]=$y[2]}},{key:"projectToScreen",value:function(e,t){return this.projectToRenderScreen(e,ng),this.renderToScreen(ng,t),t}},{key:"projectToRenderScreen",value:function(e,t){if($y[0]=e[0],$y[1]=e[1],$y[2]=e[2],$y[3]=1,(0,Vu.w)($y,$y,this.viewProjectionMatrix),0===$y[3])return null;(0,Vu.g)($y,$y,1/Math.abs($y[3]));var r=this.fullViewport;return"x"in t?(t.x=(0,Vu.Z)(0,r[0]+r[2],.5+.5*$y[0]),t.y=(0,Vu.Z)(0,r[1]+r[3],.5+.5*$y[1])):(t[0]=(0,Vu.Z)(0,r[0]+r[2],.5+.5*$y[0]),t[1]=(0,Vu.Z)(0,r[1]+r[3],.5+.5*$y[1]),t.length>2&&(t[2]=.5*($y[2]+1))),t}},{key:"unprojectFromScreen",value:function(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,ng),t)}},{key:"unprojectFromRenderScreen",value:function(e,t){if((0,Wu.u)(eg,this.projectionMatrix,this.viewMatrix),!(0,Wu.h)(eg,eg))return null;var r=this.fullViewport;return $y[0]=2*(e[0]-r[0])/r[2]-1,$y[1]=2*(e[1]-r[1])/r[3]-1,$y[2]=2*e[2]-1,$y[3]=1,(0,Vu.w)($y,$y,eg),0===$y[3]?null:(t[0]=$y[0]/$y[3],t[1]=$y[1]/$y[3],t[2]=$y[2]/$y[3],t)}},{key:"constrainWindowSize",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,i=e*this._pixelRatio,a=t*this._pixelRatio,o=Math.max(i-r/2,0),s=Math.max(this.fullHeight-a-n/2,0),l=-Math.min(i-r/2,0),u=-Math.min(this.fullHeight-a-n/2,0);return[o,s,r-l- -Math.min(this.fullWidth-i-r/2,0),n-u- -Math.min(a-n/2,0)]}},{key:"computeUp",value:function(e){e===ic.l.Global?this._computeUpGlobal():this._computeUpLocal()}},{key:"screenToRender",value:function(e,t){var r=e[0]*this._pixelRatio,n=this.fullHeight-e[1]*this._pixelRatio;return t[0]=r,t[1]=n,t}},{key:"renderToScreen",value:function(e,t){var r=e[0]/this._pixelRatio,n=(this.fullHeight-e[1])/this._pixelRatio;t[0]=r,t[1]=n}},{key:"_computeUpGlobal",value:function(){(0,Vu.e)(tg,this.center,this.eye);var e=(0,Vu.s)(this.center);e<1?((0,Vu.o)(this._up,0,0,1),this._markViewDirty()):Math.abs((0,Vu.P)(tg,this.center))>.9999*(0,Vu.s)(tg)*e||((0,Vu._)(this._up,tg,this.center),(0,Vu._)(this._up,this._up,tg),(0,Vu.z)(this._up,this._up),this._markViewDirty())}},{key:"_computeUpLocal",value:function(){(0,Vu.H)(tg,this.eye,this.center),Math.abs(tg[2])<=.9999&&((0,Vu.g)(tg,tg,tg[2]),(0,Vu.o)(this._up,-tg[0],-tg[1],1-tg[2]),(0,Vu.z)(this._up,this._up),this._markViewDirty())}},{key:"_compareAndSetView",value:function(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,Vu.F)(e,t)||((0,Vu.r)(t,e),this._markViewDirty()):Eu.a.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}},{key:"_markViewDirty",value:function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}},{key:"_recomputeFrustum",value:function(){this._frustumDirty&&((0,kc.s)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}},{key:"_ensureViewClean",value:function(){this._viewDirty&&((0,Wu.Q)(this._viewMatrix,this.eye,this._center,this._up),(0,Vu.o)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,Vu.o)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,Vu.o)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}]),e}(),$y=(0,lc.n)(),eg=(0,hc.e)(),tg=(0,Vu.n)(),rg=(0,Vu.n)(),ng=(0,zu.x)();!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(zy||(zy={}));var ig=2,ag=(0,Eu.aj)(500),og=(0,Eu.aj)(8e3),sg=function(){function e(t){(0,Au.Z)(this,e),this._createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:ig},this.source=t(),this.target=t()}return(0,ku.Z)(e,[{key:"clone",value:function(){var t=new e(this._createCamera);return t.copyFrom(this),t}},{key:"copyFrom",value:function(e){this.update(e.source,e.target,e.settings)}},{key:"update",value:function(e,t,r){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=r.desiredScreenFlow?r.desiredScreenFlow:ig,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}},{key:"halfWindowPanAtZoom",value:function(e){var t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}},{key:"hasZoom",get:function(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}},{key:"hasPan",get:function(){return this.compared.pan>1e-9}},{key:"hasRotate",get:function(){return this.compared.rotate>1e-9}}]),e}(),lg=function(){function e(){(0,Au.Z)(this,e),this.segments=[]}return(0,ku.Z)(e,[{key:"time",get:function(){return this.segments.reduce((function(e,t){return(0,Eu.ar)(e+t.time)}),(0,Eu.ar)(0))}},{key:"interpolateComponentsAt",value:function(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;for(var r=0,n=0,i=this.definition,a=0;a<this.segments.length;a++){var o=this.segments[a],s=o.definition;if(e<=o.time||a===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(o,0===o.time?0:e/o.time,t),i.hasPan&&!isNaN(t.pan)&&isFinite(i.compared.pan)?t.pan=(r+s.compared.pan*t.pan)/i.compared.pan:t.pan=1,i.hasRotate&&!isNaN(t.rotate)&&isFinite(i.compared.rotate)?t.rotate=(n+s.compared.rotate*t.rotate)/i.compared.rotate:t.rotate=1,i.hasZoom&&!isNaN(t.zoom)&&isFinite(s.compared.targetZoom)){var l=t.zoom*(s.compared.targetZoom-s.compared.sourceZoom)+s.compared.sourceZoom,u=this.segments[0].definition.compared.sourceZoom,c=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(l-u)/(c-u)}else t.zoom=1;return t}e-=o.time,r+=s.compared.pan,n+=s.compared.rotate}}},{key:"segmentInterpolateComponentsAt",value:function(e,t,r){return e.interpolateComponentsAt(t,r)}}]),e}(),ug=function(){function e(t){(0,Au.Z)(this,e),t&&this.update(t)}return(0,ku.Z)(e,[{key:"time",get:function(){return this._time}},{key:"update",value:function(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}},{key:"_updatePrecomputedVariables",value:function(){var e=this.definition,t=e.compared,r=t.sourceZoom,n=t.targetZoom;this._zoomSign=r>n?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(r);var i=(e.source.pixelsPerRotateAtZoom(r)+e.target.pixelsPerRotateAtZoom(n))/2;this._rotatePixels=t.rotate*i}},{key:"_updatePixelFlow",value:function(){var e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,r=this.definition,n=r.hasZoom,i=r.hasPan,a=r.hasRotate,o=0,s=0;n&&(i&&(o=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),a&&(s=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;var l=this.definition.desiredPixelFlow;if(n&&i&&a){var u=o+s+o*s;this._zoomPixelFlow=o*s/u*l,this._panPixelFlow=s/u*l,this._rotatePixelFlow=o/u*l}else if(n&&i){var c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(n&&a){var h=1+s;this._zoomPixelFlow=s/h*l,this._rotatePixelFlow=1/h*l}else if(i&&a){var d=this._panPixelsAtSource/this._rotatePixels,f=1+d;this._panPixelFlow=d/f*l,this._rotatePixelFlow=1/f*l}else i?this._panPixelFlow=l:n?this._zoomPixelFlow=l:a&&(this._rotatePixelFlow=l);this._time=a?this.rotateTime:n?this.zoomTime:i?this.panTime:(0,Eu.ar)(0)}},{key:"rotateTime",get:function(){return this.definition.hasRotate?(0,Eu.ar)(this._rotatePixels/this._rotatePixelFlow):(0,Eu.ar)(0)}},{key:"zoomTime",get:function(){return this.definition.hasZoom?(0,Eu.ar)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,Eu.ar)(0)}},{key:"panTime",get:function(){if(this.definition.hasPan){if(this.definition.hasZoom){var e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,Eu.ar)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,Eu.ar)(this._panPixelsAtSource/this._panPixelFlow)}return(0,Eu.ar)(0)}},{key:"_interpolateComponentsZoom",value:function(e){if(0===e||1===e)return e;if(this.definition.hasZoom){var t=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(t*Math.pow(t/r,-e)-t)/(r-t)}return e}},{key:"_interpolateComponentsPan",value:function(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){var t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(Math.pow(2,t*e*this._time)-1))/(t*Math.LN2)}return e}},{key:"_interpolateComponentsRotate",value:function(e){return e}},{key:"interpolateComponentsAt",value:function(e,t){e=Math.min(Math.max(e,0),1);var r=this._interpolateComponentsZoom(e),n=this._interpolateComponentsPan(e),i=this._interpolateComponentsRotate(e);return t?(t.zoom=r,t.pan=n,t.rotate=i):t={zoom:r,pan:n,rotate:i},t}}]),e}();function cg(e,t,r){var n=t-e.compared.sourceZoom,i=e.halfWindowPanAtZoom(n);return-e.halfWindowSize*(r.ascensionFactor*Math.LN2*e.compared.pan+i)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*i)}function hg(e,t,r){var n=1/t,i=Math.log(e.compared.sourceZoom*n),a=1/e.desiredPixelFlow,o=1/Math.LN2,s=t-e.compared.sourceZoom,l=1/s,u=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(s))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*a*o*l*u-e.halfWindowSize*i*a*o*l+e.halfWindowSize*i*a*o*u/(s*s)}function dg(e,t,r){var n=t-e.compared.sourceZoom,i=1/n,a=1/t,o=Math.log(e.compared.sourceZoom*a),s=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(n))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*(-2*i*a*s+2*i*o+2*a-2*o*s/(n*n)-s/(t*t))/(e.desiredPixelFlow*Math.LN2)}function fg(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function pg(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function vg(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function mg(e,t,r){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function yg(e,t,r){var n=Math.log(t/e.compared.targetZoom),i=1/e.desiredPixelFlow,a=1/Math.LN2,o=-t+e.compared.targetZoom,s=1/o,l=(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*n*i*a*s+e.halfWindowSize*n*i*a*l/(o*o)+e.halfWindowSize*i*a*s*l/t}function gg(e,t,r){var n=t-e.compared.targetZoom,i=1/n,a=1/t,o=Math.log(t/e.compared.targetZoom),s=(e.halfWindowPanAtZoom(t)+r.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*(-2*i*a*s-2*i*o+2*a+2*o*s/(n*n)-s/(t*t))/(e.desiredPixelFlow*Math.LN2)}function _g(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function bg(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function xg(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function wg(e,t){var r,n=function(e,t){var r=Math.max(e.compared.sourceZoom,e.compared.targetZoom),n=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return n<r?null!=t.maximumDistance?r+(t.maximumDistance-r)/2:1.5*r:t.maximumDistance?Math.min(t.maximumDistance,n):n}(e,t),i={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},a=0===i.ascensionFactor,o=0===i.descensionFactor,s=a?fg:cg,l=a?pg:hg,u=a?vg:dg,c=o?_g:mg,h=o?bg:yg,d=o?xg:gg,f=function(t){return s(e,t,i)+function(e,t,r){return-e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,i)+c(e,t,i)},p=function(t){return l(e,t,i)+function(e,t,r){return e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,i)+h(e,t,i)},v=function(t){return u(e,t,i)+function(e,t,r){return-2*e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,i)+d(e,t,i)},m=f(n),y=function(e){var t=Math.LN2*e.compared.pan,r=e.compared.sourceZoom-e.compared.targetZoom,n=e.halfWindowPanAtZoom(r),i=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*n);return e.compared.sourceZoom<=e.compared.targetZoom?i*(t-n):i*(t+n)}(e),g=t.maximumIterations||20,_=null!=t.maximumDistance?t.maximumDistance:1/0;for(r=0;r<g;r++){var b=(p(n)+1e-6)/v(n);if(isNaN(b)||n>=_&&b<0){if(!isFinite(_))return null;m=f(n=_);break}if((n-=b)<e.compared.sourceZoom||n<e.compared.targetZoom)return null;var x=f(n);if(Math.abs(x-m)/m<=.005)break;m=x}return m>.7*y||n<e.compared.sourceZoom||n<e.compared.targetZoom?null:n}var Tg,Cg=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this))._preallocSegments=[new ug,new ug,new ug],i.update(e,n),i}return(0,ku.Z)(r,[{key:"update",value:function(e,t){if(e){this.definition?this.definition.copyFrom(e):this.definition=e.clone();var r=null;t&&t.apex&&(r=wg(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==r?this._updateWithoutApex():this._updateWithApex(r,t.apex)}}},{key:"segmentInterpolateComponentsAt",value:function(e,t,r){return r=e.interpolateComponentsAt(t,r),e===this._ascensionSegment?r.zoom=sy(r.zoom):e===this._descensionSegment&&(r.zoom=oy(r.zoom)),r}},{key:"_updateWithApex",value:function(e,t){var r=(0,xu.Z)(this._preallocSegments,3),n=r[0],i=r[1],a=r[2],o=null!=t.ascensionFactor?t.ascensionFactor:.5,s=Math.min(1-o,null!=t.ascensionFactor?t.descensionFactor:.5),l=1-o-s;n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.targetZoom=e,n.definition.compared.pan=this.definition.compared.pan*o,n.definition.compared.rotate=this.definition.compared.rotate*o,n.update(),this._ascensionSegment=n,this.segments.push(n),l>0&&(i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.copyFrom(this.definition),i.definition.compared.sourceZoom=e,i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*l,i.definition.compared.rotate=this.definition.compared.rotate*l,i.update(),this.segments.push(i)),a.definition?a.definition.copyFrom(this.definition):a.definition=this.definition.clone(),a.definition.compared.sourceZoom=e,a.definition.compared.pan=this.definition.compared.pan*s,a.definition.compared.rotate=this.definition.compared.rotate*s,a.update(),this._descensionSegment=a,this.segments.push(a)}},{key:"_updateWithoutApex",value:function(){var e=(0,xu.Z)(this._preallocSegments,1)[0];e.update(this.definition),this.segments.push(e)}}]),r}(lg),Sg={zoom:0,pan:0,rotate:0},Og=function(){function e(t){(0,Au.Z)(this,e),this._createCamera=t,this._time=(0,Eu.aj)(0),this.definition=new sg(t),this.path=new Cg}return(0,ku.Z)(e,[{key:"time",get:function(){return this._time}},{key:"update",value:function(e,t,r){this.definition.update(e,t,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings((0,Eu.as)(isFinite(this.path.time)?this.path.time:(0,Eu.ar)(0)),r),this._easing=r.easing?r.easing:this._time>=1e3?Sy:gy}},{key:"cameraAt",value:function(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);var r=this.path.interpolateComponentsAt(e,Sg);return t.interpolate(this.definition.source,this.definition.target,r),t}},{key:"_normalizedEasing",value:function(e){var t=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(r-t)}},{key:"_applyTimeSettings",value:function(e,t){var r=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=(0,Eu.aj)(e/r));var n=null!=t.minDuration?t.minDuration:ag/r,i=null!=t.maxDuration?t.maxDuration:og/r;return(0,Eu.aj)(Math.min(Math.max(n,e),i))}}]),e}(),Pg=(0,Vu.n)(),Rg=function(){function e(t){(0,Au.Z)(this,e),this.currentTime=(0,Eu.aj)(0),this._animation=new Og((function(){return new Ky(t)})),this._current=new Ky(t)}return(0,ku.Z)(e,[{key:"finished",get:function(){return this.currentTime>=this._animation.time}},{key:"time",get:function(){return this._animation.time}},{key:"update",value:function(e,t,r){var n=this._animation.definition.source,i=this._animation.definition.target,a=(0,Vu.e)(Pg,t.center,e.center),o=(0,Vu.s)(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),(0,Vu.r)(n.lookAtDirection,a),(0,Vu.r)(i.lookAtDirection,a),n.copyFromRenderCamera(e),i.copyFromRenderCamera(t),this._current.copyFrom(n),this._animation.update(n,i,r),this.currentTime=(0,Eu.aj)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}},{key:"cameraAt",value:function(e,t){return this._animation.cameraAt(e,this._current),t=t||new Jy,this._current.copyToRenderCamera(t),t}},{key:"step",value:function(e,t){return this.finished||(this.currentTime=(0,Eu.aj)(this.currentTime+(0,Eu.as)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}]),e}();!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(Tg||(Tg={}));var Ag=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).state=Tg.Ready,n}return(0,ku.Z)(r,[{key:"active",get:function(){return this.state===Tg.Running}},{key:"isInteractive",get:function(){return!1}},{key:"canStop",get:function(){return!1}},{key:"stopController",value:function(){return!!this.canStop&&(this.state=Tg.Stopped,!0)}},{key:"finishController",value:function(){this.state=Tg.Finished}},{key:"steppingFinished",get:function(){return!1}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Ag.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Ag.prototype,"active",null),(0,Eu.e)([(0,Eu.y)()],Ag.prototype,"state",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Ag.prototype,"isInteractive",null);var kg=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._asyncResult=null,e}return(0,ku.Z)(r,[{key:"canStop",get:function(){return!0}},{key:"asyncResult",get:function(){return this._asyncResult},set:function(e){this._asyncResult&&(this._asyncResult.reject((0,Eu.d)()),this._asyncResult=null),this.state===Tg.Finished||this.state===Tg.Stopped?((0,Nu.E)(e),this.state===Tg.Finished?e.resolve():e.reject((0,Eu.d)())):this._asyncResult=e}},{key:"onControllerStart",value:function(){var e=this;this.state=Tg.Running,(0,Nu.r)(this.viewAnimation)&&this.viewAnimation.when((function(){return e.updateStateFromViewAnimation()}),(function(){return e.updateStateFromViewAnimation()}))}},{key:"updateStateFromViewAnimation",value:function(){!(0,Nu.r)(this.viewAnimation)||this.state!==Tg.Ready&&this.state!==Tg.Running||(this.viewAnimation.state===Ju.p.State.FINISHED?this.finish():this.viewAnimation.state===Ju.p.State.STOPPED&&(this.state=Tg.Stopped))}},{key:"onControllerEnd",value:function(){(0,Nu.r)(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===Tg.Finished?this.viewAnimation.finish():this.state===Tg.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Tg.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,Eu.d)()))}},{key:"finish",value:function(){this.finishController()}}]),r}(Ag=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.CameraController")],Ag)),Eg=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).mode="interaction",n._hasTarget=!1,n}return(0,ku.Z)(r,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this.animation=new Rg(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new Ju.p}},{key:"isInteractive",get:function(){return"interaction"===this.mode}},{key:"begin",value:function(e,t){this._hasTarget=!0;var r=this.animationSettings(t);Dg.copyFrom(this.view.state.camera);var n=(0,qu.g)(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Dg.ray,n,Mg)&&(Dg.center=Mg),this.animation.update(Dg,e,r),this.animation.finished&&this.finish()}},{key:"finish",value:function(){this.animation.currentTime=this.animation.time,(0,_u.Z)((0,bu.Z)(r.prototype),"finish",this).call(this)}},{key:"steppingFinished",get:function(){return this._hasTarget&&this.animation.finished}},{key:"stepController",value:function(e,t){this._hasTarget&&this.animation.step(e,t)}},{key:"onControllerEnd",value:function(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),(0,_u.Z)((0,bu.Z)(r.prototype),"onControllerEnd",this).call(this,e)}},{key:"animationSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Tu.Z)((0,Tu.Z)({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{},{easing:"string"==typeof e.easing?Ly[e.easing]:e.easing})}}]),r}(kg=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.AnimationController")],kg));(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Eg.prototype,"mode",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Eg.prototype,"isInteractive",null),Eg=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.PointToPointAnimationController")],Eg);var Dg=new Jy,Mg=(0,Vu.n)();function Ig(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ng;return[e[0],e[1],e[2],e[3]]}function Lg(e,t){return function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ig();return i[0]=e,i[1]=t,i[2]=r,i[3]=n,i}(e[0],e[1],e[2],t,Qu.r.get())}function Zg(e,t,r){return(0,Vu._)(r,e,t),(0,Vu.z)(r,r),r[3]=(0,Qu.e)(e,t),r}var Ng=[0,0,1,0];function Fg(e,t,r){return zg(e,e.screenToRender(t,(0,zu.p)(Qu.c.get())),r)}function zg(e,t,r){var n=(0,zu.p)((0,uc.a)(Qu.c.get(),t));if(n[2]=0,!e.unprojectFromRenderScreen(n,r.origin))return null;var i=(0,zu.p)((0,uc.a)(Qu.c.get(),t));i[2]=1;var a=e.unprojectFromRenderScreen(i,Qu.c.get());return(0,Nu.t)(a)?null:((0,Vu.e)(r.direction,a,r.origin),r)}function Ug(e,t,r){return Vg(e,e.screenToRender(t,(0,zu.p)(Qu.c.get())),r)}function Vg(e,t,r){(0,Vu.r)(r.origin,e.eye);var n=(0,Vu.o)(Qu.c.get(),t[0],t[1],1),i=e.unprojectFromRenderScreen(n,Qu.c.get());return(0,Nu.t)(i)?null:((0,Vu.e)(r.direction,i,r.origin),r)}function Bg(e,t,r,n){var i=Ug(t,r,Hg);return(0,Qu.z)(e,i,n)}var Gg,Hg=(0,Qu.d)();!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(Gg||(Gg={}));var jg=[1,3e8];function qg(e,t,r){return r[0]=t[0]/(e.fullWidth/e.pixelRatio),r[1]=t[1]/(e.fullHeight/e.pixelRatio),r}function Wg(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Xg(e,t,r){var n=(0,Wu.g)(Qu.a.get(),r[3],r);(0,Nu.t)(n)||(0,Wu.B)(n,hc.o)||((0,Vu.e)(V_,e.eye,t),(0,Vu.O)(V_,V_,n),e.eye=(0,Vu.u)(V_,V_,t),(0,Vu.e)(V_,e.center,t),(0,Vu.O)(V_,V_,n),e.center=(0,Vu.u)(V_,V_,t),e.up=(0,Vu.O)(V_,e.up,n))}function Yg(e,t,r,n){return(0,Tc.q)(e,Ug(t,r,q_),n)}function Qg(e,t,r,n){var i=Qu.c.get(),a=1-r;(0,Vu.e)(i,t,e.eye);var o=(0,Vu.s)(i),s=o*(1-a);a>=0&&s<n&&(a=-((s=n)-o)/o),Math.abs(o-s)<1e-6||((0,Vu.g)(i,i,a),e.eye=(0,Vu.u)(V_,e.eye,i),e.center=(0,Vu.A)(V_,e.center,t,a))}function Kg(e,t,r){t.getScreenCenter($g),Bg(e,t,$g,V_)&&(t.center=V_);var n=t.distance,i=n*r;if(!(Math.abs(n-i)<1e-6)){var a=(0,Vu.g)(Qu.c.get(),t.viewForward,i);t.eye=(0,Vu.e)(V_,t.center,a)}}var Jg,$g=(0,zu.i)();function e_(e,t){(0,Vu.o)(t,0,0,0);var r,n=(0,Cu.Z)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;(0,Vu.u)(t,t,i)}}catch(a){n.e(a)}finally{n.f()}(0,Vu.g)(t,t,1/e.length)}function t_(e,t,r,n){return Math.sin(e/(0,Vu.s)(t))*(r+n.radius)}function r_(e,t,r,n){return t_(Math.PI/2,t,r,n)+(e-Math.PI/2)}!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Jg||(Jg={}));var n_=3e4,i_=(0,Vu.m)(6),a_=.95,o_=(0,Vu.m)(18),s_=45,l_=(0,Vu.m)(80);function u_(e,t,r,n,i,a){var o=(0,Vu.n)(),s=(0,Qu.R)(),l=!0,u=!0;return e.intersectScreen(r,o,a)?s[3]=(0,Vu.s)(o):(u=!1,t.aboveGround&&i!==Gg.Ellipsoid?s[3]=Math.max((0,Vu.s)(t.center),.9*n.radius):s[3]=(0,Vu.s)(t.eye)-t.relativeElevation,i===Gg.Silhouette?f_(s,t,r,o):l=Bg(s,t,r,o)),{sphere:s,scenePickPoint:l?o:null,hasGeometryIntersection:u}}function c_(e,t,r,n){return(0,Vu.s)(e.eye)-n.radius>n_?Jg.Horizontal:r?(Ug(e,t,W_),-Math.sign(e.relativeElevation)*(.5*Math.PI+(0,Qu.e)(e.eye,W_.direction))<i_?Jg.Vertical:Jg.Horizontal):Jg.Vertical}function h_(e,t,r){(0,Vu.e)(d_,r,t),e.eye=(0,Vu.e)(V_,e.eye,d_),e.center=(0,Vu.e)(V_,e.center,d_)}var d_=(0,Vu.n)();function f_(e,t,r,n){var i=Ug(t,r,q_);return!(0,Nu.t)(i)&&((0,Qu.Y)(e,i,p_),(0,Qu.z)(e,i,n)?!((0,Vu.p)(p_,i.origin)<(0,Vu.p)(n,i.origin))||((0,Vu.r)(n,p_),!1):((0,Vu.e)(v_,t.eye,t.center),(0,Vu.z)(v_,v_),(0,Tc.T)(v_,-(0,Vu.P)((0,Vu.z)(v_,v_),p_),m_),(0,Tc.q)(m_,i,n),!1))}var p_=(0,Vu.n)(),v_=(0,Vu.n)(),m_=(0,Tc.p)();function y_(e,t,r,n,i,a){var o=0;if((0,Vu._)(H_,e,t),(0,Vu.e)(B_,e,t),(0,Vu.s)(e)<=i||!n.aboveGround){(0,Vu._)(r,B_,n.eye);var s=(0,Vu.P)(e,t)/((0,Vu.s)(e)*(0,Vu.s)(t));if(s<.9999)o=(0,Vu.i)(s);else{var l=(0,Vu.s)((0,Vu._)((0,Vu.n)(),e,t))/((0,Vu.s)(e)*(0,Vu.s)(t));o=(0,Vu.N)(l)}var u=Math.cos((0,Vu.a)(Ec.r.normalize((0,Vu.m)(a)),0,l_));o=-o-Math.max(0,(0,Vu.s)(t)-i)/(u*i)}else(0,Vu.e)(g_,n.eye,n.center),(0,Vu._)(r,B_,g_),o=-(0,Vu.s)(B_)/i;return(0,Vu.z)(r,r),(0,Vu.g)(r,r,(0,Vu.s)(H_)),o}var g_=(0,Vu.n)();function __(e,t,r,n){var i,a=Math.cos((0,Vu.a)(Ec.r.normalize((0,Vu.m)(n)),0,l_));return i=t>r?-(t-r)/(a*r):t<-r?Math.PI-(t+r)/(a*r):(0,Vu.i)(t/r),((e>r?-(e-r)/(a*r):e<-r?Math.PI-(e+r)/(a*r):(0,Vu.i)(e/r))-i)*r}function b_(e,t,r,n,i,a,o,s,l,u){(0,Vu._)(H_,e,t),Eh(a.up,a.eye,k_,E_,D_),Eh([0,0,1],a.eye,P_,R_,A_),(0,Vu.r)(r,R_),(0,Vu.r)(n,P_),(0,Vu.z)(r,r),(0,Vu.g)(r,r,(0,Vu.s)(H_)),kh(e,(0,Vu.z)(E_,E_),(0,Vu.z)(D_,D_),(0,Vu.z)(k_,k_),M_),kh(t,E_,D_,k_,I_),function(e,t,r,n,i,a,o,s,l,u){var c=__(e[2],t[2],a[3],s),h=l?__(e[0],t[0],a[3],180):t[0]-e[0],d=Math.sin(o)*h-Math.cos(o)*c,f=Math.cos(o)*h+Math.sin(o)*c;(0,Vu.z)(V_,i);var p=l?d/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,Vu.P)(r,V_),2))):d/a[3],v=f/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,Vu.P)(r,n),2)));(0,uc.r)(u,p,v)}(M_,I_,e,P_,R_,o,s,l,u,i)}function x_(e,t,r,n,i,a,o){(0,Wu.g)(N_,i,n),(0,Wu.g)(F_,o,a),(0,Wu.u)(z_,N_,F_),(0,Vu.e)(t,e,r),(0,Vu.O)(t,t,z_),(0,Vu.u)(t,t,r)}function w_(e,t,r,n,i,a){(0,Wu.g)(N_,n,r),(0,Wu.g)(F_,a,i),(0,Wu.u)(z_,N_,F_),(0,Vu.e)(V_,e.eye,t),(0,Vu.O)(V_,V_,z_),e.eye=(0,Vu.u)(V_,V_,t),(0,Vu.e)(V_,e.center,t),(0,Vu.O)(V_,V_,z_),e.center=(0,Vu.u)(V_,V_,t),(0,Vu.e)(V_,e.up,t),(0,Vu.O)(V_,V_,z_),e.up=(0,Vu.u)(V_,V_,t)}function T_(e,t,r,n,i,a){return(Math.abs(n)>Math.PI-o_||Math.abs(n)<o_)&&(Math.abs(e[2])<r*a_||Math.abs(t)>r)&&a.aboveGround&&i<s_}function C_(e,t,r,n,i,a){if(a)Zg(r,n,Z_),Xg(t,e,Z_);else{var o=y_(r,n,j_,t,e[3],i);Xg(t,e,Lg(j_,o))}}function S_(e,t,r,n,i,a,o){var s,l=o?20:1;(0,Vu.r)(U_,n),G_.copyFrom(t);for(var u=0;u<l&&(0,Vu.p)(r,U_)>1e-12&&(s=(0,Vu.p)(r,U_),b_(r,U_,R_,P_,L_,G_,e,i,a,o),w_(G_,e,P_,L_[1],R_,L_[0]),x_(U_,U_,e,P_,L_[1],R_,L_[0]),(0,Vu.p)(r,U_)<s||0===u);u++)t.copyFrom(G_)}function O_(e,t,r,n,i,a,o,s,l){T_(e.center,(0,Vu.P)(e.up,e.center),(0,Vu.s)(e.center),-Ec.r.normalize((0,Vu.m)(a)),o,t)?function(e,t,r,n,i,a){Eh([0,0,1],e.eye,P_,R_,A_);var o=t.translation[0]*r.pan,s="zoom"===i.mode?0:t.translation[1]*r.pan,l=Math.max(Math.sqrt(Math.abs(1-Math.pow((0,Vu.P)(e.center,P_),2)/Math.pow((0,Vu.s)(e.center),2))),.5),u=(Math.sin(a)*s+Math.cos(a)*o)/l,c=-Math.cos(a)*s+Math.sin(a)*o;switch((0,Wu.f)(n.pan.matrix,n.pan.matrix,u,P_),n.pan.enabled=!0,i.mode){case"pan":(0,Wu.f)(n.pan.matrix,n.pan.matrix,c,R_),n.pan.enabled=!0;break;case"zoom":n.zoom=-t.translation[1]*r.zoom}}(t,r,n,s,l,-Ec.r.normalize((0,Vu.m)(i))):function(e,t,r,n,i){var a=e.eye,o=e.viewRight,s=(0,Vu._)(Qu.c.get(),o,a),l=t.translation[0]*r.pan;switch(0!==l&&((0,Wu.f)(n.pan.matrix,n.pan.matrix,-l,s),n.pan.enabled=!0),i.mode){case"pan":var u=t.translation[1]*r.pan;0!==u&&((0,Wu.f)(n.pan.matrix,n.pan.matrix,u,o),n.pan.enabled=!0);break;case"zoom":n.zoom=-t.translation[1]*r.zoom}}(t,r,n,s,l)}var P_=(0,Vu.n)(),R_=(0,Vu.n)(),A_=(0,Vu.n)(),k_=(0,Vu.n)(),E_=(0,Vu.n)(),D_=(0,Vu.n)(),M_=(0,Vu.n)(),I_=(0,Vu.n)(),L_=(0,cc.n)(),Z_=Ig(),N_=(0,hc.e)(),F_=(0,hc.e)(),z_=(0,hc.e)(),U_=(0,Vu.n)(),V_=(0,Vu.n)(),B_=(0,Vu.n)(),G_=new Jy,H_=(0,Vu.n)(),j_=(0,Vu.n)(),q_={origin:(0,Vu.n)(),direction:(0,Vu.n)()},W_={origin:(0,Vu.n)(),direction:(0,Vu.n)()},X_=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._zoomLocation=(0,Vu.n)(),e._tmpCamera=new Jy,e._tmpViewDir=(0,Vu.n)(),e._tmpRayDir={origin:(0,Vu.n)(),direction:(0,Vu.n)()},e._targetOnSphere=(0,Vu.n)(),e._tmpCenter=(0,Vu.n)(),e._constraintOptions={selection:rm.ALL_EXCEPT_COLLISION,interactionType:nm.ZOOM,interactionFactor:null,interactionStartCamera:new Jy,interactionDirection:null,tiltMode:im.TUMBLE},e._sphere=(0,Qu.R)(),e}return(0,ku.Z)(r,[{key:"initialize",value:function(){this._intersector=(0,qu.g)(this.view.state.viewingMode)}},{key:"zoomStep",value:function(e,t){if(this.active){var r=this.view.state,n=this._constraintOptions.interactionStartCamera;this.animation.finished?n.copyFrom(r.camera):this.animation.cameraAt(1,n);var i=!1,a=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?K_:{})&&(i=e>0,a=!0),this._tmpCamera.copyFrom(r.camera),i?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Vu.r)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,a),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{apex:null,duration:(0,Eu.aj)(600),easing:gy}}},{key:"_updateCamera",value:function(e,t,r,n,i){var a,o=c_(e,n,i,(0,Xu.u)(this.view.spatialReference));this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z)),(0,Vu.z)(Q_,e.eye),(0,Vu.g)(Q_,Q_,-1),Ug(e,n,this._tmpRayDir),(0,Vu.z)(this._tmpRayDir.direction,this._tmpRayDir.direction);var s=Math.max(Math.min(12,1/Math.abs((0,Vu.P)(Q_,this._tmpRayDir.direction)))*a,200);if(o===Jg.Horizontal){var l=Math.pow(.6,t);this._sphere[3]=(0,Vu.s)(r),(0,Vu.e)(this._tmpViewDir,e.center,e.eye);var u=Math.min((0,Vu.s)(this._tmpViewDir),s),c=u*l;if(l<=1&&c<4&&(l=(c=4)/u),Math.abs(u-c)<1e-6)return;var h=(0,Vu.s)(e.center);if(this._sphere[3]!==h){var d=this._sphere[3]+l*(h-this._sphere[3]);e.center=(0,Vu.g)(Y_,e.center,d/h)}(0,Vu.g)(this._tmpViewDir,this._tmpViewDir,-l),e.eye=(0,Vu.u)(Y_,e.center,this._tmpViewDir),Zy(this.view,e,this._constraintOptions),(0,Vu.p)(r,e.center)>1e-12&&Bg(this._sphere,e,n,this._targetOnSphere)&&function(e,t,r,n,i,a,o){T_(r,(0,Vu.P)(t.up,r),e[3],-Ec.r.normalize((0,Vu.m)(i)),a,t)?S_(e,t,r,n,-Ec.r.normalize((0,Vu.m)(i)),a,o):C_(e,t,r,n,a,o)}(this._sphere,e,r,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{var f=Math.pow(.6,Math.abs(t)),p=t>0?1:-1;(0,Vu.e)(this._tmpViewDir,r,e.eye);var v=(0,Vu.s)(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,n[0],n[1],this.view.state.camera,60),y=(0,Nu.r)(m)?Math.min(s,m):s;y=i?Math.min(y,v):y,(0,Vu.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,y),(0,Vu.u)(r,this._tmpRayDir.origin,this._tmpRayDir.direction);var g=y*f,_=Math.max(4,1.01*e.nearFar[0]);if(t>0&&g<_&&(f=(g=_)/y),Math.abs(y-g)<1e-6)return;(0,Vu.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,p*(1-f)),e.eye=(0,Vu.u)(Y_,e.eye,this._tmpRayDir.direction),e.center=(0,Vu.u)(Y_,e.center,this._tmpRayDir.direction)}Um(this.view,e)}}]),r}(Eg);X_=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.global.ZoomStepController")],X_);var Y_=(0,Vu.n)(),Q_=(0,Vu.n)(),K_={exclude:new Set([Ic.j])},J_=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._zoomLocation=(0,Vu.n)(),e._tmpCamera=new Jy,e._tmpRayDir=(0,Vu.n)(),e._tmpCenter=(0,Vu.n)(),e._constraintOptions={selection:rm.ALL,interactionType:nm.ZOOM,interactionFactor:null,interactionStartCamera:new Jy,interactionDirection:null,tiltMode:im.TUMBLE},e}return(0,ku.Z)(r,[{key:"zoomStep",value:function(e,t){if(this.active){var r=this.view.state,n=this._constraintOptions.interactionStartCamera;this.animation.finished?n.copyFrom(r.camera):this.animation.cameraAt(1,n),this._tmpCamera.copyFrom(r.camera);var i=(0,qu.g)(this.view.state.viewingMode);e>0?(0===this.view.map.ground.opacity?this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,rb):this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation),this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Vu.r)(this._zoomLocation,this._tmpCamera.center);var a=Math.pow(.6,e),o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,60);(0,Vu.e)(tb,this._tmpCamera.eye,this._zoomLocation),(0,Vu.z)(tb,tb);var s=Math.max(Math.min(14,1/Math.abs((0,Vu.P)(eb,tb)))*Math.abs(this.view.camera.position.z),200);if(o=(0,Nu.r)(o)?Math.min(o,s):s){var l=(0,Vu.n)();(0,Vu.e)(l,this._zoomLocation,this._tmpCamera.eye),o<(0,Vu.s)(l)&&((0,Vu.z)(l,l),(0,Vu.u)(this._zoomLocation,this._tmpCamera.eye,(0,Vu.g)(l,l,o)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{apex:null,duration:(0,Eu.aj)(600),easing:gy}}},{key:"_updateCamera",value:function(e,t,r){(0,Vu.e)(this._tmpRayDir,r,e.eye);var n=(0,Vu.s)(this._tmpRayDir),i=n*t,a=t<=1,o=Math.max(4,1.01*e.nearFar[0]);0!==i&&(a&&i<o&&(t=(i=o)/n),Math.abs(n-i)<1e-6||((0,Vu.g)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Vu.e)($_,r,this._tmpRayDir),e.center=(0,Vu.A)($_,e.center,r,1-t),Zy(this.view,e,this._constraintOptions)))}}]),r}(Eg);J_=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.local.ZoomStepController")],J_);var $_=(0,Vu.n)(),eb=(0,Vu.c)(0,0,1),tb=(0,Vu.n)(),rb={exclude:new Set([Ic.j])},nb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,!0))._view=e,i.registerIncoming("double-click",n,(function(e){return i._handleDoubleClick(e)})),i}return(0,ku.Z)(r,[{key:"_handleDoubleClick",value:function(e){var t=e.data;if((0,Ju.t)(t,"primary")){var r=this._view.state.isGlobal?new X_({view:this._view,mode:"animation"}):new J_({view:this._view,mode:"animation"});this._view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),(0,zu.i)(t.x,t.y)),e.stopPropagation()}}}]),r}(Ju.i);var ib=function(){function e(t,r){(0,Au.Z)(this,e),this._elevationProvider=t,this._referenceEllipsoid=(0,Xu.u)(r),this._unitInMeters=(0,Xu.$)(r,this._referenceEllipsoid.metersPerDegree)}return(0,ku.Z)(e,[{key:"compute",value:function(e,t,r,n,i){var a;i||(i={near:0,far:0});var o=e[2]*this._unitInMeters,s=o,l=o-n,u=null===(a=this._elevationProvider)||void 0===a?void 0:a.visibleElevationBounds;u&&(o=l>=0?s-this._unitInMeters*u.min:this._unitInMeters*u.max-s);var c={x:(r=(0,Nu.r)(r)?r:new tc.w({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},h=Math.max(c.x,c.y,c.z);(0,Vu.e)(db,t,e),hb[0]=db[0]>0?r.xmax:r.xmin,hb[1]=db[1]>0?r.ymax:r.ymin,hb[2]=db[2]>0?h/2:-h/2,(0,Vu.e)(hb,hb,e),(0,Vu.z)(db,db);var d=1.1*(0,Vu.P)(hb,db)*this._unitInMeters,f=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),p=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),v=p*ub*this._unitInMeters,m=p*cb*this._unitInMeters,y=(0,Vu.a)((o-m)/(v-m),0,1);y*=y*y;var g=Math.min((0,Vu.Z)(f,d,y),f);return g*=Math.max(Math.log(Math.abs(l)),1),g=Math.min(g,Math.max(34064e4,h)),ob(g/=this._unitInMeters,sb,this._unitInMeters,i)}}]),e}(),ab=function(){function e(t){(0,Au.Z)(this,e),this._referenceEllipsoid=(0,Xu.u)(t)}return(0,ku.Z)(e,[{key:"compute",value:function(e,t,r,n,i){i||(i={near:0,far:0});var a=(0,Vu.s)(e)-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,n),s=Math.abs(a-n),l=Math.max(s,Math.abs(a));return ob(1.2*Math.sqrt(l*(l+2*o)),(0,Vu.a)(2e4-(Math.log(l)-7.983)/9.011*19e3,1e3,2e4),1,i)}}]),e}();function ob(e,t,r,n){var i=lb/r;return e/t>i?(n.far=e,n.near=n.far/t):(n.near=i,n.far=n.near*t),n}var sb=2e4,lb=2,ub=.001,cb=1e-4,hb=(0,Vu.n)(),db=(0,Vu.n)(),fb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)})))}},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null)}},{key:"_handleElevationChangeEvent",value:function(e){if(!this.view.state.cameraController){var t=this.view.state.camera;(0,Nu.r)(e.spatialReference)&&(0,qu.l)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}}},{key:"_applyToCurrentCamera",value:function(){var e=this;this.view.state.updateCamera((function(t){return Um(e.view,t,Mm.EYE_AND_CENTER)}))}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],fb.prototype,"view",void 0),fb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.ElevationCollisionConstraint")],fb);var pb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n.nearFarHeuristic=function(e,t,r){return e===ic.l.Global?new ab(r):new ib(t,r)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference),n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add([(0,Fu.l)((function(){var t,r,n,i;return[null===(t=e.view.constraints)||void 0===t||null===(r=t.clipDistance)||void 0===r?void 0:r.near,null===(n=e.view.constraints)||void 0===n||null===(i=n.clipDistance)||void 0===i?void 0:i.far]}),(function(){return e._clipDistanceNearFarChanged()})),(0,Fu.l)((function(){var t,r;return null===(t=e.view.constraints)||void 0===t||null===(r=t.clipDistance)||void 0===r?void 0:r.mode}),(function(){return e._updateNearFar()})),this.view.state.events.on("before-camera-change",(function(t){return e._updateCameraNearFar(t.camera)})),(0,Fu.l)((function(){return e.view.renderDataExtent}),(function(){return e._updateNearFar()}),Fu.U),(0,Fu.l)((function(){var t,r,n,i;return[null===(t=e.view.constraints)||void 0===t||null===(r=t.altitude)||void 0===r?void 0:r.min,null===(n=e.view.constraints)||void 0===n||null===(i=n.altitude)||void 0===i?void 0:i.max]}),(function(){return e._updateAltitude()}),Fu.U),(0,Fu.l)((function(){var t,r;return null===(t=e.view.constraints)||void 0===t||null===(r=t.tilt)||void 0===r?void 0:r.max}),(function(){return e._updateTiltMax()}),Fu.U),(0,Fu.l)((function(){var t,r;return null===(t=e.view.constraints)||void 0===t||null===(r=t.tilt)||void 0===r?void 0:r.mode}),(function(){return e._updateTilt()}),Fu.U),(0,Fu.l)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e._updateTiltAutoMax()}),Fu.U),(0,Fu.l)((function(){var t,r,n,i,a,o;return[null===(t=e.view.map)||void 0===t||null===(r=t.ground)||void 0===r||null===(n=r.navigationConstraint)||void 0===n?void 0:n.type,null===(i=e.view.state)||void 0===i||null===(a=i.constraints)||void 0===a||null===(o=a.collision)||void 0===o?void 0:o.enabled]}),(function(){return e._updateCollision()}),Fu.U)]),this.view.state.isLocal&&this._handles.add((0,Fu.l)((function(){return e.view.renderDataExtent}),(function(t){return e._updateLocalSurfaceDistance(t)}),Fu.h)),this._updateNearFar(),this.view.state.viewingMode!==ic.l.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new fb({view:this.view}))}},{key:"destroy",value:function(){this._handles=(0,Nu.g)(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}},{key:"_clipDistanceNearFarChanged",value:function(){var e,t=this,r=null===(e=this.view.constraints)||void 0===e?void 0:e.clipDistance;r&&"auto"!==r.mode&&this.view.state.updateCamera((function(e){return t._updateCameraNearFarManual(e,r)}))}},{key:"_updateNearFar",value:function(){var e=this;this.view.state.updateCamera((function(t){return e._updateCameraNearFar(t)}))}},{key:"_updateCameraNearFar",value:function(e){var t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}},{key:"_updateCameraNearFarAuto",value:function(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,(0,qu.m)(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}},{key:"_updateCameraNearFarManual",value:function(e,t){t&&(e.near=t.near,e.far=t.far)}},{key:"_updateCollision",value:function(){var e,t,r,n=null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t||null===(r=t.navigationConstraint)||void 0===r?void 0:r.type,i=!n||"stay-above"===n,a=this.view.state.constraints.collision;if(i!==a.enabled){a.enabled=i,i&&this._reapplyConstraints(rm.COLLISION);var o=this.view.constraints&&this.view.constraints.tilt;o&&"auto"!==o.mode||this._updateTiltAuto()}}},{key:"_updateAltitude",value:function(){var e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==ic.l.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}},{key:"_updateTiltMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}},{key:"_updateTilt",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}},{key:"_updateTiltManual",value:function(e){var t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,Vu.m)(e.max))}},{key:"_updateTiltAuto",value:function(){var e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}},{key:"_updateTiltAutoMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;if(e&&"auto"===e.mode){var t=this.view.state.constraints;if(t.tilt){var r=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,Vu.b)(r))}}}},{key:"_updateLocalSurfaceDistance",value:function(e){if(!(0,Nu.t)(e)){var t=Math.max(e.width,e.height);if(!(t<=0)){e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));var r=this.view.state,n=3*t/Math.atan(r.camera.fov/2);n!==r.constraints.distance&&(r.constraints.distance=n)}}}},{key:"_reapplyConstraints",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:rm.ALL;this.view.state.updateCamera((function(r){return Zy(e.view,r,{selection:t,interactionType:nm.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:im.TUMBLE})}))}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],pb.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],pb.prototype,"surfaceCollisionConstraint",void 0),pb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.ConstraintsManager")],pb);var vb=function(){function e(t){(0,Au.Z)(this,e),this.renderCoordsHelper=t,this.frustum=(0,kc.H)(),this._points=(0,kc.I)(),this.lines=new Array(12),this._origin=(0,Vu.n)(),this._direction=(0,Vu.n)(),this._altitude=null;for(var r=0;r<12;r++)this.lines[r]={origin:null,direction:(0,Vu.n)(),endpoint:null}}return(0,ku.Z)(e,[{key:"planes",get:function(){return this.frustum}},{key:"points",get:function(){return this._points}},{key:"mutablePoints",get:function(){return this._points}},{key:"direction",get:function(){return this._direction}},{key:"update",value:function(e){(0,kc.s)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,Vu.r)(this._origin,e.eye),(0,Vu.r)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}},{key:"updatePoints",value:function(e){for(var t=0;t<this._points.length;t++)(0,Vu.r)(this._points[t],e[t]);(0,kc.L)(this.frustum,this._points),this._updateLines()}},{key:"altitude",get:function(){return this._altitude}},{key:"intersectsSphere",value:function(e){return(0,kc.i)(this.frustum,e)}},{key:"intersectsRay",value:function(e){return(0,kc.P)(this.frustum,e)}},{key:"intersectsLineSegment",value:function(e,t){return(0,kc.m)(this.frustum,e,t)}},{key:"intersectsPoint",value:function(e){return(0,kc.p)(this.frustum,e)}},{key:"_updateLines",value:function(){for(var e=this._points,t=0;t<4;t++){var r=t+4;mb(this.lines[t],e[t],e[r]),mb(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),mb(this.lines[t+8],e[r],3===t?e[4]:e[r+1])}}}]),e}();function mb(e,t,r){e.origin=t,e.endpoint=r,(0,Vu.H)(e.direction,t,r)}vb.planePointIndices=kc.k,vb.nearFarLineIndices=[[kc.l.NEAR_BOTTOM_LEFT,kc.l.FAR_BOTTOM_LEFT],[kc.l.NEAR_BOTTOM_RIGHT,kc.l.FAR_BOTTOM_RIGHT],[kc.l.NEAR_TOP_RIGHT,kc.l.FAR_TOP_RIGHT],[kc.l.NEAR_TOP_LEFT,kc.l.FAR_TOP_LEFT]];var yb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"desiredCamera",set:function(e){this._set("desiredCamera",e.clone())}},{key:"canStop",get:function(){return!0}},{key:"constraintEnabled",get:function(){return this.view.state.constraints.collision.enabled}},{key:"onControllerStart",value:function(){var e=this;this.state=Tg.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)}))),this._applyCorrection()}},{key:"onControllerEnd",value:function(){this._handles.removeAll()}},{key:"stepController",value:function(){}},{key:"_handleElevationChangeEvent",value:function(e){(0,Nu.r)(e.spatialReference)&&!(0,qu.l)(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}},{key:"_applyCorrection",value:function(){var e=this;this.view.state.updateCamera((function(t){t.copyViewFrom(e.desiredCamera),Um(e.view,t,Mm.EYE_AND_CENTER)||e.constraintEnabled||(e.state=Tg.Stopped)}))}}]),r}(Ag);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],yb.prototype,"desiredCamera",null),yb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],yb);var gb=function(){function e(t,r,n){var i=this;(0,Au.Z)(this,e),this.target=t,this.options=r,this.view=n,this.state="pending",this._abortController=null,this._animationController=null,this._promise=new Promise((function(e,t){i._resolveCallback=e,i._rejectCallback=t;var r=new AbortController;(0,Nu.r)(i.options.signal)&&(0,Eu.v)(i.options.signal,(function(){i.abort()})),i._abortController=r,i.waitForReady()}))}return(0,ku.Z)(e,[{key:"then",value:function(e,t){return this._promise.then(e,t)}},{key:"catch",value:function(e){return this._promise.catch(e)}},{key:"resolve",value:function(e){return this.state="finished",this._resolveCallback(e)}},{key:"reject",value:function(e){return this.state="finished",this._rejectCallback(e)}},{key:"abort",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject((0,Eu.d)());break;case"wait-for-animation-finish":!e&&(0,Nu.r)(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject((0,Eu.d)())}}},{key:"waitForReady",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state="wait-for-ready",this.view.ready){e.next=9;break}return e.prev=1,e.next=4,(0,Fu.j)((function(){return t.view.ready}),this._abortController.signal);case 4:e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(1),e.abrupt("return",this.reject(e.t0));case 9:this.createViewPoint();case 10:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"createViewPoint",value:function(){var e=this;"finished"!==this.state&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,(0,qu.o)(this.view,this.target,this._abortController.signal).then((function(t){if("finished"!==e.state){var r=e._getCameraFromViewpoint(t);if(!(0,Nu.t)(r))if(e.options.animate){if((0,Nu.t)(e._animationController))return;e.startAnimation(r,e._animationController)}else e.view.stateManager.setStateCamera(r.camera,{applyConstraints:!r.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),e.resolve()}}),(function(t){e.reject(t)})))}},{key:"_getCameraFromViewpoint",value:function(e){var t=!!(this.target instanceof Du.u&&this.target.camera||this.target instanceof Du.y),r=e.camera;if((0,Nu.t)(r))return null;if(!this.view.stateManager.isCompatible(r)){var n=r.position,i=n&&n.spatialReference,a=i?i.wkid:"none",o=this.view.spatialReference.wkid;return this.reject(new Eu.s("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: ".concat(a,", view: ").concat(o,")"),{camera:r})),null}var s=(0,qu.Z)(this.view,r);return(0,Nu.t)(s)?(this.reject(new Eu.s("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:t}}},{key:"startAnimation",value:function(e,t){var r=this;this.state="wait-for-animation-finish";var n=t.viewAnimation;if((0,Nu.t)(n))this.reject(new Eu.s("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));else{if(n.update(e.viewpoint,"running"),!t.active||(0,Nu.t)(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();var i;e.isFullySpecified?(i=new yb({view:this.view,desiredCamera:e.camera}),Um(this.view,e.camera,Mm.EYE_AND_CENTER)):Zy(this.view,e.camera),t.begin(e.camera,this.options);var a=function(e){if(!(0,Nu.t)(r.view.state))switch(t.state){case Tg.Finished:switch(r.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":r.resolve()}break;case Tg.Ready:case Tg.Rejected:case Tg.Running:case Tg.Stopped:switch(r.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":r.reject(e)}}};n.when((function(){var n=r.view.state.cameraController;i&&(n&&n.active?n instanceof Eg&&(0,Nu.r)(n.viewAnimation)&&n.viewAnimation.target===e.viewpoint&&(r.view.state.cameraController=i):(0,Nu.r)(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(r.view.state.cameraController=i))}),(function(e){return a(e)})),t.asyncResult={resolve:function(){return a()},reject:function(e){return a(e)}}}}},{key:"_getAnimationController",value:function(){var e,t=null,r=this.view.state.cameraController;return r instanceof Eg&&(r.updateStateFromViewAnimation(),r.active&&(t=(e=r).viewAnimation)),null!=e||(t=(e=new Eg({view:this.view,mode:"animation"})).viewAnimation,this.view.state.switchCameraController(e))?e:((0,Nu.r)(t)&&t.stop(),this.reject(new Eu.s("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}]),e}(),_b=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._propertiesPool=new Ju.M({frustum:vb},(0,gu.Z)(n)),n._handles=new Eu.X,n._cameraSetByUser=!1,n._gotoOperation=null,n.ready=!1,n._windowDevicePixelRatio=1,n._devicePixelRatioOverride=null,n._maximumPixelRatioOverride=null,n._cameraChangeTime=0,n.test={contentCameraResetState:new Map,setDevicePixelRatio:function(e){return n._devicePixelRatioOverride=e},setMaximumPixelRatio:function(e){return n._maximumPixelRatioOverride=e},renderState:null},n}return(0,ku.Z)(r,[{key:"camera",get:function(){var e=this._get("camera");if(!this.ready)return e;var t=(0,qu.Q)(this.view,this.view.state.camera,Cb);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera((0,qu.Z)(this.view,e),{applyConstraints:!1})||Eu.a.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}},{key:"contentCamera",get:function(){var e=this._get("contentCamera");if(!this.ready)return e;var t=(0,qu.Q)(this.view,this.view.state.contentCamera,Cb);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){if(!this._updatePropertyBeforeReady("contentCamera",e)){var t=(0,qu.Z)(this.view,e);(0,Nu.t)(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}}},{key:"installContentCameraReset",value:function(e){var t=this;if(this._handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;var r=this.zoom,n=Math.pow(this.view.state.camera.distance,2),i=(0,Vu.a6)(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this._handles.add([(0,Fu.l)((function(){return t.contentCamera}),(function(){e.sticky||(t._handles.remove("contentCameraReset"),t.test.contentCameraResetState.clear())})),(0,Fu.l)((function(){return t.zoom}),(function(e){t.test.contentCameraResetState.set("view.zoom",Math.abs(e-r)/2),Math.abs(e-r)>2?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a)})),(0,Fu.l)((function(){return t.view.state.camera}),(function(e){var r=(0,Vu.p)(i,e.center);t.test.contentCameraResetState.set("camera.center",r/n),r>n?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a)}))],"contentCameraReset"),!0}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Eu.a.getLogger(this.declaredClass).error("#center=","Invalid center",e):Eu.a.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Eu.a.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");var e=this.view,t=(0,qu.q)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return(0,Nu.r)(t)?t:this._get("extent")},set:function(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Eu.a.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):Eu.a.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Eu.a.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){var e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},{key:"scale",get:function(){if(this.ready){var e=this.view.pointsOfInterest.centerOnContent;return(0,qu._)(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Eu.a.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");var e=this.view.state.camera,t=e.padding,r=e.pixelRatio,n=this._get("padding"),i=Math.round(t[zy.TOP]/r),a=Math.round(t[zy.RIGHT]/r),o=Math.round(t[zy.BOTTOM]/r),s=Math.round(t[zy.LEFT]/r);return null!=n&&n.top===i&&n.right===a&&n.bottom===o&&n.left===s?n:{top:i,right:a,bottom:o,left:s}},set:function(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Ob),this.view.state.updateCamera((function(e){return e.padding=Ob})))}},{key:"_paddingToArray",value:function(e,t,r){e?(0,Vu.C)(r,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Vu.C)(r,0,0,0,0);for(var n=0;n<4;n++)r[n]=Math.round(r[n]*t)}},{key:"screenCenter",get:function(){var e=this.padding;return(0,zu.c)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?(0,qu.s)(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Eu.a.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{var t=(0,Nu.r)(e.camera)?e.camera.position:e.targetGeometry,r=(0,Nu.r)(t)&&t.spatialReference;Eu.a.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else Eu.a.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?(0,qu.R)(this.view,this.scale):this._get("zoom")},set:function(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Eu.a.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}},{key:"maximumPixelRatio",get:function(){if((0,Nu.r)(this._maximumPixelRatioOverride))return this._maximumPixelRatioOverride;var e=1/0,t=this.view.qualitySettings,r=t.maximumPixelRatio,n=t.maximumRenderResolution;if(null!=r&&(e=Math.min(e,r)),null!=n){var i=n/Math.max(this.view.width,this.view.height);e=Math.min(e,i)}return e}},{key:"_devicePixelRatio",get:function(){return(0,Nu.t)(this._devicePixelRatioOverride)?Math.min(this._windowDevicePixelRatio,this.maximumPixelRatio):this._devicePixelRatioOverride}},{key:"initialize",value:function(){var e=this;this._cameraChangeTime=performance.now(),this._handles.add([(0,Fu.a)((function(){return e.view.state.events}),"before-camera-change",(function(t){return e._updateElevation(t.camera)})),(0,Fu.l)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t,r){return e._cameraChangedHandler(t,r)}),Fu.U)]),(0,Fu.f)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t){return e._updateElevation(t)}),{once:!0,sync:!0}),this._handles.add([(0,Eu.a7)({prepare:function(){return e._prepareFrame()}}),(0,Fu.l)((function(){return e.view.state.cameraController}),(function(){e._cameraSetByUser=!0,e._handles.remove(Pb)})),(0,Fu.a)((function(){return e.view.state.events}),"camera-projection-changed",(function(){return e.notifyChange("scale")}))])}},{key:"destroy",value:function(){this.exit(),this._handles&&(this._handles.destroy(),this._handles=null),this._propertiesPool&&(this._propertiesPool.destroy(),this._propertiesPool=null)}},{key:"init",value:function(){var e=this;this.constraintsManager=new pb({view:this.view}),this._prepareFrame();var t=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);var r,n=(0,Cu.Z)(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;this.set(i.name,i.value)}}catch(o){n.e(o)}finally{n.f()}if(!this._cameraSetByUser){var a=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;a&&this.isCompatible(a)?this._setInitialView(a):this.view.state.viewingMode===ic.l.Local&&this._handles.add((0,Fu.f)((function(){return e.view.basemapTerrain.ready}),(function(){e._handles.remove(Pb),e._setInitialView(e.view.dataExtent)}),{once:!0,initial:!0}),Pb)}}},{key:"exit",value:function(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this._handles.remove(Pb),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}},{key:"goTo",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,Tu.Z)({animate:!0},r),e.abrupt("return",((0,Nu.r)(this._gotoOperation)&&this._gotoOperation.abort(n.animate),this._gotoOperation=new gb(t,n,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"debugSetCameraOnContent",value:function(){this.setStateCamera((0,qu.t)(this.view),{applyConstraints:!1})}},{key:"step",value:function(e){var t=this.view.state,r=null===t||void 0===t?void 0:t.cameraController;r&&(t.updateCamera((function(t){return r.stepController(e,t)})),r.steppingFinished&&r.finishController())}},{key:"_cancelGoToOperation",value:function(){(0,Nu.r)(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}},{key:"_getInitialProperties",value:function(){var e,t=new Set,r=[],n=(0,Cu.Z)(wb);try{for(n.s();!(e=n.n()).done;){var i=e.value,a=i.propertyName,o=i.overrides,s=t.has(a),l=this._isOverridden(a);!s&&l&&r.push({name:a,value:this._get(a)}),this._clearOverride(a),(s||l)&&o.forEach((function(e){return t.add(e)}))}}catch(u){n.e(u)}finally{n.f()}return r}},{key:"_setInitialView",value:function(e){if(!(0,Nu.t)(e)&&!this._cameraSetByUser)if(e instanceof Du.y)this.setStateCamera((0,qu.Z)(this.view,e),{applyConstraints:!1});else if(e instanceof Du.u){if(e.targetGeometry instanceof tc.w){var t=(0,qu.u)(this.view,e.targetGeometry,0,.5,qu.K.LOCKED);return void((0,Nu.r)(t)&&this.setStateCamera((0,qu.Z)(this.view,t),{applyConstraints:!0}))}var r={applyConstraints:!e.camera},n=this._viewpointToCamera(e);this.setStateCamera(n,r)}else{var i=(0,qu.u)(this.view,e,0,.5,qu.K.LOCKED);(0,Nu.r)(i)&&this.setStateCamera((0,qu.Z)(this.view,i),{applyConstraints:!0})}}},{key:"_updatePropertyBeforeReady",value:function(e,t){return!this.ready&&(this._override(e,t),t&&xb.includes(e)&&this._override("hasInitialView",!0),!0)}},{key:"isCompatible",value:function(e){return!(0,Nu.t)(e)&&(e instanceof Du.u?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Du.y?this.isCompatible(e.position):e.spatialReference&&(0,Yu.g)(e.spatialReference,this.view.spatialReference))}},{key:"_getPreservingHeadingTilt",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Tb;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}},{key:"_centerPointAtDistanceToCamera",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sb,n=this._getPreservingHeadingTilt(),i=n.heading,a=n.tilt,o=(0,qu.v)(this.view,i,a,e,t,qu.K.ADJUST);return(0,Nu.t)(o)?null:(r.copyFrom(this.view.state.camera),r.eye=o.eye,r.center=o.center,r.up=o.up,r)}},{key:"_centerToCamera",value:function(e){var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var r=t.distance;return this._centerPointAtDistanceToCamera(e,r)}},{key:"_extentToCamera",value:function(e){var t=this._getPreservingHeadingTilt(),r=t.heading,n=t.tilt,i=(0,qu.u)(this.view,e,r,n,qu.K.ADJUST,Cb);return(0,Nu.r)(i)?(0,qu.Z)(this.view,i):null}},{key:"_scaleToCamera",value:function(e){if(null==e)return null;var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var r=t.renderLocation,n=t.location.latitude,i=(0,qu.$)(this.view,e,n);return this._centerPointAtDistanceToCamera(r,i)}},{key:"_zoomToCamera",value:function(e){return this._scaleToCamera((0,qu.w)(this.view,e))}},{key:"_viewpointToCamera",value:function(e){return(0,qu.Z)(this.view,(0,qu.c)(this.view,e))}},{key:"setStateCamera",value:function(e,t){var r=this;return!((0,Nu.t)(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((function(n){t.positionAndOrientationOnly?(n.eye=e.eye,n.center=e.center,n.up=e.up):n.copyFrom(e),t.applyConstraints&&Zy(r.view,n)})),t.applyConstraints||(this.view.state.cameraController=new yb({view:this.view,desiredCamera:e})),!0)}},{key:"_prepareFrame",value:function(){var e=this.view,t=e.surface,r=e.canvas;if(t&&r){this._windowDevicePixelRatio=window.devicePixelRatio;var n=this._devicePixelRatio,i=Math.round(t.clientWidth*n),a=Math.round(t.clientHeight*n);if(0!==i&&0!==a&&(r.width===i&&r.height===a||(r.width=i,r.height=a),this.view.state)){var o=this.view.state.camera;o.fullWidth===i&&o.fullHeight===a&&o.pixelRatio===n||(Sb.copyFrom(o),Sb.pixelRatio!==n&&(this._paddingToArray(this.padding,n,Ob),Sb.padding=Ob),Sb.fullWidth=i,Sb.fullHeight=a,Sb.pixelRatio=n,this.view.state.camera=Sb),this._updateRenderState()}}}},{key:"_updateElevation",value:function(e){var t,r,n=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=null!==(t=null===(r=this.view.renderCoordsHelper)||void 0===r?void 0:r.getAltitude(e.eye))&&void 0!==t?t:0,a=n?(0,qu.m)(this.view,e.eye):0;e.relativeElevation=i-a}},{key:"_updateRenderState",value:function(){(0,Nu.r)(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=bc.a.ANIMATING:this.view.interacting?this.view.state.mode=bc.a.INTERACTING:(this.view.state.mode===bc.a.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=Rb?this.view.state.mode=bc.a.INTERACTING:this.view.state.mode=bc.a.IDLE)}},{key:"_cameraChangedHandler",value:function(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateRenderState())}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:Du.y,dependsOn:["view.state.camera","ready"]})],_b.prototype,"camera",null),(0,Eu.e)([(0,Eu.y)({type:Du.y,dependsOn:["view.state.contentCamera","ready"]})],_b.prototype,"contentCamera",null),(0,Eu.e)([(0,Eu.y)({type:Yu.w})],_b.prototype,"center",null),(0,Eu.e)([(0,Eu.y)({type:tc.w})],_b.prototype,"extent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],_b.prototype,"frustum",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],_b.prototype,"hasInitialView",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0,type:Boolean})],_b.prototype,"ready",void 0),(0,Eu.e)([(0,Eu.y)({type:Number})],_b.prototype,"scale",null),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"padding",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],_b.prototype,"screenCenter",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],_b.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({type:Du.u})],_b.prototype,"viewpoint",null),(0,Eu.e)([(0,Eu.y)({type:Number})],_b.prototype,"zoom",null),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"maximumPixelRatio",null),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"_devicePixelRatio",null),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"_windowDevicePixelRatio",void 0),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"_devicePixelRatioOverride",void 0),(0,Eu.e)([(0,Eu.y)()],_b.prototype,"_maximumPixelRatioOverride",void 0),_b=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.ViewStateManager")],_b);var bb,xb=["camera","viewpoint","extent","scale","center","zoom"],wb=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Tb={heading:0,tilt:0},Cb=new Du.y,Sb=new Jy,Ob=(0,lc.n)(),Pb="pending-initial-view",Rb=300,Ab=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).startCamera=new Jy,e.currentCamera=new Jy,e._lastInteraction=0,e}return(0,ku.Z)(r,[{key:"isInteractive",get:function(){return performance.now()-this._lastInteraction<100}},{key:"stepController",value:function(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}},{key:"onControllerStart",value:function(e){this.state=Tg.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}},{key:"onControllerEnd",value:function(e){e.copyViewFrom(this.currentCamera)}},{key:"commitCamera",value:function(){var e=this;this._lastInteraction=performance.now(),setTimeout((function(){return e.notifyChange("isInteractive")}),100),this.view.state.updateCamera((function(t){return e.stepController(0,t)})),this.steppingFinished&&this.finishController()}}]),r}(Ag);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Ab.prototype,"isInteractive",null),(0,Eu.e)([(0,Eu.y)()],Ab.prototype,"_lastInteraction",void 0),Ab=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.InteractiveController")],Ab),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(bb||(bb={}));var kb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).pivot=bb.CENTER,n._lastPoint=(0,cc.n)(),n._tmpWorldUp=(0,Vu.n)(),n._tmpViewDir=(0,Vu.n)(),n._tmpRotCurPoint=(0,cc.n)(),n._tmpTransf=(0,hc.e)(),n._tmpAxis=(0,Vu.n)(),n._tmpPivotPoint=(0,Vu.n)(),n._pivotPos=(0,Vu.n)(),n._constraintOptions={selection:rm.ALL,interactionType:nm.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:im.TUMBLE},n}return(0,ku.Z)(r,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this._rotScale=this.pivot===bb.CENTER?3:1.5}},{key:"begin",value:function(e){if(this.active){switch(this.pivot){case bb.EYE:(0,Vu.r)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=nm.LOOK_AROUND,this._constraintOptions.tiltMode=im.LOOK_AROUND,this._constraintOptions.selection=rm.NONE;break;case bb.CENTER:var t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos);t||(0,Vu.r)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=nm.TUMBLE,this._constraintOptions.tiltMode=im.TUMBLE,this._constraintOptions.selection=rm.ALL&~rm.DISTANCE}this._constraintOptions.interactionStartCamera=this.startCamera,qg(this.startCamera,e,this._lastPoint)}}},{key:"_constrainPivotPoint",value:function(e,t){var r=this.startCamera,n=(0,Vu.n)();(0,Vu.e)(n,this._pivotPos,r.eye);var i=(0,Vu.s)(n),a=Math.min(i,7*Math.abs(this.view.camera.position.z)),o=(0,Xu.u)(this.view.spatialReference),s=(0,zu.i)(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),l=c_(this.startCamera,s,!0,o),u=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,225,90),c=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],r,90);((0,Nu.r)(u)||(0,Nu.r)(c))&&(a=(u=(0,Nu.v)(u,c))>(c=(0,Nu.t)(c)||l===Jg.Horizontal?u:c)?c:u,a=t?Math.min(a,i):a),(0,Vu.z)(n,n),(0,Vu.r)(this._pivotPos,(0,Vu.u)(this._tmpPivotPoint,r.eye,(0,Vu.g)(this._tmpPivotPoint,n,a)))}},{key:"update",value:function(e){if(this.active){switch(this.pivot){case bb.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case bb.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Zy(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}},{key:"_applyRotation",value:function(e,t,r,n){this.view.renderCoordsHelper.worldUpAtPosition(n,this._tmpWorldUp),qg(e,t,this._tmpRotCurPoint);var i=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Vu.e)(this._tmpViewDir,r,n);var o=(0,Vu.s)(this._tmpViewDir),s=(0,Vu.i)((0,Vu.P)(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===bb.EYE){i*=-.5;var l=.5*Math.PI-s,u=.5*Math.PI*.99;i=l-Math.max(-u,Math.min(u,l+i))}return i=(0,Vu.a)(i+s,od.min,od.max)-s,(0,Vu._)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===bb.CENTER&&(a=-a),(0,Wu.g)(this._tmpTransf,a,this._tmpWorldUp),(0,Wu.f)(this._tmpTransf,this._tmpTransf,i,this._tmpAxis),(0,Vu.O)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Vu.O)(Eb,e.up,this._tmpTransf),(0,Vu.u)(Eb,n,this._tmpViewDir),(0,uc.a)(this._lastPoint,this._tmpRotCurPoint),Eb}}]),r}(Ab);(0,Eu.e)([(0,Eu.y)()],kb.prototype,"pivot",void 0),kb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.RotateController")],kb);var Eb=(0,Vu.n)(),Db=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,!0))._view=e,o.pointerAction=n,o._pivot=i,o.registerIncoming("drag",a,(function(e){return o._handleDrag(e)})),o}return(0,ku.Z)(r,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,Ju.N)(e.data,this.pointerAction)){var r=(0,zu.i)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new kb({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),r}(Ju.i),Mb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._pickPoint=(0,Vu.n)(),e._tmpP0=(0,cc.n)(),e._panAxisAngle=Ig(),e._tmpRayDir=(0,Vu.n)(),e._tmpRayDirPick=(0,Vu.n)(),e._targetOnSphere=(0,Vu.n)(),e._tmpRay={origin:(0,Vu.n)(),direction:(0,Vu.n)()},e.dragBeginPoint=(0,zu.i)(),e._normalizedAnchorPoint=(0,cc.n)(),e._constraintOptions={selection:rm.ALL_EXCEPT_COLLISION,interactionType:nm.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:im.TUMBLE},e._sphere=(0,Qu.R)(),e._hasPickPoint=!1,e}return(0,ku.Z)(r,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){(0,uc.a)(this.dragBeginPoint,e),qg(this.startCamera,e,this._normalizedAnchorPoint);var t=(0,Xu.u)(this.view.spatialReference),r=u_(this._intersectionHelper,this.startCamera,e,t,Gg.Ellipsoid,0===this.view.map.ground.opacity?Lb:{});if(this._navMode=c_(this.startCamera,e,r.hasGeometryIntersection,t),this._navMode===Jg.Horizontal)this._hasPickPoint=!!r.scenePickPoint,this._pickPoint=(0,Nu.v)(r.scenePickPoint,this._pickPoint),this._sphere=r.sphere;else{var n,i;Ug(this.startCamera,e,this._tmpRay),(0,Vu.z)(this._tmpRay.direction,this._tmpRay.direction),(0,Nu.r)(r.scenePickPoint)&&((0,Vu.e)(this._tmpRayDirPick,this.startCamera.eye,r.scenePickPoint),i=(0,Vu.s)(this._tmpRayDirPick)),this.view.camera.position.hasZ&&(n=Math.abs(this.view.camera.position.z));var a=(0,Vu.a)(30*n,jg[0],jg[1]),o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,70);a=(0,Nu.r)(o)?Math.min(a,o):a,a=r.scenePickPoint?Math.min(a,i):a,this._hasPickPoint=!0,(0,Vu.g)(this._tmpRay.direction,this._tmpRay.direction,a),(0,Vu.u)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}}},{key:"update",value:function(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Jg.Horizontal){(0,Vu.e)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);var t=(0,Vu.s)(this._tmpRayDir);qg(this.currentCamera,e,this._tmpP0);var r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),n=t*Math.pow(2,r),i=this.view.state.constraints.minimumPoiDistance;if(r<0&&n<i&&(n=i),Math.abs(t-n)<1e-6)return;if(this._hasPickPoint&&n<t){var a=1-(1-n/t)*(1-this._sphere[3]/(0,Vu.s)(this.currentCamera.center));this.currentCamera.center=(0,Vu.g)(Ib,this.currentCamera.center,a)}(0,Vu.g)(this._tmpRayDir,this._tmpRayDir,-n/t),this.currentCamera.eye=(0,Vu.u)(Ib,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Fy((0,uc.m)(this.dragBeginPoint,e)),Zy(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(f_(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Zg(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Xg(this.currentCamera,this._sphere,this._panAxisAngle))}else{var o=(0,Vu.s)(this._tmpRay.direction);qg(this.currentCamera,e,this._tmpP0);var s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),l=o*Math.pow(2,s),u=this.view.state.constraints.minimumPoiDistance;if(s<0&&l<u&&(l=u),Math.abs(o-l)<1e-6)return;(0,Vu.g)(this._tmpRayDir,this._tmpRay.direction,1-l/o),this.currentCamera.eye=(0,Vu.u)(Ib,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Vu.u)(Ib,this.currentCamera.center,this._tmpRayDir)}Um(this.view,this.currentCamera),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}}]),r}(Ab);Mb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.global.ZoomController")],Mb);var Ib=(0,Vu.n)(),Lb={exclude:new Set([Ic.j])},Zb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._tmpP=(0,Vu.n)(),e._tmpDir=(0,Vu.n)(),e._tmpN=(0,Vu.n)(),e._tmpP0=(0,cc.n)(),e._tmpPoi=(0,Vu.n)(),e._tmpRayDir=(0,Vu.n)(),e.dragBeginPoint=(0,zu.i)(),e._normalizedAnchorPoint=(0,cc.n)(),e._constraintOptions={selection:rm.ALL,interactionType:nm.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:(0,Vu.n)(),tiltMode:im.TUMBLE},e._plane=(0,Tc.p)(),e}return(0,ku.Z)(r,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){(0,uc.a)(this.dragBeginPoint,e),qg(this.startCamera,e,this._normalizedAnchorPoint);var t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?Fb:{});(0,Vu.e)(this._tmpDir,this._tmpP,this.startCamera.eye);var r,n=(0,Vu.s)(this._tmpDir);(0,Vu.z)(this._tmpDir,this._tmpDir),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));var i=(0,Vu.a)(30*r,jg[0],jg[1]),a=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,70);i=(0,Nu.r)(a)?Math.min(i,a):i,i=t?Math.min(i,n):i,(0,Vu.g)(this._tmpDir,this._tmpDir,i),(0,Vu.u)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Vu.e)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Vu.z)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Vu.q)(this._tmpN,this._tmpN),(0,Tc._)(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}}},{key:"update",value:function(e){if(this.active){(function(e,t,r,n){return(0,Tc.q)(e,Fg(t,r,q_),n)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,Vu.r)(this._tmpPoi,this.currentCamera.center),qg(this.currentCamera,e,this._tmpP0);var t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,uc.a)(this._normalizedAnchorPoint,this._tmpP0),(0,Vu.e)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);var r=(0,Vu.s)(this._tmpRayDir),n=r*(1-t);(0,Vu.r)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Vu.g)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/r);var i=this.view.state.constraints.minimumPoiDistance;t>=0&&n<i&&(t=-((n=i)-r)/r),Math.abs(r-n)<1e-6||((0,Vu.g)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Vu.u)(Nb,this.currentCamera.eye,this._tmpRayDir),(0,Vu.A)(Nb,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Nb[2]=Math.max(this.startCamera.center[2],Nb[2]):Nb[2]=Math.min(this.startCamera.center[2],Nb[2]),this.currentCamera.center=Nb,this._constraintOptions.interactionFactor=Fy((0,uc.m)(this.dragBeginPoint,e)),Zy(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}}},{key:"end",value:function(){this.active&&this.finishController()}}]),r}(Ab);Zb=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.local.ZoomController")],Zb);var Nb=(0,Vu.n)(),Fb={exclude:new Set([Ic.j])},zb=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,!0))._view=e,a.pointerAction=n,a.registerIncoming("drag",i,(function(e){return a._handleDrag(e)})),a}return(0,ku.Z)(r,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,Ju.N)(e.data,this.pointerAction)){var r=(0,zu.i)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Mb({view:this._view}):this._cameraController=new Zb({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),r}(Ju.i),Ub=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},n._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],n._tmpCamera=new Jy,n._constraintOptions={selection:rm.ALL,interactionType:nm.NONE,interactionStartCamera:new Jy,interactionFactor:0,interactionDirection:null,tiltMode:im.LOOK_AROUND},n}return(0,ku.Z)(r,[{key:"handleEventGamepad",value:function(e){var t=(0,Ju.c)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,Ju.s)(t))&&this.finishController()}},{key:"activateDirection",value:function(e){this._keysButtonState[e]=1,(0,Ju.O)(this._keysButtonState,this._transformation)}},{key:"deactivateDirection",value:function(e){this._keysButtonState[e]=0;var t=(0,Ju.O)(this._keysButtonState,this._transformation);(0,Ju.s)(t)&&this.finishController()}},{key:"onControllerStart",value:function(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,(0,_u.Z)((0,bu.Z)(r.prototype),"onControllerStart",this).call(this,e)}},{key:"_updateFilteredSurfaceElevation",value:function(e){var t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}},{key:"stepController",value:function(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Xb),this._applyDisabledMovementTypes(Xb),this._applyPan(Xb.pan),this._applyRotate(Xb.rotate),this._applyZoom(Xb.zoom),this._applyAscend(Xb.ascend),this._constraintOptions.interactionType=nm.NONE,this._constraintOptions.selection=rm.COLLISION,Zy(this.view,this.currentCamera,this._constraintOptions),(0,_u.Z)((0,bu.Z)(r.prototype),"stepController",this).call(this,e,t)}},{key:"_updateStartHeading",value:function(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}},{key:"_applyRotate",value:function(e){if(e.enabled){var t=this.currentCamera;(0,Vu.e)(Yb,t.center,t.eye),(0,Vu.O)(Yb,Yb,e.matrix),t.center=(0,Vu.u)(Yb,Yb,t.eye),t.up=(0,Vu.O)(Yb,t.up,e.matrix),this._constraintOptions.interactionType=nm.LOOK_AROUND,this._constraintOptions.selection=rm.ALL_EXCEPT_COLLISION,Zy(this.view,t,this._constraintOptions)}}},{key:"_applyPan",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,Vu.O)(Yb,t.eye,e.matrix),t.center=(0,Vu.O)(Yb,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Vu.O)(Yb,t.up,e.matrix)),this._constraintOptions.interactionType=nm.PAN,this._constraintOptions.selection=rm.ALL,Zy(this.view,t,this._constraintOptions))}},{key:"_applyZoom",value:function(e){if(e){var t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Vu.u)(Yb,this.currentCamera.eye,(0,Vu.g)(Qu.c.get(),t,e)),(0,Vu.r)(Qb,t),(0,Vu.q)(Qb,Qb),this._constraintOptions.interactionDirection=Qb,this._constraintOptions.interactionType=nm.ZOOM,this._constraintOptions.selection=rm.ALL_EXCEPT_COLLISION,Zy(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_applyAscend",value:function(e){if(e){var t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Qu.c.get());if(this._constraintOptions.interactionDirection=(0,Vu.r)(Qb,t),this.view.state.isGlobal){var r=(0,Vu.s)(this.currentCamera.eye),n=(r+e)/r;this.currentCamera.eye=(0,Vu.g)(Yb,this.currentCamera.eye,n),this.currentCamera.center=(0,Vu.g)(Yb,this.currentCamera.center,n)}else{var i=(0,Vu.g)(Qu.c.get(),t,e);this.currentCamera.eye=(0,Vu.u)(Yb,this.currentCamera.eye,i),this.currentCamera.center=(0,Vu.u)(Yb,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=nm.ASCEND,this._constraintOptions.selection=rm.COLLISION,Zy(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=rm.ALL_EXCEPT_COLLISION,Zy(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_calculateControlTransformation",value:function(e,t,r){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Wu.r)(e.pan.matrix),e.rotate.enabled=!1,(0,Wu.r)(e.rotate.matrix)}(r);var n=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(n,t,r):this._calculateControlTransformationGlobal(n,t,r)}},{key:"_updateCameraCenter",value:function(){var e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,r=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(r,e,Yb)}},{key:"_calculateControlTransformationLocal",value:function(e,t,r){var n=t.viewRight,i=t.viewForward,a=this._transformation,o=this.view.navigation.gamepad,s=(0,Vu.o)(Qu.c.get(),i[0],i[1],0);(0,Vu.z)(s,s);var l=a.translation[0]*e.pan;if(0!==l){var u=(0,Vu.g)(Qu.c.get(),n,l);(0,Wu.c)(r.pan.matrix,r.pan.matrix,u),r.pan.enabled=!0}switch(o.mode){case"pan":var c=-a.translation[1]*e.pan;if(0!==c){var h=(0,Vu.g)(Qu.c.get(),s,c);(0,Wu.c)(r.pan.matrix,r.pan.matrix,h),r.pan.enabled=!0}r.zoom=a.zoom*e.zoom;break;case"zoom":r.zoom=(-a.translation[1]+a.zoom)*e.zoom}var d=a.translation[2]*e.ascend;r.ascend=d;var f=-a.heading*e.rotate;0!==f&&((0,Wu.f)(r.rotate.matrix,r.rotate.matrix,f,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Qu.c.get())),r.rotate.enabled=!0);var p=a.tilt*e.rotate,v=Gm(this.view.renderCoordsHelper,t.center,t.eye),m=(0,Vu.a)(v+p,od.min,od.max)-v;m&&((0,Wu.f)(r.rotate.matrix,r.rotate.matrix,m,n),r.rotate.enabled=!0)}},{key:"_calculateControlTransformationGlobal",value:function(e,t,r){var n=t.eye,i=t.viewRight,a=this._transformation,o=this.view.navigation.gamepad,s=(0,Vu._)(Qu.c.get(),i,n);(0,Vu.z)(s,s),(0,Vu.q)(s,s),O_(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,r,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Xb.pan,this._tmpCamera);var l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=a.translation[2]*e.ascend;r.ascend=u;var c=-a.heading*e.rotate;0!==c&&((0,Wu.f)(r.rotate.matrix,r.rotate.matrix,c,this._tmpCamera.eye),r.rotate.enabled=!0);var h=a.tilt*e.rotate,d=this._clampTiltDeltaGlobalToValidRange(h,t.ray,l);0!==d&&((0,Wu.f)(r.rotate.matrix,r.rotate.matrix,d,this._tmpCamera.viewRight),r.rotate.enabled=!0),r.zoom+=a.zoom*e.zoom}},{key:"_clampTiltDeltaGlobalToValidRange",value:function(e,t,r){var n=(0,Xu.u)(this.view.spatialReference),i=t_(od.min,t.origin,r,n),a=0,o=0,s=Qu.c.get();this.view.renderCoordsHelper.intersectManifold(t,r,s)?(a=t_(Gm(this.view.renderCoordsHelper,s,t.origin),t.origin,r,n),o=t_(od.max,t.origin,r,n)):((0,Qu.Y)((0,Qu.O)(Qu.W,r+n.radius),t,s),a=r_((0,Vu.i)(-(0,Vu.P)(t.direction,(0,Vu.z)(s,s))),t.origin,r,n),o=r_(od.max,t.origin,r,n));return(0,Vu.a)(a+e,i,o)-a}},{key:"_getPointAbsoluteSurfaceElevation",value:function(e,t,r){var n=this.view.renderCoordsHelper,i=n.getAltitude(e),a=t+Math.abs(i-t);return n.setAltitude(r,a,e),a}},{key:"_clampedDistanceToSurface",value:function(e,t){var r=this.view.renderCoordsHelper,n=this.view.state.camera,i=(0,qu.y)(this.view,t,0,Bb,Kb).direction,a=r.intersectManifoldClosestSilhouette((0,Qu.p)(t,i),e,Qu.c.get()),o=(0,Vu.x)(t,a),s=r.intersectManifoldClosestSilhouette((0,Qu.p)(t,(0,Vu.H)(Qu.c.get(),t,n.center)),e,Qu.c.get()),l=(0,Vu.x)(t,s);return Math.min(o,l)}},{key:"_computeHeadingRotateRadius",value:function(e){var t=this.view,r=t.renderCoordsHelper,n=t.state,i=n.camera,a=n.isGlobal,o=r.intersectManifoldClosestSilhouette(i.ray,this._filteredSurfaceElevation,Qu.c.get());if(a){var s=(0,Vu.e)(Qu.c.get(),e,o),l=(0,Vu.s)(s);(0,Vu.g)(s,s,1/l);var u=(0,Vu.z)(Qu.c.get(),e),c=(0,Vu.i)((0,Vu.P)(u,s));return l*Math.sin(Math.min(Gb,c))}var h=(0,Vu.r)(Qu.c.get(),e);return r.setAltitude(h,this._filteredSurfaceElevation),(0,Vu.x)(o,h)}},{key:"_minimumAscendVelocity",value:function(){return this.view.state.constraints.collision.enabled?0:jb}},{key:"_computeVelocities",value:function(e){var t=this._filteredSurfaceElevation,r=t+(0,Xu.u)(this.view.spatialReference).radius,n=this.view.state,i=n.camera,a=n.isGlobal,o=Qu.c.get(),s=this._getPointAbsoluteSurfaceElevation(i.eye,t,o),l=this._clampedDistanceToSurface(t,o),u=i.width/2,c=Hb*i.width,h=Hb*i.width,d=l*Math.tan(.5*i.fovX)/u,f=d/r,p=d/this._computeHeadingRotateRadius(o),v=s-t;return{pan:(a?f:d)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,Math.pow(2,c*e/u)*v-v),zoom:Math.pow(2,c*e/u)*l-l,rotate:(0,Vu.a)(p*h,qb,Wb)*e}}},{key:"_applyDisabledMovementTypes",value:function(e){!(0,Nu.r)(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Wu.r)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Wu.r)(e.rotate.matrix))}}],[{key:"activatesFor",value:function(e,t){var r=(0,Ju.c)(t,e.navigation.gamepad,Vb);return!("end"===t.action||(0,Ju.s)(r))}}]),r}(Ab);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Ub.prototype,"gamepadDevice",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Ub.prototype,"disableMovements",void 0),Ub=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.GamepadKeyboardController")],Ub);var Vb={translation:[0,0,0],heading:0,tilt:0,zoom:0},Bb=80,Gb=(0,Vu.m)(Bb),Hb=.75,jb=5,qb=(0,Vu.m)(30),Wb=(0,Vu.m)(80),Xb={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,hc.e)()},rotate:{enabled:!1,matrix:(0,hc.e)()}},Yb=(0,Vu.n)(),Qb=(0,Vu.n)(),Kb=(0,qu.z)();var Jb,$b=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,!0))._view=e,n._watchHandles=new Eu.X,n._handle=n.registerIncoming("gamepad",(function(e){return n._handleEventGamepad(e)})),n._handle.pause(),n}return(0,ku.Z)(r,[{key:"onInstall",value:function(e){var t=this;(0,_u.Z)((0,bu.Z)(r.prototype),"onInstall",this).call(this,e),this._watchHandles.add([(0,Fu.l)((function(){return t._view.navigation.gamepad.enabled}),(function(e){e?t._handle.resume():(t._handle.pause(),t._cameraControllerGamepad&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null))}),Fu.h),(0,Fu.l)((function(){return t._view.navigation.gamepad.device}),(function(e){t._cameraControllerGamepad&&e&&t._cameraControllerGamepad.gamepadDevice!==e&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null)}))])}},{key:"onUninstall",value:function(){this._watchHandles.removeAll(),(0,_u.Z)((0,bu.Z)(r.prototype),"onUninstall",this).call(this)}},{key:"_handleEventGamepad",value:function(e){var t=this._view.navigation.gamepad.device;if(!t||e.data.device===t){var r=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(r||Ub.activatesFor(this._view,e.data)){if(!r){var n=new Ub({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(n)&&(this._cameraControllerGamepad=n)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}}]),r}(Ju.i);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(Jb||(Jb={}));var ex=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i,a;return(0,Au.Z)(this,r),(a=t.call(this,!0))._view=e,a._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:ic.l.Local},a._keyToNumber=(i={},(0,yu.Z)(i,n.left,Jb.LEFT),(0,yu.Z)(i,n.right,Jb.RIGHT),(0,yu.Z)(i,n.forward,Jb.FORWARD),(0,yu.Z)(i,n.backward,Jb.BACKWARD),(0,yu.Z)(i,n.up,Jb.UP),(0,yu.Z)(i,n.down,Jb.DOWN),(0,yu.Z)(i,n.headingLeft,Jb.HEADINGLEFT),(0,yu.Z)(i,n.headingRight,Jb.HEADINGRIGHT),(0,yu.Z)(i,n.tiltUp,Jb.TILTUP),(0,yu.Z)(i,n.tiltDown,Jb.TILTDOWN),(0,yu.Z)(i,n.zoomIn,Jb.ZOOMIN),(0,yu.Z)(i,n.zoomOut,Jb.ZOOMOUT),i),a.registerIncoming("key-down",null,(function(e){return a._handleKeyDown(e)})),a.registerIncoming("key-up",null,(function(e){return a._handleKeyUp(e)})),a.registerIncoming("blur",null,(function(){return a._handleBlur()})),a}return(0,ku.Z)(r,[{key:"_handleKeyDown",value:function(e){if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Ub({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}}},{key:"_handleBlur",value:function(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}},{key:"_handleKeyUp",value:function(e){if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var t=this._keyToNumber[e.data.key];null!=t&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}}]),r}(Ju.i),tx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,!0))._view=e,i.registerIncoming("mouse-wheel",n,(function(e){return i._handleMouseWheel(e)})),i}return(0,ku.Z)(r,[{key:"_handleMouseWheel",value:function(e){if(this._view.navigation.mouseWheelZoomEnabled){var t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new X_({view:this._view,mode:"interaction"}):new J_({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,(0,zu.i)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}}]),r}(Ju.i),rx=function(){function e(t){(0,Au.Z)(this,e),this._gain=t}return(0,ku.Z)(e,[{key:"reset",value:function(e){this._value=e}},{key:"gain",set:function(e){this._gain=e}},{key:"value",get:function(){return void 0===this._value?0:this._value}},{key:"update",value:function(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}]),e}(),nx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._beginCamera=new Jy,e._elapsedTimeSec=0,e.constraintOptions={selection:rm.ALL,interactionType:nm.PAN,interactionFactor:0,interactionStartCamera:new Jy,interactionDirection:null,tiltMode:im.TUMBLE},e}return(0,ku.Z)(r,[{key:"initialize",value:function(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Ju.p}},{key:"steppingFinished",get:function(){return this.momentum.isFinished(this._elapsedTimeSec)}},{key:"onControllerStart",value:function(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,(0,_u.Z)((0,bu.Z)(r.prototype),"onControllerStart",this).call(this,e)}},{key:"stepController",value:function(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Zy(this.view,t,this.constraintOptions)}}]),r}(kg),ix=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).interactionType=nm.PAN,n._tmpPan=(0,Vu.n)(),n}return(0,ku.Z)(r,[{key:"momentumStep",value:function(e,t){var r=this.momentum.value(e);(0,Vu.g)(this._tmpPan,this.momentum.direction,r),t.eye=(0,Vu.e)(ax,t.eye,this._tmpPan),t.center=(0,Vu.e)(ax,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}}]),r}(nx=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.MomentumController")],nx));(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ix.prototype,"momentum",void 0),ix=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],ix);var ax=(0,Vu.n)(),ox=(0,Vu.n)(),sx=(0,Vu.n)(),lx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).interactionType=nm.PAN,n}return(0,ku.Z)(r,[{key:"momentumStep",value:function(e,t){var r=this.momentum.value1(e),n=this.momentum.value2(e);(0,Vu.r)(sx,t.eye),(0,Vu.z)(sx,sx),(0,Vu._)(this.momentum.axis2,sx,this.momentum.axis1),w_(t,ox,this.momentum.axis1,r,this.momentum.axis2,n)}}]),r}(nx);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],lx.prototype,"momentum",void 0),lx=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],lx);var ux=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).interactionType=nm.TUMBLE,n}return(0,ku.Z)(r,[{key:"center",set:function(e){this._set("center",(0,Vu.t)(e))}},{key:"axis",set:function(e){this._set("axis",(0,Vu.t)(e))}},{key:"momentumStep",value:function(e,t){var r=this.momentum.value(e);Xg(t,this.center,Lg(this.axis,r))}}]),r}(nx);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ux.prototype,"momentum",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ux.prototype,"center",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ux.prototype,"axis",null),ux=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.MomentumController")],ux);var cx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).interactionType=nm.ZOOM,n.constraintOptions.interactionDirection=(0,Vu.n)(),n}return(0,ku.Z)(r,[{key:"zoomCenter",set:function(e){this._set("zoomCenter",(0,Vu.t)(e))}},{key:"momentumStep",value:function(e,t){(0,Vu.r)(this.constraintOptions.interactionDirection,t.eye);var r=this.momentum.valueDelta(0,e);Qg(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=(0,Vu.H)(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}}]),r}(nx);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],cx.prototype,"momentum",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],cx.prototype,"zoomCenter",null),cx=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],cx);var hx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).interactionType=nm.ZOOM,n.radius=0,n._tmpSceneCenter=(0,Vu.n)(),n._tmpZoomAxisAngle=Ig(),n._sphere=(0,Qu.R)(),n}return(0,ku.Z)(r,[{key:"screenCenter",set:function(e){this._set("screenCenter",(0,zu.i)(e[0],e[1]))}},{key:"sceneCenter",set:function(e){this._set("sceneCenter",(0,Vu.t)(e))}},{key:"initialize",value:function(){this._sphere[3]=this.radius}},{key:"momentumStep",value:function(e,t){var r=this.momentum.valueDelta(0,e);Kg(this._sphere,t,r),this.constraintOptions.interactionType=nm.ZOOM,Zy(this.view,t,this.constraintOptions),f_(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Zg(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Xg(t,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=nm.PAN}}]),r}(nx);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],hx.prototype,"momentum",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],hx.prototype,"screenCenter",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],hx.prototype,"sceneCenter",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],hx.prototype,"radius",void 0),hx=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],hx);var dx=function(){function e(t){(0,Au.Z)(this,e),this._gain=t}return(0,ku.Z)(e,[{key:"update",value:function(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}},{key:"reset",value:function(){this.filteredValue=void 0}},{key:"hasFilteredValue",get:function(){return void 0!==this.filteredValue}}]),e}(),fx=1e-5,px=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o){var s,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6?arguments[6]:void 0;return(0,Au.Z)(this,r),(s=t.call(this,e,n,i))._angularVelocity1=a,s.axis1=o,s.angularVelocity2=l,s.axis2=u,s}return(0,ku.Z)(r,[{key:"value1",value:function(e){return(0,_u.Z)((0,bu.Z)(r.prototype),"valueFromInitialVelocity",this).call(this,this._angularVelocity1,e)}},{key:"value2",value:function(e){return(0,_u.Z)((0,bu.Z)(r.prototype),"valueFromInitialVelocity",this).call(this,this.angularVelocity2,e)}}]),r}(Lc.a),vx=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,Au.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=r,this._friction=n,this.enabled=!0,this._tmpAxis1=(0,Vu.n)(),this._tmpAxis2=(0,Vu.n)(),this._tmpAngles=(0,cc.n)(),this._time=new Lc.t(.3),this._screen=[new Lc.t(.4),new Lc.t(.4)],this._angle1=new dx(.6),this._angle2=new dx(.6),this._axis1=(0,Vu.n)(),this._axis2=(0,Vu.n)(),this._lastScene=(0,Vu.n)()}return(0,ku.Z)(e,[{key:"addMomentumDirectRotation",value:function(e,t,r,n,i,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;var o=y_(this._lastScene,t,this._tmpAxis2,n,i,a);this._angle2.update(0),(0,Vu.v)(this._tmpAxis2)<fx?o=0:(0,Vu.z)(this._axis1,this._tmpAxis2),this._angle1.update(o),(0,Vu.r)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}},{key:"addMomentumPreserveHeading",value:function(e,t,r,n,i,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;b_(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,i,a,o,!1),(0,Vu.v)(this._tmpAxis2)<fx?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Vu.z)(this._axis1,this._tmpAxis1),(0,Vu.z)(this._axis2,this._tmpAxis2)),(0,Vu.r)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?null:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,i=null==r||null==n?0:r/n;return Math.abs(i)<this._minimumInitialVelocity?null:this.createMomentum(i,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,r){var n=this._time.filteredDelta,i=this._angle1.filteredValue,a=this._angle2.filteredValue,o=null==n||null==a?0:a/n;return new px(e,t,r,null==n||null==i?0:i/n,this._axis1,o,this._axis2)}}]),e}(),mx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._smoothRotation=new rx(.05),e._rotationAxis=(0,Vu.n)(),e._panningPlane=(0,Tc.p)(),e._smoothScaling=new rx(.05),e._zoomCenterScreen=(0,zu.i)(),e._zoomMomentumEstimator=new Lc.s,e._rotationMomentumEstimator=new Lc.b,e._panSphericalMomentumEstimator=new vx,e._panPlanarMomentumEstimator=new Lc.l,e._adjustedSphere=(0,Qu.R)(),e._tmp3d=(0,Vu.n)(),e._tmpScreenPointArray=(0,zu.i)(),e._beginScreenPoint=(0,zu.i)(),e._beginScenePoint=(0,Vu.n)(),e._screenPickPoint=(0,zu.i)(),e._mode=Jg.Horizontal,e._tmpInteractionDirection=(0,Vu.n)(),e._constraintOptions={selection:rm.ALL,interactionType:nm.NONE,interactionFactor:0,interactionStartCamera:new Jy,interactionDirection:null,tiltMode:im.TUMBLE},e}return(0,ku.Z)(r,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){var t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panPlanarMomentumEstimator.enabled=t,this._panSphericalMomentumEstimator.enabled=t,this._beginHeading=-Ec.r.normalize((0,Vu.m)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,zu.d)(e.center,this._screenPickPoint),(0,uc.a)(this._beginScreenPoint,this._screenPickPoint);var r=(0,Xu.u)(this.view.spatialReference),n=u_(this._intersectionHelper,this.startCamera,this._screenPickPoint,r,Gg.Silhouette);(0,Nu.t)(n.scenePickPoint)||(this._scenePickPoint=n.scenePickPoint,this._sphere=n.sphere,(0,Vu.r)(this._beginScenePoint,this._scenePickPoint),this._mode=c_(this.startCamera,this._screenPickPoint,n.hasGeometryIntersection,r),this._mode===Jg.Vertical&&this._preparePlanarPanMode(e),this._constraintOptions.interactionStartCamera.copyFrom(this.startCamera))}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1;this._mode===Jg.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===Jg.Horizontal?new hx({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new cx({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});var r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new ux({view:this.view,momentum:r,center:this._sphere,axis:this._rotationAxis});if(this._mode===Jg.Horizontal){var n=this._panSphericalMomentumEstimator.evaluateMomentum();if(n)return new lx({view:this.view,momentum:n})}else{var i=this._panPlanarMomentumEstimator.evaluateMomentum();if(i)return new ix({view:this.view,momentum:i})}return null}},{key:"_preparePlanarPanMode",value:function(e){var t=(0,Vu.q)(this._tmp3d,this.startCamera.viewForward);(0,Tc._)(this._scenePickPoint,t,this._panningPlane);var r=(0,zu.i)(this._screenPickPoint[0],0),n=(0,Vu.n)(),i=(0,Vu.s)(this.startCamera.eye);this._adjustedSphere[3]=i<this._sphere[3]?i-100:this._sphere[3],f_(this._adjustedSphere,this.startCamera,r,n);var a=(0,zu.x)();this.startCamera.projectToRenderScreen(n,a);var o=.9*a[1];this._screenPickPoint[1]=Math.min(this._screenPickPoint[1],o);var s=this._intersectionHelper.intersectScreen(this._screenPickPoint,this._scenePickPoint);s&&(0,Tc._)(this._scenePickPoint,(0,Tc.Y)(this._panningPlane),this._panningPlane);var l=(0,Vu.n)(),u=(0,Vu.n)(),c=(0,Vu.n)();(0,Vu.e)(l,this._scenePickPoint,this.currentCamera.eye);var h=(0,Vu.s)(l);(0,Vu.z)(l,l);var d=5*Math.max(Math.abs(this.view.camera.position.z),50),f=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80),p=(0,Nu.r)(f)?Math.min(f,d):d;p=s?Math.min(p,h):p,(0,Vu.r)(c,(0,Vu.u)(u,this.currentCamera.eye,(0,Vu.g)(u,l,p))),this._panningPlane[3]=-(0,Vu.P)(this._panningPlane,c),this.startCamera.center=(0,Vu.u)(u,this.startCamera.eye,(0,Vu.g)(u,this.startCamera.viewForward,p));var v=(0,zu.d)(e.center,this._tmpScreenPointArray);Yg(this._panningPlane,this.startCamera,v,this._beginScenePoint)}},{key:"_zoomSpherical",value:function(e){var t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),Kg(this._sphere,this.currentCamera,this._smoothScaling.value),(0,zu.d)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=nm.ZOOM,this._constraintOptions.interactionFactor=Fy(e.radius-this._beginRadius),Zy(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningSpherical",value:function(e){var t=(0,zu.d)(e.center,this._tmpScreenPointArray);f_(this._sphere,this.currentCamera,t,this._tmp3d),T_(this._beginScenePoint,(0,Vu.P)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(S_(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(C_(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=nm.PAN,this._constraintOptions.interactionFactor=Fy((0,uc.m)(this._screenPickPoint,t)),Zy(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotateSpherical",value:function(e){(0,Vu.z)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Vu.q)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,r=t+Wg(e.angle-t),n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(r);var i=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(i,.001*e.timestamp),Xg(this.currentCamera,this._sphere,Lg(this._rotationAxis,i)),this._constraintOptions.interactionType=nm.TUMBLE,this._constraintOptions.interactionFactor=Fy(e.radius*r),Zy(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningPlanar",value:function(e){var t=(0,zu.d)(e.center,this._tmpScreenPointArray);Yg(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(h_(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=nm.PAN,this._constraintOptions.interactionFactor=Fy((0,uc.m)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Zy(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}},{key:"_zoomPlanar",value:function(e){var t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Qg(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=nm.ZOOM,this._constraintOptions.interactionFactor=Fy(e.radius-this._beginRadius),Zy(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotatePlanar",value:function(e){(0,Vu.r)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Vu.q)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,r=e.angle-t,n=t+(r=Wg(r)),i=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=i,this._smoothRotation.update(n);var a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Xg(this.currentCamera,this._sphere,Lg(this._rotationAxis,a)),this._constraintOptions.interactionType=nm.TUMBLE,this._constraintOptions.interactionFactor=Fy(e.radius*a),Zy(this.view,this.currentCamera,this._constraintOptions)}}]),r}(Ab);mx=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.global.PinchAndPanController")],mx);var yx=(0,Vu.c)(0,0,1),gx=16/180*Math.PI,_x=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._rotationValueSmooth=new rx(.05),e._scalingValueSmooth=new rx(.05),e._planeHorizontal=(0,Tc.p)(),e._planeVertical=(0,Tc.p)(),e._rotationMomentumEstimator=new Lc.b,e._panMomentumEstimator=new Lc.l(300,12,.9),e._zoomMomentumEstimator=new Lc.s,e._beginCenter=(0,Vu.n)(),e._tmpPoints=[],e._beginCenterScreen=(0,zu.i)(),e._tmpCentroid3d=(0,Vu.n)(),e._tmpCentroid2d=(0,zu.i)(),e._tmp2d=(0,zu.i)(),e._constraintOptions={selection:rm.ALL,interactionType:nm.NONE,interactionFactor:0,interactionStartCamera:new Jy,interactionDirection:null,tiltMode:im.TUMBLE},e}return(0,ku.Z)(r,[{key:"begin",value:function(e){if(this.active){var t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,zu.d)(e.center,this._beginCenterScreen),(0,Tc.T)(yx,0,this._planeHorizontal);var r=(0,Vu.n)(),n=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,r),i=(0,Vu.n)();(0,Vu.q)(i,this.startCamera.viewForward);var a=(0,Vu.n)();(0,Vu.r)(a,yx);var o=(0,Vu.P)(i,a),s=(0,Vu.N)(o<0?-o:o);if(this._panMode=s>=gx?Jg.Horizontal:Jg.Vertical,(0,Tc.L)(this._planeHorizontal,this._planeHorizontal,r),this.startCamera.aboveGround||(0,Tc.P)(this._planeHorizontal,this._planeHorizontal),this._panMode===Jg.Vertical){(0,Vu.g)(a,a,o),(0,Vu.e)(this._planeVertical,i,a),(0,Vu.z)(this._planeVertical,this._planeVertical),(0,Tc.L)(this._planeVertical,this._planeVertical,r);var l=(0,Vu.n)(),u=(0,Vu.n)(),c=(0,Vu.n)();(0,Vu.e)(l,r,this.currentCamera.eye);var h=(0,Vu.s)(l);(0,Vu.z)(l,l);var d=5*Math.max(Math.abs(this.view.camera.position.z),50),f=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80),p=(0,Nu.r)(f)?Math.min(f,d):d;p=n?Math.min(p,h):p,(0,Vu.r)(c,(0,Vu.u)(u,this.currentCamera.eye,(0,Vu.g)(u,l,p))),this._planeVertical[3]=-(0,Vu.P)(this._planeVertical,c),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),e_(this._tmpPoints,this._beginCenter)}else this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),e_(this._tmpPoints,this._beginCenter);this._constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1,r=this._panMode===Jg.Horizontal?this._planeHorizontal:this._planeVertical,n=this._beginCenter;if(t){var i=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(i),Qg(this.currentCamera,n,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=nm.ZOOM,this._constraintOptions.interactionFactor=Fy(Math.abs(e.radius-this._beginRadius)),Zy(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,r,this.currentCamera,this._tmpPoints),e_(this._tmpPoints,this._tmpCentroid3d),(0,zu.d)(e.center,this._tmpCentroid2d),h_(this.currentCamera,n,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=nm.PAN,this._constraintOptions.interactionFactor=Fy((0,uc.m)(this._beginCenterScreen,this._tmpCentroid2d)),Zy(this.view,this.currentCamera,this._constraintOptions),t){var o=this._planeHorizontal,s=n,l=this._rotationValueSmooth.value,u=l+Wg(e.angle-l),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(u);var h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),Xg(this.currentCamera,s,Lg(o,h)),this._constraintOptions.interactionType=nm.TUMBLE,this._constraintOptions.interactionFactor=Fy(Math.abs(e.radius*h)),Zy(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new cx({view:this.view,momentum:t,zoomCenter:this._beginCenter});var r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new ux({view:this.view,momentum:r,center:this._beginCenter,axis:(0,Tc.Y)(this._planeHorizontal)});var n=this._panMomentumEstimator.evaluateMomentum();return n?new ix({view:this.view,momentum:n}):null}},{key:"_computePlanePoints",value:function(e,t,r,n){n.length=e.size;var i=this._tmp2d,a=0;return e.forEach((function(e){i[0]=e.x,i[1]=e.y,void 0===n[a]&&(n[a]=(0,Vu.n)()),Yg(t,r,i,n[a]),a+=1})),n}},{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),r}(Ab);_x=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.controllers.local.PinchAndPanController")],_x);var bx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,!0))._view=e,a.pointerAction=n,a._lastEndTimestamp=0,a._lastTimestamp=0,a.registerIncoming("drag",i,(function(e){return a._handleDrag(e)})),a}return(0,ku.Z)(r,[{key:"_handleDrag",value:function(e){if("mouse"!==e.data.pointerType||(0,Ju.N)(e.data,this.pointerAction)){var t=e.timestamp-this._lastEndTimestamp,r=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}}},{key:"_endController",value:function(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;var r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}},{key:"_startController",value:function(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}},{key:"_createController",value:function(){return this._view.state.isGlobal?new mx({view:this._view}):new _x({view:this._view})}}]),r}(Ju.i),xx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,!0)).view=e,i.registerIncoming("pointer-down",n,(function(){return i.view.state.stopActiveCameraController()})),i}return(0,ku.Z)(r)}(Ju.i),wx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,!0)).key=e,i.registerIncoming("key-down",n,(function(e){return i._handleKeyDown(e)})),i}return(0,ku.Z)(r,[{key:"_handleKeyDown",value:function(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}]),r}(Ju.i),Tx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,n,i)).view=e,a}return(0,ku.Z)(r,[{key:"activate",value:function(){this.view.goTo({heading:0}).catch((function(){}))}}]),r}(wx),Cx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,n,i)).view=e,a}return(0,ku.Z)(r,[{key:"activate",value:function(){this.view.goTo({tilt:0}).catch((function(){}))}}]),r}(wx),Sx=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,Au.Z)(this,r),(n=t.call(this,!0))._view=e,n._invert=i,n.registerIncoming("vertical-two-finger-drag",(function(e){return n._handleTwoFinger(e)})),n}return(0,ku.Z)(r,[{key:"_handleTwoFinger",value:function(e){var t,r,n,i=this._invert?-1:1,a=(0,zu.i)(0,e.data.delta*i);switch(e.data.action){case"begin":null!==(t=this._cameraController)&&void 0!==t&&t.end(),this._cameraController=new kb({view:this._view,pivot:bb.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(a);break;case"update":null===(r=this._cameraController)||void 0===r||r.update(a);break;case"end":null!==(n=this._cameraController)&&void 0!==n&&n.end(),this._cameraController=null}}}]),r}(Ju.i),Ox=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;return(0,Au.Z)(this,r),(e=t.call(this,!1))._threshold=n,e._maxDelta=i,e._state="ready",e._emittedArtificalEnd2=!1,e._vertical=e.registerOutgoing("vertical-two-finger-drag"),e._artificalDrag=e.registerOutgoing("drag"),e._dragEventSeparator=new Ju.a({start:function(t,r){return e._observeStart(t,r)},update:function(t,r,n){return e._observeUpdate(t,r,n)},end:function(t,r){return e._observeEnd(r)}}),e.registerIncoming("drag",(function(t){return e._dragEventSeparator.handle(t)})),e}return(0,ku.Z)(r,[{key:"failed",get:function(){return"failed"===this._state}},{key:"_observeStart",value:function(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}},{key:"_observeUpdate",value:function(e,t,r){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,r.data)?this._checkVerticalThresholdReached(t.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}},{key:"_observeEnd",value:function(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}},{key:"_checkMovementWithinLimits",value:function(e,t){var r,n=-1/0,i=1/0,a=-1/0,o=1/0,s=(0,Cu.Z)(t.pointers.values());try{for(s.s();!(r=s.n()).done;){var l=r.value,u=l.x,c=l.y;n=Math.max(n,u),i=Math.min(i,u),a=Math.max(a,c),o=Math.min(o,c)}}catch(C){s.e(C)}finally{s.f()}var h,d=-1/0,f=1/0,p=-1/0,v=1/0,m=(0,Cu.Z)(e.pointers.values());try{for(m.s();!(h=m.n()).done;){var y=h.value,g=y.x,_=y.y;d=Math.max(d,g),f=Math.min(f,g),p=Math.max(p,_),v=Math.min(v,_)}}catch(C){m.e(C)}finally{m.f()}var b=n-i,x=a-o,w=d-f,T=p-v;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(w-b)<=this._maxDelta&&Math.abs(T-x)<=this._maxDelta}},{key:"_checkVerticalThresholdReached",value:function(e,t){var r=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((function(e,n){var i=t.pointers.get(n);r=Math.min(r,Math.abs(e.y-i.y))})),r>=this._threshold}}]),r}(Ju.i),Px=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._handles=new Eu.X,e}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}},{key:"primaryDragAction",get:function(){return this._get("primaryDragAction")},set:function(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}},{key:"mode",get:function(){return this._get("mode")},set:function(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}},{key:"hasPendingInputs",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.hasPendingInputs}},{key:"latestPointerType",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerType}},{key:"latestPointerLocation",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerLocation}},{key:"multiTouchActive",get:function(){var e,t;return null!==(e=null===(t=this._inputManager)||void 0===t?void 0:t.multiTouchActive)&&void 0!==e&&e}},{key:"disconnect",value:function(){this.view.viewEvents.disconnect(),this._inputManager=(0,Nu.g)(this._inputManager)}},{key:"connect",value:function(){var e=this,t=this.view;this._source=new Ju.u(this.view.surface,t.input);var r=[new Ju.m,new Ju.r,new Ju.f,new Ju.h(this.view.navigation),new Ox],n=new Ju.j({eventSource:this._source,recognizers:r});this._inputManager=n,n.installHandlers("prevent-context-menu",[new Ju.k],Ju.P.INTERNAL),this._modeDragPan=new bx(t,"primary"),this._modeDragRotate=new Db(t,"secondary",bb.CENTER),this._modeDragZoom=new zb(t,"tertiary");var i="b",a={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},o="n",s="p";n.installHandlers("navigation",[new xx(t),new nb(t),new $b(t),new ex(t,a),new tx(t),new Cx(t,s),new Tx(t,o),new Db(t,"primary",bb.EYE,[i]),new Db(t,"secondary",bb.CENTER,[i]),new bx(t,"tertiary",[i]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Sx(t)],Ju.P.INTERNAL),this.view.viewEvents.connect(n),this._updateMode(),this._handles.add((0,Fu.l)((function(){var t;return null===(t=e.view.navigation)||void 0===t?void 0:t.browserTouchPanEnabled}),(function(t){e._source.browserTouchPanningEnabled=!t}),Fu.h))}},{key:"_updateMode",value:function(){var e=this.mode,t=this.primaryDragAction,r=Rx.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom)}},{key:"test",get:function(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],Px.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({value:"pan"})],Px.prototype,"primaryDragAction",null),(0,Eu.e)([(0,Eu.y)({value:"default"})],Px.prototype,"mode",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Px.prototype,"hasPendingInputs",null),(0,Eu.e)([(0,Eu.y)()],Px.prototype,"latestPointerType",null),(0,Eu.e)([(0,Eu.y)()],Px.prototype,"latestPointerLocation",null),(0,Eu.e)([(0,Eu.y)()],Px.prototype,"multiTouchActive",null),(0,Eu.e)([(0,Eu.y)()],Px.prototype,"_inputManager",void 0),Px=(0,Eu.e)([(0,Eu.n)("esri.views.3d.input.SceneInputManager")],Px);var Rx=new Map,Ax=new Map,kx=new Map;Ax.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Ax.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),kx.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),kx.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Rx.set("default",Ax),Rx.set("pro",kx);var Ex,Dx,Mx,Ix,Lx,Zx,Nx=Px,Fx=!1,zx=!1,Ux=!1,Vx=!1,Bx=null;function Gx(e){Ux=Ac.t.DECONFLICTOR_SHOW_VISIBLE,Vx=Ac.t.DECONFLICTOR_SHOW_INVISIBLE,Fx=Ux||Vx,zx=Ac.t.DECONFLICTOR_SHOW_GRID,Bx=null,Fx||zx?Bx=function(){return function(e){null==Ex&&((Ex=document.createElement("canvas")).setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Ex));var t=e.state,r=t.camera,n=t.pixelRatio,i=r.width,a=r.height,o=i*n,s=a*n;Ex.setAttribute("width","".concat(o,"px")),Ex.setAttribute("height","".concat(s,"px")),Ex.setAttribute("style","position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:".concat(i,"px;height:").concat(a,"px")),(Dx=Ex.getContext("2d")).clearRect(0,0,i,a),Dx.font="12px Arial"}(e)}:Ex&&(Ex.parentElement.removeChild(Ex),Ex=null)}function Hx(){Bx&&(Bx(),Bx=null)}function jx(e,t,r,n,i){Hx();var a=Ex.height,o=Dx;o.beginPath(),o.lineWidth=1,o.strokeStyle=i,o.moveTo(e,a-r),o.lineTo(t,a-r),o.stroke(),o.lineTo(t,a-n),o.stroke(),o.lineTo(t,a-r),o.stroke(),o.lineTo(e,a-r),o.stroke(),o.lineTo(e,a-r),o.stroke(),o.closePath()}function qx(e,t){Fx&&(t&&Ux||!t&&Vx)&&jx(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}function Wx(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}function Xx(e,t){e.include(dc.S),e.attributes.add(fc.O.POSITION,"vec3"),e.attributes.add(fc.O.NORMAL,"vec3"),e.attributes.add(fc.O.AUXPOS1,"vec4");var r=e.vertex;(0,dc.T)(r,t),(0,dc.U)(r,t),r.uniforms.add([new dc.f("viewport",(function(e,t){return t.camera.fullViewport})),new dc.g("polygonOffset",(function(e){return e.shaderPolygonOffset})),new dc.g("cameraGroundRelative",(function(e,t){return t.camera.aboveGround?1:-1})),new dc.g("renderTransparentlyOccludedHUD",(function(e,t){return t.renderTransparentlyOccludedHUD===Lx.Occluded?1:t.renderTransparentlyOccludedHUD===Lx.NotOccluded?0:.75})),new dc.h("hudVisibilityTexture",(function(e,t){return t.hudVisibilityTexture}))]),t.hasVerticalOffset&&(0,dc.V)(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add((0,dc.n)(ge||(ge=(0,wu.Z)(["struct ProjectHUDAux {\nvec3 posModel;\nvec3 posView;\nvec3 vnormal;\nfloat distanceToCamera;\nfloat absCosAngle;\n};"])))),r.code.add((0,dc.n)(_e||(_e=(0,wu.Z)(["float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {\nfloat pointGroundSign = sign(pointGroundDistance);\nif (pointGroundSign == 0.0) {\npointGroundSign = cameraGroundRelative;\n}\nfloat groundRelative = cameraGroundRelative * pointGroundSign;\nif (polygonOffset > .0) {\nfloat cosAlpha = clamp(absCosAngle, 0.01, 1.0);\nfloat tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;\nfloat factor = (1.0 - tanAlpha / viewport[2]);\nif (groundRelative > 0.0) {\nposView *= factor;\n}\nelse {\nposView /= factor;\n}\n}\nreturn groundRelative;\n}"])))),t.isDraped&&!t.hasVerticalOffset||(0,dc.W)(r),t.isDraped||(r.uniforms.add(new dc.g("perDistancePixelRatio",(function(e,t){return Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)}))),r.code.add((0,dc.n)(be||(be=(0,wu.Z)(["void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {\nfloat distanceToCamera = length(posView);\nfloat pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;\nvec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;\nvec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\nposModel += modelOffset;\nposView += viewOffset;\n}"]))))),t.screenCenterOffsetUnitsEnabled===Zx.Screen&&r.uniforms.add(new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),t.hasScreenSizePerspective&&(0,dc.X)(r),r.code.add((0,dc.n)(xe||(xe=(0,wu.Z)(["\n    vec4 projectPositionHUD(out ProjectHUDAux aux) {\n      // centerOffset is in view space and is used to implement world size offsetting\n      // of labels with respect to objects. It also pulls the label towards the viewer\n      // so that the label is visible in front of the object.\n      vec3 centerOffset = auxpos1.xyz;\n\n      // The pointGroundDistance is the distance of the geometry to the ground and is\n      // negative if the point is below the ground, or positive if the point is above\n      // ground.\n      float pointGroundDistance = auxpos1.w;\n\n      aux.posModel = position;\n      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;\n      aux.vnormal = normal;\n      ","\n\n      // Screen sized offset in world space, used for example for line callouts\n      // Note: keep this implementation in sync with the CPU implementation, see\n      //   - MaterialUtil.verticalOffsetAtDistance\n      //   - HUDMaterial.applyVerticalOffsetTransformation\n\n      aux.distanceToCamera = length(aux.posView);\n\n      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);\n      float cosAngle = dot(aux.vnormal, viewDirObjSpace);\n\n      aux.absCosAngle = abs(cosAngle);\n\n      ","\n\n      ","\n\n      ","\n\n      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);\n\n      ","\n\n      vec4 posProj = proj * vec4(aux.posView, 1.0);\n\n      ","\n\n      ","\n\n      // constant part of polygon offset emulation\n      posProj.z -= groundRelative * polygonOffset * posProj.w;\n      return posProj;\n    }\n  "])),t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);",t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled===Zx.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":"",t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":"",t.hasVerticalOffset?(0,dc.n)(we||(we=(0,wu.Z)(["\n            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);\n            vec3 modelOffset = aux.vnormal * worldOffset;\n            aux.posModel += modelOffset;\n            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n            aux.posView += viewOffset;\n            // Since we elevate the object, we need to take that into account\n            // in the distance to ground\n            pointGroundDistance += worldOffset;"]))):"",t.screenCenterOffsetUnitsEnabled!==Zx.Screen?(0,dc.n)(Te||(Te=(0,wu.Z)(["\n            // Apply x/y in view space, but z in screen space (i.e. along posView direction)\n            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);\n\n            // Same material all have same z != 0.0 condition so should not lead to\n            // branch fragmentation and will save a normalization if it's not needed\n            if (centerOffset.z != 0.0) {\n              aux.posView -= normalize(aux.posView) * centerOffset.z;\n            }\n          "]))):"",t.screenCenterOffsetUnitsEnabled===Zx.Screen?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":"",t.screenCenterOffsetUnitsEnabled===Zx.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":"")),r.code.add((0,dc.n)(Ce||(Ce=(0,wu.Z)(["bool testVisibilityHUD(vec4 posProj) {\nvec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);\nvec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);\nif (renderTransparentlyOccludedHUD > 0.5) {\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;\n}\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;\n}"]))))}!function(e){e[e.GRAPHIC=0]="GRAPHIC",e[e.LABEL=1]="LABEL",e[e._COUNT=2]="_COUNT"}(Mx||(Mx={})),function(e){e[e.USER_SETTING=0]="USER_SETTING",e[e.SCALE_RANGE=1]="SCALE_RANGE",e[e.FILTER=2]="FILTER",e[e.DECONFLICTION=3]="DECONFLICTION",e[e._COUNT=4]="_COUNT"}(Ix||(Ix={})),function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(Lx||(Lx={})),function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"}(Zx||(Zx={}));var Yx=128,Qx=.5;function Kx(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Yx,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*Qx,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=Jx(e,t,r,n);return new dc.Y(i,{mipmap:!1,wrap:{s:pc.D.CLAMP_TO_EDGE,t:pc.D.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function Jx(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Yx,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*Qx,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(e){case"circle":default:return $x(t,r);case"square":return ew(t,r);case"cross":return rw(t,r,n);case"x":return nw(t,r,n);case"kite":return tw(t,r);case"triangle":return iw(t,r);case"arrow":return aw(t,r)}}function $x(e,t){var r=e/2-.5;return cw(e,lw(r,r,t/2))}function ew(e,t){return ow(e,t,!1)}function tw(e,t){return ow(e,t,!0)}function rw(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return sw(e,t,!1,r)}function nw(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return sw(e,t,!0,r)}function iw(e,t){return cw(e,uw(e/2,t,t/2))}function aw(e,t){var r=t,n=t/2,i=e/2,a=.8*r,o=lw(i,(e-t)/2-a,Math.sqrt(a*a+n*n)),s=uw(i,r,n);return cw(e,(function(e,t){return Math.max(s(e,t),-o(e,t))}))}function ow(e,t,r){return r&&(t/=Math.SQRT2),cw(e,(function(n,i){var a=n-.5*e+.25,o=.5*e-i-.75;if(r){var s=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=s}return Math.max(Math.abs(a),Math.abs(o))-.5*t}))}function sw(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t-=n,r&&(t*=Math.SQRT2);var i=.5*t;return cw(e,(function(t,a){var o,s=t-.5*e,l=.5*e-a-1;if(r){var u=(s+l)/Math.SQRT2;l=(l-s)/Math.SQRT2,s=u}return o=(s=Math.abs(s))>(l=Math.abs(l))?s>i?Math.sqrt((s-i)*(s-i)+l*l):l:l>i?Math.sqrt(s*s+(l-i)*(l-i)):s,o-=n/2}))}function lw(e,t,r){return function(n,i){var a=n-e,o=i-t;return Math.sqrt(a*a+o*o)-r}}function uw(e,t,r){var n=Math.sqrt(t*t+r*r);return function(i,a){var o=Math.abs(i-e)-r,s=a-e+t/2+.75,l=(t*o+r*s)/n,u=-s;return Math.max(l,u)}}function cw(e,t){for(var r=new Uint8Array(4*e*e),n=0;n<e;n++)for(var i=0;i<e;i++){var a=i+e*n,o=t(i,n);o=o/e+.5,(0,Nc.o)(o,r,4*a)}return r}function hw(e,t){var r=e.vertex,n=e.fragment;t.hasMultipassGeometry&&r.include(Rf),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.code.add((0,dc.n)(Se||(Se=(0,wu.Z)(["\n  void main(void) {\n    vec4 posProjCenter;\n    if (dot(position, position) > 0.0) {\n      // Render single point to center of the pixel to avoid subpixel\n      // filtering to affect the marker color\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      posProjCenter = alignToPixelCenter(posProj, viewport.zw);\n\n      ","\n\n      ","\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        // Project out of clip space\n        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n      }\n\n    } else {\n      // Project out of clip space\n      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n\n    gl_Position = posProjCenter;\n    gl_PointSize = 1.0;\n  }\n  "])),t.hasMultipassGeometry?(0,dc.n)(Oe||(Oe=(0,wu.Z)(["\n        // Don't draw vertices behind geometry\n        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){\n          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n        }"]))):"",t.hasMultipassTerrain?"depth = projectAux.posView.z;":"")),t.hasMultipassTerrain&&n.include(dc.j),t.hasMultipassTerrain&&n.uniforms.add([].concat((0,mu.Z)((0,dc.Z)("terrainDepthTexture",(function(e,t){return t.multipassTerrain.linearDepthTexture}),t.hasWebGL2Context?dc.$.None:dc.$.InvSize)),[new dc.b("nearFar",(function(e,t){return t.camera.nearFar}))])),n.include(dc.y),n.code.add((0,dc.n)(Pe||(Pe=(0,wu.Z)(["\n  void main() {\n    gl_FragColor = vec4(1, 1, 1, 1);\n    ","\n  }\n  "])),t.hasMultipassTerrain?(0,dc.n)(Re||(Re=(0,wu.Z)(["\n          vec2 uv = gl_FragCoord.xy;\n\n          // Read the rgba data from the texture linear depth\n          vec4 terrainDepthData = ",";\n\n          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);\n\n          // If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)\n          // Mark the HUD vertex as occluded by transparent terrain\n          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){\n            gl_FragColor.g = 0.5;\n          }"])),(0,dc._)(t,"terrainDepthTexture","uv")):""))}function dw(e){var t=new dc.o,r=e.signedDistanceFieldEnabled;if(t.include(nv),t.include(Xx,e),t.include(dc.a0,e),e.occlusionPass)return t.include(hw,e),t;var n=t.vertex,i=t.fragment;t.include(dc.S),i.include(dc.y),i.include(dc.x),t.include(dc.a1,e),t.include(dc.a2,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),n.uniforms.add([new dc.f("viewport",(function(e,t){return t.camera.fullViewport})),new dc.b("screenOffset",(function(e,t){return(0,uc.r)(mw,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio)})),new dc.b("anchorPosition",(function(e){return pw(e)})),new dc.f("materialColor",(function(e){return e.color})),new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),r&&(n.uniforms.add(new dc.f("outlineColor",(function(e){return e.outlineColor}))),i.uniforms.add([new dc.f("outlineColor",(function(e){return fw(e)?e.outlineColor:lc.l})),new dc.g("outlineSize",(function(e){return fw(e)?e.outlineSize:0}))])),e.hasScreenSizePerspective&&((0,dc.a3)(n),(0,dc.X)(n)),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(fc.O.UV0,"vec2"),t.attributes.add(fc.O.COLOR,"vec4"),t.attributes.add(fc.O.SIZE,"vec2"),t.attributes.add(fc.O.AUXPOS2,"vec4"),n.code.add((0,dc.n)(Ae||(Ae=(0,wu.Z)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      forwardObjectAndLayerIdColor();\n\n      if (rejectBySlice(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n      vec2 inputSize;\n      ","\n\n      ","\n\n      vec2 combinedSize = inputSize * pixelRatio;\n      vec4 quadOffset = vec4(0.0);\n\n      ","\n\n      ","\n    "])),e.hasScreenSizePerspective?(0,dc.n)(ke||(ke=(0,wu.Z)(["\n      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);\n      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n         "]))):(0,dc.n)(Ee||(Ee=(0,wu.Z)(["\n      inputSize = size;\n      vec2 screenOffsetScaled = screenOffset;"]))),e.vvSize?"inputSize *= vvScale(auxpos2).xx;":"",e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":"",e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""));var a=(0,dc.n)(De||(De=(0,wu.Z)(["vec2 uv01 = floor(uv0);\nvec2 uv = uv0 - uv01;\nquadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;"]))),o=e.pixelSnappingEnabled?r?(0,dc.n)(Me||(Me=(0,wu.Z)(["posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;"]))):(0,dc.n)(Ie||(Ie=(0,wu.Z)(["posProj += quadOffset;\nif (inputSize.x == size.x) {\nposProj = alignToPixelOrigin(posProj, viewport.zw);\n}"]))):(0,dc.n)(Le||(Le=(0,wu.Z)(["posProj += quadOffset;"])));e.vvColor&&n.uniforms.add([new dc.a4("vvColorColors",(function(e){return e.vvColorColors}),dc.a5),new dc.a6("vvColorValues",(function(e){return e.vvColorValues}),dc.a5)]),n.uniforms.add(new dc.b("textureCoordinateScaleFactor",(function(e){return(0,Nu.r)(e.texture)&&(0,Nu.r)(e.texture.descriptor.textureCoordinateScaleFactor)?e.texture.descriptor.textureCoordinateScaleFactor:cc.i}))),n.code.add((0,dc.n)(Ze||(Ze=(0,wu.Z)(["\n    ","\n    ","\n    ","\n\n    bool alphaDiscard = vcolor.a < ",";\n    ",'\n    if (alphaDiscard) {\n      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    } else {\n      ',"\n      gl_Position = posProj;\n    }\n\n    vtc = uv * textureCoordinateScaleFactor;\n\n    ","\n    vsize = inputSize;\n    ","\n  }\n  "])),e.occlusionTestEnabled?"if (visible) {":"",a,e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;",dc.n.float(dc.a7),r?"alphaDiscard = alphaDiscard && outlineColor.a < ".concat(dc.n.float(dc.a7),";"):"",o,e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":"",e.occlusionTestEnabled?(0,dc.n)(Ne||(Ne=(0,wu.Z)(["} else { vtc = vec2(0.0);\n      ",""])),e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"):"")),i.uniforms.add(new dc.h("tex",(function(e){return e.texture})));var s=e.debugDrawLabelBorder?(0,dc.n)(Fe||(Fe=(0,wu.Z)(["(isBorder > 0.0 ? 0.0 : ",")"])),dc.n.float(dc.a8)):dc.n.float(dc.a8),l=(0,dc.n)(ze||(ze=(0,wu.Z)(["\n    ","\n\n    ","\n\n    // Draw debug border with transparency, so that original texels along border are still partially visible\n    ","\n  "])),e.debugDrawLabelBorder?(0,dc.n)(Ue||(Ue=(0,wu.Z)(["\n      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));"]))):"",r?(0,dc.n)(Ve||(Ve=(0,wu.Z)(["\n      vec4 fillPixelColor = vcolor;\n\n      // Attempt to sample texel centers to avoid that thin cross outlines\n      // disappear with large symbol sizes.\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041\n      const float txSize = ",";\n      const float texelSize = 1.0 / txSize;\n      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel\n      vec2 scaleFactor = (vsize - txSize) * texelSize;\n      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;\n\n      // Get distance and map it into [-0.5, 0.5]\n      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;\n\n      // Distance in output units (i.e. pixels)\n      float dist = d * vsize.x;\n\n      // Create smooth transition from the icon into its outline\n      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);\n      fillPixelColor.a *= fillAlphaFactor;\n\n      if (outlineSize > 0.25) {\n        vec4 outlinePixelColor = outlineColor;\n        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);\n\n        // Create smooth transition around outline\n        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);\n        outlinePixelColor.a *= outlineAlphaFactor;\n\n        if (\n          outlineAlphaFactor + fillAlphaFactor < "," ||\n          fillPixelColor.a + outlinePixelColor.a < ","\n        ) {\n          discard;\n        }\n\n        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)\n        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);\n        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +\n          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);\n\n        gl_FragColor = vec4(compositeColor, compositeAlpha);\n      } else {\n        if (fillAlphaFactor < ",") {\n          discard;\n        }\n\n        gl_FragColor = premultiplyAlpha(fillPixelColor);\n      }\n\n      // visualize SDF:\n      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);\n      "])),dc.n.float(Yx),s,dc.n.float(dc.a7),s):(0,dc.n)(Be||(Be=(0,wu.Z)(["\n          vec4 texColor = texture2D(tex, vtc, -0.5);\n          if (texColor.a < ",") {\n            discard;\n          }\n          gl_FragColor = texColor * premultiplyAlpha(vcolor);\n          "])),s),e.debugDrawLabelBorder?(0,dc.n)(Ge||(Ge=(0,wu.Z)(["gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);"]))):"");return e.output===dc.O.Alpha&&i.code.add((0,dc.n)(He||(He=(0,wu.Z)(["\n      void main() {\n        ","\n        gl_FragColor = vec4(gl_FragColor.a);\n      }\n      "])),l)),e.output===dc.O.ObjectAndLayerIdColor&&i.code.add((0,dc.n)(je||(je=(0,wu.Z)(["\n      void main() {\n        ","\n        outputObjectAndLayerIdColor();\n      }\n      "])),l)),e.output===dc.O.Color&&i.code.add((0,dc.n)(qe||(qe=(0,wu.Z)(["\n    void main() {\n      ","\n      ","\n    }\n    "])),l,e.transparencyPassType===vc.o.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":"")),e.output===dc.O.Highlight&&(t.include(dc.a9,e),i.code.add((0,dc.n)(We||(We=(0,wu.Z)(["\n    void main() {\n      ","\n      ","\n    }\n    "])),l,e.binaryHighlightOcclusionEnabled?(0,dc.n)(Xe||(Xe=(0,wu.Z)(["\n          if (voccluded == 1.0) {\n            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);\n          } else {\n            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n          }"]))):"outputHighlight();"))),t}function fw(e){return e.outlineColor[3]>0&&e.outlineSize>0}function pw(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:mw;return e.textureIsSignedDistanceField?vw(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,uc.a)(t,e.anchorPosition),t}function vw(e,t,r){(0,Nu.r)(t)?(0,uc.r)(r,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,uc.r)(r,0,0)}var mw=(0,cc.n)(),yw=Object.freeze(Object.defineProperty({__proto__:null,build:dw,calculateAnchorPosForRendering:pw},Symbol.toStringTag,{value:"Module"})),gw=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2,t.spherical=e.viewingMode===ic.l.Global}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,r=e===vc.o.NONE,n=e===vc.o.FrontFace,i=this.configuration.hasPolygonOffset&&_w,a=(r||n)&&t.output!==dc.O.Highlight?(t.depthEnabled||t.occlusionPass)&&vc.b:null;return(0,vc.W)({blending:t.output===dc.O.Color||t.output===dc.O.Alpha||t.output===dc.O.Highlight?r?bw:(0,vc.A)(e):null,depthTest:{func:pc.I.LEQUAL},depthWrite:a,colorWrite:vc._,polygonOffset:i})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}},{key:"primitiveType",get:function(){return this.configuration.occlusionPass?pc.E.POINTS:pc.E.TRIANGLES}}]),r}(dc.k);gw.shader=new dc.m(yw,(function(){return r.e(5008).then(r.bind(r,25008))}));var _w={factor:0,units:-4},bw=(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),xw=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.screenCenterOffsetUnitsEnabled=Zx.World,e.transparencyPassType=vc.o.NONE,e.spherical=!1,e.occlusionTestEnabled=!0,e.signedDistanceFieldEnabled=!1,e.vvSize=!1,e.vvColor=!1,e.hasVerticalOffset=!1,e.hasScreenSizePerspective=!1,e.debugDrawLabelBorder=!1,e.binaryHighlightOcclusionEnabled=!0,e.hasSlicePlane=!1,e.hasPolygonOffset=!1,e.depthEnabled=!0,e.pixelSnappingEnabled=!0,e.isDraped=!1,e.hasMultipassGeometry=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.occlusionPass=!1,e.objectAndLayerIdColorInstanced=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],xw.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:Zx.COUNT})],xw.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],xw.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"occlusionTestEnabled",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"signedDistanceFieldEnabled",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"vvSize",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"vvColor",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasVerticalOffset",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasScreenSizePerspective",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"debugDrawLabelBorder",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"binaryHighlightOcclusionEnabled",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasPolygonOffset",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"depthEnabled",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"pixelSnappingEnabled",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"isDraped",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasMultipassGeometry",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"occlusionPass",void 0),(0,Eu.e)([(0,dc.p)()],xw.prototype,"objectAndLayerIdColorInstanced",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],xw.prototype,"hasSliceInVertexProgram",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],xw.prototype,"hasVvInstancing",void 0);var ww=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new Hw))._configuration=new xw,n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?Zx.Screen:Zx.World,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.isDraped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.vvSize=!!this.parameters.vvSizeEnabled,this._configuration.vvColor=!!this.parameters.vvColorEnabled,this._configuration.occlusionPass=t.slot===dc.H.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===dc.O.Color||e===dc.O.Alpha),e===dc.O.Color&&(this._configuration.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),e===dc.O.Highlight&&(this._configuration.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassGeometry=t.multipassGeometry.enabled,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"intersect",value:function(e,t,r,n,i,a,o,s,l){(0,Nu.r)(l)?this._intersectDrapedHudGeometry(e,a,o,s,l):this._intersectHudGeometry(e,t,r,n,o,s)}},{key:"_intersectDrapedHudGeometry",value:function(e,t,r,n,i){var a=e.vertexAttributes.get(fc.O.POSITION),o=e.vertexAttributes.get(fc.O.SIZE),s=this.parameters,l=pw(s),u=1,c=1;if((0,Nu.r)(n)){var h=n(zw);u=h[0],c=h[5]}u*=e.screenToWorldRatio,c*=e.screenToWorldRatio;for(var d=Vw*e.screenToWorldRatio,f=0;f<a.data.length/a.size;f++){var p=f*a.size,v=a.data[p],m=a.data[p+1],y=f*o.size,g=void 0;Bw[0]=o.data[y]*u,Bw[1]=o.data[y+1]*c,s.textureIsSignedDistanceField&&(g=s.outlineSize*e.screenToWorldRatio/2),Sw(t,v,m,Bw,d,g,s,l)&&r(i.dist,i.normal,-1,!1)}}},{key:"_intersectHudGeometry",value:function(e,t,r,n,i,a){if(n.options.selectionMode&&n.options.hud&&!(0,Ic.a)(t)){var o=this.parameters,s=1,l=1;if((0,mc.a)(Iw,r),(0,Nu.r)(a)){var u=a(zw);s=u[0],l=u[5],function(e){var t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8],c=1/Math.sqrt(t*t+r*r+n*n),h=1/Math.sqrt(i*i+a*a+o*o),d=1/Math.sqrt(s*s+l*l+u*u);e[0]=t*c,e[1]=r*c,e[2]=n*c,e[3]=i*h,e[4]=a*h,e[5]=o*h,e[6]=s*d,e[7]=l*d,e[8]=u*d}(Iw)}var c=e.vertexAttributes.get(fc.O.POSITION),h=e.vertexAttributes.get(fc.O.SIZE),d=e.vertexAttributes.get(fc.O.NORMAL),f=e.vertexAttributes.get(fc.O.AUXPOS1);(0,Sc.e)(c.size>=3);var p=n.point,v=n.camera,m=pw(o);s*=v.pixelRatio,l*=v.pixelRatio;for(var y="screen"===this.parameters.centerOffsetUnits,g=0;g<c.data.length/c.size;g++){var _=g*c.size;(0,Vu.o)(Aw,c.data[_],c.data[_+1],c.data[_+2]),(0,Vu.O)(Aw,Aw,r);var b=g*h.size;Bw[0]=h.data[b]*s,Bw[1]=h.data[b+1]*l,(0,Vu.O)(Aw,Aw,v.viewMatrix);var x=g*f.size;if((0,Vu.o)(Nw,f.data[x+0],f.data[x+1],f.data[x+2]),!y&&(Aw[0]+=Nw[0],Aw[1]+=Nw[1],0!==Nw[2])){var w=Nw[2];(0,Vu.z)(Nw,Aw),(0,Vu.e)(Aw,Aw,(0,Vu.g)(Nw,Nw,w))}var T=g*d.size;if((0,Vu.o)(kw,d.data[T],d.data[T+1],d.data[T+2]),this._normalAndViewAngle(kw,Iw,v,Fw),this._applyVerticalOffsetTransformationView(Aw,Fw,v,Pw),v.applyProjection(Aw,Ew),Ew[0]>-1){Ew[0]=Math.floor(Ew[0]),Ew[1]=Math.floor(Ew[1]),y&&(Nw[0]||Nw[1])&&(Ew[0]+=Nw[0],0!==Nw[1]&&(Ew[1]+=(0,dc.ab)(Nw[1],Pw.factorAlignment)),v.unapplyProjection(Ew,Aw)),Ew[0]+=this.parameters.screenOffset[0],Ew[1]+=this.parameters.screenOffset[1],(0,dc.ac)(Bw,Pw.factor,Bw);var C=Uw*v.pixelRatio,S=void 0;if(o.textureIsSignedDistanceField&&(S=o.outlineSize*v.pixelRatio/2),Sw(p,Ew[0],Ew[1],Bw,C,S,o,m)){var O=n.ray;if((0,Vu.O)(Mw,Aw,(0,Wu.h)(Zw,v.viewMatrix)),Ew[0]=p[0],Ew[1]=p[1],v.unprojectFromRenderScreen(Ew,Aw)){var P=(0,Vu.n)();(0,Vu.r)(P,O.direction);var R=1/(0,Vu.s)(P);(0,Vu.g)(P,P,R),i((0,Vu.x)(O.origin,Aw)*R,P,-1,!0,1,Mw)}}}}}}},{key:"computeAttachmentOrigin",value:function(e,t){var r=e.vertexAttributes;if(!r)return!1;var n=r.get(fc.O.POSITION),i=e.indices.get(fc.O.POSITION);return(0,dc.ad)(n,i,t)}},{key:"createBufferWriter",value:function(){return new Ww(this)}},{key:"_normalAndViewAngle",value:function(e,t,r,n){return Wx(t)&&(t=(0,mc.a)(Lw,t)),(0,Vu.S)(n.normal,e,t),(0,Vu.O)(n.normal,n.normal,r.viewInverseTransposeMatrix),n.cosAngle=(0,Vu.P)(Dw,Gw),n}},{key:"_updateScaleInfo",value:function(e,t,r){var n=this.parameters;(0,Nu.r)(n.screenSizePerspective)?(0,dc.ae)(r,t,n.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),(0,Nu.r)(n.screenSizePerspectiveAlignment)?(0,dc.ae)(r,t,n.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}},{key:"applyShaderOffsetsView",value:function(e,t,r,n,i,a,o){var s=this._normalAndViewAngle(t,r,i,Fw);return this._applyVerticalGroundOffsetView(e,s,i,o),this._applyVerticalOffsetTransformationView(o,s,i,a),this._applyPolygonOffsetView(o,s,n[3],i,o),this._applyCenterOffsetView(o,n,o),o}},{key:"applyShaderOffsetsNDC",value:function(e,t,r,n,i){return this._applyCenterOffsetNDC(e,t,r,n),(0,Nu.r)(i)&&(0,Vu.r)(i,n),this._applyPolygonOffsetNDC(n,t,r,n),n}},{key:"_applyPolygonOffsetView",value:function(e,t,r,n,i){var a=n.aboveGround?1:-1,o=Math.sign(r);0===o&&(o=a);var s=a*o;if(this.parameters.shaderPolygonOffset<=0)return(0,Vu.r)(i,e);var l=(0,Vu.a)(Math.abs(t.cosAngle),.01,1),u=1-Math.sqrt(1-l*l)/l/n.viewport[2];return(0,Vu.g)(i,e,s>0?u:1/u),i}},{key:"_applyVerticalGroundOffsetView",value:function(e,t,r,n){var i=(0,Vu.s)(e),a=r.aboveGround?1:-1,o=.5*r.computeRenderPixelSizeAtDist(i),s=(0,Vu.g)(Aw,t.normal,a*o);return(0,Vu.u)(n,e,s),n}},{key:"_applyVerticalOffsetTransformationView",value:function(e,t,r,n){var i=this.parameters;if(!i.verticalOffset||!i.verticalOffset.screenLength){if(i.screenSizePerspective||i.screenSizePerspectiveAlignment){var a=(0,Vu.s)(e);this._updateScaleInfo(n,a,t.cosAngle)}else n.factor.scale=1,n.factorAlignment.scale=1;return e}var o=(0,Vu.s)(e),s=(0,Nu.v)(i.screenSizePerspectiveAlignment,i.screenSizePerspective),l=(0,dc.an)(r,o,i.verticalOffset,t.cosAngle,s);return this._updateScaleInfo(n,o,t.cosAngle),(0,Vu.g)(t.normal,t.normal,l),(0,Vu.u)(e,e,t.normal)}},{key:"_applyCenterOffsetView",value:function(e,t,r){var n="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,Vu.r)(r,e),n&&(r[0]+=t[0],r[1]+=t[1],t[2]&&((0,Vu.z)(kw,r),(0,Vu.u)(r,r,(0,Vu.g)(kw,kw,t[2])))),r}},{key:"_applyCenterOffsetNDC",value:function(e,t,r,n){var i="screen"!==this.parameters.centerOffsetUnits;return n!==e&&(0,Vu.r)(n,e),i||(n[0]+=t[0]/r.fullWidth*2,n[1]+=t[1]/r.fullHeight*2),n}},{key:"_applyPolygonOffsetNDC",value:function(e,t,r,n){var i=this.parameters.shaderPolygonOffset;if(e!==n&&(0,Vu.r)(n,e),i){var a=r.aboveGround?1:-1,o=a*Math.sign(t[3]);n[2]-=(o||a)*i}return n}},{key:"requiresSlot",value:function(e,t){if(t===dc.O.Color||t===dc.O.Alpha||t===dc.O.Highlight||t===dc.O.ObjectAndLayerIdColor){if(e===dc.H.DRAPED_MATERIAL)return!0;var r=this.parameters,n=r.drawInSecondSlot,i=r.occlusionTest;return e===(n?dc.H.LABEL_MATERIAL:dc.H.HUD_MATERIAL)||i&&e===dc.H.OCCLUSION_PIXELS}return!1}},{key:"createGLMaterial",value:function(e){return new Tw(e)}},{key:"calculateRelativeScreenBounds",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,ju.u)();return Cw(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}}]),r}(dc.aa),Tw=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,(0,Tu.Z)((0,Tu.Z)({},e),e.material.parameters))}return(0,ku.Z)(r,[{key:"selectProgram",value:function(e){return this.ensureTechnique(gw,e)}},{key:"beginSlot",value:function(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}]),r}(dc.af);function Cw(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Rw;return(0,uc.a)(n,e.anchorPosition),n[0]*=-t[0],n[1]*=-t[1],n[0]+=e.screenOffset[0]*r,n[1]+=e.screenOffset[1]*r,n}function Sw(e,t,r,n,i,a,o,s){var l=t-i-(s[0]>0?n[0]*s[0]:0),u=l+n[0]+2*i,c=r-i-(s[1]>0?n[1]*s[1]:0),h=c+n[1]+2*i,d=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&(0,Nu.r)(d)&&(l+=n[0]*d[0],c+=n[1]*d[1],u-=n[0]*(1-d[2]),h-=n[1]*(1-d[3]),l-=a,u+=a,c-=a,h+=a),e[0]>l&&e[0]<u&&e[1]>c&&e[1]<h}var Ow,Pw={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},Rw=(0,cc.n)(),Aw=(0,Vu.n)(),kw=(0,Vu.n)(),Ew=(0,lc.n)(),Dw=(0,Vu.n)(),Mw=(0,Vu.n)(),Iw=(0,gc.e)(),Lw=(0,gc.e)(),Zw=(0,hc.e)(),Nw=(0,Vu.n)(),Fw={normal:Dw,cosAngle:0},zw=(0,hc.e)(),Uw=1,Vw=2,Bw=[0,0],Gw=(0,Vu.c)(0,0,1),Hw=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).renderOccluded=dc.ah.Occlude,e.color=(0,lc.r)(1,1,1,1),e.texCoordScale=[1,1],e.polygonOffset=!1,e.anchorPosition=(0,cc.r)(.5,.5),e.screenOffset=[0,0],e.shaderPolygonOffset=1e-5,e.textureIsSignedDistanceField=!1,e.outlineColor=(0,lc.r)(1,1,1,1),e.outlineSize=0,e.vvSizeEnabled=!1,e.vvSizeMinSize=[1,1,1],e.vvSizeMaxSize=[100,100,100],e.vvSizeOffset=[0,0,0],e.vvSizeFactor=[1,1,1],e.vvColorEnabled=!1,e.vvColorValues=[0,0,0,0,0,0,0,0],e.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],e.hasSlicePlane=!1,e.pixelSnappingEnabled=!0,e.occlusionTest=!0,e.binaryHighlightOcclusion=!0,e.debugDrawLabelBorder=!1,e.centerOffsetUnits="world",e.drawInSecondSlot=!1,e.depthEnabled=!0,e.isDraped=!1,e}return(0,ku.Z)(r)}(dc.ag),jw=(0,wc.T)().vec3f(fc.O.POSITION).vec3f(fc.O.NORMAL).vec2f(fc.O.UV0).vec4u8(fc.O.COLOR).vec2f(fc.O.SIZE).vec4f(fc.O.AUXPOS1).vec4f(fc.O.AUXPOS2),qw=jw.clone().vec4u8(fc.O.OBJECTANDLAYERIDCOLOR),Ww=function(){function e(t){(0,Au.Z)(this,e),this._material=t,this.vertexBufferLayout=(0,Nu.h)("enable-feature:objectAndLayerId-rendering")?qw:jw}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return 6*e.indices.get(fc.O.POSITION).length}},{key:"write",value:function(e,t,r,n,i){(0,dc.ai)(r.indices.get(fc.O.POSITION),r.vertexAttributes.get(fc.O.POSITION).data,e,n.position,i,6),(0,dc.aj)(r.indices.get(fc.O.NORMAL),r.vertexAttributes.get(fc.O.NORMAL).data,t,n.normal,i,6);var a,o,s,l,u=r.vertexAttributes.get(fc.O.UV0).data;if(null==u||u.length<4){var c=this._material.parameters;a=0,o=0,s=c.texCoordScale[0],l=c.texCoordScale[1]}else a=u[0],o=u[1],s=u[2],l=u[3];s=Math.min(1.99999,s+1),l=Math.min(1.99999,l+1);for(var h=r.indices.get(fc.O.POSITION).length,d=n.uv0,f=i,p=0;p<h;++p)d.set(f,0,a),d.set(f,1,o),f+=1,d.set(f,0,s),d.set(f,1,o),f+=1,d.set(f,0,s),d.set(f,1,l),f+=1,d.set(f,0,s),d.set(f,1,l),f+=1,d.set(f,0,a),d.set(f,1,l),f+=1,d.set(f,0,a),d.set(f,1,o),f+=1;(0,dc.ak)(r.indices.get(fc.O.COLOR),r.vertexAttributes.get(fc.O.COLOR).data,4,n.color,i,6);for(var v=r.indices.get(fc.O.SIZE),m=r.vertexAttributes.get(fc.O.SIZE).data,y=v.length,g=n.size,_=i,b=0;b<y;++b)for(var x=m[2*v[b]],w=m[2*v[b]+1],T=0;T<6;++T)g.set(_,0,x),g.set(_,1,w),_+=1;if(r.indices.get(fc.O.AUXPOS1)&&r.vertexAttributes.get(fc.O.AUXPOS1)&&(0,dc.al)(r.indices.get(fc.O.AUXPOS1),r.vertexAttributes.get(fc.O.AUXPOS1).data,n.auxpos1,i,6),r.indices.get(fc.O.AUXPOS2)&&r.vertexAttributes.get(fc.O.AUXPOS2)&&(0,dc.al)(r.indices.get(fc.O.AUXPOS2),r.vertexAttributes.get(fc.O.AUXPOS2).data,n.auxpos2,i,6),(0,Nu.r)(r.objectAndLayerIdColor)&&4===r.objectAndLayerIdColor.length&&r.indices.get(fc.O.POSITION)){var C=r.indices.get(fc.O.POSITION).length,S=n.getField(fc.O.OBJECTANDLAYERIDCOLOR,Zc.x);(0,dc.am)(r.objectAndLayerIdColor,S,C,i,6)}}}]),e}(),Xw=(0,Vu.n)(),Yw=(0,lc.n)(),Qw=(0,lc.n)(),Kw=(0,Vu.n)(),Jw=(0,hc.e)(),$w=(0,Qu.R)(),eT=(0,Qu.d)(),tT=(0,Vu.n)(),rT=(0,ju.u)(),nT=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.aabr=(0,ju.u)(),this.distance=0,this.culled=!1,this.visible=!1})),iT=(0,ku.Z)((function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,Au.Z)(this,e),this.graphics3DGraphic=t,this.slicePlaneEnabled=r,this.info=n})),aT=function(){function e(){(0,Au.Z)(this,e),this.active=new Map,this.visible=new Map}return(0,ku.Z)(e,[{key:"clear",value:function(){this.active.clear(),this.visible.clear()}}]),e}(),oT=(0,ku.Z)((function e(){(0,Au.Z)(this,e)})),sT=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.sortArray=new Eu.a6({allocator:function(e){return e||new oT}})}));!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(Ow||(Ow={}));var lT=function(){function e(){(0,Au.Z)(this,e),this.camera=new Jy,this.slicePlane=(0,qu.G)(),this.slicePlaneEnabled=!1}return(0,ku.Z)(e,[{key:"copyFrom",value:function(e){this.camera.copyFrom(e.camera),(0,qu.X)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}]),e}(),uT=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._dirty=!1,n._runningViewState=new lT,n._state=Ow.Idle,n._graphics=new aT,n._iterators=new sT,n._accBinsNumX=15,n._accBinsNumY=20,n._accBinsSizeX=0,n._accBinsSizeY=0,n._accBins=null,n.accNumTests=0,n}return(0,ku.Z)(r,[{key:"dirty",get:function(){return this._dirty}},{key:"state",get:function(){return this._state}},{key:"destroy",value:function(){this._graphics.clear(),this._iterators=null}},{key:"setDirty",value:function(){!this._dirty&&this._graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){return this._state!==Ow.Idle||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;var e=this._state/Ow.NumStates;return this._dirty?.5*e:e}},{key:"running",get:function(){return this.view.ready&&null!=this.view.state&&this.updating}},{key:"runTask",value:function(e){switch(this._state){case Ow.Idle:this._startUpdate(),e.madeProgress();case Ow.Process:if(this._state=Ow.Process,!this._processActiveGraphics(e))return;case Ow.Sort:if(this._state=Ow.Sort,!this._sortVisibleGraphics(e))return;case Ow.Deconflict:if(this._state=Ow.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if(zx&&Dx){Hx();for(var r=Dx,n=0,i=0;i<e.accBinsNumX;i++)for(var a=0;a<e.accBinsNumY;a++){var o=e.accBins[i][e.accBinsNumY-1-a];n+=o.length;var s=i*e.accBinsSizeX,l=(i+1)*e.accBinsSizeX,u=a*e.accBinsSizeY,c=(a+1)*e.accBinsSizeY;r.fillText(o.length.toFixed(),s+5,u+15),jx(s,l,u,c,"blue")}r.fillText("total totalShownLabels: "+n,70,40),r.fillText("total visible labels: "+t.size,70,50),r.fillText("total numTests: "+e.accNumTests,70,30)}})(this,this._graphics.visible),this._state=Ow.Idle,this.notifyChange("updating")}}},{key:"modifyGraphics",value:function(e,t){var r=this;t?e.forEach((function(e){return r.addToActiveGraphics(e)})):e.forEach((function(e){return r.removeFromActiveGraphics(e)})),this.setDirty()}},{key:"layerSupportsDeconfliction",value:function(e){if((0,Nu.t)(e)||"object3d"!==e.type)return!1;var t=e.stageObject;return 1===(t?t.geometryRecords.length:0)&&t.geometryRecords[0].material instanceof ww}},{key:"_startUpdate",value:function(){Gx(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);var e=this._runningViewState.camera,t=e.fullWidth,r=e.fullHeight;this._initBins(t,r),this._resetIterators()}},{key:"addToActiveGraphics",value:function(e){e.info[this.visibilityGroup]=new nT,this._graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}},{key:"removeFromActiveGraphics",value:function(e){this._removeFromVisibleGraphics(e),function(e,t){var r=e.graphics3DGraphic;r.destroyed||r.clearVisibilityFlag(Ix.DECONFLICTION,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}},{key:"_addToVisibleGraphics",value:function(e){this._graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}},{key:"_removeFromVisibleGraphics",value:function(e){this._graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}},{key:"_processActiveGraphics",value:function(e){var t=this._ensureActiveGraphicsIterator(),r=(0,Wu.h)(Jw,this._runningViewState.camera.projectionMatrix),n="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?$w:null,i=0;for((0,Nu.r)(n)&&((0,Vu.O)(n,Vu.a7,this._runningViewState.camera.viewMatrix),n[3]=(0,Xu.u)(this.view.spatialReference).radius,i=(0,Qu.F)(n,Vu.a7));!e.done;){e.madeProgress();var a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;var o=a.value,s=o&&o.info[this.visibilityGroup];s&&(this._collectGraphics3DGraphics(o,r,n,i),s.culled?this._removeFromVisibleGraphics(o):this._addToVisibleGraphics(o))}return!1}},{key:"_sortVisibleGraphics",value:function(e){for(var t=this._ensureSortGraphicsIterator();!e.done;){var r=t.next();if(e.madeProgress(),!0===r.done)return this._resetSortGraphicsIterator(),!0}return!1}},{key:"_deconflictVisibleGraphics",value:function(e){for(var t=this._ensureVisibleGraphicsIterator(),r=this.visibilityGroup===Mx.LABEL;!e.done;){e.madeProgress();var n=t.next();if(!0===n.done)return this._resetVisibleGraphicsIterator(),!0;var i=n.value,a=i.info[this.visibilityGroup];if(a&&!a.culled){var o=i.graphics3DGraphic,s=(!r||o.isVisible())&&!this._isConflicted(i);s&&this._addToBins(i),a.visible=s,this._setGraphicVisibility(i,s),qx(a,s)}}return!1}},{key:"_resetIterators",value:function(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}},{key:"_ensureActiveGraphicsIterator",value:function(){return this._iterators.active||(this._iterators.active=cT(this._graphics.active)),this._iterators.active}},{key:"_resetActiveGraphicsIterator",value:function(){this._iterators.active=null}},{key:"_ensureVisibleGraphicsIterator",value:function(){return this._iterators.visible||(this._iterators.visible=cT(this._graphics.visible)),this._iterators.visible}},{key:"_resetVisibleGraphicsIterator",value:function(){this._iterators.visible=null}},{key:"_ensureSortGraphicsIterator",value:function(){return this._iterators.sort||(this._iterators.sort=hT(this._graphics.visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}},{key:"_resetSortGraphicsIterator",value:function(){this._iterators.sort=null}},{key:"_collectGraphics3DGraphics",value:function(e,t,r,n){var i=e.graphics3DGraphic;if(!i.destroyed){var a=e.info[this.visibilityGroup];if(i.isVisible(Mx.GRAPHIC,Ix.DECONFLICTION)){var o=this.getGraphicsLayers(i);(0,ju.D)(a.aabr);var s,l=null,u=(0,Cu.Z)(o);try{for(u.s();!(s=u.n()).done;){var c=s.value;if(this.layerSupportsDeconfliction(c)){var h=c.stageObject.geometryRecords[0].material;if((0,Nu.t)(l)){if((l=this._getProjectionInfo(c,t,pT)).isOutsideScreen||this._isCulledBySlice(e,Xw)||(0,Nu.r)(r)&&this._isCulledByHorizon(l,r,n))return void(a.culled=!0);!Ac.t.TESTS_DISABLE_OPTIMIZATIONS&&a.visible&&(l.distance*=.7)}this._expandBoundingRect(a,c,h,l)}}}catch(d){u.e(d)}finally{u.f()}(0,Nu.t)(l)?a.culled=!0:(a.distance=l.distance,a.culled=!1)}else a.culled=!0}}},{key:"_getProjectionInfo",value:function(e,t,r){var n=this._runningViewState.camera,i=e.stageObject,a=i.geometryRecords[0],o=a.material,s=(0,Qu.g)(i.boundingVolumeWorldSpace.bounds);(0,Vu.O)(Xw,s,n.viewMatrix);var l=a.geometry.vertexAttributes,u=l.get(fc.O.NORMAL).data,c=l.get(fc.O.AUXPOS1).data;return o.applyShaderOffsetsView(Xw,u,i.transformation,c,n,r.scaleInfo,Xw),(0,Vu.C)(Yw,Xw[0],Xw[1],Xw[2],1),(0,Vu.w)(Qw,Yw,n.projectionMatrix),(0,Vu.g)(r.positionNDC,Qw,1/Qw[3]),o.applyShaderOffsetsNDC(r.positionNDC,c,n,r.positionNDC,Kw),r.distanceWithoutPolygonOffset=n.depthNDCToWorld(Kw[2]),r.distance=Kw[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:n.depthNDCToWorld(r.positionNDC[2]),(0,Vu.C)(Qw,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),(0,Vu.w)(Yw,Qw,t),(0,Vu.G)(Yw,Yw,1/Yw[3]),(0,Vu.o)(r.positionView,Xw[0],Xw[1],Xw[2]),r}},{key:"_isCulledByHorizon",value:function(e,t,r){return(0,Vu.r)(eT.direction,e.positionView),(0,Vu.o)(eT.origin,0,0,0),!!(0,Qu.z)(t,eT,tT)&&e.distanceWithoutPolygonOffset>r}},{key:"_isCulledBySlice",value:function(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&(0,qu.A)(this._runningViewState.slicePlane,t)}},{key:"_expandBoundingRect",value:function(e,t,r,n){var i=n.positionNDC,a=n.scaleInfo,o=this._runningViewState.camera,s=t.getScreenSize(dT);(0,dc.ac)(s,a.factor,s),s[0]*=o.pixelRatio,s[1]*=o.pixelRatio;var l=(0,ju.z)(r.calculateRelativeScreenBounds(s,a.factorAlignment.scale,rT),(0,Vu.Z)(0,o.fullWidth,.5+.5*i[0]),(0,Vu.Z)(0,o.fullHeight,.5+.5*i[1])),u=this.iconMarginFactor;if(0!==u){var c=u*Math.min((0,ju.s)(l),(0,ju.l)(l));l[0]-=c,l[1]-=c,l[2]+=c,l[3]+=c}(0,ju.h)(e.aabr,l,e.aabr)}},{key:"_isConflicted",value:function(e){for(var t=e.graphics3DGraphic.graphic.uid,r=e.info[this.visibilityGroup],n=Math.floor(r.aabr[0]/this._accBinsSizeX);n<=Math.floor(r.aabr[2]/this._accBinsSizeX);n++)if(!(n<0||n>=this._accBinsNumX))for(var i=Math.floor(r.aabr[1]/this._accBinsSizeY);i<=Math.floor(r.aabr[3]/this._accBinsSizeY);i++)if(!(i<0||i>=this._accBinsNumY))for(var a=this._accBins[n][i],o=0;o<a.length;o++){var s=a.data[o],l=s.info[this.visibilityGroup];if(l&&l.visible&&s.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,ju.E)(l.aabr,r.aabr)))return!0}return!1}},{key:"_initBins",value:function(e,t){if(null==this._accBins){this._accBins=[];for(var r=0;r<this._accBinsNumX;r++){this._accBins.push([]);for(var n=this._accBins[this._accBins.length-1],i=0;i<this._accBinsNumY;i++)n.push(new Eu.a6)}}else for(var a=0;a<this._accBinsNumX;a++)for(var o=0;o<this._accBinsNumY;o++)this._accBins[a][o].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}},{key:"_addToBins",value:function(e){for(var t=e.info[this.visibilityGroup],r=Math.floor(t.aabr[0]/this._accBinsSizeX),n=Math.floor(t.aabr[2]/this._accBinsSizeX),i=Math.floor(t.aabr[1]/this._accBinsSizeY),a=Math.floor(t.aabr[3]/this._accBinsSizeY),o=r;o<=n;o++)if(!(o<0||o>=this._accBinsNumX))for(var s=i;s<=a;s++)s<0||s>=this._accBinsNumY||this._accBins[o][s].push(e)}},{key:"_setGraphicVisibility",value:function(e,t){var r=e.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(Ix.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===Mx.LABEL&&this.view.labeler.setLabelGraphicVisibility(r,t))}}]),r}(Eu.m);function cT(e){var t,r;return(0,Su.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!Map.prototype.entries){n.next=11;break}t=e.entries(),r=t.next();case 3:if(r.done){n.next=9;break}return n.next=6,r.value[1];case 6:r=t.next(),n.next=3;break;case 9:n.next=12;break;case 11:return n.delegateYield(e.values(),"t0",12);case 12:case"end":return n.stop()}}),wh)}function hT(e,t,r){var n,i;return(0,Su.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return t.clear(),e.forEach((function(e,n){var i=t.pushNew();i.id=n,i.prio=e.info?-e.info[r].distance:Number.MAX_VALUE})),void(a.next=4);case 4:n=t.iterableSort((function(e,t){return t.prio-e.prio})),i=n.next();case 6:if(i.done){a.next=12;break}return void(a.next=9);case 9:i=n.next(),a.next=6;break;case 12:t.forAll((function(t){var r=e.get(t.id);r&&(e.delete(t.id),e.set(t.id,r))})),t.clear();case 13:case"end":return a.stop()}}),Th)}(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],uT.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],uT.prototype,"updating",null),uT=(0,Eu.e)([(0,Eu.n)("esri.views.3d.layers.graphics.Deconflictor")],uT);var dT=(0,cc.n)(),fT=function(){function e(){(0,Au.Z)(this,e),this.positionView=(0,Vu.n)(),this.positionNDC=(0,Vu.n)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}return(0,ku.Z)(e,[{key:"isOutsideScreen",get:function(){var e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}]),e}(),pT=new fT,vT=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).visibilityGroup=Mx.LABEL,n.iconMarginFactor=0,n._lastDeconfliction=0,n}return(0,ku.Z)(r,[{key:"viewState",get:function(){return this.parent.viewState}},{key:"runTask",value:function(e){if(!this.parent.running){var t=performance.now();(e.state===bc.a.IDLE||t-this._lastDeconfliction>2e3)&&((0,_u.Z)((0,bu.Z)(r.prototype),"runTask",this).call(this,e),this.state===Ow.Idle&&(this._lastDeconfliction=t))}}},{key:"enabledChanged",value:function(e,t){this.modifyGraphics(t,e.labelsEnabled)}},{key:"getGraphicsLayers",value:function(e){return e.labelGraphics}}]),r}(uT);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],vT.prototype,"parent",void 0),vT=(0,Eu.e)([(0,Eu.n)("esri.views.3d.layers.graphics.LabelDeconflictor")],vT);var mT=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._handles=new Eu.X,e._contexts=new Map,e._viewState=new lT,e.visibilityGroup=Mx.GRAPHIC,e._iconMarginFactor=-.1,e}return(0,ku.Z)(r,[{key:"labels",get:function(){return this._labels}},{key:"viewState",get:function(){return this._viewState}},{key:"initialize",value:function(){var e=this;this._handles.add([(0,Fu.l)((function(){var t,r;return null===(t=e.view)||void 0===t||null===(r=t.state)||void 0===r?void 0:r.camera}),(function(){e._updateViewState(),e.setDirty()})),(0,Fu.l)((function(){var t,r,n;return null===(t=e.view)||void 0===t||null===(r=t.map)||void 0===r||null===(n=r.ground)||void 0===n?void 0:n.opacity}),(function(t,r){1!==t&&1!==r||e.setDirty()})),(0,Fu.l)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.slicePlane}),(function(){e._updateSlicePlane(),e._slicePlaneChanged()}),Fu.h)]),this._frameTask=this.view.resourceController.scheduler.registerTask(bc.I.GRAPHICS_DECONFLICTOR,this),this._labels=new vT({view:this.view,parent:this})}},{key:"destroy",value:function(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}},{key:"iconMarginFactor",get:function(){return this._iconMarginFactor},set:function(e){this._iconMarginFactor=e,this.setDirty()}},{key:"setDirty",value:function(){this._contexts.size>0&&((0,_u.Z)((0,bu.Z)(r.prototype),"setDirty",this).call(this),this._labels.setDirty())}},{key:"runTask",value:function(e){(0,_u.Z)((0,bu.Z)(r.prototype),"runTask",this).call(this,e),this.running||this._labels.setDirty()}},{key:"setInitialIconVisibilityFlag",value:function(e,t){var r=!(this._graphicSupportsDeconfliction(t)&&yT(e));t.setVisibilityFlag(Ix.DECONFLICTION,r,Mx.GRAPHIC)}},{key:"_updateViewState",value:function(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}},{key:"_updateSlicePlane",value:function(){var e=this.view?this.view.slicePlane:null;(0,Nu.r)(e)&&(0,qu.B)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=(0,Nu.r)(e)}},{key:"_slicePlaneChanged",value:function(){(0,Eu.a9)(this._contexts,(function(e,t){return t.symbolCreationContext.slicePlaneEnabled}))&&this.setDirty()}},{key:"addGraphicsOwner",value:function(e){var t=this,r=this._contexts.get(e);return null==r&&(r=new Map,this._contexts.set(e,r),this.setDirty()),{addGraphic:function(n){return t._addGraphic(e,r,n)},removeGraphic:function(e){return t._removeGraphic(r,e)},labelingInfoChange:function(){return t._labels.enabledChanged(e,r)},featureReductionChange:function(){return t.enabledChanged(e,r)},slicePlaneEnabledChange:function(){return t._slicePlaneEnabledChanged(e,r)},clear:function(){return r.forEach((function(e){return t._removeGraphic(r,e.graphics3DGraphic)}))}}}},{key:"removeGraphicsOwner",value:function(e){var t=this,r=this._contexts.get(e);r&&(r.forEach((function(e){return t._removeGraphic(r,e.graphics3DGraphic)})),this._contexts.delete(e),this.setDirty())}},{key:"_addGraphic",value:function(e,t,r){var n=r.graphic.uid,i=new iT(r,e.symbolCreationContext.slicePlaneEnabled);t.set(n,i),yT(e)&&this.addToActiveGraphics(i),e.labelsEnabled&&this._labels.addToActiveGraphics(i)}},{key:"_removeGraphic",value:function(e,t){var r=t.graphic.uid,n=e.get(r);n&&(this.removeFromActiveGraphics(n),this._labels.removeFromActiveGraphics(n),e.delete(r),this.setDirty())}},{key:"enabledChanged",value:function(e,t){var r=yT(e);r||function(e){var t=e.graphics3DGraphics;t&&t.forEach((function(e){return e.clearVisibilityFlag(Ix.DECONFLICTION)}))}(e),this.modifyGraphics(t,r)}},{key:"_slicePlaneEnabledChanged",value:function(e,t){var r=e.symbolCreationContext.slicePlaneEnabled;t.forEach((function(e){return e.slicePlaneEnabled=r})),this.setDirty()}},{key:"getGraphicsLayers",value:function(e){return e.graphics}},{key:"_graphicSupportsDeconfliction",value:function(e){if(e.isDraped)return!1;var t=e.graphics;if(!t||!t.length)return!1;var r,n=(0,Cu.Z)(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(this.layerSupportsDeconfliction(i))return!0}}catch(a){n.e(a)}finally{n.f()}return!1}}]),r}(uT);function yT(e){var t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function gT(e){return"declaredClass"in e}function _T(e){return"declaredClass"in e}function bT(e,t){if(!e)return null;if(function(e){return"declaredClass"in e}(e))return e;var r=new Iu.g({layer:t,sourceLayer:t});return r.visible=e.visible,r.symbol=(0,Nu.y)(e.symbol),r.attributes=(0,Nu.y)(e.attributes),r.geometry=xT(e.geometry),r}function xT(e){return(0,Nu.t)(e)?null:gT(e)?e:(0,zc.v)(function(e){var t=e.spatialReference,r=t.wkid,n=t.wkt,i=t.latestWkid,a={wkid:r,wkt:n,latestWkid:i};switch(e.type){case"point":return{x:e.x,y:e.y,z:e.z,m:e.m,spatialReference:a};case"polygon":var o=e.rings,s=e.hasZ,l=e.hasM;return{rings:wT(o),hasZ:s,hasM:l,spatialReference:a};case"polyline":var u=e.paths,c=e.hasZ,h=e.hasM;return{paths:wT(u),hasZ:c,hasM:h,spatialReference:a};case"extent":return{xmin:e.xmin,xmax:e.xmax,ymin:e.ymin,ymax:e.ymax,zmin:e.zmin,zmax:e.zmax,mmin:e.mmin,mmax:e.mmax,hasZ:e.hasZ,hasM:e.hasM,spatialReference:a};case"multipoint":var d=e.points,f=e.hasZ,p=e.hasM;return{points:CT(d)?TT(d):d,hasZ:f,hasM:p,spatialReference:a};default:return}}(e))}function wT(e){return function(e){var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(0!==n.length)return CT(n)}}catch(i){r.e(i)}finally{r.f()}return!1}(e)?e.map((function(e){return TT(e)})):e}function TT(e){return e.map((function(e){return(0,Nu.J)(e)}))}function CT(e){return e.length&&((0,Nu.H)(e[0])||(0,Nu.I)(e[0]))}function ST(e,t){if(!e)return null;var r;if(_T(e)){if(null==t)return e.clone();if(_T(t))return t.copy(e)}return null!=t?((r=t).x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=null,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=null,r.hasM=!1)):(r=(0,Uc.v)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r}function OT(e){var t={wkid:e.wkid,wkt:e.wkt,latestWkid:e.latestWkid};return Yu.k.fromJSON(t)}function PT(e,t){if("point"===e.type)return AT(e,t,!1);if(gT(e))switch(e.type){case"extent":return AT(e.center,t,!1);case"polygon":return AT(e.centroid,t,!1);case"polyline":return AT(RT(e),t,!0);case"mesh":return AT(e.origin,t,!1)}else switch(e.type){case"extent":return AT(function(e){var t=isFinite(e.zmin);return(0,Uc.v)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return AT(function(e){var t=e.rings[0];if(!t||0===t.length)return null;var r=(0,Mu.o)(e.rings,e.hasZ);return(0,Uc.v)(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return AT(RT(e),t,!0)}}function RT(e){var t=e.paths[0];if(!t||0===t.length)return null;var r=(0,Mu.c)(t,(0,Mu.d)(t)/2);return(0,Uc.v)(r[0],r[1],r[2],e.spatialReference)}function AT(e,t,r){var n=r?e:ST(e);return t&&e?(0,Hu.p)(e,n,t)?n:null:n}function kT(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e){t||(t=(0,ju.u)());var i=e,a=.5*i.width*(r-1),o=.5*i.height*(r-1);return i.width<1e-7*i.height?a+=o/20:i.height<1e-7*i.width&&(o+=a/20),(0,Vu.C)(t,i.xmin-a-n,i.ymin-o-n,i.xmax+a+n,i.ymax+o+n),t}return null}function ET(e,t){for(var r=0;r<e.geometries.length;++r){var n=e.geometries[r].getMutableAttribute(fc.O.AUXPOS1);n&&n.data[3]!==t&&(n.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[r]))}}function DT(e,t){var r=(0,lc.t)(lc._);return(0,Nu.r)(e)&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),(0,Nu.r)(t)?r[3]=t:(0,Nu.r)(e)&&e.length>3&&(r[3]=e[3]),r}function MT(e,t,r,n,i){for(var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[0,0,0,0],o=0;o<3;++o)(0,Nu.r)(e)&&null!=e[o]?a[o]=e[o]:(0,Nu.r)(r)&&null!=r[o]?a[o]=r[o]:a[o]=i[o];return(0,Nu.r)(t)?a[3]=t:(0,Nu.r)(n)?a[3]=n:a[3]=i[3],a}function IT(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Vu.l,t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=new Array(3);if((0,Nu.t)(t)||(0,Nu.t)(r))i[0]=1,i[1]=1,i[2]=1;else{for(var a,o=0,s=2;s>=0;s--){var l=e[s],u=void 0,c=null!=l,h=0===s&&!a&&!c,d=r[s];"symbol-value"===l||h?u=0!==d?t[s]/d:1:c&&"proportional"!==l&&isFinite(l)&&(u=0!==d?l/d:1),null!=u&&(i[s]=u,a=u,o=Math.max(o,Math.abs(u)))}for(var f=2;f>=0;f--)null==i[f]?i[f]=a:0===i[f]&&(i[f]=.001*o)}for(var p=2;p>=0;p--)i[p]/=n;return(0,Vu.a6)(i)}function LT(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),ZT(e)?null:"Symbol sizes may not be negative values"}function ZT(e){if(Array.isArray(e)){var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){if(!ZT(t.value))return!1}}catch(n){r.e(n)}finally{r.f()}return!0}return null==e||e>=0}function NT(e,t,r){if(null!=r.minDemResolution)return r.minDemResolution;var n=(0,Xu.$)(t),i=(0,Gc.I)(e)*n,a=(0,Gc.y)(e)*n,o=(0,Gc.N)(e)*(t.isGeographic?1:n);return 0===i&&0===a&&0===o?r.minDemResolutionForPoints:.01*Math.max(i,a,o)}function FT(e,t,r,n,i,a,o,s,l,u,c){var h,d,f=WT[c.mode],p=0;if((0,Hu.x)(e,t,r,n,l.spatialReference,i,s))return f.requiresAlignment(c)?(p=f.applyElevationAlignmentBuffer(n,i,a,o,s,l,u,c),h=a,d=o):(h=n,d=i),(0,Hu.x)(h,l.spatialReference,d,a,u.spatialReference,o,s)?p:void 0}function zT(e,t,r,n,i){var a=((0,qu.E)(e)?e.z:(0,qu.F)(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":var o=(0,Nu.v)((0,qu.C)(t,e,"ground"),0);return i.verticalDistanceToGround=0,i.sampledElevation=o,void(i.z=o);case"relative-to-ground":var s=(0,Nu.v)((0,qu.C)(t,e,"ground"),0),l=r.geometryZWithOffset(a,n);return i.verticalDistanceToGround=l,i.sampledElevation=s,void(i.z=l+s);case"relative-to-scene":var u=(0,Nu.v)((0,qu.C)(t,e,"scene"),0),c=r.geometryZWithOffset(a,n);return i.verticalDistanceToGround=c,i.sampledElevation=u,void(i.z=c+u);case"absolute-height":var h=r.geometryZWithOffset(a,n),d=(0,Nu.v)((0,qu.C)(t,e,"ground"),0);return i.verticalDistanceToGround=h-d,i.sampledElevation=d,void(i.z=h);default:return void(i.z=0)}}function UT(e,t,r,n){return zT(e,t,r,n,YT),YT.z}function VT(e,t,r){return null==t||null==r?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?jT.UPDATE:e.onTheGroundChanged}function BT(e){return"relative-to-ground"===e||"relative-to-scene"===e}function GT(e){return"absolute-height"!==e}function HT(e,t,r,n,i){zT(t,r,i,n,YT),ET(e,YT.verticalDistanceToGround);var a=YT.sampledElevation,o=(0,Wu.n)(XT,e.transformation);return QT[0]=t.x,QT[1]=t.y,QT[2]=YT.z,(0,Hu.Z)(t.spatialReference,QT,o,n.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}mT=(0,Eu.e)([(0,Eu.n)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],mT);var jT,qT=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}));!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(jT||(jT={}));var WT={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,n,i,a,o,s){var l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext;t*=3,n*=3;for(var c=0;c<i;++c){var h=e[t+0],d=e[t+1],f=e[t+2];r[n+0]=h,r[n+1]=d,r[n+2]=null==u?f+l:l,t+=3,n+=3}return 0},requiresAlignment:function(e){var t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,n,i,a){var o=0,s=a.spatialReference;t*=3,n*=3;for(var l=0;l<i;++l){var u=e[t+0],c=e[t+1],h=e[t+2],d=(0,Nu.v)(a.getElevation(u,c,h,s,"ground"),0);o+=d,r[n+0]=u,r[n+1]=c,r[n+2]=d,t+=3,n+=3}return o/i},requiresAlignment:function(){return!0}},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,n,i,a,o,s){var l=0,u=s.calculateOffsetRenderUnits(o),c=s.featureExpressionInfoContext,h=a.spatialReference;t*=3,n*=3;for(var d=0;d<i;++d){var f=e[t+0],p=e[t+1],v=e[t+2],m=(0,Nu.v)(a.getElevation(f,p,v,h,"ground"),0);l+=m,r[n+0]=f,r[n+1]=p,r[n+2]=null==c?v+m+u:m+u,t+=3,n+=3}return l/i},requiresAlignment:function(){return!0}},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,n,i,a,o,s){var l=0,u=s.calculateOffsetRenderUnits(o),c=s.featureExpressionInfoContext,h=a.spatialReference;t*=3,n*=3;for(var d=0;d<i;++d){var f=e[t+0],p=e[t+1],v=e[t+2],m=(0,Nu.v)(a.getElevation(f,p,v,h,"scene"),0);l+=m,r[n+0]=f,r[n+1]=p,r[n+2]=null==c?v+m+u:m+u,t+=3,n+=3}return l/i},requiresAlignment:function(){return!0}}},XT=(0,hc.e)(),YT=new qT,QT=(0,Vu.n)();function KT(e,t,r,n){var i,a=e.stageObject,o=a.geometryRecords,s=0,l=(0,Cu.Z)(o);try{for(l.s();!(i=l.n()).done;){var u=i.value,c=uC(u,t,r,n),h=c.update;s+=c.averageGeometrySampledElevation,h&&a.geometryVertexAttrsUpdated(u)}}catch(d){l.e(d)}finally{l.f()}return s/o.length}function JT(e,t,r,n){var i=e.stageObject,a=t.centerPointInElevationSR,o=0;i.metadata.usesVerticalDistanceToGround?(zT(a,r,t,n,lC),ET(i,lC.verticalDistanceToGround),o=lC.sampledElevation):(zT(a,r,t,n,lC),"absolute-height"!==t.mode&&(o=lC.sampledElevation));var s=(0,Wu.n)($T,i.transformation),l=(0,Vu.o)(sC,s[12],s[13],s[14]);Ac.t.TESTS_DISABLE_OPTIMIZATIONS?(nC[0]=a.x,nC[1]=a.y,nC[2]=lC.z,(0,Hu.Z)(a.spatialReference,nC,s,n.spatialReference)&&(i.transformation=s)):n.setAltitudeOfTransformation(lC.z,s);var u=rC/n.unitInMeters;return(Math.abs(s[12]-l[0])>=u||Math.abs(s[13]-l[1])>=u||Math.abs(s[14]-l[2])>=u)&&(i.transformation=s),o}var $T=(0,hc.e)();function eC(e,t,r,n){var i=e.graphics3DSymbolLayer.lodRenderer;if((0,Nu.t)(i))return 0;var a=t.centerPointInElevationSR;zT(a,r,t,n,lC);var o="absolute-height"!==t.mode?lC.sampledElevation:0,s=i.instanceData,l=e.instanceIndex,u=oC;s.getGlobalTransform(l,u);var c=(0,Vu.o)(sC,u[12],u[13],u[14]);Ac.t.TESTS_DISABLE_OPTIMIZATIONS?(nC[0]=a.x,nC[1]=a.y,nC[2]=lC.z,(0,Hu.Z)(a.spatialReference,nC,u,n.spatialReference)&&s.setGlobalTransform(l,u)):n.setAltitudeOfTransformation(lC.z,u);var h=rC/n.unitInMeters;return(Ac.t.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(u[12]-c[0])>=h||Math.abs(u[13]-c[1])>=h||Math.abs(u[14]-c[2])>=h)&&s.setGlobalTransform(l,u),o}function tC(e,t,r,n){var i=e.stageObject,a=i.geometryRecords;if(0===a.length)return 0;var o,s=0,l=null,u=0,c=!1,h=(0,Cu.Z)(a);try{for(h.s();!(o=h.n()).done;){var d=o.value,f=d.geometry.vertexAttributes.get(fc.O.POSITION);if(f!==l){var p=uC(d,t,r,n),v=p.update;u=p.averageGeometrySampledElevation,l=f,c=v}c&&i.geometryVertexAttrsUpdated(d),s+=u}}catch(m){h.e(m)}finally{h.f()}return s/a.length}var rC=.01,nC=(0,Vu.n)(),iC=(0,Vu.n)(),aC=(0,Vu.n)(),oC=(0,hc.e)(),sC=(0,Vu.n)(),lC=new qT;function uC(e,t,r,n){var i=!1,a=r.spatialReference,o=e.geometry,s=e.getShaderTransformation(),l=t.requiresSampledElevationInfo;iC[0]=s[12],iC[1]=s[13],iC[2]=s[14],o.invalidateBoundingInfo();for(var u=o.getMutableAttribute(fc.O.POSITION),c=u.data,h=o.vertexAttributes.get(fc.O.MAPPOS).data,d=u.size,f=c.length/d,p=new qu.H(h,a),v=0,m=0,y=0;y<f;y++){if(aC[0]=c[v],aC[1]=c[v+1],aC[2]=c[v+2],zT(p,r,t,n,lC),l&&(m+=lC.sampledElevation),Ac.t.TESTS_DISABLE_OPTIMIZATIONS)c[v]=p.array[p.offset],c[v+1]=p.array[p.offset+1],c[v+2]=lC.z,(0,Hu.x)(c,a,v,c,n.spatialReference,v,1),c[v]-=iC[0],c[v+1]-=iC[1],c[v+2]-=iC[2],i=!0;else{nC[0]=c[v]+iC[0],nC[1]=c[v+1]+iC[1],nC[2]=c[v+2]+iC[2],n.setAltitude(nC,lC.z),c[v]=nC[0]-iC[0],c[v+1]=nC[1]-iC[1],c[v+2]=nC[2]-iC[2];var g=rC/n.unitInMeters;(Math.abs(aC[0]-c[v])>=g||Math.abs(aC[1]-c[v+1])>=g||Math.abs(aC[2]-c[v+2])>=g)&&(i=!0)}v+=d,p.offset+=3}return{update:i,averageGeometrySampledElevation:m/=f}}var cC=Eu.a.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function hC(e){var t=e&&e.expression;if("string"==typeof t){var r=_C(t);if(null!=r)return{cachedResult:r}}return null}function dC(e,t,r,n){return fC.apply(this,arguments)}function fC(){return fC=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i){var a,o,s,l,u;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof(a=t&&t.expression)){e.next=3;break}return e.abrupt("return",null);case 3:if(null==(o=_C(a))){e.next=6;break}return e.abrupt("return",{cachedResult:o});case 6:return e.next=8,(0,jc.i)();case 8:return s=e.sent,(0,Eu.f)(n),l=s.arcadeUtils,u=l.createSyntaxTree(a),e.abrupt("return",l.dependsOnView(u)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:l.createFunction(u),context:l.createExecContext(null,{sr:r}),modules:s}});case 12:case"end":return e.stop()}}),e)}))),fC.apply(this,arguments)}function pC(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function vC(e,t){if(null!=e&&!gC(e)){if(!t||!e.arcade)return void cC.errorOncePerTick("Arcade support required but not provided");var r=t;r._geometry&&(r._geometry=xT(r._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function mC(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e&&e.featureExpressionInfo,n=r&&r.expression;return t||"0"===n||(r=null),r}var yC={cachedResult:0};function gC(e){return null!=e.cachedResult}function _C(e){return"0"===e?0:null}var bC=function(){function e(){(0,Au.Z)(this,e),this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}return(0,ku.Z)(e,[{key:"featureExpressionInfoContext",get:function(){return this._featureExpressionInfoContext}},{key:"meterUnitOffset",get:function(){return this._meterUnitOffset}},{key:"unit",get:function(){return this._unit},set:function(e){this._unit=e,this._metersPerElevationInfoUnit=(0,Hc.r)(e)}},{key:"requiresSampledElevationInfo",get:function(){return"absolute-height"!==this.mode}},{key:"reset",value:function(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}},{key:"offsetMeters",set:function(e){this._meterUnitOffset=e,this._renderUnitOffset=0}},{key:"offsetElevationInfoUnits",set:function(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}},{key:"addOffsetRenderUnits",value:function(e){this._renderUnitOffset+=e}},{key:"geometryZWithOffset",value:function(e,t){var r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}},{key:"calculateOffsetRenderUnits",value:function(e){var t=this._meterUnitOffset,r=this.featureExpressionInfoContext;return null!=r&&(t+=function(e){if(null!=e){if(gC(e))return e.cachedResult;var t=e.arcade,r=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0}(r)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}},{key:"setFromElevationInfo",value:function(e){this.mode=e.mode,this.unit=(0,Hc.n)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=(0,Nu.v)(e.offset,0)}},{key:"updateFeatureExpressionInfoContext",value:function(e,t,r){if((0,Nu.t)(e))this._featureExpressionInfoContext=null;else{var n=e&&e.arcade;n&&(0,Nu.r)(t)&&(0,Nu.r)(r)?(this._featureExpressionInfoContext=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}(e),vC(this._featureExpressionInfoContext,pC(n.modules,t,r))):this._featureExpressionInfoContext=e}}}],[{key:"fromElevationInfo",value:function(t){var r=new e;return(0,Nu.r)(t)&&r.setFromElevationInfo(t),r}}]),e}(),xC=function(){function e(t,r,n,i,a,o,s){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;(0,Au.Z)(this,e),this.graphics3DSymbolLayer=t,this.stageObject=r,this._uniqueGeometries=n,this._uniqueMaterials=i,this._sharedResource=a,this.elevationAligner=o,this.elevationContext=s,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=t,this.stageObject=r}return(0,ku.Z)(e,[{key:"isElevationSource",get:function(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}},{key:"initialize",value:function(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)}},{key:"destroy",value:function(){var e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);var t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),(0,Nu.r)(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}},{key:"layerOpacityChanged",value:function(e,t){if(!(0,Nu.t)(this._edgeState)){var r,n=wC(this._edgeState.baseMaterial),i=!1,a=(0,Cu.Z)(this._edgeState.edgeMaterials);try{for(a.s();!(r=a.n()).done;){var o=r.value;o.objectTransparency!==n&&(o.objectTransparency=n,i=!0)}}catch(s){a.e(s)}finally{a.f()}i&&this._resetEdgeObject(t),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}}},{key:"slicePlaneEnabledChanged",value:function(e,t){(0,Nu.t)(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e)}},{key:"setVisibility",value:function(e){if(null!=this._stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),(0,Nu.r)(this._edgeState))){var t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}},{key:"visible",get:function(){return this._visible}},{key:"alignWithElevation",value:function(e,t,r,n){null!=this.elevationAligner&&((0,Nu.r)(r)&&vC(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e,t),this._resetEdgeObject(n))}},{key:"getCenterObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Vu.n)();return(0,Vu.r)(e,(0,Qu.g)(this.stageObject.boundingVolumeObjectSpace.bounds))}},{key:"getBoundingBoxObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Gc.a)(),t=this.stageObject.boundingVolumeObjectSpace;return(0,Gc.d)(e,t.min),(0,Gc.q)(e,t.max),e}},{key:"computeAttachmentOrigin",value:function(e){if(this.useObjectOriginAsAttachmentOrigin){var t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else{var r,n=(0,Cu.Z)(this.stageObject.geometryRecords);try{for(n.s();!(r=n.n()).done;){r.value.computeAttachmentOrigin(OC)&&((0,Vu.O)(OC,OC,this.stageObject.transformation),(0,Vu.u)(e.render.origin,e.render.origin,OC),e.render.num++)}}catch(i){n.e(i)}finally{n.f()}}}},{key:"getProjectedBoundingBox",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u,c,h,d,f,p,v,m;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(o=this.getBoundingBoxObjectSpace(a),s=PC,l=(0,Gc.P)(o)?1:s.length,u=0;u<l;u++)c=s[u],SC[0]=o[c[0]],SC[1]=o[c[1]],SC[2]=o[c[2]],(0,Vu.O)(SC,SC,this.stageObject.transformation),CC[3*u+0]=SC[0],CC[3*u+1]=SC[1],CC[3*u+2]=SC[2];if(t(CC,0,l)){e.next=4;break}return e.abrupt("return",null);case 4:for((0,Gc.A)(o),h=null,this.calculateRelativeScreenBounds&&(h=this.calculateRelativeScreenBounds()),d=0;d<3*l;d+=3){for(f=0;f<3;f++)o[f]=Math.min(o[f],CC[d+f]),o[f+3]=Math.max(o[f+3],CC[d+f]);h&&n.push({location:CC.slice(d,d+3),screenSpaceBoundingRect:h})}if(!r||!r.service||"absolute-height"===this.elevationContext.mode){e.next=28;break}if((0,Gc.p)(o,OC),p="relative-to-scene"===this.elevationContext.mode?"scene":"ground",v=0,!r.useViewElevation){e.next=16;break}v=(0,Nu.v)(r.service.getElevation(OC[0],OC[1],p),0),e.next=27;break;case 16:return e.prev=16,m=NT(o,r.service.spatialReference,r),e.t0=Nu.v,e.next=21,r.service.queryElevation(OC[0],OC[1],i,m,p);case 21:e.t1=e.sent,v=(0,e.t0)(e.t1,0),e.next=27;break;case 25:e.prev=25,e.t2=e.catch(16);case 27:(0,Gc.V)(o,0,0,-this.alignedSampledElevation+v);case 28:return e.abrupt("return",o);case 29:case"end":return e.stop()}}),e,this,[[16,25]])})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"addObjectState",value:function(e,t){e===vc.u.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===vc.u.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}},{key:"removeObjectState",value:function(e){e.removeObject(this.stageObject)}},{key:"_resetEdgeObject",value:function(e){if(!(0,Nu.t)(this._edgeState)){var t=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}}},{key:"_addOrUpdateEdgeObject",value:function(e,t){var r=this,n=this._edgeState;if(!(0,Nu.t)(n)){var i,a=wC(n.baseMaterial),o=(0,Cu.Z)(n.edgeMaterials);try{for(o.s();!(i=o.n()).done;){i.value.objectTransparency=a}}catch(s){o.e(s)}finally{o.f()}e.addOrUpdateObject3D(this.stageObject,n.edgeMaterials,n.properties,!t).then((function(){var e;return null===(e=r._stageLayer)||void 0===e?void 0:e.sync()}))}}}]),e}();function wC(e){return e.isVisible?e.parameters.transparent?qc.A.TRANSPARENT:qc.A.OPAQUE:qc.A.INVISIBLE}var TC,CC=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],SC=(0,Vu.n)(),OC=(0,Vu.n)(),PC=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];!function(e){e[e.Recreate_Symbol=0]="Recreate_Symbol",e[e.Recreate_Graphics=1]="Recreate_Graphics",e[e.Fast_Update=2]="Fast_Update"}(TC||(TC={}));var RC,AC=function(){function e(t){(0,Au.Z)(this,e),this.schedule=t,this._abortController=null,this._loadStatus=RC.LOADING,this._loadError=null,this._loader=null,this.logger=null}return(0,ku.Z)(e,[{key:"destroy",value:function(){this.abortLoad()}},{key:"loadStatus",get:function(){return this._loadStatus}},{key:"load",value:function(e,t){var r=this;return this._loadStatus===RC.LOADED?(e&&e(),(0,Nu.v)(this._loader,Promise.resolve())):this._loadStatus===RC.FAILED?(t&&t(this._loadError),(0,Nu.v)(this._loader,Promise.resolve())):((0,Nu.t)(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((function(){r._abortController=null,r._loadStatus=RC.LOADED}),(function(e){throw r._loadError=e,r._abortController=null,r._loadStatus=RC.FAILED,!(0,Eu.j)(e)&&r.logger&&e.message&&r.logger.warn(e.message),e}))),this._loader.then(e,t).catch((function(){})),this._loader)}},{key:"abortLoad",value:function(){(0,Nu.r)(this._abortController)?this._abortController=(0,Nu.l)(this._abortController):this._loadStatus===RC.LOADING&&(this._loadStatus=RC.FAILED),this._loader=null}}]),e}();function kC(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function EC(e,t){var r=function(e,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return{levels:e.map((function(e){var i=r(e.tesselation);return n&&gp(i),{components:[{geometry:i,material:t}],faceCount:i.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}}))}};switch(e){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(function(e){return cp(.5,e,!0)}));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],(function(){return op(1)}));case"cone":return r(DC,(function(e){return pp(1,.5,e,!1)}),!0);case"inverted-cone":return r(DC,(function(e){return pp(1,.5,e,!0)}),!0);case"cylinder":return r(DC,(function(e){return function(e,t,r,n,i,a){var o,s=n?(0,yc.t)(n):(0,yc.r)(1,0,0),l=i?(0,yc.t)(i):(0,yc.r)(0,0,0);a=null===(o=a)||void 0===o||o;var u=(0,yc.n)();(0,Vu.z)(u,s);var c=(0,yc.n)();(0,Vu.g)(c,u,Math.abs(e));var h=(0,yc.n)();(0,Vu.g)(h,c,-.5),(0,Vu.u)(h,h,l);var d=(0,yc.r)(0,1,0);Math.abs(1-(0,Vu.P)(u,d))<.2&&(0,Vu.o)(d,0,0,1);var f=(0,yc.n)();(0,Vu._)(f,u,d),(0,Vu.z)(f,f),(0,Vu._)(d,f,u);var p=2*r+(a?2:0),v=r+(a?2:0),m=new Float32Array(3*p),y=new Float32Array(3*v),g=new Float32Array(2*p),_=new Array(3*r*(a?4:2)),b=new Array(3*r*(a?4:2));a&&(m[3*(p-2)+0]=h[0],m[3*(p-2)+1]=h[1],m[3*(p-2)+2]=h[2],g[2*(p-2)]=0,g[2*(p-2)+1]=0,m[3*(p-1)+0]=m[3*(p-2)+0]+c[0],m[3*(p-1)+1]=m[3*(p-2)+1]+c[1],m[3*(p-1)+2]=m[3*(p-2)+2]+c[2],g[2*(p-1)]=1,g[2*(p-1)+1]=1,y[3*(v-2)+0]=-u[0],y[3*(v-2)+1]=-u[1],y[3*(v-2)+2]=-u[2],y[3*(v-1)+0]=u[0],y[3*(v-1)+1]=u[1],y[3*(v-1)+2]=u[2]);for(var x=function(e,t,r){_[e]=t,b[e]=r},w=0,T=(0,yc.n)(),C=(0,yc.n)(),S=0;S<r;S++){var O=S*(2*Math.PI/r);(0,Vu.g)(T,d,Math.sin(O)),(0,Vu.g)(C,f,Math.cos(O)),(0,Vu.u)(T,T,C),y[3*S+0]=T[0],y[3*S+1]=T[1],y[3*S+2]=T[2],(0,Vu.g)(T,T,t),(0,Vu.u)(T,T,h),m[3*S+0]=T[0],m[3*S+1]=T[1],m[3*S+2]=T[2],g[2*S+0]=S/r,g[2*S+1]=0,m[3*(S+r)+0]=m[3*S+0]+c[0],m[3*(S+r)+1]=m[3*S+1]+c[1],m[3*(S+r)+2]=m[3*S+2]+c[2],g[2*(S+r)+0]=S/r,g[2*S+1]=1;var P=(S+1)%r;x(w++,S,S),x(w++,S+r,S),x(w++,P,P),x(w++,P,P),x(w++,S+r,S),x(w++,P+r,P)}if(a){for(var R=0;R<r;R++){var A=(R+1)%r;x(w++,p-2,v-2),x(w++,R,v-2),x(w++,A,v-2)}for(var k=0;k<r;k++){var E=(k+1)%r;x(w++,k+r,v-1),x(w++,p-1,v-1),x(w++,E+r,v-1)}}var D=[[fc.O.POSITION,_],[fc.O.NORMAL,b],[fc.O.UV0,_]],M=[[fc.O.POSITION,{size:3,data:m,exclusive:!0}],[fc.O.NORMAL,{size:3,data:y,exclusive:!0}],[fc.O.UV0,{size:2,data:g,exclusive:!0}]];return new dc.M(M,D)}(1,.5,e,[0,0,1],[0,0,.5])}));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],(function(){return lp(1)}),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],(function(){return sp(1)}),!0);default:return}}!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"}(RC||(RC={}));var DC=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function MC(e){var t=[];return e.levels.forEach((function(e){e.components.forEach((function(e){t.push(e.material)}))})),(0,Nu.D)(t)}function IC(e){var t=new Array;return e.levels.forEach((function(e){e.components.forEach((function(e){e.textures&&t.push.apply(t,(0,mu.Z)(e.textures))}))})),(0,Nu.D)(t)}function LC(e){var t=[];return e.components.forEach((function(e){t.push(e.geometry)})),(0,Nu.D)(t)}function ZC(e){var t=[];return e.levels.forEach((function(e){e.components.forEach((function(e){t.push(e.geometry)}))})),(0,Nu.D)(t)}function NC(e){return LC(e).reduce((function(e,t){return e+t.indexCount/3}),0)}var FC={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function zC(e){return"web-style"===e.type?FC:UC(e.symbolLayers.toArray().map((function(t){return GC(e,t)})))}function UC(e){var t,r=0,n=0,i=0,a=!1,o=0,s={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}},l=(0,Cu.Z)(e);try{for(l.s();!(t=l.n()).done;){var u=t.value;(0,Nu.t)(u)||(r+=u.primitivesPerFeature,n+=u.primitivesPerCoordinate,i+=u.drawCallsPerFeature,s.bytesPerFeature+=u.memory.bytesPerFeature,s.bytesPerFeatureLabel+=u.memory.bytesPerFeatureLabel,s.bytesPerCoordinate+=u.memory.bytesPerCoordinate,s.resourceBytes+=u.memory.resourceBytes,s.draped.bytesPerFeature+=u.memory.bytesPerFeature,s.draped.bytesPerFeatureLabel+=u.memory.bytesPerFeatureLabel,s.draped.bytesPerCoordinate+=u.memory.bytesPerCoordinate,a=a||u.estimated,++o)}}catch(c){l.e(c)}finally{l.f()}return{primitivesPerFeature:r,primitivesPerCoordinate:n,drawCallsPerFeature:i,estimated:a,memory:s,numComplexities:o}}function VC(e){var t=UC(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}var BC={};function GC(e,t){var r=HC(e,t),n=(0,qc.a)(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:n,estimated:!1,memory:r};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:n,estimated:!1,memory:r}:(0,Nu.r)(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:r}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:r};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:r}:(0,Tu.Z)((0,Tu.Z)({},function(e){var t=BC[e];if(t)return t;var r=EC(e,null);return t={primitivesPerFeature:LC(r.levels[0]).reduce((function(e,t){return e+t.indices.get(fc.O.POSITION).length/3}),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},BC[e]=t,t}(t.resource&&t.resource.primitive||Bc.r)),{},{memory:r});case"path":var i=0,a=0;switch(t.profile){case"circle":i=10;break;case"quad":i=4;break;default:return void(0,Ac.n)()}switch(t.join){case"round":a=3;break;case"miter":case"bevel":a=1;break;default:return void(0,Ac.n)()}var o=2*i,s=i*a*2,l=-2*s-o;switch(t.cap){case"none":break;case"butt":case"square":l+=2*(i-1);break;case"round":l+=2*(2*i*2+i);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:s+o,drawCallsPerFeature:0,estimated:!1,memory:r};case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:r};default:return}}function HC(e,t){var r="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?jC.EXTRUDE_EDGES:jC.EXTRUDE;case"fill":return(0,Nu.r)(t.outline)&&t.outline.size>0?jC.FILL_OUTLINE:jC.FILL;case"water":return jC.FILL;case"line":return"round"===t.join?jC.LINE_ROUND:jC.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return jC.PATH_ROUND_CIRCLE;case"quad":return jC.PATH_ROUND_QUAD;default:return void(0,Ac.n)()}case"miter":case"bevel":switch(t.profile){case"circle":return jC.PATH_MITER_CIRCLE;case"quad":return jC.PATH_MITER_QUAD;default:return void(0,Ac.n)()}default:return void(0,Ac.n)()}case"object":return r?jC.OBJECT_POINT:jC.OBJECT_POLYGON;case"icon":case"text":return r?jC.ICON_POINT:jC.ICON_POLYGON;default:return}}var jC={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,resourceBytes:0,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,resourceBytes:0,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,resourceBytes:0,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,resourceBytes:0,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,resourceBytes:0,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,resourceBytes:0,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,resourceBytes:0,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,resourceBytes:0,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,resourceBytes:0,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,resourceBytes:0,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,resourceBytes:0,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,resourceBytes:0,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},qC=Eu.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer"),WC=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,i.schedule))._context=i,o._elevationInfoOverride=null,o._ignoreDrivers=!1,o._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},o.complexity=null,o.logger=qC,o._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},o.symbol=e,o.symbolLayer=n,o._renderPriority=a.renderPriority,o._renderPriorityStep=a.renderPriorityStep,o._elevationContext=new bC,o.complexity=o.computeComplexity(),o._ignoreDrivers=a.ignoreDrivers,o._ignoreDrivers||(o._drivenProperties=YC(o._context.renderer)),o._updateElevationContext(),o}return(0,ku.Z)(r,[{key:"getCachedSize",value:function(){return null}},{key:"extentPadding",get:function(){return 0}},{key:"_drivenPropertiesChanged",value:function(e){if(this._ignoreDrivers)return!1;var t=this._drivenProperties,r=YC(e);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size}},{key:"needsDrivenTransparentPass",get:function(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}},{key:"_logGeometryCreationWarnings",value:function(e,t,r,n){var i=e.projectionSuccess,a="polygons"in e?e.polygons:null,o="".concat(n," geometry failed to be created"),s=null;i?!this._logGeometryValidationWarnings(t,r,n)&&a&&0===a.length&&"rings"===r&&t.length>0&&t[0].length>2&&(s="".concat(o," (filled rings should use clockwise winding - try reversing the order of vertices)")):s="".concat(o," (failed to project geometry to view spatial reference)"),s&&qC.warnOncePerTick(s)}},{key:"_logGeometryValidationWarnings",value:function(e,t,r){var n="".concat(r," geometry failed to be created");return!e.length||1===e.length&&!e[0].length?(qC.warnOncePerTick("".concat(n," (no ").concat(t," were defined)")),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(qC.warnOncePerTick("".concat(n," (").concat(t," should be defined as a 2D array)")),!0)}},{key:"_validateGeometry",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if((0,Nu.r)(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+" symbol: ".concat(e.type)),!1;if("point"===e.type){var n=e;if(!isFinite(n.x)||!isFinite(n.y))return qC.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}},{key:"_defaultElevationInfoNoZ",value:function(){return QC}},{key:"_defaultElevationInfoZ",value:function(){return KC}},{key:"_updateElevationContext",value:function(){(0,Nu.r)(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}},{key:"getDefaultElevationInfo",value:function(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}},{key:"getGeometryElevationMode",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultElevationInfo(e);return this._elevationContext.mode||t.mode}},{key:"setElevationInfoOverride",value:function(e){this._elevationInfoOverride=e,this._updateElevationContext()}},{key:"setGraphicElevationContext",value:function(e,t){var r=(0,Nu.e)(e.geometry),n=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:n.unit,t.mode=this.getGeometryElevationMode(r,n),t.offsetMeters=(0,Nu.v)(this._elevationContext.meterUnitOffset,(0,Nu.v)(n.offset,0));var i=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;i&&(t.mode="relative-to-ground",t.offsetMeters=0);var a=i?yC:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}},{key:"prepareSymbolLayerPatch",value:function(e){}},{key:"updateGeometry",value:function(e,t){return!1}},{key:"onRemoveGraphic",value:function(e){}},{key:"_getLayerOpacity",value:function(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;var e=this._context.layer.opacity;return null!==e&&void 0!==e?e:1}},{key:"_getCombinedOpacity",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:JC,r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||((0,Nu.r)(e)?r*=e.a:t.hasIntrinsicColor||(r=0)),r}},{key:"_getCombinedOpacityAndColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:JC,r=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return DT(null,r);var n=(0,Nu.r)(e)?sc.l.toUnitRGB(e):Vu.l;return DT(n,r)}},{key:"_getVertexOpacityAndColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this._drivenProperties.color?e.color:null,n=this._drivenProperties.opacity?e.opacity:null,i=DT(r,n);return(0,Nu.r)(t)&&(i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t),i}},{key:"isFastUpdatesEnabled",value:function(){return this._fastUpdates&&this._fastUpdates.enabled}},{key:"computeComplexity",value:function(){return GC(this.symbol,this.symbolLayer)}},{key:"globalPropertyChanged",value:function(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":var n=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,r,n)!==jT.RECREATE;case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}},{key:"updateGraphics3DGraphicElevationInfo",value:function(e,t,r){var n=this,i=jT.UPDATE;return e.forEach((function(e){var a=t(e);if((0,Nu.r)(a)){var o=e.graphic;n.setGraphicElevationContext(o,a.elevationContext),a.needsElevationUpdates=r(a.elevationContext.mode)}else i=jT.RECREATE})),i}},{key:"applyRendererDiff",value:function(e,t){return TC.Recreate_Symbol}},{key:"getFastUpdateAttrValues",value:function(e){if(!this._fastUpdates.enabled)return null;var t=this._fastUpdates.visualVariables,r=t.size?XC(t.size.field,e):0,n=t.color?XC(t.color.field,e):0,i=t.opacity?XC(t.opacity.field,e):0;return(0,lc.r)(r,n,i,0)}},{key:"draped",get:function(){return this._draped}},{key:"ensureDrapedStatus",value:function(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&qC.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}},{key:"test",value:function(){var e=this;return{drivenProperties:this._drivenProperties,getVisVarFields:function(){var t,r,n,i,a,o,s,l,u,c,h,d,f,p,v,m;return{size:null!==(t=null===(r=e._fastUpdates)||void 0===r||null===(n=r.visualVariables)||void 0===n||null===(i=n.size)||void 0===i?void 0:i.field)&&void 0!==t?t:null,color:null!==(a=null===(o=e._fastUpdates)||void 0===o||null===(s=o.visualVariables)||void 0===s||null===(l=s.color)||void 0===l?void 0:l.field)&&void 0!==a?a:null,opacity:null!==(u=null===(c=e._fastUpdates)||void 0===c||null===(h=c.visualVariables)||void 0===h||null===(d=h.opacity)||void 0===d?void 0:d.field)&&void 0!==u?u:null,rotation:null!==(f=null===(p=e._fastUpdates)||void 0===p||null===(v=p.visualVariables)||void 0===v||null===(m=v.rotation)||void 0===m?void 0:m.field)&&void 0!==f?f:null}}}}}]),r}(AC);function XC(e,t){var r=null!=e?t.attributes[e]:0;return null!=r&&isFinite(r)?r:0}function YC(e){var t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((function(e){switch(e.type){case"color":if(t.color=!0,e.stops)for(var r=0;r<e.stops.length;r++){var n=e.stops[r].color;n&&(t.opacity=!0,n.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),t}var QC={mode:"on-the-ground",offset:0,unit:"meters"},KC={mode:"absolute-height",offset:0,unit:"meters"},JC={hasIntrinsicColor:!1},$C=function(){function e(){(0,Au.Z)(this,e),this._disposed=!1}return(0,ku.Z)(e,[{key:"disposed",get:function(){return this._disposed}},{key:"shaderTransformation",get:function(){return this._shaderTransformation}},{key:"acquire",value:function(e,t,r,n,i,a){this.id=(0,Eu.a4)(),this.geometry=e,this.material=t,this.transformation=r,this.instanceParameters=n,this.origin=i,this._shaderTransformation=a,this._disposed=!1}},{key:"release",value:function(){this._disposed=!1}},{key:"dispose",value:function(){this._disposed=!0}},{key:"getStaticTransformation",value:function(){return this.transformation}},{key:"getShaderTransformation",value:function(){return(0,Nu.r)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}},{key:"computeAttachmentOrigin",value:function(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&((0,Vu.O)(e,e,this.getStaticTransformation()),!0)}}]),e}();$C.pool=new Eu.h($C);var eS=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.channel=t,this.id=(0,Eu.a4)()})),tS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Au.Z)(this,r),(e=t.call(this)).type=dc.ap.Object,e._geometryRecords=new Array,e._geometries=new Array,e._objectTransformation=(0,hc.e)(),e._bvObjectSpace=new nS,e._bvWorldSpace=new nS,e._bvDirty=!0,e._hasVolatileTransformation=!1,e._visible=!0,e.castShadow=null==n.castShadow||n.castShadow,e.metadata=n.metadata,e.metadata&&e.metadata.isElevationSource&&(e.metadata.lastValidElevationBB=new rS);var i=n.geometries,a=n.materials,o=n.transformations,s=n.origins;if(Array.isArray(i)){(0,Sc.e)(a.length===i.length,"Object3D: materials don't match geometries"),(0,Sc.e)(o.length===i.length,"Object3D: transformations don't match geometries"),e._geometryRecords.length=i.length,e._geometries.length=i.length;for(var l=0;l<i.length;l++)e._geometries[l]=i[l],e._geometryRecords[l]=$C.pool.acquire(i[l],a[l],(0,hc.r)(o[l]),{highlights:null,occludees:null,visible:e._visible},s&&s[l])}return e}return(0,ku.Z)(r,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._objectTransformation},set:function(e){(0,Wu.n)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"dispose",value:function(){this._geometryRecords.length=0,this._geometries.length=0}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(e){(0,Sc.e)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}},{key:"addGeometry",value:function(e,t,r,n,i){r=r||hc.o,this._geometries.push(e);var a=$C.pool.acquire(e,t,r,{highlights:null,occludees:null,visible:this._visible},n,i);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._hasVolatileTransformation||(0,Nu.r)(a.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:a}),this._invalidateBoundingVolume(),a}},{key:"removeGeometry",value:function(e){var t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=(0,Nu.r)(t.shaderTransformation)?this._geometryRecords.some((function(e){return(0,Nu.r)(e.shaderTransformation)})):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}},{key:"removeAllGeometries",value:function(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}},{key:"geometryVertexAttrsUpdated",value:function(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}},{key:"isVisible",get:function(){return this._visible}},{key:"setVisible",value:function(e){if(this._visible!==e){this._visible=e;var t,r=(0,Cu.Z)(this._geometryRecords);try{for(r.s();!(t=r.n()).done;){t.value.instanceParameters.visible=this._visible}}catch(n){r.e(n)}finally{r.f()}this._emit("visibilityChanged",this)}}},{key:"maskOccludee",value:function(){var e,t=new eS(vc.u.MaskOccludee),r=(0,Cu.Z)(this._geometryRecords);try{for(r.s();!(e=r.n()).done;){var n=e.value;n.instanceParameters.occludees=(0,Ic.c)(n.instanceParameters.occludees,t)}}catch(i){r.e(i)}finally{r.f()}return this._emit("occlusionChanged",this),t}},{key:"removeOcclude",value:function(e){var t,r=(0,Cu.Z)(this._geometryRecords);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.instanceParameters.occludees=(0,Ic.f)(n.instanceParameters.occludees,e)}}catch(i){r.e(i)}finally{r.f()}this._emit("occlusionChanged",this)}},{key:"highlight",value:function(){var e,t=new eS(vc.u.Highlight),r=(0,Cu.Z)(this._geometryRecords);try{for(r.s();!(e=r.n()).done;){var n=e.value;n.instanceParameters.highlights=(0,Ic.c)(n.instanceParameters.highlights,t)}}catch(i){r.e(i)}finally{r.f()}return this._emit("highlightChanged",this),t}},{key:"removeHighlight",value:function(e){var t,r=(0,Cu.Z)(this._geometryRecords);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.instanceParameters.highlights=(0,Ic.f)(n.instanceParameters.highlights,e)}}catch(i){r.e(i)}finally{r.f()}this._emit("highlightChanged",this)}},{key:"getCombinedStaticTransformation",value:function(e,t){return(0,Wu.u)(t,this.transformation,e.getStaticTransformation())}},{key:"_getCombinedShaderTransformation",value:function(e){return(0,Wu.u)((0,hc.e)(),this.transformation,e.getShaderTransformation())}},{key:"hasVolativeTransformation",value:function(){return this._hasVolatileTransformation}},{key:"boundingVolumeWorldSpace",get:function(){return this._validateBoundingVolume(),this._bvWorldSpace}},{key:"boundingVolumeObjectSpace",get:function(){return this._validateBoundingVolume(),this._bvObjectSpace}},{key:"_validateBoundingVolume",value:function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var e=0;e<this._geometryRecords.length;++e){var t=this._geometries[e],r=this._geometryRecords[e],n=t.boundingInfo;(0,Nu.r)(n)&&(this._calculateTransformedBoundingVolume(n,this._bvObjectSpace,r.getShaderTransformation()),this._calculateTransformedBoundingVolume(n,this._bvWorldSpace,this._getCombinedShaderTransformation(r)))}(0,Vu.A)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),(0,Vu.A)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);for(var i=(0,Vu.n)(),a=(0,Vu.n)(),o=(0,qu.I)(this.transformation),s=0;s<this._geometryRecords.length;++s){var l=this._geometries[s].boundingInfo;if(!(0,Nu.t)(l)){var u=this._geometryRecords[s].getShaderTransformation(),c=(0,qu.I)(u);(0,Vu.O)(i,l.getCenter(),u);var h=(0,Vu.x)(i,this._bvObjectSpace.bounds),d=l.getBSRadius()*c;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],h+d),(0,Vu.O)(a,i,this.transformation);var f=(0,Vu.x)(a,this._bvWorldSpace.bounds),p=d*o;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],f+p)}}this._bvDirty=!1}}},{key:"_calculateTransformedBoundingVolume",value:function(e,t,r){var n=e.getBBMin(),i=e.getBBMax(),a=(0,Vu.t)(n),o=(0,Vu.t)(i);(0,Vu.O)(a,a,r),(0,Vu.O)(o,o,r);for(var s=0;s<3;++s)t.min[s]=Math.min(t.min[s],a[s],o[s]),t.max[s]=Math.max(t.max[s],a[s],o[s]);for(var l=0;l<3;++l){(0,Vu.r)(a,n),(0,Vu.r)(o,i),a[l]=i[l],o[l]=n[l],(0,Vu.O)(a,a,r),(0,Vu.O)(o,o,r);for(var u=0;u<3;++u)t.min[u]=Math.min(t.min[u],a[u],o[u]),t.max[u]=Math.max(t.max[u],a[u],o[u])}}},{key:"_invalidateBoundingVolume",value:function(){this._bvDirty=!0,(0,Nu.r)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}},{key:"_emit",value:function(e,t){(0,Nu.r)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}},{key:"test",get:function(){var e=this;return{hasGeometry:function(t){return e._geometries.includes(t)},getGeometryIndex:function(t){return e._geometries.indexOf(t)}}}}]),r}(dc.ao),rS=function(){function e(){(0,Au.Z)(this,e),this.min=(0,Vu.c)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,Vu.c)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return(0,ku.Z)(e,[{key:"isEmpty",value:function(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}]),e}(),nS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).bounds=(0,Qu.R)(),e}return(0,ku.Z)(r,[{key:"init",value:function(){(0,Vu.o)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),(0,Vu.o)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),(0,Qu.C)(this.bounds)}}]),r}(rS),iS=(0,Vu.n)();function aS(e,t,r,n,i,a,o,s){var l=r?r.length:0,u=e.clippingExtent;if((0,Hu.g)(t,iS,e.elevationProvider.spatialReference),(0,Nu.r)(u)&&!(0,Gc.E)(u,iS))return null;(0,Hu.g)(t,iS,e.renderCoordsHelper.spatialReference);for(var c=e.localOriginFactory.getOrigin(iS),h=new tS({castShadow:!1,metadata:{layerUid:a,graphicUid:o,usesVerticalDistanceToGround:!0}}),d=0;d<l;d++){var f=hc.o;h.addGeometry(r[d],n[d],f,c,s)}return{object:h,sampledElevation:HT(h,t,e.elevationProvider,e.renderCoordsHelper,i)}}function oS(e,t,r){var n=e.elevationContext,i=r.spatialReference;(0,Hu.g)(t,iS,i),n.centerPointInElevationSR=(0,Uc.v)(iS[0],iS[1],t.hasZ?iS[2]:0,(0,Nu.r)(i)?i:null)}function sS(e){switch(e.type){case"point":return e;case"polygon":case"extent":return PT(e);case"polyline":var t=e.paths[0];if(!t||0===t.length)return null;var r=(0,Mu.c)(t,(0,Mu.d)(t)/2);return(0,Uc.v)(r[0],r[1],r[2],e.spatialReference);case"mesh":return e.origin}return null}function lS(e){var t=new dc.o;t.include(nv),t.include(Xx,e),t.include(dc.a0,e),t.attributes.add(fc.O.UV0,"vec2");var r=t.vertex,n=t.fragment;return r.uniforms.add([new dc.f("viewport",(function(e,t){return t.camera.fullViewport})),new dc.g("lineSize",(function(e,t){return Math.ceil(e.size)*t.camera.pixelRatio})),new dc.b("pixelToNDC",(function(e,t){return(0,uc.r)(cS,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3])})),new dc.g("borderSize",(function(e,t){return(0,Nu.r)(e.borderColor)?t.camera.pixelRatio:0})),new dc.b("screenOffset",(function(e,t){return(0,uc.r)(cS,e.screenOffset[0]*t.camera.pixelRatio,e.screenOffset[1]*t.camera.pixelRatio)}))]),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.hasMultipassGeometry&&t.varyings.add("depth","float"),e.hasScreenSizePerspective&&(0,dc.X)(r),r.code.add((0,dc.n)(Ye||(Ye=(0,wu.Z)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 endPoint = projectPositionHUD(projectAux);\n\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n    ","\n\n    ","\n      // Add view dependent polygon offset to get exact same original starting point. This is mostly\n      // used to get the correct depth value\n      vec3 posView = (view * vec4(position, 1.0)).xyz;\n      ","\n\n      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);\n      vec4 startPoint = proj * vec4(posView, 1.0);\n      // Apply screen offset to both start and end point\n      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;\n      startPoint.xy += screenOffsetNorm * startPoint.w;\n      endPoint.xy += screenOffsetNorm * endPoint.w;\n      // Align start and end to pixel origin\n      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);\n      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);\n    ","\n      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);\n      // The direction of the line in screen space\n      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);\n      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);\n    ","\n      float halfPixelSize = lineSizeScaled * 0.5;\n      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned\n      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,\n      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel\n      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).\n      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;\n      float halfPixelSizeInt = floor(halfWholePixelSize);\n\n      // Sub-pixel offset if we need to grow sub-pixels to the left\n      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);\n\n      // Pixel offset aligning to whole pixels and adding subpixel offset if needed\n      float pixelOffset = -halfPixelSizeInt + subpixelOffset;\n\n      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size\n      float padding = 1.0 + borderSizeScaled;\n      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;\n\n      // Offset x/y from the center of the line in screen space\n      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;\n\n      // Compute a coverage varying which we can use in the fragment shader to determine\n      // how much a pixel is actually covered by the line (i.e. to anti alias the line).\n      // This works by computing two coordinates that can be linearly interpolated and then\n      // subtracted to find out how far away from the line edge we are.\n      float edgeDirection = (uv0.x * 2.0 - 1.0);\n\n      float halfBorderSize = 0.5 * borderSizeScaled;\n      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;\n      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);\n\n      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);\n\n      coverageSampling = vec4(\n        // Edge coordinate\n        outerEdgeCoverageSampler,\n\n        // Border edge coordinate\n        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,\n\n        // Line offset\n        halfPixelSize - 0.5,\n\n        // Border offset\n        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)\n      );\n\n      lineSizes = vec2(lineSizeScaled, borderSizeScaled);\n\n      gl_Position = projectedPosition;\n    }\n  "])),e.occlusionTestEnabled?(0,dc.n)(Qe||(Qe=(0,wu.Z)(["\n      if (!testVisibilityHUD(endPoint)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }"]))):"",e.hasScreenSizePerspective?(0,dc.n)(Ke||(Ke=(0,wu.Z)(["\n      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);\n        "]))):(0,dc.n)(Je||(Je=(0,wu.Z)(["\n      vec2 screenOffsetScaled = screenOffset;\n        "]))),e.hasMultipassGeometry?"depth = posView.z;":"",e.depthHudEnabled?e.depthHudAlignStartEnabled?(0,dc.n)($e||($e=(0,wu.Z)(["endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);"]))):(0,dc.n)(et||(et=(0,wu.Z)(["startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);"]))):"",e.hasScreenSizePerspective?(0,dc.n)(tt||(tt=(0,wu.Z)(["\n      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);\n      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);\n        "]))):(0,dc.n)(rt||(rt=(0,wu.Z)(["\n      float lineSizeScaled = lineSize;\n      float borderSizeScaled = borderSize;\n        "]))))),n.uniforms.add([new dc.f("uColor",(function(e){return uS(e.color)})),new dc.f("borderColor",(function(e){return uS(e.borderColor)}))]),e.hasMultipassGeometry&&(n.include(Rf,e),n.uniforms.add(new dc.b("inverseViewport",(function(e,t){return t.inverseViewport})))),n.code.add((0,dc.n)(nt||(nt=(0,wu.Z)(["\n    void main() {\n      ","\n\n      // Mix between line and border coverage offsets depending on whether we need\n      // a border (based on the sidedness).\n      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);\n\n      // Mix between border and line color based on the line coverage (conceptually the line\n      // blends on top of the border background).\n      //\n      // Anti-alias by blending final result using the full (including optional border) coverage\n      // and the color alpha\n      float borderAlpha = uColor.a * borderColor.a * coverage.y;\n      float colorAlpha = uColor.a * coverage.x;\n\n      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);\n\n    ","\n  }\n  "])),e.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":"",e.depthHudEnabled?(0,dc.n)(it||(it=(0,wu.Z)(["\n      if (finalAlpha < 0.01) {\n        discard;\n      }\n      "]))):(0,dc.n)(at||(at=(0,wu.Z)(["\n      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);\n      gl_FragColor = vec4(finalRgb, finalAlpha);\n      "]))))),t}function uS(e){return(0,Nu.r)(e)?e:lc.l}var cS=(0,cc.n)(),hS=Object.freeze(Object.defineProperty({__proto__:null,build:lS},Symbol.toStringTag,{value:"Module"})),dS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.spherical=e.viewingMode===ic.l.Global}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"setPipelineState",value:function(e){var t=e?pc.I.ALWAYS:pc.I.LESS;return this.configuration.depthHudEnabled?(0,vc.W)({depthTest:{func:t},depthWrite:vc.b}):(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:vc._})}},{key:"initializePipeline",value:function(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}}]),r}(dc.k);dS.shader=new dc.m(hS,(function(){return r.e(8446).then(r.bind(r,18446))}));var fS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).screenCenterOffsetUnitsEnabled=Zx.World,e.spherical=!1,e.occlusionTestEnabled=!0,e.hasVerticalOffset=!1,e.hasScreenSizePerspective=!1,e.depthHudEnabled=!1,e.depthHudAlignStartEnabled=!1,e.hasSlicePlane=!1,e.hasMultipassGeometry=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:Zx.COUNT})],fS.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"occlusionTestEnabled",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"hasVerticalOffset",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"hasScreenSizePerspective",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"depthHudEnabled",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"depthHudAlignStartEnabled",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],fS.prototype,"hasMultipassGeometry",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],fS.prototype,"hasSliceInVertexProgram",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],fS.prototype,"isDraped",void 0);var pS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new mS))._configuration=new fS,n._uniqueMaterialIdentifier=r.uniqueMaterialIdentifier(n.parameters),n}return(0,ku.Z)(r,[{key:"uniqueMaterialIdentifier",get:function(){return this._uniqueMaterialIdentifier}},{key:"getPassParameters",value:function(){return this.parameters}},{key:"getConfiguration",value:function(e,t){var r=(null===t||void 0===t?void 0:t.slot)!==dc.H.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=(0,Nu.r)(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=(0,Nu.r)(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=r,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?Zx.Screen:Zx.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=t.multipassGeometry.enabled,this._configuration}},{key:"intersect",value:function(){}},{key:"requiresSlot",value:function(e,t){if(t===dc.O.Color)switch(e){case dc.H.LINE_CALLOUTS:case dc.H.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}},{key:"createGLMaterial",value:function(e){return new vS(e)}},{key:"createBufferWriter",value:function(){return new _S}},{key:"validateParameters",value:function(e){var t=r.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}}],[{key:"uniqueMaterialIdentifier",value:function(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}]),r}(dc.aa),vS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"beginSlot",value:function(e){return this.ensureTechnique(dS,e)}}]),r}(dc.aq),mS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).screenOffset=cc.f,e.color=[0,0,0,1],e.size=1,e.occlusionTest=!1,e.shaderPolygonOffset=1e-5,e.depthHUDAlignStart=!1,e.centerOffsetUnits="world",e.hasSlicePlane=!1,e}return(0,ku.Z)(r)}(dc.ar),yS=(0,wc.T)().vec3f(fc.O.POSITION).vec3f(fc.O.NORMAL).vec2f(fc.O.UV0).vec4f(fc.O.AUXPOS1),gS=[(0,Wc.t)(0,0),(0,Wc.t)(1,0),(0,Wc.t)(0,1),(0,Wc.t)(1,0),(0,Wc.t)(1,1),(0,Wc.t)(0,1)],_S=function(){function e(){(0,Au.Z)(this,e),this.vertexBufferLayout=yS}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return 6*e.indices.get(fc.O.POSITION).length}},{key:"write",value:function(e,t,r,n,i){(0,dc.ai)(r.indices.get(fc.O.POSITION),r.vertexAttributes.get(fc.O.POSITION).data,e,n.position,i,6),(0,dc.aj)(r.indices.get(fc.O.NORMAL),r.vertexAttributes.get(fc.O.NORMAL).data,t,n.normal,i,6),(0,dc.al)(r.indices.get(fc.O.AUXPOS1),r.vertexAttributes.get(fc.O.AUXPOS1).data,n.auxpos1,i,6);for(var a=0;a<gS.length;++a)n.uv0.setVec(i+a,gS[a])}}]),e}(),bS=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,e,null,n,CS))._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},i.ensureDrapedStatus(!1),i}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._material=new pS(this._materialParameters),this._context.stage.add(this._material);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null}},{key:"_perInstanceMaterialParameters",value:function(e){var t=this._materialParameters;return t.screenOffset=e.screenOffset||cc.f,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}},{key:"_materialParameters",get:function(){var e=this.symbol,t=e.callout,r=(0,Nu.r)(t.color)?sc.l.toUnitRGBA(t.color):[0,0,0,0];r[3]*=this._getLayerOpacity();var n=(0,zu.u)(t.size||0),i=null;if(e.verticalOffset){var a=e.verticalOffset,o=a.screenLength,s=a.minWorldLength,l=a.maxWorldLength;i={screenLength:(0,zu.u)(o),minWorldLength:s||0,maxWorldLength:(0,Nu.r)(l)?l:1/0}}var u=(0,Nu.r)(t.border)&&(0,Nu.r)(t.border.color)?sc.l.toUnitRGBA(t.border.color):null,c="object"===e.symbolLayers.getItemAt(0).type,h=!c,d=c?0:void 0,f="label-3d"===e.type;return{color:r,size:n,verticalOffset:i,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:u,occlusionTest:h,shaderPolygonOffset:d,depthHUDAlignStart:f,hasSlicePlane:this._context.slicePlaneEnabled,renderOccluded:dc.ah.Occlude,__tagStrict:"NoParameters"}}},{key:"_defaultElevationInfoNoZ",value:function(){return TS}},{key:"createGraphics3DGraphic",value:function(e){var t=e.renderingInfo,r=e.graphic,n=this.setGraphicElevationContext(r,new bC,t.elevationOffset||0),i=t.symbol,a="on-the-ground"===this._elevationContext.mode&&("cim"===i.type||!i.symbolLayers.some((function(e){return"object"===e.type||"text"===e.type})));if("label-3d"!==i.type&&a)return null;if("point-3d"===i.type&&i.symbolLayers.every((function(e){return"text"===e.type&&!(0,Bc.s)(e)})))return null;var o=PT(r.geometry);return(0,Nu.t)(o)?null:this._createAs3DShape(o,n,t,r.uid)}},{key:"layerOpacityChanged",value:function(){(0,Nu.r)(this._material)&&this._material.setParameters(this._materialParameters)}},{key:"layerElevationInfoChanged",value:function(e,t,n){var i=this,a=this._elevationContext.mode,o=VT(r.elevationModeChangeTypes,n,a);return o!==jT.UPDATE||e.forEach((function(e){var r=t(e);(0,Nu.r)(r)&&i.updateGraphicElevationContext(e.graphic,r)})),o}},{key:"slicePlaneEnabledChanged",value:function(){return(0,Nu.t)(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"setGraphicElevationContext",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=(0,_u.Z)((0,bu.Z)(r.prototype),"setGraphicElevationContext",this).call(this,e,t);return i.addOffsetRenderUnits(n),i}},{key:"updateGraphicElevationContext",value:function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=BT(t.elevationContext.mode)}},{key:"computeComplexity",value:function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:FC.memory}}},{key:"_createVertexData",value:function(e){var t=e.translation,r=e.centerOffset,n=t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},i=r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return[[fc.O.POSITION,n],[fc.O.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[fc.O.AUXPOS1,i]]}},{key:"_getOrCreateMaterial",value:function(e){var t=this._perInstanceMaterialParameters(e),r=pS.uniqueMaterialIdentifier(t);if((0,Nu.r)(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){var n=e.materialCollection.get(r);return(0,Nu.t)(n)&&(n=new pS(t),e.materialCollection.add(r,n)),{material:n,isUnique:!1}}return{material:new pS(t),isUnique:!0}}},{key:"_createAs3DShape",value:function(e,t,r,n){var i=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),a=[new dc.M(this._createVertexData(r),wS,vc.a.Point,i)],o=this._getOrCreateMaterial(r),s=aS(this._context,e,a,[o.material],t,this._context.layer.uid,n);if(null===s)return null;var l=new xC(this,s.object,a,o.isUnique?[o.material]:null,null,JT,t);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=s.sampledElevation,l.needsElevationUpdates=BT(t.mode),oS(l,e,this._context.elevationProvider),l}}]),r}(WC);bS.elevationModeChangeTypes={definedChanged:jT.UPDATE,staysOnTheGround:jT.UPDATE,onTheGroundChanged:jT.RECREATE};var xS=[0],wS=[[fc.O.POSITION,xS],[fc.O.NORMAL,xS],[fc.O.AUXPOS1,xS]],TS={mode:"relative-to-ground",offset:0},CS={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},SS=Eu.a.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function OS(e,t){if(!(0,Bc.t)(e))return SS.error("Graphics3DCalloutSymbolLayerFactory#make","symbol of type '".concat(e.type,"' does not support callouts")),null;if(!e.callout)return null;var r=PS[e.callout.type];return r?new r(e,t):(SS.error("Graphics3DCalloutSymbolLayerFactory#make","unknown or unsupported callout type ".concat(e.callout.type)),null)}var PS={line:bS},RS=(0,ku.Z)((function e(t,r,n){(0,Au.Z)(this,e),this.graphic=t,this.renderingInfo=r,this.layer=n})),AS=new Eu.h(Array,(function(e){return(0,Gc.w)(e,Gc.D)}),null,10,5),kS=(0,ju.u)(),ES=function(){function e(t,r,n,i,a){(0,Au.Z)(this,e),this.graphic=t,this.graphics3DSymbol=r,this.graphics=n,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){for(var r=new Array(e),n=0;n<r.length;n++)r[n]=new Array(t);return r}(Mx._COUNT,Ix._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++r.referenced,this._featureExpressionFeature=a?pC(a,t,i):null;var o,s=(0,Cu.Z)(n);try{for(s.s();!(o=s.n()).done;){var l=o.value;(0,Nu.r)(l)&&(this.isElevationSource=this.isElevationSource||l.isElevationSource)}}catch(u){s.e(u)}finally{s.f()}}return(0,ku.Z)(e,[{key:"labelGraphics",get:function(){return this._labelGraphics}},{key:"extent",get:function(){return this._extent}},{key:"initialize",value:function(e,t){var r=this;this._layer=t,this._stage=e,this._forEachSymbolLayerGraphic((function(n){n.initialize(e,t),n.setVisibility(r.isVisible())}))}},{key:"destroy",value:function(){this._forEachSymbolLayerGraphic((function(e){return e.destroy()})),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}},{key:"destroyed",get:function(){return null==this.graphics}},{key:"clearLabelGraphics",value:function(){this._forEachLabelGraphic((function(e){return e.destroy()})),this._labelGraphics.length=0}},{key:"addLabelGraphic",value:function(e,t,r){this._labelGraphics.push(e),e.initialize(t,r),e.setVisibility(this.isVisible(Mx.LABEL))}},{key:"addAuxiliaryGraphic",value:function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}},{key:"isDraped",get:function(){var e=!1;return this._forEachSymbolLayerGraphic((function(t){"draped"===t.type&&(e=!0)})),e}},{key:"isVisible",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Mx.GRAPHIC,t=arguments.length>1?arguments[1]:void 0,r=0;r<=e;r++)for(var n=this._visibilityFlags[r],i=0;i<n.length;++i)if(!1===n[i]&&i!==t)return!1;return!0}},{key:"hasVisibilityFlag",value:function(e,t){return null!=this._visibilityFlags[t][e]}},{key:"setVisibilityFlag",value:function(e,t,r){var n=this.isVisible(r);this._visibilityFlags[r][e]=t;var i=this.isVisible(r);if(n===i)return!1;if(r===Mx.LABEL)this._forEachLabelGraphic((function(e){return e.setVisibility(i)}));else{this._forEachSymbolLayerGraphic((function(e){return e.setVisibility(i)}));var a=this.isVisible(Mx.LABEL);this._forEachLabelGraphic((function(e){return e.setVisibility(a)}))}return!0}},{key:"clearVisibilityFlag",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mx.GRAPHIC;return this.setVisibilityFlag(e,void 0,t)}},{key:"computeExtent",value:function(e){if(!this._extent){var t=this.graphic.geometry;if((0,Nu.t)(t))return!1;this._extent=(0,ju.u)(),(0,Uc.J)(t,this._extent);var r=t.spatialReference;if(!(0,Yu.E)(r,e)&&!(0,Hu.v)(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}},{key:"getAsOptimizedGeometry",value:function(e,t){return(0,Nu.r)(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}},{key:"_convertGraphicToOptimizedGeometry",value:function(e,t,r){var n=e.geometry;return"mesh"!==n.type&&"extent"!==n.type||(n=Mu.v.fromExtent("mesh"===n.type?n.extent:n)),(0,Yc.n)(n,t,r)}},{key:"usedMemory",get:function(){var e=this,t=(0,Xc.t)(this.graphic.attributes);return this._forEachSymbolLayerGraphic((function(r){var n=r.graphics3DSymbolLayer.complexity;if(!(0,Nu.t)(n)){var i="draped"===r.type?n.memory.draped:n.memory;t+=i.bytesPerFeature,i.bytesPerCoordinate&&(t+=(0,Uc.w)(e.graphic.geometry)*i.bytesPerCoordinate)}})),t}},{key:"computeAttachmentOrigin",value:function(){var e,t={render:{origin:(0,Vu.n)(),num:0},draped:{origin:(0,cc.n)(),num:0}},r=(0,Cu.Z)(this.graphics);try{for(r.s();!(e=r.n()).done;){var n=e.value;(0,Nu.t)(n)||n.computeAttachmentOrigin(t)}}catch(i){r.e(i)}finally{r.f()}return t.render.num&&(0,Vu.g)(t.render.origin,t.render.origin,1/t.render.num),t.draped.num&&(0,uc.l)(t.draped.origin,t.draped.origin,1/t.draped.num),t}},{key:"getProjectedBoundingBox",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?(0,Gc.A)(a.boundingBox):a.boundingBox=(0,Gc.A)(),a.requiresDrapedElevation=!1,e.next=5,(0,ac.c)(this.graphics,function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(o){var s,l,u;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,Nu.t)(o)){e.next=2;break}return e.abrupt("return");case 2:return s="draped"===o.type?r:t,l=AS.acquire(),e.next=6,o.getProjectedBoundingBox(s,n,a.screenSpaceObjects,i,l);case 6:u=e.sent,isFinite(u[2])&&isFinite(u[5])||(a.requiresDrapedElevation=!0),u&&(0,Gc.f)(a.boundingBox,l),AS.release(l);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",(0,Gc.l)(a.boundingBox)||(0,ju.M)((0,Gc.B)(a.boundingBox,kS))?a:null);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"needsElevationUpdates",value:function(){var e,t=(0,Cu.Z)(this.graphics);try{for(t.s();!(e=t.n()).done;){var r=e.value;if((0,Nu.r)(r)&&("object3d"===r.type||"lod-instance"===r.type)&&r.needsElevationUpdates)return!0}}catch(o){t.e(o)}finally{t.f()}var n,i=(0,Cu.Z)(this._labelGraphics);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a&&a.needsElevationUpdates)return!0}}catch(o){i.e(o)}finally{i.f()}return!1}},{key:"alignWithElevation",value:function(e,t,r){var n=this;this._forEachRenderedGraphic((function(i){"object3d"!==i.type&&"lod-instance"!==i.type||i.alignWithElevation(e,t,n._featureExpressionFeature,r)}))}},{key:"addObjectStateSet",value:function(e,t){this._forEachSymbolLayerGraphic((function(r){return r.addObjectState(e,t)}))}},{key:"removeObjectState",value:function(e){this._forEachSymbolLayerGraphic((function(t){return t.removeObjectState(e)}))}},{key:"_forEachGraphicList",value:function(e,t){e.forEach((function(e){return e&&t(e)}))}},{key:"_forEachSymbolLayerGraphic",value:function(e){this._forEachGraphicList(this.graphics,e),this._forEachGraphicList(this._auxiliaryGraphics,e)}},{key:"_forEachLabelGraphic",value:function(e){this._forEachGraphicList(this._labelGraphics,e)}},{key:"_forEachRenderedGraphic",value:function(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}}]),e}();function DS(e,t){if(!e||e.symbol)return null;var r=t&&t.renderer;return e&&(0,Nu.r)(r)&&r.getObservationRenderer?r.getObservationRenderer(e):r}function MS(e,t){var r,n=DS(e,t),i=function(e,t){if((0,Nu.r)(e.symbol))return e.symbol;var r=DS(e,t);return(0,Nu.r)(r)&&"dot-density"!==r.type?r.getSymbol(e,t):null}(e,t);if((0,Nu.t)(i))return null;var a={renderer:n,symbol:i};if((0,Nu.t)(n)||!("visualVariables"in n)||!n.visualVariables)return a;var o,s=null!==(r=(0,$c.N)(n,e,t))&&void 0!==r?r:[],l=["proportional","proportional","proportional"],u=(0,Cu.Z)(s);try{for(u.s();!(o=u.n()).done;){var c=o.value,h=c.variable,d=c.value;switch(h.type){case"color":a.color=d.toRgba();break;case"size":if("outline"===h.target)a.outlineSize=d;else{var f=h.axis,p=h.useSymbolValue?"symbol-value":d;switch(f){case"width":l[0]=p;break;case"depth":l[1]=p;break;case"height":l[2]=p;break;case"width-and-depth":l[0]=l[1]=p;break;default:l[0]=l[1]=l[2]=p}}break;case"opacity":a.opacity=d;break;case"rotation":switch(h.axis){case"tilt":a.tilt=d;break;case"roll":a.roll=d;break;default:a.heading=d}}}}catch(v){u.e(v)}finally{u.f()}return"proportional"===l[0]&&"proportional"===l[1]&&"proportional"===l[2]||(a.size=l),a}function IS(e,t){return LS.apply(this,arguments)}function LS(){return LS=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,Nu.r)(t.symbol)){e.next=2;break}return e.abrupt("return",t.symbol);case 2:return n=DS(t,r),e.abrupt("return",(0,Nu.r)(n)?n.getSymbolAsync(t,r):null);case 4:case"end":return e.stop()}}),e)}))),LS.apply(this,arguments)}function ZS(e,t){return NS.apply(this,arguments)}function NS(){return NS=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o,s,l,u,c,h,d,f,p,v;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=DS(t,r),e.next=3,IS(t,r);case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return",null);case 6:if(o={renderer:i,symbol:a},i&&"visualVariables"in i&&i.visualVariables){e.next=9;break}return e.abrupt("return",o);case 9:s=null!==(n=(0,$c.N)(i,t,r))&&void 0!==n?n:[],l=["proportional","proportional","proportional"],u=(0,Cu.Z)(s);try{for(u.s();!(c=u.n()).done;)h=c.value,d=h.variable,f=h.value,"color"===d.type?o.color=sc.l.toUnitRGBA(f):"size"===d.type?"outline"===d.target?o.outlineSize=f:(p=d.axis,v=d.useSymbolValue?"symbol-value":f,"width"===p?l[0]=v:"depth"===p?l[1]=v:"height"===p?l[2]=v:l[0]=l[1]="width-and-depth"===p?v:l[2]=v):"opacity"===d.type?o.opacity=f:"rotation"===d.type&&"tilt"===d.axis?o.tilt=f:"rotation"===d.type&&"roll"===d.axis?o.roll=f:"rotation"===d.type&&(o.heading=f)}catch(m){u.e(m)}finally{u.f()}return e.abrupt("return",((isFinite(l[0])||isFinite(l[1])||isFinite(l[2]))&&(o.size=l),o));case 13:case"end":return e.stop()}}),e)}))),NS.apply(this,arguments)}function FS(e){var t=[[fc.O.POSITION,e.indices]],r=[[fc.O.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}]];return(0,Nu.r)(e.attributeData.color)&&(r.push([fc.O.COLOR,{size:4,data:e.attributeData.color,exclusive:!0}]),t.push([fc.O.COLOR,new Array(e.indices.length).fill(0)])),(0,Nu.r)(e.attributeData.uvMapSpace)&&(r.push([fc.O.UVMAPSPACE,{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push([fc.O.UVMAPSPACE,e.indices])),(0,Nu.r)(e.attributeData.boundingRect)&&(r.push([fc.O.BOUNDINGRECT,{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push([fc.O.BOUNDINGRECT,e.indices])),(0,Nu.r)(e.attributeData.mapPosition)&&(r.push([fc.O.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([fc.O.MAPPOS,e.indices])),new dc.M(r,t,vc.a.Triangle,e.attributeData.objectAndLayerIdColor)}function zS(e){var t=[[fc.O.POSITION,e.indices],[fc.O.UV0,e.indices]],r=[[fc.O.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}],[fc.O.UV0,{size:2,data:e.attributeData.uv0,exclusive:!0}]];return(0,Nu.r)(e.attributeData.mapPosition)&&(r.push([fc.O.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([fc.O.MAPPOS,e.indices])),new dc.M(r,t)}function US(e){switch(e.type){case"extent":if(e instanceof tc.w)return Mu.v.fromExtent(e);break;case"polygon":return e}return null}var VS,BS,GS,HS,jS,qS,WS,XS,YS,QS=(0,ku.Z)((function e(t,r,n){(0,Au.Z)(this,e),this.renderData=t,this.layerUid=r,this.graphicsUid=n,this.outGeometries=new Array,this.outMaterials=new Array,this.outTransforms=new Array}));!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(VS||(VS={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(BS||(BS={})),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(GS||(GS={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(HS||(HS={})),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(jS||(jS={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(qS||(qS={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(WS||(WS={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(XS||(XS={})),function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(YS||(YS={}));var KS,JS=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.vec3=t,this.id=r}));function $S(e,t,r,n){return new JS((0,Vu.c)(e,t,r),n)}!function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded",e[e.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"}(KS||(KS={}));var eO=function(){function e(t,r){(0,Au.Z)(this,e),this.index=t,this.renderTargets=r,this._extent=(0,ju.u)(),this.resolution=0,this.renderLocalOrigin=$S(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new tO,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(r.renderTargets.length).fill(!1)}return(0,ku.Z)(e,[{key:"extent",get:function(){return this._extent}},{key:"getValidTexture",value:function(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}},{key:"_needsColorWithoutRasterImage",get:function(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}},{key:"getColorTexture",value:function(e){var t=e===KS.ColorAndWater?this.renderTargets.getTarget(WS.Color):e===KS.Highlight?this.renderTargets.getTarget(WS.Highlight):e===KS.ObjectAndLayerIdColor?this.renderTargets.getTarget(WS.ObjectAndLayerIdColor):this.renderTargets.getTarget(WS.Occluded);return t?t.getTexture():null}},{key:"getColorTextureNoRasterImage",value:function(){return this._needsColorWithoutRasterImage?this.getValidTexture(WS.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(WS.Color):null}},{key:"getNormalTexture",value:function(e){var t=e===KS.ColorAndWater?this.renderTargets.getTarget(WS.Water):null;return t?t.getTexture():null}},{key:"draw",value:function(e,t){var r,n=this.computeRenderTargetValidityBitfield(),i=(0,Cu.Z)(this.renderTargets.renderTargets);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.type!==WS.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[a.type]=e.drawTarget(this,a,t):this.validTargets[a.type]=!1}}catch(o){i.e(o)}finally{i.f()}return n^this.computeRenderTargetValidityBitfield()?vc.c.CHANGED:vc.c.UNCHANGED}},{key:"computeRenderTargetValidityBitfield",value:function(){var e=this.validTargets;return+e[WS.Color]|+e[WS.ColorNoRasterImage]<<1|+e[WS.Highlight]<<2|+e[WS.Water]<<3|+e[WS.Occluded]<<4}},{key:"setupGeometryViewsCyclical",value:function(e){this.setupGeometryViewsDirect();var t=.001*e.range;if(this._extent[0]-t<=e.min){var r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,ju.z)(this._extent,e.range,0,r)}if(this._extent[2]+t>=e.max){var n=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,ju.z)(this._extent,-e.range,0,n)}}},{key:"setupGeometryViewsDirect",value:function(){this.canvasGeometries.numViews=1,(0,ju.a)(this.canvasGeometries.extents[0],this._extent)}},{key:"hasSomeSizedView",value:function(){for(var e=0;e<this.canvasGeometries.numViews;e++){var t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},{key:"applyViewport",value:function(e){e.setViewport(this.index===GS.INNER?0:this.resolution,0,this.resolution,this.resolution)}}]),e}();var tO=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.extents=[(0,ju.u)(),(0,ju.u)(),(0,ju.u)()],this.numViews=0})),rO=function(){function e(t,r){(0,Au.Z)(this,e),this._size=(0,Wc.n)(),this._fbo=null,this._fbo=new _c.x(t,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE},{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR_MIPMAP_LINEAR,hasMipmap:r,maxAnisotropy:8,width:0,height:0})}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._fbo=(0,Nu.G)(this._fbo)}},{key:"getTexture",value:function(){return this._fbo?this._fbo.colorTexture:null}},{key:"isValid",value:function(){return null!==this._fbo}},{key:"resize",value:function(e,t){this._size[0]=e,this._size[1]=t,this._fbo.resize(this._size[0],this._size[1])}},{key:"bind",value:function(e){e.bindFramebuffer(this._fbo)}},{key:"generateMipMap",value:function(){var e=this._fbo.colorTexture;e.descriptor.hasMipmap&&e.generateMipmap()}},{key:"disposeRenderTargetMemory",value:function(){var e;null===(e=this._fbo)||void 0===e||e.resize(0,0)}},{key:"gpuMemoryUsage",get:function(){var e,t;return null!==(e=null===(t=this._fbo)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0}}]),e}(),nO=(0,ku.Z)((function e(t,r,n){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];(0,Au.Z)(this,e),this.output=r,this.type=n,this.valid=!1,this.lastUsed=1/0,this.fbo=new rO(t,i)})),iO=function(){function e(t){(0,Au.Z)(this,e),this.renderTargets=[new nO(t,dc.O.Color,WS.Color),new nO(t,dc.O.Color,WS.ColorNoRasterImage),new nO(t,dc.O.Highlight,WS.Highlight,!1),new nO(t,dc.O.Normal,WS.Water),new nO(t,dc.O.Color,WS.Occluded)],(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new nO(t,dc.O.ObjectAndLayerIdColor,WS.ObjectAndLayerIdColor))}return(0,ku.Z)(e,[{key:"getTarget",value:function(e){return this.renderTargets[e].fbo}},{key:"dispose",value:function(){var e,t=(0,Cu.Z)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.dispose()}}catch(r){t.e(r)}finally{t.f()}}},{key:"disposeRenderTargetMemory",value:function(){var e,t=(0,Cu.Z)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.disposeRenderTargetMemory()}}catch(r){t.e(r)}finally{t.f()}}},{key:"validateUsageForTarget",value:function(e,t,r){if(e)t.lastUsed=r;else if(r-t.lastUsed>aO)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}},{key:"gpuMemoryUsage",get:function(){return this.renderTargets.reduce((function(e,t){return e+t.fbo.gpuMemoryUsage}),0)}}]),e}(),aO=1e3,oO=function(){function e(t){(0,Au.Z)(this,e),this._context=t,this._perConstructorInstances=new th.t,this._frameCounter=0,this._keepAliveFrameCount=lO}return(0,ku.Z)(e,[{key:"viewingMode",get:function(){return this._context.viewingMode}},{key:"constructionContext",get:function(){return this._context}},{key:"dispose",value:function(){this._perConstructorInstances.forEach((function(e){return e.forEach((function(e){return e.technique.destroy()}))})),this._perConstructorInstances.clear()}},{key:"acquire",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:uO,n=r.key,i=this._perConstructorInstances.get(e,n);if((0,Nu.t)(i)){var a=new e(this._context,r,(function(){return t.release(a)}));i=new sO(a),this._perConstructorInstances.set(e,n,i)}return++i.refCount,i.technique}},{key:"releaseAndAcquire",value:function(e,t,r){if((0,Nu.r)(r)){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}},{key:"release",value:function(e){if(!(0,Nu.t)(e)&&!this._perConstructorInstances.empty){var t=this._perConstructorInstances.get(e.constructor,e.key);(0,Nu.t)(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}}},{key:"frameUpdate",value:function(){var e=this;this._frameCounter++,this._keepAliveFrameCount!==lO&&this._perConstructorInstances.forEach((function(t,r){t.forEach((function(t,n){0===t.refCount&&t.refZeroFrame+e._keepAliveFrameCount<e._frameCounter&&(t.technique.destroy(),e._perConstructorInstances.delete(r,n))}))}))}},{key:"reloadAll",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t,r=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Array,this._perConstructorInstances.forEach((function(e,n){var i=function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,n){var i;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.shader,e.t0=i,!e.t0){e.next=6;break}return e.next=5,i.reload();case 5:t.forEach((function(e){return e.technique.reload(r._context)}));case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}();t.push(i(e,n))})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),sO=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.technique=t,this.refCount=0,this.refZeroFrame=0})),lO=-1,uO=new dc.q,cO=function(e){var t=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._isDisposed=!1,e}return(0,ku.Z)(r,[{key:"dispose",value:function(){var e,t,r=(0,Cu.Z)(null!==(e=this._managedDisposables)&&void 0!==e?e:[]);try{for(r.s();!(t=r.n()).done;){var n=t.value,i=this[n];this[n]=null,i&&"function"==typeof i.dispose&&i.dispose()}}catch(a){r.e(a)}finally{r.f()}this._isDisposed=!0}},{key:"isDisposed",get:function(){return this._isDisposed}}]),r}(e);return t},hO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(cO(function(){return(0,ku.Z)((function e(){(0,Au.Z)(this,e)}))}()));var dO,fO,pO=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this._textureRepository=t,this._techniqueRepository=r,this.materialChanged=n,this.requestRender=i,this._id2glMaterialRef=new th.t}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._textureRepository.dispose()}},{key:"acquire",value:function(e,t,r){if(this._ownMaterial(e),!e.requiresSlot(t,r))return null;var n=this._id2glMaterialRef.get(r,e.id);if((0,Nu.t)(n)){var i=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:r});n=new vO(i),this._id2glMaterialRef.set(r,e.id,n)}return n.ref(),n.glMaterial}},{key:"release",value:function(e,t){var r=this._id2glMaterialRef.get(t,e.id);(0,Nu.r)(r)&&(r.unref(),r.referenced||((0,Nu.G)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}},{key:"_ownMaterial",value:function(e){(0,Nu.r)(e.repository)&&e.repository!==this&&Eu.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}]),e}(),vO=function(){function e(t){(0,Au.Z)(this,e),this.glMaterial=t,this._refCnt=0}return(0,ku.Z)(e,[{key:"ref",value:function(){++this._refCnt}},{key:"unref",value:function(){--this._refCnt,(0,Sc.e)(this._refCnt>=0)}},{key:"referenced",get:function(){return this._refCnt>0}}]),e}(),mO=!1,yO=null,gO=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"],_O=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n,i,a,o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return(0,Au.Z)(this,r),(o=t.call(this)).apiLayerUid=s,o.type=dc.ap.Layer,o.events=new ec.n,o.isSliceable=!1,o._objects=new Eu.a6,o._stageHandles=new Eu.X,o.apiLayerUid=s,o.isVisible=null===(n=null===e||void 0===e?void 0:e.isVisible)||void 0===n||n,o.isPickable=null===(i=null===e||void 0===e?void 0:e.isPickable)||void 0===i||i,o.updatePolicy=null!==(a=null===e||void 0===e?void 0:e.updatePolicy)&&void 0!==a?a:vc.i.ASYNC,o}return(0,ku.Z)(r,[{key:"objects",get:function(){return this._objects}},{key:"destroy",value:function(){this.detachStage(),this._stage=null}},{key:"attachStage",value:function(e){var t=this;this.detachStage(),this._stage=e;var r,n=(0,Cu.Z)(gO);try{var i=function(){var n=r.value;t._stageHandles.add(t.events.on(n,(function(t){return e.handleEvent(n,t)})))};for(n.s();!(r=n.n()).done;)i()}catch(a){n.e(a)}finally{n.f()}}},{key:"detachStage",value:function(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}},{key:"add",value:function(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),(0,Nu.r)(this._octree)&&this._octree.add([e])}},{key:"remove",value:function(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),(0,Nu.r)(this._octree)&&this._octree.remove([e]))}},{key:"addMany",value:function(e){this._objects.pushArray(e);var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){t.value.parentLayer=this}}catch(n){r.e(n)}finally{r.f()}this.events.emit("layerObjectsAdded",{layer:this,objects:e}),(0,Nu.r)(this._octree)&&this._octree.add(e)}},{key:"removeMany",value:function(e){var t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){var r,n=(0,Cu.Z)(t);try{for(n.s();!(r=n.n()).done;){r.value.parentLayer=null}}catch(i){n.e(i)}finally{n.f()}this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),(0,Nu.r)(this._octree)&&this._octree.remove(t)}}},{key:"sync",value:function(){(0,Nu.r)(this._stage)&&this.updatePolicy!==vc.i.SYNC&&this._stage.syncLayer(this.id)}},{key:"notifyObjectBBChanged",value:function(e,t){(0,Nu.r)(this._octree)&&this._octree.update(e,t)}},{key:"getSpatialQueryAccelerator",value:function(){return(0,Nu.t)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}},{key:"shaderTransformationChanged",value:function(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}},{key:"invalidateSpatialQueryAccelerator",value:function(){this._octree=(0,Nu.g)(this._octree)}},{key:"_createOctree",value:function(){this._octree=new rh.G((function(e){return e.boundingVolumeWorldSpace.bounds})),this._octree.add(this._objects.data,this._objects.length)}}]),r}(dc.ao);function bO(e){return(0,Nu.r)(e)&&e.type===dc.ap.Layer}!function(e){e[e.Draped=0]="Draped",e[e.Screen=1]="Screen",e[e.World=2]="World",e[e.COUNT=3]="COUNT"}(dO||(dO={})),function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(fO||(fO={}));var xO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.transparencyPassType=vc.o.NONE,e.occluder=!1,e.hasSlicePlane=!1,e.writeDepth=!1,e.space=dO.Screen,e.hideOnShortSegments=!1,e.hasCap=!1,e.anchor=fO.Center,e.hasTip=!1,e.vvSize=!1,e.vvColor=!1,e.vvOpacity=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],xO.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],xO.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"occluder",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"writeDepth",void 0),(0,Eu.e)([(0,dc.p)({count:dO.COUNT})],xO.prototype,"space",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hideOnShortSegments",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hasCap",void 0),(0,Eu.e)([(0,dc.p)({count:fO.COUNT})],xO.prototype,"anchor",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hasTip",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"vvSize",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"vvColor",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"vvOpacity",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],xO.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],xO.prototype,"hasVvInstancing",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],xO.prototype,"hasSliceTranslatedView",void 0);function wO(e,t){var r=e.vertex;r.uniforms.add(new dc.g("intrinsicWidth",(function(e){return e.width}))),t.vvSize?(e.attributes.add(fc.O.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new dc.c("vvSizeMinSize",(function(e){return e.vvSizeMinSize}))),r.uniforms.add(new dc.c("vvSizeMaxSize",(function(e){return e.vvSizeMaxSize}))),r.uniforms.add(new dc.c("vvSizeOffset",(function(e){return e.vvSizeOffset}))),r.uniforms.add(new dc.c("vvSizeFactor",(function(e){return e.vvSizeFactor}))),r.code.add((0,dc.n)(ot||(ot=(0,wu.Z)(["float getSize() {\nreturn intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;\n}"]))))):(e.attributes.add(fc.O.SIZE,"float"),r.code.add((0,dc.n)(st||(st=(0,wu.Z)(["float getSize(){\nreturn intrinsicWidth * size;\n}"]))))),t.vvOpacity?(e.attributes.add(fc.O.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add([new dc.a6("vvOpacityValues",(function(e){return e.vvOpacityValues}),8),new dc.a6("vvOpacityOpacities",(function(e){return e.vvOpacityOpacities}),8)]),r.code.add((0,dc.n)(lt||(lt=(0,wu.Z)(["float interpolateOpacity( float value ){\nif (value <= vvOpacityValues[0]) {\nreturn vvOpacityOpacities[0];\n}\nfor (int i = 1; i < vvOpacityNumber; ++i) {\nif (vvOpacityValues[i] >= value) {\nfloat f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\nreturn mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);\n}\n}\nreturn vvOpacityOpacities[vvOpacityNumber - 1];\n}\nvec4 applyOpacity( vec4 color ){\nreturn vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));\n}"]))))):r.code.add((0,dc.n)(ut||(ut=(0,wu.Z)(["vec4 applyOpacity( vec4 color ){\nreturn color;\n}"])))),t.vvColor?(e.attributes.add(fc.O.COLORFEATUREATTRIBUTE,"float"),r.constants.add("vvColorNumber","int",dc.a5),r.uniforms.add(new dc.a6("vvColorValues",(function(e){return e.vvColorValues}),dc.a5)),r.uniforms.add(new dc.a4("vvColorColors",(function(e){return e.vvColorColors}),dc.a5)),r.code.add((0,dc.n)(ct||(ct=(0,wu.Z)(["vec4 interpolateColor( float value ) {\nif (value <= vvColorValues[0]) {\nreturn vvColorColors[0];\n}\nfor (int i = 1; i < vvColorNumber; ++i) {\nif (vvColorValues[i] >= value) {\nfloat f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\nreturn mix(vvColorColors[i-1], vvColorColors[i], f);\n}\n}\nreturn vvColorColors[vvColorNumber - 1];\n}\nvec4 getColor(){\nreturn applyOpacity(interpolateColor(colorFeatureAttribute));\n}"]))))):(e.attributes.add(fc.O.COLOR,"vec4"),r.code.add((0,dc.n)(ht||(ht=(0,wu.Z)(["vec4 getColor(){\nreturn applyOpacity(color);\n}"])))))}var TO=function(){function e(t){(0,Au.Z)(this,e),this._rctx=t,this._cache=new Map}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._cache.forEach((function(e){return(0,Nu.G)(e.stippleTexture)})),this._cache.clear()}},{key:"_acquire",value:function(e){if((0,Nu.t)(e))return null;var t=this._patternId(e),r=this._cache.get(t);if(r)return r.refCount++,r;var n=function(e){var t,r=SO(e),n=1/e.pixelRatio,i=OO(e),a=PO(e),o=(Math.floor(.5*(a-1))+.5)*n,s=[],l=1,u=(0,Cu.Z)(r);try{for(u.s();!(t=u.n()).done;){for(var c=t.value,h=0;h<c;h++){var d=l*(Math.min(h,c-1-h)+.5)*n/o*.5+.5;s.push(d)}l=-l}}catch(x){u.e(x)}finally{u.f()}var f,p=Math.round(r[0]/2),v=[].concat((0,mu.Z)(s.slice(p)),(0,mu.Z)(s.slice(0,p))),m=i+RO,y=new Uint8Array(4*m),g=4,_=(0,Cu.Z)(v);try{for(_.s();!(f=_.n()).done;){var b=f.value;(0,Nc.o)(b,y,g),g+=4}}catch(x){_.e(x)}finally{_.f()}return y.copyWithin(0,g-4,g),y.copyWithin(g,4,8),{encodedData:y,paddedPixels:m}}(e),i=n.encodedData,a=n.paddedPixels,o=new CO(new Oc.E(this._rctx,{width:a,height:1,internalFormat:pc.P.RGBA,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE},i));return this._cache.set(t,o),o}},{key:"release",value:function(e){if(!(0,Nu.t)(e)){var t=this._patternId(e),r=this._cache.get(t);r&&(r.refCount--,0===r.refCount&&((0,Nu.r)(r.stippleTexture)&&r.stippleTexture.dispose(),this._cache.delete(t)))}}},{key:"swap",value:function(e,t){var r=this._acquire(t);return this.release(e),r}},{key:"_patternId",value:function(e){return"".concat(e.pattern.join(","),"-r").concat(e.pixelRatio)}}]),e}(),CO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this)).stippleTexture=e,n.refCount=1,n}return(0,ku.Z)(r)}(dc.t);function SO(e){return e.pattern.map((function(t){return Math.round(t*e.pixelRatio)}))}function OO(e){if((0,Nu.t)(e))return 1;var t=SO(e);return Math.floor(t.reduce((function(e,t){return e+t})))}function PO(e){return SO(e).reduce((function(e,t){return Math.max(e,t)}))}var RO=2;var AO=(0,lc.n)();function kO(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){var r=!(t.draped&&t.stipplePreferContinuous),n=e.vertex,i=e.fragment;i.include(dc.y),t.draped||((0,dc.U)(n,t),n.uniforms.add(new dc.g("worldToScreenPerDistanceRatio",(function(e,t){return 1/t.camera.perScreenPixelRatio}))),n.code.add((0,dc.n)(dt||(dt=(0,wu.Z)(["float computeWorldToScreenRatio(vec3 segmentCenter) {\nfloat segmentDistanceToCamera = length(segmentCenter - cameraPosition);\nreturn worldToScreenPerDistanceRatio / segmentDistanceToCamera;\n}"]))))),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),n.code.add((0,dc.n)(ft||(ft=(0,wu.Z)(["\n    float discretizeWorldToScreenRatio(float worldToScreenRatio) {\n      float step = ",";\n\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n      return discreteWorldToScreenRatio;\n    }\n  "])),MO)),n.code.add((0,dc.n)(pt||(pt=(0,wu.Z)(["vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {"])))),n.code.add((0,dc.n)(vt||(vt=(0,wu.Z)(["\n    if (segmentLengthPseudoScreen >= ",") {\n  "])),r?"patternLength":"1e4")),n.uniforms.add(new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),n.code.add((0,dc.n)(mt||(mt=(0,wu.Z)(["\n        // Round the screen length to get an integer number of pattern repetitions (minimum 1).\n        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);\n        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));\n        float segmentLengthScreenRounded = flooredRepetitions * patternLength;\n\n        ","\n\n        return vec2(0.0, segmentLengthScreenRounded);\n      }\n      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);\n    }\n  "])),t.stippleRequiresStretchMeasure?(0,dc.n)(yt||(yt=(0,wu.Z)(["\n              float stretch = repetitions / flooredRepetitions;\n\n              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.\n              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.\n              vStipplePatternStretch = max(0.75, stretch);"]))):"")),i.constants.add("stippleTexturePadding","float",RO);var a=t.hasWebGL2Context?dc.$.None:dc.$.Size;i.uniforms.add((0,dc.Z)("stipplePatternTexture",(function(e){return e.stippleTexture}),a)),i.uniforms.add([new dc.g("stipplePatternSDFNormalizer",(function(e){return function(e){return(0,Nu.r)(e)?(Math.floor(.5*(PO(e)-1))+.5)/e.pixelRatio:1}(e.stipplePattern)})),new dc.g("stipplePatternPixelSizeInv",(function(e){return 1/EO(e)}))]),i.code.add((0,dc.n)(gt||(gt=(0,wu.Z)(["\n    float padStippleTexture(float u) {\n      float paddedTextureSize = ",".x;\n      float unpaddedTextureSize = paddedTextureSize - stippleTexturePadding;\n\n      return (u * unpaddedTextureSize + stippleTexturePadding * 0.5) / paddedTextureSize;\n    }\n  "])),(0,dc.as)(t,"stipplePatternTexture"))),i.code.add((0,dc.n)(_t||(_t=(0,wu.Z)(["\n    float getStippleSDF(out bool isClamped) {\n      ","\n\n      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;\n      ","\n      u = padStippleTexture(fract(u));\n\n      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));\n      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;\n\n      ","\n    }\n\n    float getStippleSDF() {\n      bool ignored;\n      return getStippleSDF(ignored);\n    }\n\n    float getStippleAlpha() {\n      bool isClamped;\n      float stippleSDF = getStippleSDF(isClamped);\n\n      float antiAliasedResult = ","\n\n      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;\n    }\n  "])),t.stippleRequiresClamp?(0,dc.n)(bt||(bt=(0,wu.Z)(["\n          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);\n          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;\n          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;"]))):(0,dc.n)(xt||(xt=(0,wu.Z)(["\n          float stippleDistanceClamped = vStippleDistance;\n          isClamped = false;"]))),t.stippleScaleWithLineWidth?(0,dc.n)(wt||(wt=(0,wu.Z)(["u *= vLineSizeInv;"]))):"",t.stippleRequiresStretchMeasure?(0,dc.n)(Tt||(Tt=(0,wu.Z)(["return (sdf - 0.5) * vStipplePatternStretch + 0.5;"]))):(0,dc.n)(Ct||(Ct=(0,wu.Z)(["return sdf;"]))),t.stippleScaleWithLineWidth?(0,dc.n)(St||(St=(0,wu.Z)(["clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);"]))):(0,dc.n)(Ot||(Ot=(0,wu.Z)(["clamp(stippleSDF + 0.5, 0.0, 1.0);"]))))),t.stippleOffColorEnabled?(i.uniforms.add(new dc.f("stippleOffColor",(function(e){return function(e){return(0,Nu.t)(e)?lc.l:4===e.length?e:(0,Vu.C)(AO,e[0],e[1],e[2],1)}(e.stippleOffColor)}))),i.code.add((0,dc.n)(Pt||(Pt=(0,wu.Z)(["#define discardByStippleAlpha(stippleAlpha, threshold) {}\n#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)"]))))):i.code.add((0,dc.n)(Rt||(Rt=(0,wu.Z)(["#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }\n#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)"]))))}(e,t):function(e){e.fragment.code.add((0,dc.n)(At||(At=(0,wu.Z)(["float getStippleAlpha() { return 1.0; }\n#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}\n#define blendStipple(color, _stippleAlpha_) color"]))))}(e)}function EO(e){var t=e.stipplePattern;return(0,Nu.r)(t)?OO(e.stipplePattern)/t.pixelRatio:1}var DO,MO=dc.n.float(.4),IO=10;function LO(e,t){return e.fromData("".concat(t,"-marker"),(function(){return Kx(t,64,32,6.4)}))}function ZO(e,t){var r=e.vertex;e.constants.add("markerSizePerLineWidth","float",IO),r.uniforms.add(new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),(0,Nu.t)(r.uniforms.get("markerScale"))&&r.constants.add("markerScale","float",1),r.code.add((0,dc.n)(kt||(kt=(0,wu.Z)(["float getLineWidth() {\nreturn max(getSize(), 1.0) * pixelRatio;\n}\nfloat getScreenMarkerSize() {\nreturn markerSizePerLineWidth * markerScale * getLineWidth();\n}"])))),t.space===dO.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new dc.g("perRenderPixelRatio",(function(e,t){return t.camera.perRenderPixelRatio}))),r.code.add((0,dc.n)(Et||(Et=(0,wu.Z)(["float getWorldMarkerSize(vec4 pos) {\nfloat distanceToCamera = length(pos.xyz);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nreturn getScreenMarkerSize() * screenToWorldRatio;\n}\nbool areWorldMarkersHidden(vec4 pos, vec4 other) {\nvec3 midPoint = mix(pos.xyz, other.xyz, 0.5);\nfloat distanceToCamera = length(midPoint);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nfloat worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;\nfloat segmentLen = length(pos.xyz - other.xyz);\nreturn worldMarkerSize > maxSegmentLengthFraction * segmentLen;\n}"])))))}!function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"}(DO||(DO={}));var NO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.capType=DO.BUTT,e.transparencyPassType=vc.o.NONE,e.occluder=!1,e.hasSlicePlane=!1,e.hasPolygonOffset=!1,e.writeDepth=!1,e.draped=!1,e.stippleEnabled=!1,e.stippleOffColorEnabled=!1,e.stippleScaleWithLineWidth=!1,e.stipplePreferContinuous=!0,e.roundJoins=!1,e.applyMarkerOffset=!1,e.vvSize=!1,e.vvColor=!1,e.vvOpacity=!1,e.falloffEnabled=!1,e.innerColorEnabled=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.wireframe=!1,e.objectAndLayerIdColorInstanced=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],NO.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:DO.COUNT})],NO.prototype,"capType",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],NO.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"occluder",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"hasPolygonOffset",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"writeDepth",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"draped",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"stippleEnabled",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"stippleOffColorEnabled",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"stippleScaleWithLineWidth",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"stipplePreferContinuous",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"roundJoins",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"applyMarkerOffset",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"vvSize",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"vvColor",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"vvOpacity",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"falloffEnabled",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"innerColorEnabled",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"wireframe",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],NO.prototype,"stippleRequiresClamp",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],NO.prototype,"stippleRequiresStretchMeasure",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],NO.prototype,"hasVvInstancing",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],NO.prototype,"hasSliceTranslatedView",void 0),(0,Eu.e)([(0,dc.p)()],NO.prototype,"objectAndLayerIdColorInstanced",void 0);var FO=1;function zO(e){var t=new dc.o,r=t.vertex,n=t.fragment,i=e.hasMultipassTerrain&&(e.output===dc.O.Color||e.output===dc.O.Alpha);t.include(dc.C),t.include(wO,e),t.include(kO,e);var a=e.applyMarkerOffset&&!e.draped;a&&(r.uniforms.add(new dc.g("markerScale",(function(e){return e.markerScale}))),t.include(ZO,{space:dO.World})),e.output===dc.O.Depth&&t.include(dc.at,e),t.include(dc.a2,e),(0,dc.T)(r,e),r.uniforms.add([new dc.e("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new dc.b("nearFar",(function(e,t){return t.camera.nearFar})),new dc.g("miterLimit",(function(e){return"miter"!==e.join?0:e.miterLimit})),new dc.f("viewport",(function(e,t){return t.camera.fullViewport}))]),r.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(fc.O.POSITION,"vec3"),t.attributes.add(fc.O.SUBDIVISIONFACTOR,"float"),t.attributes.add(fc.O.UV0,"vec2"),t.attributes.add(fc.O.AUXPOS1,"vec3"),t.attributes.add(fc.O.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),(0,dc.au)(t),i&&t.varyings.add("depth","float");var o=e.capType===DO.ROUND,s=e.stippleEnabled&&e.stippleScaleWithLineWidth||o;s&&t.varyings.add("vLineWidth","float");var l=e.stippleEnabled&&e.stippleScaleWithLineWidth;l&&t.varyings.add("vLineSizeInv","float");var u=e.innerColorEnabled||o;u&&t.varyings.add("vLineDistance","float");var c=e.stippleEnabled&&o,h=e.falloffEnabled||c;h&&t.varyings.add("vLineDistanceNorm","float"),o&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),r.code.add((0,dc.n)(Dt||(Dt=(0,wu.Z)(["#define PERPENDICULAR(v) vec2(v.y, -v.x);\nfloat interp(float ncp, vec4 a, vec4 b) {\nreturn (-ncp - a.z) / (b.z - a.z);\n}\nvec2 rotate(vec2 v, float a) {\nfloat s = sin(a);\nfloat c = cos(a);\nmat2 m = mat2(c, -s, s, c);\nreturn m * v;\n}"])))),r.code.add((0,dc.n)(Mt||(Mt=(0,wu.Z)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),(0,dc.av)(t),r.code.add((0,dc.n)(It||(It=(0,wu.Z)(["\n    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {\n      float vnp = nearFar[0] * 0.99;\n\n      if(pos.z > -nearFar[0]) {\n        //current pos behind ncp --\x3e we need to clip\n        if (!isStartVertex) {\n          if(prev.z < -nearFar[0]) {\n            //previous in front of ncp\n            pos = mix(prev, pos, interp(vnp, prev, pos));\n            next = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        } else {\n          if(next.z < -nearFar[0]) {\n            //next in front of ncp\n            pos = mix(pos, next, interp(vnp, pos, next));\n            prev = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        }\n      } else {\n        //current position visible\n        if (prev.z > -nearFar[0]) {\n          //previous behind ncp\n          prev = mix(pos, prev, interp(vnp, pos, prev));\n        }\n        if (next.z > -nearFar[0]) {\n          //next behind ncp\n          next = mix(next, pos, interp(vnp, next, pos));\n        }\n      }\n\n      ","\n      linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n      pos = projectAndScale(pos);\n      next = projectAndScale(next);\n      prev = projectAndScale(prev);\n    }\n  "])),i?"depth = pos.z;":"")),r.uniforms.add(new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),r.code.add((0,dc.n)(Lt||(Lt=(0,wu.Z)(["\n  void main(void) {\n    // unpack values from uv0.y\n    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;\n\n    float coverage = 1.0;\n\n    // Check for special value of uv0.y which is used by the Renderer when graphics\n    // are removed before the VBO is recompacted. If this is the case, then we just\n    // project outside of clip space.\n    if (uv0.y == 0.0) {\n      // Project out of clip space\n      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n    else {\n      bool isJoin = abs(uv0.y) < 3.0;\n\n      float lineSize = getSize();\n      float lineWidth = lineSize * pixelRatio;\n\n      ","\n      ","\n\n      // convert sub-pixel coverage to alpha\n      if (lineWidth < 1.0) {\n        coverage = lineWidth;\n        lineWidth = 1.0;\n      }else{\n        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if\n        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly\n        // so we only really care to round anything larger than 1.\n        lineWidth = floor(lineWidth + 0.5);\n      }\n\n      vec4 pos  = view * vec4(position.xyz, 1.0);\n      vec4 prev = view * vec4(auxpos1.xyz, 1.0);\n      vec4 next = view * vec4(auxpos2.xyz, 1.0);\n  "])),s?(0,dc.n)(Zt||(Zt=(0,wu.Z)(["vLineWidth = lineWidth;"]))):"",l?(0,dc.n)(Nt||(Nt=(0,wu.Z)(["vLineSizeInv = 1.0 / lineSize;"]))):"")),a&&r.code.add((0,dc.n)(Ft||(Ft=(0,wu.Z)(["vec4 other = isStartVertex ? next : prev;\nbool markersHidden = areWorldMarkersHidden(pos, other);\nif(!isJoin && !markersHidden) {\npos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;\n}"])))),r.code.add((0,dc.n)(zt||(zt=(0,wu.Z)(["clipAndTransform(pos, prev, next, isStartVertex);\nvec2 left = (pos.xy - prev.xy);\nvec2 right = (next.xy - pos.xy);\nfloat leftLen = length(left);\nfloat rightLen = length(right);"])))),(e.stippleEnabled||o)&&r.code.add((0,dc.n)(Ut||(Ut=(0,wu.Z)(["\n      float isEndVertex = float(!isStartVertex);\n      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);\n      vec2 segment = mix(right, left, isEndVertex);\n      ","\n    "])),o?(0,dc.n)(Vt||(Vt=(0,wu.Z)(["vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);"]))):"")),r.code.add((0,dc.n)(Bt||(Bt=(0,wu.Z)(["left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);\nright = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);\nvec2 capDisplacementDir = vec2(0, 0);\nvec2 joinDisplacementDir = vec2(0, 0);\nfloat displacementLen = lineWidth;\nif (isJoin) {\nbool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;\njoinDisplacementDir = normalize(left + right);\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\nif (leftLen > 0.001 && rightLen > 0.001) {\nfloat nDotSeg = dot(joinDisplacementDir, left);\ndisplacementLen /= length(nDotSeg * left - joinDisplacementDir);\nif (!isOutside) {\ndisplacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));\n}\n}\nif (isOutside && (displacementLen > miterLimit * lineWidth)) {"])))),e.roundJoins?r.code.add((0,dc.n)(Gt||(Gt=(0,wu.Z)(["\n        vec2 startDir = leftLen < 0.001 ? right : left;\n        startDir = PERPENDICULAR(startDir);\n\n        vec2 endDir = rightLen < 0.001 ? left : right;\n        endDir = PERPENDICULAR(endDir);\n\n        float factor = ",";\n\n        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));\n        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);\n      "])),e.stippleEnabled?(0,dc.n)(Ht||(Ht=(0,wu.Z)(["min(1.0, subdivisionFactor * ",")"])),dc.n.float((FO+2)/(FO+1))):(0,dc.n)(jt||(jt=(0,wu.Z)(["subdivisionFactor"]))))):r.code.add((0,dc.n)(qt||(qt=(0,wu.Z)(["if (leftLen < 0.001) {\njoinDisplacementDir = right;\n}\nelse if (rightLen < 0.001) {\njoinDisplacementDir = left;\n}\nelse {\njoinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;\n}\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);"]))));var d=e.capType!==DO.BUTT;return r.code.add((0,dc.n)(Wt||(Wt=(0,wu.Z)(["\n        displacementLen = lineWidth;\n      }\n    } else {\n      // CAP handling ---------------------------------------------------\n      joinDisplacementDir = isStartVertex ? right : left;\n      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\n\n      ","\n    }\n  "])),d?(0,dc.n)(Xt||(Xt=(0,wu.Z)(["capDisplacementDir = isStartVertex ? -right : left;"]))):"")),r.code.add((0,dc.n)(Yt||(Yt=(0,wu.Z)(["\n    // Displacement (in pixels) caused by join/or cap\n    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;\n\n    ","\n\n    ","\n    ","\n\n    pos.xy += dpos;\n  "])),h||u?(0,dc.n)(Qt||(Qt=(0,wu.Z)(["float lineDistNorm = sign(uv0.y) * pos.w;"]))):"",u?(0,dc.n)(Kt||(Kt=(0,wu.Z)(["vLineDistance = lineWidth * lineDistNorm;"]))):"",h?(0,dc.n)(Jt||(Jt=(0,wu.Z)(["vLineDistanceNorm = lineDistNorm;"]))):"")),o&&r.code.add((0,dc.n)($t||($t=(0,wu.Z)(["vec2 segmentDir = normalize(segment);\nvSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;\nvReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);"])))),e.stippleEnabled&&(e.draped?r.uniforms.add(new dc.g("worldToScreenRatio",(function(e,t){return 1/t.screenToPCSRatio}))):r.code.add((0,dc.n)(er||(er=(0,wu.Z)(["vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),r.code.add((0,dc.n)(tr||(tr=(0,wu.Z)(["float segmentLengthScreenDouble = length(segment);\nfloat segmentLengthScreen = segmentLengthScreenDouble * 0.5;\nfloat discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);\nfloat segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));\nvStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;"])))),e.draped?r.code.add((0,dc.n)(rr||(rr=(0,wu.Z)(["float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;\nfloat startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);"])))):r.code.add((0,dc.n)(nr||(nr=(0,wu.Z)(["float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),r.uniforms.add(new dc.g("stipplePatternPixelSize",(function(e){return EO(e)}))),r.code.add((0,dc.n)(ir||(ir=(0,wu.Z)(["\n      float patternLength = "," stipplePatternPixelSize;\n\n      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader\n      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);\n\n      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);\n\n      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)\n      if (segmentLengthScreenDouble >= 0.001) {\n        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the\n        // original vertex positions, and slightly outside of that range at the displaced positions\n        vec2 stippleDisplacement = pos.xy - segmentOrigin;\n        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);\n\n        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)\n        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);\n      }\n\n      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance\n      vStippleDistanceLimits *= pos.w;\n      vStippleDistance *= pos.w;\n\n      // Disable stipple distance limits on caps\n      vStippleDistanceLimits = isJoin ?\n                                 vStippleDistanceLimits :\n                                 isStartVertex ?\n                                  vec2(-1e038, vStippleDistanceLimits.y) :\n                                  vec2(vStippleDistanceLimits.x, 1e038);\n    "])),e.stippleScaleWithLineWidth?"lineSize * ":""))),r.code.add((0,dc.n)(ar||(ar=(0,wu.Z)(["\n      // Convert back into NDC\n      pos.xy = (pos.xy / viewport.zw) * pos.w;\n\n      vColor = getColor();\n      vColor.a *= coverage;\n\n      ","\n\n      // transform final position to camera space for slicing\n      vpos = (inverseProjectionMatrix * pos).xyz;\n      gl_Position = pos;\n      forwardObjectAndLayerIdColor();\n    }\n  }\n  "])),e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":"")),i&&t.include(dc.aw,e),t.include(dc.a0,e),n.include(dc.x),n.code.add((0,dc.n)(or||(or=(0,wu.Z)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n  "])),i?"terrainDepthTest(gl_FragCoord, depth);":"")),e.wireframe?n.code.add((0,dc.n)(sr||(sr=(0,wu.Z)(["vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);"])))):(o&&n.code.add((0,dc.n)(lr||(lr=(0,wu.Z)(["\n      float sdf = min(vSegmentSDF, vReverseSegmentSDF);\n      vec2 fragmentPosition = vec2(\n        min(sdf, 0.0),\n        vLineDistance\n      ) * gl_FragCoord.w;\n\n      float fragmentRadius = length(fragmentPosition);\n      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);\n\n      if (capCoverage < ",") {\n        discard;\n      }\n    "])),dc.n.float(dc.a7))),c?n.code.add((0,dc.n)(ur||(ur=(0,wu.Z)(["\n      vec2 stipplePosition = vec2(\n        min(getStippleSDF() * 2.0 - 1.0, 0.0),\n        vLineDistanceNorm * gl_FragCoord.w\n      );\n      float stippleRadius = length(stipplePosition * vLineWidth);\n      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);\n      float stippleAlpha = step(",", stippleCoverage);\n      "])),dc.n.float(dc.a7))):n.code.add((0,dc.n)(cr||(cr=(0,wu.Z)(["float stippleAlpha = getStippleAlpha();"])))),n.uniforms.add(new dc.f("intrinsicColor",(function(e){return e.color}))),n.code.add((0,dc.n)(hr||(hr=(0,wu.Z)(["discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);\nvec4 color = intrinsicColor * vColor;"])))),e.innerColorEnabled&&(n.uniforms.add(new dc.f("innerColor",(function(e){return(0,Nu.v)(e.innerColor,e.color)}))),n.uniforms.add(new dc.g("innerWidth",(function(e,t){return e.innerWidth*t.camera.pixelRatio}))),n.code.add((0,dc.n)(dr||(dr=(0,wu.Z)(["float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;\nfloat innerAA = clamp(0.5 - distToInner, 0.0, 1.0);\nfloat innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);\ncolor = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);"]))))),n.code.add((0,dc.n)(fr||(fr=(0,wu.Z)(["vec4 finalColor = blendStipple(color, stippleAlpha);"])))),e.falloffEnabled&&(n.uniforms.add(new dc.g("falloff",(function(e){return e.falloff}))),n.code.add((0,dc.n)(pr||(pr=(0,wu.Z)(["finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);"])))))),n.code.add((0,dc.n)(vr||(vr=(0,wu.Z)(["\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),dc.n.float(dc.a7),e.output===dc.O.Alpha?(0,dc.n)(mr||(mr=(0,wu.Z)(["gl_FragColor = vec4(finalColor.a);"]))):"",e.output===dc.O.Color?(0,dc.n)(yr||(yr=(0,wu.Z)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===dc.O.Color&&e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":"",e.output===dc.O.Highlight?(0,dc.n)(gr||(gr=(0,wu.Z)(["gl_FragColor = vec4(1.0);"]))):"",e.output===dc.O.Depth?(0,dc.n)(_r||(_r=(0,wu.Z)(["outputDepth(linearDepth);"]))):"",e.output===dc.O.ObjectAndLayerIdColor?(0,dc.n)(br||(br=(0,wu.Z)(["outputObjectAndLayerIdColor();"]))):"")),t}var UO=Object.freeze(Object.defineProperty({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:FO,build:zO},Symbol.toStringTag,{value:"Module"})),VO=new Map([[fc.O.POSITION,0],[fc.O.SUBDIVISIONFACTOR,1],[fc.O.UV0,2],[fc.O.AUXPOS1,3],[fc.O.AUXPOS2,4],[fc.O.COLOR,5],[fc.O.COLORFEATUREATTRIBUTE,5],[fc.O.SIZE,6],[fc.O.SIZEFEATUREATTRIBUTE,6],[fc.O.OPACITYFEATUREATTRIBUTE,7],[fc.O.OBJECTANDLAYERIDCOLOR,8]]),BO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),VO)}},{key:"_makePipelineState",value:function(e,t){var r=this.configuration,n=e===vc.o.NONE,i=e===vc.o.FrontFace;return(0,vc.W)({blending:r.output===dc.O.Color||r.output===dc.O.Alpha?n?vc.d:(0,vc.A)(e):null,depthTest:{func:(0,vc.e)(e)},depthWrite:n?r.writeDepth&&vc.b:(0,vc.E)(e),colorWrite:vc._,stencilWrite:r.hasOccludees?dc.ax:null,stencilTest:r.hasOccludees?t?dc.ay:dc.az:null,polygonOffset:n||i?r.hasPolygonOffset&&HO:vc.f})}},{key:"initializePipeline",value:function(){var e=this.configuration;if(e.occluder){var t=e.hasPolygonOffset&&HO;this._occluderPipelineTransparent=(0,vc.W)({blending:vc.d,polygonOffset:t,depthTest:dc.aA,depthWrite:null,colorWrite:vc._,stencilWrite:null,stencilTest:dc.aB}),this._occluderPipelineOpaque=(0,vc.W)({blending:vc.d,polygonOffset:t,depthTest:dc.aA,depthWrite:null,colorWrite:vc._,stencilWrite:dc.aC,stencilTest:dc.aD}),this._occluderPipelineMaskWrite=(0,vc.W)({blending:null,polygonOffset:t,depthTest:dc.aE,depthWrite:null,colorWrite:null,stencilWrite:dc.ax,stencilTest:dc.ay})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}},{key:"primitiveType",get:function(){return this.configuration.wireframe?pc.E.LINES:pc.E.TRIANGLE_STRIP}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===dc.H.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===dc.H.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);BO.shader=new dc.m(UO,(function(){return r.e(7389).then(r.bind(r,7389))}));var GO,HO={factor:0,units:-4};!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(GO||(GO={}));var jO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new WO))._configuration=new NO,n._vertexAttributeLocations=VO,n._layout=n.createLayout(),n}return(0,ku.Z)(r,[{key:"isClosed",value:function(e,t){return KO(this.parameters,e,t)}},{key:"getConfiguration",value:function(e,t){this._configuration.output=e,this._configuration.draped=t.slot===dc.H.DRAPED_MATERIAL;var r=(0,Nu.r)(this.parameters.stipplePattern)&&e!==dc.O.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&(0,Nu.r)(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!(0,Nu.r)(this.parameters.markerParameters)&&function(e){return e.anchor===fO.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&(0,Nu.r)(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===dc.ah.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}},{key:"intersect",value:function(e,t,r,n,i,a,o,s,l){(0,Nu.r)(l)?this._intersectDrapedLineGeometry(e,n,l,a,o):this._intersectLineGeometry(e,t,r,n,o)}},{key:"_intersectDrapedLineGeometry",value:function(e,t,r,n,i){if(t.options.selectionMode){var a=e.vertexAttributes.get(fc.O.POSITION).data,o=e.vertexAttributes.get(fc.O.SIZE),s=this.parameters.width;if(this.parameters.vvSizeEnabled){var l=e.vertexAttributes.get(fc.O.SIZEFEATUREATTRIBUTE).data[0];s*=(0,Vu.a)(this.parameters.vvSizeOffset[0]+l*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o&&(s*=o.data[0]);for(var u=n[0],c=n[1],h=(s/2+4)*e.screenToWorldRatio,d=Number.MAX_VALUE,f=0,p=0;p<a.length-5;p+=3){var v=a[p],m=a[p+1],y=u-v,g=c-m,_=a[p+3]-v,b=a[p+4]-m,x=(0,Vu.a)((_*y+b*g)/(_*_+b*b),0,1),w=_*x-y,T=b*x-g,C=w*w+T*T;C<d&&(d=C,f=p/3)}d<h*h&&i(r.dist,r.normal,f,!1)}}},{key:"_intersectLineGeometry",value:function(e,t,r,n,i){if(n.options.selectionMode&&!(0,Ic.a)(t))if((0,Sc.a)(r)){var a=e.vertexAttributes,o=a.get(fc.O.POSITION).data,s=this.parameters.width;if(this.parameters.vvSizeEnabled){var l=a.get(fc.O.SIZEFEATUREATTRIBUTE).data[0];s*=(0,Vu.a)(this.parameters.vvSizeOffset[0]+l*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a.has(fc.O.SIZE)&&(s*=a.get(fc.O.SIZE).data[0]);var u=n.camera,c=nP;(0,uc.a)(c,n.point);var h=s*u.pixelRatio/2+4*u.pixelRatio;(0,Vu.o)(fP[0],c[0]-h,c[1]+h,0),(0,Vu.o)(fP[1],c[0]+h,c[1]+h,0),(0,Vu.o)(fP[2],c[0]+h,c[1]-h,0),(0,Vu.o)(fP[3],c[0]-h,c[1]-h,0);for(var d=0;d<4;d++)if(!u.unprojectFromRenderScreen(fP[d],pP[d]))return;(0,Tc.j)(u.eye,pP[0],pP[1],vP),(0,Tc.j)(u.eye,pP[1],pP[2],mP),(0,Tc.j)(u.eye,pP[2],pP[3],yP),(0,Tc.j)(u.eye,pP[3],pP[0],gP);for(var f=Number.MAX_VALUE,p=0,v=QO(this.parameters,a,e.indices)?o.length-2:o.length-5,m=0;m<v;m+=3){$O[0]=o[m]+r[12],$O[1]=o[m+1]+r[13],$O[2]=o[m+2]+r[14];var y=(m+3)%o.length;if(eP[0]=o[y]+r[12],eP[1]=o[y+1]+r[13],eP[2]=o[y+2]+r[14],!((0,Tc.R)(vP,$O)<0&&(0,Tc.R)(vP,eP)<0||(0,Tc.R)(mP,$O)<0&&(0,Tc.R)(mP,eP)<0||(0,Tc.R)(yP,$O)<0&&(0,Tc.R)(yP,eP)<0||(0,Tc.R)(gP,$O)<0&&(0,Tc.R)(gP,eP)<0)){if(u.projectToRenderScreen($O,iP),u.projectToRenderScreen(eP,aP),iP[2]<0&&aP[2]>0){(0,Vu.e)(tP,$O,eP);var g=u.frustum,_=-(0,Tc.R)(g[kc.U.NEAR],$O)/(0,Vu.P)(tP,(0,Tc.Y)(g[kc.U.NEAR]));(0,Vu.g)(tP,tP,_),(0,Vu.u)($O,$O,tP),u.projectToRenderScreen($O,iP)}else if(iP[2]>0&&aP[2]<0){(0,Vu.e)(tP,eP,$O);var b=u.frustum,x=-(0,Tc.R)(b[kc.U.NEAR],eP)/(0,Vu.P)(tP,(0,Tc.Y)(b[kc.U.NEAR]));(0,Vu.g)(tP,tP,x),(0,Vu.u)(eP,eP,tP),u.projectToRenderScreen(eP,aP)}else if(iP[2]<0&&aP[2]<0)continue;iP[2]=0,aP[2]=0;var w=(0,Sc.M)((0,Sc.b)(iP,aP,lP),c);w<f&&(f=w,(0,Vu.r)(oP,$O),(0,Vu.r)(sP,eP),p=m/3)}}var T=n.rayBegin,C=n.rayEnd;if(f<h*h){var S=Number.MAX_VALUE;if((0,Sc.c)((0,Sc.b)(oP,sP,lP),(0,Sc.b)(T,C,uP),rP)){(0,Vu.e)(rP,rP,T);var O=(0,Vu.s)(rP);(0,Vu.g)(rP,rP,1/O),S=O/(0,Vu.x)(T,C)}i(S,rP,p,!1)}}else Eu.a.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix")}},{key:"computeAttachmentOrigin",value:function(e,t){var r=e.vertexAttributes;if(!r)return!1;var n=e.indices,i=r.get(fc.O.POSITION);return(0,dc.aF)(i,n?n.get(fc.O.POSITION):null,n&&QO(this.parameters,r,n),t)}},{key:"createLayout",value:function(){var e=(0,wc.T)().vec3f(fc.O.POSITION).f32(fc.O.SUBDIVISIONFACTOR).vec2f(fc.O.UV0).vec3f(fc.O.AUXPOS1).vec3f(fc.O.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(fc.O.SIZEFEATUREATTRIBUTE):e.f32(fc.O.SIZE),this.parameters.vvColorEnabled?e.f32(fc.O.COLORFEATUREATTRIBUTE):e.vec4f(fc.O.COLOR),this.parameters.vvOpacityEnabled&&e.f32(fc.O.OPACITYFEATUREATTRIBUTE),(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(fc.O.OBJECTANDLAYERIDCOLOR),e}},{key:"createBufferWriter",value:function(){return new XO(this._layout,this.parameters)}},{key:"requiresSlot",value:function(e,t){return(t===dc.O.Color||t===dc.O.Alpha||t===dc.O.Highlight||t===dc.O.Depth||t===dc.O.ObjectAndLayerIdColor)&&(e===dc.H.DRAPED_MATERIAL||(this.parameters.renderOccluded===dc.ah.OccludeAndTransparentStencil?e===dc.H.OPAQUE_MATERIAL||e===dc.H.OCCLUDER_MATERIAL||e===dc.H.TRANSPARENT_OCCLUDER_MATERIAL:t===dc.O.Color||t===dc.O.Alpha?e===(this.parameters.writeDepth?dc.H.TRANSPARENT_MATERIAL:dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===dc.H.OPAQUE_MATERIAL))}},{key:"createGLMaterial",value:function(e){return new qO(e)}},{key:"validateParameters",value:function(e){"miter"!==e.join&&(e.miterLimit=0),(0,Nu.r)(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)}}]),r}(dc.aa),qO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._stipplePattern=null,e}return(0,ku.Z)(r,[{key:"dispose",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"dispose",this).call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){this._output!==dc.O.Color&&this._output!==dc.O.Alpha||this._updateOccludeeState(e);var t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(BO,e)}}]),r}(dc.aq),WO=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).width=0,e.color=lc._,e.join="miter",e.cap=DO.BUTT,e.miterLimit=5,e.writeDepth=!0,e.hasPolygonOffset=!1,e.stippleTexture=null,e.stippleScaleWithLineWidth=!1,e.stipplePreferContinuous=!0,e.markerParameters=null,e.markerScale=1,e.hasSlicePlane=!1,e.vvFastUpdate=!1,e.isClosed=!1,e.falloff=0,e.innerWidth=0,e.hasOccludees=!1,e.wireframe=!1,e}return(0,ku.Z)(r)}(dc.aG),XO=function(){function e(t,r){(0,Au.Z)(this,e),this._parameters=r,this.numJoinSubdivisions=0,this.vertexBufferLayout=t;var n=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=n;break;case"round":this.numJoinSubdivisions=FO+n}}return(0,ku.Z)(e,[{key:"_isClosed",value:function(e){return QO(this._parameters,e.vertexAttributes,e.indices)}},{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){var t=e.indices.get(fc.O.POSITION).length/2+1,r=this._isClosed(e),n=r?2:4;return n+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}},{key:"write",value:function(e,t,r,n,i){var a,o=this,s=cP,l=hP,u=dP,c=r.vertexAttributes.get(fc.O.POSITION).data,h=r.indices&&r.indices.get(fc.O.POSITION),d=null===(a=r.vertexAttributes.get(fc.O.DISTANCETOSTART))||void 0===a?void 0:a.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var f=1,p=0;this._parameters.vvSizeEnabled?p=r.vertexAttributes.get(fc.O.SIZEFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(fc.O.SIZE)&&(f=r.vertexAttributes.get(fc.O.SIZE).data[0]);var v=[1,1,1,1],m=0;this._parameters.vvColorEnabled?m=r.vertexAttributes.get(fc.O.COLORFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(fc.O.COLOR)&&(v=r.vertexAttributes.get(fc.O.COLOR).data);var y=null;(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&(y=r.objectAndLayerIdColor);var g=0;this._parameters.vvOpacityEnabled&&(g=r.vertexAttributes.get(fc.O.OPACITYFEATUREATTRIBUTE).data[0]);var _=c.length/3,b=new Float32Array(n.buffer),x=(0,Nu.h)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(n.buffer):null,w=this.vertexBufferLayout.stride/4,T=i*w,C=T,S=0,O=d?function(e,t,r){return S=d[r]}:function(e,t,r){return S+=(0,Vu.x)(e,t)},P=function(e,t,r,n,i,a,s){if(b[T++]=t[0],b[T++]=t[1],b[T++]=t[2],b[T++]=n,b[T++]=s,b[T++]=i,b[T++]=e[0],b[T++]=e[1],b[T++]=e[2],b[T++]=r[0],b[T++]=r[1],b[T++]=r[2],o._parameters.vvSizeEnabled?b[T++]=p:b[T++]=f,o._parameters.vvColorEnabled)b[T++]=m;else{var l=Math.min(4*a,v.length-4);b[T++]=v[l+0],b[T++]=v[l+1],b[T++]=v[l+2],b[T++]=v[l+3]}o._parameters.vvOpacityEnabled&&(b[T++]=g),(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&((0,Nu.r)(y)&&(x[4*T+0]=y[0],x[4*T+1]=y[1],x[4*T+2]=y[2],x[4*T+3]=y[3]),T++)};T+=w,(0,Vu.o)(l,c[0],c[1],c[2]),e&&(0,Vu.O)(l,l,e);var R=this._isClosed(r);if(R){var A=c.length-3;(0,Vu.o)(s,c[A],c[A+1],c[A+2]),e&&(0,Vu.O)(s,s,e)}else(0,Vu.o)(u,c[3],c[4],c[5]),e&&(0,Vu.O)(u,u,e),P(l,l,u,1,GO.LEFT_CAP_START,0,0),P(l,l,u,1,GO.RIGHT_CAP_START,0,0),(0,Vu.r)(s,l),(0,Vu.r)(l,u);for(var k=R?0:1,E=R?_:_-1,D=k;D<E;D++){var M=(D+1)%_*3;(0,Vu.o)(u,c[M+0],c[M+1],c[M+2]),e&&(0,Vu.O)(u,u,e),O(s,l,D),P(s,l,u,0,GO.LEFT_JOIN_END,D,S),P(s,l,u,0,GO.RIGHT_JOIN_END,D,S);for(var I=this.numJoinSubdivisions,L=0;L<I;++L){var Z=(L+1)/(I+1);P(s,l,u,Z,GO.LEFT_JOIN_END,D,S),P(s,l,u,Z,GO.RIGHT_JOIN_END,D,S)}P(s,l,u,1,GO.LEFT_JOIN_START,D,S),P(s,l,u,1,GO.RIGHT_JOIN_START,D,S),(0,Vu.r)(s,l),(0,Vu.r)(l,u)}R?((0,Vu.o)(u,c[3],c[4],c[5]),e&&(0,Vu.O)(u,u,e),S=O(s,l,E),P(s,l,u,0,GO.LEFT_JOIN_END,k,S),P(s,l,u,0,GO.RIGHT_JOIN_END,k,S)):(S=O(s,l,E),P(s,l,l,0,GO.LEFT_CAP_END,E,S),P(s,l,l,0,GO.RIGHT_CAP_END,E,S)),YO(b,C+w,b,C,w),T=YO(b,T-w,b,T,w),this._parameters.wireframe&&this._addWireframeVertices(n,C,T,w)}},{key:"_addWireframeVertices",value:function(e,t,r,n){for(var i=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t),o=0,s=function(e){return o=YO(a,e,i,o,n)},l=0;l<a.length-1;l+=2*n)s(l),s(l+2*n),s(l+1*n),s(l+2*n),s(l+1*n),s(l+3*n)}}]),e}();function YO(e,t,r,n,i){for(var a=0;a<i;a++)r[n++]=e[t++];return n}function QO(e,t,r){return KO(e,t.get(fc.O.POSITION).data,r?r.get(fc.O.POSITION):null)}function KO(e,t,r){return!!e.isClosed&&(r?r.length>2:t.length>6)}var JO,$O=(0,Vu.n)(),eP=(0,Vu.n)(),tP=(0,Vu.n)(),rP=(0,Vu.n)(),nP=(0,Vu.n)(),iP=(0,zu.x)(),aP=(0,zu.x)(),oP=(0,Vu.n)(),sP=(0,Vu.n)(),lP=(0,Sc.v)(),uP=(0,Sc.v)(),cP=(0,Vu.n)(),hP=(0,Vu.n)(),dP=(0,Vu.n)(),fP=[(0,zu.x)(),(0,zu.x)(),(0,zu.x)(),(0,zu.x)()],pP=[(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)()],vP=(0,Tc.p)(),mP=(0,Tc.p)(),yP=(0,Tc.p)(),gP=(0,Tc.p)(),_P=function(){function e(t){(0,Au.Z)(this,e),this._originSR=t,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+(0,Eu.a4)()}return(0,ku.Z)(e,[{key:"getOrigin",value:function(e){var t=this._origins.get(this._rootOriginId);if(null==t){var r=yO;if((0,Nu.r)(r))return this._origins.set(this._rootOriginId,$S(r[0],r[1],r[2],this._rootOriginId)),this.getOrigin(e);var n=$S(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,n),n}var i=this._gridSize,a=Math.round(e[0]/i),o=Math.round(e[1]/i),s=Math.round(e[2]/i),l="".concat(a,"/").concat(o,"/").concat(s),u=this._origins.get(l),c=.5*i;if((0,Vu.e)(bP,e,t.vec3),bP[0]=Math.abs(bP[0]),bP[1]=Math.abs(bP[1]),bP[2]=Math.abs(bP[2]),bP[0]<c&&bP[1]<c&&bP[2]<c){if(u){var h=Math.max.apply(Math,(0,mu.Z)(bP));if((0,Vu.e)(bP,e,u.vec3),bP[0]=Math.abs(bP[0]),bP[1]=Math.abs(bP[1]),bP[2]=Math.abs(bP[2]),Math.max.apply(Math,(0,mu.Z)(bP))<h)return u}return t}return u||(u=$S(a*i,o*i,s*i,l),this._origins.set(l,u)),u}},{key:"_drawOriginBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,lc.r)(1,1,0,1),r=window.view,n=r._stage,i=t.toString();if(!this._objects.has(i)){this._material=new jO({width:2,color:t}),n.add(this._material);var a=new _O({isPickable:!1}),o=new tS({castShadow:!1});n.add(o),a.add(o),n.add(a),this._objects.set(i,o)}for(var s=this._objects.get(i),l=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],u=l.length,c=new Array(3*u),h=new Array,d=.5*this._gridSize,f=0;f<u;f++)c[3*f+0]=e[0]+(1&l[f]?d:-d),c[3*f+1]=e[1]+(2&l[f]?d:-d),c[3*f+2]=e[2]+(4&l[f]?d:-d),f>0&&h.push(f-1,f);(0,Hu.x)(c,this._originSR,0,c,r.renderSpatialReference,0,u);var p=new dc.M([[fc.O.POSITION,{size:3,data:c,exclusive:!0}]],[[fc.O.POSITION,h]],vc.a.Line);n.add(p),s.addGeometry(p,this._material,hc.o)}},{key:"test",get:function(){var e=this;return{set gridSize(t){e._gridSize=t}}}}]),e}(),bP=(0,Vu.n)(),xP=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,Au.Z)(this,e),this.rctx=t,this.sliceHelper=i,this.lastFrameCamera=new Jy,this.output=dc.O.Color,this.renderOccludedMask=TP,this.bindParameters=new Df(r,n,(0,Nu.r)(i)?i.plane:null)}return(0,ku.Z)(e,[{key:"resetRenderOccludedMask",value:function(){this.renderOccludedMask=TP}}]),e}(),wP=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o){var s;return(0,Au.Z)(this,r),(s=t.call(this,e,i,a,o)).offscreenRenderingHelper=n,s.sliceHelper=o,s}return(0,ku.Z)(r)}(xP),TP=dc.ah.Occlude|dc.ah.OccludeAndTransparent|dc.ah.OccludeAndTransparentStencil;!function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}(JO||(JO={}));for(var CP=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.camera=new Jy,this.lightMat=(0,hc.e)()})),SP=function(){function e(t,r){(0,Au.Z)(this,e),this._rctx=t,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._splitSchemeLambda=0,this._warp=!0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,lc.n)(),this._cascades=[new CP,new CP,new CP,new CP],this._maxTextureSize=Math.min((0,Nu.h)("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}return(0,ku.Z)(e,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return(0,Vu.C)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}},{key:"dispose",value:function(){this._discardDepthTexture(),this._discardAllSnapshots()}},{key:"maxCascades",get:function(){return this._maxNumCascades},set:function(e){this._maxNumCascades=(0,Vu.a)(Math.floor(e),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&(0,Nu.r)(this._depthTexture)}},{key:"getSnapshot",value:function(e){return this.enabled?this._snapshots[e]:null}},{key:"getCascades",value:function(){for(var e=0;e<this._numCascades;++e)VP[e]=this._cascades[e];return VP.length=this._numCascades,VP}},{key:"start",value:function(e,t,r){(0,Sc.e)(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();var n=this._clampNearFar(r),i=n.near,a=n.far;this._computeCascadeDistances(a,i),this._setupMatrices(e,t);for(var o=e.viewMatrix,s=e.projectionMatrix,l=0;l<this._numCascades;++l)this._constructCascade(l,s,o,t);this._lastOrigin=null,this.clear()}},{key:"finish",value:function(e){(0,Sc.e)(this.enabled),this._rctx.bindFramebuffer(e)}},{key:"getShadowMapMatrices",value:function(e){if(!this._lastOrigin||!(0,Vu.F)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,Vu.n)(),(0,Vu.r)(this._lastOrigin,e);for(var t=0;t<this._numCascades;++t){(0,Wu.c)(BP,this._cascades[t].lightMat,e);for(var r=0;r<16;++r)GP[16*t+r]=BP[r]}}return GP}},{key:"takeCascadeSnapshotTo",value:function(e,t){(0,Sc.e)(this.enabled);var r=this._ensureSnapshot(t);this._bindFbo();var n=this._rctx,i=n.bindTexture(r,Oc.E.TEXTURE_UNIT_FOR_UPDATES);n.gl.copyTexSubImage2D(pc.M.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),n.bindTexture(i,Oc.E.TEXTURE_UNIT_FOR_UPDATES)}},{key:"clear",value:function(){var e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(pc._.COLOR_BUFFER_BIT|pc._.DEPTH_BUFFER_BIT)}},{key:"_computeTextureSize",value:function(e,t){var r=.5*Math.log(e*e+t*t)*Math.LOG2E,n=Math.pow(2,Math.round(r+.35));return Math.min(this._maxTextureSize,2*n)}},{key:"_ensureDepthTexture",value:function(){if(!(0,Nu.r)(this._depthTexture)||this._depthTexture.descriptor.width!==this._textureSize){this._discardDepthTexture();var e={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new Oc.E(this._rctx,e),this._fbo=new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}}},{key:"_ensureSnapshot",value:function(e){var t=this._snapshots[e];if((0,Nu.r)(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);var r={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new Oc.E(this._rctx,r),this._snapshots[e]=t,t}},{key:"_discardDepthTexture",value:function(){this._fbo=(0,Nu.G)(this._fbo),this._depthTexture=(0,Nu.G)(this._depthTexture)}},{key:"_discardSnapshot",value:function(e){this._snapshots[e]=(0,Nu.G)(this._snapshots[e])}},{key:"_discardAllSnapshots",value:function(){for(var e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}},{key:"_bindFbo",value:function(){var e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}},{key:"_constructCascade",value:function(e,t,r,n){var i=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],s=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),l=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);(0,Sc.e)(s<l);for(var u=0;u<8;++u){(0,Vu.C)(AP,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?s:l,1),(0,Vu.w)(kP[u],AP,RP);for(var c=0;c<3;++c)kP[u][c]/=kP[u][3]}(0,Vu.q)(UP,kP[0]),(0,Wu.c)(OP,zP,UP),i.camera.viewMatrix=OP;for(var h=0;h<8;++h)(0,Vu.O)(kP[h],kP[h],i.camera.viewMatrix);(0,Vu.r)(DP,kP[0]),(0,Vu.r)(MP,kP[0]);for(var d=1;d<8;++d)for(var f=0;f<3;++f)DP[f]=Math.min(DP[f],kP[d][f]),MP[f]=Math.max(MP[f],kP[d][f]);DP[2]-=200,MP[2]+=200,i.camera.near=-MP[2],i.camera.far=-DP[2],this._warp?this._constructTrapezoidalProjection(r,n,i):this._constructOrthogonalProjection(i),(0,Wu.u)(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);var p=this._textureSize/2;i.camera.viewport[0]=e%2==0?0:p,i.camera.viewport[1]=0===Math.floor(e/2)?0:p,i.camera.viewport[2]=p,i.camera.viewport[3]=p}},{key:"_constructOrthogonalProjection",value:function(e){(0,Wu.F)(e.camera.projectionMatrix,DP[0],MP[0],DP[1],MP[1],e.camera.near,e.camera.far)}},{key:"_constructTrapezoidalProjection",value:function(e,t,r){var n=1/kP[0][3],i=1/kP[4][3];(0,Sc.e)(n<i);var a=n+Math.sqrt(n*i),o=Math.sin((0,Vu.i)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));(function(e,t,r,n,i,a,o,s){(0,uc.r)(HP,0,0);for(var l=0;l<4;++l)(0,uc.s)(HP,HP,e[l]);(0,uc.l)(HP,HP,.25),(0,uc.r)(jP,0,0);for(var u=4;u<8;++u)(0,uc.s)(jP,jP,e[u]);(0,uc.l)(jP,jP,.25),(0,uc.A)(qP[0],e[4],e[5],.5),(0,uc.A)(qP[1],e[5],e[6],.5),(0,uc.A)(qP[2],e[6],e[7],.5),(0,uc.A)(qP[3],e[7],e[4],.5);for(var c=0,h=(0,uc.b)(qP[0],HP),d=1;d<4;++d){var f=(0,uc.b)(qP[d],HP);f<h&&(h=f,c=d)}(0,uc.o)(WP,qP[c],e[c+4]);var p,v,m=WP[0];WP[0]=-WP[1],WP[1]=m,(0,uc.o)(XP,jP,HP),(0,uc.j)(XP,WP)<0&&(0,uc.g)(WP,WP),(0,uc.A)(WP,WP,XP,r),(0,uc.v)(WP,WP),p=v=(0,uc.j)((0,uc.o)(YP,e[0],HP),WP);for(var y=1;y<8;++y){var g=(0,uc.j)((0,uc.o)(YP,e[y],HP),WP);g<p?p=g:g>v&&(v=g)}(0,uc.a)(n,HP),(0,uc.l)(YP,WP,p-t),(0,uc.s)(n,n,YP);for(var _=-1,b=1,x=0,w=0,T=0;T<8;++T){(0,uc.o)(QP,e[T],n),(0,uc.v)(QP,QP);var C=WP[0]*QP[1]-WP[1]*QP[0];C>0?C>_&&(_=C,x=T):C<b&&(b=C,w=T)}(0,Sc.s)(_>0,"leftArea"),(0,Sc.s)(b<0,"rightArea"),(0,uc.l)(KP,WP,p),(0,uc.s)(KP,KP,HP),(0,uc.l)(JP,WP,v),(0,uc.s)(JP,JP,HP),$P[0]=-WP[1],$P[1]=WP[0];var S=(0,Sc.u)(n,e[w],JP,(0,uc.s)(YP,JP,$P),1,i),O=(0,Sc.u)(n,e[x],JP,YP,1,a),P=(0,Sc.u)(n,e[x],KP,(0,uc.s)(YP,KP,$P),1,o),R=(0,Sc.u)(n,e[w],KP,YP,1,s);(0,Sc.s)(S,"rayRay"),(0,Sc.s)(O,"rayRay"),(0,Sc.s)(P,"rayRay"),(0,Sc.s)(R,"rayRay")})(kP,a/=o,o,IP,LP,ZP,NP,FP),function(e,t,r,n,i){(0,uc.o)(nR,r,n),(0,uc.l)(nR,nR,.5),iR[0]=nR[0],iR[1]=nR[1],iR[2]=0,iR[3]=nR[1],iR[4]=-nR[0],iR[5]=0,iR[6]=nR[0]*nR[0]+nR[1]*nR[1],iR[7]=nR[0]*nR[1]-nR[1]*nR[0],iR[8]=1,iR[eR(0,2)]=-(0,uc.j)(rR(iR,0),e),iR[eR(1,2)]=-(0,uc.j)(rR(iR,1),e);var a=(0,uc.j)(rR(iR,0),r)+iR[eR(0,2)],o=(0,uc.j)(rR(iR,1),r)+iR[eR(1,2)],s=(0,uc.j)(rR(iR,0),n)+iR[eR(0,2)],l=(0,uc.j)(rR(iR,1),n)+iR[eR(1,2)];a=-(a+s)/(o+l),iR[eR(0,0)]+=iR[eR(1,0)]*a,iR[eR(0,1)]+=iR[eR(1,1)]*a,iR[eR(0,2)]+=iR[eR(1,2)]*a,a=1/((0,uc.j)(rR(iR,0),r)+iR[eR(0,2)]),o=1/((0,uc.j)(rR(iR,1),r)+iR[eR(1,2)]),iR[eR(0,0)]*=a,iR[eR(0,1)]*=a,iR[eR(0,2)]*=a,iR[eR(1,0)]*=o,iR[eR(1,1)]*=o,iR[eR(1,2)]*=o,iR[eR(2,0)]=iR[eR(1,0)],iR[eR(2,1)]=iR[eR(1,1)],iR[eR(2,2)]=iR[eR(1,2)],iR[eR(1,2)]+=1,a=(0,uc.j)(rR(iR,1),t)+iR[eR(1,2)],o=(0,uc.j)(rR(iR,2),t)+iR[eR(2,2)],s=(0,uc.j)(rR(iR,1),r)+iR[eR(1,2)],l=(0,uc.j)(rR(iR,2),r)+iR[eR(2,2)],a=-.5*(a/o+s/l),iR[eR(1,0)]+=iR[eR(2,0)]*a,iR[eR(1,1)]+=iR[eR(2,1)]*a,iR[eR(1,2)]+=iR[eR(2,2)]*a,a=(0,uc.j)(rR(iR,1),t)+iR[eR(1,2)],o=(0,uc.j)(rR(iR,2),t)+iR[eR(2,2)],s=-o/a,iR[eR(1,0)]*=s,iR[eR(1,1)]*=s,iR[eR(1,2)]*=s,i[0]=iR[0],i[1]=iR[1],i[2]=0,i[3]=iR[2],i[4]=iR[3],i[5]=iR[4],i[6]=0,i[7]=iR[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=iR[6],i[13]=iR[7],i[14]=0,i[15]=iR[8]}(IP,LP,NP,FP,r.camera.projectionMatrix),r.camera.projectionMatrix[10]=2/(DP[2]-MP[2]),r.camera.projectionMatrix[14]=-(DP[2]+MP[2])/(DP[2]-MP[2])}},{key:"_setupMatrices",value:function(e,t){(0,Wu.u)(PP,e.projectionMatrix,e.viewMatrix),(0,Wu.h)(RP,PP);var r=this._viewingMode===ic.l.Global?e.eye:(0,Vu.o)(UP,0,0,1);(0,Wu.Q)(zP,[0,0,0],[-t[0],-t[1],-t[2]],r)}},{key:"_clampNearFar",value:function(e){var t=e.near,r=e.far;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}},{key:"_computeCascadeDistances",value:function(e,t){this._numCascades=Math.min(1+Math.floor((0,Sc.f)(e/t,4)),this._maxNumCascades);for(var r=(e-t)/this._numCascades,n=Math.pow(e/t,1/this._numCascades),i=t,a=t,o=0;o<this._numCascades+1;++o)this._cascadeDistances[o]=(0,Vu.Z)(i,a,this._splitSchemeLambda),i*=n,a+=r}},{key:"gpuMemoryUsage",get:function(){var e,t;return this._snapshots.reduce((function(e,t){return e+(0,_c.u)(t)}),null!==(e=null===(t=this._fbo)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0)}},{key:"test",get:function(){var e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e._splitSchemeLambda=t},get splitSchemeLambda(){return e._splitSchemeLambda},set warp(t){e._warp=t},get warp(){return e._warp}}}}]),e}(),OP=(0,hc.e)(),PP=(0,hc.e)(),RP=(0,hc.e)(),AP=(0,lc.n)(),kP=[],EP=0;EP<8;++EP)kP.push((0,lc.n)());var DP=(0,Vu.n)(),MP=(0,Vu.n)(),IP=(0,cc.n)(),LP=(0,cc.n)(),ZP=(0,cc.n)(),NP=(0,cc.n)(),FP=(0,cc.n)(),zP=(0,hc.e)(),UP=(0,Vu.n)(),VP=[],BP=(0,hc.e)(),GP=new Float32Array(64),HP=(0,cc.n)(),jP=(0,cc.n)(),qP=[(0,cc.n)(),(0,cc.n)(),(0,cc.n)(),(0,cc.n)()],WP=(0,cc.n)(),XP=(0,cc.n)(),YP=(0,cc.n)(),QP=(0,cc.n)(),KP=(0,cc.n)(),JP=(0,cc.n)(),$P=(0,cc.n)();function eR(e,t){return 3*t+e}var tR=(0,cc.n)();function rR(e,t){return(0,uc.r)(tR,e[t],e[t+3]),tR}var nR=(0,cc.n)(),iR=(0,gc.e)();var aR,oR,sR=function(){function e(){(0,Au.Z)(this,e),this.adds=new Eu.a6,this.removes=new Eu.a6,this.updates=new Eu.a6({allocator:function(e){return e||new lR},deallocator:function(e){return e.renderGeometry=null,e}})}return(0,ku.Z)(e,[{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.updates.clear()}},{key:"prune",value:function(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}]),e}(),lR=(0,ku.Z)((function e(){(0,Au.Z)(this,e)})),uR=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.adds=new Array,this.removes=new Array,this.updates=new Array}));function cR(e){var t=new Map,r=function(e){var r=t.get(e);return r||(r=new uR,t.set(e,r)),r};return e.removes.forAll((function(e){hR(e)&&r(e.material).removes.push(e)})),e.adds.forAll((function(e){hR(e)&&r(e.material).adds.push(e)})),e.updates.forAll((function(e){hR(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}function hR(e){return e.data.indexCount>=1}!function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(aR||(aR={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITIES=1]="VISIBILITIES",e[e.VERTEXATTRS=2]="VERTEXATTRS",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHTS=8]="HIGHLIGHTS",e[e.OCCLUDEES=16]="OCCLUDEES"}(oR||(oR={}));var dR=function(){function e(t,r){(0,Au.Z)(this,e),this._material=t,this._repository=r,this._map=new Map}return(0,ku.Z)(e,[{key:"destroy",value:function(){var e=this;this._map.forEach((function(t,r){(0,Nu.r)(t)&&e._repository.release(e._material,r)}))}},{key:"load",value:function(e,t,r){if(!this._material.requiresSlot(t,r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));var n=this._map.get(r);if((0,Nu.r)(n)){if(n.ensureResources(e)===vc.O.LOADED)return n;this._repository.requestRender()}return null}}]),e}(),fR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Vu.n)();return(0,Au.Z)(this,r),(e=t.call(this)).origin=n,e.slicePlaneLocalOrigin=e.origin,e}return(0,ku.Z)(r)}(dc.aH);function pR(e){e.fragment.code.add((0,dc.n)(xr||(xr=(0,wu.Z)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function vR(e){e.fragment.code.add((0,dc.n)(wr||(wr=(0,wu.Z)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}function mR(e){e.fragment.uniforms.add(new dc.h("texWaveNormal",(function(e){return e.waveNormal}))),e.fragment.uniforms.add(new dc.h("texWavePerturbation",(function(e){return e.wavePertubation}))),e.fragment.uniforms.add([new dc.f("waveParams",(function(e){return(0,Vu.C)(yR,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)})),new dc.b("waveDirection",(function(e){return(0,uc.r)(gR,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)}))]),e.include(pR),e.fragment.code.add((0,dc.n)(Tr||(Tr=(0,wu.Z)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture2D(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}var yR=(0,lc.n)(),gR=(0,cc.n)();function _R(e,t){t.spherical?e.vertex.code.add((0,dc.n)(Cr||(Cr=(0,wu.Z)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):e.vertex.code.add((0,dc.n)(Sr||(Sr=(0,wu.Z)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),t.spherical?e.vertex.code.add((0,dc.n)(Or||(Or=(0,wu.Z)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):e.vertex.code.add((0,dc.n)(Pr||(Pr=(0,wu.Z)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}function bR(e,t){e.include(dc.aI,t),e.include(Ed),e.include(vR),t.hasCloudsReflections&&e.include(Kd,t),t.hasScreenSpaceReflections&&e.include(kf,t);var r=e.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add((0,dc.n)(Rr||(Rr=(0,wu.Z)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),r.uniforms.add([new dc.g("lightingSpecularStrength",(function(e,t){return t.lighting.mainLight.specularStrength})),new dc.g("lightingEnvironmentStrength",(function(e,t){return t.lighting.mainLight.environmentStrength}))]),r.code.add((0,dc.n)(Ar||(Ar=(0,wu.Z)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {\nfloat reflectionHit = 0.0;\nfloat reflectionHitDiffused = 0.0;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nspecular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}\nfloat correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);\nvec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);\nvec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));"])))),t.hasCloudsReflections&&r.code.add((0,dc.n)(kr||(kr=(0,wu.Z)(["vec4 cloudsColor = renderClouds(reflectedWorld, position);\ncloudsColor.a = 1.0 - cloudsColor.a;\ncloudsColor = pow(cloudsColor, vec4(GAMMA));\ncloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);"])))),t.hasScreenSpaceReflections?(r.uniforms.add(new dc.e("view",(function(e,t){return t.ssr.camera.viewMatrix}))),r.uniforms.add(new dc.h("lastFrameColorMap",(function(e,t){return t.ssr.lastFrameColorTexture}))),r.code.add((0,dc.n)(Er||(Er=(0,wu.Z)(["vec3 viewDir = normalize(viewPosition);\nvec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = view * vec4(localUp, 0.0);\nvec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));\nvec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);\nreflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\nreflectionHitDiffused = waterDiffusion * reflectionHit;\nreflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;\n}\nfloat seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);\nvec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);"]))))):r.code.add((0,dc.n)(Dr||(Dr=(0,wu.Z)(["vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);"])))),t.hasCloudsReflections?t.hasScreenSpaceReflections?r.code.add((0,dc.n)(Mr||(Mr=(0,wu.Z)(["return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;\n}"])))):r.code.add((0,dc.n)(Ir||(Ir=(0,wu.Z)(["return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;\n}"])))):r.code.add((0,dc.n)(Lr||(Lr=(0,wu.Z)(["return waterRenderedColor;\n}"]))))}function xR(e){var t=new dc.o,r=t.vertex,n=t.fragment;(0,dc.T)(r,e),t.include(dc.K,e),t.attributes.add(fc.O.POSITION,"vec3"),t.attributes.add(fc.O.UV0,"vec2");var i=new dc.f("waterColor",(function(e){return e.color}));if(e.output===dc.O.Color&&e.isDraped)return t.varyings.add("vpos","vec3"),r.uniforms.add(i),r.code.add((0,dc.n)(Zr||(Zr=(0,wu.Z)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),dc.n.float(dc.a7))),n.uniforms.add(i),n.code.add((0,dc.n)(Nr||(Nr=(0,wu.Z)(["void main() {\ngl_FragColor = waterColor;\n}"])))),t;switch(e.output!==dc.O.Color&&e.output!==dc.O.Alpha||(t.include(_R,e),t.include(dc.aJ,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.uniforms.add(i),r.code.add((0,dc.n)(Fr||(Fr=(0,wu.Z)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),dc.n.float(dc.a7),e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":"",e.output===dc.O.Color?"forwardLinearDepth();":""))),t.include(dc.aw,e),e.output){case dc.O.Alpha:t.include(dc.a0,e),n.uniforms.add(i),n.code.add((0,dc.n)(zr||(zr=(0,wu.Z)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""));break;case dc.O.Color:t.include(dc.D,e),t.include(dc.z,{pbrMode:dc.B.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(mR),t.include(dc.a0,e),t.include(dc.aK,e),t.include(bR,e),n.uniforms.add([i,new dc.g("timeElapsed",(function(e){return e.timeElapsed})),r.uniforms.get("view"),r.uniforms.get("localOrigin")]),(0,dc.U)(n,e),n.include(dc.x),(0,dc.i)(n),(0,dc.w)(n),n.code.add((0,dc.n)(Ur||(Ur=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - cameraPosition);\n        float shadow = ",";\n        vec4 vPosView = view * vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?(0,dc.n)(Vr||(Vr=(0,wu.Z)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""));break;case dc.O.Normal:t.include(_R,e),t.include(mR,e),t.include(dc.a0,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),r.uniforms.add(i),r.code.add((0,dc.n)(Br||(Br=(0,wu.Z)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),dc.n.float(dc.a7))),n.uniforms.add(new dc.g("timeElapsed",(function(e){return e.timeElapsed}))),n.code.add((0,dc.n)(Gr||(Gr=(0,wu.Z)(["void main() {\ndiscardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\ngl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n}"]))));break;case dc.O.Highlight:t.include(dc.a9,e),t.varyings.add("vpos","vec3"),r.uniforms.add(i),r.code.add((0,dc.n)(Hr||(Hr=(0,wu.Z)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),dc.n.float(dc.a7))),t.include(dc.a0,e),n.code.add((0,dc.n)(jr||(jr=(0,wu.Z)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))}return t}var wR=Object.freeze(Object.defineProperty({__proto__:null,build:xR},Symbol.toStringTag,{value:"Module"})),TR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2,t.spherical=e.viewingMode===ic.l.Global,t.doublePrecisionRequiresObfuscation=(0,dc.aL)(e.rctx)}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,r=e===vc.o.NONE,n=e===vc.o.FrontFace;return(0,vc.W)({blending:t.output!==dc.O.Normal&&t.output!==dc.O.Highlight&&t.transparent?r?vc.d:(0,vc.A)(e):null,depthTest:{func:(0,vc.e)(e)},depthWrite:r?t.writeDepth&&vc.b:(0,vc.E)(e),colorWrite:vc._,polygonOffset:r||n?null:(0,vc.g)(t.enableOffset)})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}}]),r}(dc.k);TR.shader=new dc.m(wR,(function(){return r.e(9896).then(r.bind(r,24221))}));var CR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.transparencyPassType=vc.o.NONE,e.spherical=!1,e.receiveShadows=!1,e.hasSlicePlane=!1,e.transparent=!1,e.enableOffset=!0,e.writeDepth=!1,e.hasScreenSpaceReflections=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasCloudsReflections=!1,e.isDraped=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],CR.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],CR.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"receiveShadows",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"transparent",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"enableOffset",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"writeDepth",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"hasScreenSpaceReflections",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"hasCloudsReflections",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"isDraped",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],CR.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.B.Water})],CR.prototype,"pbrMode",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],CR.prototype,"useCustomDTRExponentForWater",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],CR.prototype,"highStepCount",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],CR.prototype,"useFillLights",void 0);var SR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_updateShadowState",value:function(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}},{key:"_updateSSRState",value:function(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}},{key:"_updateCloudsReflectionState",value:function(e){var t=(0,Nu.r)(e.cloudsFade.data);t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}},{key:"ensureResources",value:function(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}},{key:"beginSlot",value:function(e){return this._output===dc.O.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(TR,e)}}]),r}(dc.aq),OR=(0,wc.T)().vec3f(fc.O.POSITION),PR=(0,wc.T)().vec3f(fc.O.POSITION).vec2f(fc.O.UV0),RR=(0,wc.T)().vec3f(fc.O.POSITION).vec4u8(fc.O.COLOR);(0,wc.T)().vec3f(fc.O.POSITION).vec4u8(fc.O.OBJECTANDLAYERIDCOLOR),(0,wc.T)().vec3f(fc.O.POSITION).vec2f(fc.O.UV0).vec4u8(fc.O.OBJECTANDLAYERIDCOLOR);var AR=(0,wc.T)().vec3f(fc.O.POSITION).vec4u8(fc.O.COLOR).vec4u8(fc.O.OBJECTANDLAYERIDCOLOR),kR=function(){function e(t){(0,Au.Z)(this,e),this.vertexBufferLayout=t}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(fc.O.POSITION).length}},{key:"write",value:function(e,t,r,n,i){(0,dc.aM)(r,this.vertexBufferLayout,e,t,n,i)}}]),e}(),ER=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new DR))._configuration=new CR,n.animation=new Np,n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<vc.S,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"update",value:function(e){var t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<MR;var r=this.animation.advance(e);return this.setParameters({timeElapsed:(0,Eu.aq)(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&r}},{key:"intersect",value:function(e,t,r,n,i,a,o){(0,dc.aN)(e,t,n,i,a,void 0,o)}},{key:"requiresSlot",value:function(e,t){switch(t){case dc.O.Normal:return e===dc.H.DRAPED_WATER;case dc.O.Color:if(this.parameters.isDraped)return e===dc.H.DRAPED_MATERIAL;break;case dc.O.Alpha:break;case dc.O.Highlight:return e===dc.H.OPAQUE_MATERIAL||e===dc.H.DRAPED_MATERIAL;default:return!1}var r=dc.H.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?dc.H.TRANSPARENT_MATERIAL:dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===r}},{key:"createGLMaterial",value:function(e){return new SR(e)}},{key:"createBufferWriter",value:function(){return new kR(PR)}}]),r}(dc.aa),DR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).waveStrength=.06,e.waveTextureRepeat=32,e.waveDirection=(0,cc.r)(1,0),e.waveVelocity=.05,e.flowStrength=.015,e.flowOffset=-.5,e.animationSpeed=.35,e.timeElapsed=0,e.color=(0,lc.r)(0,0,0,0),e.transparent=!0,e.writeDepth=!0,e.hasSlicePlane=!1,e.isDraped=!1,e.receiveShadows=!0,e.hasScreenSpaceReflections=!1,e.hasCloudsReflections=!1,e}return(0,ku.Z)(r)}(dc.ar),MR=35e3,IR=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.first=0,this.count=0})),LR=(0,ku.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,Au.Z)(this,e),this.from=t,this.to=r})),ZR=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o,s){var l;return(0,Au.Z)(this,r),(l=t.call(this,n,i)).id=e,l.isVisible=a,l.hasHighlights=o,l.hasOccludees=s,l}return(0,ku.Z)(r)}(LR);function NR(e){return Array.from(e.values()).sort(FR)}function FR(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function zR(e,t){var r=e.back();if(null==r){var n=e.pushNew();return n.first=t.from,void(n.count=t.to-t.from)}if(function(e,t){return e.first+e.count>=t.from}(r,t)){var i=t.from-r.first+t.to-t.from;r.count=i}else{var a=e.pushNew();a.first=t.from,a.count=t.to-t.from}}var UR=function(){function e(t,r){(0,Au.Z)(this,e),this._pool=t,this._size=0,this._buffer=t.newBuffer(BR(r))}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}},{key:"release",value:function(){this.erase(0,this._size),this.dispose()}},{key:"buffer",get:function(){return this._buffer}},{key:"size",get:function(){return this._size}},{key:"grow",value:function(e){this._resize(this._size+e,!0).dispose()}},{key:"allocate",value:function(e){return this._resize(e,!1)}},{key:"_resize",value:function(e,t){var r,n=this,i=function(e,t,r){return t<=r?e>=r?e:BR(Math.max(2*e,r)):e<=2*r?e:BR(r)}(this._buffer.length,this._size,e);if(this._buffer.length!==i){var a=this._pool.newBuffer(i);t&&(a.array.set(this._buffer.array.subarray(0,Math.min(this._size,i))),a.vao.vertexBuffers.geometry.setSubData(a.array,0,0,a.array.length)),r=this._buffer,this._buffer=a}var o=this._size;return this._size=e,r?{dispose:function(){r.array.fill(0,0,o),n._pool.deleteBuffer(r)},copy:function(e,t,i){return n._buffer.array.set(r.array.subarray(t,i),e)},hasNewBuffer:!0}:{dispose:function(){},copy:function(e,t,r){e!==t&&n._buffer.array.copyWithin(e,t,r)},hasNewBuffer:!1}}},{key:"erase",value:function(e,t){this._buffer.array.fill(0,e,t)}}]),e}(),VR=65536;function BR(e){return Math.ceil(e/VR)*VR}var GR=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this.vao=new dc.N(t,r,{geometry:n},{geometry:_c.E.createVertex(t,pc.F.STATIC_DRAW)}),this.array=new Float32Array(i),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}return(0,ku.Z)(e,[{key:"dispose",value:function(){this.vao.dispose(!0)}},{key:"length",get:function(){return this.array.length}}]),e}(),HR=nh.s+1,jR=function(){function e(t,r,n){(0,Au.Z)(this,e),this._rctx=t,this._locations=r,this._layout=n,this._cache=t.newCache("MergedRenderer pool ".concat((0,Eu.a4)()),qR)}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._cache.destroy()}},{key:"newBuffer",value:function(e){var t=e.toString(),r=this._cache.pop(t);if((0,Nu.r)(r)){var n=r.pop();return r.length>0&&this._cache.put(t,r,n.array.byteLength*r.length,HR),n}return new GR(this._rctx,this._locations,this._layout,e)}},{key:"deleteBuffer",value:function(e){var t=e.array.byteLength,r=e.array.length.toString(),n=this._cache.pop(r);return(0,Nu.r)(n)?(n.push(e),this._cache.put(r,n,t*n.length,-1)):this._cache.put(r,[e],t,-1),null}}]),e}();function qR(e,t){if(t!==nh.i.ALL){var r=e.pop(),n=e.length*r.array.byteLength;return r.dispose(),n}e.forEach((function(e){return e.dispose()}))}var WR=function(){function e(t,r,n){(0,Au.Z)(this,e),this._rctx=t,this._materialRepository=r,this._material=n,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new Eu.a6,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new dR(this._material,this._materialRepository),this._bufferWriter=n.createBufferWriter(),this._bufferPool=new jR(t,n.vertexAttributeLocations,(0,xc.o)(this._bufferWriter.vertexBufferLayout))}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((function(e){return e.geometry.dispose()})),this._dataByOrigin.clear(),this._bufferPool.dispose()}},{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof ER}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==dc.ah.Occlude}},{key:"modify",value:function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}},{key:"_addAndRemoveGeometries",value:function(e,t){var r=this,n=this._bufferWriter,i=n.vertexBufferLayout.stride/4,a=this._dataByOrigin,o=function(e,t){var r,n=new Map,i=(0,Cu.Z)(e);try{for(i.s();!(r=i.n()).done;){YR(n,r.value,!0)}}catch(s){i.e(s)}finally{i.f()}var a,o=(0,Cu.Z)(t);try{for(o.s();!(a=o.n()).done;){YR(n,a.value,!1)}}catch(s){o.e(s)}finally{o.f()}return n}(e,t);o.forEach((function(e,t){o.delete(t);var s=e.add.reduce((function(e,t){return e+n.elementCount(t.data)}),0),l=a.get(t);if(null==l)(0,Sc.e)(0===e.remove.length),l=new $R(e.origin,new UR(r._bufferPool,s*i)),a.set(t,l);else if(0===e.add.length&&l.instances.size===e.remove.length)return l.geometry.dispose(),void a.delete(t);var u=0;l.instances.forEach((function(e){return u+=e.to-e.from}));var c=e.remove.reduce((function(e,t){return e+n.elementCount(t.data)}),0),h=l.geometry.size,d=(u+s-c)*i,f=tA;if(d>VR&&(d<h/2||h-d>1048576)?r._removeAndRebuild(l,e.remove,i,d,f):e.remove.length>0&&r._remove(l,e.remove,i,f),e.add.length>0){var p=rA;(0,Sc.h)(p,-e.origin[0],-e.origin[1],-e.origin[2]),r._add(l,e.add,i,p,f)}var v=l.geometry.buffer.vao.vertexBuffers.geometry;JR(f),f.forAll((function(e){var t=e.from,r=e.to;if(t<r){var n=l.geometry.buffer.array;v.setSubData(n,t,t,r)}})),f.clear(),l.drawCommandsDirty=!0}))}},{key:"_updateGeometries",value:function(e){var t,r=this._bufferWriter,n=r.vertexBufferLayout.stride/4,i=(0,Cu.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=a.renderGeometry,s=this._dataByOrigin.get(o.origin.id),l=s&&s.instances.get(o.id);if(!l)return;var u=a.updateType;if(u&oR.VISIBILITIES&&(l.isVisible=o.instanceParameters.visible),u&(oR.HIGHLIGHTS|oR.VISIBILITIES)){var c=o.instanceParameters.visible;l.hasHighlights=!!o.instanceParameters.highlights&&c}if(u&oR.OCCLUDEES&&(l.hasOccludees=!!o.instanceParameters.occludees),u&(oR.VERTEXATTRS|oR.TRANSFORMATION)){var h=s.geometry.buffer,d=h.array,f=h.vao;(0,Ic.l)(o,nA,iA),r.write(nA,iA,o.data,r.vertexBufferLayout.createView(d.buffer),l.from),(0,Sc.e)(l.from+r.elementCount(o.data)===l.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(d,l.from*n,l.from*n,l.to*n)}s.drawCommandsDirty=!0}}catch(p){i.e(p)}finally{i.f()}}},{key:"_updateDrawCommands",value:function(){var e=this;this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((function(t){t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,(0,Eu.a9)(t.instances,(function(r){return r.isVisible?(r.hasHighlights&&(e._hasHighlights=!0,t.hasHighlights=!0),r.hasOccludees&&(e._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees}))}));this._dataByOrigin.forEach((function(e){e.drawCommandsDirty&&(function(e){if(e.drawCommandsDefault.clear(),e.drawCommandsHighlight.clear(),e.drawCommandsOccludees.clear(),e.drawCommandsShadowHighlightRest.clear(),0!==e.instances.size){if(!QR(e)){var t=e.drawCommandsDefault.pushNew();return t.first=1/0,t.count=0,e.instances.forEach((function(e){t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first)}var r,n=NR(e.instances),i=(0,Cu.Z)(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.isVisible&&(a.hasOccludees?zR(e.drawCommandsOccludees,a):zR(e.drawCommandsDefault,a),a.hasHighlights?zR(e.drawCommandsHighlight,a):zR(e.drawCommandsShadowHighlightRest,a))}}catch(o){i.e(o)}finally{i.f()}}}(e),e.drawCommandsDirty=!1)}))}},{key:"updateAnimation",value:function(e){return this._material.update(e)}},{key:"requiresSlot",value:function(e,t){return this._material.requiresSlot(e,t)}},{key:"render",value:function(e,t){var r=this;if(!this.requiresSlot(t.slot,e))return!1;var n=e===dc.O.Highlight||e===dc.O.ShadowHighlight;if(n&&!this._hasHighlights)return!1;var i=e===dc.O.ShadowExludeHighlight,a=!(n||i);if(this._dataByOrigin.forEach((function(e){if(!n||e.hasHighlights){var t=(n?e.drawCommandsHighlight:i&&QR(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,o=a&&e.drawCommandsOccludees||null;((null===t||void 0===t?void 0:t.length)||(null===o||void 0===o?void 0:o.length))&&r._renderCommandData.push(new eA(e.origin,e.geometry,t,o))}})),0===this._renderCommandData.length)return!1;var o=this._rctx,s=this._glMaterials.load(o,t.slot,e);if((0,Nu.t)(s))return this._renderCommandData.clear(),!1;var l=s.beginSlot(t),u=o.bindTechnique(l,this._material.parameters,t);return this._renderCommandData.forAll((function(e){u.bindDraw(e,t,r._material.parameters);var n=e.geometry,i=e.renderCommands,a=e.occludeeCommands;l.ensureAttributeLocations(n.buffer.vao),o.bindVAO(n.buffer.vao);var s=l.primitiveType;(0,Nu.r)(i)&&i.length>0&&(l.bindPipelineState(o,t.slot,!1),i.forAll((function(e){return o.drawArrays(s,e.first,e.count)}))),(0,Nu.r)(a)&&a.length>0&&(l.bindPipelineState(o,t.slot,!0),a.forAll((function(e){return o.drawArrays(s,e.first,e.count)})))})),this._renderCommandData.clear(),!0}},{key:"_removeAndRebuild",value:function(e,t,r,n,i){var a,o=(0,Cu.Z)(t);try{for(o.s();!(a=o.n()).done;){var s=a.value;e.instances.delete(s.id)}}catch(y){o.e(y)}finally{o.f()}var l=NR(e.instances);e.instances.clear();var u,c=e.geometry.size,h=e.geometry.allocate(n),d=0,f=(0,Cu.Z)(l);try{for(f.s();!(u=f.n()).done;){var p=u.value,v=p.from*r,m=p.to*r;h.copy(d,v,m),p.from=d/r,d+=m-v,p.to=d/r,e.instances.set(p.id,p)}}catch(y){f.e(y)}finally{f.f()}i.push(new LR(0,h.hasNewBuffer?e.geometry.buffer.array.length:c)),h.dispose(),e.geometry.erase(d,i.back().to),e.holes.clear()}},{key:"_remove",value:function(e,t,r,n){var i,a=(0,Cu.Z)(t);try{for(a.s();!(i=a.n()).done;){var o=i.value.id,s=e.instances.get(o),l=s.from*r,u=s.to*r;e.geometry.erase(l,u),e.holes.push(new LR(s.from,s.to)),e.instances.delete(o),n.push(new LR(l,u))}}catch(c){a.e(c)}finally{a.f()}JR(e.holes)}},{key:"_add",value:function(e,t,r,n,i){if(0!==t.length){var a,o=this._bufferWriter,s=o.vertexBufferLayout.createView(e.geometry.buffer.array.buffer),l=e.holes.length>0,u=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER,h=(0,Cu.Z)(t);try{for(h.s();!(a=h.n()).done;){var d=a.value,f=(0,Nu.r)(d.transformation)?(0,Wu.u)(nA,n,d.transformation):n;(0,Wu.h)(iA,f);var p=(0,Wu.o)(iA,iA),v=o.elementCount(d.data),m=v*r,y=KR(e.holes,v);(0,Nu.t)(y)&&(y=e.geometry.size/r,e.geometry.grow(m),s=o.vertexBufferLayout.createView(e.geometry.buffer.array.buffer)),o.write(f,p,d.data,s,y);var g=d.instanceParameters.visible,_=!!d.instanceParameters.highlights&&g,b=!!d.instanceParameters.occludees,x=new ZR(d.id,y,y+v,g,_,b);(0,Sc.e)(null==e.instances.get(d.id)),e.instances.set(d.id,x),l?i.push(new LR(x.from*r,x.to*r)):(u=Math.min(x.from,u),c=Math.max(x.to,c))}}catch(w){h.e(w)}finally{h.f()}l||i.push(new LR(u*r,c*r))}}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),XR=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.origin=t,this.add=new Array,this.remove=new Array}));function YR(e,t,r){var n=t.origin;if(!(0,Nu.t)(n)){var i=e.get(n.id);null==i&&(i=new XR(n.vec3),e.set(n.id,i)),r?i.add.push(t):i.remove.push(t)}}function QR(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function KR(e,t){var r;if(!e.some((function(e){return!(e.to-e.from<t)&&(r=e,!0)})))return null;var n=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),n}function JR(e){var t=new Map;e.forAll((function(e){return t.set(e.from,e)}));for(var r=!0;r;)r=!1,e.forEach((function(n){var i=t.get(n.to);i&&(n.to=i.to,t.delete(i.from),e.removeUnordered(i),r=!0)}))}var $R=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.origin=t,this.geometry=r,this.instances=new Map,this.holes=new Eu.a6({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1,this.drawCommandsDefault=new Eu.a6({allocator:function(e){return e||new IR},deallocator:function(e){return e}}),this.drawCommandsHighlight=new Eu.a6({allocator:function(e){return e||new IR},deallocator:function(e){return e}}),this.drawCommandsOccludees=new Eu.a6({allocator:function(e){return e||new IR},deallocator:function(e){return e}}),this.drawCommandsShadowHighlightRest=new Eu.a6({allocator:function(e){return e||new IR},deallocator:function(e){return e}})})),eA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e)).geometry=n,o.renderCommands=i,o.occludeeCommands=a,o}return(0,ku.Z)(r)}(fR),tA=new Eu.a6({deallocator:null}),rA=(0,hc.e)(),nA=(0,hc.e)(),iA=(0,hc.e)(),aA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._pending=new oA,n._changes=new sR,n._materialRenderers=new Map,n._sortedMaterialRenderers=new Eu.a6,n._geometries=new Map,n._hasHighlights=!1,n._hasWater=!1,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._changes.prune(),this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}},{key:"updating",get:function(){return!this._pending.empty||this._changes.updates.length>0}},{key:"rctx",get:function(){return this.rendererContext.rctx}},{key:"_materialRepository",get:function(){return this.rendererContext.materialRepository}},{key:"_localOriginFactory",get:function(){return this.rendererContext.localOriginFactory}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return(0,Eu.a9)(this._materialRenderers,(function(e){return e.rendersOccluded}))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}},{key:"commitChanges",value:function(){var e=this;if(!this.updating)return!1;this._processAddsRemoves();var t=cR(this._changes),r=!1,n=!1,i=!1;return t.forEach((function(t,a){var o=e._materialRenderers.get(a);if(!o&&t.adds.length>0&&(o=new WR(e.rctx,e._materialRepository,a),e._materialRenderers.set(a,o),r=!0,n=!0,i=!0),o){var s=n||o.hasHighlights,l=i||o.hasWater;o.modify(t),n=n||s!==o.hasHighlights,i=i||l!==o.hasWater,o.isEmpty&&(e._materialRenderers.delete(a),o.dispose(),r=!0)}})),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),n&&(this._hasHighlights=(0,Eu.a9)(this._materialRenderers,(function(e){return e.hasHighlights}))),i&&(this._hasWater=(0,Eu.a9)(this._materialRenderers,(function(e){return e.hasWater}))),this.notifyChange("updating"),!0}},{key:"addGeometries",value:function(e,t){if(0!==e.length){var r,n=this._validateRenderGeometries(e),i=(0,Cu.Z)(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;this._geometries.set(a.id,a)}}catch(c){i.e(c)}finally{i.f()}var o,s=this._pending.empty,l=(0,Cu.Z)(n);try{for(l.s();!(o=l.n()).done;){var u=o.value;this._pending.adds.add(u)}}catch(c){l.e(c)}finally{l.f()}s&&this.notifyChange("updating"),t===aR.UPDATE&&this._notifyGraphicGeometryChanged(e)}}},{key:"removeGeometries",value:function(e,t){var r,n=this._pending.empty,i=this._pending.adds,a=(0,Cu.Z)(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;i.has(o)?(this._pending.removed.add(o),i.delete(o)):this._pending.removed.has(o)||this._pending.removes.add(o),this._geometries.delete((0,Nu.e)(o.id))}}catch(s){a.e(s)}finally{a.f()}n&&!this._pending.empty&&this.notifyChange("updating"),t===aR.UPDATE&&this._notifyGraphicGeometryChanged(e)}},{key:"modifyGeometries",value:function(e,t){var r,n=0===this._changes.updates.length,i=(0,Cu.Z)(e);try{for(i.s();!(r=i.n()).done;){var a=r.value,o=this._changes.updates.pushNew();o.renderGeometry=this._validateRenderGeometry(a),o.updateType=t}}catch(s){i.e(s)}finally{i.f()}switch(n&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case oR.TRANSFORMATION:case oR.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e);case oR.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e)}}},{key:"updateAnimation",value:function(e){var t=!1;return this._sortedMaterialRenderers.forAll((function(r){var n=r.materialRenderer;return t=n.updateAnimation(e)||t})),t}},{key:"render",value:function(e,t){for(var r=0;r<this._sortedMaterialRenderers.length;r++){var n=this._sortedMaterialRenderers.data[r];n.material.shouldRender(e)&&n.materialRenderer.render(e.output,t)}}},{key:"intersect",value:function(e,t,r,n,i){var a=this;return this._geometries.forEach((function(o){if(!n||n(o)){a._intersectRenderGeometry(o,r,t,0,e,i);var s=a.rendererContext.longitudeCyclical;s&&(o.boundingSphere[0]-o.boundingSphere[3]<s.min&&a._intersectRenderGeometry(o,r,t,s.range,e,i),o.boundingSphere[0]+o.boundingSphere[3]>s.max&&a._intersectRenderGeometry(o,r,t,-s.range,e,i)),i++}})),i}},{key:"_updateSortedMaterialRenderers",value:function(){var e=this;this._sortedMaterialRenderers.clear();var t=0;this._materialRenderers.forEach((function(r,n){n.insertOrder=t++,e._sortedMaterialRenderers.push({material:n,materialRenderer:r})})),this._sortedMaterialRenderers.sort((function(e,t){var r=t.material.renderPriority-e.material.renderPriority;return 0!==r?r:e.material.insertOrder-t.material.insertOrder}))}},{key:"_processAddsRemoves",value:function(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(var e=0;e<this._changes.updates.length;){var t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}},{key:"_intersectRenderGeometry",value:function(e,t,r,n,i,a){if(e.instanceParameters.visible){var o=0;(0,Nu.r)(e.transformation)&&(n+=e.transformation[12],o=e.transformation[13]),sA[0]=r[0]-n,sA[1]=r[1]-o,sA[2]=1,lA[0]=r[0]-n,lA[1]=r[1]-o,lA[2]=0,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,sA,lA,(function(r,n,o){!function(e,t,r,n,i,a,o){var s={layerUid:a,graphicUid:o,triangleNr:t},l=function(t){t.set(qu.M.OVERLAY,s,e.dist,e.normal,e.transformation,r,n)};if((null==i.results.min.drapedLayerOrder||r>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&l(i.results.min),i.options.store!==qu.J.MIN&&(null==i.results.max.drapedLayerOrder||r<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&l(i.results.max),i.options.store===qu.J.ALL){var u=(0,qu.L)(i.ray);l(u),i.results.all.push(u)}}(t,o,e.material.renderPriority,a,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,t)}}},{key:"_notifyGraphicGeometryChanged",value:function(e){if(!(0,Nu.t)(this.drapeSource.notifyGraphicGeometryChanged)){var t,r,n=(0,Cu.Z)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value.graphicUid;(0,Nu.r)(i)&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}}catch(a){n.e(a)}finally{n.f()}}}},{key:"_notifyGraphicVisibilityChanged",value:function(e){if(!(0,Nu.t)(this.drapeSource.notifyGraphicVisibilityChanged)){var t,r,n=(0,Cu.Z)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value.graphicUid;(0,Nu.r)(i)&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}}catch(a){n.e(a)}finally{n.f()}}}},{key:"_validateRenderGeometries",value:function(e){var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._validateRenderGeometry(n)}}catch(i){r.e(i)}finally{r.f()}return e}},{key:"_validateRenderGeometry",value:function(e){return(0,Nu.t)(e.origin)&&(e.origin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],aA.prototype,"drapeSource",void 0),(0,Eu.e)([(0,Eu.y)()],aA.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],aA.prototype,"rctx",null),(0,Eu.e)([(0,Eu.y)()],aA.prototype,"rendererContext",void 0),(0,Eu.e)([(0,Eu.y)()],aA.prototype,"_materialRepository",null),(0,Eu.e)([(0,Eu.y)()],aA.prototype,"_localOriginFactory",null),aA=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],aA);var oA=function(){function e(){(0,Au.Z)(this,e),this.adds=new Set,this.removes=new Set,this.removed=new Set}return(0,ku.Z)(e,[{key:"empty",get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}},{key:"has",value:function(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}},{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}]),e}();var sA=(0,Vu.n)(),lA=(0,Vu.n)(),uA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return this.configuration.hasAlpha?(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._}):(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);uA.shader=new dc.m(dc.aO,(function(){return r.e(7986).then(r.bind(r,17986))}));var cA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).hasAlpha=!1,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)()],cA.prototype,"hasAlpha",void 0);var hA,dA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._overlays=null,n._overlayRenderTarget=null,n._hasHighlights=!1,n._rendersOccluded=!1,n._hasWater=!1,n._handles=new Eu.X,n._renderers=new Map,n._sortedDrapeSourceRenderersDirty=!1,n._sortedRenderers=new Eu.a6,n._passParameters=new dc.aP,n._rctx=null,n._materialRepository=null,n._screenToWorldRatio=1,n._localOriginFactory=null,n.worldToPCSRatio=1,n.events=new ec.n,n.longitudeCyclical=null,n}return(0,ku.Z)(r,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},{key:"initialize",value:function(){var e=this,t=this.view._stage.renderView;this._rctx=t.renderingContext;var r=t.waterTextureRepository;this._stippleTextureRepository=new TO(t.renderingContext),this._shaderTechniqueRepository=new oO({rctx:this._rctx,viewingMode:ic.l.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._renderContext=new xP(this._rctx,new SP(this._rctx,this.view.state.viewingMode),new dc.aQ(this._shaderTechniqueRepository,this._rctx,(function(){}))),this._handles.add([(0,Fu.l)((function(){return r.updating}),(function(){return e.events.emit("content-changed")}),Fu.w),(0,Fu.l)((function(){return e.spatialReference}),(function(t){return e._localOriginFactory=new _P(t)}),Fu.w),(0,Fu.a)((function(){return e.view.allLayerViews}),"after-changes",(function(){return e._sortedDrapeSourceRenderersDirty=!0}))]),this._materialRepository=new pO(t.textureRepository,this._shaderTechniqueRepository,(function(t){(t.renderOccluded&yA)>0!==e._rendersOccluded&&e._updateRendersOccluded(),e.events.emit("content-changed"),e.notifyChange("updating")}),(function(){return e.events.emit("content-changed")})),this._bindParameters.slot=dc.H.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=(0,dc.aR)(this._rctx),this._bindParameters.camera=vA,this._bindParameters.transparencyPassType=vc.o.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new dc.Q((0,Vu.c)(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(bc.I.STAGE,this))}},{key:"dispose",value:function(){this._handles.destroy(),this._renderers.forEach((function(e){return e.destroy()})),this._renderers.clear(),this._debugTextureTechnique=(0,Nu.F)(this._debugTextureTechnique),this._passParameters.texture=(0,Nu.G)(this._passParameters.texture),this._bindParameters.highlightDepthTexture=(0,Nu.G)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=(0,Nu.G)(this._shaderTechniqueRepository),this._temporaryFBO=(0,Nu.G)(this._temporaryFBO),this._quadVAO=(0,Nu.G)(this._quadVAO),this.disposeOverlays()}},{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||(0,Eu.a9)(this._renderers,(function(e){return e.updating}))}},{key:"hasOverlays",get:function(){return(0,Nu.r)(this._overlays)&&(0,Nu.r)(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return(0,Nu.r)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"createGeometryDrapeSourceRenderer",value:function(e){return this.createDrapeSourceRenderer(e,aA)}},{key:"createDrapeSourceRenderer",value:function(e,t,r){var n=this,i=this._renderers.get(e);(0,Nu.r)(i)&&i.destroy();var a=new t((0,Tu.Z)((0,Tu.Z)({},r),{},{rendererContext:this,drapeSource:e}));return this._renderers.set(e,a),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add((0,Fu.l)((function(){return e.fullOpacity}),(function(){return n.events.emit("content-changed")})),e),a}},{key:"removeDrapeSourceRenderer",value:function(e){if(!(0,Nu.t)(e)){var t=this._renderers.get(e);(0,Nu.t)(t)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),t.destroy())}}},{key:"collectUnusedRenderTargetMemory",value:function(e){var t=!1;if((0,Nu.r)(this._overlayRenderTarget)){var r,n=(0,Cu.Z)(this._overlayRenderTarget.renderTargets);try{for(n.s();!(r=n.n()).done;){var i=r.value,a=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(a,i,e)||t}}catch(o){n.e(o)}finally{n.f()}}return t}},{key:"overlays",get:function(){return(0,Nu.v)(this._overlays,[])}},{key:"ensureDrapeTargets",value:function(e){(0,Nu.r)(this._overlays)&&this._overlays.forEach((function(t){return t.hasTargetWithoutRasterImage=(0,Eu.at)(e,(function(e){return e.drapeTargetType===BS.WithoutRasterImage}))}))}},{key:"ensureDrapeSources",value:function(e){(0,Nu.r)(this._overlays)&&this._overlays.forEach((function(t){t.hasDrapedFeatureSource=(0,Eu.at)(e,(function(e){return e.drapeSourceType===VS.Features})),t.hasDrapedRasterSource=(0,Eu.at)(e,(function(e){return e.drapeSourceType===VS.RasterImage}))}))}},{key:"ensureOverlays",value:function(e,t){(0,Nu.t)(this._overlays)&&(this._overlayRenderTarget=new iO(this._rctx),this._overlays=[new eO(GS.INNER,this._overlayRenderTarget),new eO(GS.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}},{key:"disposeOverlays",value:function(){this._overlays=null,this._overlayRenderTarget=(0,Nu.G)(this._overlayRenderTarget),this.events.emit("textures-disposed")}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){this._processDrapeSources(e,(function(){return!0}))}},{key:"_processDrapeSources",value:function(e,t){var r,n=!1,i=(0,Cu.Z)(this._renderers);try{for(i.s();!(r=i.n()).done;){var a=(0,xu.Z)(r.value,2),o=a[0],s=a[1];if(e.done)break;(o.destroyed||t(o))&&s.commitChanges()&&(n=!0,e.madeProgress())}}catch(l){i.e(l)}finally{i.f()}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,n=!0,this._updateSortedDrapeSourceRenderers()),n&&((0,Nu.r)(this._overlays)&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}},{key:"processSyncDrapeSources",value:function(){this._processDrapeSources(bc.F,(function(e){return e.updatePolicy===vc.i.SYNC}))}},{key:"isEmpty",value:function(){if(Ac.t.OVERLAY_DRAW_DEBUG_TEXTURE)return!1;var e,t=(0,Cu.Z)(this._renderers.values());try{for(t.s();!(e=t.n()).done;){if(!e.value.isEmpty)return!1}}catch(r){t.e(r)}finally{t.f()}return!0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"updateAnimation",value:function(e){var t=!1;return this._renderers.forEach((function(r){return t=r.updateAnimation(e)||t})),t}},{key:"updateDrapeSourceOrder",value:function(){this._sortedDrapeSourceRenderersDirty=!0}},{key:"drawTarget",value:function(e,t,r){var n=this,i=e.canvasGeometries;if(0===i.numViews)return!1;this._screenToWorldRatio=r*e.mapUnitsPerPixel;var a=t.output;if(this.isEmpty()||a===dc.O.Highlight&&!this.hasHighlights||a===dc.O.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;var o=t.fbo;if(!o.isValid())return!1;var s=2*e.resolution,l=e.resolution;o.resize(s,l);var u=this._rctx;vA.pixelRatio=e.pixelRatio*r,this._renderContext.output=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=a===dc.O.Normal?dc.H.DRAPED_WATER:dc.H.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(u),e.index===GS.INNER&&(u.setClearColor(0,0,0,0),u.clearSafe(pc._.COLOR_BUFFER_BIT));var c=t.type===WS.ColorNoRasterImage?hA.ExcludeRasterImage:t.type===WS.Occluded?hA.OccludedOnly:hA.Normal;if(c===hA.OccludedOnly&&(this._renderContext.renderOccludedMask=yA),Ac.t.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==hA.OccludedOnly)for(var h=0;h<i.numViews;h++)this._setViewParameters(i.extents[h],e,vA),this._drawDebugTexture(e.resolution,pA[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll((function(t){var r=t.drapeSource,h=t.renderer;if(c!==hA.ExcludeRasterImage||r.drapeSourceType!==VS.RasterImage){var d=r.fullOpacity,f=(0,Nu.r)(d)&&d<1&&a===dc.O.Color;f&&(n.bindTemporaryFramebuffer(n._rctx,s,l),u.clearSafe(pc._.COLOR_BUFFER_BIT));for(var p=0;p<i.numViews;p++)n._setViewParameters(i.extents[p],e,vA),h.render(n._renderContext,n._bindParameters);f&&(0,Nu.r)(n._temporaryFBO)&&(o.bind(u),n.view._stage.renderView.compositingHelper.compositeOverlay(n._renderContext.bindParameters,n._temporaryFBO.getTexture(),d,e.index))}})),u.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}},{key:"bindTemporaryFramebuffer",value:function(e,t,r){(0,Nu.t)(this._temporaryFBO)&&(this._temporaryFBO=new rO(e,!1)),this._temporaryFBO.resize(t,r),this._temporaryFBO.bind(e)}},{key:"reloadShaders",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._shaderTechniqueRepository.reloadAll();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"notifyContentChanged",value:function(){this.events.emit("content-changed")}},{key:"intersect",value:function(e,t,r,n){var i,a=0,o=(0,Cu.Z)(this._renderers.values());try{for(o.s();!(i=o.n()).done;){var s,l,u=i.value;a=null!==(s=null===(l=u.intersect)||void 0===l?void 0:l.call(u,e,t,r,n,a))&&void 0!==s?s:a}}catch(c){o.e(c)}finally{o.f()}}},{key:"_updateSortedDrapeSourceRenderers",value:function(){var e=this;if(this._sortedRenderers.clear(),0!==this._renderers.size){var t=this.view.map.allLayers;this._renderers.forEach((function(r,n){var i=t.indexOf(n.layer);e._sortedRenderers.push(new fA(n,r,i<0?1/0:i))})),this._sortedRenderers.sort((function(e,t){return e.index-t.index}))}}},{key:"_setViewParameters",value:function(e,t,r){r.viewport[0]=r.viewport[1]=0,r.viewport[2]=r.viewport[3]=t.resolution,(0,Wu.F)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,Wu.x)(r.viewMatrix,[-e[0],-e[1],0]),this._bindParameters.camera=r}},{key:"_updateHasWater",value:function(){var e=(0,Eu.a9)(this._renderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}},{key:"_updateHasHighlights",value:function(){var e=(0,Eu.a9)(this._renderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}},{key:"_updateRendersOccluded",value:function(){var e=(0,Eu.a9)(this._renderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}},{key:"_drawDebugTexture",value:function(e,t){this._ensureDebugPatternResources(e,e,t);var r=this._rctx;r.bindTechnique(this._debugTextureTechnique,this._passParameters,null),r.bindVAO(this._quadVAO),r.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(this._quadVAO,"geometry"))}},{key:"_ensureDebugPatternResources",value:function(e,t,r){if((0,Vu.o)(this._passParameters.color,r[0],r[1],r[2]),!this._passParameters.texture){for(var n=new Uint8Array(e*t*4),i=0,a=0;a<t;a++)for(var o=0;o<e;o++){var s=Math.floor(o/10),l=Math.floor(a/10);s<2||l<2||10*s>e-20||10*l>t-20?(n[i++]=255,n[i++]=255,n[i++]=255,n[i++]=255):(n[i++]=255,n[i++]=255,n[i++]=255,n[i++]=1&s&&1&l?1&o^1&a?0:255:1&s^1&l?0:128)}this._passParameters.texture=new Oc.E(this._rctx,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.NEAREST,width:e,height:t},n);var u=new cA;u.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(uA,u),this._quadVAO=(0,dc.u)(this._rctx)}}},{key:"test",get:function(){var e=this;return{drapeSourceRenderers:this._renderers,getDrapeSourceRenderer:function(t){return e._renderers.get(t)}}}}]),r}(cO(Eu.m));(0,Eu.e)([(0,Eu.y)()],dA.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],dA.prototype,"_shaderTechniqueRepository",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],dA.prototype,"_stippleTextureRepository",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],dA.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],dA.prototype,"worldToPCSRatio",void 0),(0,Eu.e)([(0,Eu.y)()],dA.prototype,"spatialReference",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],dA.prototype,"updating",null),dA=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.OverlayRenderer")],dA),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(hA||(hA={}));var fA=(0,ku.Z)((function e(t,r,n){(0,Au.Z)(this,e),this.drapeSource=t,this.renderer=r,this.index=n})),pA=[[1,.5,.5],[.5,.5,1]],vA=new Jy;vA.near=1,vA.far=1e4,vA.relativeElevation=null;var mA=-2,yA=dc.ah.OccludeAndTransparent;function gA(e,t,r,n){var i=(0,eh.l)(e.rings,e.hasZ,eh.c.CCW_IS_HOLE),a=new Float64Array(i.position.length),o=FT(i.position,e.spatialReference,0,a,0,i.position,0,i.position.length/3,t,r,n),s=null!=o;return new CA(i.position,a,xA(i.polygons,i.position,a),bA(i.outlines,i.position,a),s,o)}function _A(e,t){for(var r=(0,eh.l)(e.rings,!1,eh.c.CCW_IS_HOLE),n=(0,Hu.x)(r.position,e.spatialReference,0,r.position,t,0,r.position.length/3),i=2;i<r.position.length;i+=3)r.position[i]=mA;return{position:r.position,polygons:xA(r.polygons,r.position),outlines:bA(r.outlines,r.position),projectionSuccess:n}}function bA(e,t,r){return e.filter((function(e){return e.count>1})).map((function(e){var n=e.index,i=e.count,a=3*n,o=a+3*i;return r?new TA(n,i,t.subarray(a,o),r.subarray(a,o)):new wA(n,i,t.subarray(a,o))}))}function xA(e,t,r){var n,i=new Array,a=(0,Cu.Z)(e);try{var o=function(){var e=n.value,a=e.index,o=e.count,s=e.holeIndices,l=e.pathLengths;if(o<=1)return"continue";var u=3*a,c=u+3*o,h=s.map((function(e){return e-a}));i.push({index:a,count:o,holeIndices:h,pathLengths:l,position:t.subarray(u,c),mapPosition:r?r.subarray(u,c):void 0})};for(a.s();!(n=a.n()).done;)o()}catch(s){a.e(s)}finally{a.f()}return i}var wA=(0,ku.Z)((function e(t,r,n){(0,Au.Z)(this,e),this.index=t,this.count=r,this.position=n})),TA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i)).mapPosition=a,o}return(0,ku.Z)(r)}(wA),CA=(0,ku.Z)((function e(t,r,n,i,a,o){(0,Au.Z)(this,e),this.position=t,this.mapPosition=r,this.polygons=n,this.outlines=i,this.projectionSuccess=a,this.sampledElevation=o})),SA=["polygon","extent"],OA=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a)).ensureDrapedStatus(!1),o}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t,r,n,i,a,o,s;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._drivenProperties.size){e.next=4;break}if(!(t=LT(this._getSymbolSize()))){e.next=4;break}throw new Eu.s("graphics3dextrudesymbollayer:invalid-size",t);case 4:r=(0,Nu.q)(this.symbolLayer,"material","color"),n=this._getCombinedOpacityAndColor(r),i=(0,Vu.a6)(n),a=n[3],o=a<1||this.needsDrivenTransparentPass,s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:a,transparent:o,cullFace:o?vc.n.None:vc.n.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0},this._material=new dc.aS(s),this._bottomMaterial=new dc.aS((0,Tu.Z)((0,Tu.Z)({},s),{},{cullFace:vc.n.Back})),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,SA,this.symbolLayer.type))return null;var r=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(t,new bC);return this._createAs3DShape(t,e.renderingInfo,r,n,t.uid)}},{key:"layerOpacityChanged",value:function(e,t){var r=this,n=(0,Nu.q)(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(n),a=i<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:i,transparent:a}),this._bottomMaterial.setParameters({opacity:i,transparent:a});var o=this._getLayerOpacity();e.forEach((function(e){var n=t(e);(0,Nu.r)(n)&&n.layerOpacityChanged(o,r._context.isAsync)}))}},{key:"layerElevationInfoChanged",value:function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,GT)}},{key:"slicePlaneEnabledChanged",value:function(e,t){var r=this;return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((function(e){var n=t(e);(0,Nu.r)(n)&&n.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)})),!0}},{key:"physicalBasedRenderingChanged",value:function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"_getExtrusionSize",value:function(e){var t,r;return r=e.size&&this._drivenProperties.size?null!==(t=function(e){var t=e[arguments.length>1&&void 0!==arguments[1]?arguments[1]:0];return"number"==typeof t&&isFinite(t)?t:null}(e.size,2))&&void 0!==t?t:0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters}},{key:"applyRendererDiff",value:function(e,t){return this._drivenPropertiesChanged(t)?TC.Recreate_Symbol:TC.Recreate_Graphics}},{key:"queryForSnapping",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i){var a,o,s,l,u,c,h,d,f,p,v;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/(0,Xu.L)(r),s=t.objectId,l=t.target,u=(0,Nu.y)(l),e.t0=(u.z=(null!==(a=u.z)&&void 0!==a?a:0)+o,t.type),e.next="edge"===e.t0?4:"vertex"===e.t0?6:7;break;case 4:return d=t.start,f=t.end,p=(0,Nu.y)(d),v=(0,Nu.y)(f),e.abrupt("return",(p.z=(null!==(c=p.z)&&void 0!==c?c:0)+o,v.z=(null!==(h=v.z)&&void 0!==h?h:0)+o,[(0,Jc.e)(s,u,1/0,p,v)]));case 6:return e.abrupt("return",[(0,Jc.t)(s,u,1/0),(0,Jc.e)(s,l,1/0,l,u)]);case 7:return e.abrupt("return",[]);case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getSymbolSize",value:function(){var e;return null!==(e=this.symbolLayer.size)&&void 0!==e?e:1}},{key:"_createAs3DShape",value:function(e,t,r,n,i){var a=US(e.geometry);if((0,Nu.t)(a))return null;if(0===a.rings.length||!a.rings.some((function(e){return e.length>0})))return this._logGeometryValidationWarnings(a.rings,"rings","ExtrudeSymbol3DLayer"),null;var o=gA(a,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(o,a.rings,"rings","ExtrudeSymbol3DLayer");var s=PT(a);if((0,Nu.t)(s))return null;var l=new Array,u=new Array,c=new Array,h=(0,Gc.a)(),d=(0,hc.e)(),f=(0,Vu.n)(),p=this._context.renderCoordsHelper.viewingMode===ic.l.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,f),(0,Hu.Z)(a.spatialReference,[s.x,s.y,0],d,this._context.renderCoordsHelper.spatialReference);var v=(0,hc.e)();(0,Wu.h)(v,d);var m=(0,gc.e)();(0,mc.g)(m,v);for(var y=o.polygons,g=o.mapPosition,_=o.position,b=_.length/3,x=new Float64Array(3*b*6),w=new Float64Array(3*b*6),T=new Float64Array(3*b*6),C=new Float64Array(1*b*6),S=0,O=0;O<y.length;++O){var P=y[O],R=P.count;if(!this._context.clippingExtent||((0,Gc.A)(h),(0,Gc.M)(h,P.mapPosition),(0,Gc.R)(h,this._context.clippingExtent))){var A=(0,Qc.x)(P.mapPosition,P.holeIndices,3);if(0!==A.length){var k=3*R*2+A.length,E=new Array(k),D=new Array(A.length),M=6*R,I=3*x.BYTES_PER_ELEMENT,L=new Zc.T(x.buffer,S*I,I,(S+M)*I),Z=3*w.BYTES_PER_ELEMENT,N=new Zc.T(w.buffer,S*Z,Z,(S+M)*Z),F=new Float64Array(T.buffer,3*S*T.BYTES_PER_ELEMENT,3*M),z=new Float64Array(C.buffer,1*S*C.BYTES_PER_ELEMENT,1*M),U=this._getExtrusionSize(t);RA(_,g,A,P,L.typedBuffer,F,N.typedBuffer,z,E,D,U,f,p),(0,Kc.t)(L,L,v),(0,Kc.r)(N,N,m),S+=6*R;var V=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),B=PA(E,E.length-D.length,{positions:L.typedBuffer,elevation:F,normals:N.typedBuffer,heights:z},r,V);l.push(B),u.push(this._material),c.push(hc.o);var G=PA(D,0,{positions:L.typedBuffer,elevation:F,normals:N.typedBuffer,heights:z},r,V);l.push(G),u.push(this._bottomMaterial),c.push(hc.o)}}}if(0===l.length)return null;var H=new tS({geometries:l,materials:u,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0}});H.transformation=d;var j=(0,qc.f)(this.symbolLayer,{opacity:this._getLayerOpacity()}),q=(0,Nu.r)(j)?{baseMaterial:this._material,edgeMaterials:[j],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,W=new xC(this,H,l,null,null,zA,n,q);return W.alignedSampledElevation=o.sampledElevation,W.needsElevationUpdates=GT(n.mode),W}}]),r}(WC);function PA(e,t,r,n,i){var a=new Array(e.length).fill(0),o=[[fc.O.POSITION,{size:3,data:r.positions,exclusive:!0}],[fc.O.NORMAL,{size:3,data:r.normals,exclusive:!0}],[fc.O.COLOR,{size:4,data:n,exclusive:!0}],[fc.O.SIZE,{size:1,data:r.heights,exclusive:!0}]],s=[[fc.O.POSITION,e],[fc.O.NORMAL,e],[fc.O.COLOR,a]];return r.elevation&&(o.push([fc.O.MAPPOS,{size:3,data:r.elevation}]),s.push([fc.O.MAPPOS,e])),new dc.M(o,s,vc.a.Triangle,i,t)}function RA(e,t,r,n,i,a,o,s,l,u,c,h,d){var f=r.length/3,p=0,v=2*n.count;!function(e,t,r,n,i,a,o,s,l,u,c,h,d,f,p,v,m){(0,Vu.r)(BA,v);for(var y=p>0?1:-1,g=3*r,_=0,b=3*_,x=n,w=3*x,T=0;T<n;++T)m&&(BA[0]=e[g+0],BA[1]=e[g+1],BA[2]=e[g+2],(0,Vu.z)(BA,BA)),s[b+0]=e[g+0],s[b+1]=e[g+1],s[b+2]=e[g+2],l[b+0]=t[g+0],l[b+1]=t[g+1],l[b+2]=t[g+2],u[b+0]=-y*BA[0],u[b+1]=-y*BA[1],u[b+2]=-y*BA[2],c[_]=0,s[w+0]=e[g+0]+p*BA[0],s[w+1]=e[g+1]+p*BA[1],s[w+2]=e[g+2]+p*BA[2],l[w+0]=t[g+0],l[w+1]=t[g+1],l[w+2]=t[g+2],u[w+0]=y*BA[0],u[w+1]=y*BA[1],u[w+2]=y*BA[2],c[x]=p,b+=3,w+=3,g+=3,_+=1,x+=1;g=3*a,b=0,w=3*f;for(var C=p<0?jA:HA,S=p<0?HA:jA,O=0;O<o;++O)d[b+0]=i[g+C[0]],d[b+1]=i[g+C[1]],d[b+2]=i[g+C[2]],h[w+0]=i[g+S[0]]+n,h[w+1]=i[g+S[1]]+n,h[w+2]=i[g+S[2]]+n,b+=3,w+=3,g+=3}(e,t,n.index,n.count,r,0,f,i,a,o,s,l,u,v,c,h,d);var m=2*n.count;v=0,EA(i,a,s,o,p,n.pathLengths[0],n.count,m,l,v,c),m+=4*n.pathLengths[0],v+=2*n.pathLengths[0],p+=n.pathLengths[0];for(var y=1;y<n.pathLengths.length;++y)EA(i,a,s,o,p,n.pathLengths[y],n.count,m,l,v,c),m+=4*n.pathLengths[y],v+=2*n.pathLengths[y],p+=n.pathLengths[y]}function AA(e,t,r,n,i,a,o){n[a]=n[o],o*=3,e[0+(a*=3)]=e[o+0],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a+0]=t[o+0],t[a+1]=t[o+1],t[a+2]=t[o+2],r[a+0]=i[0],r[a+1]=i[1],r[a+2]=i[2]}var kA=(0,Vu.n)();function EA(e,t,r,n,i,a,o,s,l,u,c){var h=i,d=i+1,f=i+o,p=i+o+1,v=s,m=s+1,y=s+2*a,g=s+2*a+1;c<0&&(h=i+o+1,p=i),u*=3;for(var _=0;_<a;++_)_===a-1&&(c>0?(d=i,p=i+o):(d=i,h=i+o)),NA(e,h,d,f,kA),AA(e,t,n,r,kA,v,h),AA(e,t,n,r,kA,m,d),AA(e,t,n,r,kA,y,f),AA(e,t,n,r,kA,g,p),l[u++]=v,l[u++]=y,l[u++]=g,l[u++]=v,l[u++]=g,l[u++]=m,h++,d++,f++,p++,v+=2,m+=2,y+=2,g+=2}var DA=(0,Vu.n)(),MA=(0,Vu.n)(),IA=(0,Vu.n)(),LA=(0,Vu.n)(),ZA=(0,Vu.n)();function NA(e,t,r,n,i){t*=3,r*=3,n*=3,(0,Vu.o)(DA,e[t++],e[t++],e[t++]),(0,Vu.o)(MA,e[r++],e[r++],e[r++]),(0,Vu.o)(IA,e[n++],e[n++],e[n++]),(0,Vu.e)(LA,MA,DA),(0,Vu.e)(ZA,IA,DA),(0,Vu._)(i,ZA,LA),(0,Vu.z)(i,i)}var FA=(0,Vu.n)();function zA(e,t,r,n){for(var i=e.stageObject,a=i.geometryRecords,o=a.length,s="absolute-height"!==t.mode,l=0,u=i.transformation,c=(0,Wu.h)((0,hc.e)(),u),h=0;h<o;h+=2){for(var d=a[h].geometry,f=d.getMutableAttribute(fc.O.POSITION).data,p=d.vertexAttributes.get(fc.O.SIZE).data,v=d.vertexAttributes.get(fc.O.MAPPOS).data,m=new qu.H(v),y=f.length/3,g=0,_=!1,b=0,x=r.spatialReference,w=0;w<y;w++){FA[0]=f[g],FA[1]=f[g+1],FA[2]=f[g+2],zT(m,r,t,n,GA),s&&(b+=GA.sampledElevation),Ac.t.TESTS_DISABLE_OPTIMIZATIONS?((0,Vu.o)(VA,m.array[m.offset+0],m.array[m.offset+1],GA.z+p[g/3]),(0,Nu.r)(x)&&n.toRenderCoords(VA,x,VA),(0,Vu.O)(VA,VA,c)):((0,Vu.o)(VA,f[g+0],f[g+1],f[g+2]),(0,Vu.O)(VA,VA,u),n.setAltitude(VA,GA.z+p[g/3]),(0,Vu.O)(VA,VA,c)),f[g]=VA[0],f[g+1]=VA[1],f[g+2]=VA[2];var T=qA/n.unitInMeters;(Math.abs(FA[0]-f[g])>=T||Math.abs(FA[1]-f[g+1])>=T||Math.abs(FA[2]-f[g+2])>=T)&&(_=!0),m.offset+=3,g+=3}_&&(d.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(a[h]),a[h+1].geometry.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(a[h+1])),l+=b/y}return l/o}for(var UA,VA=(0,Vu.n)(),BA=(0,Vu.n)(),GA=new qT,HA=[0,2,1],jA=[0,1,2],qA=.01,WA=1.2,XA=lc.l,YA=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this.graphics3DSymbolLayer=t,this.renderGeometries=r,this.boundingBox=n,this._drapeSourceRenderer=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}return(0,ku.Z)(e,[{key:"initialize",value:function(e){this.stage=e}},{key:"setVisibility",value:function(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,aR.ADD);if(e||this._addedToStage){var t,r=(0,Cu.Z)(this.renderGeometries);try{for(r.s();!(t=r.n()).done;){t.value.instanceParameters.visible=this._visible}}catch(n){r.e(n)}finally{r.f()}this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,oR.VISIBILITIES)}}}},{key:"destroy",value:function(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,aR.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}},{key:"getCenterObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Vu.n)();return(0,Vu.o)(e,0,0,0)}},{key:"getBoundingBoxObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Gc.a)();return(0,Gc.A)(e)}},{key:"addObjectState",value:function(e,t){var r=this;e===vc.u.Highlight&&(this.renderGeometries.forEach((function(e){var n=e.addHighlight();t.addRenderGeometry(e,n,r)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,oR.HIGHLIGHTS))}},{key:"removeObjectState",value:function(e){this.renderGeometries.forEach((function(t){e.removeRenderGeometry(t)}))}},{key:"removeRenderGeometryObjectState",value:function(e,t){e.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,oR.HIGHLIGHTS)}},{key:"computeAttachmentOrigin",value:function(e){var t,r=(0,Cu.Z)(this.renderGeometries);try{for(r.s();!(t=r.n()).done;){t.value.computeAttachmentOrigin(JA)&&(e.draped.origin[0]+=JA[0],e.draped.origin[1]+=JA[1],e.draped.num++)}}catch(n){r.e(n)}finally{r.f()}}},{key:"getProjectedBoundingBox",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for((0,Gc.A)(a),o=0;o<this.renderGeometries.length;o++)s=this.renderGeometries[o],this._getRenderGeometryProjectedBoundingRect(s,t,QA,n),(0,Gc.h)(a,QA);if(!r){e.next=14;break}return(0,Gc.p)(a,JA),u=NT(a,r.service.spatialReference,r),e.prev=5,e.next=8,r.service.queryElevation(JA[0],JA[1],i,u,"ground");case 8:l=e.sent,e.next=13;break;case 11:e.prev=11,e.t0=e.catch(5);case 13:(0,Nu.r)(l)&&(a[2]=Math.min(a[2],l),a[5]=Math.max(a[5],l));case 14:return e.abrupt("return",a);case 15:case"end":return e.stop()}}),e,this,[[5,11]])})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_getRenderGeometryProjectedBoundingRect",value:function(e,t,r,n){if(this.boundingBox)(0,Gc.w)(KA,this.boundingBox);else{var i=e.boundingSphere,a=i[3];KA[0]=i[0]-a,KA[1]=i[1]-a,KA[2]=i[2]-a,KA[3]=i[0]+a,KA[4]=i[1]+a,KA[5]=i[2]+a}return t(KA,0,2),this.calculateRelativeScreenBounds&&n.push({location:(0,Gc.p)(KA),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,Gc.B)(KA,r)}}]),e}(),QA=(0,ju.u)(),KA=(0,Gc.a)(),JA=(0,Vu.n)(),$A=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2048;(0,Au.Z)(this,e),this.text=t,this._alignment=r,this._parameters=n,this._maxSize=i,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetricsCached=null,this.key="TextRenderer-".concat(this._parameters.key,"-").concat(this._alignment,"--").concat(t),this._lines=t.split(/\r?\n/)}return(0,ku.Z)(e,[{key:"displayWidth",get:function(){return Math.ceil(this._ensureTextWidth()+2*this._backgroundHorizontalPadding)}},{key:"displayHeight",get:function(){var e=this._lineSpacing*(this._lines.length-1),t=this._lineHeight;return Math.ceil(e+t+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}},{key:"renderedWidth",get:function(){return Math.ceil(this._toRenderUnit(this.displayWidth))}},{key:"renderedHeight",get:function(){return Math.ceil(this._toRenderUnit(this.displayHeight))}},{key:"firstRenderedBaselinePosition",get:function(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}},{key:"_firstLineYOffset",get:function(){return this._backgroundTopPadding+this._haloSize}},{key:"_heightMetrics",get:function(){return this._ensureHeightMetrics()}},{key:"_lineSpacing",get:function(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}},{key:"_lineHeight",get:function(){return this._heightMetrics.lineHeight}},{key:"_linePadding",get:function(){return this._lineHeight*sk}},{key:"_baselinePosition",get:function(){return this._heightMetrics.baselinePosition}},{key:"_renderedFontSize",get:function(){return this._toRenderUnit(this._fontSize)}},{key:"_fontSize",get:function(){return this._parameters.definition.size}},{key:"_renderedHaloSize",get:function(){return this._toRenderUnit(this._haloSize)}},{key:"_haloSize",get:function(){return this._parameters.haloSize}},{key:"_backgroundHorizontalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}},{key:"_backgroundVerticalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}},{key:"_backgroundTopPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingTop)}},{key:"_backgroundBottomPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingBottom)}},{key:"_hasBackground",get:function(){return!!this._parameters.backgroundStyle}},{key:"renderPixelRatio",get:function(){if((0,Nu.t)(this._renderPixelRatio)){var e=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}},{key:"_getLineXOffset",value:function(e){switch(this._alignment){case UA.Left:return this._backgroundHorizontalPadding;case UA.Center:return(this.displayWidth-this._lineWidths[e])/2;case UA.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}}},{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e.save();var n=t/=this.renderPixelRatio,i=r/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset;t+=a,r+=o+this._baselinePosition;var s=this._haloSize>0;s&&this._renderHalo(e,n,i,a,o),this._setFontProperties(e,this._renderedFontSize);for(var l=0;l<this._lines.length;++l){var u=this._lines[l],c=this._getLineXOffset(l);s&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,u,t+c,r),this._renderLineDecoration(e,t+c,r,this._textWidths[l])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,u,t+this._getLineXOffset(l),r),this._renderLineDecoration(e,t+c,r,this._textWidths[l]),r+=this._lineSpacing}if(Ac.t.TEXT_SHOW_BASELINE){e.strokeStyle=uk,e.setLineDash([2,2]),e.lineWidth=1;for(var h=i+o,d=0;d<this._lines.length;++d){var f=h+this._baselinePosition;this._drawLine(e,[n,f],[n+this.displayWidth,f]),h+=this._lineSpacing}}if(Ac.t.TEXT_SHOW_BORDER&&(e.strokeStyle=uk,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[n,i],[this.displayWidth,this.displayHeight])),this._hasBackground){var p=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,n,i,p),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}},{key:"_renderLineDecoration",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if("none"!==this._parameters.definition.font.decoration&&0!==n){var a=1,o=Math.max(this._parameters.definition.size/16,a);switch(this._parameters.definition.font.decoration){case"underline":r+=2*o;break;case"line-through":r-=.33*this._baselinePosition}var s=i?this._haloSize:0;e.strokeStyle=i?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(o+2*s),e.beginPath(),e.moveTo(this._toRenderUnit(t-s),this._toRenderUnit(r)),e.lineTo(this._toRenderUnit(t+n+s),this._toRenderUnit(r)),e.stroke()}}},{key:"_roundedRect",value:function(e,t,r,n){t=this._toRenderUnit(t),r=this._toRenderUnit(r);var i=this.renderedWidth,a=this.renderedHeight;0!==n?(n=(0,Vu.a)(n,0,Math.floor(a/2)),e.beginPath(),e.moveTo(t,r+n),e.arcTo(t,r,t+n,r,n),e.lineTo(t+i-n,r),e.arcTo(t+i,r,t+i,r+n,n),e.lineTo(t+i,r+a-n),e.arcTo(t+i,r+a,t+i-n,r+a,n),e.lineTo(t+n,r+a),e.arcTo(t,r+a,t,r+a-n,n),e.closePath()):e.rect(t,r,i,a)}},{key:"_renderHalo",value:function(e,t,r,n,i){var a=this.renderedWidth,o=this.renderedHeight,s=rk(ok,Math.max(a,lk),Math.max(o,lk)),l=s.getContext("2d");l.clearRect(0,0,a,o),this._setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;var u=this._renderedHaloSize<3;l.lineJoin=u?"miter":"round",u?this._renderHaloEmulated(l,n,i):this._renderHaloNative(l,n,i);for(var c=i+this._baselinePosition,h=0;h<this._lines.length;++h){var d=this._getLineXOffset(h);this._renderLineDecoration(l,n+d,c,this._textWidths[h],!0),c+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(s,0,0,a,o,this._toRenderUnit(t),this._toRenderUnit(r),a,o),e.globalAlpha=1}},{key:"_renderHaloEmulated",value:function(e,t,r){r+=this._baselinePosition;for(var n=0;n<this._lines.length;++n){var i,a=this._lines[n],o=this._getLineXOffset(n),s=(0,Cu.Z)(ek);try{for(s.s();!(i=s.n()).done;){var l=(0,xu.Z)(i.value,2),u=l[0],c=l[1];this._fillText(e,a,t+o+this._haloSize*u,r+this._haloSize*c)}}catch(h){s.e(h)}finally{s.f()}r+=this._lineSpacing}}},{key:"_renderHaloNative",value:function(e,t,r){var n=2*this._haloSize;r+=this._baselinePosition;for(var i=0;i<this._lines.length;++i){for(var a=this._lines[i],o=this._getLineXOffset(i),s=0;s<5;s++){var l=.6+.1*s;e.lineWidth=this._toRenderUnit(l*n),this._strokeText(e,a,t+o,r)}r+=this._lineSpacing}}},{key:"_setFontProperties",value:function(e,t){e.font=this._parameters.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}},{key:"_ensureTextWidth",value:function(){if((0,Nu.r)(this._displayWidth))return this._displayWidth;var e=rk(ok,lk,lk).getContext("2d");this._setFontProperties(e,this._fontSize);var t=2*this._haloSize,r=this._parameters.definition.font;"italic"!==r.style&&"oblique"!==r.style&&"bold"!==r.weight&&"bolder"!==r.weight||(t+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;var n,i=0,a=(0,Cu.Z)(this._lines);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=e.measureText(o).width,l=s+t;this._textWidths.push(s),this._lineWidths.push(l),i=Math.max(i,l)}}catch(u){a.e(u)}finally{a.f()}return this._displayWidth=i,this._displayWidth}},{key:"_ensureHeightMetrics",value:function(){if((0,Nu.t)(this._heightMetricsCached)){var e=rk(ok,lk,lk).getContext("2d");this._setFontProperties(e,this._fontSize);var t=e.measureText(this.text+ck),r=this._hasBackground?e.measureText(this._lines[0]):t,n=1===this._lines.length?r:this._hasBackground?e.measureText(this._lines[this._lines.length-1]):t,i=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent;this._heightMetricsCached={paddingTop:t.actualBoundingBoxAscent-r.actualBoundingBoxAscent,paddingBottom:t.actualBoundingBoxDescent-n.actualBoundingBoxDescent,lineHeight:i,baselinePosition:t.actualBoundingBoxAscent}}return this._heightMetricsCached}},{key:"_toRenderUnit",value:function(e){return e*this.renderPixelRatio}},{key:"_toRoundedRenderUnit",value:function(e){return Math.round(e*this.renderPixelRatio)}},{key:"_fillText",value:function(e,t,r,n){e.fillText(t,this._toRenderUnit(r),this._toRenderUnit(n))}},{key:"_strokeText",value:function(e,t,r,n){e.strokeText(t,this._toRenderUnit(r),this._toRenderUnit(n))}},{key:"_drawLine",value:function(e,t,r){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.stroke()}},{key:"_drawBox",value:function(e,t,r){var n=this._toRenderUnit(t[0]),i=this._toRenderUnit(t[1]),a=this._toRenderUnit(r[0]),o=this._toRenderUnit(r[1]),s=Math.floor(n)+.5,l=Math.ceil(n+a)-.5,u=Math.floor(i)+.5,c=Math.ceil(i+o)-.5;e.beginPath(),e.moveTo(s,u),e.lineTo(l,u),e.lineTo(l,c),e.lineTo(s,c),e.lineTo(s,u),e.stroke()}}]),e}(),ek=[],tk=0;tk<360;tk+=22.5)ek.push([Math.cos(Math.PI*tk/180),Math.sin(Math.PI*tk/180)]);function rk(e,t,r){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=r,e.canvas}!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(UA||(UA={}));var nk,ik,ak,ok={canvas:null},sk=.2,lk=512,uk="rgb(255, 0, 255, 0.5)",ck=function(){for(var e="",t=32;t<127;t++)e+=String.fromCharCode(t);return e}(),hk=Object.freeze({left:0,center:.5,right:1}),dk=Object.freeze({"bottom-left":(0,cc.r)(0,0),bottom:(0,cc.r)(.5,0),"bottom-right":(0,cc.r)(1,0),left:(0,cc.r)(0,.5),center:(0,cc.r)(.5,.5),right:(0,cc.r)(1,.5),"top-left":(0,cc.r)(0,1),top:(0,cc.r)(.5,1),"top-right":(0,cc.r)(1,1)});function fk(e){switch(e){case"left":return UA.Left;case"right":return UA.Right;default:return UA.Center}}function pk(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function vk(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function mk(e){return"middle"===e?"center":e}function yk(e){return null!=e}function gk(e){return"number"==typeof e}function _k(e){return"string"==typeof e}function bk(e,t){e&&e.push(t)}function xk(e,t,r,n,i){var a=e.minSize,o=e.maxSize;if(e.expression)return bk(i,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){var s=n.symbolSize[r];return t.minSize[r]=s,t.maxSize[r]=s,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=nk.DefinedSize,!0}if(yk(e.field))return yk(e.stops)?2===e.stops.length&&gk(e.stops[0].size)&&gk(e.stops[1].size)?(wk(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,r),t.type[r]=nk.DefinedSize,!0):(bk(i,"Could not convert size info: stops only supported with 2 elements"),!1):gk(a)&&gk(o)&&yk(e.minDataValue)&&yk(e.maxDataValue)?(wk(a,o,e.minDataValue,e.maxDataValue,t,r),t.type[r]=nk.DefinedSize,!0):null!=Hc.m[e.valueUnit]?(t.minSize[r]=-1/0,t.maxSize[r]=1/0,t.offset[r]=0,t.factor[r]=1/Hc.m[e.valueUnit],t.type[r]=nk.DefinedSize,!0):"unknown"===e.valueUnit?(bk(i,"Could not convert size info: proportional size not supported"),!1):(bk(i,"Could not convert size info: scale-dependent size not supported"),!1);if(!yk(e.field)){if(e.stops&&e.stops[0]&&gk(e.stops[0].size))return t.minSize[r]=e.stops[0].size,t.maxSize[r]=e.stops[0].size,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=nk.DefinedSize,!0;if(gk(a))return t.minSize[r]=a,t.maxSize[r]=a,t.offset[r]=a,t.factor[r]=0,t.type[r]=nk.DefinedSize,!0}return bk(i,"Could not convert size info: unsupported variant of sizeInfo"),!1}function wk(e,t,r,n,i,a){var o=Math.abs(n-r)>0?(t-e)/(n-r):0;i.minSize[a]=o>0?e:t,i.maxSize[a]=o>0?t:e,i.offset[a]=e-r*o,i.factor[a]=o}function Tk(e,t,r,n){if(e.normalizationField||e.valueRepresentation)return bk(n,"Could not convert size info: unsupported property"),null;if(!function(e){return null==e||_k(e)}(e.field))return bk(n,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return bk(n,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[nk.Undefined,nk.Undefined,nk.Undefined]};var i;switch(e.axis){case"width":return(i=xk(e,t.size,0,r,n))?t:null;case"height":return(i=xk(e,t.size,2,r,n))?t:null;case"depth":return(i=xk(e,t.size,1,r,n))?t:null;case"width-and-depth":return(i=xk(e,t.size,0,r,n))&&xk(e,t.size,1,r,n),i?t:null;case null:case void 0:case"all":return(i=(i=(i=xk(e,t.size,0,r,n))&&xk(e,t.size,1,r,n))&&xk(e,t.size,2,r,n))?t:null;default:return bk(n,'Could not convert size info: unknown axis "'.concat(e.axis,'""')),null}}function Ck(e,t,r){e[4*t+0]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function Sk(e,t,r){var n=2===r&&"arithmetic"===e.rotationType;t.offset[r]=n?90:0,t.factor[r]=n?-1:1,t.type[r]=1}function Ok(e,t,r){if(!e)return null;var n=!t.supportedTypes||!!t.supportedTypes.size,i=!t.supportedTypes||!!t.supportedTypes.color,a=!t.supportedTypes||!!t.supportedTypes.rotation,o=!!t.supportedTypes&&!!t.supportedTypes.opacity,s=e.reduce((function(e,s){if(!e)return e;if(s.valueExpression)return bk(r,"Could not convert visual variables: arcade expressions not supported"),null;switch(s.type){case"size":return n?Tk(s,e,t,r):e;case"color":return i?function(e,t,r){if(e.normalizationField)return bk(r,"Could not convert color info: unsupported property"),null;if(_k(e.field)){if(!e.stops)return bk(r,"Could not convert color info: missing stops or colors"),null;if(e.stops.length>8)return bk(r,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var n=e.stops,i=0;i<8;++i){var a=n[Math.min(i,n.length-1)];t.color.values[i]=a.value,Ck(t.color.colors,i,a.color)}}else{if(!(e.stops&&e.stops.length>=0))return bk(r,"Could not convert color info: no field and no colors/stops"),null;var o=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var s=0;s<8;s++)t.color.values[s]=1/0,Ck(t.color.colors,s,o)}return t}(s,e,r):e;case"opacity":return o?function(e,t,r){if(e.normalizationField)return bk(r,"Could not convert opacity info: unsupported property"),null;if(_k(e.field)){if(!e.stops)return bk(r,"Could not convert opacity info: missing stops or opacities"),null;if(e.stops.length>8)return bk(r,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(var n=e.stops,i=0;i<8;++i){var a=n[Math.min(i,n.length-1)];t.opacity.values[i]=a.value,t.opacity.opacityValues[i]=a.opacity}}else{if(!(e.stops&&e.stops.length>=0))return bk(r,"Could not convert opacity info: no field and no opacities/stops"),null;var o=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(var s=0;s<8;s++)t.opacity.values[s]=1/0,t.opacity.opacityValues[s]=o}return t}(s,e,r):null;case"rotation":return a?function(e,t,r){if(!_k(e.field))return bk(r,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return bk(r,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Sk(e,t.rotation,0),t;case"roll":return Sk(e,t.rotation,1),t;case null:case void 0:case"heading":return Sk(e,t.rotation,2),t;default:return bk(r,'Could not convert rotation info: unknown axis "'.concat(e.axis,'""')),null}}(s,e,r):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s&&s.size&&!function(e,t,r){for(var n=0;n<3;++n){var i=t.unitInMeters;e.type[n]===nk.DefinedSize&&(i*=t.modelSize[n],e.type[n]=nk.DefinedScale),e.minSize[n]=e.minSize[n]/i,e.maxSize[n]=e.maxSize[n]/i,e.offset[n]=e.offset[n]/i,e.factor[n]=e.factor[n]/i}var a;if(e.type[0]!==nk.Undefined)a=0;else if(e.type[1]!==nk.Undefined)a=1;else{if(e.type[2]===nk.Undefined)return bk(r,"No size axis contains a valid size or scale"),!1;a=2}for(var o=0;o<3;++o)e.type[o]===nk.Undefined&&(e.minSize[o]=e.minSize[a],e.maxSize[o]=e.maxSize[a],e.offset[o]=e.offset[a],e.factor[o]=e.factor[a],e.type[o]=e.type[a]);return!0}(s.size,t,r)?null:s:null}function Pk(e){return e&&null!=e.size}function Rk(e,t){if(!e)return{enabled:!1};if(Ac.t.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};var r=Ok(e.visualVariables,t);return r?{enabled:!0,visualVariables:r,materialParameters:Ek(r,t),requiresShaderTransformation:Pk(r)}:{enabled:!1}}function Ak(e,t,r){if(!t||!e.enabled)return!1;var n=e.visualVariables,i=Ok(t.visualVariables,r);return!!i&&!!(kk(n.size,i.size,"size")&&kk(n.color,i.color,"color")&&kk(n.rotation,i.rotation,"rotation")&&kk(n.opacity,i.opacity,"opacity"))&&(e.visualVariables=i,e.materialParameters=Ek(i,r),e.requiresShaderTransformation=Pk(i),!0)}function kk(e,t,r){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===r)for(var n=e,i=t,a=0;a<3;a++)if(n.type[a]!==i.type[a]||n.offset[a]!==i.offset[a]||n.factor[a]!==i.factor[a])return!1;return!0}function Ek(e,t){var r={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},n=Pk(e);return e&&e.size?(r.vvSizeEnabled=!0,r.vvSizeMinSize=e.size.minSize,r.vvSizeMaxSize=e.size.maxSize,r.vvSizeOffset=e.size.offset,r.vvSizeFactor=e.size.factor):e&&n&&(r.vvSizeValue=t.transformation.scale),e&&n&&(r.vvSymbolAnchor=t.transformation.anchor,r.vvSymbolRotationMatrix=(0,gc.e)(),(0,Wu.r)(Dk),function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,hc.e)(),i=e||0,a=t||0,o=r||0;0!==i&&(0,Wu.m)(n,n,-i/180*Math.PI),0!==a&&(0,Wu.b)(n,n,a/180*Math.PI),0!==o&&(0,Wu.l)(n,n,o/180*Math.PI)}(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],Dk),(0,mc.a)(r.vvSymbolRotationMatrix,Dk)),e&&e.color&&(r.vvColorEnabled=!0,r.vvColorValues=e.color.values,r.vvColorColors=e.color.colors),e&&e.opacity&&(r.vvOpacityEnabled=!0,r.vvOpacityValues=e.opacity.values,r.vvOpacityOpacities=e.opacity.opacityValues),r}!function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"}(nk||(nk={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(ik||(ik={})),function(e){var t=(0,hc.e)(),r=(0,Vu.n)();e.evaluateModelTransform=function(e,n,i){if(!e.vvSizeEnabled)return i;(0,Wu.n)(t,i);var a=e.vvSymbolRotationMatrix;(0,Wu.s)(Dk,a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1),(0,Wu.u)(t,t,Dk);for(var o=0;o<3;++o){var s=e.vvSizeOffset[o]+n[0]*e.vvSizeFactor[o];r[o]=(0,Vu.a)(s,e.vvSizeMinSize[o],e.vvSizeMaxSize[o])}return(0,Wu.i)(t,t,r),(0,Wu.c)(t,t,e.vvSymbolAnchor),t},e.evaluateModelTransformScale=function(e,t,r){if(!t.vvSizeEnabled)return(0,Vu.o)(e,1,1,1);for(var n=0;n<3;++n){var i=t.vvSizeOffset[n]+r[0]*t.vvSizeFactor[n];e[n]=(0,Vu.a)(i,t.vvSizeMinSize[n],t.vvSizeMaxSize[n])}return e}}(ak||(ak={}));var Dk=(0,hc.e)(),Mk=ak.evaluateModelTransform,Ik=ak.evaluateModelTransformScale,Lk=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.visible=!0})),Zk=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,Au.Z)(this,e),this.data=t,this.material=r,this.boundingSphere=(0,lc.n)(),this.instanceParameters=new Lk,this._transformation=(0,hc.e)(),this._shaderTransformationDirty=!0,this.layerUid=(0,Nu.v)(n.layerUid,null),this.graphicUid=(0,Nu.v)(n.graphicUid,null),this.id=n.id?n.id:(0,Eu.a4)(),this.boundingInfo=(0,Nu.v)(n.boundingInfo,null),this.calculateShaderTransformation=(0,Nu.v)(n.calculateShaderTransformation,null),this.castShadow=!!n.castShadow&&n.castShadow}return(0,ku.Z)(e,[{key:"transformation",get:function(){return this._transformation}},{key:"updateTransformation",value:function(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}},{key:"shaderTransformationChanged",value:function(){this._shaderTransformationDirty=!0}},{key:"computeBoundingSphere",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,qu.I)(e);(0,Nu.t)(this.boundingInfo)||((0,Vu.O)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*r)}},{key:"hasShaderTransformation",get:function(){return(0,Nu.r)(this.calculateShaderTransformation)}},{key:"primitiveType",get:function(){return this.data.primitiveType}},{key:"getShaderTransformation",value:function(){return(0,Nu.t)(this.calculateShaderTransformation)?(0,Nu.v)(this.transformation,hc.o):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=(0,hc.e)()),(0,Wu.n)(this._shaderTransformation,this.calculateShaderTransformation((0,Nu.v)(this.transformation,hc.o))),this._shaderTransformationDirty=!1),this._shaderTransformation)}},{key:"computeAttachmentOrigin",value:function(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,Nu.r)(this._transformation)&&(0,Vu.O)(e,e,this._transformation),!0);var t=this.indices.get(fc.O.POSITION),r=this.vertexAttributes.get(fc.O.POSITION);return!!(0,dc.aT)(r,t,e)&&((0,Nu.r)(this._transformation)&&(0,Vu.O)(e,e,this._transformation),!0)}},{key:"indices",get:function(){return this.data.indices}},{key:"vertexAttributes",get:function(){return this.data.vertexAttributes}},{key:"addHighlight",value:function(){var e=new eS(vc.u.Highlight),t=this.instanceParameters;return t.highlights=(0,Ic.c)(t.highlights,e),e}},{key:"removeHighlight",value:function(e){var t=this.instanceParameters;t.highlights=(0,Ic.f)(t.highlights,e)}}]),e}(),Nk=(0,hc.e)(),Fk=(0,Vu.c)(0,0,1),zk=Qx,Uk=[zk/2,zk/2,1-zk/2,1-zk/2],Vk=[Yx*zk,Yx*zk],Bk=function(e){(0,Pu.Z)(n,e);var t=(0,Ru.Z)(n);function n(e,r,i,a){var o;return(0,Au.Z)(this,n),(o=t.call(this,e,r,i,a))._cimLayers=null,o._cimSymbolMaterials=new Map,o._cimSymbolTextures=new Map,o._cimMaterialParametersInfo=null,o._cimRequiredFields=null,o._cimScaleFactorOrFunction=null,o._size=null,o._symbolTextureRatio=1,o._outlineSize=0,o._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},o}return(0,ku.Z)(n,[{key:"getCachedSize",value:function(){return{size:this._getIconSize()}}},{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._validateOrThrow(),r=this._prepareMaterialParameters(),n=this._getPrimitive(),!(0,Nu.r)(n)){e.next=6;break}this._prepareResourcesPrimitive(r,n),e.next=14;break;case 6:if(i=(0,ah.g)(this.symbol,this.symbolLayer),!(a=(0,ih.n)(i))||"application/json"!==a.mediaType){e.next=12;break}return e.next=10,this._prepareResourcesCIM(r,JSON.parse(a.data),t);case 10:e.next=14;break;case 12:return e.next=14,this._prepareResourcesHref(r,i,t);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_validateOrThrow",value:function(){if(!this._drivenProperties.size){var e=LT(this._getIconSize());if(e)throw new Eu.s("graphics3diconsymbollayer:invalid-size",e)}}},{key:"_getIconSize",value:function(){var e=this.symbolLayer,t=Math.round(null!=e.size?(0,zu.u)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}},{key:"_generateTextureCIM",value:function(e){var t=this._getGraphicHash(e),r=""===t?null:this._cimSymbolTextures.get(t);if(!r){var n={scaleFactor:this._cimScaleFactorOrFunction},i=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",n,null,null);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",i.anchorPosition);var a={width:i.imageData.width,height:i.imageData.height,powerOfTwoResizeMode:vc.h.PAD};r=new dc.Y(i.imageData,a),this._cimSymbolTextures.set(t,r),this._context.stage.add(r)}return r}},{key:"_computeSize",value:function(e,t){var r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]}},{key:"_prepareMaterialParameters",value:function(){var e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){var r=t.verticalOffset,n=r.screenLength,i=r.minWorldLength,a=r.maxWorldLength;e.verticalOffset={screenLength:(0,zu.u)(n),minWorldLength:i||0,maxWorldLength:(0,Nu.r)(a)?a:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}},{key:"_prepareResourcesPrimitive",value:function(e,t){var r=this._getOutlineSize();if(Gk(t)&&0===r)throw new Error("Nothing to render");if(this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,(0,Nu.r)(this._context.sharedResources.textures)){var n=this._context.sharedResources.textures.fromData("".concat(t,"-icon"),(function(){return Kx(t)}));this._texture=n.texture,this._releaseTexture=n,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Uk;var i=this._getIconSize();this._size=[i,i],this._symbolTextureRatio=1/zk,this._createMaterialAndAddToStage(e,this._context.stage)}},{key:"_prepareResourcesHref",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n){var i,a,o,s,l;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,Nu.h)("esri-canvas-svg-support")||!(0,ih.I)(r)){e.next=2;break}throw new Eu.s("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");case 2:if(this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1,i=this._getIconSize(),a=i*this._context.graphicsCoreOwner.view.state.pixelRatio,!(0,Nu.r)(this._context.sharedResources.textures)){e.next=14;break}return e.next=7,(0,ac.b)(this._context.sharedResources.textures.fromUrl(r,a,{signal:n}));case 7:if(!1!==(o=e.sent).ok){e.next=11;break}throw(0,Eu.w)(o.error),new Eu.s("graphics3diconsymbollayer:request-failed","Failed to load (Request for icon resource failed: ".concat(r,")"));case 11:this._releaseTexture=o.value,s=o.value.texture,l=s.params,this._size=this._computeSize(l,i),t.textureId=s.id;case 14:this._createMaterialAndAddToStage(t,this._context.stage);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_prepareResourcesCIM",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,n,i){var a,o,s,l,u,c,h,d,f,p;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=new sh.d({data:n}),this._context.sharedResources.cimSymbolRasterizer){e.next=6;break}return e.next=4,Promise.all([r.e(9370),r.e(2017),r.e(3623),r.e(5598)]).then(r.bind(r,97527));case 4:o=e.sent.CIMSymbolRasterizer,(0,Eu.f)(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new o(this._context.renderCoordsHelper.spatialReference,!0));case 6:return s=this._context.layer.fields?this._context.layer.fields.map((function(e){return e.toJSON()})):null,e.next=9,this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(a,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i});case 9:if(this._cimLayers=e.sent,!this._context.renderer||"dictionary"!==this._context.renderer.type||!this._context.renderer.scaleExpression){e.next=21;break}if(c=this._context.renderer,!isNaN(c.scaleExpression)){e.next=20;break}return h=c.scaleExpression,e.next=16,(0,jc.o)(h,this._context.layer.spatialReference,s);case 16:d=e.sent,u=function(e,t,r){var n=(0,oh.i)(d,e,{$view:r},"esriGeometryPoint",t);return null!==n?n:1},e.next=21;break;case 20:l=Number(c.scaleExpression);case 21:if(this._cimScaleFactorOrFunction=l||u||1,!this._context.renderer){e.next=28;break}return e.next=25,this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex);case 25:e.t0=e.sent,e.next=29;break;case 28:e.t0=[];case 29:f=e.t0,(0,Eu.f)(i),p=this._context.layer.fieldsIndex,this._cimRequiredFields=f.map((function(e){return p.get(e).name})),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1;case 33:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_getPrimitive",value:function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Bc.u}},{key:"_getOutlineSize",value:function(){var e,t=this.symbolLayer;return(0,Nu.r)(t.outline)&&null!=t.outline.size?Math.max((0,zu.u)(t.outline.size),0):(e=Gk(this._getPrimitive())?1.5:0,Math.max(e,0))}},{key:"_getOutlineColor",value:function(){var e=this._getLayerOpacity(),t=this.symbolLayer,r=(0,Nu.q)(t,"outline","color");if((0,Nu.r)(r)){var n=sc.l.toUnitRGB(r),i=r.a*e;return[n[0],n[1],n[2],i]}return[0,0,0,0]}},{key:"_getFillColor",value:function(){if(Gk(this._getPrimitive()))return XA;var e=(0,Nu.t)(this._getPrimitive()),t=(0,Nu.q)(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}},{key:"_getAnchorPos",value:function(e,t){return"relative"===e?(0,cc.r)((t.x||0)+.5,.5-(t.y||0)):e in dk?dk[e]:dk.center}},{key:"_createMaterialAndAddToStage",value:function(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=Rk(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){var r=(0,Nu.r)(e.textureId)?this._cimSymbolMaterials.get(e.textureId):null;return r||(r=new ww(e),this._cimSymbolMaterials.set((0,Nu.v)(e.textureId,0),r),t.add(r)),r}return this._material=new ww(e),t.add(this._material),this._material}},{key:"_setDrapingDependentMaterialParameters",value:function(){var e=this;this.draped&&(this._forEachMaterial((function(t){t.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:e.draped})})),this.layerOpacityChanged())}},{key:"destroy",value:function(){var e=this;(0,_u.Z)((0,bu.Z)(n.prototype),"destroy",this).call(this),this._forEachMaterial((function(t){return e._context.stage.remove(t)})),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((function(t){return e._context.stage.remove(t)})),this._cimSymbolTextures.clear(),this._releaseTexture=(0,Nu.F)(this._releaseTexture)}},{key:"_getScaleFactor",value:function(e,t){if(this._drivenProperties.size&&e.size){for(var r=0;r<3;r++){var n=e.size[r];n&&"symbol-value"!==n&&"proportional"!==n&&(e.size[r]=(0,zu.u)(n))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}},{key:"createGraphics3DGraphic",value:function(e){var t,r,n=e.graphic;if(!this._validateGeometry(n.geometry))return null;if(this._cimLayers){if(!this._cimLayers.length)return null;var i=this._generateTextureCIM(n),a=(0,Tu.Z)({textureId:i.id},this._cimMaterialParametersInfo);r=this._createMaterialAndAddToStage(a,this._context.stage),t=[i.params.width,i.params.height]}else t=this._size,r=(0,Nu.e)(this._material);var o=sS(n.geometry);if((0,Nu.t)(o))return this.logger.warn("unsupported geometry type for icon symbol: ".concat(n.geometry.type)),null;var s=e.renderingInfo,l=this._getVertexOpacityAndColor(s),u=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){var c=t[0]>t[1]?t[0]:t[1];u=this._getScaleFactor(s,c)}u*=this._symbolTextureRatio;var h=[t[0]*u,t[1]*u],d=this.setGraphicElevationContext(n,new bC);return this.ensureDrapedStatus("on-the-ground"===d.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(n,o,r,l,h,e.layer.uid):this._createAs3DShape(n,o,r,l,h,d,n.uid)}},{key:"layerOpacityChanged",value:function(){var e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial((function(r){r.setParameters({color:e}),r.setParameters({outlineColor:t})}))}},{key:"layerElevationInfoChanged",value:function(e,t,r){var i=this._elevationContext.mode,a=VT(n.elevationModeChangeTypes,r,i);if(a!==jT.UPDATE)return a;var o=BT(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,(function(){return o}))}},{key:"slicePlaneEnabledChanged",value:function(){var e=this;return this.draped||this._forEachMaterial((function(t){t.setParameters({hasSlicePlane:e._context.slicePlaneEnabled})})),!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!!this._getPrimitive()}},{key:"applyRendererDiff",value:function(e,t){for(var r in e.diff){if("visualVariables"!==r)return TC.Recreate_Symbol;if(!Ak(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return TC.Recreate_Symbol;(0,Nu.r)(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return TC.Fast_Update}},{key:"_defaultElevationInfoNoZ",value:function(){return jk}},{key:"_createAs3DShape",value:function(e,t,r,n,i,a,o){var s=this,l=this.getFastUpdateAttrValues(e),u=l?function(e){return Mk(s._fastUpdates.materialParameters,l,e)}:null,c=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:o,layerUid:this._context.layer.uid}),h=[hp(Fk,null,n,i,qk,null,l,c)],d=aS(this._context,t,h,[r],a,this._context.layer.uid,o,u);if(null===d)return null;var f=new xC(this,d.object,h,null,null,JT,a);return f.alignedSampledElevation=d.sampledElevation,f.needsElevationUpdates=BT(a.mode)||"absolute-height"===a.mode,f.getScreenSize=this._createScreenSizeGetter(i,u),f.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(f.getScreenSize(),1,e)},oS(f,t,this._context.elevationProvider),f}},{key:"_createAsOverlay",value:function(e,t,r,n,i,a){var o=this;r.renderPriority=this._renderPriority;var s=(0,lc.n)();(0,Hu.g)(t,s,this._context.overlaySR),s[2]=mA;var l=this._context.clippingExtent;if((0,Nu.r)(l)&&!(0,Gc.E)(l,s))return null;var u=this.getFastUpdateAttrValues(e),c=u?function(e){return Mk(o._fastUpdates.materialParameters,u,e)}:null,h=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),d=hp(Fk,s,n,i,null,null,u,h),f=new Zk(d,r,{layerUid:a,graphicUid:e.uid,calculateShaderTransformation:c});s[3]=0,(0,Vu.B)(f.boundingSphere,s);var p=new YA(this,[f],null,this._context.drapeSourceRenderer);return p.getScreenSize=this._createScreenSizeGetter(i,c),p.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(p.getScreenSize(),1,e)},p}},{key:"_createScreenSizeGetter",value:function(e,t){var r=this._outlineSize+2;if(this._fastUpdates.enabled){var n=e[0]/this._symbolTextureRatio,i=e[1]/this._symbolTextureRatio;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,cc.n)(),a=t(Nk);return e[0]=a[0]*n+r,e[1]=a[5]*i+r,e}}var a=e[0]/this._symbolTextureRatio+r,o=e[1]/this._symbolTextureRatio+r;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,cc.n)();return e[0]=a,e[1]=o,e}}},{key:"_fastVisualVariableConvertOptions",value:function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=(0,Vu.c)(e,e,e),r=(0,zu.e)(1),n=e*r;return{modelSize:t,symbolSize:(0,Vu.c)(n,n,n),unitInMeters:r,transformation:{anchor:Vu.a7,scale:Vu.l,rotation:Vu.a7}}}},{key:"_getGraphicHash",value:function(e){var t,r="",n=(0,Cu.Z)(this._cimRequiredFields);try{for(n.s();!(t=n.n()).done;){var i=t.value;r+=i+e.attributes[i]}}catch(a){n.e(a)}finally{n.f()}return r}},{key:"_forEachMaterial",value:function(e){(0,Nu.r)(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}},{key:"test",value:function(){return(0,Tu.Z)((0,Tu.Z)({},(0,_u.Z)((0,bu.Z)(n.prototype),"test",this).call(this)),{},{material:this._material})}}]),n}(WC);function Gk(e){return!(0,Nu.t)(e)&&("cross"===e||"x"===e)}Bk.PRIMITIVE_SIZE=Vk,Bk.elevationModeChangeTypes={definedChanged:jT.UPDATE,staysOnTheGround:jT.NONE,onTheGroundChanged:jT.RECREATE};var Hk,jk={mode:"relative-to-ground",offset:0},qk=(0,lc.r)(0,0,0,1);function Wk(e){switch(e){case"butt":return DO.BUTT;case"square":return DO.SQUARE;case"round":return DO.ROUND;default:return null}}function Xk(e){return"diamond"===e?"kite":e}function Yk(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=[],n=[];Qk(e,n,r);var i=n[0][1].data,a=r[0][1].length,o=new Array(a).fill(0);return Kk(e,n,r),Jk(e,n,r,o),tE(e,n,r,o),$k(e,n,r,o),eE(e,n,r,o),rE(e,n,r,o),nE(e,n,r,o),iE(e,n,r,i),new dc.M(n,r,vc.a.Line,t)}function Qk(e,t,r){for(var n=e.attributeData.position,i=e.removeDuplicateStartEnd,a=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(n)&&i,o=n.length/3-(a?1:0),s=new Array(2*(o-1)),l=a?(0,Nu.K)(n,0,n.length-3):n,u=0,c=0;c<o-1;c++)s[u++]=c,s[u++]=c+1;t.push([fc.O.POSITION,{size:3,data:l,exclusive:a}]),r.push([fc.O.POSITION,s])}function Kk(e,t,r){var n=e.attributeData.mapPosition;(0,Nu.t)(n)||(r.push([fc.O.MAPPOS,r[0][1]]),t.push([fc.O.MAPPOS,{size:3,data:n}]))}function Jk(e,t,r,n){if(!(0,Nu.r)(e.attributeData.colorFeature)){var i=e.attributeData.color;t.push([fc.O.COLOR,{size:4,data:(0,Nu.v)(i,lc._)}]),r.push([fc.O.COLOR,n])}}function $k(e,t,r,n){if((0,Nu.r)(e.attributeData.normal)){var i=e.attributeData.normal;t.push([fc.O.NORMAL,{size:3,data:i}]),r.push([fc.O.NORMAL,n])}}function eE(e,t,r,n){var i=e.attributeData.colorFeature;(0,Nu.t)(i)||(t.push([fc.O.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),r.push([fc.O.COLOR,n]))}function tE(e,t,r,n){if(!(0,Nu.r)(e.attributeData.sizeFeature)){var i=e.attributeData.size;t.push([fc.O.SIZE,{size:1,data:[(0,Nu.v)(i,1)]}]),r.push([fc.O.SIZE,n])}}function rE(e,t,r,n){var i=e.attributeData.sizeFeature;(0,Nu.t)(i)||(t.push([fc.O.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),r.push([fc.O.SIZEFEATUREATTRIBUTE,n]))}function nE(e,t,r,n){var i=e.attributeData.opacityFeature;(0,Nu.t)(i)||(t.push([fc.O.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),r.push([fc.O.OPACITYFEATUREATTRIBUTE,n]))}function iE(e,t,r,n){if(!(0,Nu.t)(e.overlayInfo)&&e.overlayInfo.renderCoordsHelper.viewingMode===ic.l.Global&&e.overlayInfo.spatialReference.isGeographic){for(var i=new Float64Array(n.length),a=(0,Xu.u)(e.overlayInfo.spatialReference),o=0;o<i.length;o+=3)(0,Hu.a)(n,o,i,o,a);var s=n.length/3,l=new Float32Array(s+1),u=aE,c=oE,h=0,d=0;(0,Vu.o)(u,i[d++],i[d++],i[d++]),l[0]=0;for(var f=1;f<s+1;++f){var p;f===s&&(d=0),(0,Vu.o)(c,i[d++],i[d++],i[d++]),h+=(0,uc.H)(u,c),l[f]=h,u=(p=[c,u])[0],c=p[1]}t.push([fc.O.DISTANCETOSTART,{size:1,data:l}]),r.push([fc.O.DISTANCETOSTART,r[0][1]])}}!function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"}(Hk||(Hk={}));var aE=(0,Vu.n)(),oE=(0,Vu.n)();function sE(e,t){if((0,Nu.t)(e)||0===e.length)return[];var r=[];return e.forEach((function(e){var n=e.length,i=new Float64Array(3*n);e.forEach((function(e,t){i[3*t+0]=e[0],i[3*t+1]=e[1],i[3*t+2]=e[2]}));var a={attributeData:{position:i,normal:t},removeDuplicateStartEnd:!1};r.push(a)})),r}function lE(e,t,r){var n,i=new Array,a=(0,Cu.Z)(e);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=o.index,l=o.count;if(!(l<=1)){var u=3*s,c=u+3*l;i.push({position:t.subarray(u,c),mapPosition:r?r.subarray(u,c):void 0})}}}catch(h){a.e(h)}finally{a.f()}return i}function uE(e){var t=new dc.o,r=e.hasMultipassTerrain&&(e.output===dc.O.Color||e.output===dc.O.Alpha),n=e.space===dO.World;e.hasTip&&n&&t.extensions.add("GL_OES_standard_derivatives"),t.include(wO,e),t.include(ZO,e),e.output===dc.O.Depth&&t.include(dc.at,e);var i=t.vertex,a=t.fragment;return a.include(dc.y),(0,dc.T)(i,e),t.attributes.add(fc.O.POSITION,"vec3"),t.attributes.add(fc.O.UV0,"vec2"),t.attributes.add(fc.O.AUXPOS1,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),(0,dc.au)(t),r&&t.varyings.add("depth","float"),e.hasTip&&t.varyings.add("vLineWidth","float"),i.uniforms.add([new dc.b("nearFar",(function(e,t){return t.camera.nearFar})),new dc.f("viewport",(function(e,t){return t.camera.fullViewport}))]),i.code.add((0,dc.n)(qr||(qr=(0,wu.Z)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),i.code.add((0,dc.n)(Wr||(Wr=(0,wu.Z)(["void clip(vec4 pos, inout vec4 prev) {\nfloat vnp = nearFar[0] * 0.99;\nif (prev.z > -nearFar[0]) {\nfloat interpolation = (-vnp - pos.z) / (prev.z - pos.z);\nprev = mix(pos, prev, interpolation);\n}\n}"])))),n?(t.attributes.add(fc.O.NORMAL,"vec3"),(0,dc.W)(i),i.constants.add("tiltThreshold","float",.7),i.code.add((0,dc.n)(Xr||(Xr=(0,wu.Z)(["vec3 perpendicular(vec3 v) {\nvec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;\nvec3 n2 = cross(v, n);\nvec3 forward = vec3(0.0, 0.0, 1.0);\nfloat tiltDot = dot(forward, n);\nreturn abs(tiltDot) < tiltThreshold ? n : n2;\n}"]))))):i.code.add((0,dc.n)(Yr||(Yr=(0,wu.Z)(["vec2 perpendicular(vec2 v) {\nreturn vec2(v.y, -v.x);\n}"])))),i.code.add((0,dc.n)(Qr||(Qr=(0,wu.Z)(["\n      #define vecN ","\n\n      vecN normalizedSegment(vecN pos, vecN prev) {\n        vecN segment = pos - prev;\n        float segmentLen = length(segment);\n\n        // normalize or zero if too short\n        return (segmentLen > 0.001) ? segment / segmentLen : ",";\n      }\n\n      vecN displace(vecN pos, vecN prev, float displacementLen) {\n        vecN segment = normalizedSegment(pos, prev);\n\n        vecN displacementDirU = perpendicular(segment);\n        vecN displacementDirV = segment;\n\n        ","\n\n        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);\n      }\n    "])),n?"vec3":"vec2",n?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)",e.anchor===fO.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":"")),e.space===dO.Screen&&(i.uniforms.add(new dc.e("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix}))),i.code.add((0,dc.n)(Kr||(Kr=(0,wu.Z)(["vec3 inverseProject(vec4 posScreen) {\nposScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;\nreturn (inverseProjectionMatrix * posScreen).xyz;\n}"])))),i.code.add((0,dc.n)(Jr||(Jr=(0,wu.Z)(["bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {\nfloat cos = dot(rayDir, planeNormal);\nfloat t = dot(planeOrigin, planeNormal) / cos;\nintersection = t * rayDir;\nreturn abs(cos) > 0.001 && t > 0.0;\n}"])))),i.uniforms.add(new dc.g("perScreenPixelRatio",(function(e,t){return t.camera.perScreenPixelRatio}))),i.code.add((0,dc.n)($r||($r=(0,wu.Z)(["\n      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {\n        // Project displaced position back to camera space\n        vec3 displacedPos = inverseProject(displacedPosScreen);\n\n        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally\n        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).\n        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));\n        vec3 planeOrigin = posLeft;\n\n        ",";\n\n        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the\n        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.\n        float offset = lineWidth * perScreenPixelRatio;\n        planeOrigin *= (1.0 - offset);\n\n        // Intersect camera ray with the plane and make sure it is within clip space\n        vec3 rayDir = normalize(displacedPos);\n        vec3 intersection;\n        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {\n          return vec4(intersection.xyz, 1.0);\n        }\n\n        // Fallback: use depth of pos or prev, whichever is closer to the camera\n        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);\n        displacedPos *= minDepth / length(displacedPos);\n        return vec4(displacedPos.xyz, 1.0);\n      }\n  "])),e.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += perpendicular(diff) / 2.0;\n                }\n              ":""))),i.uniforms.add(new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),(0,dc.av)(t),i.code.add((0,dc.n)(en||(en=(0,wu.Z)(["void main(void) {\nif (uv0.y == 0.0) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n}\nelse {\nfloat lineWidth = getLineWidth();\nfloat screenMarkerSize = getScreenMarkerSize();\nvec4 pos  = view * vec4(position.xyz, 1.0);\nvec4 prev = view * vec4(auxpos1.xyz, 1.0);\nclip(pos, prev);"])))),n?(e.hideOnShortSegments&&i.code.add((0,dc.n)(tn||(tn=(0,wu.Z)(["if (areWorldMarkersHidden(pos, prev)) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\nreturn;\n}"])))),i.code.add((0,dc.n)(rn||(rn=(0,wu.Z)(["pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));\nvec4 displacedPosScreen = projectAndScale(pos);"]))))):(i.code.add((0,dc.n)(nn||(nn=(0,wu.Z)(["vec4 posScreen = projectAndScale(pos);\nvec4 prevScreen = projectAndScale(prev);\nvec4 displacedPosScreen = posScreen;\ndisplacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);"])))),e.space===dO.Screen&&i.code.add((0,dc.n)(an||(an=(0,wu.Z)(["vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));\nvec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));\nvec3 lineLeft = pos.xyz + (pos.xyz - lineRight);\npos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);\ndisplacedPosScreen = projectAndScale(pos);"]))))),i.code.add((0,dc.n)(on||(on=(0,wu.Z)(["\n        ","\n        linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n        // Convert back into NDC\n        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;\n\n        // Convert texture coordinate into [0,1]\n        vUV = (uv0 + 1.0) / 2.0;\n\n        ","\n\n        ","\n\n        vSize = screenMarkerSize;\n        vColor = getColor();\n\n        // Use camera space for slicing\n        vpos = pos.xyz;\n\n        gl_Position = displacedPosScreen;\n      }\n    }\n  "])),r?"depth = pos.z;":"",n?"":"vUV *= displacedPosScreen.w;",e.hasTip?"vLineWidth = lineWidth;":"")),r&&t.include(dc.aw,e),t.include(dc.a0,e),a.uniforms.add([new dc.f("intrinsicColor",(function(e){return e.color})),new dc.h("tex",(function(e){return e.texture}))]),a.include(dc.x),t.constants.add("texelSize","float",1/64),a.code.add((0,dc.n)(sn||(sn=(0,wu.Z)(["float markerAlpha(vec2 samplePos) {\nsamplePos += vec2(0.5, -0.5) * texelSize;\nfloat sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;\nfloat distance = sdf * vSize;\ndistance -= 0.5;\nreturn clamp(0.5 - distance, 0.0, 1.0);\n}"])))),e.hasTip&&(t.constants.add("relativeMarkerSize","float",.5),t.constants.add("relativeTipLineWidth","float",.25),a.code.add((0,dc.n)(ln||(ln=(0,wu.Z)(["\n    float tipAlpha(vec2 samplePos) {\n      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker\n      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);\n      samplePos *= vSize;\n\n      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;\n      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);\n\n      ","\n\n      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);\n      return clamp(0.5 - distance, 0.0, 1.0);\n    }\n  "])),n?"halfTipLineWidth *= fwidth(samplePos.y);":""))),t.constants.add("symbolAlphaCutoff","float",dc.a7),a.code.add((0,dc.n)(un||(un=(0,wu.Z)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n\n    vec4 finalColor = intrinsicColor * vColor;\n\n    ","\n\n    ","\n\n    if (finalColor.a < symbolAlphaCutoff) {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),r?"terrainDepthTest(gl_FragCoord, depth);":"",n?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;",e.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);",e.output===dc.O.Alpha?(0,dc.n)(cn||(cn=(0,wu.Z)(["gl_FragColor = vec4(finalColor.a);"]))):"",e.output===dc.O.Color?(0,dc.n)(hn||(hn=(0,wu.Z)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===dc.O.Color&&e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":"",e.output===dc.O.Highlight?(0,dc.n)(dn||(dn=(0,wu.Z)(["gl_FragColor = vec4(1.0);"]))):"",e.output===dc.O.Depth?(0,dc.n)(fn||(fn=(0,wu.Z)(["outputDepth(linearDepth);"]))):"")),t}var cE=Object.freeze(Object.defineProperty({__proto__:null,build:uE},Symbol.toStringTag,{value:"Module"})),hE=new Map([[fc.O.POSITION,0],[fc.O.UV0,2],[fc.O.AUXPOS1,3],[fc.O.NORMAL,4],[fc.O.COLOR,5],[fc.O.COLORFEATUREATTRIBUTE,5],[fc.O.SIZE,6],[fc.O.SIZEFEATUREATTRIBUTE,6],[fc.O.OPACITYFEATUREATTRIBUTE,7]]),dE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),hE)}},{key:"_makePipelineState",value:function(e,t){var r=this.configuration,n=e===vc.o.NONE;return(0,vc.W)({blending:r.output===dc.O.Color||r.output===dc.O.Alpha?n?vc.d:(0,vc.A)(e):null,depthTest:{func:(0,vc.e)(e)},depthWrite:n?r.writeDepth&&vc.b:(0,vc.E)(e),colorWrite:vc._,stencilWrite:r.hasOccludees?dc.ax:null,stencilTest:r.hasOccludees?t?dc.ay:dc.az:null,polygonOffset:{factor:0,units:-10}})}},{key:"initializePipeline",value:function(){return this.configuration.occluder&&(this._occluderPipelineTransparent=(0,vc.W)({blending:vc.d,depthTest:dc.aA,depthWrite:null,colorWrite:vc._,stencilWrite:null,stencilTest:dc.aB}),this._occluderPipelineOpaque=(0,vc.W)({blending:vc.d,depthTest:dc.aA,depthWrite:null,colorWrite:vc._,stencilWrite:dc.aC,stencilTest:dc.aD}),this._occluderPipelineMaskWrite=(0,vc.W)({blending:null,depthTest:dc.aE,depthWrite:null,colorWrite:null,stencilWrite:dc.ax,stencilTest:dc.ay})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===dc.H.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===dc.H.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);dE.shader=new dc.m(cE,(function(){return r.e(4761).then(r.bind(r,54761))}));var fE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new vE))._vertexAttributeLocations=hE,n._configuration=new xO,n._layout=n.createLayout(),n}return(0,ku.Z)(r,[{key:"dispose",value:function(){}},{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.space=t.slot===dc.H.DRAPED_MATERIAL?dO.Draped:this.parameters.worldSpace?dO.World:dO.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==DO.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===dc.ah.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"intersect",value:function(){}},{key:"createLayout",value:function(){var e=(0,wc.T)().vec3f(fc.O.POSITION).vec2f(fc.O.UV0).vec3f(fc.O.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(fc.O.NORMAL),this.parameters.vvSizeEnabled?e.f32(fc.O.SIZEFEATUREATTRIBUTE):e.f32(fc.O.SIZE),this.parameters.vvColorEnabled?e.f32(fc.O.COLORFEATUREATTRIBUTE):e.vec4f(fc.O.COLOR),this.parameters.vvOpacityEnabled&&e.f32(fc.O.OPACITYFEATUREATTRIBUTE),e}},{key:"createBufferWriter",value:function(){return new mE(this._layout,this.parameters)}},{key:"requiresSlot",value:function(e,t){return(t===dc.O.Color||t===dc.O.Alpha||t===dc.O.Highlight||t===dc.O.Depth)&&(e===dc.H.DRAPED_MATERIAL||(this.parameters.renderOccluded===dc.ah.OccludeAndTransparentStencil?e===dc.H.OPAQUE_MATERIAL||e===dc.H.OCCLUDER_MATERIAL||e===dc.H.TRANSPARENT_OCCLUDER_MATERIAL:t===dc.O.Color||t===dc.O.Alpha?e===(this.parameters.writeDepth?dc.H.TRANSPARENT_MATERIAL:dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===dc.H.OPAQUE_MATERIAL))}},{key:"createGLMaterial",value:function(e){return new pE(e)}}]),r}(dc.aa),pE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_updateParameters",value:function(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(dE,e)}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==dc.O.Color&&this._output!==dc.O.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}]),r}(dc.af),vE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).width=0,e.color=[1,1,1,1],e.placement="end",e.cap=DO.BUTT,e.anchor=fO.Center,e.hasTip=!1,e.worldSpace=!1,e.hideOnShortSegments=!1,e.writeDepth=!0,e.hasSlicePlane=!1,e.vvFastUpdate=!1,e.hasOccludees=!1,e}return(0,ku.Z)(r)}(dc.aG),mE=function(){function e(t,r){(0,Au.Z)(this,e),this.vertexBufferLayout=t,this._parameters=r}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(){return"begin-end"===this._parameters.placement?12:6}},{key:"write",value:function(e,t,r,n,i){var a=this,o=r.vertexAttributes.get(fc.O.POSITION).data,s=o.length/3,l=[1,0,0],u=r.vertexAttributes.get(fc.O.NORMAL);this._parameters.worldSpace&&(0,Nu.r)(u)&&(l=u.data);var c=1,h=0;this._parameters.vvSizeEnabled?h=r.vertexAttributes.get(fc.O.SIZEFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(fc.O.SIZE)&&(c=r.vertexAttributes.get(fc.O.SIZE).data[0]);var d=[1,1,1,1],f=0;this._parameters.vvColorEnabled?f=r.vertexAttributes.get(fc.O.COLORFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(fc.O.COLOR)&&(d=r.vertexAttributes.get(fc.O.COLOR).data);var p=0;this._parameters.vvOpacityEnabled&&(p=r.vertexAttributes.get(fc.O.OPACITYFEATUREATTRIBUTE).data[0]);var v,m=new Float32Array(n.buffer),y=i*(this.vertexBufferLayout.stride/4),g=function(e,t,r,n){if(m[y++]=e[0],m[y++]=e[1],m[y++]=e[2],m[y++]=r[0],m[y++]=r[1],m[y++]=t[0],m[y++]=t[1],m[y++]=t[2],a._parameters.worldSpace&&(m[y++]=l[0],m[y++]=l[1],m[y++]=l[2]),a._parameters.vvSizeEnabled?m[y++]=h:m[y++]=c,a._parameters.vvColorEnabled)m[y++]=f;else{var i=Math.min(4*n,d.length-4);m[y++]=d[i+0],m[y++]=d[i+1],m[y++]=d[i+2],m[y++]=d[i+3]}a._parameters.vvOpacityEnabled&&(m[y++]=p)};!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(v||(v={}));var _=function(t,r){var n=(0,Vu.o)(yE,o[3*t],o[3*t+1],o[3*t+2]),i=gE,a=t+r;do{(0,Vu.o)(i,o[3*a],o[3*a+1],o[3*a+2]),a+=r}while((0,Vu.a2)(n,i)&&a>=0&&a<s);e&&((0,Vu.O)(n,n,e),(0,Vu.O)(i,i,e)),g(n,i,[-1,-1],t),g(n,i,[1,-1],t),g(n,i,[1,1],t),g(n,i,[-1,-1],t),g(n,i,[1,1],t),g(n,i,[-1,1],t)},b=this._parameters.placement;"begin"!==b&&"begin-end"!==b||_(0,v.ASCENDING),"end"!==b&&"begin-end"!==b||_(s-1,v.DESCENDING)}}]),e}(),yE=(0,Vu.n)(),gE=(0,Vu.n)(),_E={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},bE={dash:_E.dash,"dash-dot":[].concat((0,mu.Z)(_E.dash),(0,mu.Z)(_E.dot)),dot:_E.dot,"long-dash":_E["long-dash"],"long-dash-dot":[].concat((0,mu.Z)(_E["long-dash"]),(0,mu.Z)(_E.dot)),"long-dash-dot-dot":[].concat((0,mu.Z)(_E["long-dash"]),(0,mu.Z)(_E.dot),(0,mu.Z)(_E.dot)),none:null,"short-dash":_E["short-dash"],"short-dash-dot":[].concat((0,mu.Z)(_E["short-dash"]),(0,mu.Z)(_E["short-dot"])),"short-dash-dot-dot":[].concat((0,mu.Z)(_E["short-dash"]),(0,mu.Z)(_E["short-dot"]),(0,mu.Z)(_E["short-dot"])),"short-dot":_E["short-dot"],solid:null};function xE(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return{pattern:[e,e],pixelRatio:t}}function wE(e){return(0,Nu.r)(e)&&"style"===e.type?function(e){return(0,Nu.r)(e)?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return(0,Nu.t)(e)?e:{pattern:e.slice(),pixelRatio:t}}(bE[e],8):null}(e.style):null}var TE,CE=["polyline","polygon","extent"],SE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){return(0,Au.Z)(this,r),t.call(this,e,n,i,a)}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Rk(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},this._drivenProperties.size){e.next=3;break}if(!((null!=this.symbolLayer.size?this.symbolLayer.size:(0,zu.e)(1))<0)){e.next=3;break}throw new Eu.s("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");case 3:this._markerTexture=(0,Nu.r)(this.symbolLayer.marker)&&(0,Nu.r)(this._context.sharedResources.textures)?LO(this._context.sharedResources.textures,Xk(this.symbolLayer.marker.style)):null;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getMaterialParameters",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._getCombinedOpacityAndColor(r&&this._markerColor||this._materialColor);this._patternHidesLine&&!r&&(n[3]=0);var i={width:this._computeMaterialWidth(null===(t=this.symbolLayer)||void 0===t?void 0:t.size),color:n,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Wk(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:wE(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?(0,Tu.Z)((0,Tu.Z)({},i),this._fastUpdates.materialParameters):i}},{key:"_materialColor",get:function(){return(0,Nu.n)(this.symbolLayer.material,(function(e){return e.color}))}},{key:"_markerColor",get:function(){return(0,Nu.n)(this.symbolLayer.marker,(function(e){return e.color}))}},{key:"_lineMaterial",get:function(){return(0,Nu.t)(this._lineMaterialCached)&&(this._lineMaterialCached=new jO(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}},{key:"_ringMaterial",get:function(){return(0,Nu.t)(this._ringMaterialCached)&&(this._ringMaterialCached=new jO(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}},{key:"_wireframeLineMaterial",get:function(){return(0,Nu.t)(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new jO((0,Tu.Z)((0,Tu.Z)({},this._getMaterialParameters(!1)),{},{wireframe:!0})),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}},{key:"_wireframeRingMaterial",get:function(){return(0,Nu.t)(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new jO((0,Tu.Z)((0,Tu.Z)({},this._getMaterialParameters(!0)),{},{wireframe:!0})),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}},{key:"_markerMaterial",get:function(){return(0,Nu.t)(this._markerMaterialCached)&&(0,Nu.r)(this.symbolLayer.marker)&&(0,Nu.r)(this._markerTexture)&&(this._markerMaterialCached=new fE((0,Tu.Z)((0,Tu.Z)({},this._getMaterialParameters(!1,!0)),{},{placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id})),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}},{key:"destroy",value:function(){var e=this;(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._forEachMaterial((function(t){return e._context.stage.remove(t)})),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=(0,Nu.F)(this._markerTexture)}},{key:"_getDrivenSize",value:function(e){return this._drivenProperties.size&&e.size?(0,zu.u)(function(e){for(var t=0;t<3;t++){var r=e[t];if("number"==typeof r)return isFinite(r)?r:0}return 0}(e.size)):1}},{key:"_getSizeFeatureAttributeData",value:function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?XC(this._fastUpdates.visualVariables.size.field,e):null}},{key:"_getDrivenColor",value:function(e){var t=(0,lc.r)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}},{key:"_getColorFeatureAttributeData",value:function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?XC(this._fastUpdates.visualVariables.color.field,e):null}},{key:"_getOpacityFeatureAttributeData",value:function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?XC(this._fastUpdates.visualVariables.opacity.field,e):null}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,CE,this.symbolLayer.type))return null;var r=this.setGraphicElevationContext(t,new bC);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,t.uid)}},{key:"applyRendererDiff",value:function(e,t){var r=this;for(var n in e.diff){if("visualVariables"!==n)return TC.Recreate_Symbol;if(!Ak(this._fastUpdates,t,this._vvConvertOptions))return TC.Recreate_Symbol;this._forEachMaterial((function(e){return e.setParameters(r._fastUpdates.materialParameters)}))}return TC.Fast_Update}},{key:"prepareSymbolLayerPatch",value:function(e){var t,r,n=this;if("partial"===e.diff.type){var i=e.diff.diff,a={};"complete"===(null===(t=i.size)||void 0===t?void 0:t.type)&&(a.width=this._computeMaterialWidth(i.size.newValue),delete i.size),"complete"===(null===(r=i.cap)||void 0===r?void 0:r.type)&&(a.cap=Wk((0,Nu.v)(i.cap.newValue,"butt")),delete i.cap);var o=this._prepareMarkerPatch(e,i);this._prepareMaterialPatch(e,i,o),e.symbolLayerStatePatches.push((function(){return n._forEachMaterial((function(e){return e.setParameters(a)}))}))}}},{key:"layerOpacityChanged",value:function(){var e=this;this._forEachMaterial((function(t,r){return e._updateMaterialLayerOpacity(t,r)}))}},{key:"_forEachMaterial",value:function(e){(0,Nu.r)(this._lineMaterialCached)&&e(this._lineMaterialCached),(0,Nu.r)(this._ringMaterialCached)&&e(this._ringMaterialCached),(0,Nu.r)(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),(0,Nu.r)(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),(0,Nu.r)(this._markerMaterialCached)&&e(this._markerMaterialCached,!0)}},{key:"_updateMaterialLayerOpacity",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.parameters.color,n=(0,Nu.q)(this.symbolLayer,"material","color"),i=this._patternHidesLine&&!t?0:this._getCombinedOpacity(n),a=(0,lc.r)(r[0],r[1],r[2],i);e.setParameters({color:a})}},{key:"layerElevationInfoChanged",value:function(e,t,n){var i=this._elevationContext.mode,a=VT(r.elevationModeChangeTypes,n,i);if(a!==jT.UPDATE)return a;var o=BT(i);return this.updateGraphics3DGraphicElevationInfo(e,t,(function(){return o}))}},{key:"slicePlaneEnabledChanged",value:function(){var e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((function(t){return t.setParameters(e)})),!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"_getGeometryAsPolygonOrPolyline",value:function(e){switch(e.type){case"extent":if(e instanceof tc.w)return Mu.v.fromExtent(e);break;case"polygon":case"polyline":return e}return null}},{key:"_createAs3DShape",value:function(e,t,r){var n=e.graphic,i=this._getGeometryAsPolygonOrPolyline(n.geometry),a="polygon"===i.type?i.rings:i.paths,o=new Array,s=new Array,l=new Array,u=(0,Gc.a)(),c=function(e,t,r,n){var i="polygon"===e.type?eh.c.CCW_IS_HOLE:eh.c.NONE,a="polygon"===e.type?e.rings:e.paths,o=(0,eh.l)(a,e.hasZ,i),s=o.position,l=o.outlines,u=new Float64Array(s.length),c=FT(s,e.spatialReference,0,u,0,s,0,s.length/3,t,r,n),h=null!=c;return{lines:h?lE(l,s,u):[],projectionSuccess:h,sampledElevation:c}}(i,this._context.elevationProvider,this._context.renderCoordsHelper,t),h="polygon"===i.type?"rings":"paths";this._logGeometryCreationWarnings(c,a,h,"LineSymbol3DLayer");for(var d=0;d<c.lines.length;d++){var f=c.lines[d],p=f.position,v=f.mapPosition;if(!(0,Nu.r)(this._context.clippingExtent)||((0,Gc.A)(u),(0,Gc.M)(u,v),(0,Gc.R)(u,this._context.clippingExtent))){var m=this._createGeometry(e,p,v,i.type,TE.ELEVATED,r);o.push(m),s.push("polygon"===i.type?this._ringMaterial:this._lineMaterial),l.push(hc.o),Ac.t.LINE_WIREFRAMES&&(o.push(m.cloneShallow()),s.push("polygon"===i.type?this._wireframeRingMaterial:this._wireframeLineMaterial),l.push(hc.o));var y=this._markerMaterial;(0,Nu.r)(y)&&(o.push(m.cloneShallow()),s.push(y),l.push(hc.o))}}if(0===o.length)return null;var g=new tS({geometries:o,materials:s,transformations:l,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),_=new xC(this,g,o,null,null,tC,t);return _.alignedSampledElevation=c.sampledElevation,_.needsElevationUpdates=BT(t.mode),_}},{key:"_createGeometry",value:function(e,t,r,n,i,a){var o="polygon"===n,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,u=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid});return Yk({overlayInfo:i===TE.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:o,attributeData:{position:t,mapPosition:r,size:l?null:this._getDrivenSize(e.renderingInfo),color:s?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}},u)}},{key:"_createAsOverlay",value:function(e,t){var r=this,n=e.graphic,i=this._getGeometryAsPolygonOrPolyline(n.geometry),a="polygon"===i.type?i.rings:i.paths,o="polygon"===i.type?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;var s=Ac.t.LINE_WIREFRAMES?"polygon"===i.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;(0,Nu.r)(s)&&(s.renderPriority=this._renderPriority-.001),(0,Nu.r)(l)&&(l.renderPriority=this._renderPriority-.002);var u=new Array,c=(0,Gc.a)(),h=(0,Gc.A)(),d=function(e,t){for(var r="polygon"===e.type?eh.c.CCW_IS_HOLE:eh.c.NONE,n="polygon"===e.type?e.rings:e.paths,i=(0,eh.l)(n,!1,r),a=i.position,o=i.outlines,s=(0,Hu.x)(a,e.spatialReference,0,a,t,0,a.length/3),l=2;l<a.length;l+=3)a[l]=mA;return{lines:s?lE(o,a):[],projectionSuccess:s}}(i,this._context.overlaySR),f="polygon"===i.type?"rings":"paths";this._logGeometryCreationWarnings(d,a,f,"LineSymbol3DLayer");var p,v=(0,Cu.Z)(d.lines);try{var m=function(){var a=p.value;if((0,Gc.A)(c),(0,Gc.M)(c,a.position),!(0,Gc.R)(c,r._context.clippingExtent))return"continue";(0,Gc.f)(h,c);var d=r._createGeometry(e,a.position,null,i.type,TE.DRAPED,n.uid),f=function(e){var r=new Zk(d,e,{layerUid:t,graphicUid:n.uid});return u.push(r),r};if((0,Nu.r)(l)){var v=f(l),m=(0,Nu.e)(r.symbolLayer.marker).placement;"begin"!==m&&"begin-end"!==m||(0,Gc.M)(c,a.position,0,1),"end"!==m&&"begin-end"!==m||(0,Gc.M)(c,a.position,a.position.length-3,1),r._updateBoundingSphere(v,c)}var y=f(o);if(r._updateBoundingSphere(y,c),Ac.t.LINE_WIREFRAMES){var g=f(s);r._updateBoundingSphere(g,c)}};for(v.s();!(p=v.n()).done;)m()}catch(y){v.e(y)}finally{v.f()}return new YA(this,u,h,this._context.drapeSourceRenderer)}},{key:"_updateBoundingSphere",value:function(e,t){(0,Vu.C)(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))}},{key:"_patternHidesLine",get:function(){var e=this.symbolLayer.pattern;return(0,Nu.r)(e)&&"style"===e.type&&"none"===e.style}},{key:"_computeMaterialWidth",value:function(e){return e=(0,Nu.v)(e,(0,zu.e)(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?(0,zu.u)(1):1:(0,zu.u)(e)}},{key:"_prepareMaterialPatch",value:function(e,t,r){var n=t.material;if((0,Nu.t)(n))r.changed&&r.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e);else if("collection"!==n.type){var i="complete"===n.type?(0,Nu.n)(n.newValue,(function(e){return e.color})):"complete"===n.diff.color.type?n.diff.color.newValue:null,a=this._getCombinedOpacityAndColor(i);r.useMaterialColor&&this._patchMaterialColor((0,lc.t)(a),this._markerMaterialCached,e),this._patternHidesLine&&(a[3]=0),this._patchMaterialColor(a,this._lineMaterialCached,e),delete t.material}}},{key:"_prepareMarkerPatch",value:function(e,t){var r=t.marker;if((0,Nu.t)(r)||"partial"!==r.type||(0,Nu.r)(r.diff.style)||(0,Nu.r)(r.diff.placement)||(0,Nu.r)(r.diff.color)&&"complete"!==r.diff.color.type)return{changed:!1,useMaterialColor:(0,Nu.t)(this._markerColor)};var n=r.diff.color;if((0,Nu.t)(n))return delete t.marker,{changed:!1,useMaterialColor:(0,Nu.t)(this._markerColor)};var i=(0,Nu.e)(n.newValue);return(0,Nu.t)(i)?(delete t.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(i),this._markerMaterialCached,e),delete t.marker,{changed:!0,useMaterialColor:!1})}},{key:"_patchMaterialColor",value:function(e,t,r){(0,Nu.t)(t)||r.symbolLayerStatePatches.push((function(){return t.setParameters({color:e})}))}}]),r}(WC);function OE(e){var t=new dc.o,r=t.vertex,n=t.fragment;return t.include(dc.K,e),t.include(dc.aU,e),t.include(kO,e),(0,dc.T)(r,e),e.stippleEnabled&&(t.attributes.add(fc.O.UV0,"vec2"),t.attributes.add(fc.O.AUXPOS1,"vec3"),r.uniforms.add(new dc.f("viewport",(function(e,t){return t.camera.fullViewport})))),t.attributes.add(fc.O.POSITION,"vec3"),t.varyings.add("vpos","vec3"),r.code.add((0,dc.n)(pn||(pn=(0,wu.Z)(["void main(void) {\nvpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);"])))),e.stippleEnabled&&(r.code.add((0,dc.n)(vn||(vn=(0,wu.Z)(["vec4 vpos2 = transformPosition(proj, view, auxpos1);\nvec2 ndcToPixel = viewport.zw * 0.5;\nfloat lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);"])))),e.draped?r.uniforms.add(new dc.g("worldToScreenRatio",(function(e,t){return 1/t.screenToPCSRatio}))):r.code.add((0,dc.n)(mn||(mn=(0,wu.Z)(["vec3 segmentCenter = (position + auxpos1) * 0.5;\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),r.code.add((0,dc.n)(yn||(yn=(0,wu.Z)(["float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);"])))),e.draped?r.code.add((0,dc.n)(gn||(gn=(0,wu.Z)(["float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);\nfloat segmentLengthPseudoScreen = lineSegmentPixelSize;"])))):r.code.add((0,dc.n)(_n||(_n=(0,wu.Z)(["float segmentLengthRender = length(position - auxpos1);\nfloat startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),r.uniforms.add(new dc.g("stipplePatternPixelSize",(function(e){return EO(e)}))),r.code.add((0,dc.n)(bn||(bn=(0,wu.Z)(["vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);\nvStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);\nvStippleDistance *= gl_Position.w;"]))))),r.code.add((0,dc.n)(xn||(xn=(0,wu.Z)(["}"])))),e.output===dc.O.Highlight&&t.include(dc.a9,e),t.include(dc.a0,e),n.uniforms.add(new dc.g("alphaCoverage",(function(e,t){return Math.min(1,e.width*t.camera.pixelRatio)}))),e.hasVertexColors||n.uniforms.add(new dc.f("constantColor",(function(e){return e.color}))),n.code.add((0,dc.n)(wn||(wn=(0,wu.Z)(["\n  void main() {\n    discardBySlice(vpos);\n\n    vec4 color = ",";\n\n    float stippleAlpha = getStippleAlpha();\n    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);\n\n    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);\n\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n  }\n  "])),e.hasVertexColors?"vColor":"constantColor",dc.n.float(dc.a7),e.output===dc.O.Color?(0,dc.n)(Tn||(Tn=(0,wu.Z)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===dc.O.Highlight?(0,dc.n)(Cn||(Cn=(0,wu.Z)(["outputHighlight();"]))):"")),t}SE.elevationModeChangeTypes={definedChanged:jT.RECREATE,staysOnTheGround:jT.NONE,onTheGroundChanged:jT.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(TE||(TE={}));var PE=Object.freeze(Object.defineProperty({__proto__:null,build:OE},Symbol.toStringTag,{value:"Module"})),RE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_stippleEnabled",get:function(){return this.configuration.stippleEnabled&&this.configuration.output!==dc.O.Highlight}},{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){var e=this.configuration,t=(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),r=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,vc.W)({blending:r,depthTest:dc.aE,depthWrite:n,colorWrite:vc._,stencilWrite:e.hasOccludees?dc.ax:null,stencilTest:e.hasOccludees?t?dc.ay:dc.az:null})};return e.output===dc.O.Color?(this._occludeePipelineState=r(!0,e.transparent||this._stippleEnabled?t:null,vc.b),r(!1,e.transparent||this._stippleEnabled?t:null,vc.b)):r(!1)}},{key:"primitiveType",get:function(){return pc.E.LINES}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);RE.shader=new dc.m(PE,(function(){return r.e(145).then(r.bind(r,30145))}));var AE,kE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.hasSlicePlane=!1,e.hasVertexColors=!1,e.transparent=!1,e.draped=!1,e.stippleEnabled=!1,e.stippleOffColorEnabled=!1,e.stipplePreferContinuous=!0,e.hasOccludees=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],kE.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"hasVertexColors",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"transparent",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"draped",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"stippleEnabled",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"stippleOffColorEnabled",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"stipplePreferContinuous",void 0),(0,Eu.e)([(0,dc.p)()],kE.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],kE.prototype,"stippleRequiresClamp",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],kE.prototype,"stippleScaleWithLineWidth",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],kE.prototype,"stippleRequiresStretchMeasure",void 0),function(e){e[e.START=0]="START",e[e.END=1]="END"}(AE||(AE={}));var EE,DE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new LE))._configuration=new kE,n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===dc.H.DRAPED_MATERIAL;var r=(0,Nu.r)(this.parameters.stipplePattern);return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&(0,Nu.r)(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}},{key:"intersect",value:function(e,t,r,n,i,a,o,s,l){(0,Nu.r)(l)?(0,dc.aV)(e,n,l,a,1,o):this._intersectLineGeometry(e,t,r,n,o)}},{key:"_intersectLineGeometry",value:function(e,t,r,n,i){if(n.options.selectionMode&&!(0,Ic.a)(t))if((0,Sc.a)(r)){var a=e.vertexAttributes.get(fc.O.POSITION).data,o=n.camera,s=qE;(0,uc.a)(s,n.point);(0,Vu.o)(WE[0],s[0]-2,s[1]+2,0),(0,Vu.o)(WE[1],s[0]+2,s[1]+2,0),(0,Vu.o)(WE[2],s[0]+2,s[1]-2,0),(0,Vu.o)(WE[3],s[0]-2,s[1]-2,0);for(var l=0;l<4;l++)if(!o.unprojectFromRenderScreen(WE[l],XE[l]))return;(0,Tc.j)(o.eye,XE[0],XE[1],YE),(0,Tc.j)(o.eye,XE[1],XE[2],QE),(0,Tc.j)(o.eye,XE[2],XE[3],KE),(0,Tc.j)(o.eye,XE[3],XE[0],JE);for(var u=Number.MAX_VALUE,c=0,h=0;h<a.length-5;h+=3)if(ZE[0]=a[h]+r[12],ZE[1]=a[h+1]+r[13],ZE[2]=a[h+2]+r[14],NE[0]=a[h+3]+r[12],NE[1]=a[h+4]+r[13],NE[2]=a[h+5]+r[14],!((0,Tc.R)(YE,ZE)<0&&(0,Tc.R)(YE,NE)<0||(0,Tc.R)(QE,ZE)<0&&(0,Tc.R)(QE,NE)<0||(0,Tc.R)(KE,ZE)<0&&(0,Tc.R)(KE,NE)<0||(0,Tc.R)(JE,ZE)<0&&(0,Tc.R)(JE,NE)<0)){if(o.projectToRenderScreen(ZE,UE),o.projectToRenderScreen(NE,VE),UE[2]<0&&VE[2]>0){(0,Vu.e)(FE,ZE,NE);var d=o.frustum,f=-(0,Tc.R)(d[kc.U.NEAR],ZE)/(0,Vu.P)(FE,(0,Tc.Y)(d[kc.U.NEAR]));(0,Vu.g)(FE,FE,f),(0,Vu.u)(ZE,ZE,FE),o.projectToRenderScreen(ZE,UE)}else if(UE[2]>0&&VE[2]<0){(0,Vu.e)(FE,NE,ZE);var p=o.frustum,v=-(0,Tc.R)(p[kc.U.NEAR],NE)/(0,Vu.P)(FE,(0,Tc.Y)(p[kc.U.NEAR]));(0,Vu.g)(FE,FE,v),(0,Vu.u)(NE,NE,FE),o.projectToRenderScreen(NE,VE)}else if(UE[2]<0&&VE[2]<0)continue;UE[2]=0,VE[2]=0;var m=(0,Sc.M)((0,Sc.b)(UE,VE,HE),s);m<u&&(u=m,(0,Vu.r)(BE,ZE),(0,Vu.r)(GE,NE),c=h/3)}var y=n.rayBegin,g=n.rayEnd;if(u<4){var _=Number.MAX_VALUE;if((0,Sc.c)((0,Sc.b)(BE,GE,HE),(0,Sc.b)(y,g,jE),zE)){(0,Vu.e)(zE,zE,y);var b=(0,Vu.s)(zE);(0,Vu.g)(zE,zE,1/b),_=b/(0,Vu.x)(y,g)}i(_,zE,c,!1)}}else Eu.a.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix")}},{key:"computeAttachmentOrigin",value:function(e,t){var r=e.vertexAttributes;if(!r)return!1;var n=r.get(fc.O.POSITION);return(0,dc.aF)(n,null,!1,t)}},{key:"requiresSlot",value:function(e,t){return!(t!==dc.O.Color&&t!==dc.O.Highlight&&t!==dc.O.ObjectAndLayerIdColor||e!==dc.H.OPAQUE_MATERIAL&&e!==dc.H.DRAPED_MATERIAL)}},{key:"createGLMaterial",value:function(e){return new ME(e)}},{key:"createBufferWriter",value:function(){var e=this.parameters.hasVertexColors?RR:OR;return(0,Nu.t)(this.parameters.stipplePattern)?new kR(e):new IE(e.clone().vec3f(fc.O.AUXPOS1).vec2f(fc.O.UV0))}}]),r}(dc.aa),ME=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._stipplePattern=null,e}return(0,ku.Z)(r,[{key:"dispose",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"dispose",this).call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){this._output===dc.O.Color&&this._updateOccludeeState(e);var t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(RE,e)}}]),r}(dc.aq),IE=function(){function e(t){(0,Au.Z)(this,e),this.vertexBufferLayout=t}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(fc.O.POSITION).length}},{key:"write",value:function(e,t,r,n,i){(0,dc.aM)(r,this.vertexBufferLayout,e,t,n,i),this._writeAuxpos1(e,r,n,i),this._writeUV0(e,r,n,i)}},{key:"_writeAuxpos1",value:function(e,t,r,n){var i=r.getField(fc.O.AUXPOS1,Zc.i),a=t.indices.get(fc.O.POSITION),o=t.vertexAttributes.get(fc.O.POSITION).data,s=e,l=i.typedBufferStride,u=i.typedBuffer;n*=l;for(var c=0;c<a.length-1;c+=2)for(var h=0,d=[1,0];h<d.length;h++){var f=3*a[c+d[h]],p=o[f],v=o[f+1],m=o[f+2],y=s[0]*p+s[4]*v+s[8]*m+s[12],g=s[1]*p+s[5]*v+s[9]*m+s[13],_=s[2]*p+s[6]*v+s[10]*m+s[14];u[n]=y,u[n+1]=g,u[n+2]=_,n+=l}}},{key:"_writeUV0",value:function(e,t,r,n){var i,a=r.getField(fc.O.UV0,Zc.u),o=t.indices.get(fc.O.POSITION),s=t.vertexAttributes.get(fc.O.POSITION).data,l=null===(i=t.vertexAttributes.get(fc.O.DISTANCETOSTART))||void 0===i?void 0:i.data,u=a.typedBufferStride,c=a.typedBuffer,h=0;c[n*=u]=AE.START,c[n+1]=h,n+=u;var d=3*o[0],f=(0,Vu.o)(ZE,s[d],s[d+1],s[d+2]);e&&(0,Vu.O)(f,f,e);for(var p=NE,v=o.length-1,m=1,y=l?function(e,t,r){return h=l[r]}:function(e,t,r){return h+=(0,Vu.x)(e,t)},g=1;g<v;g+=2){var _=3*o[g];(0,Vu.o)(p,s[_],s[_+1],s[_+2]),e&&(0,Vu.O)(p,p,e),y(f,p,m++);for(var b=0;b<2;++b)c[n]=1-b,c[n+1]=h,n+=u;(0,Vu.r)(f,p)}var x=3*o[v];(0,Vu.o)(p,s[x],s[x+1],s[x+2]),e&&(0,Vu.O)(p,p,e),y(f,p,m),c[n]=AE.END,c[n+1]=h}}]),e}(),LE=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).color=lc._,e.hasVertexColors=!1,e.hasSlicePlane=!1,e.width=1,e.stipplePreferContinuous=!0,e.hasOccludees=!1,e.stippleTexture=null,e}return(0,ku.Z)(r)}(dc.ar),ZE=(0,Vu.n)(),NE=(0,Vu.n)(),FE=(0,Vu.n)(),zE=(0,Vu.n)(),UE=(0,zu.x)(),VE=(0,zu.x)(),BE=(0,Vu.n)(),GE=(0,Vu.n)(),HE=(0,Sc.v)(),jE=(0,Sc.v)(),qE=(0,Vu.n)(),WE=[(0,zu.x)(),(0,zu.x)(),(0,zu.x)(),(0,zu.x)()],XE=[(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)()],YE=(0,Tc.p)(),QE=(0,Tc.p)(),KE=(0,Tc.p)(),JE=(0,Tc.p)(),$E=["mesh"],eD=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a))._materials=new Map,o._textures=new Map,o.ensureDrapedStatus(!1),o}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Ac.t.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new DE({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new DE({color:[0,1,1,1]}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._context.stage.removeMany(Array.from(this._materials.values(),(function(e){return e.material}))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,$E,"fill on mesh-3d"))return null;var r=this.setGraphicElevationContext(t,new bC),n=e.renderingInfo;return this._createAs3DShape(t,n,r,t.uid)}},{key:"layerOpacityChanged",value:function(e,t){var r=this,n=this._getLayerOpacity();this._materials.forEach((function(e){e.material.setParameters({layerOpacity:n});var t=e.material.parameters;r._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((function(e){var i=t(e);(0,Nu.r)(i)&&i.layerOpacityChanged(n,r._context.isAsync)}))}},{key:"layerElevationInfoChanged",value:function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,GT)}},{key:"slicePlaneEnabledChanged",value:function(e,t){var r=this;return this._materials.forEach((function(e){e.material.setParameters({hasSlicePlane:r._context.slicePlaneEnabled})})),e.forEach((function(e){var n=t(e);(0,Nu.r)(n)&&n.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)})),!0}},{key:"physicalBasedRenderingChanged",value:function(){var e=this._usePBR();return this._materials.forEach((function(t){return t.material.setParameters({usePBR:e})})),!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"_requiresSymbolVertexColors",value:function(){return this._drivenProperties.color||this._drivenProperties.opacity}},{key:"_colorOrTextureUid",value:function(e){return(0,Nu.t)(e)?"-":e instanceof sc.l?e.toHex():e.contentHash}},{key:"_materialPropertiesDefault",value:function(e,t){var r=this._requiresSymbolVertexColors(),n=!!e.vertexAttributes.color,i=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:n,hasVertexTangents:i,uid:"vc:".concat(n,",vt:").concat(i,",vct").concat(t,",svc:").concat(r)}}},{key:"_materialProperties",value:function(e,t,r){var n=this._materialPropertiesDefault(e,r);if(!t.material)return n;var i=t.material,a=i.color,o=i.colorTexture,s=i.normalTexture,l=i.doubleSided,u=i.alphaCutoff,c=i.alphaMode,h=this._colorOrTextureUid(a),d=this._colorOrTextureUid(o),f=this._colorOrTextureUid(s);if(n.color=a,n.colorTexture=o,n.normalTexture=s,n.uid="".concat(n.uid,",cmuid:").concat(h,",ctmuid:").concat(d,",ntmuid:").concat(f,",ds:").concat(l,",ac:").concat(u,",am:").concat(c),t.material instanceof eh.a){var p=t.material,v=p.metallic,m=p.roughness,y=p.metallicRoughnessTexture,g=p.emissiveColor,_=p.emissiveTexture,b=p.occlusionTexture,x=this._colorOrTextureUid(y),w=this._colorOrTextureUid(g),T=this._colorOrTextureUid(_),C=this._colorOrTextureUid(b);n.metallic=v,n.roughness=m,n.metallicRoughnessTexture=y,n.emissiveColor=g,n.emissiveTexture=_,n.occlusionTexture=b,n.colorTextureTransform=t.material.colorTextureTransform,n.normalTextureTransform=t.material.normalTextureTransform,n.emissiveTextureTransform=t.material.emissiveTextureTransform,n.occlusionTextureTransform=t.material.occlusionTextureTransform,n.metallicRoughnessTextureTransform=t.material.metallicRoughnessTextureTransform,n.uid="".concat(n.uid,",mrm:").concat(v,",mrr:").concat(m,",mrt:").concat(x,",emuid:").concat(w,",etmuid:").concat(T,",otmuid:").concat(C)}return n}},{key:"_setInternalColorValueParameters",value:function(e,t){t.diffuse=sc.l.toUnitRGB(e),t.opacity=e.a}},{key:"_getLoadableTextureResource",value:function(e){return e.data?e.data:e.url}},{key:"_getInternalTextureId",value:function(e){var t=this._getInternalTexture(e,vc.C.Opaque);return(0,Nu.r)(t)?t.id:null}},{key:"_getInternalTexture",value:function(e,t){var r=this._getLoadableTextureResource(e);if(!r)return null;var n="".concat(e.contentHash,"/").concat(t),i=this._textures.get(n);return i||(i=new dc.Y(r,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:t!==vc.C.Opaque}),this._textures.set(n,i),this._context.stage.add(i),this._context.stage.loadImmediate(i)),i}},{key:"_castTextureWrap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"repeat";if("string"==typeof e){var t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}},{key:"_castTextureWrapIndividual",value:function(e){switch(e){case"clamp":return pc.D.CLAMP_TO_EDGE;case"mirror":return pc.D.MIRRORED_REPEAT;default:return pc.D.REPEAT}}},{key:"_setInternalMaterialParameters",value:function(e,t){if((0,Nu.r)(e.color)&&this._setInternalColorValueParameters(e.color,t),(0,Nu.r)(e.colorTexture)){var r=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);(0,Nu.r)(r)?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):t.textureId=void 0}(0,Nu.r)(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),(0,Nu.r)(e.emissiveColor)&&(t.emissiveFactor=sc.l.toUnitRGB(e.emissiveColor)),(0,Nu.r)(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),(0,Nu.r)(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),(0,Nu.r)(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),t.colorTextureTransformMatrix=(0,dc.aW)(e.colorTextureTransform),t.normalTextureTransformMatrix=(0,dc.aW)(e.normalTextureTransform),t.occlusionTextureTransformMatrix=(0,dc.aW)(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=(0,dc.aW)(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=(0,dc.aW)(e.metallicRoughnessTextureTransform)}},{key:"_setExternalMaterialParameters",value:function(e){var t=this._drivenProperties.color,r=(0,Nu.r)(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=lc._;else{var n=(0,Nu.r)(this.symbolLayer.material)?this.symbolLayer.material.color:null;(0,Nu.r)(n)?e.externalColor=sc.l.toUnitRGBA(n):(r=null,e.externalColor=lc._)}r&&(e.colorMixMode=r),e.castShadows=!!this.symbolLayer.castShadows}},{key:"_hasTransparentVertexColors",value:function(e){var t=e.vertexAttributes.color;if((0,Nu.t)(t))return!1;for(var r=3;r<t.length;r+=4)if(255!==t[r])return!0;return!1}},{key:"_getOrCreateMaterial",value:function(e,t){var r,n,i,a=null===(r=t.material)||void 0===r?void 0:r.color,o=null===(n=t.material)||void 0===n?void 0:n.colorTexture,s=null===(i=t.material)||void 0===i?void 0:i.alphaMode,l="blend"===s,u=!("opaque"===s)&&(this._hasTransparentVertexColors(e)||(0,Nu.r)(a)&&a.a<1||(0,Nu.r)(o)&&o.transparent||l),c=this._materialProperties(e,t,u),h=this._materials.get(c.uid);if(h)return h.material;var d={material:null,isComponentTransparent:u,alphaMode:t.material?t.material.alphaMode:"opaque"},f=null==c.metallicRoughnessTexture&&null==c.metallic&&null==c.roughness,p={usePBR:this._usePBR(),isSchematic:f,hasVertexColors:c.hasVertexColors,hasSymbolColors:c.hasSymbolVertexColors,hasVertexTangents:c.hasVertexTangents,ambient:Vu.a7,diffuse:Vu.l,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:vc.n.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};f||(p.mrrFactors=[null!=c.metallic?c.metallic:1,null!=c.roughness?c.roughness:1,.5]),t.material&&(p.doubleSided=t.material.doubleSided,p.cullFace=t.material.doubleSided?vc.n.None:vc.n.Back,p.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(p),this._setMaterialTransparentParameter(p,d),this._setInternalMaterialParameters(c,p);var v=new dc.aS(p);return d.material=v,this._materials.set(c.uid,d),this._context.stage.add(v),v}},{key:"_usePBR",value:function(){return this._context.physicalBasedRenderingEnabled}},{key:"_setMaterialTransparentParameter",value:function(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?vc.C.MaskBlend:vc.C.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?vc.C.Opaque:"mask"===t.alphaMode?vc.C.Mask:vc.C.Blend}},{key:"_addDebugNormals",value:function(e,t,r,n){for(var i=t.length,a=e.spatialReference.isGeographic?20015077/180:1,o=.1*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),s=[],l=[],u=[],c=[],h=0;h<i;h++)for(var d=t[h],f=d.vertexAttributes.get(fc.O.POSITION),p=d.vertexAttributes.get(fc.O.NORMAL),v=d.indices.get(fc.O.POSITION),m=d.indices.get(fc.O.NORMAL),y=f.data,g=p.data,_=0;_<v.length;_++){for(var b=3*v[_],x=3*m[_],w=0;w<3;w++)s.push(y[b+w]);for(var T=0;T<3;T++)s.push(y[b+T]+g[x+T]*o);if(l.push(l.length),l.push(l.length),_%3==0){this._calculateFaceNormal(y,v,_,aD),this._getFaceVertices(y,v,_,rD,nD,iD),(0,Vu.u)(rD,rD,nD),(0,Vu.u)(rD,rD,iD),(0,Vu.g)(rD,rD,1/3);for(var C=0;C<3;C++)u.push(rD[C]);for(var S=0;S<3;S++)u.push(rD[S]+aD[S]*o);c.push(c.length),c.push(c.length)}}var O=new dc.M([[fc.O.POSITION,{data:s,size:3,exclusive:!0}]],[[fc.O.POSITION,l]],vc.a.Line);t.push(O),r.push(this._debugVertexNormalMaterial),n.push((0,hc.r)(n[0]));var P=new dc.M([[fc.O.POSITION,{data:u,size:3,exclusive:!0}]],[[fc.O.POSITION,c]],vc.a.Line);t.push(P),r.push(this._debugFaceNormalMaterial),n.push((0,hc.r)(n[0]))}},{key:"_createAs3DShape",value:function(e,t,r,n){var i=e.geometry;if("mesh"!==i.type)return null;var a=this._createGeometryInfo(i,t,n);if(!a)return null;var o=a.geometries,s=a.materials,l=a.transformations,u=a.objectTransformation;Ac.t.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(i,o,s,l);var c=new tS({geometries:o,materials:s,transformations:l,metadata:{layerUid:this._context.layer.uid,graphicUid:n}});c.transformation=u;var h=this._createEdgeMaterial(),d=(0,Nu.r)(h)?{baseMaterial:s[0],edgeMaterials:[h],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,f=new xC(this,c,o,null,null,JT,r,d);return f.needsElevationUpdates=GT(r.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(c),f.alignedSampledElevation=JT(f,f.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),f}},{key:"_getCenterPointInElevationSR",value:function(e){var t=(0,Uc.v)(0,0,0,(0,Nu.r)(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return(0,Hu.H)([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}},{key:"_createComponentNormals",value:function(e,t,r,n){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,r,n);case"flat":return this._createComponentNormalsFlat(e,n);case"smooth":return this._createComponentNormalsSmooth(e,n);default:return}}},{key:"_createComponentNormalsSource",value:function(e,t,r,n){if((0,Nu.t)(t))return this._createComponentNormalsFlat(e,n);var i=!1;if(!r.trustSourceNormals)for(var a=0;a<n.length;a+=3){this._calculateFaceNormal(e,n,a,aD);for(var o=0;o<3;o++){var s=3*n[a+o];rD[0]=t[s+0],rD[1]=t[s+1],rD[2]=t[s+2],(0,Vu.P)(aD,rD)<0&&(t[s+0]=-t[s+0],t[s+1]=-t[s+1],t[s+2]=-t[s+2],i=!0)}}return{normals:t,indices:n,didFlipNormals:i}}},{key:"_createComponentNormalsFlat",value:function(e,t){for(var r=new Float32Array(t.length),n=new Array(3*t.length),i=0;i<t.length;i+=3)for(var a=this._calculateFaceNormal(e,t,i,aD),o=0;o<3;o++)r[i+o]=a[o],n[i+o]=i/3;return{normals:r,indices:n,didFlipNormals:!1}}},{key:"_createComponentNormalsSmooth",value:function(e,t){for(var r={},n=0;n<t.length;n+=3)for(var i=this._calculateFaceNormal(e,t,n,aD),a=0;a<3;a++){var o=t[n+a],s=r[o];s||(s={normal:(0,Vu.n)(),count:0},r[o]=s),(0,Vu.u)(s.normal,s.normal,i),s.count++}for(var l=new Float32Array(3*t.length),u=new Array(3*t.length),c=0;c<t.length;c++){var h=r[t[c]];1!==h.count&&((0,Vu.z)(h.normal,h.normal),h.count=1);for(var d=0;d<3;d++)l[3*c+d]=h.normal[d];u[c]=c}return{normals:l,indices:u,didFlipNormals:!1}}},{key:"_getFaceVertices",value:function(e,t,r,n,i,a){var o=3*t[r+0],s=3*t[r+1],l=3*t[r+2];n[0]=e[o+0],n[1]=e[o+1],n[2]=e[o+2],i[0]=e[s+0],i[1]=e[s+1],i[2]=e[s+2],a[0]=e[l+0],a[1]=e[l+1],a[2]=e[l+2]}},{key:"_calculateFaceNormal",value:function(e,t,r,n){return this._getFaceVertices(e,t,r,rD,nD,iD),(0,Vu.e)(nD,nD,rD),(0,Vu.e)(iD,iD,rD),(0,Vu._)(rD,nD,iD),(0,Vu.z)(n,rD),n}},{key:"_getOrCreateComponents",value:function(e){return(0,Nu.v)(e.components,uD)}},{key:"_createPositionBuffer",value:function(e,t){var r=e.vertexAttributes.position,n=t.reprojection===EE.ECEF?t.transformBeforeProject:null;if((0,Nu.r)(n)&&(r=(0,Rc.R)(r,new Float64Array(r.length),n)),t.reprojection===EE.NONE)return t.needsBufferCopy?new Float64Array(r):r;var i=(0,Nu.r)(n)?r:new Float64Array(r.length);return(0,Hu.x)(r,e.spatialReference,0,i,this._context.renderCoordsHelper.spatialReference,0,r.length/3),i}},{key:"_createNormalBuffer",value:function(e,t,r){var n=e.vertexAttributes.normal;if((0,Nu.t)(n))return null;var i=r.reprojection===EE.ECEF?r.transformBeforeProject:null;if((0,Nu.r)(i)&&(n=(0,Rc.v)(n,new Float32Array(n.length),i)),"local"===this._context.graphicsCoreOwner.view.viewingMode||r.reprojection===EE.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===n?new Float32Array(n):n;var a=e.vertexAttributes.position,o=(0,Nu.r)(i)?n:new Float32Array(n.length);return(0,Rc.j)(n,a,t,e.spatialReference,o)}},{key:"_createTangentBuffer",value:function(e,t,r){var n=e.vertexAttributes.tangent;if((0,Nu.t)(n))return null;var i=r.reprojection===EE.ECEF?r.transformBeforeProject:null;if((0,Nu.r)(i)&&(n=(0,Rc.V)(n,new Float32Array(n.length),i)),"local"===this._context.graphicsCoreOwner.view.viewingMode||r.reprojection===EE.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===n?new Float32Array(n):n;var a=e.vertexAttributes.position,o=(0,Nu.r)(i)?n:new Float32Array(n.length);return(0,Rc.k)(n,a,t,e.spatialReference,o)}},{key:"_createColorBuffer",value:function(e){return e.vertexAttributes.color}},{key:"_createSymbolColorBuffer",value:function(e){if(this._requiresSymbolVertexColors()){var t=this._getVertexOpacityAndColor(e),r=(0,lh.n)((0,Nu.q)(this.symbolLayer,"material","colorMixMode")),n=new Uint8Array(4);return(0,lh.o)(t,r,n),n}return null}},{key:"_createBuffers",value:function(e,t){var r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var n=e.vertexAttributes.normal,i=e.vertexAttributes.uv,a=e.vertexAttributes.tangent;if((0,Nu.r)(n)&&n.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if((0,Nu.r)(a)&&a.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if((0,Nu.r)(i)&&i.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;var o=this._computeReprojectionInfo(e),s=this._createPositionBuffer(e,o),l=this._createColorBuffer(e),u=this._createSymbolColorBuffer(t),c=this._createNormalBuffer(e,s,o),h=this._createTangentBuffer(e,s,o);return{positionBuffer:s,normalBuffer:c,tangentBuffer:h,uvBuffer:i,colorBuffer:l,symbolColorBuffer:u,objectTransformation:o.reprojection===EE.NONE&&(0,Nu.r)(o.objectTransformation)?o.objectTransformation:this._transformOriginLocal(e,s,c,h),geometryTransformation:o.reprojection===EE.NONE&&(0,Nu.r)(o.geometryTransformation)?o.geometryTransformation:(0,hc.e)()}}},{key:"_computeReprojectionInfo",value:function(e){var t=(0,Nu.r)(e.transform),r=t&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===ic.l.Local?EE.NONE:EE.ECEF;if(t){if(r===EE.NONE){var n=(0,hc.e)();return(0,Hu.Z)(e.spatialReference,e.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:r,objectTransformation:n,geometryTransformation:(0,hc.r)(e.transform.localMatrix),needsBufferCopy:!1}}var i=(0,Wu.x)((0,hc.e)(),e.transform.origin);return(0,Wu.u)(i,i,e.transform.localMatrix),{reprojection:r,transformBeforeProject:i,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}},{key:"_transformOriginLocal",value:function(e,t,r,n){var i=this._context.renderCoordsHelper.spatialReference,a=e.anchor;tD[0]=a.x,tD[1]=a.y,tD[2]=a.z;var o=(0,hc.e)();(0,Hu.Z)(e.spatialReference,tD,o,i);var s=Zc.T.fromTypedArray(t);if((0,Wu.h)(oD,o),(0,Kc.t)(s,s,oD),(0,Nu.r)(r)||(0,Nu.r)(n)){if((0,mc.a)(sD,o),(0,mc.o)(sD,sD),(0,Nu.r)(r)){var l=Zc.i.fromTypedArray(r);(0,Kc.r)(l,l,sD)}if((0,Nu.r)(n)){var u=Zc.i.fromTypedArray(n,4*n.BYTES_PER_ELEMENT);(0,Kc.r)(u,u,sD)}}return o}},{key:"_validateFaces",value:function(e,t){var r=e.vertexAttributes.position.length/3,n=t.faces;if(n){for(var i=-1,a=0;a<n.length;a++){var o=n[a];o>i&&(i=o)}if(r<=i)return this.logger.warn("Vertex index ".concat(i," is out of bounds of the mesh position buffer")),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}},{key:"_getOrCreateFaces",value:function(e,t){return t.faces?t.faces:(0,Cc.u)(e.vertexAttributes.position.length/3)}},{key:"_isOutsideClippingArea",value:function(e){if(!this._context.clippingExtent)return!1;var t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;var r,n=this._context.elevationProvider.spatialReference,i=t.length/3;return(0,Nu.r)(n)&&!e.spatialReference.equals(n)?(r=new Float64Array(t.length),(0,Hu.x)(e.vertexAttributes.position,e.spatialReference,0,r,n,0,i)):r=t,(0,Gc.A)(lD),(0,Gc.M)(lD,r,0,i),!(0,Gc.R)(lD,this._context.clippingExtent)}},{key:"_createGeometryInfo",value:function(e,t,r){if(!(0,Hu.A)(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;var n=this._createBuffers(e,t);if((0,Nu.t)(n))return null;var i,a=n.positionBuffer,o=n.uvBuffer,s=n.colorBuffer,l=n.symbolColorBuffer,u=n.normalBuffer,c=n.tangentBuffer,h=n.objectTransformation,d=n.geometryTransformation,f=this._getOrCreateComponents(e),p=[],v=[],m=[],y=!1,g=(0,Cu.Z)(f);try{for(g.s();!(i=g.n()).done;){var _=i.value;if(!this._validateFaces(e,_))return null;var b=this._getOrCreateFaces(e,_);if(0!==b.length){var x=this._createComponentNormals(a,u,_,b);x.didFlipNormals&&(y=!0);var w=[[fc.O.POSITION,{size:3,data:a,exclusive:!0}],[fc.O.NORMAL,{size:3,data:x.normals,exclusive:!0}]],T=[[fc.O.POSITION,b],[fc.O.NORMAL,x.indices]];(0,Nu.r)(s)&&(w.push([fc.O.COLOR,{size:4,data:s,exclusive:!0}]),T.push([fc.O.COLOR,b])),(0,Nu.r)(l)&&(w.push([fc.O.SYMBOLCOLOR,{size:4,data:l,exclusive:!0}]),T.push([fc.O.SYMBOLCOLOR,new Array(b.length).fill(0)])),(0,Nu.r)(o)&&(w.push([fc.O.UV0,{size:2,data:o,exclusive:!0}]),T.push([fc.O.UV0,b])),(0,Nu.r)(c)&&(w.push([fc.O.TANGENT,{size:4,data:c,exclusive:!0}]),T.push([fc.O.TANGENT,b]));var C=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),S=new dc.M(w,T,vc.a.Triangle,C);p.push(S),v.push(d),m.push(this._getOrCreateMaterial(e,_))}}}catch(O){g.e(O)}finally{g.f()}return y&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:v,materials:m,objectTransformation:h}}},{key:"_createEdgeMaterial",value:function(){var e={opacity:this._getLayerOpacity()};return(0,qc.f)(this.symbolLayer,e)}}]),r}(WC),tD=(0,Vu.n)(),rD=(0,Vu.n)(),nD=(0,Vu.n)(),iD=(0,Vu.n)(),aD=(0,Vu.n)(),oD=(0,hc.e)(),sD=(0,gc.e)(),lD=(0,Gc.a)(),uD=[new eh.g];!function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF"}(EE||(EE={}));var cD=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this.graphics3DSymbolLayer=t,this.instanceIndex=r,this.elevationAligner=n,this.elevationContext=i,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}return(0,ku.Z)(e,[{key:"initialize",value:function(){}},{key:"setVisibility",value:function(e){var t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}},{key:"destroy",value:function(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}},{key:"alignWithElevation",value:function(e,t,r){if(this.elevationAligner){vC(this.elevationContext.featureExpressionInfoContext,r);var n=this.elevationAligner(this,this.elevationContext,e,t);(0,Nu.r)(n)&&(this.alignedSampledElevation=n)}}},{key:"getCenterObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Vu.n)();return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,vD),(0,Vu.O)(e,this._lodRenderer.baseBoundingSphere.center,vD)}},{key:"getBoundingBoxObjectSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Gc.a)();this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,vD);var t=this._lodRenderer.baseBoundingBox;(0,Gc.A)(e);for(var r=0;r<8;++r)(0,Vu.o)(dD,0==(1&r)?t[0]:t[3],0==(2&r)?t[1]:t[4],0==(4&r)?t[2]:t[5]),(0,Vu.O)(dD,dD,vD),(0,Gc.c)(e,dD);return e}},{key:"computeAttachmentOrigin",value:function(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,vD),e.render.origin[0]+=vD[12],e.render.origin[1]+=vD[13],e.render.origin[2]+=vD[14],e.render.num++}},{key:"getProjectedBoundingBox",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u,c,h,d,f,p,v;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(o=this.getBoundingBoxObjectSpace(a),s=pD,l=(0,Gc.P)(o)?1:s.length,this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,vD),u=0;u<l;u++)c=s[u],dD[0]=o[c[0]],dD[1]=o[c[1]],dD[2]=o[c[2]],(0,Vu.O)(dD,dD,vD),hD[3*u+0]=dD[0],hD[3*u+1]=dD[1],hD[3*u+2]=dD[2];if(t(hD,0,l)){e.next=5;break}return e.abrupt("return",null);case 5:for((0,Gc.A)(o),h=null,this.calculateRelativeScreenBounds&&(h=this.calculateRelativeScreenBounds()),d=0;d<3*l;d+=3){for(f=0;f<3;f++)o[f]=Math.min(o[f],hD[d+f]),o[f+3]=Math.max(o[f+3],hD[d+f]);h&&n.push({location:hD.slice(d,d+3),screenSpaceBoundingRect:h})}if(!r||((0,Gc.p)(o,fD),"absolute-height"===this.elevationContext.mode)){e.next=20;break}return v=NT(o,r.service.spatialReference,r),e.prev=11,e.next=14,r.service.queryElevation(fD[0],fD[1],i,v,"ground");case 14:p=e.sent,e.next=19;break;case 17:e.prev=17,e.t0=e.catch(11);case 19:(0,Nu.r)(p)&&(0,Gc.V)(o,0,0,-this.alignedSampledElevation+p);case 20:return e.abrupt("return",o);case 21:case"end":return e.stop()}}),e,this,[[11,17]])})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"addObjectState",value:function(e,t){var r=this;if(e===vc.u.Highlight){var n=new eS(e);this._addHighlightId(n),t.addExternal((function(e){r._removeHighlightId(e)}),n)}}},{key:"removeObjectState",value:function(e){this._highlights.forEach((function(t){return e.remove(t)}))}},{key:"_addHighlightId",value:function(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}},{key:"_removeHighlightId",value:function(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}},{key:"_lodRenderer",get:function(){return this.graphics3DSymbolLayer.lodRenderer}}]),e}(),hD=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],dD=(0,Vu.n)(),fD=(0,Vu.n)(),pD=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],vD=(0,hc.e)();function mD(e){return{levels:e.map((function(e){return function(e){var t=[];return e.stageResources.geometries.forEach((function(r,n){var i=e.stageResources.materials[n],a=e.stageResources.textures;t.push({material:i,geometry:r,textures:a})})),{components:t,minScreenSpaceRadius:(0,Nu.r)(e.lodThreshold)?e.lodThreshold:0,pivotOffset:e.pivotOffset}}(e)}))}}function yD(e){e.levels.forEach((function(e){e.minScreenSpaceRadius||(e.minScreenSpaceRadius=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_D,r=NC(e);return Math.sqrt(r/(t*Math.PI))}(e))}))}var gD,_D=.05;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(gD||(gD={}));var bD=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.localTransform=t.getField(fc.O.LOCALTRANSFORM,Zc.b),this.globalTransform=t.getField(fc.O.GLOBALTRANSFORM,Zc.b),this.modelOrigin=t.getField(fc.O.MODELORIGIN,Zc.T),this.model=t.getField(fc.O.MODEL,Zc.l),this.modelNormal=t.getField(fc.O.MODELNORMAL,Zc.l),this.modelScaleFactors=t.getField(fc.O.MODELSCALEFACTORS,Zc.u),this.boundingSphere=t.getField(fc.O.BOUNDINGSPHERE,Zc.h),this.color=t.getField(fc.O.COLOR,Zc.c),this.featureAttribute=t.getField(fc.O.FEATUREATTRIBUTE,Zc.c),this.state=t.getField(fc.O.STATE,Zc.d),this.lodLevel=t.getField(fc.O.LODLEVEL,Zc.d),this.objectAndLayerIdColor=t.getField(fc.O.OBJECTANDLAYERIDCOLOR,Zc.x)})),xD=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this))._capacity=0,i._size=0,i._next=0,i._buffer=null,i._view=null,i._layout=function(e){var t=(0,wc.T)().mat4f64(fc.O.LOCALTRANSFORM).mat4f64(fc.O.GLOBALTRANSFORM).vec4f64(fc.O.BOUNDINGSPHERE).vec3f64(fc.O.MODELORIGIN).mat3f(fc.O.MODEL).mat3f(fc.O.MODELNORMAL).vec2f(fc.O.MODELSCALEFACTORS);return e.includes("color")&&(t=t.vec4f(fc.O.COLOR)),e.includes("featureAttribute")&&(t=t.vec4f(fc.O.FEATUREATTRIBUTE)),t=t.u8(fc.O.STATE).u8(fc.O.LODLEVEL),e.includes(fc.O.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(fc.O.OBJECTANDLAYERIDCOLOR)),t.alignTo(8),t}(e),i._shaderTransformation=n,i}return(0,ku.Z)(r,[{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer.buffer}},{key:"view",get:function(){return this._view}},{key:"addInstance",value:function(){this._size+1>this._capacity&&this._grow();var e=this._findSlot();return this._view.state.set(e,gD.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}},{key:"removeInstance",value:function(e){var t=this._view.state;(0,Sc.e)(e>=0&&e<this._capacity&&t.get(e)&gD.ALLOCATED,"invalid instance handle"),this._getStateFlag(e,gD.ACTIVE)?this._setStateFlags(e,gD.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}},{key:"freeInstance",value:function(e){var t=this._view.state;(0,Sc.e)(e>=0&&e<this._capacity&&t.get(e)&gD.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}},{key:"setLocalTransform",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.localTransform.setMat(e,t),r&&this.updateModelTransform(e)}},{key:"getLocalTransform",value:function(e,t){this._view.localTransform.getMat(e,t)}},{key:"setGlobalTransform",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.globalTransform.setMat(e,t),r&&this.updateModelTransform(e)}},{key:"getGlobalTransform",value:function(e,t){this._view.globalTransform.getMat(e,t)}},{key:"updateModelTransform",value:function(e){var t=this._view,r=CD,n=SD;t.localTransform.getMat(e,OD),t.globalTransform.getMat(e,PD);var i=(0,Wu.u)(PD,PD,OD);(0,Vu.o)(r,i[12],i[13],i[14]),t.modelOrigin.setVec(e,r),(0,mc.a)(n,i),t.model.setMat(e,n);var a=(0,qu.N)(CD,i);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),(0,mc.u)(n,n),(0,mc.o)(n,n),t.modelNormal.setMat(e,n),this._setStateFlags(e,gD.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}},{key:"getModelTransform",value:function(e,t){var r=this._view;r.model.getMat(e,SD),r.modelOrigin.getVec(e,CD),t[0]=SD[0],t[1]=SD[1],t[2]=SD[2],t[3]=0,t[4]=SD[3],t[5]=SD[4],t[6]=SD[5],t[7]=0,t[8]=SD[6],t[9]=SD[7],t[10]=SD[8],t[11]=0,t[12]=CD[0],t[13]=CD[1],t[14]=CD[2],t[15]=1}},{key:"applyShaderTransformation",value:function(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}},{key:"getCombinedModelTransform",value:function(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}},{key:"getCombinedLocalTransform",value:function(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}},{key:"getCombinedMaxScaleFactor",value:function(e){var t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){var r=this._shaderTransformation.scaleFactor(CD,this,e);t*=Math.max(r[0],r[1],r[2])}return t}},{key:"getCombinedMedianScaleFactor",value:function(e){var t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){var r=this._shaderTransformation.scaleFactor(CD,this,e);t*=function(e,t,r){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),r))}(r[0],r[1],r[2])}return t}},{key:"getModel",value:function(e,t){this._view.model.getMat(e,t)}},{key:"setFeatureAttribute",value:function(e,t){this._view.featureAttribute.setVec(e,t)}},{key:"getFeatureAttribute",value:function(e,t){this._view.featureAttribute.getVec(e,t)}},{key:"setColor",value:function(e,t){this._view.color.setVec(e,t)}},{key:"setObjectAndLayerIdColor",value:function(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}},{key:"getColor",value:function(e,t){this._view.color.getVec(e,t)}},{key:"setVisible",value:function(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,gD.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}},{key:"getVisible",value:function(e){return this._getStateFlag(e,gD.VISIBLE)}},{key:"setHighlight",value:function(e,t){t!==this.getHighlight(e)&&(this._setStateFlag(e,gD.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}},{key:"getHighlight",value:function(e){return this._getStateFlag(e,gD.HIGHLIGHT)}},{key:"getState",value:function(e){return this._view.state.get(e)}},{key:"getLodLevel",value:function(e){return this._view.lodLevel.get(e)}},{key:"countFlags",value:function(e){for(var t=0,r=0;r<this._capacity;++r)this.getState(r)&e&&++t;return t}},{key:"_setStateFlags",value:function(e,t){var r=this._view.state;t=r.get(e)|t,r.set(e,t)}},{key:"_clearStateFlags",value:function(e,t){var r=this._view.state;t=r.get(e)&~t,r.set(e,t)}},{key:"_setStateFlag",value:function(e,t,r){r?this._setStateFlags(e,t):this._clearStateFlags(e,t)}},{key:"_getStateFlag",value:function(e,t){return!!(this._view.state.get(e)&t)}},{key:"_grow",value:function(){var e=Math.max(wD,Math.floor(this._capacity*TD)),t=this._layout.createBuffer(e);if(this._buffer){var r=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(r)}this._capacity=e,this._buffer=t,this._view=new bD(this._buffer)}},{key:"_findSlot",value:function(){for(var e=this._view.state,t=this._next;e.get(t)&gD.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}}]),r}(ec.n);var wD=1024,TD=2,CD=(0,Vu.n)(),SD=(0,gc.e)(),OD=(0,hc.e)(),PD=(0,hc.e)(),RD=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),i=t.call(this,(function(e){return(0,Qu.w)(i._instanceData.view.boundingSphere.getVec(e,i._tmpSphere))}),{maximumDepth:25}),i._tmpSphere=(0,Qu.R)(),i._tmpMat4=(0,hc.e)(),i._instanceData=e,i._boundingSphere=n,i}return(0,ku.Z)(r,[{key:"addInstance",value:function(e){var t=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,Vu.O)(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*(0,qu.I)(r),t.setVec(e,this._tmpSphere),this.add([e])}},{key:"removeInstance",value:function(e){this.remove([e])}}]),r}(rh.G),AD=function(){function e(t,r){(0,Au.Z)(this,e),this.thresholdScale=1,this._camera=new Jy,this._worldSpaceRadius=t,this._thresholds=r.map((function(e){return e}))}return(0,ku.Z)(e,[{key:"updateCamera",value:function(e){this._camera.copyFrom(e)}},{key:"selectLevel",value:function(e,t){for(var r=this._camera.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*t/r,i=this._thresholds,a=-1,o=0;o<i.length;++o)n>=i[o]*this.thresholdScale&&(a=o);return a}}]),e}(),kD=function(){function e(t,r){(0,Au.Z)(this,e);var n=t.renderContext.rctx,i=r.geometry,a=r.material;this._materialRepository=t.materialRep,a.setParameters({instancedDoublePrecision:!0});var o=a.createBufferWriter(),s=o.vertexBufferLayout,l=o.elementCount(i),u=o.allocate(l);o.write(null,null,i,u,0),this.geometry=i,this.material=a,this.glMaterials=new dR(a,this._materialRepository),this.vertexBufferLayout=s,this.vbo=_c.E.createVertex(n,pc.F.STATIC_DRAW,u.buffer),this.vao=new dc.N(n,dc.E,{geometry:(0,xc.o)(s)},{geometry:this.vbo}),this.vertexCount=l}return(0,ku.Z)(e,[{key:"destroy",value:function(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}},{key:"boundingInfo",get:function(){return this.geometry.boundingInfo}},{key:"triangleCount",get:function(){return this.vertexCount/3}},{key:"intersect",value:function(e,t,r,n,i,a,o,s){var l=this.geometry.id;this.material.intersect(this.geometry,null,e.transform.transform,e,r,n,(function(r,n,u,c,h){if(r>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,r))return;var d={layerUid:a.layerUid,graphicUid:a.graphicUid(i),geometryId:l,triangleNr:u,baseBoundingSphere:o,numLodLevels:s};if((null==e.results.min.drapedLayerOrder||h>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||r<e.results.min.dist)&&e.results.min.set(qu.M.LOD,d,r,n,e.transform.transform,h),e.options.store!==qu.J.MIN&&(null==e.results.max.drapedLayerOrder||h>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||r>e.results.max.dist)&&e.results.max.set(qu.M.LOD,d,r,n,e.transform.transform,h),e.options.store===qu.J.ALL){var f=(0,qu.L)(e.results.min.ray);f.set(qu.M.LOD,d,r,n,e.transform.transform,h),e.results.all.push(f)}}}))}}]),e}(),ED=function(){function e(t,r){(0,Au.Z)(this,e),this.minScreenSpaceRadius=t,this.components=r}return(0,ku.Z)(e,[{key:"destroy",value:function(){this.components.forEach((function(e){return e.destroy()}))}},{key:"intersect",value:function(e,t,r,n,i,a,o){var s=this;this.components.forEach((function(l){return l.intersect(e,t,r,n,i,a,s.boundingSphere,o)}))}},{key:"boundingBox",get:function(){if((0,Nu.t)(this._boundingBox)){var e=(0,Gc.A)();this.components.forEach((function(t){(0,Nu.r)(t.boundingInfo)&&((0,Gc.c)(e,t.boundingInfo.bbMin),(0,Gc.c)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}},{key:"boundingSphere",get:function(){if((0,Nu.t)(this._boundingSphere)){var e=this.boundingBox,t=(0,Vu.n)();(0,Gc.p)(e,t),this._boundingSphere={center:t,radius:.5*(0,Gc.g)(e)}}return this._boundingSphere}},{key:"triangleCount",get:function(){return this.components.reduce((function(e,t){return e+t.triangleCount}),0)}}],[{key:"create",value:function(){var t=(0,Ou.Z)((0,Su.Z)().mark((function t(r,n,i){var a,o,s,l,u;return(0,Su.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Promise.allSettled(n.components.map((function(e){return r.schedule((function(){return new kD(r,e)}),i)})));case 2:if(a=t.sent,o=a.map((function(e){return"fulfilled"===e.status?e.value:null})).filter((function(e){return e})),!(0,Eu.p)(i)&&o.length===a.length){t.next=23;break}o.forEach((function(e){return e.destroy()})),(0,Eu.f)(i),s=(0,Cu.Z)(a),t.prev=7,s.s();case 9:if((l=s.n()).done){t.next=15;break}if("rejected"!==(u=l.value).status){t.next=13;break}throw u.reason;case 13:t.next=9;break;case 15:t.next=20;break;case 17:t.prev=17,t.t0=t.catch(7),s.e(t.t0);case 20:return t.prev=20,s.f(),t.finish(20);case 23:return t.abrupt("return",new e(n.minScreenSpaceRadius,o));case 24:case"end":return t.stop()}}),t,null,[[7,17,20,23]])})));return function(e,r,n){return t.apply(this,arguments)}}()}]),e}(),DD=function(){function e(t,r,n){(0,Au.Z)(this,e),this._elementSize=r,this._buffer=_c.E.createVertex(t,pc.F.STATIC_DRAW),this.resize(n)}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._buffer.dispose()}},{key:"elementSize",get:function(){return this._elementSize}},{key:"capacity",get:function(){return this._capacity}},{key:"array",get:function(){return this._array}},{key:"buffer",get:function(){return this._buffer}},{key:"memoryUsage",get:function(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}},{key:"copyRange",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,n*this.elementSize).set(i)}},{key:"transferAll",value:function(){this._buffer.setData(this._array)}},{key:"transferRange",value:function(e,t){var r=e*this._elementSize,n=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),r,r,n)}},{key:"resize",value:function(e){var t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e}}]),e}(),MD=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.modelOriginHi=t.getField(fc.O.MODELORIGINHI,Zc.i),this.modelOriginLo=t.getField(fc.O.MODELORIGINLO,Zc.i),this.model=t.getField(fc.O.MODEL,Zc.l),this.modelNormal=t.getField(fc.O.MODELNORMAL,Zc.l),this.color=t.getField(fc.O.INSTANCECOLOR,Zc.c),this.featureAttribute=t.getField(fc.O.INSTANCEFEATUREATTRIBUTE,Zc.c),this.objectAndLayerIdColor=t.getField(fc.O.OBJECTANDLAYERIDCOLOR_INSTANCED,Zc.x)})),ID=function(){function e(t,r){(0,Au.Z)(this,e),this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=r,this._elementSize=r.stride,this._capacity=1}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._buffer&&this._buffer.destroy()}},{key:"buffer",get:function(){return this._buffer.buffer}},{key:"view",get:function(){return this._view}},{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){var e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}},{key:"isEmpty",get:function(){return this._headIndex===this._tailIndex}},{key:"isFull",get:function(){return this._tailIndex===(this._headIndex+1)%this._capacity}},{key:"headIndex",get:function(){return this._headIndex}},{key:"tailIndex",get:function(){return this._tailIndex}},{key:"firstIndex",get:function(){return this._firstIndex}},{key:"memoryUsage",get:function(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}},{key:"reset",value:function(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}},{key:"startUpdateCylce",value:function(){this._captureFirstIndex=!0}},{key:"beginUpdate",value:function(){(0,Sc.e)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}},{key:"endUpdate",value:function(){(0,Sc.e)(this._updating,"not updating"),this.size<ND*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}},{key:"allocateHead",value:function(){(0,Sc.e)(this._updating,"not updating"),this.isFull&&this._grow();var e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,Sc.e)(this._headIndex!==this._tailIndex,"invalid pointers"),e}},{key:"freeTail",value:function(){(0,Sc.e)(this._updating,"not updating"),(0,Sc.e)(this.size>0,"invalid size");var e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}},{key:"_grow",value:function(){var e=Math.max(LD,Math.floor(this._capacity*ZD));this._resize(e)}},{key:"_shrink",value:function(){var e=Math.max(LD,Math.floor(this._capacity*FD));this._resize(e)}},{key:"_resize",value:function(e){if((0,Sc.e)(this._updating,"not updating"),e!==this._capacity){var t=new DD(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);var r=this.size,n=this._compactInstances(t);(0,Sc.e)(n===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=n,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new MD(this._instanceBufferLayout.createView(this._buffer.array))}}},{key:"_compactInstances",value:function(e){var t=this._headIndex,r=this._tailIndex;return r<t?(this._buffer.copyRange(r,t,e),t-r):r>t?(this._buffer.copyRange(r,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-r),t+(this._capacity-r)):0}},{key:"_incrementHead",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._headIndex=(this._headIndex+e)%this._capacity}},{key:"_incrementTail",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._tailIndex=(this._tailIndex+e)%this._capacity}},{key:"_transferRange",value:function(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}]),e}(),LD=1024,ZD=2,ND=.3,FD=.5,zD=function(e){var t=e.baseBoundingSphere.radius,r=e.levels.map((function(e){return e.minScreenSpaceRadius}));return new AD(t,r)},UD=function(){function e(t,r,n,i){var a=this;(0,Au.Z)(this,e),this.type=qu.M.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._lastCamera=new Jy,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[dc.H.OPAQUE_MATERIAL,dc.H.TRANSPARENT_MATERIAL],this.canRender=!0,this._symbol=t,this._optionalFields=r,this._metadata=n,this._instanceBufferLayout=(0,dc.aY)({instancedDoublePrecision:!0,instanced:r}),this._glInstanceBufferLayout=(0,xc.o)(this._instanceBufferLayout,1),this._instanceData=new xD(this._optionalFields,i),this._instanceData.on("instance-added",(function(){return a._requestUpdateCycle()})),this._instanceData.on("instance-removed",(function(){return a._requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(function(e){a._requestUpdateCycle(),a._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(function(e){a._requestUpdateCycle(!0),a._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(function(){return a._requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1}return(0,ku.Z)(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"layerUid",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){var e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((function(t){var r=t.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu})),this._highlightRenderInstanceData.forEach((function(t){var r=t.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu})),e}},{key:"renderStats",get:function(){var e=this,t=this._instanceData.size,r=[];return this._levels.forEach((function(t,n){var i=e._defaultRenderInstanceData[n],a=e._highlightRenderInstanceData[n],o=i.size+a.size,s=t.triangleCount;r.push({renderedInstances:o,renderedTriangles:o*s,trianglesPerInstance:s})})),{totalInstances:t,renderedInstances:r.reduce((function(e,t){return e+t.renderedInstances}),0),renderedTriangles:r.reduce((function(e,t){return e+t.renderedTriangles}),0),levels:r}}},{key:"initializeRenderContext",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o,s,l,u=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._context=t,n=t.renderContext.rctx,e.next=4,Promise.allSettled(this._symbol.levels.map((function(e){return u._defaultRenderInstanceData.push(new ID(n,u._instanceBufferLayout)),u._highlightRenderInstanceData.push(new ID(n,u._instanceBufferLayout)),ED.create(t,e,r)})));case 4:if(i=e.sent,a=i.map((function(e){return"fulfilled"===e.status?e.value:null})).filter((function(e){return e})),!(0,Eu.p)(r)&&a.length===i.length){e.next=25;break}a.forEach((function(e){return e.destroy()})),(0,Eu.f)(r),o=(0,Cu.Z)(i),e.prev=9,o.s();case 11:if((s=o.n()).done){e.next=17;break}if("rejected"!==(l=s.value).status){e.next=15;break}throw l.reason;case 15:e.next=11;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(9),o.e(e.t0);case 22:return e.prev=22,o.f(),e.finish(22);case 25:this._levels=a,this._levelSelector=zD(this);case 26:case"end":return e.stop()}}),e,this,[[9,19,22,25]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"uninitializeRenderContext",value:function(){this._invalidateOctree(),this._levels.forEach((function(e){return e.destroy()})),this._defaultRenderInstanceData.forEach((function(e){return e.destroy()})),this._highlightRenderInstanceData.forEach((function(e){return e.destroy()}))}},{key:"needsTransparentPass",get:function(){return this._levels.some((function(e){return e.components.some((function(e){return e.material.requiresSlot(dc.H.TRANSPARENT_MATERIAL,dc.O.Color)}))}))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some((function(e){return e.size>0}))}},{key:"prepareRender",value:function(e){if(!Ac.t.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var t=e.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}var r=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(e.bindParameters.contentCamera,r),this._needsUpdates&&this._context.requestRender()}}},{key:"render",value:function(e){this.baseMaterial.isVisible()&&this.baseMaterial.isVisibleForOutput(e.output)&&(e.rctx.bindVAO(),e.output!==dc.O.Highlight&&e.output!==dc.O.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData),e.output!==dc.O.ShadowExludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData))}},{key:"intersect",value:function(e,t,r,n){var i=this;if(this.baseMaterial.isVisible()){var a=(0,Vu.n)();(0,Vu.e)(a,n,r);var o=function(a){i._instanceData.getCombinedModelTransform(a,HD),e.transform.set(HD),(0,Vu.O)(jD,r,e.transform.inverse),(0,Vu.O)(qD,n,e.transform.inverse);var o=i._instanceData.getState(a),s=i._instanceData.getLodLevel(a),l=i._levels.length;(0,Sc.e)(o&gD.ACTIVE,"invalid instance state"),(0,Sc.e)(s>=0&&s<l,"invaid lod level"),i._levels[s].intersect(e,t,jD,qD,a,i._metadata,l)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(r,a,o)}}},{key:"queryDepthRange",value:function(e){return this._queryDepthRangeOctree(e)}},{key:"notifyShaderTransformationChanged",value:function(){this._invalidateOctree()}},{key:"_requestUpdateCycle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this._needsUpdates&&this._context.requestRender()}},{key:"_needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"_octree",get:function(){return(0,Nu.t)(this._octreeCached)&&(this._octreeCached=this._buildOctree()),this._octreeCached}},{key:"_invalidateOctree",value:function(){this._octreeCached=(0,Nu.g)(this._octreeCached)}},{key:"_buildOctree",value:function(){for(var e=new RD(this._instanceData,this.baseBoundingSphere),t=this._instanceData,r=t.view?t.view.state:null,n=0;n<this._instanceData.capacity;++n)r.get(n)&gD.ACTIVE&&e.addInstance(n);return e}},{key:"_queryDepthRangeOctree",value:function(e){var t=e.eye,r=e.viewForward,n=this._octree.findClosest(r,rh.G.DepthOrder.FRONT_TO_BACK,e.frustum),i=this._octree.findClosest(r,rh.G.DepthOrder.BACK_TO_FRONT,e.frustum);if(null!=n&&null!=i){this._instanceData.view.boundingSphere.getVec(n,GD),(0,Vu.e)(GD,GD,t);var a=(0,Vu.P)(GD,r)-GD[3];this._instanceData.view.boundingSphere.getVec(i,GD),(0,Vu.e)(GD,GD,t);var o=(0,Vu.P)(GD,r)+GD[3];return{near:Math.max(e.near,a),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}}},{key:"_startUpdateCycle",value:function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((function(e){e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((function(e){e.startUpdateCylce()})),this._needsUpdates&&this._context.requestRender()}},{key:"_updateInstances",value:function(e,t){var r=this._enableLevelSelection,n=this._levelSelector;n.updateCamera(e),this._defaultRenderInstanceData.forEach((function(e){return e.beginUpdate()})),this._highlightRenderInstanceData.forEach((function(e){return e.beginUpdate()}));var i=this._instanceData,a=this._instanceData.view,o=i.size,s=i.capacity,l=this._instanceIndex;t=Math.min(o,t);for(var u=0;u<t;++u){0===l&&this._startUpdateCycle();var c=a.state.get(l),h=0;if(c&gD.ALLOCATED){var d=a.lodLevel.get(l);if(c&gD.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[d].freeTail(),c&gD.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[d].freeTail(),c&gD.REMOVE)i.freeInstance(l);else if(c&gD.VISIBLE){var f=0;r&&(a.modelOrigin.getVec(l,BD),f=n.selectLevel(BD,i.getCombinedMedianScaleFactor(l))),h=c&~(gD.ACTIVE|gD.TRANSFORM_CHANGED),f>=0&&(c&gD.HIGHLIGHT?(VD(this._highlightRenderInstanceData[f],a,l),h|=gD.HIGHLIGHT_ACTIVE):(VD(this._defaultRenderInstanceData[f],a,l),h|=gD.DEFAULT_ACTIVE)),a.state.set(l,h),a.lodLevel.set(l,f)}else h=c&~(gD.ACTIVE|gD.TRANSFORM_CHANGED),a.state.set(l,h);if((0,Nu.r)(this._octreeCached)){var p=!!(c&gD.ACTIVE),v=!!(h&gD.ACTIVE);!p&&v?this._octreeCached.addInstance(l):p&&!v?this._octreeCached.removeInstance(l):p&&v&&c&gD.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===s?0:l+1}else l=l+1===s?0:l+1,t++}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((function(e){return e.endUpdate()})),this._highlightRenderInstanceData.forEach((function(e){return e.endUpdate()}))}},{key:"_renderComponents",value:function(e,t){var r=this;this.levels.forEach((function(n,i){n.components.forEach((function(n){r._renderComponent(e,t[i],n,i)}))}))}},{key:"_renderComponent",value:function(e,t,r,n){var i=e.bindParameters,a=e.rctx,o=e.output;if(0!==t.size&&r.material.requiresSlot(i.slot,e.output)){var s=r.glMaterials.load(a,i.slot,o);if(!(0,Nu.t)(s)){var l=s.beginSlot(i),u=a.bindTechnique(l,r.material.parameters,i);a.bindVAO(r.vao),l.ensureAttributeLocations(r.vao),u.bindDraw(XD,i,r.material.parameters),Ac.t.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===dc.O.Color&&(u.setUniform4fv("externalColor",WD[Math.min(n,WD.length-1)]),u.setUniform1i("colorMixMode",dc.aZ.replace));var c=a.capabilities.instancing,h=t.capacity,d=t.headIndex,f=t.tailIndex,p=t.firstIndex,v=this._glInstanceBufferLayout,m=function(e,n){(0,_c.R)(a,dc.E,t.buffer,v,e),c.drawArraysInstanced(l.primitiveType,0,r.vertexCount,n-e),(0,_c.a)(a,dc.E,t.buffer,v)};r.material.parameters.transparent&&null!=p?d>f?((0,Sc.e)(p>=f&&p<=d,"invalid firstIndex"),m(p,d),m(f,p)):d<f&&(p<=d?((0,Sc.e)(p>=0&&p<=d,"invalid firstIndex"),m(p,d),m(f,h),m(0,p)):((0,Sc.e)(p>=f&&p<=h,"invalid firstIndex"),m(p,h),m(0,d),m(f,p))):d>f?m(f,d):d<f&&(m(0,d),m(f,h)),a.bindVAO(null)}}}}]),e}();function VD(e,t,r){var n=e.allocateHead();!function(e,t,r,n){(0,Ic.p)(e.modelOrigin,t,r.modelOriginHi,r.modelOriginLo,n),r.model.copyFrom(n,e.model,t),r.modelNormal.copyFrom(n,e.modelNormal,t),e.color&&r.color&&r.color.copyFrom(n,e.color,t),e.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(n,e.objectAndLayerIdColor,t),e.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(n,e.featureAttribute,t)}(t,r,e.view,n)}var BD=(0,Vu.n)(),GD=(0,lc.n)(),HD=(0,hc.e)(),jD=(0,Vu.n)(),qD=(0,Vu.n)(),WD=[(0,lc.r)(1,0,1,1),(0,lc.r)(0,0,1,1),(0,lc.r)(0,1,0,1),(0,lc.r)(1,1,0,1),(0,lc.r)(1,0,0,1)],XD=new dc.aX,YD=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a))._resources=null,o._optionalFields=new Array,o._instanceIndexToGraphicUid=new Map,o._hasLoadedPBRTextures=!1,o._disposeResourceHandles=new Array,o.ensureDrapedStatus(!1),o._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled,o}return(0,ku.Z)(r,[{key:"getCachedSize",value:function(){var e=(0,Nu.r)(this._resources)?this._resources.symbolSize:[1,1,1],t=(0,xu.Z)(e,3);return{width:t[0],depth:t[1],height:t[2]}}},{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._drivenProperties.size){e.next=3;break}if(!LT(this.symbolLayer)){e.next=3;break}throw new Error;case 3:if(r=this.symbolLayer,!this._isPrimitive){e.next=11;break}return n=r.resource?r.resource.primitive:Bc.r,e.next=8,this._createResourcesForPrimitive(n,t);case 8:this._resources=e.sent,e.next=14;break;case 11:return e.next=13,this._createResourcesForUrl(r.resource.href,t);case 13:this._resources=e.sent;case 14:this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity();case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"extentPadding",get:function(){return(0,Nu.r)(this._resources)?this._resources.extentPadding:0}},{key:"_isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return(0,Nu.q)(this._resources,"lodRenderer")}},{key:"_setMaterialTransparencyParams",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Nu.q)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t),n=r<1||this.needsDrivenTransparentPass;return e.transparent=n,e.opacity=r,e.cullFace=n?vc.n.None:vc.n.Back,e}},{key:"_createResourcesForPrimitive",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o,s,l,u,c,h,d,f,p,v,m,y,g,_,b,x,w;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(kC(t)){e.next=2;break}throw new Error("Unknown object symbol primitive: ".concat(t));case 2:if(n=this.symbolLayer,i=(0,Gc.a)((0,Bc.w)(t)),a=(0,Vu.a6)((0,Gc.F)(i)),o=(0,Vu.a6)((0,Bc.v)(a,n)),s=(0,Vu.s)(o),l=!1,u=!1,c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:Vu.l,diffuse:Vu.l,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},h=c.usePBR,this._setMaterialTransparencyParams(c),"point-3d"===(d=this.symbol).type&&d.verticalOffset&&(f=d.verticalOffset,p=f.screenLength,v=f.minWorldLength,m=f.maxWorldLength,c.verticalOffset={screenLength:(0,zu.u)(p),minWorldLength:v||0,maxWorldLength:(0,Nu.r)(m)?m:1/0},c.castShadows=!1),this._context.screenSizePerspectiveEnabled&&(c.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color?c.externalColor=lc._:(y=(0,Nu.r)(n.material)&&n.material.color,g=(0,Nu.r)(y)?sc.l.toUnitRGBA(y):lc._,c.externalColor=g),this._fastUpdates=Rk(this._context.renderer,this._fastVisualVariableConvertOptions(i,o,a,Nu.L)),c.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(c,this._fastUpdates.materialParameters),c.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.instanced.push("color"),this._optionalFields.push("color")),(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&(c.instanced.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor")),_=new dc.aS(c),b=EC(t,_)){e.next=11;break}throw new Error("Unknown object symbol primitive: ".concat(t));case 11:return x=MC(b).map((function(e){return{opacity:1,transparent:e.parameters.transparent}})),e.next=14,this._createStageResources(b,h);case 14:return w=e.sent,e.t0=b,e.next=18,this._createLodRenderer(b,r);case 18:return e.t1=e.sent,e.t2=w,e.t3=o,e.t4=s,e.t5=l,e.t6=u,e.t7=x,e.t8=h,e.t9=i,e.t10=a,e.t11=Nu.L,e.abrupt("return",{lodResources:e.t0,lodRenderer:e.t1,stageResources:e.t2,symbolSize:e.t3,extentPadding:e.t4,isEsriSymbolResource:e.t5,isWosr:e.t6,originalMaterialParameters:e.t7,physicalBasedRenderingEnabled:e.t8,resourceBoundingBox:e.t9,resourceSize:e.t10,pivotOffset:e.t11});case 30:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createResourcesForUrl",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o,s,l,u,c,h,d,f,p,v,m,y,g,_,b,x,w,T,C,S,O,P,R,A=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={materialParamsMixin:{instanced:n=["transformation"],hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache},this._fastUpdates=Rk(this._context.renderer,this._fastVisualVariableConvertOptions(Nu.L,Nu.L,Nu.L,Nu.L)),this._fastUpdates.enabled?(Object.assign(i.materialParamsMixin,this._fastUpdates.materialParameters),n.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(n.push("color"),this._optionalFields.push("color")),(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&(n.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor")),"point-3d"===(a=this.symbol).type&&a.verticalOffset&&(o=a.verticalOffset,s=o.screenLength,l=o.minWorldLength,u=o.maxWorldLength,i.materialParamsMixin.verticalOffset={screenLength:(0,zu.u)(s),minWorldLength:l||0,maxWorldLength:(0,Nu.r)(u)?u:1/0},i.materialParamsMixin.castShadows=!1),i.signal=r,i.usePBR=this._context.physicalBasedRenderingEnabled,i.skipHighLods=this._context.skipHighSymbolLods,c=i.usePBR,e.next=8,(0,dc.a_)(t,i);case 8:return h=e.sent,d=h.isEsriSymbolResource,f=h.isWosr,yD(p=mD(h.lods)),p.levels.sort((function(e,t){return e.minScreenSpaceRadius-t.minScreenSpaceRadius})),p.levels[0].minScreenSpaceRadius=Math.min(2,p.levels[0].minScreenSpaceRadius),v=this._context,m=this.symbolLayer.material,y=this._getExternalColorParameters(m),g=(0,Nu.q)(this.symbolLayer,"material","color"),_=this._getCombinedOpacity(g,{hasIntrinsicColor:!0}),b=this.needsDrivenTransparentPass,x=MC(p),w=MC(p).map((function(e){return{opacity:e.parameters.opacity||1,transparent:e.parameters.transparent}})),x.forEach((function(e){var t=e.parameters;e.setParameters(y);var r=t.opacity*_,n=r<1||b||t.transparent;e.setParameters({opacity:r,transparent:n}),v.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:v.sharedResources.screenSizePerspectiveSettings})})),T=h.referenceBoundingBox,C=(0,Vu.a6)((0,Gc.F)(T)),S=(0,Vu.a6)(p.levels[0].pivotOffset),O=(0,Vu.a6)((0,Bc.v)(C,this.symbolLayer)),P=(0,Vu.s)(O),Ak(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(T,O,C,S))&&x.forEach((function(e){return e.setParameters(A._fastUpdates.materialParameters)})),e.next=19,this._createStageResources(p,c);case 19:return R=e.sent,e.t0=p,e.next=23,this._createLodRenderer(p,r);case 23:return e.t1=e.sent,e.t2=R,e.t3=O,e.t4=P,e.t5=d,e.t6=f,e.t7=w,e.t8=c,e.t9=T,e.t10=C,e.t11=S,e.abrupt("return",{lodResources:e.t0,lodRenderer:e.t1,stageResources:e.t2,symbolSize:e.t3,extentPadding:e.t4,isEsriSymbolResource:e.t5,isWosr:e.t6,originalMaterialParameters:e.t7,physicalBasedRenderingEnabled:e.t8,resourceBoundingBox:e.t9,resourceSize:e.t10,pivotOffset:e.t11});case 35:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addDisposeResource",value:function(e){this._disposeResourceHandles.push(e)}},{key:"_createStageResources",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._context.stage,i=MC(t),r!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),n.addMany(i),this._addDisposeResource((function(){return n.removeMany(i)})),a=IC(t),n.addMany(a),this._addDisposeResource((function(){return n.removeMany(a)})),e.next=7,n.load(a);case 7:return o=ZC(t),e.abrupt("return",(n.addMany(o),this._addDisposeResource((function(){return n.removeMany(o)})),{materials:i,textures:a,geometries:o}));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createLodRenderer",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o,s=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._context.stage,i={layerUid:this._context.layer.uid,graphicUid:function(e){return s._instanceIndexToGraphicUid.get(e)},notifyGraphicGeometryChanged:function(e){return s._context.notifyGraphicGeometryChanged(s._instanceIndexToGraphicUid.get(e))},notifyGraphicVisibilityChanged:function(e){return s._context.notifyGraphicVisibilityChanged(s._instanceIndexToGraphicUid.get(e))}},a=this._fastUpdates.enabled?{applyTransform:function(e,t,r){e.getFeatureAttribute(t,$D),(0,Wu.n)(r,Mk(s._fastUpdates.materialParameters,$D,r))},scaleFactor:function(e,t,r){return t.getFeatureAttribute(r,$D),Ik(e,s._fastUpdates.materialParameters,$D)}}:null,(o=new UD(t,this._optionalFields,i,a)).slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((function(){n.removeRenderPlugin(o)})),e.next=5,n.addRenderPlugin(o.slots,o,r);case 5:return e.abrupt("return",o);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getExternalColorParameters",value:function(e){var t={};return this._drivenProperties.color?t.externalColor=lc._:(0,Nu.r)(e)&&(0,Nu.r)(e.color)?t.externalColor=sc.l.toUnitRGBA(e.color):(t.externalColor=lc._,t.colorMixMode="ignore"),t}},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._cleanupResources()}},{key:"_cleanupResources",value:function(){this._disposeResourceHandles.forEach((function(e){return e()})),this._disposeResourceHandles.length=0,this._resources=null}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry))return null;var r=sS(t.geometry);if((0,Nu.t)(r))return this.logger.warn("unsupported geometry type for icon symbol: ".concat(t.geometry.type)),null;var n=this.setGraphicElevationContext(t,new bC),i=e.renderingInfo;return this._createAs3DShape(t,r,i,n,t.uid,e.layer.uid)}},{key:"notifyDestroyGraphicLayer",value:function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}},{key:"graphicLayerToGraphicId",value:function(){return 0}},{key:"layerOpacityChanged",value:function(){if(!(0,Nu.t)(this._resources))for(var e=this._drivenProperties.opacity,t=!this._isPrimitive,r=this._resources.stageResources.materials,n=this._resources.originalMaterialParameters,i=0;i<r.length;i++){var a=r[i],o=(0,Nu.q)(this.symbolLayer,"material","color"),s=n[i],l=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*s.opacity,u=l<1||e||s.transparent;a.setParameters({opacity:l,transparent:u}),this._isPrimitive&&a.setParameters({cullFace:u?vc.n.None:vc.n.Back})}}},{key:"layerElevationInfoChanged",value:function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,GT)}},{key:"slicePlaneEnabledChanged",value:function(){if((0,Nu.t)(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;var e,t=(0,Cu.Z)(this._resources.stageResources.materials);try{for(t.s();!(e=t.n()).done;){e.value.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}}catch(r){t.e(r)}finally{t.f()}return!0}},{key:"physicalBasedRenderingChanged",value:function(){if((0,Nu.t)(this._resources))return!0;var e,t=this._resources,r=t.stageResources,n=t.isWosr,i=(0,Cu.Z)(r.materials);try{for(i.s();!(e=i.n()).done;){var a=e.value;this._isPrimitive?a.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):n||a.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1})}}catch(o){i.e(o)}finally{i.f()}return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"applyRendererDiff",value:function(e,t){if((0,Nu.t)(this._resources))return TC.Recreate_Symbol;var r=this._resources,n=r.stageResources.materials,i=r.lodRenderer,a=r.resourceBoundingBox,o=r.symbolSize,s=r.resourceSize,l=r.pivotOffset;for(var u in e.diff){if("visualVariables"!==u)return TC.Recreate_Symbol;if(!Ak(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,s,l)))return TC.Recreate_Symbol;var c,h=(0,Cu.Z)(n);try{for(h.s();!(c=h.n()).done;){c.value.setParameters(this._fastUpdates.materialParameters)}}catch(d){h.e(d)}finally{h.f()}i.notifyShaderTransformationChanged()}return TC.Fast_Update}},{key:"computeComplexity",value:function(){if((0,Nu.t)(this._resources))return(0,_u.Z)((0,bu.Z)(r.prototype),"computeComplexity",this).call(this);var e=this._resources.lodResources,t=LC(e.levels[0]).reduce((function(e,t){return e+t.indices.get(fc.O.POSITION).length}),0)/3,n=IC(e).reduce((function(e,t){return e+t.estimatedTexMemRequired}),0)/4+ZC(e).reduce((function(e,t){return e+function(e){return Array.from(e.vertexAttributes.values()).reduce((function(e,t){var r,n;return e+(null!==(r=null===(n=t.data.buffer)||void 0===n?void 0:n.byteLength)&&void 0!==r?r:0)}),0)+Array.from(e.indices.values()).reduce((function(e,t){return e+(Array.isArray(t)?12*t.length:t.buffer.byteLength)}),0)}(t)}),0);return{primitivesPerFeature:t,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:(0,Tu.Z)((0,Tu.Z)({},HC(this.symbol,this.symbolLayer)),{},{resourceBytes:n})}}},{key:"_hasLodRenderer",value:function(){return(0,Nu.r)(this._resources)}},{key:"_createAs3DShape",value:function(e,t,r,n,i,a){if(!this._hasLodRenderer()||(0,Nu.t)(this._resources))return null;var o=this.getFastUpdateAttrValues(e),s=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?DT(r.color,r.opacity):null,l=this._context.clippingExtent;if((0,Hu.g)(t,QD,this._context.elevationProvider.spatialReference),(0,Nu.r)(l)&&!(0,Gc.E)(l,QD))return null;var u=this._requiresTerrainElevation(n),c=this._computeGlobalTransform(t,n,JD,eM),h=this._computeLocalTransform(this._resources,this.symbolLayer,r,KD),d=this._resources.lodRenderer.instanceData,f=d.addInstance();this._instanceIndexToGraphicUid.set(f,i),d.setLocalTransform(f,h,!1),d.setGlobalTransform(f,c),o&&d.setFeatureAttribute(f,o),s&&d.setColor(f,s),(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&d.setObjectAndLayerIdColor(f,this._context.stage.renderView._objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:i,layerUid:a}));var p=new cD(this,f,eC,n);return u&&(p.alignedSampledElevation=eM.sampledElevation),p.needsElevationUpdates=GT(n.mode),oS(p,t,this._context.elevationProvider),p}},{key:"_computeGlobalTransform",value:function(e,t,r,n){return zT(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,n),QD[0]=e.x,QD[1]=e.y,QD[2]=n.z,(0,Hu.Z)(e.spatialReference,QD,r,this._context.renderCoordsHelper.spatialReference),r}},{key:"_computeLocalTransform",value:function(e,t,r,n){return(0,Wu.r)(n),this._applyObjectRotation(r,!1,n),this._applyObjectRotation(t,!0,n),this._applyObjectScale(e,r,n),this._applyAnchor(e,t,n),n}},{key:"_applyObjectScale",value:function(e,t,r){if(!this._fastUpdates.enabled||!this._fastUpdates.requiresShaderTransformation){var n=IT(this._drivenProperties.size&&t.size?t.size:e.symbolSize,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===n[0]&&1===n[1]&&1===n[2]||(0,Wu.i)(r,r,n)}}},{key:"prepareSymbolLayerPatch",value:function(e){if("partial"===e.diff.type){var t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}}},{key:"updateGeometry",value:function(e,t){if((0,Nu.t)(this._resources))return!0;var r=t&&sS(t);if((0,Nu.t)(r))return!1;var n=this.getGeometryElevationMode(t);return e.elevationContext.mode===n&&(this._computeGlobalTransform(r,e.elevationContext,JD,eM),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=eM.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,JD,!0),oS(e,r,this._context.elevationProvider),!0)}},{key:"_preparePatchTransform",value:function(e,t){var r=this;if((t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)&&!(0,Nu.t)(this._resources)){var n=function(e,t,r){return(0,Nu.v)(null!=e&&"complete"===e.type?e.newValue:t,r)},i=n(t.heading,this.symbolLayer.heading,0),a=n(t.tilt,this.symbolLayer.tilt,0),o=n(t.roll,this.symbolLayer.roll,0),s=n(t.width,this.symbolLayer.width,void 0),l=n(t.height,this.symbolLayer.height,void 0),u=n(t.depth,this.symbolLayer.depth,void 0),c=n(t.anchor,this.symbolLayer.anchor,void 0),h=n(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;var d={heading:i,tilt:a,roll:o,anchor:c,anchorPosition:h},f=this._resources;this.loadStatus===RC.LOADED&&e.symbolLayerStatePatches.push((function(){f.symbolSize=(0,Vu.a6)((0,Bc.v)(f.resourceSize,{width:s,height:l,depth:u,isPrimitive:r.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push((function(e,t){var n=r._computeLocalTransform(f,d,t,KD),i=e.instanceIndex;f.lodRenderer.instanceData.setLocalTransform(i,n,!0)}))}}},{key:"_preparePatchColor",value:function(e,t){var r=this;if(t.material&&"partial"===t.material.type){var n=t.material.diff;if(n.color&&"complete"===n.color.type&&null!=n.color.newValue&&null!=n.color.oldValue){var i=n.color.newValue,a=(0,Nu.r)(i)?sc.l.toUnitRGBA(i):lc._;delete n.color;var o=this._resources;(0,Nu.t)(o)||e.graphics3DGraphicPatches.push((function(e){var t;r._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=r._setMaterialTransparencyParams({},i)):t=r._setMaterialTransparencyParams({externalColor:a},i);var n,s=(0,Cu.Z)(o.stageResources.materials);try{for(s.s();!(n=s.n()).done;){n.value.setParameters(t)}}catch(l){s.e(l)}finally{s.f()}}))}}}},{key:"_requiresTerrainElevation",value:function(e){return"absolute-height"!==e.mode}},{key:"_applyObjectRotation",value:function(e,t,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,hc.e)(),i=e||0,a=t||0,o=r||0;return 0!==i&&(0,Wu.m)(n,n,-i/180*Math.PI),0!==a&&(0,Wu.b)(n,n,a/180*Math.PI),0!==o&&(0,Wu.l)(n,n,o/180*Math.PI),n}(e.heading,e.tilt,e.roll,r)}},{key:"_computeAnchor",value:function(e,t,r){var n=(0,Vu.n)();switch(r.anchor){case"center":(0,Vu.r)(n,(0,Gc.p)(e)),(0,Vu.q)(n,n);break;case"top":var i=(0,Gc.p)(e);(0,Vu.o)(n,-i[0],-i[1],-e[5]);break;case"bottom":var a=(0,Gc.p)(e);(0,Vu.o)(n,-a[0],-a[1],-e[2]);break;case"relative":var o=(0,Gc.p)(e),s=(0,Gc.F)(e),l=r.anchorPosition,u=l?(0,Vu.c)(l.x,l.y,l.z):Vu.a7;(0,Vu.a9)(n,s,u),(0,Vu.u)(n,n,o),(0,Vu.q)(n,n);break;default:(0,Nu.r)(t)?(0,Vu.q)(n,t):(0,Vu.r)(n,Vu.a7)}return n}},{key:"_applyAnchor",value:function(e,t,r){if(!this._fastUpdates.enabled||!this._fastUpdates.requiresShaderTransformation){var n=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);n&&(0,Wu.c)(r,r,n)}}},{key:"_hasPerInstanceColor",value:function(){return this._drivenProperties.color||this._drivenProperties.opacity}},{key:"_fastVisualVariableConvertOptions",value:function(e,t,r,n){var i=(0,Nu.r)(e)?(0,Vu.a6)((0,Gc.F)(e)):Vu.l,a=(0,Nu.r)(e)?this._computeAnchor(e,n,this.symbolLayer):Vu.a7,o=this._context.renderCoordsHelper.unitInMeters,s=IT((0,Nu.r)(t)?t:void 0,t,r,o),l=(0,Vu.c)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:i,symbolSize:(0,Nu.r)(t)?t:Vu.l,unitInMeters:o,transformation:{anchor:a,scale:s,rotation:l}}}}]),r}(WC),QD=(0,Vu.n)(),KD=(0,hc.e)(),JD=(0,hc.e)(),$D=(0,lc.n)(),eM=new qT;function tM(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e}function rM(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=r[0],l=r[1],u=r[2],c=r[3];return e[0]=n*s+a*l,e[1]=i*s+o*l,e[2]=n*u+a*c,e[3]=i*u+o*c,e}function nM(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}var iM=rM,aM=nM;Object.freeze(Object.defineProperty({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:tM,transpose:function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r*a-i*n;return o?(o=1/o,e[0]=a*o,e[1]=-n*o,e[2]=-i*o,e[3]=r*o,e):null},adjoint:function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:rM,rotate:function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(r),l=Math.cos(r);return e[0]=n*l+a*s,e[1]=i*l+o*s,e[2]=n*-s+a*l,e[3]=i*-s+o*l,e},scale:function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=r[0],l=r[1];return e[0]=n*s,e[1]=i*s,e[2]=a*l,e[3]=o*l,e},fromRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},LDU:function(e,t,r,n){return e[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-e[2]*r[1],[e,t,r]},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},subtract:nM,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){var r=e[0],n=e[1],i=e[2],a=e[3],o=t[0],s=t[1],l=t[2],u=t[3],c=(0,Vu.d)();return Math.abs(r-o)<=c*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-s)<=c*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-l)<=c*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-u)<=c*Math.max(1,Math.abs(a),Math.abs(u))},multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},multiplyScalarAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},mul:iM,sub:aM},Symbol.toStringTag,{value:"Module"}));var oM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o,s,l){var u;return(0,Au.Z)(this,r),(u=t.call(this,e,n,vc.a.Triangle,l)).path=i,u.geometrySR=a,u.upVectorAlignment=o,u.stencilWidth=s,u}return(0,ku.Z)(r)}(dc.M);function sM(e){return"upVectorAlignment"in e}function lM(){return[1,0,0,1]}function uM(){return{up:(0,Vu.n)(),right:(0,Vu.n)()}}function cM(e,t,r){(0,Vu.O)(e.up,t.up,r),(0,Vu.O)(e.right,t.right,r)}function hM(e,t,r){(0,uc.r)(e,(0,Vu.P)(r,t.right),(0,Vu.P)(r,t.up))}Object.freeze(Object.defineProperty({__proto__:null,create:lM,clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,r,n){return[e,t,r,n]},createView:function(e,t){return new Float64Array(e,t,4)}},Symbol.toStringTag,{value:"Module"}));var dM=function(){function e(){(0,Au.Z)(this,e),this.pos=(0,Vu.n)(),this.posES=(0,Vu.n)(),this.posGS=(0,Vu.n)(),this.vRight=(0,Vu.n)(),this.vLeft=(0,Vu.n)(),this.frame=uM(),this.rotationFrame=uM(),this.rotationRight=(0,cc.n)(),this.rotationAngle=0,this.miterStretch=[1,0,0,1]}return(0,ku.Z)(e,[{key:"setFrameFromUpVector",value:function(e){(0,Vu.r)(this.frame.up,e),(0,Vu.u)(EM,this.vLeft,this.vRight),(0,Vu.z)(EM,EM),(0,Vu.g)(kM,this.frame.up,(0,Vu.P)(EM,this.frame.up)),(0,Vu.e)(IM,EM,kM),(0,Vu.z)(IM,IM),(0,Vu._)(this.frame.right,IM,this.frame.up)}},{key:"computeRotationAxisAndAngleFromUpVector",value:function(){(0,Vu.r)(this.rotationFrame.up,this.frame.up),(0,Vu.r)(this.rotationFrame.right,this.frame.right),(0,uc.r)(this.rotationRight,1,0),(0,Vu.g)(kM,this.frame.up,(0,Vu.P)(this.frame.up,this.vLeft)),(0,Vu.e)(kM,this.vLeft,kM),(0,Vu.q)(kM,kM),(0,Vu.z)(kM,kM),(0,Vu.g)(EM,this.frame.up,(0,Vu.P)(this.frame.up,this.vRight)),(0,Vu.e)(EM,this.vRight,EM),(0,Vu.z)(EM,EM),(0,Vu._)(DM,this.rotationFrame.up,this.vLeft);var e=Math.sign((0,Vu.P)(DM,this.vRight));if(this.rotationAngle=e*(Math.PI-(0,Vu.i)((0,Vu.P)(kM,EM))),Math.abs(this.rotationAngle)>0){var t=(0,Vu.aa)(Math.cos(.5*this.rotationAngle));tM(this.miterStretch,t-1+1,0,0,1)}var r=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*r))}}]),e}(),fM=function(){function e(){(0,Au.Z)(this,e),this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}return(0,ku.Z)(e,[{key:"addVertex",value:function(e,t){return this.vertices.push((0,cc.t)(e)),this.vertexNormals.push((0,cc.t)(t)),this.vertices.length-1}},{key:"addUV",value:function(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}},{key:"addPole",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.poles.push({position:(0,cc.t)(e),normal:t?(0,cc.t)(t):null}),this.poles.length-1}},{key:"addSegment",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}},{key:"numSegments",get:function(){return this.vertexIndices.length/2}},{key:"hasUV",value:function(){return null!=this.uvs}},{key:"translate",value:function(e,t){var r,n=(0,Cu.Z)(this.vertices);try{for(n.s();!(r=n.n()).done;){var i=r.value;i[0]+=e,i[1]+=t}}catch(l){n.e(l)}finally{n.f()}var a,o=(0,Cu.Z)(this.poles);try{for(o.s();!(a=o.n()).done;){var s=a.value;s.position[0]+=e,s.position[1]+=t}}catch(l){o.e(l)}finally{o.f()}}}],[{key:"circle",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,r=.5,n=new e,i={v0:0,v1:0};n.addPole((0,cc.r)(0,0));for(var a=0;a<t;++a){var o=2*a*Math.PI/t,s=Math.cos(o),l=Math.sin(o),u=(0,cc.r)(s*r,l*r),c=(0,cc.r)(s,l);n.addVertex(u,c),n.addUV(a/t)}n.addUV(1);for(var h=0;h<t-1;++h){var d={v0:h,v1:h+1},f=d;n.addSegment(d,f,i)}var p={v0:t-1,v1:0},v={v0:t-1,v1:t};return n.addSegment(p,v,i),n}},{key:"rect",value:function(){var t=new e,r=(0,cc.r)(-.5,-.5),n=(0,cc.r)(.5,-.5),i=(0,cc.r)(.5,.5),a=(0,cc.r)(-.5,.5),o=(0,cc.r)(0,-1),s=(0,cc.r)(1,0),l=(0,cc.r)(0,1),u=(0,cc.r)(-1,0);t.addUV(0),t.addUV(1),t.addPole((0,cc.r)(0,.5),l),t.addPole((0,cc.r)(0,.5)),t.addPole((0,cc.r)(0,-.5)),t.addPole((0,cc.r)(0,-.5),o);var c={v0:0,v1:1};return t.addVertex(r,o),t.addVertex(n,o),t.addSegment({v0:0,v1:1},c,{v0:3,v1:3}),t.addVertex(n,s),t.addVertex(i,s),t.addSegment({v0:2,v1:3},c,{v0:2,v1:1}),t.addVertex(i,l),t.addVertex(a,l),t.addSegment({v0:4,v1:5},c,{v0:0,v1:0}),t.addVertex(a,u),t.addVertex(r,u),t.addSegment({v0:6,v1:7},c,{v0:1,v1:2}),t}}]),e}(),pM=function(){function e(t){(0,Au.Z)(this,e),this.vertices=[],this.offset=(0,Vu.n)(),this.xform=(0,hc.e)(),this.vertices=t;var r=Math.floor((t.length-1)/2);(0,Vu.r)(this.offset,this.vertices[r].pos);var n,i=(0,Cu.Z)(this.vertices);try{for(i.s();!(n=i.n()).done;){var a=n.value;(0,Vu.e)(a.pos,a.pos,this.offset)}}catch(o){i.e(o)}finally{i.f()}(0,Wu.c)(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}return(0,ku.Z)(e,[{key:"updatePathVertexInformation",value:function(){var e=this.vertices.length,t=this.vertices[0];t.index=0,(0,Vu.o)(t.vLeft,0,0,0),t.vLeftLength=0,(0,Vu.e)(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=(0,Vu.s)(t.vRight),(0,Vu.z)(t.vRight,t.vRight);for(var r=t,n=1;n<e;++n)(t=this.vertices[n]).index=n,(0,Vu.r)(t.vLeft,r.vRight),t.vLeftLength=r.vRightLength,n<e-1?((0,Vu.e)(t.vRight,this.vertices[n+1].pos,t.pos),t.vRightLength=(0,Vu.s)(t.vRight),(0,Vu.z)(t.vRight,t.vRight)):((0,Vu.r)(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),r=t}}]),e}();var vM=function(){function e(){(0,Au.Z)(this,e)}return(0,ku.Z)(e,[{key:"numProfilesPerJoin",value:function(){return 1}},{key:"extrude",value:function(e,t,r){for(var n=0;n<t.vertices.length;++n)r(e.index,e.frame,t.vertices[n],t.vertexNormals[n],!1)}}]),e}(),mM=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.8*Math.PI,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,Au.Z)(this,e),this.cutoffAngle=t,this.numBendSubdivisions=r}return(0,ku.Z)(e,[{key:"numProfilesPerJoin",value:function(){return this.numBendSubdivisions+1}},{key:"extrude",value:function(e,t,r){var n=LM;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(var i=0;i<this.numBendSubdivisions+1;++i){(0,Wu.g)(ZM,.5*-e.rotationAngle+i*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),cM(n,e.frame,ZM);for(var a=0;a<t.vertices.length;++a)(0,uc.j)(t.vertices[a],e.rotationRight)*e.rotationAngle>=0?r(e.index,n,t.vertices[a],t.vertexNormals[a],!1):((0,uc._)(PM,t.vertices[a],e.miterStretch),r(e.index,e.frame,PM,t.vertexNormals[a],!0))}else for(var o=0;o<this.numBendSubdivisions+1;++o)for(var s=0;s<t.vertices.length;++s){var l=(0,uc.j)(t.vertices[s],e.rotationRight)*e.rotationAngle>=0;(0,uc._)(PM,t.vertices[s],e.miterStretch),r(e.index,e.frame,PM,t.vertexNormals[s],!l)}}}]),e}(),yM={generateUV:!1},gM=function(){function e(){(0,Au.Z)(this,e)}return(0,ku.Z)(e,[{key:"rebuildConnectingProfileGeometry",value:function(e,t,r){for(var n=0;n<t.vertices.length;++n)r(e.index,e.frame,t.vertices[n],t.vertexNormals[n],0,0)}}]),e}(),_M=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.call(this)}return(0,ku.Z)(r,[{key:"getNumVertices",value:function(){return 0}},{key:"getNumIndices",value:function(){return 0}},{key:"rebuildCapGeometry",value:function(){}},{key:"buildTopology",value:function(){}}]),r}(gM),bM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,Au.Z)(this,r),(n=t.call(this)).profile=e,n.profilePlaneOffset=i,n.flip=a,n}return(0,ku.Z)(r,[{key:"getNumVertices",value:function(){return this.profile.vertices.length}},{key:"getNumIndices",value:function(){return 3*this.profile.numSegments}},{key:"rebuildConnectingProfileGeometry",value:function(e,t,r){for(var n=0;n<t.vertices.length;++n)r(e.index,e.frame,t.vertices[n],t.vertexNormals[n],this.profilePlaneOffset,0)}},{key:"rebuildCapGeometry",value:function(e,t){var r=RM;(0,uc.r)(r,0,0);for(var n=this.flip?1:-1,i=0;i<this.profile.vertices.length;++i)t(e.index,e.frame,this.profile.vertices[i],r,this.profilePlaneOffset,n)}},{key:"buildTopology",value:function(e,t){for(var r=this.vertexBufferStart+this.profile.vertexIndices[0],n=1;n<this.profile.numSegments;++n){var i=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],o=this.vertexBufferStart+i,s=this.vertexBufferStart+a;this.flip?t(s,o,r):t(r,o,s)}}}]),r}(gM),xM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this)).flip=!1,n.sign=0,n.breakNormals=!1,n.numSegments=3,n.profile=e.profile,n.flip=e.flip,n.sign=n.flip?1:-1,n.breakNormals=e.breakNormals,n.numSegments=e.subdivisions,n}return(0,ku.Z)(r,[{key:"getNumVertices",value:function(){var e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length}},{key:"getNumIndices",value:function(){var e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(var t=0;t<this.profile.numSegments;++t){var r=this.profile.vertexIndices[2*t+0],n=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[r]===this.profile.poleIndices[n]?e+=1:e+=2}return 3*e}},{key:"rebuildCapGeometry",value:function(e,t){var r=e.frame,n=.5*this.sign,i=PM,a=RM;(0,uc.r)(a,0,0);for(var o=0;o<this.profile.poles.length;++o){var s=this.profile.poles[o];s.normal?t(e.index,r,s.position,s.normal,n,0):t(e.index,r,s.position,a,n,this.sign)}if(this.breakNormals)for(var l=0;l<this.profile.vertices.length;++l)t(e.index,r,this.profile.vertices[l],this.profile.vertexNormals[l],0,0);for(var u=0;u<this.numSegments-1;++u)for(var c=(1-(u+1)/this.numSegments)*Math.PI*.5,h=Math.sin(c),d=Math.cos(c),f=0;f<this.profile.vertices.length;++f){var p=this.profile.poles[this.profile.poleIndices[f]];(0,uc.o)(i,this.profile.vertices[f],p.position),(0,uc.l)(i,i,h),p.normal?((0,uc.s)(i,i,p.position),t(e.index,r,i,p.normal,n*d,0)):((0,uc.v)(a,i),(0,uc.l)(a,a,h),(0,uc.s)(i,i,p.position),t(e.index,r,i,a,n*d,this.sign*d))}}},{key:"buildTopology",value:function(e,t){for(var r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,n=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length,i=0;i<this.profile.numSegments;++i){for(var a=this.profile.vertexIndices[2*i+0],o=this.profile.vertexIndices[2*i+1],s=this.vertexBufferStart+this.profile.poleIndices[a],l=this.vertexBufferStart+this.profile.poleIndices[o],u=r+a,c=r+o,h=0;h<this.numSegments-1;++h){var d=n+h*this.profile.vertices.length+a,f=n+h*this.profile.vertices.length+o;this.flip?(t(d,c,u),t(c,d,f)):(t(u,c,d),t(f,d,c)),u=d,c=f}this.flip?(t(s,c,u),s!==l&&t(s,l,c)):(t(u,c,s),s!==l&&t(c,l,s))}}}]),r}(gM),wM=function(){function e(t,r,n,i,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:yM;(0,Au.Z)(this,e),this.options=o,this._extrusionVertexCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=r,this.path=t,this.extruder=n,this.startCap=i,this.endCap=a;var s=this.path.vertices.length-2;this.numExtrusionProfiles=n.numProfilesPerJoin()*s+2,this.numVerticesTotal=r.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;var l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;var u=this.endCap.getNumVertices();this.numVerticesTotal+=u,this.numNormalsTotal+=u,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}return(0,ku.Z)(e,[{key:"emitVertex",value:function(e,t,r,n,i){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=n[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=n[1],this.pathVertexData[this._extrusionVertexCount]=e,i){var a=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=a.rotationRight[0]*a.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=a.rotationRight[1]*a.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}},{key:"emitCapVertex",value:function(e,t,r,n,i,a){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=n[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=n[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=i,this.profileUpAxisData[4*this._extrusionVertexCount+3]=a,++this._extrusionVertexCount}},{key:"emitTriangle",value:function(e,t,r){this.vertexIndices.push(e),this.vertexIndices.push(t),this.vertexIndices.push(r),this.pathVertexIndices.push(this.pathVertexData[e]),this.pathVertexIndices.push(this.pathVertexData[t]),this.pathVertexIndices.push(this.pathVertexData[r]),this.normalIndices.push(e),this.normalIndices.push(t),this.normalIndices.push(r)}},{key:"_rebuildGeometry",value:function(){var e=this,t=function(t,r,n,i,a){return e.emitVertex(t,r,n,i,a)},r=function(t,r,n,i,a,o){return e.emitCapVertex(t,r,n,i,a,o)};this._extrusionVertexCount=0;var n,i=(0,Cu.Z)(this.path.vertices);try{for(i.s();!(n=i.n()).done;){var a=n.value;this.originData[3*a.index+0]=a.pos[0],this.originData[3*a.index+1]=a.pos[1],this.originData[3*a.index+2]=a.pos[2]}}catch(l){i.e(l)}finally{i.f()}this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,r);for(var o=1;o<this.path.vertices.length-1;++o)this.extruder.extrude(this.path.vertices[o],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,r),this.startCap.rebuildCapGeometry(this.path.vertices[0],r),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],r),this.profile.hasUV()&&this.options.generateUV)for(var s=0;s<this.profile.uvs.length;++s)this.uvData[2*s+0]=this.profile.uvs[s],this.uvData[2*s+1]=0}},{key:"buildTopology",value:function(){var e=this,t=this.profile.vertices.length,r=this.profile.numSegments,n=this.numExtrusionProfiles-1,i=r*n*2*3;this.startCap.indexBufferStart=i,this.startCap.firstProfileVertexIndex=0,i+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=i,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),this.vertexIndices=new Array,this.normalIndices=new Array,this.pathVertexIndices=new Array,this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Array);for(var a=0;a<r;++a)for(var o=this.profile.vertexIndices[2*a],s=this.profile.vertexIndices[2*a+1],l=0;l<n;++l){var u=l*t+o,c=(l+1)*t+o,h=(l+1)*t+s,d=l*t+s;this.emitTriangle(u,c,h),this.emitTriangle(u,h,d)}var f=function(t,r,n){return e.emitTriangle(t,r,n)};this.startCap.buildTopology(this.path.vertices[0],f),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],f)}},{key:"onPathChanged",value:function(){this._rebuildGeometry()}}]),e}(),TM=function(){function e(t){(0,Au.Z)(this,e),this.builder=t}return(0,ku.Z)(e,[{key:"xform",get:function(){return this.builder.path.xform}},{key:"onPathChanged",value:function(){this.builder.onPathChanged()}}]),e}(),CM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).vertexAttributePosition=null,n.vertexAttributeNormal=null,n.vertexAttributeColor=null,n.vertexAttributePosition=new Float32Array(3*n.builder.numVerticesTotal),n.vertexAttributeNormal=new Float32Array(3*n.builder.numNormalsTotal),n.vertexAttributeColor=new Uint8Array(4),n.vertexAttributeColor[0]=255,n.vertexAttributeColor[1]=255,n.vertexAttributeColor[2]=255,n.vertexAttributeColor[3]=255,n}return(0,ku.Z)(r,[{key:"bakeVertexColors",value:function(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}},{key:"bake",value:function(e){this.size=e;for(var t=0;t<this.builder.numVerticesTotal;++t){var r=this.builder.pathVertexData[t],n=0===r||r===this.builder.path.vertices.length-1;r*=3;var i=OM;(0,Vu.o)(i,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);var a=4*t,o=kM,s=PM,l=EM,u=DM,c=MM,h=0,d=0;if((0,Vu.o)(u,this.builder.profileRightAxisData[a],this.builder.profileRightAxisData[a+1],this.builder.profileRightAxisData[a+2]),(0,Vu.o)(c,this.builder.profileUpAxisData[a],this.builder.profileUpAxisData[a+1],this.builder.profileUpAxisData[a+2]),(0,uc.r)(s,this.builder.profileVertexAndNormalData[a]*e[0],this.builder.profileVertexAndNormalData[a+1]*e[1]),n)(0,Vu._)(l,c,u),h=this.builder.profileRightAxisData[a+3]*e[0],d=this.builder.profileUpAxisData[a+3];else{var f=RM,p=AM;(0,uc.r)(f,this.builder.profileRightAxisData[a+3],this.builder.profileUpAxisData[a+3]);var v=(0,uc.q)(f);(0,uc.v)(f,f);var m=(0,uc.j)(s,f);if(Math.abs(m)>v){(0,uc.r)(p,-f[1],f[0]);var y=(0,uc.j)(s,p);(0,uc.l)(f,f,v*Math.sign(m)),(0,uc.l)(p,p,y),(0,uc.s)(s,f,p)}(0,Vu.o)(l,0,0,0)}(0,Vu.o)(o,u[0]*s[0]+c[0]*s[1],u[1]*s[0]+c[1]*s[1],u[2]*s[0]+c[2]*s[1]),this.vertexAttributePosition[3*t+0]=i[0]+o[0]+l[0]*h,this.vertexAttributePosition[3*t+1]=i[1]+o[1]+l[1]*h,this.vertexAttributePosition[3*t+2]=i[2]+o[2]+l[2]*h;var g=PM;(0,uc.r)(g,this.builder.profileVertexAndNormalData[a+2],this.builder.profileVertexAndNormalData[a+3]),this.vertexAttributeNormal[3*t+0]=u[0]*g[0]+c[0]*g[1]+l[0]*d,this.vertexAttributeNormal[3*t+1]=u[1]*g[0]+c[1]*g[1]+l[1]*d,this.vertexAttributeNormal[3*t+2]=u[2]*g[0]+c[2]*g[1]+l[2]*d}}},{key:"createGeometryData",value:function(){var e=[[fc.O.POSITION,this.builder.vertexIndices],[fc.O.NORMAL,this.builder.normalIndices]],t=[[fc.O.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[fc.O.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){var r=this.builder.vertexIndices.length;e.push([fc.O.COLOR,new Array(r).fill(0)]),t.push([fc.O.COLOR,{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:t,indices:e}}},{key:"onPathChanged",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"onPathChanged",this).call(this),this.bake(this.size)}},{key:"intersect",value:function(e,t,r){var n=this.builder.vertexIndices,i={size:3,data:this.vertexAttributePosition},a=n.length/3;(0,dc.a$)(e,t,0,a,n,i,void 0,void 0,r)}}]),r}(TM),SM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;(0,Au.Z)(this,r),(o=t.call(this,e)).sizeAttributeValue=n,o.colorAttributeValue=i,o.opacityAttributeValue=a,o.vvData=null,o.baked=new CM(e),o.vvData=new Float32Array(4*o.builder.path.vertices.length);for(var s=0;s<o.builder.path.vertices.length;++s){o.vvData[4*s+0]=n,o.vvData[4*s+1]=i,o.vvData[4*s+2]=a;var l=0===s||s===o.builder.path.vertices.length-1;o.vvData[4*s+3]=l?1:0}return o}return(0,ku.Z)(r,[{key:"createGeometryData",value:function(){return{vertexAttributes:[[fc.O.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[fc.O.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[fc.O.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[fc.O.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[fc.O.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[fc.O.POSITION,this.builder.pathVertexIndices],[fc.O.PROFILERIGHT,this.builder.vertexIndices],[fc.O.PROFILEUP,this.builder.vertexIndices],[fc.O.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[fc.O.FEATUREVALUE,this.builder.pathVertexIndices]]}}}]),r}(TM),OM=(0,Vu.n)(),PM=(0,cc.n)(),RM=(0,cc.n)(),AM=(0,cc.n)(),kM=(0,Vu.n)(),EM=(0,Vu.n)(),DM=(0,Vu.n)(),MM=(0,Vu.n)(),IM=(0,Vu.n)(),LM=uM(),ZM=(0,hc.e)();function NM(e,t){e.attributes.add(fc.O.FEATUREVALUE,"vec4");var r=e.vertex;r.code.add((0,dc.n)(Sn||(Sn=(0,wu.Z)(["bool isCapVertex() {\nreturn featureValue.w == 1.0;\n}"])))),r.uniforms.add(new dc.b("size",(function(e){return e.size}))),t.vvSize?(r.uniforms.add(new dc.c("vvSizeMinSize",(function(e){return e.vvSizeMinSize}))),r.uniforms.add(new dc.c("vvSizeMaxSize",(function(e){return e.vvSizeMaxSize}))),r.uniforms.add(new dc.c("vvSizeOffset",(function(e){return e.vvSizeOffset}))),r.uniforms.add(new dc.c("vvSizeFactor",(function(e){return e.vvSizeFactor}))),r.code.add((0,dc.n)(On||(On=(0,wu.Z)(["vec2 getSize() {\nreturn size * clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;\n}"]))))):r.code.add((0,dc.n)(Pn||(Pn=(0,wu.Z)(["vec2 getSize(){\nreturn size;\n}"])))),t.vvOpacity?(r.constants.add("vvOpacityNumber","int",8),r.uniforms.add([new dc.a6("vvOpacityValues",(function(e){return e.vvOpacityValues}),8),new dc.a6("vvOpacityOpacities",(function(e){return e.vvOpacityOpacities}),8)]),r.code.add((0,dc.n)(Rn||(Rn=(0,wu.Z)(["vec4 applyOpacity(vec4 color) {\nfloat value = featureValue.z;\nif (value <= vvOpacityValues[0]) {\nreturn vec4( color.xyz, vvOpacityOpacities[0]);\n}\nfor (int i = 1; i < vvOpacityNumber; ++i) {\nif (vvOpacityValues[i] >= value) {\nfloat f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\nreturn vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));\n}\n}\nreturn vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);\n}"]))))):r.code.add((0,dc.n)(An||(An=(0,wu.Z)(["vec4 applyOpacity(vec4 color){\nreturn color;\n}"])))),t.vvColor?(r.constants.add("vvColorNumber","int",dc.a5),r.uniforms.add([new dc.a6("vvColorValues",(function(e){return e.vvColorValues}),dc.a5),new dc.a4("vvColorColors",(function(e){return e.vvColorColors}),dc.a5)]),r.code.add((0,dc.n)(kn||(kn=(0,wu.Z)(["vec4 getColor() {\nfloat value = featureValue.y;\nif (value <= vvColorValues[0]) {\nreturn applyOpacity(vvColorColors[0]);\n}\nfor (int i = 1; i < vvColorNumber; ++i) {\nif (vvColorValues[i] >= value) {\nfloat f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\nreturn applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));\n}\n}\nreturn applyOpacity(vvColorColors[vvColorNumber - 1]);\n}"]))))):r.code.add((0,dc.n)(En||(En=(0,wu.Z)(["vec4 getColor(){\nreturn applyOpacity(vec4(1, 1, 1, 1));\n}"])))),e.include(dc.b0),e.attributes.add(fc.O.PROFILERIGHT,"vec4"),e.attributes.add(fc.O.PROFILEUP,"vec4"),e.attributes.add(fc.O.PROFILEVERTEXANDNORMAL,"vec4"),r.code.add((0,dc.n)(Dn||(Dn=(0,wu.Z)(["vec3 calculateVPos() {\nvec2 size = getSize();\nvec3 origin = position;\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileVertex = profileVertexAndNormal.xy * size;\nvec2 profileNormal = profileVertexAndNormal.zw;\nfloat positionOffsetAlongProfilePlaneNormal = 0.0;\nfloat normalOffsetAlongProfilePlaneNormal = 0.0;"])))),r.code.add((0,dc.n)(Mn||(Mn=(0,wu.Z)(["if(!isCapVertex()) {\nvec2 rotationRight = vec2(profileRight.w, profileUp.w);\nfloat maxDistance = length(rotationRight);"])))),r.code.add((0,dc.n)(In||(In=(0,wu.Z)(["rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);\nfloat rx = dot(profileVertex, rotationRight);\nif (abs(rx) > maxDistance) {\nvec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);\nfloat ry = dot(profileVertex, rotationUp);\nprofileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;\n}\n}else{\npositionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];\nnormalOffsetAlongProfilePlaneNormal = profileUp.w;\n}\nvec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;\nreturn origin + offset;\n}"])))),r.code.add((0,dc.n)(Ln||(Ln=(0,wu.Z)(["vec3 localNormal() {\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileNormal = profileVertexAndNormal.zw;\nvec3 normal = right * profileNormal.x + up * profileNormal.y;\nif(isCapVertex()) {\nnormal += forward * profileUp.w;\n}\nreturn normal;\n}"]))))}var FM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).size=(0,cc.r)(1,1),e}return(0,ku.Z)(r)}(dc.aG);function zM(e){var t=new dc.o,r=t.vertex,n=t.fragment;switch((0,dc.T)(r,e),t.varyings.add("vpos","vec3"),t.include(NM,e),e.output!==dc.O.Color&&e.output!==dc.O.Alpha||(t.include(dc.K,e),t.include(dc.aK,e),t.include(dc.aJ,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.code.add((0,dc.n)(Zn||(Zn=(0,wu.Z)(["\n      void main() {\n        vpos = calculateVPos();\n        vnormal = normalize(localNormal());\n\n        ","\n        gl_Position = transformPosition(proj, view, vpos);\n\n        ","\n\n        vcolor = getColor();\n      }\n    "])),e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":"",e.output===dc.O.Color?"forwardLinearDepth();":""))),t.include(dc.aw,e),e.output){case dc.O.Alpha:t.include(dc.a0,e),n.uniforms.add(new dc.g("opacity",(function(e){return e.opacity}))),n.code.add((0,dc.n)(Nn||(Nn=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        float combinedOpacity = vcolor.a * opacity;\n        gl_FragColor = vec4(combinedOpacity);\n      }\n    "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""));break;case dc.O.Color:t.include(dc.a0,e),t.include(dc.b2,e),t.include(dc.b3,e),t.include(dc.aK,e),t.include(dc.b4,e),(0,dc.U)(n,e),(0,dc.b5)(n),(0,dc.b6)(n),n.uniforms.add([r.uniforms.get("localOrigin"),new dc.c("ambient",(function(e){return e.ambient})),new dc.c("diffuse",(function(e){return e.diffuse})),new dc.c("specular",(function(e){return e.specular})),new dc.g("opacity",(function(e){return e.opacity}))]),n.include(dc.x),(0,dc.w)(n),n.code.add((0,dc.n)(Fn||(Fn=(0,wu.Z)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          shadingParams.viewDirection = normalize(vpos - cameraPosition);\n          shadingParams.normalView = vnormal;\n          vec3 normal = shadingNormal(shadingParams);\n          float ssao = evaluateAmbientOcclusionInverse();\n\n          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n          ","\n          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one\n          float combinedOpacity = vcolor.a * opacity;\n          albedo += 0.25 * specular; // don't completely ignore specular for now\n\n          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);\n          gl_FragColor = vec4(shadedColor, combinedOpacity);\n          gl_FragColor = highlightSlice(gl_FragColor, vpos);\n          ","\n        }\n      "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;",e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""));break;case dc.O.Depth:case dc.O.Shadow:case dc.O.ShadowHighlight:case dc.O.ShadowExludeHighlight:t.include(dc.K,e),(0,dc.b1)(t),t.varyings.add("depth","float"),r.code.add((0,dc.n)(zn||(zn=(0,wu.Z)(["void main() {\nvpos = calculateVPos();\ngl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);\n}"])))),t.include(dc.a0,e),t.include(dc.at,e),n.code.add((0,dc.n)(Un||(Un=(0,wu.Z)(["void main() {\ndiscardBySlice(vpos);\noutputDepth(depth);\n}"]))));break;case dc.O.Normal:t.include(dc.K,e),t.include(_R,e),(0,dc.W)(r),t.varyings.add("vnormal","vec3"),r.code.add((0,dc.n)(Vn||(Vn=(0,wu.Z)(["void main(void) {\nvpos = calculateVPos();\nvnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),t.include(dc.a0,e),n.code.add((0,dc.n)(Bn||(Bn=(0,wu.Z)(["void main() {\ndiscardBySlice(vpos);\nvec3 normal = normalize(vnormal);\nif (gl_FrontFacing == false) normal = -normal;\ngl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n}"]))));break;case dc.O.Highlight:t.include(dc.K,e),t.include(_R,e),t.varyings.add("vnormal","vec3"),r.code.add((0,dc.n)(Gn||(Gn=(0,wu.Z)(["void main(void) {\nvpos = calculateVPos();\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),t.include(dc.a0,e),t.include(dc.a9,e),n.code.add((0,dc.n)(Hn||(Hn=(0,wu.Z)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))}return t}var UM=Object.freeze(Object.defineProperty({__proto__:null,build:zM},Symbol.toStringTag,{value:"Module"})),VM=new Map([[fc.O.POSITION,0],[fc.O.PROFILERIGHT,1],[fc.O.PROFILEUP,2],[fc.O.PROFILEVERTEXANDNORMAL,3],[fc.O.FEATUREVALUE,4]]),BM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).ambient=(0,Vu.c)(.2,.2,.2),e.diffuse=(0,Vu.c)(.8,.8,.8),e.specular=(0,Vu.c)(0,0,0),e.opacity=1,e}return(0,ku.Z)(r)}(FM),GM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2,t.spherical=e.viewingMode===ic.l.Global,t.doublePrecisionRequiresObfuscation=(0,dc.aL)(e.rctx)}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),VM)}},{key:"initializePipeline",value:function(){var e=this.configuration.transparencyPassType,t=this.configuration,r=e===vc.o.NONE,n=e===vc.o.FrontFace;return(0,vc.W)({blending:t.output!==dc.O.Color&&t.output!==dc.O.Alpha||!t.transparent?null:r?vc.d:(0,vc.A)(e),culling:t.hasSlicePlane&&!t.transparent&&!(t.doubleSidedMode===dc.b7.None)&&vc.j,depthTest:{func:(0,vc.e)(e)},depthWrite:r||n?vc.b:null,colorWrite:vc._,stencilWrite:t.hasOccludees?dc.ax:null,stencilTest:t.hasOccludees?dc.az:null,polygonOffset:r||n?null:vc.f})}}]),r}(dc.k);GM.shader=new dc.m(UM,(function(){return r.e(2154).then(r.bind(r,92154))}));var HM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.doubleSidedMode=dc.b7.None,e.transparencyPassType=vc.o.NONE,e.spherical=!1,e.receiveShadows=!1,e.receiveAmbientOcclusion=!1,e.vvSize=!1,e.vvColor=!1,e.vvOpacity=!1,e.hasSlicePlane=!1,e.transparent=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.doublePrecisionRequiresObfuscation=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],HM.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:dc.b7.COUNT})],HM.prototype,"doubleSidedMode",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],HM.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"receiveShadows",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"receiveAmbientOcclusion",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"vvSize",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"vvColor",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"vvOpacity",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"transparent",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],HM.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.B.Disabled})],HM.prototype,"pbrMode",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],HM.prototype,"hasVvInstancing",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],HM.prototype,"useCustomDTRExponentForWater",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],HM.prototype,"useFillLights",void 0);var jM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new WM)).supportsEdges=!0,n._vertexAttributeLocations=VM,n._configuration=new HM,n._vertexBufferLayout=r.getVertexBufferLayout(n.parameters),n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==dc.O.Color&&e!==dc.O.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?dc.b7.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?dc.b7.WindingOrder:dc.b7.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.ready&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"isVisibleForOutput",value:function(e){return e!==dc.O.Shadow&&e!==dc.O.ShadowExludeHighlight&&e!==dc.O.ShadowHighlight||this.parameters.castShadows}},{key:"isVisible",value:function(){return(0,_u.Z)((0,bu.Z)(r.prototype),"isVisible",this).call(this)&&this.parameters.opacity>0}},{key:"intersect",value:function(e,t,r,n,i,a,o){var s=e;if(sM(s)){var l=s.path,u=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){var c=this.parameters.vvSizeOffset,h=this.parameters.vvSizeFactor,d=this.parameters.vvSizeMinSize,f=this.parameters.vvSizeMaxSize,p=l.sizeAttributeValue;u[0]*=(0,Vu.a)(c[0]+p*h[0],d[0],f[0]),u[1]*=(0,Vu.a)(c[2]+p*h[2],d[2],f[2])}var v=Math.max(u[0],u[1]),m=e.boundingInfo;if((0,Nu.t)(m))this._intersectTriangles(l,u,i,a,o);else{var y=(0,Gc.u)(m.bbMin[0]-v,m.bbMin[1]-v,m.bbMin[2]-v,m.bbMax[0]+v,m.bbMax[1]+v,m.bbMax[2]+v),g=[a[0]-i[0],a[1]-i[1],a[2]-i[2]],_=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),b=[_/g[0],_/g[1],_/g[2]];(0,dc.b8)(y,i,b,n.tolerance)&&this._intersectTriangles(l,u,i,a,o)}}}},{key:"_intersectTriangles",value:function(e,t,r,n,i){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(r,n,i)}},{key:"computeAttachmentOrigin",value:function(e,t){var r=e.vertexAttributes;if(!r)return null;var n=r.get(fc.O.POSITION);return(0,dc.aF)(n,null,!1,t)}},{key:"createBufferWriter",value:function(){return new XM(this._vertexBufferLayout)}},{key:"requiresSlot",value:function(e,t){switch(t){case dc.O.Shadow:case dc.O.ShadowHighlight:case dc.O.ShadowExludeHighlight:if(!this.parameters.castShadows)return!1;case dc.O.Color:case dc.O.Alpha:case dc.O.Depth:case dc.O.Normal:case dc.O.Highlight:case dc.O.ObjectAndLayerIdColor:return e===(this.parameters.transparent?dc.H.TRANSPARENT_MATERIAL:dc.H.OPAQUE_MATERIAL)||e===dc.H.DRAPED_MATERIAL;default:return!1}}},{key:"createGLMaterial",value:function(e){return new qM(e)}}],[{key:"getVertexBufferLayout",value:function(e){var t=(0,wc.T)().vec3f(fc.O.POSITION).vec4f(fc.O.PROFILERIGHT).vec4f(fc.O.PROFILEUP).vec4f(fc.O.PROFILEVERTEXANDNORMAL);return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&t.vec4f(fc.O.FEATUREVALUE),t}}]),r}(dc.aa),qM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"_updateShadowState",value:function(e){((0,Nu.t)(this.technique)||e.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}},{key:"beginSlot",value:function(e){return this._output!==dc.O.Color&&this._output!==dc.O.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(GM,e)}}]),r}(dc.aq),WM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).doubleSided=!1,e.doubleSidedType="normal",e.receiveSSAO=!0,e.receiveShadows=!1,e.castShadows=!0,e.hasSlicePlane=!1,e.transparent=!1,e.hasOccludees=!1,e}return(0,ku.Z)(r)}(BM),XM=function(){function e(t){(0,Au.Z)(this,e),this.vertexBufferLayout=t}return(0,ku.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(fc.O.POSITION).length}},{key:"write",value:function(e,t,r,n,i){YM(fc.O.PROFILERIGHT,r,n,i),YM(fc.O.PROFILEUP,r,n,i),YM(fc.O.PROFILEVERTEXANDNORMAL,r,n,i),this.vertexBufferLayout.hasField(fc.O.FEATUREVALUE)&&YM(fc.O.FEATUREVALUE,r,n,i),(0,dc.aM)(r,this.vertexBufferLayout,e,t,n,i)}}]),e}();function YM(e,t,r,n){if(t.vertexAttributes.has(e)){var i=t.vertexAttributes.get(e),a=t.indices.get(e);(0,Sc.e)(4===i.size);var o=r.getField(e,Zc.c);if(!o)throw new Error("unable to acquire view for "+e);(0,dc.al)(a,i.data,o,n)}}var QM=["polyline"],KM=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a))._intrinsicSize=(0,cc.r)(1,1),o._upVectorAlignment="path",o._stencilWidth=.1,o.ensureDrapedStatus(!1),o}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t,r,n,i,a,o,s,l,u,c,h,d,f,p;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Nu.r)(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,r=(0,Nu.r)(this.symbolLayer.height)?this.symbolLayer.height:t,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Rk(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},n=this.symbolLayer.anchor||"center",this._upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this._upVectorAlignment="world"),i=this.symbolLayer.profile||"circle",e.t0=i,e.next="circle"===e.t0?8:"quad"===e.t0?10:8;break;case 8:return this._profile=fM.circle(lI),e.abrupt("break",11);case 10:this._profile=fM.rect();case 11:a=[0,0],"center"!==n&&(a={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[n],this._profile.translate(a[0],a[1])),e.t1=this.symbolLayer.join||"simple",e.next="round"===e.t1?16:"bevel"===e.t1?18:"miter"===e.t1?20:22;break;case 16:return this._extruder=new mM(0,oI),e.abrupt("break",23);case 18:return this._extruder=new mM(0,1),e.abrupt("break",23);case 20:return this._extruder=new mM(.8*Math.PI,1),e.abrupt("break",23);case 22:this._extruder=new vM;case 23:o=this.symbolLayer.cap||"butt",e.t2=o,e.next="none"===e.t2?27:"butt"===e.t2?29:"square"===e.t2?31:"round"===e.t2?33:29;break;case 27:return this._startCap=new _M,this._endCap=new _M,e.abrupt("break",36);case 29:return this._startCap=new bM(this._profile,0),this._endCap=new bM(this._profile,0,!0),e.abrupt("break",36);case 31:return this._startCap=new bM(this._profile,-.5),this._endCap=new bM(this._profile,.5,!0),e.abrupt("break",36);case 33:return s="quad"===i,this._startCap=new xM({profile:this._profile,flip:!1,breakNormals:s,subdivisions:sI}),this._endCap=new xM({profile:this._profile,flip:!0,breakNormals:s,subdivisions:sI}),e.abrupt("break",36);case 36:if(l=(0,Nu.q)(this.symbolLayer,"material","color"),u=this._getCombinedOpacityAndColor(l),c=(0,Vu.a6)(u),h=u[3],d=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:d,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:d||"none"===o?vc.n.None:vc.n.Back,offsetTransparentBackfaces:!0},this._drivenProperties.size||((0,uc.r)(this._intrinsicSize,t,r),ZT(this._intrinsicSize[0])&&ZT(this._intrinsicSize[1]))){e.next=39;break}throw new Eu.s("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");case 39:this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(0,uc.l)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(p=(0,Tu.Z)((0,Tu.Z)((0,Tu.Z)({},f),this._fastUpdates.materialParameters),{},{size:(0,cc.e)(this._intrinsicSize)}),this._material=new jM(p)):(f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new dc.aS(f)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material);case 41:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,QM,this.symbolLayer.type))return null;var r=this.setGraphicElevationContext(t,new bC),n=e.renderingInfo;return this._createAs3DShape(t,n,r,t.uid)}},{key:"layerOpacityChanged",value:function(){var e=(0,Nu.q)(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:t,transparent:r})}},{key:"layerElevationInfoChanged",value:function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,GT)}},{key:"slicePlaneEnabledChanged",value:function(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}},{key:"physicalBasedRenderingChanged",value:function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"applyRendererDiff",value:function(e,t){for(var r in e.diff){if("visualVariables"!==r)return TC.Recreate_Symbol;if(!Ak(this._fastUpdates,t,this._vvConvertOptions))return TC.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return TC.Fast_Update}},{key:"getVertexData",value:function(e){var t,r=0,n=e.paths,i=[],a=e.spatialReference,o=this._context.elevationProvider.spatialReference,s=this._context.renderCoordsHelper.spatialReference,l=(0,Cu.Z)(n);try{for(l.s();!(t=l.n()).done;){r+=t.value.length}}catch(b){l.e(b)}finally{l.f()}var u,c=new Float64Array(3*r),h=new Float64Array(3*r),d=new Float64Array(3*r),f=0,p=(0,Cu.Z)(n);try{for(p.s();!(u=p.n()).done;){var v=u.value;i.push({index:f,numVertices:v.length});var m,y=(0,Cu.Z)(v);try{for(y.s();!(m=y.n()).done;){var g=m.value;c[f++]=g[0],c[f++]=g[1],c[f++]=e.hasZ?g[2]:0}}catch(b){y.e(b)}finally{y.f()}}}catch(b){p.e(b)}finally{p.f()}var _=!0;return(0,Nu.r)(o)&&!a.equals(o)?_=(0,Hu.x)(c,a,0,h,o,0,r):this._copyVertices(c,0,h,0,r),(0,Nu.r)(o)&&!o.equals(s)?(0,Hu.x)(h,o,0,d,s,0,r):this._copyVertices(h,0,d,0,r),{pathVertexDataInfos:i,vertexDataGS:c,vertexDataES:h,vertexDataRS:d,projectionSuccess:_,terrainElevation:0}}},{key:"_copyVertices",value:function(e,t,r,n,i){t*=3,n*=3;for(var a=0;a<i;++a)r[n++]=e[t++],r[n++]=e[t++],r[n++]=e[t++]}},{key:"_createAs3DShape",value:function(e,t,r,n){var i=e.geometry,a=new Array,o=new Array,s=new Array,l=i.spatialReference,u=(0,Gc.a)(),c=this._context.renderCoordsHelper,h=this.getVertexData(i);if(!h.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(h.pathVertexDataInfos.length>0){for(var d=0;d<h.pathVertexDataInfos.length;++d){var f=h.pathVertexDataInfos[d],p=f.index,v=f.numVertices;if(!(v<2)&&(!(0,Nu.r)(this._context.clippingExtent)||((0,Gc.A)(u),(0,Gc.M)(u,h.vertexDataES,3*p,v),(0,Gc.R)(u,this._context.clippingExtent)))){for(var m=[],y=p;y<p+3*v;){var g=y++,_=y++,b=y++,x=new dM;(0,Vu.o)(x.posGS,h.vertexDataGS[g],h.vertexDataGS[_],h.vertexDataGS[b]),(0,Vu.o)(x.posES,h.vertexDataES[g],h.vertexDataES[_],h.vertexDataES[b]);var w=UT(x.posES,this._context.elevationProvider,r,c);(0,Vu.o)(rI,h.vertexDataRS[g],h.vertexDataRS[_],h.vertexDataRS[b]),c.setAltitude(rI,w),(0,Vu.o)(x.pos,rI[0],rI[1],rI[2]),m.push(x)}var T=new pM(m);JM(T,this._upVectorAlignment,this._context.renderCoordsHelper);var C=new wM(T,this._profile,this._extruder,this._startCap,this._endCap),S=null;if(this._fastUpdates.enabled){var O=this._fastUpdates.visualVariables,P=O.size?XC(O.size.field,e):0,R=O.color?XC(O.color.field,e):0,A=O.opacity?XC(O.opacity.field,e):0;S=new SM(C,P,R,A)}else{var k=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(k[0]*=$M(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),k[1]*=$M(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));var E=null;this._drivenProperties.color&&(E=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(E=E?[E[0],E[1],E[2],t.opacity]:[1,1,1,t.opacity]);var D=new CM(C);D.bake(k),E&&D.bakeVertexColors(E),S=D}var M=S.createGeometryData(),I=M.vertexAttributes,L=M.indices,Z=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),N=new oM(I,L,S,l,this._upVectorAlignment,this._stencilWidth,Z);a.push(N),o.push(this._material),s.push(S.xform)}}if(a.length>0){var F={layerUid:this._context.layer.uid,graphicUid:n},z=new tS({geometries:a,materials:o,transformations:s,metadata:F}),U=new xC(this,z,a,null,null,tI,r);return U.alignedSampledElevation=h.terrainElevation,U.needsElevationUpdates=GT(r.mode),U}}else 0!==i.paths.length&&i.paths.some((function(e){return e.length>0}))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}]),r}(WC);function JM(e,t,r){switch(t){case"world":var n,i=(0,Cu.Z)(e.vertices);try{for(i.s();!(n=i.n()).done;){var a=n.value;(0,Vu.u)(nI,a.pos,e.offset),r.worldUpAtPosition(nI,rI),a.setFrameFromUpVector(rI),a.computeRotationAxisAndAngleFromUpVector()}}catch(p){i.e(p)}finally{i.f()}break;case"path":(0,Vu.u)(nI,e.vertices[0].pos,e.offset),r.worldUpAtPosition(nI,rI),function(e,t){var r=null,n=e.vertices.length,i=.99619469809,a=(0,Vu.n)(),o=(0,Vu.n)(),s=(0,Vu.n)(),l=(0,Vu.n)(),u=(0,Vu.n)(),c=(0,Vu.n)(),h=(0,Tc.p)(),d=e.vertices[0];(0,Vu.r)(o,t),(0,Vu.o)(a,0,1,0),bp(d.vRight,o,a,a,s,o,i),(0,Vu.r)(d.frame.up,o),(0,Vu.r)(d.frame.right,s),r=d;for(var f=1;f<n;++f){d=e.vertices[f],(0,Vu.u)(u,d.vLeft,d.vRight);var p=(0,Vu.s)(u);p>0?(p=1/Math.sqrt(p),u[0]=u[0]*p,u[1]=u[1]*p,u[2]=u[2]*p):(u[0]=d.vRight[0],u[1]=d.vRight[1],u[2]=d.vRight[2]),(0,Vu.u)(c,r.pos,r.frame.up),(0,Tc._)(d.pos,u,h),(0,Tc.q)(h,(0,Qu.p)(c,d.vLeft),l)?((0,Vu.e)(l,l,d.pos),(0,Vu.z)(o,l),(0,Vu._)(s,u,o),(0,Vu.z)(s,s)):bp(u,r.frame.up,r.frame.right,a,s,o,i),(0,Vu.r)(d.frame.up,o),(0,Vu.r)(d.frame.right,s),r=d}}(e,rI);var o,s=(0,Cu.Z)(e.vertices);try{for(s.s();!(o=s.n()).done;){var l=o.value,u=Math.sign((0,Vu.P)(l.frame.right,l.vRight));(0,Vu._)(l.rotationFrame.up,l.vRight,l.vLeft),(0,Vu.g)(l.rotationFrame.up,l.rotationFrame.up,u),(0,Vu.z)(l.rotationFrame.up,l.rotationFrame.up);var c=(0,Vu.P)(l.rotationFrame.up,l.frame.up),h=(0,Vu.P)(l.rotationFrame.up,l.frame.right);if((0,Vu.g)(nI,l.frame.up,-h),(0,Vu.g)(iI,l.frame.right,c),(0,Vu.u)(nI,nI,iI),(0,Vu.z)(l.rotationFrame.right,nI),hM(l.rotationRight,l.frame,l.rotationFrame.right),(0,Vu.q)(nI,l.vLeft),l.rotationAngle=-u*(Math.PI-(0,Vu.i)((0,Vu.P)(nI,l.vRight))),Math.abs(l.rotationAngle)>0){var d=(0,Vu.aa)(Math.cos(.5*l.rotationAngle));tM(l.miterStretch,1+(d-1)*l.rotationRight[0]*l.rotationRight[0],(d-1)*l.rotationRight[0]*l.rotationRight[1],(d-1)*l.rotationRight[0]*l.rotationRight[1],1+(d-1)*l.rotationRight[1]*l.rotationRight[1])}var f=Math.PI-l.rotationAngle;l.maxStretchDistance=Math.abs(Math.min(l.vLeftLength,l.vRightLength)*(0,Vu.aa)(Math.cos(.5*f)))}}catch(p){s.e(p)}finally{s.f()}}}function $M(e,t,r){switch(e){case"symbol-value":return r;case"proportional":return t;default:return e}}function eI(e,t,r,n){var i,a=0,o=(0,Cu.Z)(e.vertices);try{for(o.s();!(i=o.n()).done;){var s=i.value;zT(s.posES,r,t,n,aI),a+=aI.sampledElevation,(0,Vu.u)(rI,s.pos,e.offset),n.setAltitude(rI,aI.z),(0,Vu.e)(s.pos,rI,e.offset)}}catch(l){o.e(l)}finally{o.f()}return e.updatePathVertexInformation(),a/e.vertices.length}function tI(e,t,r,n){var i,a=e.stageObject,o=a.geometryRecords,s=0,l=(0,Cu.Z)(o);try{for(l.s();!(i=l.n()).done;){var u=i.value,c=u.geometry;if(sM(c)){var h=c.path,d=h.builder.path;s+=eI(d,t,r,n),"world"!==c.upVectorAlignment&&JM(d,c.upVectorAlignment,n),h.onPathChanged(),c.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(u)}}}catch(f){l.e(f)}finally{l.f()}return s/o.length}var rI=(0,Vu.n)(),nI=(0,yc.n)(),iI=(0,yc.n)(),aI=new qT,oI=3,sI=3,lI=10;function uI(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(0,Vu.o)(fI,1,0,0),(0,Vu.o)(pI,0,1,0),(0,Vu.o)(vI,0,0,1),RI(cI,t),wI(t,dI)&&TI(dI,fI,pI,vI,r,cI),(0,uc.r)(mI,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,uc.r)(yI,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(var a=0;a<t.count;a++){t.getVec(a,hI);var o=(0,Vu.P)(fI,hI),s=(0,Vu.P)(pI,hI);mI[0]=Math.min(mI[0],o),mI[1]=Math.min(mI[1],s),yI[0]=Math.max(yI[0],o),yI[1]=Math.max(yI[1],s)}var l=(0,Vu.P)(vI,cI);kI(_I,mI[0],mI[1],l,fI,pI,vI),kI(bI,yI[0],mI[1],l,fI,pI,vI),kI(xI,mI[0],yI[1],l,fI,pI,vI),(0,Vu.e)(bI,bI,_I),(0,Vu.g)(bI,bI,.5),(0,Vu.e)(xI,xI,_I),(0,Vu.g)(xI,xI,.5),(0,Vu.u)(_I,_I,bI),(0,Vu.u)(_I,_I,xI);var u=mI[0]%i,c=mI[1]%i;gI[0]=mI[0]-u,gI[1]=mI[1]-c;for(var h=0;h<t.count;h++){t.getVec(h,hI),e.setValues(h,((0,Vu.P)(fI,hI)-gI[0])/i,((0,Vu.P)(pI,hI)-gI[1])/i,gI[0]/i,gI[1]/i);for(var d=0;d<3;d++)n.set(h,d,_I[d]),n.set(h,d+3,bI[d]),n.set(h,d+6,xI[d])}}var cI=(0,Vu.n)(),hI=(0,Vu.n)(),dI=(0,Tc.p)(),fI=(0,Vu.n)(),pI=(0,Vu.n)(),vI=(0,Vu.n)(),mI=(0,cc.n)(),yI=(0,cc.n)(),gI=(0,cc.n)(),_I=(0,Vu.n)(),bI=(0,Vu.n)(),xI=(0,Vu.n)();function wI(e,t){var r=e.count-1;return(0,Tc.b)(e,t,0,Math.floor(r/3),Math.floor(r*(2/3)))}function TI(e,t,r,n,i,a){(0,Nu.r)(i)?(i.basisMatrixAtPosition(a,CI),(0,Vu.o)(SI,CI[0],CI[1],CI[2]),(0,Vu.o)(OI,CI[4],CI[5],CI[6]),(0,Vu.o)(PI,CI[8],CI[9],CI[10])):((0,Vu.o)(SI,1,0,0),(0,Vu.o)(OI,0,1,0),(0,Vu.o)(PI,0,0,1));var o=(0,Tc.Y)(e);(0,Vu.P)(o,PI)<0&&(0,Vu.g)(o,o,-1),(0,Vu.r)(n,o);var s=(0,Vu.P)(o,OI),l=(0,Vu.P)(o,SI);Math.abs(s)<Math.abs(l)?((0,Vu.ab)(t,SI,o,-l),(0,Vu.z)(t,t),(0,Vu._)(r,t,o),(0,Vu.z)(r,r),(0,Vu.g)(r,r,-1)):((0,Vu.ab)(r,OI,o,-s),(0,Vu.z)(r,r),(0,Vu._)(t,r,o),(0,Vu.z)(t,t))}var CI=(0,hc.e)(),SI=(0,Vu.n)(),OI=(0,Vu.n)(),PI=(0,Vu.n)();function RI(e,t){(0,Vu.o)(AI,0,0,0);for(var r=0;r<t.count-1;r++)t.getVec(r,hI),(0,Vu.u)(AI,AI,hI);(0,Vu.g)(e,AI,1/(t.count-1))}var AI=(0,Vu.n)();function kI(e,t,r,n,i,a,o){(0,Vu.o)(e,t*i[0]+r*a[0]+n*o[0],t*i[1]+r*a[1]+n*o[1],t*i[2]+r*a[2]+n*o[2])}function EI(e){var t=new dc.o,r=t.vertex,n=t.fragment,i=e.output===dc.O.Depth,a=e.hasMultipassTerrain&&(e.output===dc.O.Color||e.output===dc.O.Alpha);return(0,dc.T)(r,e),t.include(dc.K,e),t.include(dc.aU,e),t.include(dc.a2,e),t.attributes.add(fc.O.POSITION,"vec3"),t.varyings.add("vpos","vec3"),a&&t.varyings.add("depth","float"),i&&(t.include(dc.at,e),(0,dc.b1)(t),(0,dc.au)(t)),r.code.add((0,dc.n)(jn||(jn=(0,wu.Z)(["\n    void main(void) {\n      vpos = position;\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n      ","\n      gl_Position = ","\n    }\n  "])),a?"depth = (view * vec4(vpos, 1.0)).z;":"",i?(0,dc.n)(qn||(qn=(0,wu.Z)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,dc.n)(Wn||(Wn=(0,wu.Z)(["transformPosition(proj, view, vpos);"]))))),t.include(dc.a0,e),a&&t.include(dc.aw,e),n.include(dc.x),n.uniforms.add(new dc.f("eColor",(function(e){return e.color}))),e.output===dc.O.Highlight&&t.include(dc.a9,e),n.code.add((0,dc.n)(Xn||(Xn=(0,wu.Z)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n    vec4 fColor = ","\n\n    if (fColor.a < ",") {\n      discard;\n    }\n\n    ","\n\n    ","\n    ",";\n    ",";\n    ","\n  }\n  "])),a?"terrainDepthTest(gl_FragCoord, depth);":"",e.hasVertexColors?"vColor * eColor;":"eColor;",dc.n.float(dc.a7),e.output===dc.O.Alpha?(0,dc.n)(Yn||(Yn=(0,wu.Z)(["gl_FragColor = vec4(fColor.a);"]))):"",e.output===dc.O.Color?(0,dc.n)(Qn||(Qn=(0,wu.Z)(["gl_FragColor = highlightSlice(fColor, vpos); ",""])),e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""):"",e.output===dc.O.Highlight?(0,dc.n)(Kn||(Kn=(0,wu.Z)(["outputHighlight();"]))):"",e.output===dc.O.Depth?(0,dc.n)(Jn||(Jn=(0,wu.Z)(["outputDepth(linearDepth);"]))):"",e.output===dc.O.ObjectAndLayerIdColor?(0,dc.n)($n||($n=(0,wu.Z)(["outputObjectAndLayerIdColor();"]))):"")),t}var DI=Object.freeze(Object.defineProperty({__proto__:null,build:EI},Symbol.toStringTag,{value:"Module"})),MI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"_createPipeline",value:function(e,t){var r=this.configuration,n=e===vc.o.NONE,i=e===vc.o.FrontFace;return(0,vc.W)({blending:r.output!==dc.O.Color&&r.output!==dc.O.Alpha||!r.transparent?null:n?vc.d:(0,vc.A)(e),culling:(0,vc.k)(r.cullFace),depthTest:{func:(0,vc.e)(e)},depthWrite:n||i?r.writeDepth&&vc.b:null,colorWrite:vc._,stencilWrite:r.hasOccludees?dc.ax:null,stencilTest:r.hasOccludees?t?dc.ay:dc.az:null,polygonOffset:n||i?r.polygonOffset&&II:(0,vc.g)(r.enableOffset)})}},{key:"initializePipeline",value:function(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);MI.shader=new dc.m(DI,(function(){return r.e(9314).then(r.bind(r,79314))}));var II={factor:1,units:1},LI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.cullFace=vc.n.None,e.hasSlicePlane=!1,e.hasVertexColors=!1,e.transparent=!1,e.polygonOffset=!1,e.enableOffset=!0,e.writeDepth=!0,e.hasOccludees=!1,e.transparencyPassType=vc.o.NONE,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.objectAndLayerIdColorInstanced=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],LI.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:vc.n.COUNT})],LI.prototype,"cullFace",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"hasVertexColors",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"transparent",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"polygonOffset",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"enableOffset",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"writeDepth",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],LI.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],LI.prototype,"objectAndLayerIdColorInstanced",void 0);var ZI,NI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new zI)).supportsEdges=!0,n._configuration=new LI,n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<vc.S,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"intersect",value:function(e,t,r,n,i,a,o){(0,dc.aN)(e,t,n,i,a,void 0,o)}},{key:"requiresSlot",value:function(e,t){return!!(t===dc.O.Color||t===dc.O.Alpha||t===dc.O.Highlight||t===dc.O.Depth&&this.parameters.writeLinearDepth||t===dc.O.ObjectAndLayerIdColor)&&(e===dc.H.DRAPED_MATERIAL||(t===dc.O.Highlight?e===dc.H.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?dc.H.TRANSPARENT_MATERIAL:dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:dc.H.OPAQUE_MATERIAL)))}},{key:"createGLMaterial",value:function(e){return new FI(e)}},{key:"createBufferWriter",value:function(){return new kR((0,Nu.h)("enable-feature:objectAndLayerId-rendering")?AR:RR)}}]),r}(dc.aa),FI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==dc.O.Color&&this._output!==dc.O.Alpha||this._updateOccludeeState(e),this.ensureTechnique(MI,e)}}]),r}(dc.aq),zI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).color=lc.l,e.transparent=!1,e.writeDepth=!0,e.writeLinearDepth=!1,e.hasVertexColors=!1,e.polygonOffset=!1,e.hasSlicePlane=!1,e.cullFace=vc.n.None,e.hasOccludees=!1,e}return(0,ku.Z)(r)}(dc.ar);!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"}(ZI||(ZI={}));var UI=.70710678118,VI=UI;function BI(e){var t=new dc.o,r=e.hasMultipassTerrain&&(e.output===dc.O.Color||e.output===dc.O.Alpha);e.draped||t.extensions.add("GL_OES_standard_derivatives");var n=t.vertex,i=t.fragment;(0,dc.T)(n,e),t.include(dc.K,e),t.include(dc.aU,e),e.draped?n.uniforms.add(new dc.g("worldToScreenRatio",(function(e,t){return 1/t.screenToPCSRatio}))):t.attributes.add(fc.O.BOUNDINGRECT,"mat3"),t.attributes.add(fc.O.POSITION,"vec3"),t.attributes.add(fc.O.UVMAPSPACE,"vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),r&&t.varyings.add("depth","float");var a=e.style===ZI.ForwardDiagonal||e.style===ZI.BackwardDiagonal||e.style===ZI.DiagonalCross;a&&n.code.add((0,dc.n)(ei||(ei=(0,wu.Z)(["\n      const mat2 rotate45 = mat2(",", ",",\n                                 ",", ",");\n    "])),dc.n.float(UI),dc.n.float(-VI),dc.n.float(VI),dc.n.float(UI))),e.draped||((0,dc.U)(n,e),n.uniforms.add(new dc.g("worldToScreenPerDistanceRatio",(function(e,t){return 1/t.camera.perScreenPixelRatio}))),n.code.add((0,dc.n)(ti||(ti=(0,wu.Z)(["vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {\nfloat projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);\nreturn center + halfVector * clamp(projectedLength, -1.0, 1.0);\n}"])))),n.code.add((0,dc.n)(ri||(ri=(0,wu.Z)(["vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {\nfloat d = dot(planeNormal, planePoint);\nfloat t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);\nreturn rayOrigin + t * rayDir;\n}"])))),n.code.add((0,dc.n)(ni||(ni=(0,wu.Z)(["\n      float boundingRectDistanceToCamera() {\n        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);\n        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);\n        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);\n        vec3 n = normalize(cross(halfU, halfV));\n\n        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);\n\n        float viewAngle = dot(viewDir, n);\n        float minViewAngle = ",";\n\n        if (abs(viewAngle) < minViewAngle) {\n          // view direction is (almost) parallel to plane -> clamp it to min angle\n          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;\n          viewDir = normalize(viewDir + normalComponent * n);\n        }\n\n        // intersect view direction with infinite plane that contains bounding rect\n        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);\n\n        // clip to bounds by projecting to u and v line segments individually\n        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);\n        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);\n\n        // use to calculate the closest point to camera on bounding rect\n        vec3 closestPoint = uProjected + vProjected - center;\n\n        return length(closestPoint - cameraPosition);\n      }\n    "])),dc.n.float(.08715574274)))),n.code.add((0,dc.n)(ii||(ii=(0,wu.Z)(["\n    vec2 scaledUV() {\n      vec2 uv = uvMapSpace.xy ",";\n      vec2 uvCellOrigin = uvMapSpace.zw ",";\n\n      ","\n\n      // Logarithmically discretize ratio to avoid jittering\n      float step = 0.1;\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n\n      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ",");\n      return uvOffset + (uv * discreteWorldToScreenRatio);\n    }\n  "])),a?" * rotate45":"",a?" * rotate45":"",e.draped?"":(0,dc.n)(ai||(ai=(0,wu.Z)(["\n            float distanceToCamera = boundingRectDistanceToCamera();\n            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;\n          "]))),dc.n.float(e.patternSpacing)));var o=e.output===dc.O.Depth;return o&&(t.include(dc.at,e),(0,dc.b1)(t),(0,dc.au)(t)),n.code.add((0,dc.n)(oi||(oi=(0,wu.Z)(["\n    void main(void) {\n      vuv = scaledUV();\n      vpos = position;\n      ","\n      forwardNormalizedVertexColor();\n      gl_Position = ","\n    }\n  "])),r?"depth = (view * vec4(vpos, 1.0)).z;":"",o?(0,dc.n)(si||(si=(0,wu.Z)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,dc.n)(li||(li=(0,wu.Z)(["transformPosition(proj, view, vpos);"]))))),t.include(dc.a0,e),i.include(dc.x),e.draped&&i.uniforms.add(new dc.g("texelSize",(function(e,t){return 1/t.camera.pixelRatio}))),e.output===dc.O.Highlight&&t.include(dc.a9,e),r&&t.include(dc.aw,e),e.output!==dc.O.Highlight&&(i.code.add((0,dc.n)(ui||(ui=(0,wu.Z)(["\n      const float lineWidth = ",";\n      const float spacing = ",";\n      const float spacingINV = ",";\n\n      float coverage(float p, float txlSize) {\n        p = mod(p, spacing);\n\n        float halfTxlSize = txlSize / 2.0;\n\n        float start = p - halfTxlSize;\n        float end = p + halfTxlSize;\n\n        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;\n        coverage -= min(lineWidth, mod(start, spacing));\n        coverage -= max(lineWidth - mod(end, spacing), 0.0);\n\n        return coverage / txlSize;\n      }\n    "])),dc.n.float(e.lineWidth),dc.n.float(e.patternSpacing),dc.n.float(1/e.patternSpacing))),e.draped||i.code.add((0,dc.n)(ci||(ci=(0,wu.Z)(["const int maxSamples = 5;\nfloat sample(float p) {\nvec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));\nfloat fwidth = dxdy.x + dxdy.y;\nivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));\nvec2 invSamples = 1.0 / vec2(samples);\nfloat accumulator = 0.0;\nfor (int j = 0; j < maxSamples; j++) {\nif(j >= samples.y) {\nbreak;\n}\nfor (int i = 0; i < maxSamples; i++) {\nif(i >= samples.x) {\nbreak;\n}\nvec2 step = vec2(i,j) * invSamples - 0.5;\naccumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);\n}\n}\naccumulator /= float(samples.x * samples.y);\nreturn accumulator;\n}"]))))),i.uniforms.add(new dc.f("uColor",(function(e){return e.color}))),i.code.add((0,dc.n)(hi||(hi=(0,wu.Z)(["\n    void main() {\n      discardBySlice(vpos);\n      ","\n      vec4 color = ","\n      color = highlightSlice(color, vpos);\n\n      ","\n\n      if (color.a < ",") {\n        discard;\n      }\n\n      ","\n\n      ","\n      ","\n      ",";\n    }\n  "])),r?"terrainDepthTest(gl_FragCoord, depth);":"",e.hasVertexColors?"vColor * uColor;":"uColor;",e.output!==dc.O.Highlight?(0,dc.n)(di||(di=(0,wu.Z)(["color.a *= ",";"])),function(e){function t(t){return e.draped?(0,dc.n)(yi||(yi=(0,wu.Z)(["coverage(vuv.",", texelSize)"])),t):(0,dc.n)(gi||(gi=(0,wu.Z)(["sample(vuv.",")"])),t)}switch(e.style){case ZI.ForwardDiagonal:case ZI.Horizontal:return t("y");case ZI.BackwardDiagonal:case ZI.Vertical:return t("x");case ZI.DiagonalCross:case ZI.Cross:return(0,dc.n)(_i||(_i=(0,wu.Z)(["\n        1.0 - (1.0 - ",") * (1.0 - ",")\n      "])),t("x"),t("y"));default:return"0.0"}}(e)):"",dc.n.float(dc.a7),e.output===dc.O.Alpha?(0,dc.n)(fi||(fi=(0,wu.Z)(["gl_FragColor = vec4(color.a);"]))):"",e.output===dc.O.Color?(0,dc.n)(pi||(pi=(0,wu.Z)(["gl_FragColor = color; ",""])),e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""):"",e.output===dc.O.Highlight?(0,dc.n)(vi||(vi=(0,wu.Z)(["outputHighlight();"]))):"",e.output===dc.O.Depth?(0,dc.n)(mi||(mi=(0,wu.Z)(["outputDepth(linearDepth);"]))):"")),t}var GI=Object.freeze(Object.defineProperty({__proto__:null,build:BI},Symbol.toStringTag,{value:"Module"})),HI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),WI)}},{key:"_setPipelineState",value:function(e,t){var r=this.configuration,n=e===vc.o.NONE,i=e===vc.o.FrontFace;return(0,vc.W)({blending:r.output===dc.O.Color||r.output===dc.O.Alpha?n?vc.d:(0,vc.A)(e):null,culling:(0,vc.k)(r.cullFace),depthTest:{func:(0,vc.e)(e)},depthWrite:n?r.writeDepth&&vc.b:(0,vc.E)(e),colorWrite:vc._,stencilWrite:r.hasOccludees?dc.ax:null,stencilTest:r.hasOccludees?t?dc.ay:dc.az:null,polygonOffset:n||i?r.polygonOffset&&jI:(0,vc.g)(r.enableOffset)})}},{key:"initializePipeline",value:function(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);HI.shader=new dc.m(GI,(function(){return r.e(8669).then(r.bind(r,78669))}));var jI={factor:1,units:1},qI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.cullFace=vc.n.None,e.transparencyPassType=vc.o.NONE,e.hasSlicePlane=!1,e.hasVertexColors=!1,e.polygonOffset=!1,e.writeDepth=!0,e.hasOccludees=!1,e.enableOffset=!0,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],qI.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:vc.n.COUNT})],qI.prototype,"cullFace",void 0),(0,Eu.e)([(0,dc.p)({count:ZI.COUNT})],qI.prototype,"style",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],qI.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"hasVertexColors",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"polygonOffset",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"writeDepth",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"patternSpacing",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"lineWidth",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"enableOffset",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"draped",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],qI.prototype,"cullAboveGround",void 0);var WI=new Map([[fc.O.POSITION,0],[fc.O.COLOR,3],[fc.O.UVMAPSPACE,4],[fc.O.BOUNDINGRECT,5]]),XI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e,new KI)).supportsEdges=!0,n._vertexAttributeLocations=WI,n._configuration=new qI,n}return(0,ku.Z)(r,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<vc.S,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"intersect",value:function(e,t,r,n,i,a,o){(0,dc.aN)(e,t,n,i,a,void 0,o)}},{key:"requiresSlot",value:function(e,t){return!!(t===dc.O.Color||t===dc.O.Alpha||t===dc.O.Highlight||t===dc.O.Depth&&this.parameters.writeLinearDepth)&&(e===dc.H.DRAPED_MATERIAL||(t===dc.O.Highlight?e===dc.H.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?dc.H.TRANSPARENT_MATERIAL:dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)))}},{key:"createGLMaterial",value:function(e){return new YI(e)}},{key:"createBufferWriter",value:function(){var e=(0,wc.T)().vec3f(fc.O.POSITION).vec4u8(fc.O.COLOR).vec4f(fc.O.UVMAPSPACE);return this.parameters.draped||e.mat3f(fc.O.BOUNDINGRECT),new QI(e)}}]),r}(dc.aa),YI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_updateParameters",value:function(e){return this.ensureTechnique(HI,e)}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==dc.O.Color&&this._output!==dc.O.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}]),r}(dc.aq),QI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"write",value:function(e,t,r,n,i){var a,o=(0,Cu.Z)(this.vertexBufferLayout.fieldNames);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=r.vertexAttributes.get(s),u=r.indices.get(s);if(l&&u)switch(s){case fc.O.POSITION:(0,Sc.e)(3===l.size);var c=n.getField(s,Zc.i);c&&(0,dc.ai)(u,l.data,e,c,i);break;case fc.O.COLOR:(0,Sc.e)(3===l.size||4===l.size);var h=n.getField(s,Zc.x);h&&(0,dc.ak)(u,l.data,l.size,h,i);break;case fc.O.UVMAPSPACE:(0,Sc.e)(4===l.size);var d=n.getField(s,Zc.c);d&&(0,dc.al)(u,l.data,d,i);break;case fc.O.BOUNDINGRECT:(0,Sc.e)(9===l.size);var f=n.getField(s,Zc.l);f&&this.writeBoundingRect(u,l.data,e,f,i)}}}catch(p){o.e(p)}finally{o.f()}}},{key:"writeBoundingRect",value:function(e,t,r,n,i){var a=r,o=n.typedBuffer,s=n.typedBufferStride,l=e.length;i*=s;for(var u=0;u<l;++u){var c=9*e[u],h=t[c],d=t[c+1],f=t[c+2];o[i]=a[0]*h+a[4]*d+a[8]*f+a[12],o[i+1]=a[1]*h+a[5]*d+a[9]*f+a[13],o[i+2]=a[2]*h+a[6]*d+a[10]*f+a[14];for(var p=3;p<9;++p)o[i+p]=t[c+p];i+=s}}}]),r}(kR),KI=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).color=(0,lc.r)(1,1,1,1),e.writeDepth=!0,e.writeLinearDepth=!1,e.hasVertexColors=!1,e.polygonOffset=!1,e.hasSlicePlane=!1,e.cullFace=vc.n.None,e.hasOccludees=!1,e.style=ZI.Cross,e.patternSpacing=10,e.lineWidth=1,e.draped=!0,e}return(0,ku.Z)(r)}(dc.ar);function JI(e,t,r){return function(e,t,r){return(0,Nu.r)(e)?"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=(0,lc.r)(0,0,0,0),t.transparent=!0),new NI(t)):(t.style=function(e){switch(e){case"horizontal":return ZI.Horizontal;case"vertical":return ZI.Vertical;case"cross":return ZI.Cross;case"forward-diagonal":return ZI.ForwardDiagonal;case"backward-diagonal":return ZI.BackwardDiagonal;case"diagonal-cross":return ZI.DiagonalCross;default:return}}(e.style),t.draped=r.isDraped,new XI(t)):new NI(t)}(function(e){return e&&e.pattern||null}(e),t,r)}function $I(e,t){if(function(e){return e.material instanceof XI&&!e.material.parameters.draped}(e)){var r=e.geometry.vertexAttributes,n=r.get(fc.O.POSITION).data,i=r.get(fc.O.UVMAPSPACE).data,a=r.get(fc.O.BOUNDINGRECT).data;uI(Zc.c.fromTypedArray(i),Zc.T.fromTypedArray(n),t,Zc.a.fromTypedArray(a))}}function eL(e,t,r,n){for(var i=KT(e,t,r,n),a=e.stageObject.geometryRecords,o=0;o<a.length;o++)$I(a[o],n);return i}var tL=["polyline","polygon","extent"],rL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a))._needsUV=!1,o._hasOutline=!1,o}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"_ensureMaterials",value:function(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}},{key:"_ensureFillMaterial",value:function(){if(!(0,Nu.r)(this._material)){var e=(0,Nu.q)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=JI(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof XI,this._context.stage.add(this._material)}}},{key:"_ensureOutlineMaterial",value:function(){var e=this,t=this.symbolLayer.outline;if(!(0,Nu.r)(this._outlineMaterial)&&this._isValidOutline(t)){this._hasOutline=!0;this._outlineMaterial=function(r){var n=wE(t.pattern);return new jO({width:r,color:e._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:e._context.slicePlaneEnabled,isClosed:!0,stipplePattern:n,stippleScaleWithLineWidth:!0,cap:Wk(t.patternCap||"butt")})}((0,zu.u)(t.size)),this._context.stage.add(this._outlineMaterial)}}},{key:"_isValidOutline",value:function(e){return(0,Nu.r)(e)&&e.size&&e.size>0&&(0,Nu.r)(e.color)&&((0,Nu.t)(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)}},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,tL,this.symbolLayer.type))return null;var r=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(t,new bC);return this.ensureDrapedStatus("on-the-ground"===n.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(t,r):this._createAs3DShape(t,r,n)}},{key:"layerOpacityChanged",value:function(){if((0,Nu.r)(this._material)){var e=this._material.parameters.color,t=(0,Nu.q)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if((0,Nu.r)(this._outlineMaterial)){var n=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[n[0],n[1],n[2],this._getOutlineOpacity()]})}}},{key:"layerElevationInfoChanged",value:function(e,t,n){var i=this._elevationContext.mode,a=VT(r.elevationModeChangeTypes,n,i);if(a!==jT.UPDATE)return a;var o=BT(i);return this.updateGraphics3DGraphicElevationInfo(e,t,(function(){return o}))}},{key:"slicePlaneEnabledChanged",value:function(){if((0,Nu.r)(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(0,Nu.r)(this._outlineMaterial)){var e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"_createAs3DShape",value:function(e,t,r){var n,i=US(e.geometry);if((0,Nu.t)(i))return null;var a=gA(i,this._context.elevationProvider,this._context.renderCoordsHelper,r),o=new iL(a,t,this._context.layer.uid,e.uid),s=o.renderData.position.length/3;if(this._needsUV&&(o.uvMapSpace=new Float32Array(4*s),o.boundingRect=new Float64Array(9*s)),o.objectAndLayerIdColor=null===(n=this._context.stage.renderView)||void 0===n?void 0:n._getObjectAndLayerIdColor({graphicUid:o.graphicsUid,layerUid:o.layerUid}),this._createAs3DShapeFill(o),this._hasOutline&&this._createAs3DShapeOutline(o),this._logGeometryCreationWarnings(o.renderData,i.rings,"rings","FillSymbol3DLayer"),0===o.outGeometries.length)return null;this._needsUV&&uI(Zc.c.fromTypedArray(o.uvMapSpace),Zc.T.fromTypedArray(o.renderData.position),this._context.renderCoordsHelper,Zc.a.fromTypedArray(o.boundingRect));var l=new tS({geometries:o.outGeometries,materials:o.outMaterials,transformations:o.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),u=new xC(this,l,o.outGeometries,null,null,eL,r);return u.alignedSampledElevation=o.renderData.sampledElevation,u.needsElevationUpdates=BT(r.mode),u}},{key:"_createAs3DShapeFill",value:function(e){var t,r=e.renderData.polygons,n=(0,Cu.Z)(r);try{for(n.s();!(t=n.n()).done;){var i=t.value,a=i.position,o=i.mapPosition,s=i.holeIndices,l=i.index,u=i.count;if(!(0,Nu.r)(this._context.clippingExtent)||((0,Gc.A)(nL),(0,Gc.M)(nL,o),(0,Gc.R)(nL,this._context.clippingExtent))){var c=(0,Qc.x)(o,s,3);if(0!==c.length){var h=FS({indices:c,attributeData:{position:a,color:e.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*l*e.uvMapSpace.BYTES_PER_ELEMENT,4*u):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*l*e.boundingRect.BYTES_PER_ELEMENT,9*u):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(h),e.outMaterials.push((0,Nu.e)(this._material)),e.outTransforms.push(hc.o)}}}}catch(d){n.e(d)}finally{n.f()}}},{key:"_createAs3DShapeOutline",value:function(e){if(this._hasOutline)for(var t=e.renderData.outlines,r=0;r<t.length;++r){var n=t[r],i=n.mapPosition,a=n.position;if(!(0,Nu.r)(this._context.clippingExtent)||((0,Gc.A)(nL),(0,Gc.M)(nL,i),(0,Gc.R)(nL,this._context.clippingExtent))){var o=Yk({overlayInfo:null,removeDuplicateStartEnd:!0,attributeData:{position:a,mapPosition:i}},e.objectAndLayerIdColor),s=o.vertexAttributes.get(fc.O.POSITION);s.data===a&&(s.data=new Float64Array(a)),e.outGeometries.push(o),e.outMaterials.push((0,Nu.e)(this._outlineMaterial)),e.outTransforms.push(hc.o)}}}},{key:"_createAsOverlay",value:function(e,t){var r,n=US(e.geometry);if((0,Nu.t)(n))return null;(0,Nu.e)(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,(0,Nu.r)(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);var i=_A(n,this._context.overlaySR),a=new aL(i,t,this._context.layer.uid,e.uid),o=a.renderData.position.length/3;return this._needsUV&&(a.uvMapSpace=new Float32Array(4*o)),a.outBoundingBox=(0,Gc.A)(),a.objectAndLayerIdColor=null===(r=this._context.stage.renderView)||void 0===r?void 0:r._getObjectAndLayerIdColor({graphicUid:a.graphicsUid,layerUid:a.layerUid}),this._createAsOverlayFill(a),this._hasOutline&&this._createAsOverlayOutline(a),this._logGeometryCreationWarnings(a.renderData,n.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length?null:(this._needsUV&&function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(r.isGeographic&&n===ic.l.Global){for(var a=new Float64Array(t.typedBuffer.length),o=3*t.count,s=(0,Xu.u)(r),l=0;l<o;l+=3)(0,Hu.a)(t.typedBuffer,l,a,l,s);t=Zc.T.fromTypedArray(a)}(0,uc.r)(mI,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(var u=0;u<t.count;u++)t.getVec(u,hI),mI[0]=Math.min(mI[0],hI[0]),mI[1]=Math.min(mI[1],hI[1]);var c=mI[0]%i,h=mI[1]%i;gI[0]=mI[0]-c,gI[1]=mI[1]-h;for(var d=0;d<t.count;d++)t.getVec(d,hI),e.setValues(d,(hI[0]-gI[0])/i,(hI[1]-gI[1])/i,gI[0]/i,gI[1]/i)}(Zc.c.fromTypedArray(a.uvMapSpace),Zc.T.fromTypedArray(a.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),new YA(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer))}},{key:"_createAsOverlayFill",value:function(e){var t,r=e.renderData.polygons,n=(0,Cu.Z)(r);try{for(n.s();!(t=n.n()).done;){var i=t.value,a=i.position,o=i.holeIndices,s=i.index,l=i.count;if((0,Gc.A)(nL),(0,Gc.M)(nL,a),(0,Gc.R)(nL,this._context.clippingExtent)){var u=(0,Qc.x)(a,o,3);if(0!==u.length){(0,Gc.f)(e.outBoundingBox,nL);var c=FS({indices:u,attributeData:{position:a,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*l):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),h=new Zk(c,(0,Nu.e)(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),d=nL;(0,Vu.C)(h.boundingSphere,.5*(d[0]+d[3]),.5*(d[1]+d[4]),0,.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]))),e.outGeometries.push(h)}}}}catch(f){n.e(f)}finally{n.f()}}},{key:"_createAsOverlayOutline",value:function(e){if(this._hasOutline)for(var t=e.renderData.outlines,r=0;r<t.length;++r){var n=t[r].position;if((0,Gc.A)(nL),(0,Gc.M)(nL,n),(0,Gc.R)(nL,this._context.clippingExtent)){(0,Gc.f)(e.outBoundingBox,nL);var i=Yk({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:n}},e.objectAndLayerIdColor),a=new Zk(i,(0,Nu.e)(this._outlineMaterial),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),o=nL;(0,Vu.C)(a.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),e.outGeometries.push(a)}}}},{key:"_getOutlineOpacity",value:function(){var e=(0,Nu.q)(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*((0,Nu.r)(e)?e.a:0)}},{key:"_getOutlineColor",value:function(){var e=(0,Nu.q)(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return DT((0,Nu.r)(e)?sc.l.toUnitRGB(e):null,t)}},{key:"test",value:function(){var e=this;return(0,Tu.Z)((0,Tu.Z)({},(0,_u.Z)((0,bu.Z)(r.prototype),"test",this).call(this)),{},{createAsOverlay:function(t,r){return e._createAsOverlay(t,r)},createAs3DShape:function(t,r,n){return e._createAs3DShape(t,r,n)}})}}]),r}(WC);rL.elevationModeChangeTypes={definedChanged:jT.RECREATE,staysOnTheGround:jT.NONE,onTheGroundChanged:jT.RECREATE};var nL=(0,Gc.a)(),iL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,i,a)).color=n,o}return(0,ku.Z)(r)}(QS),aL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,i,a)).color=n,o}return(0,ku.Z)(r)}(QS),oL=function(){function e(t){(0,Au.Z)(this,e),this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=this._colorToRGBA(t.color),this.haloStyle=this._colorToRGB(t.halo.color),this.backgroundStyle=0!==t.background.color[3]?this._colorToRGBA(t.background.color):null}return(0,ku.Z)(e,[{key:"fontString",value:function(e){var t=this.definition.font;return"".concat(t.style," ").concat(t.weight," ").concat(e,"px ").concat(t.family,", sans-serif")}},{key:"_colorToRGB",value:function(e){return"rgb(".concat(e.slice(0,3).map((function(e){return Math.floor(255*e)})).toString(),")")}},{key:"_colorToRGBA",value:function(e){return"rgba(".concat(e.slice(0,3).map((function(e){return Math.floor(255*e)})).toString(),",").concat(e[3],")")}}],[{key:"fromSymbol",value:function(){var t=(0,Ou.Z)((0,Su.Z)().mark((function t(r){var n,i,a,o,s,l,u,c,h,d,f,p=arguments;return(0,Su.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=p.length>1&&void 0!==p[1]?p[1]:1,i=(0,Nu.q)(r,"material","color"),a=(0,Nu.u)(i,lc.l,sc.l.toUnitRGBA),o=(0,Nu.u)(r.size,12,zu.u),s=r.lineHeight,l=(0,Nu.r)(r.background)?sc.l.toUnitRGBA(r.background.color):lc.l,u={family:(0,Nu.u)(r.font,"sans-serif",(function(e){return e.family})),decoration:(0,Nu.u)(r.font,"none",(function(e){return e.decoration})),weight:(0,Nu.u)(r.font,"normal",(function(e){return e.weight})),style:(0,Nu.u)(r.font,"normal",(function(e){return e.style}))},c=r.halo,h=(0,Nu.r)(c)&&(0,Nu.r)(c.color)&&c.size>0?{size:(0,zu.u)(c.size),color:sc.l.toUnitRGBA(c.color)}:{size:0,color:lc.l},d=new e({color:a,size:o,background:{color:l,padding:(0,Nu.r)(r.background)?[.65*o,.5*o]:[0,0],borderRadius:(0,Nu.r)(r.background)?o*(6/16):0},lineSpacingFactor:s,font:u,halo:h,pixelRatio:n}),f=d.fontString(o),t.prev=2,t.next=5,document.fonts.load(f);case 5:t.next=10;break;case 7:t.prev=7,t.t0=t.catch(2),Eu.a.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce("Failed to preload font '".concat(f,"'. Some text symbology may be rendered using the default browser font."));case 10:return t.abrupt("return",d);case 11:case"end":return t.stop()}}),t,null,[[2,7]])})));return function(e){return t.apply(this,arguments)}}()}]),e}(),sL=function(){function e(t,r,n){(0,Au.Z)(this,e),this._renderer=new $A(t,r,n)}return(0,ku.Z)(e,[{key:"key",get:function(){return this._renderer.key}},{key:"baselineAnchorY",get:function(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}},{key:"displayWidth",get:function(){return this._renderer.displayWidth}},{key:"displayHeight",get:function(){return this._renderer.displayHeight}},{key:"create",value:function(){var e=rk(lL,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new dc.Y(e,{wrap:{s:pc.D.CLAMP_TO_EDGE,t:pc.D.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:vc.h.PAD})}}]),e}(),lL={canvas:null},uL=[0,0,1],cL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,n,i,a))._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},o.ensureDrapedStatus(!1),o}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._drivenProperties.size){e.next=4;break}if(!(t=LT(this.symbolLayer.size))){e.next=4;break}throw new Eu.s("graphics3dtextsymbollayer:invalid-size",t);case 4:return e.next=6,this._createTextRenderParameters();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_createTextRenderParameters",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._context.graphicsCoreOwner.view.state.pixelRatio,e.next=3,oL.fromSymbol(this.symbolLayer,t);case 3:this._textRenderParameters=e.sent;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this)}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic,r=sS(t.geometry);if((0,Nu.t)(r))return this.logger.warn("unsupported geometry type for text symbol: ".concat(t.geometry.type)),null;var n=this.symbolLayer.text;if((0,Nu.t)(n)||""===n)return null;var i=(0,Bc.t)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if((0,Nu.r)(i)&&!(0,Bc.s)(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '".concat(this.symbolLayer.horizontalAlignment,"' alignment)")),null;var a=(0,Tu.Z)((0,Tu.Z)({},fL),{},{verticalOffset:i,horizontalPlacement:this.symbolLayer.horizontalAlignment,verticalPlacement:mk(this.symbolLayer.verticalAlignment)});return this._createAs3DShape(t,r,n,a)}},{key:"createLabel",value:function(e,t,r,n){var i=e.graphic,a=sS(i.geometry);if((0,Nu.t)(a))return this.logger.warn("unsupported geometry type for label: ".concat(i.geometry.type)),null;var o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(i,a,o,t,r,n)}},{key:"setGraphicElevationContext",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=(0,_u.Z)((0,bu.Z)(r.prototype),"setGraphicElevationContext",this).call(this,e,t);return i.addOffsetRenderUnits(n),i}},{key:"layerOpacityChanged",value:function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}},{key:"layerElevationInfoChanged",value:function(e,t){var r=this;return hL(e,t,(function(e,t){r.updateGraphicElevationContext(t,e)})),jT.UPDATE}},{key:"slicePlaneEnabledChanged",value:function(e,t){var r=this;return hL(e,t,(function(e){var t,n=(0,Cu.Z)(e.stageObject.geometryRecords);try{for(n.s();!(t=n.n()).done;){t.value.material.setParameters({hasSlicePlane:r._context.slicePlaneEnabled})}}catch(i){n.e(i)}finally{n.f()}})),!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!1}},{key:"updateGraphicElevationContext",value:function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=BT(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}},{key:"_defaultElevationInfoNoZ",value:function(){return dL}},{key:"_createAs3DShape",value:function(e,t,r,n,i,a){var o=this.setGraphicElevationContext(e,new bC,n.elevationOffset),s="polyline"===(0,Nu.q)(e.geometry,"type"),l=e.uid,u=null,c=null;if((0,Nu.t)(a)){var h=fk(n.horizontalPlacement);u=new sL(r,h,this._textRenderParameters);var d=null;if((0,Nu.r)(this._context.sharedResources.textures)){c=this._context.sharedResources.textures.fromData(u.key,(function(){return(0,Nu.e)(u).create()}),(function(){(0,Nu.r)(d)&&d.release()}));var f=this._context.stage.renderView.textureRepository.acquire(c.texture.id);if((0,Nu.t)(f)||(0,Eu.V)(f))return c.release(),null;d=f}}var p,v=function(e,t){if("baseline"===t.verticalPlacement){var r=hk[t.horizontalPlacement],n=(0,Nu.r)(e)?e.baselineAnchorY:0;return(0,cc.r)(r,n)}var i=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}}(t.horizontalPlacement,t.verticalPlacement);return dk[i]}(u,n),m={occlusionTest:!0,screenOffset:n.screenOffset,anchorPosition:v,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:n.centerOffsetUnits,debugDrawLabelBorder:n.debugDrawLabelBorder,drawInSecondSlot:!0};if((0,Nu.r)(c)&&(m.textureId=c.texture.id),(0,Nu.r)(a)&&(m.textureId=a.id),(0,Nu.r)(n.verticalOffset)){var y=n.verticalOffset,g=y.screenLength,_=y.minWorldLength,b=y.maxWorldLength;m.verticalOffset={screenLength:(0,zu.u)(g),minWorldLength:_||0,maxWorldLength:(0,Nu.r)(b)?b:1/0}}if(this._context.screenSizePerspectiveEnabled){var x=this._context.sharedResources,w=x.screenSizePerspectiveSettings,T=x.screenSizePerspectiveSettingsLabels;m.screenSizePerspective=T.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=w}if(s&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,(0,Nu.r)(i)){var C=JSON.stringify(m);p=i.get(C),(0,Nu.t)(p)&&(p=new ww(m),i.add(C,p))}else p=new ww(m);var S=[p],O=n.translation,P=(0,Nu.r)(u)?[u.displayWidth,u.displayHeight]:[0,0],R=n.centerOffset,A=[hp(uL,O,null,P,R,[0,0],null)],k=this._context.layer.uid,E=aS(this._context,t,A,S,o,k,l);if(null===E)return null;var D=new xC(this,E.object,A,(0,Nu.t)(i)?S:null,c,JT,o);D.alignedSampledElevation=E.sampledElevation,D.needsElevationUpdates=BT(o.mode)||"absolute-height"===o.mode;var M=(0,Nu.r)(u)?u:n,I=M.displayWidth,L=M.displayHeight;D.getScreenSize=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,cc.n)();return e[0]=I,e[1]=L,e};var Z={labelText:r,elevationOffset:n.elevationOffset};return D.metadata=Z,oS(D,t,this._context.elevationProvider),D}}]),r}(WC);function hL(e,t,r){e&&e.forEach((function(e){var n=t(e);(0,Nu.r)(n)&&r(n,e.graphic)}))}var dL={mode:"relative-to-ground",offset:0},fL={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0},pL={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},vL=["polyline","polygon","extent"],mL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){return(0,Au.Z)(this,r),t.call(this,e,n,i,a)}return(0,ku.Z)(r,[{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null}},{key:"createGraphics3DGraphic",value:function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry,vL,this.symbolLayer.type))return null;var r=this.setGraphicElevationContext(t,new bC);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)}},{key:"ensureMaterial",value:function(){if(!(0,Nu.r)(this._material)){var e=new DR,t=this.symbolLayer.color;(0,Nu.r)(t)&&(e.color=sc.l.toUnitRGBA(t));var n=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],n],e.transparent=n<1||this.needsDrivenTransparentPass,e.waveDirection=(0,Nu.r)(this.symbolLayer.waveDirection)?r.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,cc.r)(0,0);var i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=pL[i];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new ER(e),this._context.stage.add(this._material)}}},{key:"layerOpacityChanged",value:function(){if(!(0,Nu.t)(this._material)){var e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:r})}}},{key:"layerElevationInfoChanged",value:function(e,t,n){var i=this._elevationContext.mode,a=VT(r.elevationModeChangeTypes,n,i);if(a!==jT.UPDATE)return a;var o=BT(i);return this.updateGraphics3DGraphicElevationInfo(e,t,(function(){return o}))}},{key:"slicePlaneEnabledChanged",value:function(){return(0,Nu.r)(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}},{key:"physicalBasedRenderingChanged",value:function(){return!0}},{key:"pixelRatioChanged",value:function(){return!0}},{key:"_createAs3DShape",value:function(e,t,r){var n=US(e.geometry);if((0,Nu.t)(n))return null;var i=gA(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=i.position.length/3,o=new Float64Array(2*a),s=new xL(i,o);if(this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,n.rings,"rings","WaterSymbol3DLayer"),0===s.outGeometries.length)return null;this._createUVCoordsFromVertices(s.uvCoords,s.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);var l=new tS({geometries:s.outGeometries,materials:s.outMaterials,transformations:s.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),u=new xC(this,l,s.outGeometries,null,null,KT,t);return u.alignedSampledElevation=s.renderData.sampledElevation,u.needsElevationUpdates=BT(t.mode),u}},{key:"_createUVCoordsFromVertices",value:function(e,t,n,i){var a=(0,Xu.$)(i);(0,ju.D)(gL);for(var o=0;o<n;o++)(0,uc.r)(_L,t[3*o+0],t[3*o+1]),(0,ju.m)(gL,_L);(0,Vu.G)(gL,gL,a);var s=gL[0]%r.unitSizeOfTexture,l=gL[1]%r.unitSizeOfTexture;yL[0]=gL[0]-s,yL[1]=gL[1]-l;for(var u=0;u<n;u++)e[2*u+0]=(t[3*u+0]*a-yL[0])/r.unitSizeOfTexture,e[2*u+1]=(t[3*u+1]*a-yL[1])/r.unitSizeOfTexture}},{key:"_create3DShapeGeometries",value:function(e){var t,r=e.renderData.polygons,n=e.uvCoords,i=(0,Cu.Z)(r);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=a.count,s=a.index,l=a.position,u=a.mapPosition,c=a.holeIndices;if(!(0,Nu.r)(this._context.clippingExtent)||((0,Gc.A)(bL),(0,Gc.M)(bL,u),(0,Gc.R)(bL,this._context.clippingExtent))){var h=(0,Qc.x)(u,c,3);if(0!==h.length){var d=zS({indices:h,attributeData:{position:l,uv0:new Float64Array(n.buffer,2*s*n.BYTES_PER_ELEMENT,2*o),mapPosition:u}});e.outGeometries.push(d),e.outMaterials.push((0,Nu.e)(this._material)),e.outTransforms.push(hc.o)}}}}catch(f){i.e(f)}finally{i.f()}}},{key:"_createAsOverlay",value:function(e){var t=US(e.geometry);if((0,Nu.t)(t))return null;(0,Nu.e)(this._material).renderPriority=this._renderPriority;var r=_A(t,this._context.overlaySR),n=r.position.length/3,i=new Float64Array(2*n),a=new wL(r,i,this._context.layer.uid,e.uid);return a.outBoundingBox=(0,Gc.A)(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===a.outGeometries.length?null:(this._createUVCoordsFromVertices(a.uvCoords,a.renderData.position,n,this._context.overlaySR),new YA(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer))}},{key:"_createAsOverlayWater",value:function(e){var t,r=e.uvCoords,n=e.renderData.polygons,i=(0,Cu.Z)(n);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=a.position,s=a.holeIndices,l=a.index,u=a.count;if((0,Gc.A)(bL),(0,Gc.M)(bL,o),(0,Gc.R)(bL,this._context.clippingExtent)){(0,Gc.f)(e.outBoundingBox,bL);var c=(0,Qc.x)(o,s,3);if(0!==c.length){var h=zS({indices:c,attributeData:{position:o,uv0:new Float64Array(r.buffer,2*l*r.BYTES_PER_ELEMENT,2*u)}}),d=new Zk(h,(0,Nu.e)(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),f=bL;(0,Vu.C)(d.boundingSphere,.5*(f[0]+f[3]),.5*(f[1]+f[4]),0,.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]))),e.outGeometries.push(d)}}}}catch(p){i.e(p)}finally{i.f()}}},{key:"test",value:function(){var e=this;return(0,Tu.Z)((0,Tu.Z)({},(0,_u.Z)((0,bu.Z)(r.prototype),"test",this).call(this)),{},{create3DShape:function(t){return e._createAs3DShape(t.graphic,t.elevationContext,t.graphicUid)},ensureMaterial:function(){return e.ensureMaterial()}})}}],[{key:"headingVectorFromAngle",value:function(e){var t=(0,cc.n)(),r=(0,Vu.f)(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t}}]),r}(WC);mL.unitSizeOfTexture=100,mL.elevationModeChangeTypes={definedChanged:jT.RECREATE,staysOnTheGround:jT.NONE,onTheGroundChanged:jT.RECREATE};var yL=(0,cc.n)(),gL=(0,ju.u)(),_L=(0,cc.n)(),bL=(0,Gc.a)(),xL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this,e,null,null)).uvCoords=n,i}return(0,ku.Z)(r)}(QS),wL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,e,i,a)).uvCoords=n,o}return(0,ku.Z)(r)}(QS);function TL(e,t,r,n){var i=SL[e.type]&&SL[e.type][t.type]||CL[t.type];return i?new i(e,t,r,n):(Eu.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make","unknown symbol type ".concat(t.type)),null)}var CL={icon:Bk,object:YD,line:SE,path:KM,fill:rL,extrude:OA,text:cL,water:mL},SL={"mesh-3d":{fill:eD}},OL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,n.schedule))._symbol=e,a._context=n,a._backgroundLayers=i,a._destroyed=!1,a.symbolLayers=new Array,a.referenced=0,a._extentPadding=0,a}return(0,ku.Z)(r,[{key:"symbol",get:function(){return this._symbol},set:function(e){this._symbol=e;for(var t=0;t<e.symbolLayers.length;t++){var r=this.symbolLayers[t];(0,Nu.t)(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[t])}}},{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a,o,s,l,u,c=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=this._symbol.symbolLayers,this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r)),n=r.length;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length,i=[],a=function(e){var a=r.getItemAt(e);if(!1===a.enabled)return"continue";PL.renderPriority=1-(1+e)/n,PL.renderPriorityStep=1/n,PL.ignoreDrivers=a._ignoreDrivers;var o=TL(c.symbol,a,c._context,PL);i.push((0,Eu.o)(t,(function(){c.symbolLayers[e]=null,o.destroy()}))),c.symbolLayers[e]=o},o=0;case 8:if(!(o<n)){e.next=15;break}if("continue"!==a(o)){e.next=12;break}return e.abrupt("continue",12);case 12:o++,e.next=8;break;case 15:return e.next=17,(0,ac.c)(this.symbolLayers,function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,Nu.r)(t)){e.next=10;break}return e.prev=1,e.next=4,t.load();case 4:c._extentPadding+=Math.max(c._extentPadding,t.extentPadding),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),c.symbolLayers[r]=null;case 10:case"end":return e.stop()}}),e,null,[[1,7]])})));return function(t,r){return e.apply(this,arguments)}}());case 17:for(s=0,l=i;s<l.length;s++)null===(u=l[s])||void 0===u||u.remove();if(i.length=0,(0,Eu.f)(t),!this.symbolLayers.length||this.symbolLayers.some((function(e){return!!e}))){e.next=20;break}throw new Error;case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getSymbolLayerSize",value:function(e){var t=this.symbolLayers[e];return(0,Nu.r)(t)?t.getCachedSize():null}},{key:"extentPadding",get:function(){return this._extentPadding}},{key:"symbologySnappingSupported",get:function(){return this.symbolLayers.some((function(e){return(0,Nu.r)(e)&&e.queryForSnapping}))}},{key:"createGraphics3DGraphic",value:function(e,t){for(var r=e.graphic,n=new Array(this.symbolLayers.length),i=0;i<this.symbolLayers.length;i++){var a=this.symbolLayers[i];n[i]=(0,Nu.r)(a)?a.createGraphics3DGraphic(e):null}var o=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new ES(r,t||this,n,e.layer,o)}},{key:"complexity",get:function(){return UC(this.symbolLayers.map((function(e){return(0,Nu.q)(e,"complexity")})))}},{key:"globalPropertyChanged",value:function(e,t){for(var r=this,n=this.symbolLayers.length,i=function(n){var i=r.symbolLayers[n];if((0,Nu.r)(i)&&!i.globalPropertyChanged(e,t,(function(e){var t=e.graphics[n];return t instanceof xC?t:null})))return{v:!1}},a=0;a<n;a++){var o=i(a);if("object"===typeof o)return o.v}return!0}},{key:"applyRendererDiff",value:function(e,t){return this.loadStatus!==RC.LOADED?TC.Recreate_Symbol:this.symbolLayers.reduce((function(r,n){return r!==TC.Recreate_Symbol&&(0,Nu.r)(n)?Math.min(r,n.applyRendererDiff(e,t)):r}),TC.Fast_Update)}},{key:"prepareSymbolPatch",value:function(e){if(this.loadStatus!==RC.FAILED&&"partial"===e.diff.type){var t=e.diff.diff;if(t.symbolLayers&&"partial"===t.symbolLayers.type){var r=t.symbolLayers.diff;this.symbolLayers.forEach((function(t,n){if(!(0,Nu.t)(t)){var i=r[n];if(i){var a,o={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(o),(a=e.symbolStatePatches).push.apply(a,(0,mu.Z)(o.symbolLayerStatePatches)),o.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((function(e,t){var r=e.graphics[n];(0,Nu.r)(r)&&o.graphics3DGraphicPatches.forEach((function(e){return e(r,t)}))}))}}}))}}}},{key:"updateGeometry",value:function(e,t){for(var r=0;r<this.symbolLayers.length;r++){var n=this.symbolLayers[r];if(!(0,Nu.t)(n)){var i=e.graphics[r];if((0,Nu.t)(i)||!n.updateGeometry(i,t))return!1}}return!0}},{key:"onRemoveGraphic",value:function(e){for(var t=0;t<this.symbolLayers.length;t++){var r=this.symbolLayers[t];if(!(0,Nu.t)(r)){var n=e.graphics[t];(0,Nu.r)(n)&&r.onRemoveGraphic(n)}}}},{key:"getFastUpdateStatus",value:function(){var e=0,t=0,r=0;return this.symbolLayers.forEach((function(n){(0,Nu.t)(n)||(n.loadStatus===RC.LOADING?e++:n.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}}},{key:"queryForSnapping",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i){var a,o;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.symbolLayers.filter(Nu.r).filter((function(e){return(0,Nu.r)(e.queryForSnapping)})).map((function(e){return e.queryForSnapping(t,r,n,i)})),e.next=3,Promise.all(a);case 3:return o=e.sent,e.abrupt("return",((0,Eu.f)(i),o.flat()));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this);var e,t=(0,Cu.Z)(this.symbolLayers);try{for(t.s();!(e=t.n()).done;){var n=e.value;(0,Nu.r)(n)&&n.destroy()}}catch(i){t.e(i)}finally{t.f()}this.symbolLayers.length=0,this._destroyed=!0}}},{key:"destroyed",get:function(){return this._destroyed}}]),r}(AC),PL={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1},RL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,n)).symbol=e,a._convert=i,a.symbologySnappingSupported=!1,a.graphics3DSymbol=null,a.referenced=0,a}return(0,ku.Z)(r,[{key:"getSymbolLayerSize",value:function(e){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}},{key:"symbolLayers",get:function(){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}},{key:"extentPadding",get:function(){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}},{key:"doLoad",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.symbol.fetchSymbol({signal:t});case 2:if((r=e.sent).id=this.symbol.id,this.graphics3DSymbol=this._convert(r),e.t0=(0,Nu.r)(this.graphics3DSymbol),!e.t0){e.next=9;break}return e.next=9,this.graphics3DSymbol.load();case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createGraphics3DGraphic",value:function(e){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}},{key:"complexity",get:function(){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:FC}},{key:"globalPropertyChanged",value:function(e,t){return!!(0,Nu.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}},{key:"applyRendererDiff",value:function(e,t){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,t):TC.Recreate_Symbol}},{key:"prepareSymbolPatch",value:function(e){(0,Nu.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}},{key:"updateGeometry",value:function(e,t){return!!(0,Nu.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}},{key:"onRemoveGraphic",value:function(){}},{key:"getFastUpdateStatus",value:function(){return(0,Nu.r)(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}},{key:"destroy",value:function(){(0,Nu.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,(0,_u.Z)((0,bu.Z)(r.prototype),"destroy",this).call(this)}},{key:"destroyed",get:function(){return void 0===this.graphics3DSymbol}}]),r}(AC);function AL(e){return e instanceof RL?e.graphics3DSymbol:e instanceof OL?e:null}var kL=Eu.a.getLogger("esri.views.3d.layers.graphics.labelPlacement");function EL(e){var t=function(e){var t=e.labelClass.labelPlacement,r=e.labelSymbol,n=e.graphics3DGraphic,i=AL(n.graphics3DSymbol),a=(0,Nu.n)(i,(function(e){return"point-3d"===e.symbol.type?e.symbol:null})),o=NL[t]||IL(e);return(0,Nu.r)(a)&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!n.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:ZL(a.verticalOffset),anchor:null,normalizedOffset:null}:r&&r.hasVisibleVerticalOffset()&&((0,Nu.t)(a)||!a.supportsCallout()||!a.verticalOffset||n.isDraped)?function(e){return"above-center"===e}(o.placement)?{placement:"above-center",verticalOffset:ZL(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(kL.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if((0,Nu.t)(t))return null;var r=function(e,t){if(t.anchor)return t;var r=e.labelClass.labelPlacement,n=NL[r],i=n||IL(e);return r&&!n&&kL.warnOncePerTick("the requested label placement '".concat(r,"' is currently unsupported in SceneView.")),function(e,t){var r=t.graphics3DGraphic.graphic.geometry;if((0,Nu.t)(r))return null;if((0,Nu.r)(t.disablePlacement))return t.labelClass.labelPlacement?(kL.warnOncePerTick(ML(e.placement,t.disablePlacement.logEntityDescription)),IL(t)):e;var n=r.type;switch(n){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return kL.warnOncePerTick(ML(e.placement,"'".concat(n,"' geometries"))),IL(t);break;case"point":case"mesh":return e}return e}(i,e)}(e,t);if((0,Nu.t)(r))return null;var n=r.anchor,i=!!t.hasLabelVerticalOffset;return function(e,t,r){var n=r.graphics3DGraphic.graphic.geometry;if((0,Nu.t)(n))return null;switch(n.type){case"point":!function(e,t,r){var n=DL(r);if((0,Nu.t)(n))return;var i=r.graphics3DGraphic.graphics[0];switch((0,Nu.r)(i)?i.getCenterObjectSpace(e.translation):(0,Vu.o)(e.translation,0,0,0),n.type){case"icon":case"text":!function(e,t,r,n){var i=r.graphics3DGraphic,a=(0,Nu.r)(n)?n.getScreenSize():null;if(!i.isDraped&&(0,Nu.r)(a)){var o=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:BL,r=e.graphics3DGraphic.graphics[0],n=(0,Nu.r)(r)?r.stageObject.geometryRecords[0].material:null;if(n&&n instanceof ww){var i=n.parameters.anchorPosition;t[0]=2*(i[0]-.5),t[1]=2*(i[1]-.5)}else t[0]=0,t[1]=0;return t}(r);VL[0]=a[0]/2*(t.normalizedOffset[0]-o[0]),VL[1]=a[1]/2*(t.normalizedOffset[1]-o[1]),e.screenOffset[0]=VL[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=VL[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=VL[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(NL[r.labelClass.labelPlacement]&&kL.warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center")}(e,t,r,i);break;case"object":LL(e,t,i)}}(e,t,r);break;case"polygon":!function(e,t,r){var n=DL(r);if(!(0,Nu.t)(n)&&"extrude"===n.type){var i=r.graphics3DGraphic.graphics[0];(0,Nu.r)(i)?(i.getBoundingBoxObjectSpace(GL),(0,Gc.p)(GL,e.translation),e.translation[2]=(0,Gc.N)(GL)/2):(0,Vu.o)(e.translation,0,0,0),LL(e,t,i)}}(e,t,r);break;case"mesh":LL(e,t,r.graphics3DGraphic.graphics[0])}return e}({anchor:n,verticalOffset:t.verticalOffset,screenOffset:(0,cc.n)(),centerOffset:(0,lc.r)(0,0,0,-1),centerOffsetUnits:"world",translation:(0,Vu.n)(),elevationOffset:0,hasLabelVerticalOffset:i},r,e)}function DL(e){var t=AL(e.graphics3DGraphic.graphics3DSymbol);return(0,Nu.r)(t)?t.symbol.symbolLayers.getItemAt(0):null}function ML(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function IL(e){var t=e.graphics3DGraphic.graphic.geometry;if((0,Nu.t)(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":var r=DL(e);return(0,Nu.r)(r)&&"extrude"===r.type?NL["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"};case"point":case"mesh":return NL["above-center"];default:return}}function LL(e,t,r){var n=(0,Nu.r)(r)?r.getBoundingBoxObjectSpace(GL):GL,i=(0,Vu.c)(n[3]-n[0],n[4]-n[1],n[5]-n[2]),a=Math.sqrt(i[0]*i[0]+i[1]*i[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];var o=e.translation[2],s=i[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+s;var l=(0,Vu.s)(i);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function ZL(e){return{screenLength:e.screenLength,minWorldLength:e.minWorldLength,maxWorldLength:e.maxWorldLength}}var NL={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},FL={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]},zL=function(e){var t=FL[e],r=NL[e];t.forEach((function(e){NL[e]=r}))};for(var UL in FL)zL(UL);Object.freeze&&(Object.freeze(NL),Object.keys(NL).forEach((function(e){Object.freeze(NL[e]),Object.freeze(NL[e].normalizedOffset)})));var VL=[0,0],BL=[0,0],GL=(0,Gc.a)(),HL=function(){function e(t){(0,Au.Z)(this,e),this._stage=t,this._materials=new Map}return(0,ku.Z)(e,[{key:"get",value:function(e){return this._materials.get(e)}},{key:"add",value:function(e,t){this._materials.set(e,t),this._stage.add(t)}},{key:"dispose",value:function(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}]),e}(),jL=512,qL=4096,WL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).type=dc.ap.Texture,n.id=(0,Eu.a4)(),n.events=new ec.n,n._glTexture=null,n._needsClear=!1,n._elementsToAddOrUpdate=new Map,n._elementsToRemove=new Map,n._elementsToRender=new Map,n._elements=new Map,n._stageObjects=new Map,n.updating=!1,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);var e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}},{key:"unload",value:function(){this._glTexture=(0,Nu.G)(this._glTexture),this.updating=!1,this.events.emit("unloaded")}},{key:"width",get:function(){return this._atlas.size.width}},{key:"height",get:function(){return this._atlas.size.height}},{key:"requiresFrameUpdates",get:function(){return!1}},{key:"_createDescriptor",value:function(e){return{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,flipped:!0,samplingMode:pc.L.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}},{key:"glTexture",get:function(){return this._glTexture}},{key:"load",value:function(e){return(0,Nu.r)(this._glTexture)||(this._glTexture=new Oc.E(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(bc.I.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}},{key:"dispose",value:function(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=(0,Nu.f)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,Nu.G)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}},{key:"_create2DCanvas",value:function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",jL.toString()),e.setAttribute("height",jL.toString()),e}},{key:"_update2DCanvasSize",value:function(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}},{key:"_createAtlasRegion",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:jL;this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}},{key:"_computeAtlasResolution",value:function(e,t){var r=Math.max(e,t);return r+=256,r=(0,Vu.a8)(r),r=Math.min(r,qL)}},{key:"_resizeAtlas",value:function(e,t){t=t||e;var r=this._atlas;r.size.width=e,r.size.height=t,(0,Nu.r)(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}},{key:"_resetAtlasCursor",value:function(){var e=this._atlas;e.cursor.x=YL,e.cursor.y=YL+QL,e.lineHeight=0,this._needsClear=!0}},{key:"_getAtlasUsage",value:function(){var e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}},{key:"_getExpectedAtlasUsage",value:function(){var e=this._elementsToRemove.size,t=this._elementsToAddOrUpdate.size,r=this._elements.size;return this._getAtlasUsage()/r*(r+t-e)}},{key:"_addAtlasElement",value:function(e,t,r,n){var i=this._atlas,a=e.textRenderer,o=a.renderedWidth,s=a.renderedHeight,l=a.displayWidth,u=a.displayHeight;e.placement.offset.x=i.cursor.x,e.placement.offset.y=i.cursor.y,e.placement.size.width=o,e.placement.size.height=s,e.placement.size.displayWidth=l,e.placement.size.displayHeight=u,e.placement.uvMinMax=[e.placement.offset.x/i.size.width,1-(e.placement.offset.y+s)/i.size.height,(e.placement.offset.x+o)/i.size.width,1-e.placement.offset.y/i.size.height],i.cursor.x+=r,i.lineHeight=Math.max(i.lineHeight,n),this._elements.set(t,e)}},{key:"_removeAtlasElement",value:function(e){if(e&&this._elements.has(e.textId)){var t=e.placement.offset,r=e.placement.size;this._ctx.clearRect(t.x,t.y,r.width,r.height),this._elements.delete(e.textId)}}},{key:"_ensureStageObjects",value:function(e){var t=this._stageObjects.get(e);if(t)return t;var r=new Set;return this._stageObjects.set(e,r),r}},{key:"_addStageObject",value:function(e,t){this._ensureStageObjects(e).add(t)}},{key:"_removeStageObject",value:function(e,t){var r=this._stageObjects.get(e);r&&r.delete(t)&&(t.geometries[0].vertexAttributes.get(fc.O.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))}},{key:"_processAddition",value:function(e,t){var r=this._atlas,n=e.textId,i=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,o=i+YL,s=a+YL+QL;if(r.cursor.x+o<r.size.width&&r.cursor.y+s<r.size.height)this._addAtlasElement(e,n,o,s),this._elementsToRender.set(n,e),this._elementsToAddOrUpdate.delete(n);else{if(!(r.cursor.y+s+r.lineHeight<r.size.height)){var l=this._getExpectedAtlasUsage(),u=l>.85&&r.size.width<qL;return u&&this._resizeAtlas(2*r.size.width,2*r.size.height),!t||!u&&l>.95&&r.size.width===qL?(this._processRemovals(),XL.OK):(this._repack(),XL.REPACK)}r.cursor.x=YL,r.cursor.y+=r.lineHeight,r.lineHeight=0,this._addAtlasElement(e,n,o,s),this._elementsToRender.set(n,e),this._elementsToAddOrUpdate.delete(n)}return XL.OK}},{key:"_processRemovals",value:function(){var e=this;this._elementsToRemove.forEach((function(t,r){var n=e._stageObjects.get(r);n&&0!==n.size||e._removeAtlasElement(t),n&&0===n.size&&e._stageObjects.delete(r)})),this._elementsToRemove.clear()}},{key:"_repack",value:function(){var e=this;this._processRemovals(),this._elements.forEach((function(t,r){t.rendered=!1,e._elementsToAddOrUpdate.set(r,t)})),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}},{key:"_processRenderingRequest",value:function(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);var t=this._stageObjects.get(e.textId);t&&t.forEach((function(t){t.geometries[0].vertexAttributes.get(fc.O.UV0).data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get(fc.O.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(t.geometryRecords[0])})),e.rendered=!0}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._glTexture){var n=!1;if((0,Eu.a9)(this._elementsToAddOrUpdate,(function(e,i){var a=t._elements.get(i);if(a&&a.rendered){var o=t._stageObjects.get(i);return o&&o.forEach((function(e){var r=e.geometries[0].vertexAttributes,n=t._elements.get(i);r.get(fc.O.UV0).data=new Float32Array(n.placement.uvMinMax),r.get(fc.O.SIZE).data=new Float32Array([n.placement.size.displayWidth,n.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(e.geometryRecords[0])})),t._elementsToAddOrUpdate.delete(i),!1}return t._processAddition(t._elementsToAddOrUpdate.get(i),r)===XL.REPACK&&(n=!0,!0)})),n)this.runTask(bc.F,!1);else{var i=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),(0,Eu.a9)(this._elementsToRender,(function(r,n){return t._processRenderingRequest(r),t._elementsToRender.delete(n),i=!0,e.madeProgress(),e.done})),i&&(0,Nu.r)(this._glTexture)&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&mO&&this.repackOrdered()}}}},{key:"addTextTexture",value:function(e,t){var r=e.key;this._elementsToAddOrUpdate.has(r)||this._elementsToAddOrUpdate.set(r,{textId:r,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(r,t),this._elementsToRemove.delete(r),this.setDirty()}},{key:"removeTextTexture",value:function(e,t){var r=e.key;this._elementsToRemove.set(r,this._elements.get(r)),this._removeStageObject(r,t)}},{key:"setDirty",value:function(){this._glTexture&&(this.updating=!0)}},{key:"repackOrdered",value:function(){if(0!==this._elements.size){var e=[];this._elements.forEach((function(t,r){return e.push({element:t,key:r})}));for(var t=!0,r=0;r<e.length-1;r++)if(e[r].key.localeCompare(e[r+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort((function(e,t){return e.key.localeCompare(t.key)})),this._elements.clear();var n,i=(0,Cu.Z)(e);try{for(i.s();!(n=i.n()).done;){var a=n.value,o=a.element,s=a.key;this._elements.set(s,o)}}catch(l){i.e(l)}finally{i.f()}this._repack(),this.setDirty()}}}},{key:"test",get:function(){var e=this._elements,t=this._stageObjects,r=this._elementsToRemove,n=this._atlas,i=this;return{elements:e,stageObjects:t,elementsToRemove:r,atlas:n,_resizeAtlas:function(e,t){return i._resizeAtlas(e,t)},run:function(e,t){return i.runTask(e,t)}}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],WL.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],WL.prototype,"updating",void 0),WL=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],WL);var XL,YL=2,QL=2;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(XL||(XL={}));var KL=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._dirty=!1,n._labels=new Map,n._labelsToAdd=new Map,n._labelsToRemove=new Map,n._labelingContexts=new Array,n}return(0,ku.Z)(r,[{key:"setup",value:function(){var e=this;this.dispose(),this._handles=new Eu.X,this._handles.add([(0,Fu.l)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e.setDirty()})),(0,Fu.l)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.pixelRatio}),(function(){return e._resetAllLabels()})),this.view.resourceController.scheduler.registerTask(bc.I.LABELER,this)]),this._textTextureAtlas=new WL({view:this.view}),this._hudMaterialCollection=new HL(this.view._stage),this._calloutMaterialCollection=new HL(this.view._stage)}},{key:"dispose",value:function(){this._handles=(0,Nu.g)(this._handles),this._textTextureAtlas=(0,Nu.G)(this._textTextureAtlas),this._hudMaterialCollection=(0,Nu.G)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,Nu.G)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}},{key:"_activateLabelingContext",value:function(e){var t=this;e.labels.forEach((function(e,r){t._labels.set(r,e),e.graphics3DGraphic.setVisibilityFlag(Ix.USER_SETTING,!0,Mx.LABEL)})),e.active=!0}},{key:"_deactivateLabelingContext",value:function(e){var t=this;e.labels.forEach((function(e,r){e.graphics3DGraphic.setVisibilityFlag(Ix.USER_SETTING,!1,Mx.LABEL),t.setLabelGraphicVisibility(e.graphics3DGraphic,!1),t._labels.delete(r)})),e.active=!1}},{key:"_addLabelTextureToAtlas",value:function(e){var t,r=(0,Cu.Z)(e.graphics3DGraphic.labelGraphics);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n._labelClass){var i=e.textTextureResources.textRenderers[n._labelIndex];(0,Nu.r)(i)&&this._textTextureAtlas.addTextTexture(i,n.stageObject)}}}catch(a){r.e(a)}finally{r.f()}e.rendered=!0}},{key:"_removeLabelTextureFromAtlas",value:function(e){var t,r=(0,Cu.Z)(e.graphics3DGraphic.labelGraphics);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n._labelClass){var i=e.textTextureResources.textRenderers[n._labelIndex];(0,Nu.r)(i)&&this._textTextureAtlas.removeTextTexture(i,n.stageObject)}}}catch(a){r.e(a)}finally{r.f()}e.rendered=!1}},{key:"running",get:function(){var e;return this.view.ready&&(this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.running)}},{key:"runTask",value:function(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}},{key:"_updateLabels",value:function(e){var t=this;if(this._dirty){this._dirty=!1;var r,n=(0,Cu.Z)(this._labelingContexts);try{var i=function(){var n=r.value;if(function(e){return e.active&&(0,$u.s)(e.layer)}(n)){if(!$L(n)){if(function(e){return null===e.labelClassContexts}(n))return t._deactivateLabelingContext(n),"continue";if(t._createLabelClassContext(n),JL(n))return t._dirty=!0,"continue";if(!$L(n))return"continue"}(0,Eu.a9)(n.labelsToInitialize,(function(r,i){return t._ensureGraphics3DResources(r)&&(t._labels.set(i,r),t.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textTextureResources.initialized||!r.visible&&r.hasGraphics3DResources)&&(n.labelsToInitialize.delete(i),e.madeProgress()),e.done}))&&(t._dirty=!0)}};for(n.s();!(r=n.n()).done;)i()}catch(a){n.e(a)}finally{n.f()}this._labelsToRemove.forEach((function(e){return t._removeLabelTextureFromAtlas(e)})),this._labelsToAdd.forEach((function(e){return t._addLabelTextureToAtlas(e)})),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}},{key:"_createLabelClassContextAsync",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a,o,s,l=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.labelClassAbortController.signal,e.next=3,t.layer.when();case 3:if((0,Eu.f)(r),t.scaleVisibility&&t.scaleVisibility.updateScaleRangeActive(),n=t.graphics3DCore,i=n.layer,a=i.labelingInfo&&i.labelingInfo.filter((function(e){return!!e.symbol})),a&&0!==a.length){e.next=8;break}return e.abrupt("return");case 8:return o=new Array(a.length),s=!1,e.next=12,(0,ac.c)(a,function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(i,a){var u,c,h,d,f;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=i.symbol,c=AL(n.getOrCreateGraphics3DSymbol(u)),!(0,Nu.t)(c)){e.next=3;break}return e.abrupt("return",void Eu.a.getLogger(l.declaredClass).error("Failed to create Graphics3DSymbol for label"));case 3:return e.next=5,c.load();case 5:if((0,Eu.f)(r),h=null,e.t0=(0,Bc.t)(u)&&u.hasVisibleCallout(),!e.t0){e.next=13;break}return h=OS(u,n.symbolCreationContext),e.next=12,h.load();case 12:(0,Eu.f)(r);case 13:return e.next=15,(0,ac.b)((0,Vc.createLabelFunction)(i,t.layer.fieldsIndex,l.view.spatialReference));case 15:if(d=e.sent,(0,Eu.f)(r),!0!==d.ok){e.next=23;break}return e.next=19,l._createTextRenderParameters(c.symbol);case 19:f=e.sent,(0,Eu.f)(r),o[a]={labelClass:i,labelFunction:d.value,graphics3DSymbol:c,graphics3DCalloutSymbolLayer:h,calloutSymbolLayerIndex:0,textRenderParameters:f},e.next=24;break;case 23:Eu.a.getLogger(l.declaredClass).error("Label expression failed to evaluate: ".concat(d.error)),s=!0;case 24:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());case 12:(0,Eu.f)(r),s||(t.labelClassContexts=o);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelClassContext",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(t.labelClassPromise||(t.labelClassPromise=this._createLabelClassContextAsync(t).catch((function(e){if((0,Eu.j)(e))throw e;t.labelClassContexts=null})).then((function(){t.labelClassAbortController=null,r.notifyChange("updating")})).catch((function(){})),this.notifyChange("updating")),t.labelClassPromise));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createTextRenderParameters",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.symbolLayers.getItemAt(0),e.abrupt("return",r&&"text"===r.type?oL.fromSymbol(r,this.view.state.pixelRatio):null);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_destroyLabelClassContext",value:function(e){var t,r=(0,Cu.Z)(e.labelClassContexts);try{for(r.s();!(t=r.n()).done;){var n=t.value;--n.graphics3DSymbol.referenced,n.graphics3DSymbol=null}}catch(a){r.e(a)}finally{r.f()}var i=e.labelClassAbortController;e.labelClassAbortController=new AbortController,i&&i.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}},{key:"_createTextSymbolGraphic",value:function(e,t,r,n,i){var a={text:e.text,centerOffset:r.centerOffset,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffsetUnits:r.centerOffsetUnits,horizontalPlacement:pk(r.anchor),verticalPlacement:vk(r.anchor),verticalOffset:r.verticalOffset,debugDrawLabelBorder:Ac.t.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return tZ.graphic=t,tZ.renderingInfo=null,tZ.layer=n,i.createLabel(tZ,a,this._hudMaterialCollection,this._textTextureAtlas)}},{key:"_createLineCalloutGraphic",value:function(e,t,r,n,i){var a={symbol:t,translation:n.translation,elevationOffset:n.elevationOffset,screenOffset:n.screenOffset,centerOffset:n.centerOffset,centerOffsetUnits:n.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return tZ.graphic=e,tZ.renderingInfo=a,tZ.layer=i,r.createGraphics3DGraphic(tZ)}},{key:"_ensureGraphics3DResources",value:function(e){if(e.hasGraphics3DResources)return!1;var t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);var r=e.textTextureResources,n=e.labelingContext,i=n.labelClassContexts;if(!i||0===i.length||!n.emptySymbolLabelSupported&&0===t.graphics.length)return!1;for(var a=!1,o=t.graphic,s=n.layer,l=(0,$u.s)(n.layer),u=this.view._stage,c=0;c<i.length;c++){var h=r.textRenderers[c],d=r.labelPlacements[c];if(!(0,Nu.t)(h)&&!(0,Nu.t)(d)){var f=i[c],p=f.graphics3DSymbol,v=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null,m=p.symbolLayers[0];if(m){m.setElevationInfoOverride(n.elevationInfoOverride);var y=this._createTextSymbolGraphic(h,o,d,s,m);if(!y)return!1;y._labelClass=f.labelClass,y._labelIndex=c,t.addLabelGraphic(y,u,n.stageLayer),t.setVisibilityFlag(Ix.USER_SETTING,l,Mx.LABEL),t.clearVisibilityFlag(Ix.SCALE_RANGE,Mx.LABEL),t.setVisibilityFlag(Ix.DECONFLICTION,!1,Mx.LABEL),a=!0;var g=f.graphics3DCalloutSymbolLayer;if(g&&d.hasLabelVerticalOffset){g.setElevationInfoOverride(n.elevationInfoOverride);var _=this._createLineCalloutGraphic(o,v,g,d,s);(0,Nu.r)(_)&&(f.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(_,u,n.stageLayer))}break}}}return n.scaleVisibility&&a&&n.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}},{key:"_destroyGraphics3DResources",value:function(e){var t,r=e.labelingContext.labelClassContexts,n=(0,Cu.Z)(e.graphics3DGraphic.labelGraphics);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(null!=i._labelClass){var a=r[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=a&&a.onRemoveGraphic(i)}}}catch(o){n.e(o)}finally{n.f()}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}},{key:"_ensureTextTextureResources",value:function(e){var t=e.textTextureResources;if(!t.initialized){var r=e.labelingContext,n=r.labelClassContexts;if(n&&0!==n.length){for(var i=e.graphics3DGraphic.graphic,a=0;a<n.length;a++){var o=n[a];if(t.textRenderers[a]=null,t.labelPlacements[a]=null,o.textRenderParameters){var s=o.labelFunction,l=void 0;if("arcade"===s.type)try{var u=s.needsHydrationToEvaluate()?bT(i,r.layer):i;l=s.evaluate(u)}catch(p){l=null}else l=s.evaluate(i);if(!(0,Nu.t)(l)&&""!==l&&!/^\s+$/.test(l)){var c=o.graphics3DSymbol,h=c.symbol&&"label-3d"===c.symbol.type?c.symbol:null;if(c.symbolLayers[0]){var d=EL({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:h,labelClass:o.labelClass,disablePlacement:r.disablePlacement});if(!(0,Nu.t)(d)){var f=fk(pk(d.anchor));t.textRenderers[a]=new $A(l,f,o.textRenderParameters),t.labelPlacements[a]=d}}}}}t.initialized=!0}}}},{key:"_destroyTextTextureResources",value:function(e){var t=e.textTextureResources;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]}},{key:"_addGraphic",value:function(e,t){var r={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},n=t.graphic.uid;e.labels.set(n,r),e.labelsToInitialize.set(n,r),this.setDirty(),this.deconflictor.setDirty()}},{key:"_removeGraphic",value:function(e,t){var r=t.graphic.uid,n=e.labels.get(r);n&&(this._destroyGraphic(n,r),e.labels.delete(r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())}},{key:"_destroyGraphic",value:function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}},{key:"_labelingInfoChange",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return",(this._visibilityInfoChange(t),this._resetLabels(t),this._createLabelClassContext(t)));case 2:n=(0,Cu.Z)(r);try{for(n.s();!(i=n.n()).done;)a=i.value,(o=t.labels.get(a))&&(this._removeGraphic(t,o.graphics3DGraphic),this._addGraphic(t,o.graphics3DGraphic))}catch(s){n.e(s)}finally{n.f()}case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_globalPropertyChanged",value:function(e,t){var r,n=(0,Cu.Z)(t.labelClassContexts);try{var i=function(){var n=r.value,i=new Map;t.labels.forEach((function(e){var t=e.graphics3DGraphic;i.set(t.graphic.uid,t)}));if((0,Nu.e)(n.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,i,(function(e){return e.labelGraphics[0]})),n.graphics3DCalloutSymbolLayer){n.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,i,(function(e){return e.labelGraphics[n.calloutSymbolLayerIndex]}))}};for(n.s();!(r=n.n()).done;)i()}catch(a){n.e(a)}finally{n.f()}}},{key:"_visibilityInfoChange",value:function(e){var t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}},{key:"_resetAllLabels",value:function(){var e,t=(0,Cu.Z)(this._labelingContexts);try{for(t.s();!(e=t.n()).done;){var r=e.value;this._resetLabels(r)}}catch(n){t.e(n)}finally{t.f()}}},{key:"_resetLabels",value:function(e){var t=this;e.labels.forEach((function(r,n){t._destroyGraphic(r,n),r.visible=!1,r.rendered=!1,e.labelsToInitialize.set(n,r)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}},{key:"_findLabelingContext",value:function(e){var t,r=(0,Cu.Z)(this._labelingContexts);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.graphics3DCore===e)return n}}catch(i){r.e(i)}finally{r.f()}return null}},{key:"addGraphicsOwner",value:function(e,t,r){var n=this,i=r&&r.emptySymbolLabelSupported||!1,a=r&&r.elevationInfoOverride||null,o=r&&r.disablePlacement||null;if(!this._findLabelingContext(e)){var s=e.layer,l={graphics3DCore:e,layer:s,scaleVisibility:t,emptySymbolLabelSupported:i,elevationInfoOverride:a,disablePlacement:o,active:s.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new _O({isPickable:!0},s.uid)};return this.view._stage.add(l.stageLayer),this._labelingContexts.push(l),this.setDirty(),{addGraphic:function(e){return n._addGraphic(l,e)},removeGraphic:function(e){return n._removeGraphic(l,e)},featureReductionChange:function(){},layerLabelsEnabled:function(){return(0,$u.s)(l.layer)},labelingInfoChange:function(e){return n._labelingInfoChange(l,e)},elevationInfoChange:function(){return n._globalPropertyChanged("elevationInfo",l)},slicePlaneEnabledChange:function(){return n._globalPropertyChanged("slicePlaneEnabled",l)},visibilityInfoChange:function(){return n._visibilityInfoChange(l)},reset:function(){return n._resetLabels(l)},clear:function(){}}}}},{key:"removeGraphicsOwner",value:function(e){var t=this,r=this._findLabelingContext(e);if(r){var n=this._labelingContexts.indexOf(r);this._labelingContexts.splice(n,1),r.labels.forEach((function(e){return t._removeGraphic(r,e.graphics3DGraphic)})),this.view._stage.remove(r.stageLayer),r.stageLayer=null,this.setDirty()}}},{key:"setLabelGraphicVisibility",value:function(e,t){var r=e.graphic.uid,n=this._labels.get(r);n&&n.visible!==t&&(t&&!n.rendered?(this._labelsToAdd.set(r,n),this._labelsToRemove.delete(r),n.textTextureResources.initialized||n.labelingContext.labelsToInitialize.set(r,n)):!t&&n.rendered&&(this._labelsToRemove.set(r,n),this._labelsToAdd.delete(r)),n.visible=t,this.setDirty())}},{key:"setDirty",value:function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((function(e){return JL(e)}))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;var e=this._labelingContexts.length>0?this._labelingContexts.reduce((function(e,t){return e+(JL(t)?0:1)}),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){var e=this;return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:function(){return e._resetAllLabels()}}}}]),r}(Eu.m);function JL(e){return e.labelClassPromise&&!!e.labelClassAbortController}function $L(e){return e.labelClassContexts&&e.labelClassContexts.length}(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],KL.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],KL.prototype,"deconflictor",void 0),(0,Eu.e)([(0,Eu.y)()],KL.prototype,"_textTextureAtlas",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],KL.prototype,"updating",null),KL=(0,Eu.e)([(0,Eu.n)("esri.views.3d.layers.graphics.Labeler")],KL);var eZ,tZ=new RS(null,null,null),rZ=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,Au.Z)(this,e),this.lij=[0,0,0],this.extent=(0,ju.u)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:eZ.VISIBLE_ON_SURFACE,screenRect:(0,ju.u)(),distance:0,shouldSplit:!1},this.used=!1,i&&this.acquire(t,r,n,i)}return(0,ku.Z)(e,[{key:"acquire",value:function(t,r,n,i){this.tilingScheme=i,this.id=e.id(t,r,n),this.lij[0]=t,this.lij[1]=r,this.lij[2]=n,i.getExtent(t,r,n,this.extent),this.resolution=i.resolutionAtLevel(t)}},{key:"release",value:function(){this.tilingScheme=null}},{key:"getChildren",value:function(t){var r=this.lij[0]+1,n=2*this.lij[1],i=2*this.lij[2];return t?(t[0].acquire(r,n,i,this.tilingScheme),t[1].acquire(r,n+1,i,this.tilingScheme),t[2].acquire(r,n,i+1,this.tilingScheme),t[3].acquire(r,n+1,i+1,this.tilingScheme),t):[new e(r,n,i,this.tilingScheme),new e(r,n+1,i,this.tilingScheme),new e(r,n,i+1,this.tilingScheme),new e(r,n+1,i+1,this.tilingScheme)]}},{key:"copyMeasurementsFrom",value:function(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,ju.a)(e.measures.screenRect,this.measures.screenRect)}}],[{key:"id",value:function(e,t,r){return"".concat(e,"/").concat(t,"/").concat(r)}}]),e}();!function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",e[e.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"}(eZ||(eZ={}));var nZ=.5*Math.PI,iZ=nZ/Math.PI*180,aZ=function(){function e(t){(0,Au.Z)(this,e),this._renderCoordsHelper=t.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,Vu.n)(),direction:(0,Vu.n)()};for(var r=0;r<4;r++)this._extent[r]={origin:(0,Vu.n)(),direction:(0,Vu.n)(),cap:{next:null,direction:(0,Vu.n)()}},this._planes[r]=(0,Tc.p)();this._planes[kc.U.NEAR]=(0,Tc.p)(),this._planes[kc.U.FAR]=(0,Tc.p)(),this._planesWithoutFar=this._planes.slice(0,5)}return(0,ku.Z)(e,[{key:"update",value:function(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=this._extent;this._toRenderBoundingExtent(e,t,r),(0,Vu.u)(this._center.origin,i[0].origin,i[2].origin),(0,Vu.g)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),n||(0,Vu.g)(this._center.direction,this._center.direction,-1);for(var a=0;a<4;a++){var o=i[a];this._renderCoordsHelper.worldUpAtPosition(o.origin,o.direction);var s=i[3===a?0:a+1];o.cap.next=s.origin,(0,Vu.H)(o.cap.direction,o.origin,s.origin),(0,Tc.O)(o.direction,o.cap.direction,o.origin,this._planes[a]),n||(0,Vu.g)(o.direction,o.direction,-1)}(0,Tc.O)(i[0].cap.direction,i[1].cap.direction,i[0].origin,this._planes[kc.U.NEAR]),n?(0,Tc.P)(this._planes[kc.U.NEAR],this._planes[kc.U.FAR]):((0,Tc.A)(this._planes[kc.U.FAR],this._planes[kc.U.NEAR]),(0,Tc.P)(this._planes[kc.U.NEAR],this._planes[kc.U.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*(0,Xu.u)(this._maxSpanSpatialReference).radius}},{key:"isVisibleInFrustum",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===ic.l.Global){var n=this._maxSpanSpatialReference.isGeographic?iZ:nZ*t;if(this._maxSpan>n)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){var i=this._extent[0];return!(r||!e.intersectsRay((0,Qu.p)(i.origin,i.direction)))}for(var a=0;a<this._extent.length;a++){var o=this._extent[a];if(!r&&e.intersectsRay((0,Qu.p)(o.origin,o.direction)))return!0;if(e.intersectsLineSegment((0,Sc.b)(o.origin,o.cap.next,dZ),o.cap.direction))return!0}for(var s=r?this._planes:this._planesWithoutFar,l=0;l<e.lines.length;l++){var u=e.lines[l];if(vm(s,u.origin,u.endpoint,u.direction))return!0}return!1}},{key:"_toRenderBoundingExtentGlobal",value:function(e,t,r){(0,ju.p)(e,sZ),sZ[2]=r,(0,Hu.Z)(t,sZ,lZ,this._renderCoordsHelper.spatialReference),(0,Wu.h)(uZ,lZ),(0,Gc.A)(cZ);var n,i=(0,Cu.Z)(oZ);try{for(i.s();!(n=i.n()).done;)for(var a=n.value,o=a.x0,s=a.x1,l=a.y0,u=a.y1,c=0;c<5;c++){var h=c/4;sZ[0]=(0,Vu.Z)(e[o],e[s],h),sZ[1]=(0,Vu.Z)(e[l],e[u],h),sZ[2]=r,(0,Hu.j)(sZ,t,sZ,this._renderCoordsHelper.spatialReference),(0,Vu.O)(sZ,sZ,uZ),(0,Gc.c)(cZ,sZ)}}catch(f){i.e(f)}finally{i.f()}(0,Vu.o)(this._extent[0].origin,cZ[0],cZ[1],cZ[2]),(0,Vu.o)(this._extent[1].origin,cZ[3],cZ[1],cZ[2]),(0,Vu.o)(this._extent[2].origin,cZ[3],cZ[4],cZ[2]),(0,Vu.o)(this._extent[3].origin,cZ[0],cZ[4],cZ[2]);for(var d=0;d<4;++d)(0,Vu.O)(this._extent[d].origin,this._extent[d].origin,lZ)}},{key:"_toRenderBoundingExtentLocal",value:function(e,t,r){(0,Hu.v)(e,t,hZ,this._renderCoordsHelper.spatialReference),(0,Vu.o)(this._extent[0].origin,hZ[0],hZ[1],r),(0,Vu.o)(this._extent[1].origin,hZ[2],hZ[1],r),(0,Vu.o)(this._extent[2].origin,hZ[2],hZ[3],r),(0,Vu.o)(this._extent[3].origin,hZ[0],hZ[3],r)}},{key:"_toRenderBoundingExtent",value:function(e,t,r){switch(this._renderCoordsHelper.viewingMode){case ic.l.Global:this._toRenderBoundingExtentGlobal(e,t,r);break;case ic.l.Local:this._toRenderBoundingExtentLocal(e,t,r)}}},{key:"_isVisibleInFrustumGlobal",value:function(e){if((0,Tc.R)(e.planes[kc.U.NEAR],this._center.origin)<0&&(0,Vu.P)(this._center.direction,e.direction)<0)return!0;for(var t=0;t<4;t++){var r=this._extent[t];if((0,Tc.R)(e.planes[kc.U.NEAR],r.origin)<0&&(0,Vu.P)(r.direction,e.direction)<0)return!0}return!1}}]),e}(),oZ=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],sZ=(0,Vu.n)(),lZ=(0,hc.e)(),uZ=(0,hc.e)(),cZ=(0,Gc.a)(),hZ=(0,ju.u)(),dZ=(0,Sc.v)(),fZ=function(){function e(t){(0,Au.Z)(this,e),this._renderCoordsHelper=t,this._surfaceElevation=0,this._cache=new Map,this._frustum=new vb(t),this._extendedFrustum=new vb(t),this._intersector=new aZ({renderCoordsHelper:t}),this._renderCoordsHelper=t}return(0,ku.Z)(e,[{key:"begin",value:function(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}},{key:"end",value:function(){this._cache.clear()}},{key:"calculate",value:function(e){if(this._allTilesInvisible)return eZ.INVISIBLE;var t=this._renderCoordsHelper.viewingMode===ic.l.Global&&e.lij[0]>=pZ&&e.lij[0]<vZ,r=this._getOrCalculateSingleTileVisibility(e,!t);return r!==eZ.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):r}},{key:"_shortenFrustumFarPlane",value:function(e){var t,r=vb.nearFarLineIndices,n=e.mutablePoints,i=(0,Cu.Z)(r);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=(0,xu.Z)(a,2),s=o[0],l=o[1],u=n[s],c=n[l];(0,Vu.e)(_Z,c,u),(0,Vu.g)(_Z,_Z,yZ),(0,Vu.u)(n[l],u,_Z)}}catch(h){i.e(h)}finally{i.f()}e.updatePoints(n)}},{key:"_calculateAggregatedChildrenVisibility",value:function(e){var t=eZ.INVISIBLE,r=this._cache.get(e.id);if(null!=r)return r;var n=wZ.acquire();e.getChildren(n);var i,a=(0,Cu.Z)(n);try{for(a.s();!(i=a.n()).done;){var o=i.value,s=this.calculate(o);if(s!==eZ.INVISIBLE&&(t=s,s===eZ.VISIBLE_ON_SURFACE))break}}catch(l){a.e(l)}finally{a.f()}return wZ.release(n),this._cache.set(e.id,t),t}},{key:"_getOrCalculateSingleTileVisibility",value:function(e,t){var r=this._cache.get(e.id);if(null!=r)return r;var n=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,n),n}},{key:"_calculateSingleTileVisibility",value:function(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===ic.l.Global&&e.lij[0]<mZ?this._calculateSingleTileVisibilitySided(e,!1)===eZ.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}},{key:"_calculateSingleTileVisibilitySided",value:function(e,t){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);var r=(0,Xu.u)(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,r)?this._intersector.isVisibleInFrustum(this._frustum,r,!0)?eZ.VISIBLE_ON_SURFACE:eZ.VISIBLE_WHEN_EXTENDED:eZ.INVISIBLE}},{key:"_updateExtendedFrustum",value:function(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);var t=this._renderCoordsHelper.worldUpAtPosition(e.eye,_Z);this._aboveGround||(0,Vu.q)(t,t);var r=(0,Vu.i)(-(0,Vu.P)(t,e.viewForward));if(this._allTilesInvisible=r>(Math.PI+e.fovY)/2,!this._allTilesInvisible&&(this._hasExtendedFrustum=r>e.fovY/2,this._hasExtendedFrustum)){for(var n=this._extendedFrustumParameters(),i=this._extendedFrustum.mutablePoints,a=0;a<4;a++){var o=n.pointIndices[a],s=i[o],l=this._renderCoordsHelper.getAltitude(s);if(n.needsAltitudeAdjustment(l)){switch(this._renderCoordsHelper.worldUpAtPosition(s,_Z),o){case kc.l.FAR_BOTTOM_LEFT:case kc.l.FAR_TOP_LEFT:case kc.l.NEAR_BOTTOM_LEFT:case kc.l.NEAR_TOP_LEFT:(0,Tc.K)(this._extendedFrustum.planes[kc.U.LEFT],_Z,_Z);break;case kc.l.FAR_BOTTOM_RIGHT:case kc.l.FAR_TOP_RIGHT:case kc.l.NEAR_BOTTOM_RIGHT:case kc.l.NEAR_TOP_RIGHT:(0,Tc.K)(this._extendedFrustum.planes[kc.U.RIGHT],_Z,_Z)}(0,Vu.g)(_Z,_Z,n.direction),this._renderCoordsHelper.intersectInfiniteManifold((0,Qu.p)(s,_Z),n.zWithMargin,s)}}if(this._extendedFrustum.updatePoints(i),(0,Tc.j)(i[kc.l.NEAR_BOTTOM_LEFT],i[kc.l.NEAR_BOTTOM_RIGHT],i[kc.l.NEAR_TOP_RIGHT],bZ),(0,Tc.j)(i[kc.l.NEAR_BOTTOM_RIGHT],i[kc.l.NEAR_TOP_RIGHT],i[kc.l.NEAR_TOP_LEFT],xZ),(0,Vu.P)((0,Tc.Y)(bZ),(0,Tc.Y)(xZ))<0){var u,c,h=this._extendedFrustum.mutablePoints;this._aboveGround?(u=[h[kc.l.NEAR_BOTTOM_RIGHT],h[kc.l.NEAR_BOTTOM_LEFT]],h[kc.l.NEAR_BOTTOM_LEFT]=u[0],h[kc.l.NEAR_BOTTOM_RIGHT]=u[1]):(c=[h[kc.l.NEAR_TOP_RIGHT],h[kc.l.NEAR_TOP_LEFT]],h[kc.l.NEAR_TOP_LEFT]=c[0],h[kc.l.NEAR_TOP_RIGHT]=c[1]),this._extendedFrustum.updatePoints(h)}}}},{key:"_extendedFrustumParameters",value:function(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}},{key:"_extendedFrustumParametersAboveSurface",value:function(){var e=this._surfaceElevation-gZ;return{zWithMargin:e,pointIndices:vb.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:function(t){return t>e}}}},{key:"_extendedFrustumParametersBelowSurface",value:function(){var e=this._surfaceElevation+gZ;return{zWithMargin:e,pointIndices:vb.planePointIndices.top,direction:1,needsAltitudeAdjustment:function(t){return t<e}}}}]),e}(),pZ=2,vZ=6,mZ=12,yZ=.95,gZ=1,_Z=(0,Vu.n)(),bZ=(0,Tc.p)(),xZ=(0,Tc.p)(),wZ=new Eu.h(Array,(function(e){4!==e.length&&(e[0]=new rZ,e[1]=new rZ,e[2]=new rZ,e[3]=new rZ)}),(function(e){e[0].release(),e[1].release(),e[2].release(),e[3].release()})),TZ=function(){function e(t){(0,Au.Z)(this,e),this._camera=new Jy,this._focusOnMap=[0,0],this._screenRect=(0,ju.u)(),this._tileSize=t.tileSize,this._renderCoordsHelper=t.renderCoordsHelper,this._tilingScheme=t.tilingScheme,this._visibility=new fZ(t.renderCoordsHelper)}return(0,ku.Z)(e,[{key:"begin",value:function(e,t,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,(0,ju.o)(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,r)}},{key:"end",value:function(){this._visibility.end()}},{key:"updateTile",value:function(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=(0,ju.d)(e.extent,this._focusOnMap),e.measures.visibility!==eZ.INVISIBLE&&this._updateScreenMeasure(e)}},{key:"_updateScreenMeasure",value:function(e){var t=SZ,r=1<<t,n=e.measures.screenRect;(0,ju.D)(n);for(var i=0,a=e.lij[0]+t,o=e.lij[1]<<t,s=e.lij[2]<<t,l=this._tileSizeWithBias(e),u=l*l,c=0;c<r;c++)for(var h=0;h<r;h++)if((i+=this._computeScreenArea(e,a,o+c,s+h,n))>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}},{key:"_tileSizeWithBias",value:function(e){return e.measures.visibility===eZ.VISIBLE_WHEN_EXTENDED?this._tileSize*OZ:this._tileSize}},{key:"_computeScreenArea",value:function(e,t,r,n,i){var a=e.measures.visibility===eZ.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,r,n,a,PZ),(0,ju.D)(CZ);for(var o=0;o<4;o++)(0,ju.m)(CZ,PZ[o]);return(0,ju.h)(i,CZ,i),(0,dc.b9)(PZ[0],PZ[1],PZ[2])+(0,dc.b9)(PZ[0],PZ[2],PZ[3])}},{key:"_projectToScreen",value:function(e,t,r,n,i){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,r,RZ),this._toRenderCoords(RZ,0,3,kZ[0]),this._toRenderCoords(RZ,2,3,kZ[1]),this._toRenderCoords(RZ,2,1,kZ[2]),this._toRenderCoords(RZ,0,1,kZ[3]),n&&(this._projectToPlane(kZ,this._camera.frustum[kc.U.NEAR]),this._projectToPlane(kZ,this._camera.frustum[kc.U.TOP]),this._projectToPlane(kZ,this._camera.frustum[kc.U.BOTTOM]));for(var a=0;a<4;a++)this._camera.projectToRenderScreen(kZ[a],DZ),this._camera.renderToScreen(DZ,i[a])}},{key:"_projectToPlane",value:function(e,t){for(var r=0;r<4;r++)EZ[r]=(0,Tc.R)(t,e[r]);var n=Math.max(EZ[0],EZ[1],EZ[2],EZ[3]);if(n>0)for(var i=(0,Vu.g)(AZ,(0,Tc.Y)(t),-n),a=0;a<4;a++)(0,Vu.u)(e[a],e[a],i)}},{key:"_toRenderCoords",value:function(e,t,r,n){return AZ[0]=e[t],AZ[1]=e[r],AZ[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(AZ,this._tilingScheme.spatialReference,n),n}}]),e}(),CZ=(0,ju.u)(),SZ=2,OZ=5,PZ=[(0,zu.i)(),(0,zu.i)(),(0,zu.i)(),(0,zu.i)()],RZ=(0,ju.u)(),AZ=(0,Vu.n)(),kZ=[(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)(),(0,Vu.n)()],EZ=[0,0,0,0],DZ=(0,zu.x)();function MZ(e,t,r){if((0,Nu.t)(e)||(0,Nu.t)(r))return!1;var n=!0;return LZ[0]=null!=e.xmin?e.xmin:0,LZ[1]=null!=e.ymin?e.ymin:0,LZ[2]=null!=e.zmin?e.zmin:0,n=n&&(0,Hu.x)(LZ,e.spatialReference,0,t,r,0,1),LZ[0]=null!=e.xmax?e.xmax:0,LZ[1]=null!=e.ymax?e.ymax:0,LZ[2]=null!=e.zmax?e.zmax:0,n=n&&(0,Hu.x)(LZ,e.spatialReference,0,t,r,3,1),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),n}function IZ(e,t,r){if((0,Nu.t)(e)||(0,Nu.t)(r))return!1;var n=!0;return LZ[0]=null!=e.xmin?e.xmin:0,LZ[1]=null!=e.ymin?e.ymin:0,LZ[2]=null!=e.zmin?e.zmin:0,n=n&&(0,Hu.x)(LZ,e.spatialReference,0,LZ,r,0,1),t[0]=LZ[0],t[1]=LZ[1],LZ[0]=null!=e.xmax?e.xmax:0,LZ[1]=null!=e.ymax?e.ymax:0,LZ[2]=null!=e.zmax?e.zmax:0,n=n&&(0,Hu.x)(LZ,e.spatialReference,0,LZ,r,0,1),t[2]=LZ[0],t[3]=LZ[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),n}var LZ=(0,Vu.n)(),ZZ=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).tiles=new Lu.j,n.tileSize=512,n._idToTile=new Map,n._handles=new Eu.X,n._clients=new Set,n._dirty=!1,n._newTiles=new Eu.a6,n}return(0,ku.Z)(r,[{key:"tilingScheme",get:function(){var e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}},{key:"filterExtent",set:function(e){if(!(0,Nu.r)(e)||e.spatialReference.equals(this.viewState.spatialReference)){var t=this._get("filterExtent");if(!(t===e||(0,Nu.r)(t)&&e&&t.equals(e))){var r=(0,Nu.r)(e)?e.clone():null;this._set("filterExtent",r),this._setDirty()}}else Eu.a.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view")}},{key:"_filterExtentRect",get:function(){if((0,Nu.t)(this.filterExtent)||!this.tilingScheme)return null;var e=(0,ju.u)();return IZ(this.filterExtent,e,this.tilingScheme.spatialReference),e}},{key:"_rootTileIds",get:function(){return this._filterExtentRect?this.tilingScheme.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}},{key:"suspended",set:function(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"initialize",value:function(){var e=this;this._handles.add([(0,Fu.l)((function(){return[e.tilingScheme,e.tileSize]}),(function(){return e._reset()}),Fu.U),(0,Fu.l)((function(){var t,r,n;return[e.tileSize,null===(t=e.cameraOnSurface)||void 0===t?void 0:t.location,e.tilingScheme,null===(r=e.viewState)||void 0===r?void 0:r.contentCamera,null===(n=e.focus)||void 0===n?void 0:n.location]}),(function(){return e._setDirty()}),Fu.w)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(bc.I.FEATURE_TILE_TREE,this))}},{key:"destroy",value:function(){this._frameWorker=(0,Nu.f)(this._frameWorker),this._handles=(0,Nu.g)(this._handles)}},{key:"addClient",value:function(){var e=this,t=NZ++;return this._clients.add(t),1===this._clients.size&&this._setDirty(),{remove:function(){return e._removeClient(t)}}}},{key:"_removeClient",value:function(e){this._clients.delete(e),this._hasClients||this._clear()}},{key:"_hasClients",get:function(){return this._clients.size>0}},{key:"_setDirty",value:function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(bc.F))}},{key:"_clear",value:function(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),(0,Nu.r)(this._frameWorker)&&(this._frameWorker.priority=bc.I.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&(0,Nu.r)(this._frameWorker)&&(this._frameWorker.priority=bc.I.FEATURE_TILE_TREE),this.notifyChange("updating")}},{key:"_startUpdate",value:function(){if(!this.suspended)if(this.tilingScheme){this._tileMeasurements||(this._tileMeasurements=new TZ({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));var e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}else this._clear()}},{key:"_reset",value:function(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}},{key:"_getRootTiles",value:function(){var e=this;return this._rootTileIds.map((function(t){return new rZ(t[0],t[1],t[2],e.tilingScheme)}))}},{key:"_purgeHorizonTiles",value:function(e){e.sort((function(e,t){var r=e.measures.screenRect,n=t.measures.screenRect;return r[1]+r[3]-(n[1]+n[3])})),(0,ju.D)(FZ);for(var t=0;t<e.length;t++)if((0,ju.h)(FZ,e.data[t].measures.screenRect,FZ),(0,ju.l)(FZ)>zZ)return e.data.slice(t,e.length);return[]}},{key:"_subdivideTilesForView",value:function(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){var t,r=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!(0,ju.E)(this._filterExtentRect,r.extent)||(this._tileMeasurements.updateTile(r),r.measures.visibility!==eZ.INVISIBLE&&(r.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(r.lij[0]+1),(t=this._pendingTiles).push.apply(t,(0,mu.Z)(r.getChildren()))):this._newTiles.push(r)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}},{key:"_updateTiles",value:function(e){var t,r=this,n=(0,Cu.Z)(this.tiles.items);try{for(n.s();!(t=n.n()).done;){t.value.used=!1}}catch(o){n.e(o)}finally{n.f()}var i=e.filter((function(e){var t=r._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):r._idToTile.set(e.id,e),!t})),a=this.tiles.items.filter((function(e){return!e.used&&(r._idToTile.delete(e.id),!0)}));this.tiles.removeMany(a),this.tiles.addMany(i),this._sortTiles()}},{key:"_sortTiles",value:function(){this.viewState.fixedContentCamera||this.tiles.sort((function(e,t){return e.measures.visibility!==t.measures.visibility?e.measures.visibility===eZ.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance})),this.tiles.forEach((function(e,t){return e.loadPriority=t}))}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"scheduler",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"renderCoordsHelper",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"tilingSchemeOwner",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"cameraOnSurface",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"focus",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"viewState",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ZZ.prototype,"terrain",void 0),(0,Eu.e)([(0,Eu.y)()],ZZ.prototype,"tiles",void 0),(0,Eu.e)([(0,Eu.y)()],ZZ.prototype,"tileSize",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],ZZ.prototype,"tilingScheme",null),(0,Eu.e)([(0,Eu.y)()],ZZ.prototype,"filterExtent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],ZZ.prototype,"_filterExtentRect",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],ZZ.prototype,"_rootTileIds",null),(0,Eu.e)([(0,Eu.y)({value:!1})],ZZ.prototype,"suspended",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],ZZ.prototype,"updating",null),ZZ=(0,Eu.e)([(0,Eu.n)("esri.views.3d.layers.support.FeatureTileTree3D")],ZZ);var NZ=0;var FZ=(0,ju.u)(),zZ=10,UZ=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._propertiesPool=new Ju.M({camera:Jy},(0,gu.Z)(e)),e._lastSeenCameraProjectionValues=new Jy,e.events=new ec.n,e.viewingMode=ic.l.Global,e._cameraChanged=!1,e._updateQueue=new Array,e._processingUpdates=!1,e}return(0,ku.Z)(r,[{key:"init",value:function(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new id({mode:this.viewingMode}))}},{key:"exit",value:function(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Ju.M({camera:Jy},this)}},{key:"createInitialCamera",value:function(){if(this.viewingMode===ic.l.Global){var e=(0,Xu.u)(this.spatialReference).radius;this.camera=new Jy((0,Vu.c)(4*e,0,0),(0,Vu.c)(e,0,0),(0,Vu.c)(0,0,1))}else this.camera=new Jy((0,Vu.c)(0,0,100),(0,Vu.c)(0,0,0),(0,Vu.c)(0,1,0))}},{key:"animation",get:function(){return this.cameraController instanceof kg&&(0,Nu.r)(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}},{key:"camera",get:function(){return this._get("camera")},set:function(e){var t=this;e!==GZ&&GZ.copyFrom(e),GZ.computeUp(this.viewingMode),HZ.camera=GZ,this.events.emit("before-camera-change",HZ);var r=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,GZ)&&(this._lastSeenCameraProjectionValues.copyFrom(GZ),jZ.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",jZ)),(!r||!r.equals(GZ))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(GZ)),this._cameraChanged=!r||!r.almostEquals(GZ),this._cameraChanged))var n=(0,Eu.ad)((function(){t._cameraChanged=!1,n.remove()}))}},{key:"pixelRatio",get:function(){return this.camera.pixelRatio}},{key:"contentCamera",get:function(){return(0,Nu.r)(this._contentCamera)?this._contentCamera:this.camera},set:function(e){this._contentCamera=(0,Nu.r)(e)?e.clone():null}},{key:"fixedContentCamera",get:function(){return(0,Nu.r)(this._contentCamera)}},{key:"isGlobal",get:function(){return this.viewingMode===ic.l.Global}},{key:"isLocal",get:function(){return this.viewingMode===ic.l.Local}},{key:"navigating",get:function(){return!(!this.cameraController||!this.cameraController.isInteractive)}},{key:"stationary",get:function(){return!this._cameraChanged&&!this.navigating}},{key:"cameraController",get:function(){return this._get("cameraController")},set:function(e){var t=this;this.stopActiveCameraController()?(e&&(this.addHandles((0,Fu.f)((function(){return e.state===Tg.Finished||e.state===Tg.Stopped}),(function(){t._set("cameraController",null),t.updateCamera((function(t){return e.onControllerEnd(t)}))}),{sync:!0,once:!0})),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Tg.Rejected)}},{key:"switchCameraController",value:function(e){return this.cameraController=e,e.state!==Tg.Rejected}},{key:"stopActiveCameraController",value:function(){return!(this.cameraController&&!this.cameraController.stopController())}},{key:"updateCamera",value:function(e){this._updateQueue.push(e),this._processUpdateQueue()}},{key:"_processUpdateQueue",value:function(){if(0!==this._updateQueue.length&&!this._processingUpdates){this._processingUpdates=!0;var e=this._updateQueue.shift();GZ.copyFrom(this._get("camera")),e(GZ),this.camera=GZ,this._processingUpdates=!1,this._processUpdateQueue()}}},{key:"_cameraProjectionChanged",value:function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[zy.TOP]!==t.padding[zy.TOP]||e.padding[zy.RIGHT]!==t.padding[zy.RIGHT]||e.padding[zy.BOTTOM]!==t.padding[zy.BOTTOM]||e.padding[zy.LEFT]!==t.padding[zy.LEFT]}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"mode",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0,type:Ju.p})],UZ.prototype,"animation",null),(0,Eu.e)([(0,Eu.y)({type:Jy})],UZ.prototype,"camera",null),(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"pixelRatio",null),(0,Eu.e)([(0,Eu.y)({})],UZ.prototype,"_contentCamera",void 0),(0,Eu.e)([(0,Eu.y)({type:Jy})],UZ.prototype,"contentCamera",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"fixedContentCamera",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"constraints",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"events",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"isGlobal",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"isLocal",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"viewingMode",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UZ.prototype,"spatialReference",void 0),(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"navigating",null),(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"stationary",null),(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"_cameraChanged",void 0),(0,Eu.e)([(0,Eu.y)()],UZ.prototype,"cameraController",null);var VZ,BZ=UZ=(0,Eu.e)([(0,Eu.n)("esri.views.3d.state.ViewState")],UZ),GZ=new Jy,HZ={camera:null},jZ={camera:null},qZ=function(){function e(t,r,n){(0,Au.Z)(this,e),this.viewingMode=t,this._forEachLayer=r,this._view=n,this._externalIntersectionHandlers=new Eu.a6,this._tolerance=qu.O,this._tmpRay=(0,Qu.d)(),this._tmpRegion=(0,ju.u)(),this._validateHUDIntersector=(0,qu.g)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}return(0,ku.Z)(e,[{key:"intersectScreen",value:function(e,t,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),QZ(this.viewingMode),t,r)}},{key:"intersectScreenFreePointFallback",value:function(e,t,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,r)}},{key:"intersectRayFreePointFallback",value:function(e,t,r){return this.intersectRay(e,QZ(this.viewingMode),t,r)||this._intersectRayFreePointLocal(e,t)}},{key:"intersectRay",value:function(e,t,r,n){return t.options.selectionMode=!1,t.options.store=qu.J.MIN,this.computeIntersection(e,t,n),!!t.results.min&&t.results.min.getIntersectionPoint(r)}},{key:"getCenterRayWithSubpixelOffset",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(eN,r,n),eN[0]+=.0466,eN[1]-=.0123,Vg(e,eN,t)}},{key:"intersectIntersectorScreen",value:function(e,t,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,r)}},{key:"intersectToolIntersectorScreen",value:function(e,t,r){var n=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(n,t,r)}},{key:"intersectToolIntersectorRay",value:function(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);var n=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,qu.P)(n)&&n.intersector!==qu.M.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,r))}},{key:"setTolerance",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:qu.O;this._tolerance=e}},{key:"addIntersectionHandler",value:function(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((function(e,t){return e.type===qu.M.TERRAIN?1:t.type===qu.M.TERRAIN?-1:0}))}},{key:"removeIntersectionHandler",value:function(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort((function(e,t){return e.type===qu.M.TERRAIN?1:t.type===qu.M.TERRAIN?-1:0}))}},{key:"_getPickRay",value:function(e,t){return Fg(this._view.state.camera,e,t)}},{key:"_intersectRayFreePointLocal",value:function(e,t){if(this.viewingMode!==ic.l.Local||(0,Nu.t)(e))return!1;var r=this._view.renderDataExtent;if((0,Nu.t)(r))return(0,Vu.u)(t,e.origin,(0,Vu.z)(Qu.c.get(),e.direction)),!0;var n={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},i=Math.max(n.x,n.y,n.z);if(0===i)return(0,Vu.u)(t,e.origin,(0,Vu.z)(Qu.c.get(),e.direction)),!0;var a=this._view.state.camera,o=Math.max(0,r.xmin-a.eye[0],a.eye[0]-r.xmax),s=Math.max(0,r.ymin-a.eye[1],a.eye[1]-r.ymax),l=Math.sqrt(o*o+s*s),u=Math.abs(a.relativeElevation)+Number.MIN_VALUE,c=Math.pow(Math.max(0,Math.log(i/u)),2),h=i/Math.max(1,c);h=Math.max(h,Math.min(l,i));var d=(0,Vu.s)(e.direction),f=(0,Vu.g)(Qu.c.get(),e.direction,0===d?h:h/d);return(0,Vu.u)(t,e.origin,f),!0}},{key:"intersectElevationFromScreen",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,r,n)}},{key:"_intersectElevation",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if((0,Nu.t)(e))return null;var i=(0,Nu.r)(t)?t.mode:"absolute-height",a=(0,Nu.r)(t)?(0,Nu.v)(t.offset,0):0,o="on-the-ground"!==i?a+r:0,s=o/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===i){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,o,$Z)){var l=this._view.computeMapPointFromVec3d($Z);return l.z-=a,l}return null}var u=this._view.state.camera,c=(0,zu.p)(Qu.c.get());u.projectToRenderScreen(e.origin,c);var h=new KZ(null,this._forEachLayer),d=this._view.slicePlane,f=(0,Nu.r)(d)?(0,qu.S)(d):null,p=(0,qu.g)(this.viewingMode);p.options.store=qu.J.MIN,p.options.verticalOffset=s;var v=e.origin,m=(0,Vu.u)(Qu.c.get(),v,e.direction);p.reset(v,m,u),p.point=c;var y=(0,Nu.r)(n)?"type"in n&&"graphics"===n.type?function(e){return e.metadata.layerUid!==n.uid}:function(e){return e.metadata.graphicUid!==n.uid}:null;switch(i){case"relative-to-scene":var g=function(e){return((0,Nu.t)(y)||y(e))&&e.metadata&&e.metadata.isElevationSource};p.intersect(h.layers,c,this._tolerance,null,g),this._externalIntersectionHandlers.forAll((function(e){if(e.type===qu.M.I3S||e.type===qu.M.TERRAIN){var t=e.slicePlaneEnabled?f:null;e.intersect(p,t,p.rayBegin,p.rayEnd,c)}}));break;case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((function(e){if(e.isGround){var t=e.slicePlaneEnabled?f:null;e.intersect(p,t,p.rayBegin,p.rayEnd,c)}}))}if(p.results.min.getIntersectionPoint($Z)){var _=this._view.computeMapPointFromVec3d($Z);return _.z=r,_}return null}},{key:"computeIntersection",value:function(e,t,r){if(!(0,Nu.t)(e)){var n=this._view.state.camera,i=(0,zu.p)(Qu.c.get());n.projectToRenderScreen(e.origin,i);var a=new KZ(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);var o=e.origin,s=(0,Vu.u)(Qu.c.get(),e.origin,e.direction);t.reset(o,s,n),t.intersect(a.layers,i,this._tolerance);var l=this._view.slicePlane,u=(0,Nu.r)(l)?(0,qu.S)(l):null;t.intersect(a.sliceableLayers,i,this._tolerance,u);var c=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll((function(e){if(t.options.isFiltered=!a.filterLayerUid(e.layerUid),e.isGround&&c||!t.options.isFiltered){var r=e.slicePlaneEnabled?u:null;e.intersect(t,r,o,s,i)}}));var h=Qu.c.get(),d=this._view.basemapTerrain;if(r&&r.enableDraped&&(0,Nu.r)(d.spatialReference)&&t.results.ground.getIntersectionPoint(h)){var f=d.overlayManager.renderer,p=this._view.renderCoordsHelper.spatialReference,v=Qu.c.get();this._view.renderCoordsHelper.fromRenderCoords(h,v,d.spatialReference),v[2]=(0,Nu.v)(this._view.elevationProvider.getElevation(h[0],h[1],h[2],p,"ground"),0),f.intersect(t,v,t.results.ground,(function(e){return a.filterRenderGeometry(e)}))}t.sortResults(),this._processHUDResults(t)}}},{key:"_processHUDResults",value:function(e){var t=e.results.hud;(0,ju.a)(this._tmpRegion,ju.K);var r=this._view.state.camera,n=[],i=this._tmpRegion,a=function(e){var t=new YZ(e);r.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),n.push(t),(0,ju.m)(i,t.screenPoint)};e.sortResults(t.all),(0,Nu.r)(t.min.dist)&&a(t.min);var o,s=(0,Cu.Z)(t.all);try{for(s.s();!(o=s.n()).done;){var l=o.value;t.min.target.object!==l.target.object&&t.max.target.object!==l.target.object&&a(l)}}catch(S){s.e(S)}finally{s.f()}if((0,Nu.r)(t.max.dist)&&t.max.target.object!==t.min.target.object&&a(t.max),n.length){i[0]===i[2]&&(i[2]+=1),i[1]===i[3]&&(i[3]+=1);var u=r.fullWidth,c=r.fullHeight,h=Math.max(0,i[0]-WZ),d=Math.max(0,i[1]-WZ),f=Math.min((0,ju.s)(i)+2*WZ,u-h),p=Math.min((0,ju.l)(i)+2*WZ,c-d),v=new Uint8Array(f*p*4);this._view._stage.renderView.readHUDVisibility(h,d,f,p,v);for(var m=!0,y=(0,Nu.t)(e.results.max.dist),g=0,_=0,b=n;_<b.length;_++){var x,w=b[_],T=(0,Cu.Z)(XZ);try{for(T.s();!(x=T.n()).done;){var C=x.value;if(v[4*(Math.min(w.screenPoint[0]+C[0],u)-i[0]+(Math.min(w.screenPoint[1]+C[1],c)-i[1])*f)]){m&&(e.results.min.copy(w.result),m=!1),y&&e.results.max.copy(w.result),e.options.store===qu.J.ALL&&e.results.all.splice(g++,0,w.result);break}}}catch(S){T.e(S)}finally{T.f()}}}}}]),e}(),WZ=1,XZ=function(){for(var e=[],t=WZ,r=-t;r<=t;r++)for(var n=-t;n<=t;n++)e.push([n+t,r+t]);return e}(),YZ=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.result=t,this.screenPoint=(0,zu.x)()}));function QZ(e){return VZ&&VZ.viewingMode===e||(VZ=(0,qu.g)(e)),VZ}var KZ=function(){function e(t,r){var n=this;(0,Au.Z)(this,e),this.layers=new Array,this.sliceableLayers=new Array,this.include=null===t||void 0===t?void 0:t.include,this.exclude=null===t||void 0===t?void 0:t.exclude,r((function(e){e.isPickable&&n.filterLayerUid(e.apiLayerUid)&&(e.isSliceable?n.sliceableLayers:n.layers).push(e)}))}return(0,ku.Z)(e,[{key:"filterLayerUid",value:function(e){var t=this.include,r=this.exclude;return(0,Nu.t)(e)?null==t&&null==r:(null==t||t.has(e))&&(null==r||!r.has(e))}},{key:"filterRenderGeometry",value:function(e){return this.filterLayerUid(e.layerUid)}}]),e}();function JZ(e){return"object"==typeof e&&"intersect"in e}var $Z=(0,Vu.n)(),eN=(0,zu.x)(),tN=function(){function e(t,r){(0,Au.Z)(this,e),this.spatialReference=t,this._view=r}return(0,ku.Z)(e,[{key:"getElevation",value:function(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}},{key:"queryElevation",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._view.elevationProvider.queryElevation(t,r,0,this.spatialReference,a,n,i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()}]),e}(),rN=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this.spatialReference=r,this._getElevationQueryProvider=n,this._queries=new Array,this._queryOptions=(0,Tu.Z)((0,Tu.Z)({},i),{},{ignoreInvisibleLayers:!0}),this._frameTask=t.registerTask(bc.I.ELEVATION_QUERY,this)}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._frameTask.remove()}},{key:"queryElevation",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new Promise((function(a,o){var s={x:e,y:t,minDemResolution:i,result:{resolve:a,reject:o},signal:r};n._queries.push(s),(0,Eu.v)(r,(function(){(0,Nu.C)(n._queries,s),o((0,Eu.d)())}))}))}},{key:"running",get:function(){return this._queries.length>0}},{key:"runTask",value:function(){var e=this._queries;this._queries=[];var t=this._getElevationQueryProvider();if(t){var r=e.map((function(e){return[e.x,e.y]})),n=e.reduce((function(e,t){return Math.min(e,t.minDemResolution)}),1/0),i=new Mu.u({points:r,spatialReference:this.spatialReference}),a=e.length>1&&e.some((function(e){return!!e.signal}))?new AbortController:null,o=(0,Nu.r)(a)?a.signal:e[0].signal;if((0,Nu.r)(a)){var s=0;e.forEach((function(t){return(0,Eu.v)(t.signal,(function(){s++,t.result.reject((0,Eu.d)()),s===e.length&&a.abort()}))}))}var l=(0,Tu.Z)((0,Tu.Z)({},this._queryOptions),{},{minDemResolution:n,signal:o});t.queryElevation(i,l).then((function(t){e.forEach((function(e,r){(0,Nu.r)(e.signal)&&e.signal.aborted?e.result.reject((0,Eu.d)()):e.result.resolve(t.geometry.points[r][2])}))})).catch((function(t){e.forEach((function(e){return e.result.reject(t)}))}))}else e.forEach((function(e){return e.result.reject()}))}},{key:"test",get:function(){var e=this;return{update:function(){return e._queries.length>0&&e.runTask()}}}}]),e}(),nN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._im=new Array,n._ground=new Array,n._scene=new Array,n._handles=new Map,n.lastElevationQuery=null,n.elevationCacheEnabled=!1,n}return(0,ku.Z)(r,[{key:"spatialReference",get:function(){var e,t;return null===(e=this.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.spatialReference}},{key:"destroy",value:function(){this._elevationQueryCached=(0,Nu.g)(this._elevationQueryCached)}},{key:"_elevationQuery",get:function(){var e=this;return(0,Nu.t)(this._elevationQueryCached)&&(this._elevationQueryCached=new rN(this.view.resourceController.scheduler,this.view.spatialReference,(function(){return e.view.map&&e.view.map.ground}),{maximumAutoTileRequests:4})),this._elevationQueryCached}},{key:"enableElevationCache",value:function(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}},{key:"getElevation",value:function(e,t,r,n,i){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){var a=this.lastElevationQuery;if(e===a.x&&t===a.y&&r===a.z&&(0,Yu.E)(n,a.spatialReference)&&i===a.queryContext)return a.result}var o=null;return o=iN(o,this._im,e,t,r,n,i),(0,Nu.t)(o)&&(o=iN(o,this._ground,e,t,r,n,i)),"scene"===i&&(o=iN(o,this._scene,e,t,r,n,i)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:n,queryContext:i,result:o}),o}},{key:"queryElevation",value:function(e,t,r,n,i){var a=this,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=(0,Eu.ap)();return this._elevationQuery.queryElevation(e,t,o,s).then((function(o){"scene"===i&&(o=iN(o,a._scene,e,t,r,n,i)),l.resolve(o)})).catch((function(o){(0,Eu.j)(o)?l.reject(o):l.resolve(a.getElevation(e,t,r,n,i))})),l.promise}},{key:"register",value:function(e,t){var r=this;this._handles.set(t,t.on("elevation-change",(function(e){return r.emit("elevation-change",e)}))),this._providersFromContext(e).push(t)}},{key:"unregister",value:function(e){this._handles.has(e)&&(this._handles.get(e).remove(),this._handles.delete(e));for(var t=0,r=[this._im,this._ground,this._scene];t<r.length;t++){var n=r[t],i=n.indexOf(e);i>-1&&n.splice(i,1)}}},{key:"_providersFromContext",value:function(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}}]),r}(ec.n.EventedMixin(Eu.m));function iN(e,t,r,n,i,a,o){var s,l=(0,Cu.Z)(t);try{for(l.s();!(s=l.n()).done;){var u=s.value.getElevation(r,n,i,a,o);(0,Nu.r)(u)&&(e=(0,Nu.r)(e)?Math.max(u,e):u)}}catch(c){l.e(c)}finally{l.f()}return e}(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],nN.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],nN.prototype,"spatialReference",null),nN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.CombinedElevationProvider")],nN);var aN=function(){function e(){(0,Au.Z)(this,e)}return(0,ku.Z)(e,null,[{key:"isValidProfile",value:function(t){return t in e.profiles}},{key:"getDefaultProfile",value:function(){return(0,Nu.h)("trident")||(0,Nu.h)("esri-iPhone")?"low":"medium"}},{key:"apply",value:function(t,r){var n=e.profiles[t];r.graphics3D.maxTotalNumberOfFeatures=n.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxTotalNumberOfPrimitives=n.graphics3D.maxTotalNumberOfPrimitives,r.graphics3D.polygonLodFactor=n.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=n.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=n.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=n.graphics3D.skipHighSymbolLods;var i=r.sceneService.object,a=n.sceneService.object;i.lodFactor=a.lodFactor,i.lodCrossfadeinDuration=a.lodCrossfadeinDuration,i.lodCrossfadeoutDuration=a.lodCrossfadeoutDuration,i.lodCrossfadeUncoveredDuration=a.lodCrossfadeUncoveredDuration,r.sceneService.point.lodFactor=n.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=n.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=n.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=n.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=n.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=n.tiledSurface.angledSplitBias,r.tiledSurface.reduceTileLevelDifferences=n.tiledSurface.reduceTileLevelDifferences,r.tiledSurface.textureFadeDuration=n.tiledSurface.textureFadeDuration,r.heatmap.pixelRatio=n.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=n.heatmap.maxTotalNumberOfFeatures,r.weatherFadeDuration=n.weatherFadeDuration,r.antialiasingEnabled=n.antialiasingEnabled,r.physicallyBasedRenderingEnabled=n.physicalBasedRenderingEnabled,r.highQualityTransparency=n.highQualityTransparency,r.memoryLimit=n.memoryLimit,r.additionalCacheMemory=n.additionalCacheMemory,r.frameRate=n.frameRate,r.maximumRenderResolution=n.maximumRenderResolution,r.maximumPixelRatio=n.maximumPixelRatio}}]),e}();function oN(){var e=!!(0,Nu.h)("esri-mobile"),t=!!(0,Nu.h)("ios"),r=(0,Eu.aj)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:(0,Eu.aj)(0),lodCrossfadeoutDuration:(0,Eu.aj)(0),lodCrossfadeUncoveredDuration:(0,Eu.aj)(0)},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:(0,Eu.aj)(0)},weatherFadeDuration:(0,Eu.aj)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:void 0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:(0,Eu.aj)(0),lodCrossfadeoutDuration:(0,Eu.aj)(0),lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,Nu.h)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},weatherFadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:void 0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:(0,Eu.aj)(0),lodCrossfadeoutDuration:(0,Eu.aj)(0),lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,Nu.h)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},weatherFadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?void 0:4096,maximumPixelRatio:e?1:void 0}}}aN.debug={reset:function(){var e=oN();for(var t in e)aN.profiles[t]=e[t]}},function(e){e.profiles=oN()}(aN||(aN={}));var sN=aN,lN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).color=new sc.l([0,255,255]),e.haloColor=null,e.haloOpacity=1,e.fillOpacity=.25,e.shadowOpacity=.4,e.shadowColor=new sc.l([0,0,0]),e.shadowDifference=.2,e}return(0,ku.Z)(r,null,[{key:"toEngineOptions",value:function(e){var t=sc.l.toUnitRGBA(e.color),r=(0,Nu.r)(e.haloColor)?sc.l.toUnitRGBA(e.haloColor):t,n=sc.l.toUnitRGBA(e.shadowColor);return{color:(0,uh.r)(t[0],t[1],t[2],t[3]),haloColor:(0,uh.r)(r[0],r[1],r[2],r[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:(0,lc.r)(n[0],n[1],n[2],n[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:sc.l})],lN.prototype,"color",void 0),(0,Eu.e)([(0,Eu.y)({type:sc.l})],lN.prototype,"haloColor",void 0),(0,Eu.e)([(0,Eu.y)()],lN.prototype,"haloOpacity",void 0),(0,Eu.e)([(0,Eu.y)()],lN.prototype,"fillOpacity",void 0),(0,Eu.e)([(0,Eu.y)()],lN.prototype,"shadowOpacity",void 0),(0,Eu.e)([(0,Eu.y)({type:sc.l})],lN.prototype,"shadowColor",void 0),(0,Eu.e)([(0,Eu.y)()],lN.prototype,"shadowDifference",void 0);var uN=lN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.HighlightOptions")],lN),cN=function(){function e(t,r){(0,Au.Z)(this,e),this.spatialReference=r,this.unitInMeters=(0,Xu.$)(this.spatialReference,(0,Xu.u)(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=(0,ch.getGeometryServiceURL)(t&&t.get("portalItem")).catch((function(){throw new Eu.s("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}return(0,ku.Z)(e,[{key:"toGeographic",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a,o,s,l=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._geometryServiceURLPromise;case 2:return r=e.sent,i=!0,Array.isArray(t[0])&&"number"!=typeof t[0]?n=t:(n=[t],i=!1),a=n.map((function(e){return e instanceof Yu.w?e:new Yu.w(e,l.spatialReference)})),o=new hh.a({geometries:a,outSpatialReference:Yu.k.WGS84}),e.next=9,(0,hh.n)(r,o);case 9:return s=e.sent.map((function(e){return"point"===e.type?[e.x,e.y]:void 0})),e.abrupt("return",i?s:s[0]);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),hN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).minTotalNumberOfFeatures=2e3,e.maxTotalNumberOfFeatures=5e4,e.maxTotalNumberOfPrimitives=17e5,e.snapshotAvailable=!0,e.polygonLodFactor=1,e.polylineLodFactor=1,e.skipHighSymbolLods=!1,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)()],hN.prototype,"minTotalNumberOfFeatures",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"maxTotalNumberOfFeatures",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"maxTotalNumberOfPrimitives",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"snapshotAvailable",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"polygonLodFactor",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"polylineLodFactor",void 0),(0,Eu.e)([(0,Eu.y)()],hN.prototype,"skipHighSymbolLods",void 0),hN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],hN);var dN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).lodFactor=1,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)()],dN.prototype,"lodFactor",void 0);var fN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).lodCrossfadeinDuration=(0,Eu.aj)(0),e.lodCrossfadeoutDuration=(0,Eu.aj)(0),e.lodCrossfadeUncoveredDuration=(0,Eu.aj)(0),e}return(0,ku.Z)(r)}(dN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],dN));fN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],fN);var pN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).object=new fN,e.point=new dN,e.integratedMesh=new dN,e.pointCloud=new dN,e.uncompressedTextureDownsamplingEnabled=!1,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:fN})],pN.prototype,"object",void 0),(0,Eu.e)([(0,Eu.y)({type:dN})],pN.prototype,"point",void 0),(0,Eu.e)([(0,Eu.y)({type:dN})],pN.prototype,"integratedMesh",void 0),(0,Eu.e)([(0,Eu.y)({type:dN})],pN.prototype,"pointCloud",void 0),(0,Eu.e)([(0,Eu.y)()],pN.prototype,"uncompressedTextureDownsamplingEnabled",void 0),pN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],pN);var vN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).lodBias=0,e.angledSplitBias=1,e.reduceTileLevelDifferences=!0,e.textureFadeDuration=(0,Eu.aj)(400),e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)()],vN.prototype,"lodBias",void 0),(0,Eu.e)([(0,Eu.y)()],vN.prototype,"angledSplitBias",void 0),(0,Eu.e)([(0,Eu.y)()],vN.prototype,"reduceTileLevelDifferences",void 0),(0,Eu.e)([(0,Eu.y)()],vN.prototype,"textureFadeDuration",void 0),vN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],vN);var mN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).pixelRatio=1,e.maxTotalNumberOfFeatures=5e4,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)()],mN.prototype,"pixelRatio",void 0),(0,Eu.e)([(0,Eu.y)()],mN.prototype,"maxTotalNumberOfFeatures",void 0),mN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.HeatmapSettings")],mN);var yN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).graphics3D=new hN,e.sceneService=new pN,e.tiledSurface=new vN,e.heatmap=new mN,e.weatherFadeDuration=(0,Eu.aj)(400),e.antialiasingEnabled=!0,e.physicallyBasedRenderingEnabled=!1,e.highQualityTransparency=!0,e.memoryLimit=void 0,e.additionalCacheMemory=void 0,e.frameRate=void 0,e.maximumRenderResolution=void 0,e.maximumPixelRatio=void 0,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({type:hN})],yN.prototype,"graphics3D",void 0),(0,Eu.e)([(0,Eu.y)({type:pN})],yN.prototype,"sceneService",void 0),(0,Eu.e)([(0,Eu.y)({type:vN})],yN.prototype,"tiledSurface",void 0),(0,Eu.e)([(0,Eu.y)({type:mN})],yN.prototype,"heatmap",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"weatherFadeDuration",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"antialiasingEnabled",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"physicallyBasedRenderingEnabled",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"highQualityTransparency",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"memoryLimit",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"additionalCacheMemory",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"frameRate",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"maximumRenderResolution",void 0),(0,Eu.e)([(0,Eu.y)()],yN.prototype,"maximumPixelRatio",void 0);var gN=yN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.QualitySettings.QualitySettings")],yN);function _N(e){return function(e){return(0,Nu.H)(e)&&e.length>=3}(e)||function(e){return((0,Nu.I)(e)||Array.isArray(e))&&e.length>=3}(e)}var bN,xN=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this.viewingMode=t,this.spatialReference=r,this.unitInMeters=n,this._coordinateSystem=i,this._tmpCoordinateSystem=function(e){var t=e.value,r=e.operations;return{operations:r,value:r.create(t)}}(i)}return(0,ku.Z)(e,[{key:"extent",set:function(e){e&&function(e,t,r){e.operations.setExtent(e.value,t,r.value)}(this._coordinateSystem,e,this._coordinateSystem)}},{key:"getAltitude",value:function(e){return function(e,t){return e.operations.altitudeAt(e.value,t)}(this._coordinateSystem,e)}},{key:"setAltitude",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return Ph(this._coordinateSystem,r,t,e)}},{key:"setAltitudeOfTransformation",value:function(e,t){!function(e,t,r,n){t!==n&&(0,Wu.n)(n,t),(0,Vu.o)(Ah,n[12],n[13],n[14]),Ph(e,Ah,r,Ah),n[12]=Ah[0],n[13]=Ah[1],n[14]=Ah[2]}(this._coordinateSystem,t,e,t)}},{key:"worldUpAtPosition",value:function(e,t){return function(e,t,r){return e.operations.axisAt(e.value,t,Qu.n.Z,r)}(this._coordinateSystem,e,t)}},{key:"worldBasisAtPosition",value:function(e,t,r){return function(e,t,r,n){return e.operations.axisAt(e.value,t,r,n)}(this._coordinateSystem,e,t,r)}},{key:"basisMatrixAtPosition",value:function(e,t){var r=this.worldBasisAtPosition(e,Qu.n.X,Qu.c.get()),n=this.worldBasisAtPosition(e,Qu.n.Y,Qu.c.get()),i=this.worldBasisAtPosition(e,Qu.n.Z,Qu.c.get());return(0,Wu.s)(t,r[0],r[1],r[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,0,0,0,1),t}},{key:"headingAtPosition",value:function(e,t){var r=this.worldUpAtPosition(e,Qu.c.get()),n=this.worldBasisAtPosition(e,Qu.n.Y,Qu.c.get()),i=(0,Qu.i)(t,n,r);return(0,Vu.b)(i)}},{key:"intersectManifoldClosestSilhouette",value:function(e,t,r){return Rh(this._coordinateSystem,t,this._tmpCoordinateSystem),function(e,t,r){e.operations.intersectRayClosestSilhouette(e.value,t,r)}(this._tmpCoordinateSystem,e,r),r}},{key:"intersectManifold",value:function(e,t,r){Rh(this._coordinateSystem,t,this._tmpCoordinateSystem);var n=Qu.c.get();return function(e,t,r){return e.operations.intersectRay(e.value,t,r)}(this._tmpCoordinateSystem,e,n)?(0,Vu.r)(r,n):null}},{key:"intersectInfiniteManifold",value:function(e,t,r){if(this.viewingMode===ic.l.Global)return this.intersectManifold(e,t,r);Rh(this._coordinateSystem,t,this._tmpCoordinateSystem);var n=this._tmpCoordinateSystem.value,i=Qu.c.get();return(0,Tc.q)(n.plane,e,i)?(0,Vu.r)(r,i):null}},{key:"toRenderCoords",value:function(e,t,r){return(0,qu.E)(e)?(0,Hu.g)(e,t,this.spatialReference):(0,Hu.j)(e,t,r,this.spatialReference)}},{key:"fromRenderCoords",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,qu.E)(t)?((0,Nu.r)(r)&&(t.spatialReference=r),(0,Hu.H)(e,this.spatialReference,t)):_N(t)?(0,Hu.j)(e,this.spatialReference,t,r)?t:null:(0,Hu.d)(e,this.spatialReference,t)}}],[{key:"create",value:function(t,r){switch(t){case ic.l.Local:return new e(ic.l.Local,r,(0,Xu.$)(r),Sh(qu.V,(0,qu.D)([0,0,0],[Oh,0,0],[0,Oh,0])));case ic.l.Global:return new e(ic.l.Global,r,1,function(e){return Sh(Qu.$,(0,Qu.E)(0,0,0,(0,Xu.u)(e).radius))}(r))}}},{key:"renderUnitScaleFactor",value:function(e,t){return wN(e)/wN(t)}}]),e}();function wN(e){if((0,qu.r)(e,ic.l.Global))return 1;var t=Dh(!1,e);return(0,Xu.$)(t)}!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(bN||(bN={}));var TN=function(){var e=new Array;return e[bN.ELEVATION]=10,e[bN.BASEMAP]=10,e[bN.I3S_INDEX]=10,e[bN.I3S_DATA]=10,e[bN.SYMBOLOGY]=5,e}(),CN=30;function SN(e){return"function"==typeof e.getUsedMemory}var ON=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._quality=1,n._memoryUsed=0,n._updating=!1,n.minQuality=.1,n._stableQuality=0,n._downscaleMemoryUsed=0,n._canFastRecover=!1,n._memoryPredicted=0,n._cacheStorage=new nh.h,n._warnMemoryUsage=null,n._numQualityChanges=0,n._maxMemory=500,n._additionalCacheMemory=100,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this._cacheStorage.destroy()}},{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"newCache",value:function(e,t){return new nh.r(e,this._cacheStorage,t)}},{key:"resetStableQuality",value:function(){this._stableQuality=0}},{key:"disableMemCache",value:function(){this.additionalCacheMemory=-4096}},{key:"update",value:function(){if(this._updateMemory(),!(this._memoryPredicted<=0)||this._updating){var e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;e=this._updateQuality(this._quality+.05)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}}},{key:"_updateQuality",value:function(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}},{key:"_layersUpdating",value:function(){return this.view.allLayerViews.some((function(e){return!!e.updating}))}},{key:"_updateMemory",value:function(){var e=this,t=0,r=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(t+=this.view.basemapTerrain.getUsedMemory());var n=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderView.edgeView;(0,Nu.r)(n)&&(t+=n.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach((function(n){if(SN(n)){var i=n.ignoresMemoryFactor()?e._quality:1;t+=n.getUsedMemory()*i,r+=n.getUnloadedMemory()*i}}));var i=(0,Nu.t)(this._warnMemoryUsage)||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&i){this._warnMemoryUsage=t;var o=function(e){return(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB"},s=Math.round(100*this._quality);Eu.a.getLogger(this.declaredClass).warn("Memory Limit exceeded! Limit: ".concat(o(a)," Current: ").concat(o(t)," Projected: ").concat(o(t+r)," Quality: ").concat(s,"%"))}this._memoryUsed=t/a,this._memoryPredicted=(t+r)/a;var l=a-t;this._cacheStorage.maxSize=Math.max(0,l+1048576*this.additionalCacheMemory)}},{key:"test",get:function(){var e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:function(){var t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],ON.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"maxMemory",null),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"additionalCacheMemory",null),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"memoryFactor",null),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"usedMemory",null),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_quality",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_memoryUsed",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_updating",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_stableQuality",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_maxMemory",void 0),(0,Eu.e)([(0,Eu.y)()],ON.prototype,"_additionalCacheMemory",void 0),ON=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.MemoryControllerImpl")],ON);var PN=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.client=t,this._cancelled=!1,this.size=0,this.duration=0})),RN=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new AN})),AN=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.requests=0,this.size=0,this.duration=0,this.speed=0})),kN=function(){function e(t,r,n,i){(0,Au.Z)(this,e),this._workerFunc=t,this._callbackFunc=r,this._maxTotalNumWorkers=n,this._totalNumWorkers=0,this._clients=i.map((function(e){return new RN(e)}))}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._clients.length=0}},{key:"hasQuota",value:function(e){var t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}},{key:"push",value:function(e){var t=this,r=this._clients[e.client];r&&(this._totalNumWorkers<this._maxTotalNumWorkers?(r.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(function(e,r){return t._taskCallback(e,r)}))):r.tasks.push(e))}},{key:"cancel",value:function(e){this._taskFinished(e),e._cancelled=!0}},{key:"_taskFinished",value:function(e){var t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,Sc.e)(t.numWorkers>=0),this._next()}},{key:"_next",value:function(){var e,t=(0,Cu.Z)(this._clients);try{for(t.s();!(e=t.n()).done;){var r=e.value;if(r&&r.numWorkers<r.typeWorkerQuota&&this._processQueue(r))return}}catch(o){t.e(o)}finally{t.f()}var n,i=(0,Cu.Z)(this._clients);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a&&this._processQueue(a))return}}catch(o){i.e(o)}finally{i.f()}}},{key:"_processQueue",value:function(e){for(var t=this;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(function(e,r){return t._taskCallback(e,r)})))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}},{key:"_taskCallback",value:function(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}},{key:"getStatsForType",value:function(e){var t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}},{key:"test",get:function(){var e=this;return{set workerFunc(t){e._workerFunc=t}}}}]),e}(),EN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._tasks=new Map,e._onLoadQueue=new Array,e._doneQueue=new Array,e.updating=!1,e}return(0,ku.Z)(r,[{key:"setup",value:function(e,t,r){var n=this;this._loadQueue=new kN((function(e,t){return n._startLoading(e,t)}),(function(e,t){return n._doneLoadingCB(e,t)}),e,t),r&&(this._frameTask=r.registerTask(bc.I.STREAM_DATA_LOADER,this))}},{key:"destroy",value:function(){this._frameTask=(0,Nu.f)(this._frameTask),this._tasks.forEach((function(e){return(0,Nu.l)(e.abortController)})),this._loadQueue=(0,Nu.g)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}},{key:"hasDownloadSlots",value:function(e){return this._loadQueue.hasQuota(e)}},{key:"request",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=(0,Eu.ap)();a.__signal=(0,Nu.r)(i)?i.signal:null;var o=this._createOrUpdateTask(e,t,r,i,a);return(0,Eu.v)(i,(function(){return n._cancelRequest(o,a)})),a.promise}},{key:"_createTask",value:function(e,t,r,n,i,a){var o=new LN(e,t,r,n,i);return this._updateTask(o,a),this._tasks.set(i,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}},{key:"_cancelRequest",value:function(e,t){var r;(0,Nu.A)(e.resolvers,t),t.reject((0,Eu.d)()),0===e.resolvers.length&&(e.status===MN.DOWNLOADING&&(e.status=MN.CANCELLED,this._loadQueue.cancel(e),null!==(r=e.abortController)&&void 0!==r&&r.abort(),e.request=null,e.abortController=null),e.status=MN.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}},{key:"_updateTask",value:function(e,t){e.resolvers.push(t)}},{key:"_createOrUpdateTask",value:function(e,t,r,n,i){var a=function(e,t,r){return"".concat(e,":").concat(t,":").concat(r)}((0,Nu.r)(n)&&n.uid||e,t,r),o=this._tasks.get(a);return o?(this._updateTask(o,i),o):this._createTask(e,n,t,r,a,i)}},{key:"_doneLoadingCB",value:function(e,t){this._loadQueue&&((0,Sc.e)(e.status===MN.DOWNLOADING),e.status=MN.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}},{key:"running",get:function(){return this._doneQueue.length>0||this._onLoadQueue.length>0}},{key:"runTask",value:function(e){for(;!e.done&&this._onLoadQueue.length>0;){var t=this._onLoadQueue.shift();(0,Eu.f)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){var r=this._doneQueue.shift();r.task.status!==MN.DOWNLOADED&&(r.err=r.err||(0,Eu.d)()),this._doneLoading(r.task,r.err),e.madeProgress()}}},{key:"_doneLoading",value:function(e,t){if(t&&!(0,Eu.j)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);var r,n=e.result instanceof HTMLImageElement?0:e.resolvers.length,i=(0,Cu.Z)(e.resolvers);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(t)(0,Eu.j)(t)?a.reject(t):a.reject(new Eu.s("stream-data-loader:request-error","Failed to request resource at '".concat(e.url,"'. ").concat(t),{url:e.url,error:t}));else{var o=--n<=0?e.result:(0,Nu.y)(e.result);a.resolve(o)}}}catch(s){i.e(s)}finally{i.f()}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}},{key:"_startLoading",value:function(e,t){var r,n,i=this;if(e.status===MN.CANCELLED)return!1;switch(e.startTime=performance.now(),e.status=MN.DOWNLOADING,e.docType){case"binary":n="array-buffer",r=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;var a=e.abortController.signal;e.request=(0,ih.U)(e.url,(0,Tu.Z)((0,Tu.Z)({},e.options),{},{responseType:n,timeout:r,signal:a}));var o=function(){},s=function(r){e.duration=performance.now()-e.startTime,e.size=r instanceof ArrayBuffer?r.byteLength:e.size||0,e.result=r,i._frameTask?i._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},l=function(r){e.status===MN.DOWNLOADING&&t(e,r),o()};return"image+type"!==e.docType?(e.request.then((function(e){return s(e.data)}),l),!0):(e.request.then((function(t){var i=t.data,u=function(e){if(e.byteLength<2)return"unknown";var t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(i);if(n="image",e.size=i.byteLength,"unknown"===u)return e.request=(0,ih.U)(e.url,{responseType:n,timeout:r,signal:a}),void e.request.then((function(e){return s(e.data)}),l);var c=new Blob([i],{type:u}),h=window.URL.createObjectURL(c);o=function(){return window.URL.revokeObjectURL(h)},e.request=(0,ih.U)(h,{responseType:n,timeout:r,signal:a}),e.request.then((function(e){return s(new IN(e.data,u,o))}),l)}),l),!0)}},{key:"test",get:function(){return{loadQueue:this._loadQueue}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],EN.prototype,"updating",void 0),EN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.StreamDataLoader")],EN);var DN=0;var MN,IN=function(){function e(t,r,n){(0,Au.Z)(this,e),this.image=t,this.type=r,this.release=n}return(0,ku.Z)(e,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]),e}(),LN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o){var s;return(0,Au.Z)(this,r),(s=t.call(this,a)).url=e,s.options=n,s.docType=i,s.key=o,s.result=null,s.status=MN.QUEUED,s.request=null,s.abortController=null,s.resolvers=new Array,s.startTime=0,s.numRetries=DN,s}return(0,ku.Z)(r)}(PN);!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(MN||(MN={}));var ZN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).updating=!1,e}return(0,ku.Z)(r)}(Eu.m);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],ZN.prototype,"updating",void 0);var NN=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._scheduler=null,e._memoryController=null,e._streamDataLoader=null,e._scheduleTask=bc.y,e._handles=new Eu.X,e._frameTask=null,e}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._scheduler=(0,bc.g)(),this._memoryController=function(e){return new ON({view:e})}(this.view),this._streamDataLoader=new EN,this._streamDataLoader.setup(CN,TN,this._scheduler),this._handles.add([(0,Fu.l)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.mode}),(function(t){return e._scheduler.state=t}),Fu.U),(0,Fu.l)((function(){return e.view.stationary}),(function(){return e._stationaryChangedHandler()}))]),this._frameTask=(0,Eu.a7)({update:function(t){return e._frame(t)}}),this._scheduleTask=this._scheduler.registerTask(bc.I.RESOURCE_CONTROLLER)}},{key:"destroy",value:function(){this._handles=(0,Nu.g)(this._handles),this._scheduleTask.remove(),this._frameTask=(0,Nu.f)(this._frameTask),this._streamDataLoader=(0,Nu.g)(this._streamDataLoader),this._memoryController=(0,Nu.g)(this._memoryController),this._scheduler=(0,Nu.g)(this._scheduler)}},{key:"updating",get:function(){var e,t,r;return!!(null!==(e=this._memoryController)&&void 0!==e&&e.updating||null!==(t=this._streamDataLoader)&&void 0!==t&&t.updating||null!==(r=this._scheduleTask)&&void 0!==r&&r.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"schedule",value:function(e,t,r){return this._scheduleTask.schedule(e,t,r)}},{key:"createStreamDataRequester",value:function(e){var t=this._streamDataLoader;return{request:function(r,n,i){return t.request(r,n,e,i)},get busy(){return!t.hasDownloadSlots(e)}}}},{key:"_frame",value:function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,Eu.aq)(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}},{key:"_stationaryChangedHandler",value:function(){this.memoryController.resetStableQuality()}},{key:"test",get:function(){var e=this;return{getQueueStats:function(t){return e._streamDataLoader.test.loadQueue.getStatsForType(t)}}}}]),r}(ZN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.ResourceControllerMain")],ZN));(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],NN.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],NN.prototype,"_scheduler",void 0),(0,Eu.e)([(0,Eu.y)()],NN.prototype,"_memoryController",void 0),(0,Eu.e)([(0,Eu.y)()],NN.prototype,"_streamDataLoader",void 0),(0,Eu.e)([(0,Eu.y)()],NN.prototype,"_scheduleTask",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],NN.prototype,"updating",null),NN=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.ResourceControllerImpl")],NN);var FN=(0,Vu.n)(),zN=(0,Vu.n)(),UN=(0,Vu.n)(),VN=(0,Vu.n)();function BN(e,t,r,n){(0,Vu.r)(FN,r),FN[n]=t[n];var i,a=(0,Vu.e)(FN,FN,t),o=(0,Vu.e)(zN,e,t),s=(0,Vu.P)(o,a),l=(0,Vu.P)(a,a);i=s<=0?t:l<=s?r:(0,Vu.u)(FN,t,(0,Vu.g)(a,a,s/l));var u=(0,Vu.e)(FN,e,i);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}var GN=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=e.extent;if((0,Nu.t)(n))return!1;if(0===r)return(0,ju.b)(n,t);var i=Math.min(n[2]-n[0],n[3]-n[1]);return(0,ju.q)(n,t,r*i)},tiltToExtentEdge:function(e,t,r){var n=e.extent;if((0,Nu.t)(n))return 0;UN[0]=n[0],UN[1]=n[1],UN[2]=r,VN[0]=n[2],VN[1]=n[3],VN[2]=r;var i=1/0,a=1/0;return t[0]<UN[0]?i=BN(t,UN,VN,0):t[0]>VN[0]&&(i=BN(t,VN,UN,0)),t[1]<UN[1]?a=BN(t,UN,VN,1):t[1]>VN[1]&&(a=BN(t,VN,UN,1)),Math.min(i,a)},checkIfTileInfoSupportedForViewSR:function(e,t,r){if((0,Nu.t)(e))return Lh();if(e.spatialReference.isGeographic&&!(0,Hu.R)(e.spatialReference))return new Eu.s("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");var n=Ih.checkUnsupported(e);if((0,Nu.r)(n))return n;if((0,Nu.t)(r))return new Eu.s("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");var i=function(e,t){var r=e.lods,n=r[0].resolution*Math.pow(2,r[0].level),i=[n*e.size[0],n*e.size[1]],a=[e.origin.x,e.origin.y],o=(0,ju.c)(t),s=(0,ju.u)();Ih.computeRowColExtent(o,i,a,s);var l=(s[2]-s[0])*(s[3]-s[1]);if(l>Nh){var u=r[0].scale*Math.pow(2,r[0].level),c=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*u/n,h=Math.floor(Math.log(c)/Math.log(10));return c=Math.ceil(c/Math.pow(10,h))*Math.pow(10,h),new Eu.s("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(u).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+c.toLocaleString()+".",{level0Scale:u,suggestedLevel0Scale:c,requiredNumRootTiles:l,allowedNumRootTiles:Nh})}return null}(e,r);if(i)return i;var a=e.spatialReference;return(0,Nu.r)(t)&&!(a.equals(t)||t.isWGS84&&a.isWebMercator)?new Eu.s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}},Symbol.toStringTag,{value:"Module"}));var HN=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){if((0,Nu.t)(e))return Lh();var r=e.lods.length-1,n=e.spatialReference,i=(0,Hu.R)(n)||(0,Yu.P)(n)||(0,Yu.c)(n);if(n.isWebMercator){if(!Ih.makeWebMercatorAuxiliarySphere(r).compatibleWith(e))return new Eu.s("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!i)return new Eu.s("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Ih.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e))return e.spatialReference.isWGS84?new Eu.s("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new Eu.s("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return(0,Nu.r)(t)&&!e.spatialReference.equals(t)?new Eu.s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}},Symbol.toStringTag,{value:"Module"})),jN=(bi={},(0,yu.Z)(bi,ic.l.Global,HN),(0,yu.Z)(bi,ic.l.Local,GN),bi);function qN(e,t){e||console.warn("Terrain: "+t)}var WN=!1,XN=!1;function YN(e,t){if(WN&&!e){var r=(new Error).stack.slice(5);throw console.warn("Terrain internal: "+(t||"")+" at "+r),new Error("Assertion failed"+(t?": "+t:""))}}function QN(e){return JN(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function KN(e){return"imagery-tile"===(null===e||void 0===e?void 0:e.type)||"wcs"===(null===e||void 0===e?void 0:e.type)}function JN(e){return"imagery-tile-3d"===(null===e||void 0===e?void 0:e.type)}function $N(e){return"tile-3d"===(null===e||void 0===e?void 0:e.type)}function eF(e){return"vector-tile-3d"===(null===e||void 0===e?void 0:e.type)}function tF(e){return"wmts-3d"===(null===e||void 0===e?void 0:e.type)}function rF(e){return"elevation-3d"===(null===e||void 0===e?void 0:e.type)}function nF(e){return"group"===(null===e||void 0===e?void 0:e.type)}function iF(e){return"group"===(null===e||void 0===e?void 0:e.type)}function aF(e){return e&&($N(e)||tF(e)||JN(e)||eF(e))}function oF(e){return e&&($N(e)||JN(e)||eF(e)||tF(e))}function sF(e){return oF(e)||rF(e)}function lF(e){return(0,Nu.r)(e)&&"release"in e&&e.release(),null}function uF(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function cF(e,t,r,n){return jN[n].checkIfTileInfoSupportedForViewSR(e,r,t)}function hF(e,t,r){var n=null,i=null;if("wmts"===(null===e||void 0===e?void 0:e.type)){var a=function(e,t,r){var n=(0,$u.c)(e);if((0,Nu.r)(n)){if(!Lu.j.isCollection(n))return{tileInfo:n.tileInfo,fullExtent:n.fullExtent};var i=n.find((function(e){return null==cF(e.tileInfo,e.fullExtent,t,r)}));if(i)return{tileInfo:i.tileInfo,fullExtent:i.fullExtent}}return{tileInfo:null,fullExtent:null}}(e,t,r);n=a.tileInfo,i=a.fullExtent}else{i=KN(e)?e.getCompatibleFullExtent(t):e.fullExtent;var o=r===ic.l.Local;if(KN(e))n=e.getCompatibleTileInfo(t,i,o);else if("vector-tile"===(null===e||void 0===e?void 0:e.type)){var s=o&&!dF(t)||fF.force512VTL,l=e.tileInfo.spatialReference.isGeographic;n=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,l?1:2)}else n=e.tileInfo}return(0,Nu.r)(n)&&(0,Nu.r)(i)&&null==cF(n,i,t,r)?{tileInfo:n,fullExtent:i}:null}function dF(e){return e.isWGS84||e.isWebMercator||(0,Yu.u)(e)||!(0,Yu.A)(e)}var fF={force512VTL:!1};function pF(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function vF(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function mF(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:SF;return Math.abs(e-t)<r}function yF(e){return e===jS.NORTH_EAST?jS.SOUTH_WEST:e===jS.NORTH_WEST?jS.SOUTH_EAST:e===jS.SOUTH_WEST?jS.NORTH_EAST:jS.NORTH_WEST}function gF(e){return e===jS.NORTH?jS.SOUTH:e===jS.EAST?jS.WEST:e===jS.SOUTH?jS.NORTH:jS.EAST}function _F(e){return e===jS.NORTH_WEST||e===jS.WEST||e===jS.SOUTH_WEST}function bF(e){return e===jS.NORTH_EAST||e===jS.EAST||e===jS.SOUTH_EAST}function xF(e){return e===jS.SOUTH_EAST||e===jS.SOUTH||e===jS.SOUTH_WEST}function wF(e){return e===jS.NORTH_EAST||e===jS.NORTH||e===jS.NORTH_WEST}var TF=[jS.NORTH,jS.EAST,jS.SOUTH,jS.WEST],CF=[jS.NORTH_EAST,jS.SOUTH_EAST,jS.SOUTH_WEST,jS.NORTH_WEST],SF=1e-5,OF=(0,ku.Z)((function e(t,r){if((0,Au.Z)(this,e),this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=sF(t)?r.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),function(e){return"performanceInfo"in e}(t)){var n=t.performanceInfo;this.displayedNumberOfFeatures=n.displayedNumberOfFeatures,this.maximumNumberOfFeatures=n.maximumNumberOfFeatures,this.totalNumberOfFeatures=n.totalNumberOfFeatures}})),PF=(0,ku.Z)((function e(t){var r=this;if((0,Au.Z)(this,e),this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,(0,Nu.r)(t.resourceController)){var n=t.resourceController.memoryController;this.totalMemory=n.maxMemory*Xc.s.MEGABYTES,this.usedMemory=Math.round(n.usedMemory*this.totalMemory),this.quality=n.memoryFactor,this.load=t.resourceController.scheduler.load}this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;var i=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=(0,Nu.r)(i)?i.usedMemory:0,t.allLayerViews.items.forEach((function(e){(SN(e)||sF(e))&&r.layerPerformanceInfos.push(new OF(e,t))})),this.layerPerformanceInfos.sort((function(e,t){return t.memory-e.memory}))})),RF=function(){function e(t){(0,Au.Z)(this,e),this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=t("gltf-resources",(function(){})),this._wosrMemCache=t("wosr-resources",(function(){}))}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._gltfLoading.forEach((function(e){return e.abortController.abort()})),this._wosrLoading.forEach((function(e){return e.abortController.abort()})),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}},{key:"loadGLTF",value:function(e,t,r){var n=r?"gltfPBR:".concat(e):"gltf:".concat(e),i=this._gltfMemCache.get(n);return(0,Nu.r)(i)?Promise.resolve(i):this._loadOnce(this._gltfLoading,this._gltfMemCache,n,(function(t){return(0,Cc.m)(new Cc.n(t.streamDataRequester),e,t,r)}),t)}},{key:"loadWOSR",value:function(e,t){var r="wosr:".concat(e,":").concat(t.disableTextures),n=this._wosrMemCache.get(r);return(0,Nu.r)(n)?Promise.resolve(n):this._loadOnce(this._wosrLoading,this._wosrMemCache,r,(function(t){return(0,dc.ba)(e,t)}),t)}},{key:"_loadOnce",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u,c=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,Eu.f)(a),o=(0,Eu.v)(a,(function(){return c._abortLoad(t,n)})),(s=t.get(n))?s.refCount++:(l=new AbortController,s={refCount:1,abortController:l,promise:i((0,Tu.Z)((0,Tu.Z)({},a),{},{signal:l.signal}))},t.set(n,s)),e.prev=4,e.next=7,s.promise;case 7:return u=e.sent,e.abrupt("return",(r.put(n,u,u.size),t.delete(n),(0,Eu.f)(a),u));case 9:return e.prev=9,(0,Nu.f)(o),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[4,,9,12]])})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_abortLoad",value:function(e,t){var r=e.get(t);(0,Nu.r)(r)&&--r.refCount>0||(e.delete(t),(0,Nu.r)(r)&&r.abortController.abort())}}]),e}(),AF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,n,a))._streamDataRequester=e,o._parameters=i,o}return(0,ku.Z)(r,[{key:"fromUrl",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n){var i,a,o,s,l,u=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,Eu.f)(n),i=(0,Nu.r)(n)&&n.signal,a=this.makeUid(t,r),(o=this._textureRequests.get(a))||(s=new AbortController,l=this._streamDataRequester.request(t,"image",{uid:a,signal:s.signal}),o={referenceCount:0,texture:null,textureAsync:null,abortController:s},this._textureRequests.set(a,o),o.textureAsync=l.then(function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(n){var i;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=u._createTexture(t,n,r),o.texture=i,o.abortController=null,u._stage.add(i),e.next=6,u._stage.load(i);case 6:return e.abrupt("return",{uid:a,texture:i,release:function(){return u._release(a)}});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),(function(e){throw o.abortController=null,e}))),e.abrupt("return",(o.referenceCount++,new Promise((function(e,t){(0,Eu.v)(i,(function(){t((0,Eu.d)())})),o.textureAsync.then(e,t)})).catch((function(e){throw u._release(a),e}))));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_createTexture",value:function(e,t,r){var n=(0,Tu.Z)((0,Tu.Z)({},this._parameters),{},{powerOfTwoResizeMode:vc.h.PAD});if((0,ih.I)(e)){if(r||0===t.width&&0===t.height){var i=t.width?t.height/t.width:1;r=r||64,i>1?(t.width=Math.round(r/i),t.height=r):(t.width=r,t.height=Math.round(r*i))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(n.preMultiplyAlpha=!1)}return n.width=t.width,n.height=t.height,new dc.Y(t,n)}}]),r}(Ju.Q),kF=function(){function e(t){(0,Au.Z)(this,e),this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=t.viewState,this._view=t.view,this._pointsOfInterest=t.pointsOfInterest,this.streamDataRequester=t.resourceController.createStreamDataRequester(bN.SYMBOLOGY),this.objectResourceCache=new RF((function(e,r){return t.resourceController.memoryController.newCache(e,r)})),this.textures=new AF(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:pc.D.CLAMP_TO_EDGE,t:pc.D.CLAMP_TO_EDGE}},t.resourceController.scheduler);var r=(0,Xu.u)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,dc.bb)(t.viewingMode,r),this.screenSizePerspectiveSettingsLabels=(0,dc.bc)(t.viewingMode,r)}return(0,ku.Z)(e,[{key:"destroy",value:function(){(0,Nu.g)(this.textures),this.textures=null,this.streamDataRequester=null}},{key:"addGraphicsOwner",value:function(e){var t=this;if(!e)return(0,Eu.D)();this._graphicsOwners.push(e);var r=(0,Fu.l)((function(){var t;return null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled}),(function(){return t._updateScreenSizePerspectiveEnabled()}));return this._updateScreenSizePerspectiveEnabled(),(0,Eu.D)((function(){r.remove(),(0,Nu.A)(t._graphicsOwners,e),t._updateScreenSizePerspectiveEnabled()}))}},{key:"_updateScreenSizePerspectiveEnabled",value:function(){var e=this,t=this._graphicsOwners.some((function(e){var t;return!0===(null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled)}));if(t&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Eu.X;var r=function(){return e._updateScreenSizePerspectiveSettings()};this._screenSizePerspectiveHandles.add([(0,Fu.l)((function(){return e._pointsOfInterest.centerOnSurfaceInfrequent.distance}),r,Fu.U),this._viewState.events.on("camera-projection-changed",r)]),this._updateScreenSizePerspectiveSettings()}else!t&&this._screenSizePerspectiveHandles&&(this._screenSizePerspectiveHandles.destroy(),this._screenSizePerspectiveHandles=null)}},{key:"_updateScreenSizePerspectiveSettings",value:function(){var e=this._pointsOfInterest;EF.distance=e.centerOnSurfaceInfrequent.distance,EF.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(EF),this.screenSizePerspectiveSettingsLabels.update(EF),this._view._stage.renderView.requestRender()}},{key:"test",get:function(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}]),e}(),EF={distance:0,fovY:0},DF=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";(0,Au.Z)(this,e),this.graphics=t,this._symbol=new Bc.d({symbolLayers:[new Bc.z({material:{color:r},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Bc.A({text:n,halo:{color:"white",size:1/.75},material:{color:r},size:12})]})}return(0,ku.Z)(e,[{key:"show",value:function(e,t){if(!(0,Nu.t)(t)){this.hide();var r=new Yu.w({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new Iu.g({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}}},{key:"hide",value:function(){(0,Nu.r)(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}]),e}(),MF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"destroy",value:function(){this.handles.destroy()}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],MF.prototype,"renderCoordsHelper",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],MF.prototype,"surface",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],MF.prototype,"state",void 0),MF=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.PointOfInterest")],MF);var IF=Array,LF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._dirty=!1,n._propertiesPool=new Ju.M({location:Yu.w,renderLocation:IF},(0,gu.Z)(n)),n._estimatedSurfaceAltitude=0,n._pendingElevationQueryController=null,n.cameraName="camera",n.renderLocation=(0,Vu.n)(),n._tmpPoint=new Yu.w,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){var t=function(){return e._setDirty()};this.handles.add((0,Fu.a)((function(){var t,r;return null===(t=e.map)||void 0===t||null===(r=t.ground)||void 0===r?void 0:r.layers}),"change",t,{onListenerAdd:t,onListenerRemove:t}))}this._updateRenderLocation()}},{key:"destroy",value:function(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}},{key:"_camera",get:function(){return this.state[this.cameraName]}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"scale",get:function(){var e=this._camera,t=(0,Vu.x)(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,qu._)(r,t,0)}},{key:"updating",get:function(){return this._dirty||null!=this._pendingElevationQueryController}},{key:"updateRenderLocation",value:function(){this._setDirty(),this._updateRenderLocation()}},{key:"_setDirty",value:function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}},{key:"_cancelPendingRequest",value:function(){var e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}},{key:"running",get:function(){return!this._pendingElevationQueryController&&this._dirty}},{key:"runTask",value:function(){var e=this;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),this.map&&this.map.ground){var t=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,t);var r=this._tmpPoint.z>NF&&this.renderCoordsHelper.viewingMode===ic.l.Global&&(t.isWGS84||t.isWebMercator),n=new AbortController;this.map.ground.queryElevation(this._tmpPoint,{signal:n.signal,cache:this.cache,minDemResolution:r?FF:0}).then((function(t){return e._updateSurfaceAltitude(t.geometry.z)})).catch((function(t){(0,Eu.j)(t)||e._updateSurfaceAltitude(0)})).catch((function(){})).then((function(){e._pendingElevationQueryController===n&&(e._pendingElevationQueryController=null,e.notifyChange("updating")),n=null})),this._pendingElevationQueryController=n}else this._updateSurfaceAltitude(0)}},{key:"_updateSurfaceAltitude",value:function(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}},{key:"_updateRenderLocation",value:function(){this.renderCoordsHelper.setAltitude(ZF,this._estimatedSurfaceAltitude,this._camera.eye),(0,Vu.F)(this._get("renderLocation"),ZF)||(this._set("renderLocation",(0,Vu.r)(this._propertiesPool.get("renderLocation"),ZF)),this.notifyChange("renderLocation"))}}]),r}(MF);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],LF.prototype,"scheduler",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],LF.prototype,"cache",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],LF.prototype,"task",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],LF.prototype,"cameraName",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],LF.prototype,"location",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],LF.prototype,"map",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],LF.prototype,"renderLocation",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],LF.prototype,"scale",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],LF.prototype,"updating",null),LF=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.CameraOnSurface")],LF);var ZF=(0,Vu.n)(),NF=1e5,FF=1e6,zF=Array,UF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._propertiesPool=new Ju.M({location:Yu.w,renderLocation:zF},(0,gu.Z)(n)),n._currentSurfaceAltitude=0,n._latestSurfaceAltitude=0,n.cameraName="camera",n.distance=0,n.renderLocation=(0,Vu.n)(),n.updating=!1,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}},{key:"destroy",value:function(){this._frameWorker=(0,Nu.f)(this._frameWorker),this._propertiesPool=(0,Nu.g)(this._propertiesPool)}},{key:"_camera",get:function(){return this.state[this.cameraName]}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"updateRenderLocation",value:function(){this.updating=!0,this._updateRenderLocation()}},{key:"estimatedSurfaceAltitude",get:function(){return this._latestSurfaceAltitude}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}},{key:"_updateRenderLocation",value:function(){var e=BF,t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e),r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&((t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e))&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));var n=GF;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,n)&&((0,Vu.r)(e,n),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Vu.x)(this._camera.eye,e):((0,Vu.g)(e,this._camera.viewForward,this._get("distance")),(0,Vu.u)(e,e,this._camera.eye)),(0,Vu.F)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Vu.r)(this._propertiesPool.get("renderLocation"),e))}},{key:"_calculateSurfaceIntersection",value:function(e,t){var r=this._camera;if(!this.renderCoordsHelper.intersectManifold(r.ray,e,t))return!1;if(this.state.isGlobal){var n=(0,Xu.u)(this.renderCoordsHelper.spatialReference).radius,i=n+e,a=(0,Vu.v)(r.eye),o=a<i*i,s=(0,Vu.x)(r.eye,t);if(o&&s>n/4){var l=i-Math.sqrt(a);return(0,Vu.g)(t,r.viewForward,l),(0,Vu.u)(t,t,r.eye),!0}}else{var u=this.surface.ready?this.surface.extent:null;(0,Nu.r)(u)&&(0,Hu.v)(u,this.surface.spatialReference,HF,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,Vu.a)(t[0],HF[0],HF[2]),t[1]=(0,Vu.a)(t[1],HF[1],HF[3]))}return!0}},{key:"_latestSurfaceAltitudeChangesDistanceSignificantly",value:function(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Ac.t.TESTS_DISABLE_OPTIMIZATIONS)return!0;var r=this._camera.eye,n=(0,Vu.x)(r,e),i=(0,Vu.x)(r,t);if(Math.abs(i-n)/n>VF)return!0}return!1}}]),r}(MF);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],UF.prototype,"scheduler",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],UF.prototype,"task",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],UF.prototype,"cameraName",void 0),(0,Eu.e)([(0,Eu.y)()],UF.prototype,"distance",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],UF.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UF.prototype,"location",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],UF.prototype,"renderLocation",void 0),(0,Eu.e)([(0,Eu.y)()],UF.prototype,"updating",void 0),UF=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.CenterOnSurface")],UF);var VF=.05,BF=(0,Vu.n)(),GF=(0,Vu.n)(),HF=(0,ju.u)(),jF=function(){function e(t){var r=this;(0,Au.Z)(this,e),this._handles=new Eu.X,this.events=new ec.n,this._contentLayerViews=t.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(function(e){return r._layerViewsChanged(e)}))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null)}},{key:"_layerViewsChanged",value:function(e){var t=this;e.added.forEach((function(e){"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&t._handles.add(e.on("visible-geometry-changed",(function(){return t._contentChanged()})),e.uid)})),e.removed.forEach((function(e){return t._handles.remove(e.uid)}))}},{key:"_contentChanged",value:function(){this.events.emit("request-update",qF)}}]),e}(),qF={},WF=Array,XF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._propertiesPool=new Ju.M({location:Yu.w,renderLocation:WF},(0,gu.Z)(n)),n._dirty=!0,n.renderLocation=n._propertiesPool.get("renderLocation"),n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this.handles.add([(0,Fu.l)((function(){return e.centerOnSurface.renderLocation}),(function(){return e.updateRenderLocation()})),(0,Fu.l)((function(){return e.state.contentCamera}),(function(){return e.updateRenderLocation()}))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(bc.I.POINT_OF_INTEREST_FREQUENT,this))}},{key:"destroy",value:function(){this._propertiesPool.destroy(),this._propertiesPool=null}},{key:"updating",get:function(){return this._dirty||this.centerOnSurface.updating}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"running",get:function(){return this._dirty}},{key:"runTask",value:function(){var e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,r=this.renderCoordsHelper,n=this.state.contentCamera;this._dirty=!1,r.worldUpAtPosition(t,YF);var i=Math.max(0,(Math.acos((0,Vu.P)(YF,n.viewForward))-.5*Math.PI)*(n.aboveGround?1:-1));if(Number.isNaN(i)){if(!e||!(0,Vu.a2)(e,t)){var a=this._propertiesPool.get("renderLocation");(0,Vu.r)(a,t),this._set("renderLocation",a)}}else{var o=1-(0,Vu.a)(i/(.5*Math.PI),0,1),s=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(KF);var l=this._propertiesPool.get("renderLocation");(0,Vu.A)(l,t,KF,s),e&&(0,Vu.a2)(e,l)||this._set("renderLocation",l)}}},{key:"_calculateScreenHorizontalEdgeOnSurface",value:function(e){var t=this.state.contentCamera,r=t.getRenderCenter((0,zu.x)());if(r[1]=t.aboveGround?t.padding[zy.BOTTOM]:t.fullHeight-t.padding[zy.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;var n=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,QF)){(0,Vu.e)(QF,QF,t.eye);var i=(0,Vu.z)(QF,QF);if(this.renderCoordsHelper.intersectManifold((0,Qu.p)(t.eye,i),n,e))return e}return this.renderCoordsHelper.setAltitude(e,n,t.eye)}},{key:"updateRenderLocation",value:function(){this._dirty=!0}}]),r}(MF);(0,Eu.e)([(0,Eu.y)()],XF.prototype,"_dirty",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],XF.prototype,"scheduler",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],XF.prototype,"centerOnSurface",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],XF.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],XF.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],XF.prototype,"location",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],XF.prototype,"renderLocation",void 0),XF=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.pointsOfInterest.Focus")],XF);var YF=(0,Vu.n)(),QF=(0,Vu.n)(),KF=(0,Vu.n)(),JF=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).location=null,n._updateController=null,n._handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"surface",get:function(){var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}},{key:"surfaceView",get:function(){return this.view.basemapTerrain}},{key:"renderLocation",get:function(){if(!this.location)return null;var e=(0,Vu.n)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}},{key:"initialize",value:function(){var e=this;this.view.state.isLocal&&(this._handles.add([(0,Fu.l)((function(){var t,r;return[null===(t=e.surfaceView)||void 0===t?void 0:t.spatialReference,null===(r=e.surfaceView)||void 0===r?void 0:r.extent]}),(function(){return e._update()})),(0,Fu.a)((function(){var t;return null===(t=e.surface)||void 0===t?void 0:t.layers}),"change",(function(){return e._update()}))]),this._update())}},{key:"destroy",value:function(){this._handles.destroy()}},{key:"_update",value:function(){var e=this;if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||(0,Nu.t)(this.surfaceView.extent)||(0,Nu.t)(this.surfaceView.spatialReference))this._set("location",null);else{var t=(0,ju.p)(this.surfaceView.extent),r=new Yu.w({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(r,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((function(t){e._updateController=null,e._set("location",t.geometry)})).catch((function(e){(0,Eu.j)(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",r)}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JF.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JF.prototype,"cache",void 0),(0,Eu.e)([(0,Eu.y)()],JF.prototype,"surface",null),(0,Eu.e)([(0,Eu.y)()],JF.prototype,"surfaceView",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],JF.prototype,"location",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],JF.prototype,"renderLocation",null),JF=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.StableSurfaceCenter")],JF);var $F=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n._tileGeometryUpdateExtent=(0,ju.D)(),n._tileGeometryUpdateSpatialReference=null,n.events=new ec.n,n.updating=!1,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add([this.surface.on("elevation-change",(function(t){return e._tileGeometryChanged(t)})),this.scheduler.registerTask(bc.I.SURFACE_GEOMETRY_UPDATES,this)])}},{key:"destroy",value:function(){this._handles=(0,Nu.g)(this._handles)}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",ez),(0,ju.D)(this._tileGeometryUpdateExtent),this._set("updating",!1))}},{key:"_tileGeometryChanged",value:function(e){this._tileGeometryUpdateSpatialReference=(0,Nu.e)(e.spatialReference),(0,ju.h)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}},{key:"_furthestCenterOnSurface",value:function(){for(var e=this.centerOnSurfaces[0],t=1;t<this.centerOnSurfaces.length;t++){var r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r)}return e}},{key:"_centerIntersectsExtent",value:function(e,t){var r=this.state.camera.eye,n=nz,i=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,tz,t),this.renderCoordsHelper.fromRenderCoords(i.renderLocation,rz,t),tz[0]<rz[0]?(n[0]=tz[0],n[2]=rz[0]):(n[0]=rz[0],n[2]=tz[0]),tz[1]<rz[1]?(n[1]=tz[1],n[3]=rz[1]):(n[1]=rz[1],n[3]=tz[1]),(0,ju.E)(n,e)}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],$F.prototype,"state",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],$F.prototype,"centerOnSurfaces",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],$F.prototype,"renderCoordsHelper",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],$F.prototype,"scheduler",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],$F.prototype,"surface",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],$F.prototype,"updating",void 0),$F=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.SurfaceGeometryUpdates")],$F);var ez={},tz=(0,Vu.n)(),rz=(0,Vu.n)(),nz=(0,ju.D)(),iz=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n._tmpRay=(0,Qu.d)(),n._centerRayDirty=!0,n._surfaceAltitudeAtCenter=0,n._surfaceAltitudeAtCenterDirty=!0,n._contentAltitudeAtCenter=0,n._contentAltitudeAtCenterDirty=!0,n._propertiesPool=new Ju.M({renderPointOfView:az},(0,gu.Z)(n)),n.renderPointOfView=(0,Vu.n)(),n._pois=new Array,n._debugCenters=new Map,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e,t=this,r=this.view,n=r.state,i=r.basemapTerrain,a=r.renderCoordsHelper,o=r.map;this._surfaceIntersector=(0,qu.g)(n.viewingMode),n.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=qu.J.MIN,this._contentIntersector=(0,qu.g)(n.viewingMode);var s=function(){return t._estimateSurfaceAltitudeAtCenter()},l=this.view.resourceController.scheduler,u=(0,Nu.e)(null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.elevationQueryCache),c={state:n,scheduler:l,surface:i,renderCoordsHelper:a};this._set("centerOnSurfaceInfrequent",new UF((0,Tu.Z)((0,Tu.Z)({},c),{},{task:bc.I.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("centerOnSurfaceFrequent",new UF((0,Tu.Z)((0,Tu.Z)({},c),{},{task:bc.I.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("contentCenterOnSurface",new UF((0,Tu.Z)((0,Tu.Z)({},c),{},{task:bc.I.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s,cameraName:"contentCamera"}))),this._set("centerOnContent",new UF((0,Tu.Z)((0,Tu.Z)({},c),{},{task:bc.I.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:function(){return t._estimateContentAltitudeAtCenter()}}))),this._set("cameraOnSurface",new LF((0,Tu.Z)((0,Tu.Z)({},c),{},{cache:u,task:bc.I.POINT_OF_INTEREST_INFREQUENT,map:o}))),this._set("contentCameraOnSurface",new LF((0,Tu.Z)((0,Tu.Z)({},c),{},{cache:u,task:bc.I.POINT_OF_INTEREST_INFREQUENT,map:o,cameraName:"contentCamera"}))),this._set("surfaceGeometryUpdates",new $F((0,Tu.Z)((0,Tu.Z)({},c),{},{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new jF({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:a})),this._set("surfaceOrigin",new JF({cache:u,view:this.view})),this._set("focus",new XF({state:n,scheduler:l,surface:i,renderCoordsHelper:a,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:function(e,r){return t._estimateSurfaceIntersectionAtRenderPoint(e,t.view.state.contentCamera,r)}})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);var h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new DF(h,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new DF(h,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new DF(h,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new DF(h,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new DF(h,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new DF(h,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new DF(h,"green","Focus")),this._handles.add([(0,Fu.l)((function(){return n.camera}),(function(e){return t._cameraChanged(e)}),Fu.U),(0,Fu.l)((function(){return i.extent}),(function(){return t._updateCenterPointsOfInterest()})),(0,Fu.f)((function(){return!i.updating}),(function(){return t._updateCenterPointsOfInterest()}),Fu.U),(0,Fu.a)((function(){return t.surfaceGeometryUpdates.events}),"request-update",(function(){return t._updateCenterPointsOfInterest()})),(0,Fu.a)((function(){return t.contentGeometryUpdates.events}),"request-update",(function(){return t._updateCenterOnContent()})),(0,Fu.f)((function(){return Ac.t.SHOW_POI}),(function(e){return t._setDebug(e)}),Fu.h)]),this._cameraChanged(this.view.state.camera);var d,f=(0,Cu.Z)(this._pois);try{for(f.s();!(d=f.n()).done;){d.value.runTask()}}catch(p){f.e(p)}finally{f.f()}}},{key:"destroy",value:function(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();var e,t=(0,Cu.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(r){t.e(r)}finally{t.f()}this.surfaceOrigin.destroy()}},{key:"updating",get:function(){var e;return!((null===(e=this.surfaceGeometryUpdates)||void 0===e||!e.updating)&&!this._pois.some((function(e){return e.updating})))}},{key:"_centerRay",get:function(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}},{key:"_estimateContentAltitudeAtCenter",value:function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;var e=this._centerRay;return(0,Nu.t)(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,oz,lz)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(oz):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}},{key:"_estimateSurfaceAltitudeAtCenter",value:function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;var e=this._centerRay;if((0,Nu.t)(e))return this._surfaceAltitudeAtCenter;var t=e.origin,r=(0,Vu.u)(oz,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(oz)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(oz)),this._surfaceAltitudeAtCenter}},{key:"_estimateSurfaceIntersectionAtRenderPoint",value:function(e,t,r){var n=Vg(t,e,sz);if((0,Nu.t)(n))return null;var i=n.origin,a=(0,Vu.u)(oz,n.origin,n.direction);return this._surfaceIntersector.resetWithRay(n,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,i,a),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}},{key:"_cameraChanged",value:function(e){this._updateCenterPointsOfInterest();var t=e.eye;(0,Vu.F)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Vu.r)(this._propertiesPool.get("renderPointOfView"),t))}},{key:"_updateCenterPointsOfInterest",value:function(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;var e,t=(0,Cu.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.updateRenderLocation()}}catch(r){t.e(r)}finally{t.f()}}},{key:"_updateCenterOnContent",value:function(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}},{key:"_setDebug",value:function(e){var t=this;if(!e)return this._debugCenters.forEach((function(e){return e.hide()})),void this._handles.remove("debug");var r,n=(0,Cu.Z)(this._pois);try{var i=function(){var e=r.value;t._handles.add((0,Fu.l)((function(){return e.renderLocation}),(function(r){return t._debugCenters.get(e).show(r,e.renderCoordsHelper.spatialReference)}),Fu.h),"debug")};for(n.s();!(r=n.n()).done;)i()}catch(a){n.e(a)}finally{n.f()}}},{key:"test",get:function(){var e=this;return{update:function(){e.surfaceGeometryUpdates.runTask();var t,r=(0,Cu.Z)(e._pois);try{for(r.s();!(t=r.n()).done;){t.value.runTask()}}catch(n){r.e(n)}finally{r.f()}},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"centerOnContent",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"centerOnSurfaceFrequent",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"centerOnSurfaceInfrequent",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"contentCenterOnSurface",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"cameraOnSurface",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"contentCameraOnSurface",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"focus",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"renderPointOfView",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"surfaceOrigin",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"contentGeometryUpdates",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"surfaceGeometryUpdates",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],iz.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],iz.prototype,"updating",null),iz=(0,Eu.e)([(0,Eu.n)("esri.views.3d.support.PointsOfInterest")],iz);var az=Array,oz=(0,Vu.n)(),sz=(0,Qu.d)(),lz={exclude:new Set([Ic.j])},uz=function(){function e(t){(0,Au.Z)(this,e),this._store=t}return(0,ku.Z)(e,[{key:"destroy",value:function(){this._store.destroy()}},{key:"get",value:function(e){return this._store.get(e)}},{key:"put",value:function(e,t){this._store.put(e,t,t.values.byteLength+256)}}]),e}(),cz={value:.5,readOnly:!0},hz={readOnly:!0,value:.5,get:function(){return this.updating?this.updatingProgressValue:1}},dz=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,Au.Z)(this,e),this.min=t,this.max=r,this.level=0,this.hasNoDataValues=!1}return(0,ku.Z)(e,[{key:"copyFrom",value:function(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}]),e}(),fz=function(){function e(t,r,n){(0,Au.Z)(this,e),this.type="elevation",this.level=t[0],this.i=t[1],this.j=t[2],this.extent=r;for(var i=n.noDataValue,a=n.values,o=1/0,s=-1/0,l=!0,u=!1,c=0;c<a.length;c++){var h=a[c];h!==i?(o=h<o?h:o,s=h>s?h:s,l=!1):u=!0}l&&(o=0,s=0),s=s>-3e38?s:0,this.samplerData=new rc.t(n,r),this.bounds=[o,s],this.hasNoDataValues=u}return(0,ku.Z)(e,[{key:"release",value:function(){this.samplerData=null,this.bounds=null}},{key:"computeMinMaxValue",value:function(e,t,r,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;var i=e-this.level;if(i<=0)return n;var a=Math.pow(2,i);if(Math.floor(t/a)!==this.i||Math.floor(r/a)!==this.j)return n;var o=1/0,s=-1/0,l=this.samplerData.width,u=this.samplerData.pixelData,c=.5*zh,h=(l-1)/a,d=(r-this.j*a)*h,f=(t-this.i*a)*h;if(h<1){var p=Math.floor(d),v=Math.floor(f),m=p+v*l,y=u[m],g=u[m+1],_=u[m+l],b=u[m+l+1];if(y+g+_+b<c){var x=d-p,w=f-v,T=(0,qu.T)(y,g,_,b,x,w),C=(0,qu.T)(y,g,_,b,x+h,w),S=(0,qu.T)(y,g,_,b,x,w+h),O=(0,qu.T)(y,g,_,b,x+h,w+h);return n.min=Math.min(T,C,S,O),n.max=Math.max(T,C,S,O),n}d=p,f=v,h=1}else d=Math.floor(d),f=Math.floor(f),h=Math.ceil(h);for(var P=d;P<=d+h;P++)for(var R=f;R<=f+h;R++){var A=u[P+R*l];A<c?(o=Math.min(o,A),s=Math.max(s,A)):n.hasNoDataValues=!0}return n.min=o,n.max=s,n}}]),e}(),pz=.5*zh;function vz(e,t,r){if((0,Nu.t)(r))return null;var n,i=(0,Cu.Z)(r);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a){var o=a.safeWidth,s=(0,Vu.a)(a.dy*(a.y1-t),0,o),l=(0,Vu.a)(a.dx*(e-a.x0),0,o),u=Math.floor(s),c=Math.floor(l),h=a.width,d=u*h+c,f=a.pixelData,p=f[d],v=f[d+1],m=d+h,y=f[m],g=f[m+1];if(p+y+v+g<pz){var _=p+(v-p)*(l-=c);return _+(y+(g-y)*l-_)*(s-=u)}}}}catch(b){i.e(b)}finally{i.f()}return null}var mz=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add([this.layerViews.on("change",(function(){return e.notifyChange("stencilEnabledExtents")}))])}},{key:"destroy",value:function(){this._handles.destroy(),this._handles=null}},{key:"layerViewsExtent",get:function(){return this._computeLayerViewsExtent()}},{key:"tiledLayersExtent",get:function(){return this._computeTiledLayersExtent()}},{key:"stencilEnabledExtents",get:function(){return this._computeStencilEnabledExtents()}},{key:"_computeStencilEnabledExtents",value:function(){var e=this,t=[];return this.layerViews.forEach((function(r){var n=r.layer;if("IntegratedMeshLayer"===n.operationalLayerType&&null!=e.viewSpatialReference){var i=bz(n.fullExtent,e.viewSpatialReference);(0,Nu.r)(i)&&t.push((0,ju.c)(i))}})),t}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({readOnly:!0})],mz.prototype,"layerViewsExtent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],mz.prototype,"tiledLayersExtent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],mz.prototype,"stencilEnabledExtents",null),(0,Eu.e)([(0,Eu.y)()],mz.prototype,"viewSpatialReference",void 0),(0,Eu.e)([(0,Eu.y)()],mz.prototype,"tilingScheme",void 0),(0,Eu.e)([(0,Eu.y)()],mz.prototype,"defaultTiledLayersExtent",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],mz.prototype,"layers",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],mz.prototype,"layerViews",void 0);var yz=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_computeLayerViewsExtent",value:function(){return this._globalExtent}},{key:"_computeTiledLayersExtent",value:function(){return this._globalExtent}},{key:"_globalExtent",get:function(){return this.viewSpatialReference.isWebMercator?Uh:Vh}}]),r}(mz=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.ExtentHelper")],mz));yz=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.ExtentHelperGlobal")],yz);var gz,_z=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_computeLayerViewsExtent",value:function(){var e=(0,ju.D)(),t=this.viewSpatialReference;this.layerViews.forEach((function(r){var n=r.layer;if(r.isResolved()&&("graphics"!==n.type||!n.internal)){var i=bz("fullExtentInLocalViewSpatialReference"in r&&r.fullExtentInLocalViewSpatialReference||r.layer.fullExtent,t);(0,ju.h)(e,i,e)}}));var r=(0,ju.M)(e)?e:null,n=this._get("layerViewsExtent");return(0,ju.I)(r,n)?n:r}},{key:"_computeTiledLayersExtent",value:function(){var e=this.tilingScheme;if(!e)return null;var t=this.viewSpatialReference,r=(0,ju.D)();this.layers.forEach((function(n){if(n.loaded&&(0,$u.t)(n)){var i=hF(n,t,ic.l.Local);if((0,Nu.t)(i))return;var a=i.tileInfo,o=i.fullExtent;(0,Nu.r)(a)&&(0,Nu.r)(o)&&(KN(n)||e.compatibleWith(a)&&o.spatialReference.equals(e.spatialReference))&&(0,ju.h)(r,o,r)}})),(0,ju.h)(r,this.defaultTiledLayersExtent,r);var n=(0,ju.M)(r)?r:null,i=this._get("tiledLayersExtent");return(0,ju.I)(n,i)?i:n}}]),r}(mz);function bz(e,t){return(0,Nu.r)(e)&&!e.spatialReference.equals(t)?(0,Hu.P)(e,e.spatialReference,t):e}_z=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.ExtentHelperLocal")],_z),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(gz||(gz={}));var xz=[gz.ELEVATION,gz.MAP];function wz(){var e,t=null===(e=globalThis.require)||void 0===e?void 0:e.modules;if(t)for(var r=0,n=Object.keys(t);r<n.length;r++){var i=n[r];-1!==i.search(".glsl")&&delete t[i]}}var Tz,Cz=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],Sz=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n._spatialReference=null,n._renderSR=null,n._overlaySREqualsRenderSR=!0,n._drapeSources=new Set,n._drapeTargets=new Set,n._placementDirty=!1,n._contentUpdated=!1,n._drawTexturesDirty=!1,n._drawTexturesAnimateDirty=!1,n._hasUnusedRenderTargets=!1,n._longitudeCyclical=null,n._latestOriginId=0,n._maxResolution=(0,Nu.h)("esri-mobile")?2048:4096,n._animationTimeLast=0,n}return(0,ku.Z)(r,[{key:"running",get:function(){return this._placementDirty&&(this._drapeSources.size>0||this._view.graphics.length>0||Ac.t.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this._view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return(0,Nu.r)(this._spatialReference)&&this._spatialReference.isGeographic&&!this._view.state.isLocal?(0,Xu.u)(this._spatialReference).metersPerDegree:1}},{key:"_view",get:function(){return this.surface.view}},{key:"suspended",get:function(){return this.surface.suspended}},{key:"updating",get:function(){return this.running||this.renderer.updating||this._contentUpdated}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"initialize",value:function(){var e,t=this,r=this._view;this.renderer=new dA({view:r,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=(0,qu.g)(this._view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(function(){t.setDrawTexturesDirty(),t.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(function(e){var t;return null===(t=r._stage)||void 0===t?void 0:t.renderView.setRenderParameters({hasOverlayWater:e})})),this.renderer.events.on("renders-occluded",(function(){t.setDrawTexturesDirty(),t.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(function(){return t.setDrawTexturesDirty()})),this.renderer.events.on("textures-disposed",(function(){return t.updateOverlayResult()})),(0,Fu.l)((function(){var e,t,n;return[null===(e=r.pointsOfInterest)||void 0===e?void 0:e.renderPointOfView,null===(t=r.pointsOfInterest)||void 0===t||null===(n=t.centerOnSurfaceFrequent)||void 0===n?void 0:n.location]}),(function(){return t.setPlacementDirty()})),(0,Fu.l)((function(){var e;return null===(e=r.state)||void 0===e?void 0:e.pixelRatio}),(function(){return t.setPlacementDirty()}),Fu.U),this.surface.on("elevation-change",(function(){return t.setPlacementDirty()})),r.on("resize",(function(){return t.setPlacementDirty()})),r.resourceController.scheduler.registerTask(bc.I.OVERLAY,this),r._stage.renderView.events.on("force-camera-for-screenshot",(function(e){t._updateOverlays(e,vc.N.BACKGROUND),t.renderer.hasOverlays&&t._drawOverlayTextures(t.renderer.overlays,vc.N.BACKGROUND,e)}))]),null===(e=r._stage)||void 0===e||e.renderView.setRenderParameters({renderOverlay:function(e){t._contentUpdated=!1,t.renderer.processSyncDrapeSources(),t.renderer.hasOverlays&&(t._dispatchAnimationUpdate(e),t._drawOverlayTextures(t.renderer.overlays,vc.N.UPDATE)),t._hasUnusedRenderTargets&&t._collectUnusedRenderTargetMemory()}})}},{key:"destroy",value:function(){this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),(0,Nu.r)(Tz)&&(Tz.hide(),Tz=null)}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"setSpatialReference",value:function(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;var t=this._view.renderSpatialReference;(0,Nu.r)(e)&&(0,Nu.r)(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Ec.i(-20037508.342787,20037508.342787):new Ec.i(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}},{key:"gpuMemoryUsage",get:function(){return this.renderer.gpuMemoryUsage}},{key:"registerDrapeSource",value:function(e,t,r){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);var n=this.renderer.createDrapeSourceRenderer(e,t,r);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),n}},{key:"registerGeometryDrapeSource",value:function(e){return this.registerDrapeSource(e,aA)}},{key:"_updateDrapeSourceExtent",value:function(e){2===this.renderer.overlays.length&&(0,Nu.r)(e.setDrapingExtent)&&(0,Nu.r)(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}},{key:"unregisterDrapeSource",value:function(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}},{key:"registerDrapeTarget",value:function(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}},{key:"updateOverlayResult",value:function(){var e;null===(e=this._view._stage)||void 0===e||e.renderView.setRenderParameters({overlays:this.renderer.overlays})}},{key:"unregisterDrapeTarget",value:function(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}},{key:"_setContentDirty",value:function(){this.setPlacementDirty(),this.setDrawTexturesDirty()}},{key:"setPlacementDirty",value:function(){this._placementDirty=!0}},{key:"runTask",value:function(){this._updateOverlays(this._view.state.camera,vc.N.UPDATE)}},{key:"_updateOverlays",value:function(e,t){var r=this;if(this._spatialReference){var n=function(e,t,r){return Math.min((0,Vu.a8)(Math.max(e,t)+256),r)}(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,n,Az);var i=(0,ju.s)(Az.inner)/(0,ju.s)(Az.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);var a=this._updateOverlay(GS.INNER,Az.inner,n,1*Az.pixelRatioAdjustment,Az.mapUnitsPerPixel),o=this._updateOverlay(GS.OUTER,Az.outer,n,i*Az.pixelRatioAdjustment,Az.mapUnitsPerPixel);a!==Oz.EXTENT&&o!==Oz.EXTENT||(this._drapeSources.forEach((function(e){return r._updateDrapeSourceExtent(e)})),this.surface.updateTileOverlayParams(t)),a===Oz.NONE&&o===Oz.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1}}},{key:"_updateOverlay",value:function(e,t,r,n,i){if(0===this.renderer.overlays.length)return Oz.NONE;var a=this.renderer.overlays[e],o=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=i,a.pixelRatio=n,function(e,t){var r=1e-5,n=Ac.t.TESTS_DISABLE_OPTIMIZATIONS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=n&&Math.abs(t[1]-e[1])<=n&&Math.abs(t[2]-e[2])<=n&&Math.abs(t[3]-e[3])<=n}(t,a.extent)&&r===a.resolution)return o===i?Oz.NONE:Oz.RERENDER_ONLY;(0,ju.a)(a.extent,t),a.resolution=r;var s=(0,ju.p)(a.extent);return a.renderLocalOrigin=$S(s[0],s[1],0,"OV_"+this._latestOriginId++),Oz.EXTENT}},{key:"setTileParameters",value:function(e){var t=e.renderData.overlay;if(this.renderer.overlays.length>0){var r=this.renderer.overlays[GS.INNER],n=this.renderer.overlays[GS.OUTER],i=e.extent;this._rectInsideRect(r.extent,i)||this._rectanglesOverlap(i,r.extent)||this._rectanglesOverlap(i,n.extent)?(this._setTileOverlayData(i,GS.INNER,t),this._setTileOverlayData(i,GS.OUTER,t)):(this._clearTileOverlayData(GS.INNER,t),this._clearTileOverlayData(GS.OUTER,t))}else this._clearTileOverlayData(GS.INNER,t),this._clearTileOverlayData(GS.OUTER,t)}},{key:"overlayPixelSizeInMapUnits",value:function(e){if(0===this.renderer.overlays.length)return 0;var t=this.renderer.overlays[GS.INNER],r=this.renderer.overlays[GS.OUTER],n=this._pointIsInExtent(e,t.extent)?t:r;return(n.extent[2]-n.extent[0])/n.resolution}},{key:"_setTileOverlayData",value:function(e,t,r){if(0!==this.renderer.overlays.length){var n=this.renderer.overlays[t].extent,i=(0,ju.s)(n),a=(0,ju.l)(n),o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(n[0],o);var s=this._longitudeCyclical.minimalMonotonic(n[0],e[2]);o>s&&(o=s-(e[2]-e[0]))}r.setScale(t,(0,ju.s)(e)/i,(0,ju.l)(e)/a),r.setOffset(t,(o-n[0])/i,(e[1]-n[1])/a)}}},{key:"_clearTileOverlayData",value:function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}},{key:"reloadShaders",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wz(),e.next=3,this.renderer.reloadShaders();case 3:this.setDrawTexturesDirty(),this.runTask();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_dispatchAnimationUpdate",value:function(e){var t=(0,Eu.aj)(e-this._animationTimeLast);e=(0,Nu.v)(this._view.state.forcedAnimationTime,e),(t>=this.surface.view._stage.renderView.animationTimestep||(0,Nu.r)(this._view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty)&&(this.renderer.updateAnimation({time:e,camera:this._view.state.camera})&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e)}},{key:"setDrawTexturesDirty",value:function(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this._view._stage.renderView.requestRender()):this.setPlacementDirty()}},{key:"_intersectGroundFromView",value:function(e,t,r,n){var i=this._view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Dz,t,r);if((0,Nu.t)(i))return!1;var a=i.origin,o=(0,Vu.u)(Rz,i.origin,i.direction);return this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([],null),this._view.basemapTerrain.intersect(this._groundIntersector,null,a,o),this._groundIntersector.results.min.getIntersectionPoint(n)}},{key:"_findHorizonBasedPointOfInterest",value:function(e,t){var r=.5,n=.55,i=this._view.renderCoordsHelper.getAltitude(e.eye),a=this._view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,s=(0,Vu.a)(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:i+o,e.aboveGround?i-o:1/0),l=e.aboveGround;if("global"===this._view.viewingMode){var u=Rz;(0,Qu.Y)((0,Qu.O)(Qu.W,(0,Xu.u)(this._view.spatialReference).radius+s),(0,Qu.p)(e.eye,e.viewForward),u),(0,Vu.e)(u,u,e.eye);var c=Ec.r.normalize((0,Qu.i)(e.viewForward,u,e.viewRight))/e.fovY+.5,h=c<=0||c>=1?.5:n;r=l?h*c:c+h*(1-c)}else{var d=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(d),p=(0,lc.r)(0,f,1,0),v=(0,Vu.w)(p,p,e.projectionMatrix)[1],m=(0,Vu.a)(.5+.5*v,0,1);r=1===m||0===m?.5:l?m*n:1-(1-m)*n}return!!this._intersectGroundFromView(e,.5,r,t)&&(0,Vu.a3)(t,e.eye)<a.distance*a.distance}},{key:"_computeOverlayExtents",value:function(e,t,r){var n=this._view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i=(0,Vu.n)();this._findHorizonBasedPointOfInterest(e,i)||(0,Vu.r)(i,n);var a=Math.max(.1,(0,Vu.x)(e.eye,i)),o=Gm(this._view.renderCoordsHelper,n,e.eye),s=Math.PI/2-Math.abs(o-Math.PI/2);Ac.t.OVERLAY_SHOW_CENTER?((0,Nu.t)(Tz)&&(Tz=new DF(this._view.graphics,"red")),Tz.show(i,this._renderSR)):(0,Nu.r)(Tz)&&Tz.hide(),this._overlaySREqualsRenderSR||(0,Hu.j)(i,this._renderSR,i,this._spatialReference);var l=this.surface.extent,u=!this._isSpherical&&(0,Nu.r)(this._spatialReference)&&this._spatialReference.isGeographic,c=u&&(0,Nu.r)(this._spatialReference)?1/(0,Xu.u)(this._spatialReference).metersPerDegree:1,h=e.perRenderPixelRatio*a*c;r.mapUnitsPerPixel=h/this._worldToPCSRatio;var d=t*h/2,f=!1,p=u?90:1/0;this._isSpherical&&(0,Nu.r)(l)&&(0,Nu.r)(this._spatialReference)&&(this._spatialReference.isWebMercator?(d/=Math.cos((0,Yu.l)(i[1])),p=l[3]):(f=!0,d/=(0,Xu.u)(this._spatialReference).metersPerDegree,p=90),d>=p&&(d=p,i[1]=0,this._spatialReference.isWebMercator&&(i[0]=0)));var v=1;f&&(d*(v=1/Math.max(.2,Math.cos(Math.abs((0,Vu.m)(i[1])))))>180&&(v=180/d),r.mapUnitsPerPixel*=v);var m=Math.log(2)/12,y=(d=Math.exp(Math.round(Math.log(d)/m)*m))*v,g=.5*t/(32*y),_=.5*t/(32*d);i[0]=Math.round(i[0]*g)/g,i[1]=Math.round(i[1]*_)/_;var b=r.inner;b[0]=i[0]-y,b[1]=i[1]-d,b[2]=i[0]+y,b[3]=i[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,p);var x=r.outer;if(6*y>(0,ju.s)(l))(0,ju.a)(x,(0,Nu.e)(l));else if(s<=.25*Math.PI)x[0]=b[0]-y,x[1]=b[1]-d,x[2]=b[2]+y,x[3]=b[3]+d;else{(0,Hu.j)(e.eye,this._renderSR,Rz,this._spatialReference),(0,uc.o)(Pz,i,Rz);var w=-Math.atan2(Pz[1],Pz[0])+.125*Math.PI;w<0&&(w+=2*Math.PI);var T=Math.floor(w/(.25*Math.PI));(0,Vu.G)(Pz,Cz[T],2*d),Pz[0]*=v,Pz[2]*=v,(0,Vu.D)(x,b,Pz)}if(this._isSpherical)x[0]=this._longitudeCyclical.clamp(x[0]),x[2]=this._longitudeCyclical.clamp(x[2]),x[1]=Math.max(x[1],-p),x[3]=Math.min(x[3],p);else{var C=(0,ju.U)(b,l,kz),S=(0,ju.U)(x,l,Ez);(0,ju.R)(C,S)&&(x[2]=x[0],x[3]=x[1])}var O=Math.abs(b[2]-b[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,O),r.pixelRatioAdjustment=r.mapUnitsPerPixel/O}},{key:"_drawOverlayTextures",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._view.state.camera;if(0!==e.length&&(this._drawTexturesDirty||this._drawTexturesAnimateDirty)){var n=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;var i=this._drawOverlay(e[GS.INNER],r),a=this._drawOverlay(e[GS.OUTER],r);i!==vc.c.CHANGED&&a!==vc.c.CHANGED||this.surface.updateTileOverlayParams(vc.N.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),n?(this.surface.requestRender(t),t===vc.N.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(vc.N.BACKGROUND)}}},{key:"_drawOverlay",value:function(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}},{key:"_collectUnusedRenderTargetMemory",value:function(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){var e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}},{key:"_rectanglesOverlap",value:function(e,t){return!(0,Nu.t)(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,ju.E)(e,t))}},{key:"_rectInsideRect",value:function(e,t){return!(0,Nu.t)(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,ju.R)(e,t))}},{key:"_pointIsInExtent",value:function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var r=e.x,n=e.y;return r>t[0]&&r<t[2]&&n>t[1]&&n<t[3]}},{key:"_shiftExtentToFitBounds",value:function(e,t,r){var n=0,i=0;e[0]<-t?n=e[0]+t:e[2]>t&&(n=t-e[2]),e[1]<-r?i=e[1]+r:e[3]>r&&(i=r-e[3]),(0,ju.z)(e,n,i)}},{key:"test",get:function(){var e=this;return{renderer:this.renderer,update:function(){return e.runTask()}}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"_spatialReference",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],Sz.prototype,"running",null),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"_placementDirty",void 0),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"_contentUpdated",void 0),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"_isSpherical",null),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"_worldToPCSRatio",null),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"renderer",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],Sz.prototype,"surface",void 0),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"suspended",null),(0,Eu.e)([(0,Eu.y)()],Sz.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({type:Boolean})],Sz.prototype,"hasHighlights",null),(0,Eu.e)([(0,Eu.y)({type:Boolean})],Sz.prototype,"rendersOccluded",null),Sz=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.OverlayManager")],Sz);var Oz,Pz=(0,lc.n)(),Rz=(0,Vu.n)(),Az={inner:(0,ju.u)(),outer:(0,ju.u)(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},kz=(0,ju.u)(),Ez=(0,ju.u)(),Dz=(0,Qu.d)();!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Oz||(Oz={}));var Mz=function(){function e(t,r){(0,Au.Z)(this,e),this._factoryCallback=t,this._lengthCallback=r,this._pool=new Map}return(0,ku.Z)(e,[{key:"acquire",value:function(t){if(!e.test.disabled){var r=this._pool.get(t);if(r&&0!==r.length)return r.pop()}try{return this._factoryCallback(t)}catch(qW){var n=window.performance&&window.performance.memory,i="";throw n&&(i="\n  totalJSHeapSize: ".concat(n.totalJSHeapSize,", usedJSHeapSize: ").concat(n.usedJSHeapSize,", jsHeapSizeLimit: ").concat(n.jsHeapSizeLimit)),console.log("Array allocation of size "+t+" failed: "+qW+i),qW}}},{key:"release",value:function(t){if(!e.test.disabled){var r=this._lengthCallback(t),n=this._pool.get(r);n||(n=new Eu.a6({shrink:!0}),this._pool.set(r,n)),n.push(t)}}},{key:"clear",value:function(){this._pool.clear()}},{key:"test",get:function(){return{size:this._pool.size}}}]),e}();Mz.test={disabled:!1};var Iz=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.indices=null,this.vertexAttributes=null,this.boundingBox=(0,Gc.A)(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]})),Lz=function(){function e(t,r,n,i,a){(0,Au.Z)(this,e),this.attributes=t,this.localOrigin=r,this.index0=n,this.stride=i,this.count=a}return(0,ku.Z)(e,[{key:"getVertexIndex",value:function(e){return this.getAttributeIndex(e)}},{key:"getAttributeIndex",value:function(e){return YN(0<=e&&e<this.count),this.index0+this.stride*e}},{key:"_getVertexRaw",value:function(e,t){this.attributes.position.getVec(e,t)}},{key:"_getNormalRaw",value:function(e,t){this.attributes.normalCompressed.getVec(e,t)}},{key:"getVertexPos",value:function(e,t){this._getVertexRaw(this.getAttributeIndex(t),e),(0,Vu.u)(e,e,this.localOrigin)}},{key:"getNormal",value:function(e,t){var r=(0,cc.n)();this._getNormalRaw(this.getAttributeIndex(t),r),function(e,t){var r=Bz(t[0]),n=Bz(t[1]),i=1-Math.abs(r)-Math.abs(n);e[2]=i,i<0?(e[0]=(r>=0?1:-1)*(1-Math.abs(n)),e[1]=(n>=0?1:-1)*(1-Math.abs(r))):(e[0]=r,e[1]=n),(0,Vu.z)(e,e)}(e,r)}},{key:"_setNormal",value:function(e,t,r,n){zz(this.attributes.normalCompressed,e,t,r,n)}},{key:"_setUV",value:function(e,t,r){Uz(this.attributes.uv0,e,t,r)}},{key:"setNormalFromValues",value:function(e,t,r,n){this._setNormal(this.getAttributeIndex(e),t,r,n)}},{key:"setVertexFromValuesRawPositionUV",value:function(e,t,r,n,i,a){var o=this.getAttributeIndex(e);this.attributes.position.setValues(o,t,r,n),this._setUV(o,i,a)}},{key:"setVertexFromValuesRawPositionUVNormal",value:function(e,t,r,n,i,a,o,s,l){var u=this.getAttributeIndex(e);this.attributes.position.setValues(u,t,r,n),this._setUV(u,i,a),this._setNormal(u,o,s,l)}}]),e}(),Zz=(0,wc.T)().vec3f(fc.O.POSITION).vec2i16(fc.O.UV0).vec2i16(fc.O.NORMALCOMPRESSED,{glNormalized:!0}),Nz=new Mz((function(e){return Zz.createBuffer(e)}),(function(e){return e.count}));function Fz(e){return Nz.acquire(e)}function zz(e,t,r,n,i){var a=1/(Math.abs(r)+Math.abs(n)+Math.abs(i)),o=r*a,s=n*a,l=i<=0?(o>=0?1:-1)*(1-Math.abs(s)):o,u=i<=0?(s>=0?1:-1)*(1-Math.abs(o)):s;e.setValues(t,Vz(l),Vz(u))}function Uz(e,t,r,n){e.setValues(t,16384*r,16384*n)}function Vz(e){return(0,Vu.a)(Math.round(32767*e),-32767,32767)}function Bz(e){return(0,Vu.a)(e/32767,-1,1)}function Gz(e,t,r,n){e<n[0]?n[0]=e:e>n[3]&&(n[3]=e),t<n[1]?n[1]=t:t>n[4]&&(n[4]=t),r<n[2]?n[2]=r:r>n[5]&&(n[5]=r)}var Hz,jz=function(){function e(){(0,Au.Z)(this,e),this.sinLonLUT=new Array(513),this.cosLonLUT=new Array(513),this.sinLatLUT=new Array(513),this.cosLatLUT=new Array(513)}return(0,ku.Z)(e,[{key:"update",value:function(e,t,r){for(var n=t[0],i=t[2],a=0;a<=e;a++){var o=a/e,s=n*(1-o)+i*o;this.sinLonLUT[a]=Math.sin(s),this.cosLonLUT[a]=Math.cos(s);var l=r(o);this.sinLatLUT[a]=Math.sin(l),this.cosLatLUT[a]=Math.cos(l)}}}]),e}(),qz=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]})),Wz=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.cornerNeighborData=[new qz,new qz,new qz,new qz],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]})),Xz=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new Wz})),Yz=function(){function e(t){(0,Au.Z)(this,e),this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}return(0,ku.Z)(e,[{key:"clear",value:function(){this._current=(0,Nu.g)(this._current),this._next=(0,Nu.g)(this._next),this._waiting=(0,Nu.g)(this._waiting),this._delayed=(0,Nu.g)(this._delayed)}},{key:"current",get:function(){if((0,Nu.t)(this._current))return null;if(!this._isFadingEnabled){var t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}var r=e.test.fadeMoment;if((0,Nu.r)(this._delayed)&&((r=r||performance.now())>=this._delayedTime&&(this._push(this._delayed,Hz.Immediate),this._delayed=null)),(0,Nu.r)(this._next)){r=r||performance.now();var n=this._fadeDuration,i=(0,Nu.r)(this._current)&&this._next.texture===this._current.texture,a=this._next.type!==XS.FADING,o=r-this._fadeStart>=n;(i||a||o)&&((0,Nu.g)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(r))}return this._current}},{key:"next",get:function(){return this._next}},{key:"fadeFactor",get:function(){if((0,Nu.t)(this._next))return 1;var t=e.test.fadeMoment||performance.now(),r=Math.max(0,t-this._fadeStart),n=this._fadeDuration;return r>n?0:1-r/n}},{key:"isFading",get:function(){return(0,Nu.r)(this._next)||(0,Nu.r)(this._delayed)}},{key:"push",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Hz.Immediate;this._delayed=(0,Nu.g)(this._delayed),this._push(e,t)}},{key:"_push",value:function(t,r){if(this._isFadingEnabled||this.clear(),!(0,Nu.t)(this._current)){var n=e.test.fadeMoment||performance.now();return r!==Hz.Immediate?(this._delayed=t,void(this._delayedTime=n+r)):(0,Nu.t)(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(n))):void((0,Nu.t)(t)||((0,Nu.g)(this._waiting),this._waiting=t))}this._current=t}},{key:"_fadeDuration",get:function(){return(0,Nu.t)(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}},{key:"_alignFadeStart",value:function(e){var t=this._getFadeDuration();return e+t-e%t}},{key:"_isFadingEnabled",get:function(){return this._getFadeDuration()>0}}]),e}();Yz.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Hz||(Hz={}));var Qz=function(){function e(){(0,Au.Z)(this,e),this._queue=new Eu.a6,this._last=null,this.remove=function(){}}return(0,ku.Z)(e,[{key:"done",get:function(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}},{key:"resetOne",value:function(e){this._queue.clear(),this._queue.push(e),this._last=null}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),(0,Nu.r)(e)&&this._queue.pushArray(e),this._last=null}},{key:"skipSubtree",value:function(){this._last=null}},{key:"next",value:function(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}]),e}(),Kz=function(){function e(){(0,Au.Z)(this,e),this._q=new Eu.a6}return(0,ku.Z)(e,[{key:"done",get:function(){return 0===this._q.length}},{key:"reset",value:function(e){if(this._q.clear(),!(0,Nu.t)(e)){this._q.pushArray(e);for(var t=0;t<this._q.length;++t){var r=this._q.data[t];r.isLeaf||this._q.pushArray(r.children)}}}},{key:"next",value:function(){return this._q.pop()}}]),e}();function Jz(e,t,r){if((0,Nu.t)(t)||(0,Nu.t)(t.fullExtent))return!1;var n=t.fullExtent,i=e.extent;if(r){if(i[0]<n.xmin||i[1]<n.ymin||i[2]>n.xmax||i[3]>n.ymax)return!1}else if(n.xmin>i[2]||n.ymin>i[3]||n.xmax<i[0]||n.ymax<i[1])return!1;var a=e.surface.tilingScheme.levels[e.level].scale;return!(t.minScale>0&&a>1.00000001*t.minScale)&&!(t.maxScale>0&&a<.99999999*t.maxScale)}function $z(e,t){return e.lij[0]-t.lij[0]||e.lij[1]-t.lij[1]||e.lij[2]-t.lij[2]}function eU(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,Nu.t)(r)||0===r.length?t.sort((function(t,r){return tU(t,r,e)})):t.sort((function(t,n){return rU(t,n,e,r)}))}function tU(e,t,r){var n=e.screenDepth,i=t.screenDepth;return n<i?-r:n>i?r:$z(e,t)}function rU(e,t,r,n){return nU(e,n)===nU(t,n)?tU(e,t,r):e?r:-r}function nU(e,t){var r,n=(0,Cu.Z)(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(e.intersectsExtent(i))return!0}}catch(a){n.e(a)}finally{n.f()}return!1}function iU(e,t){if(!e||!t||e[0]===t[0])return!1;var r=e[0]<t[0],n=r?e:t,i=r?t:e,a=1<<i[0]-n[0];return Math.floor(i[1]/a)===n[1]&&Math.floor(i[2]/a)===n[2]}var aU,oU,sU=function(){function e(){(0,Au.Z)(this,e)}return(0,ku.Z)(e,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"init",value:function(e,t,r,n){this.tile=e,this._layerIdx=t,this._layerClass=r,this._suspended=n,this._tileLayerInfo=e.getLayerInfo(t,r),this._tileRequested=null;var i=this._findAncestorWithData();this._setUpsampleTile(i)}},{key:"startLoading",value:function(){return this._requestNext()}},{key:"dispose",value:function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}},{key:"setSuspension",value:function(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}},{key:"update",value:function(){var e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}},{key:"dataArrived",value:function(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,XS.FADING):this._requestNext()}},{key:"dataMissing",value:function(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}},{key:"_agentDone",value:function(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}},{key:"_requestNext",value:function(){if(this._suspended)return!0;var e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return(0,Nu.r)(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}},{key:"_findNextDownload",value:function(){for(var e,t=this._layerIdx,r=this._layerClass,n=this.tile.surface.layerViewByIndex(t,r),i=QN(n),a=n.dataLevelRange,o=a.minLevel,s=a.maxLevel,l=this._desiredMinLevelDelta,u=this._progressiveLevelModulo+l,c=this._scaleRangeEnabled?Jz:function(){return!0},h=this.tile,d=h.level,f=this._tileLayerInfo.upsampleInfo,p=(0,Nu.r)(f)?f.tile.level:-1,v=!!(0,Nu.r)(f)&&p-d>=l,m=(0,Nu.q)(i,"tilemapCache");h&&c(h,i,!1)&&h.level>=o;){var y=h.level,g=d-y,_=h.layerInfo[r][t];if(_.data&&g>=l){(!v||y>p)&&this._setUpsampleTile(h),_.dataInvalidated&&(e=h);break}if(((0,Nu.t)(m)||"unavailable"!==m.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&y<=s&&!_.data&&!_.dataMissing&&(((0,Nu.t)(e)||h.level===o||y%4==0||d-e.level<l)&&(e=h),g>=u))break;h=h.parent}return(0,Nu.r)(e)&&d-e.level<l&&this._tileLayerInfo.upsampleInfo&&(e=null),e}},{key:"_findAncestorWithData",value:function(){for(var e,t=this.tile.vlevel,r=this._desiredMinLevelDelta,n=this.tile;n;n=n.parent)if(n.hasLayerData(this._layerIdx,this._layerClass)){if(t-n.level>=r)return n;e=n}return e}},{key:"_setUpsampleTile",value:function(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,XS.FADING)}},{key:"test",get:function(){var e=this;return{findNextDownload:function(){return e._findNextDownload()},tileLayerInfo:this._tileLayerInfo}}}]),e}(),lU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"_desiredMinLevelDelta",get:function(){throw uU}},{key:"_progressiveLevelModulo",get:function(){throw uU}},{key:"dispose",value:function(){}}]),r}(sU),uU=new Error("Abstract method called on TileAgent"),cU=new lU,hU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._scaleRangeEnabled=!1,e}return(0,ku.Z)(r,[{key:"_desiredMinLevelDelta",get:function(){return Bh(this.tile.level)-(this.tile.vlevel-this.tile.level)}},{key:"_progressiveLevelModulo",get:function(){return 0}}]),r}(sU),dU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.call(this))._scaleRangeEnabled=!0,e}return(0,ku.Z)(r,[{key:"_desiredMinLevelDelta",get:function(){return 0}},{key:"_progressiveLevelModulo",get:function(){return 4}}]),r}(sU);function fU(e,t){e.fragment.uniforms.add([new dc.h("u_colormap",(function(e){return e.u_colormap})),new dc.g("u_colormapOffset",(function(e){return e.colormap.u_colormapOffset})),new dc.g("u_colormapMaxIndex",(function(e){return e.colormap.u_colormapMaxIndex})),new dc.g("u_opacity",(function(e){return e.common.u_opacity}))]),e.fragment.code.add((0,dc.n)(xi||(xi=(0,wu.Z)(["\n    vec4 colormap(vec4 currentPixel, bool isFloat) {\n      float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;\n      vec4 result;\n      // handle no data and out of range pixels\n      if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {\n        result = vec4(0.0, 0.0, 0.0, 0.0);\n      } else {\n        // colormap lookup\n        vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);\n        result = ",";\n      }\n      return result;\n    }\n  "])),(0,dc._)(t,"u_colormap","texelCoordinates","(1.0 / vec2(u_colormapMaxIndex + 1.0, 1.0))")))}function pU(e,t){e.fragment.uniforms.add((0,dc.Z)("u_transformGrid",(function(e){return e.u_transformGrid}),t.hasWebGL2Context?dc.$.None:dc.$.InvSize)),e.fragment.uniforms.add(new dc.b("u_transformSpacing",(function(e){return e.common.u_transformSpacing}))),e.fragment.uniforms.add(new dc.b("u_targetImageSize",(function(e){return e.common.u_targetImageSize}))),e.fragment.code.add((0,dc.n)(wi||(wi=(0,wu.Z)(["\n    vec2 projectPixelLocation(vec2 coords) {\n      // Pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]\n      vec2 index_image = floor(coords * u_targetImageSize);\n\n      // Pixel's corresponding cell index in transform grid\n      // Each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle\n      vec2 oneTransformPixel = vec2(4.0, 1.0);\n      vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;\n\n      // Correspoding position in transform grid cell, cell center coordinates\n      vec2 pos = fract((index_image + 0.5) / u_transformSpacing);\n\n      // Pixel's corresponding transform cell location, cell center coordinates\n      vec2 transform_location = index_transform + 0.5;\n\n      vec2 srcLocation;\n\n      // Use lower triangle or upper triangle\n      if (pos.s <= pos.t) {\n        vec3 ll_abc = ",".rgb;\n        vec3 ll_def = ",".rgb;\n        srcLocation.s = dot(ll_abc, vec3(pos, 1.0));\n        srcLocation.t = dot(ll_def, vec3(pos, 1.0));\n      } else {\n        vec3 ur_abc = ",".rgb;\n        vec3 ur_def = ",".rgb;\n        srcLocation.s = dot(ur_abc, vec3(pos, 1.0));\n        srcLocation.t = dot(ur_def, vec3(pos, 1.0));\n      }\n\n      return srcLocation;\n    }\n  "])),(0,dc._)(t,"u_transformGrid","transform_location"),(0,dc._)(t,"u_transformGrid","vec2(transform_location.s + 1.0, transform_location.t)"),(0,dc._)(t,"u_transformGrid","vec2(transform_location.s + 2.0, transform_location.t)"),(0,dc._)(t,"u_transformGrid","vec2(transform_location.s + 3.0, transform_location.t)")))}!function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(aU||(aU={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(oU||(oU={}));var vU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).scale=1,e.offset=cc.f,e}return(0,ku.Z)(r)}(dc.t);function mU(e){e.attributes.add(fc.O.POSITION,"vec2"),e.attributes.add(fc.O.UV0,"vec2"),e.vertex.uniforms.add(new dc.g("scale",(function(e){return e.scale}))),e.vertex.uniforms.add(new dc.b("offset",(function(e){return e.offset}))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add((0,dc.n)(Ti||(Ti=(0,wu.Z)(["void main(void) {\ngl_Position = vec4(position, 0.0, 1.0);\nuv = uv0 * scale + offset;\nvuv = uv0;\n}"]))))}var yU,gU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this)).common=e,a.u_image=n,a.u_transformGrid=i,a}return(0,ku.Z)(r)}(vU);function _U(e,t){e.include(pU,t),e.fragment.uniforms.add([new dc.h("u_image",(function(e){return e.u_image})),new dc.v("u_flipY",(function(e){return e.common.u_flipY})),new dc.v("u_applyTransform",(function(e){return e.common.u_applyTransform}))]),e.fragment.code.add((0,dc.n)(Ci||(Ci=(0,wu.Z)(["vec2 getPixelLocation(vec2 coords) {\nvec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;\nif (!u_applyTransform) {\nreturn targetLocation;\n}\nreturn projectPixelLocation(targetLocation);\n}\nbool isOutside(vec2 coords){\nif (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {\nreturn true;\n} else {\nreturn false;\n}\n}\nvec4 getPixel(vec2 pixelLocation) {\nreturn texture2D(u_image, pixelLocation);\n}"]))))}!function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(yU||(yU={}));var bU,xU,wU,TU={normal:yU.Normal,average:yU.Average,lighten:yU.Lighten,lighter:yU.Lighter,screen:yU.Screen,plus:yU.Plus,"color-dodge":yU.ColorDodge,darken:yU.Darken,multiply:yU.Multiply,"color-burn":yU.ColorBurn,overlay:yU.Overlay,"soft-light":yU.SoftLight,"hard-light":yU.HardLight,"vivid-light":yU.VividLight,hue:yU.Hue,saturation:yU.Saturation,luminosity:yU.Luminosity,color:yU.Color,difference:yU.Difference,exclusion:yU.Exclusion,minus:yU.Minus,invert:yU.Invert,reflect:yU.Reflect,"destination-over":yU.DestinationOver,"destination-atop":yU.DestinationAtop,"destination-in":yU.DestinationIn,"destination-out":yU.DestinationOut,"source-atop":yU.SourceAtop,"source-in":yU.SourceIn,"source-out":yU.SourceOut,xor:yU.Xor};function CU(e){return e===yU.DestinationOver||e===yU.DestinationAtop||e===yU.DestinationIn||e===yU.DestinationOut||e===yU.SourceAtop||e===yU.SourceIn||e===yU.SourceOut||e===yU.Xor}function SU(e){e.code.add((0,dc.n)(Si||(Si=(0,wu.Z)(["\n    float lineFactorAtPosition(float value) {\n      float pos = value * ",";\n      if(pos < 0.5 || pos > ",") {\n        return 1.0;\n      }\n\n      pos = pos + 0.5;\n      float modulo = mod(pos, 16.0);\n      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;\n    }\n\n    float lineFactorAtUV(vec2 uv) {\n      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));\n    }\n\n    float lineFactor(vec2 uv) {\n      vec2 offset = fwidth(uv) * 0.25;\n      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;\n    }\n\n    vec4 gridColor(vec2 uv) {\n      float line = lineFactor(uv) * 0.1 + 0.9;\n      return vec4(vec3(1.0, 0.972, 0.918) * line, 1.0);\n    }"])),dc.n.float(257),dc.n.float(256.5)))}function OU(e,t){var r=t.blendMode;r!==yU.Normal&&(r===yU.Reflect&&e.code.add((0,dc.n)(Oi||(Oi=(0,wu.Z)(["float reflectBlend(in float cb, in float cl) {\nreturn (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);\n}"])))),r!==yU.ColorDodge&&r!==yU.VividLight||e.code.add((0,dc.n)(Pi||(Pi=(0,wu.Z)(["float colorDodge(in float cb, in float cl) {\nreturn (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));\n}"])))),r!==yU.ColorBurn&&r!==yU.VividLight||e.code.add((0,dc.n)(Ri||(Ri=(0,wu.Z)(["float colorBurn(in float cb, in float cl) {\nreturn (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);\n}"])))),r===yU.Overlay&&e.code.add((0,dc.n)(Ai||(Ai=(0,wu.Z)(["float overlay(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);\n}"])))),r===yU.HardLight&&e.code.add((0,dc.n)(ki||(ki=(0,wu.Z)(["float hardLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));\n}"])))),r===yU.SoftLight&&e.code.add((0,dc.n)(Ei||(Ei=(0,wu.Z)(["float softLight(in float cb, in float cl) {\nif (cl <= 0.5) {\nreturn cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);\n}\nif (cb <= 0.25) {\nreturn cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);\n}\nreturn cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);\n}"])))),r===yU.VividLight&&e.code.add((0,dc.n)(Di||(Di=(0,wu.Z)(["float vividLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));\n}"])))),r!==yU.Hue&&r!==yU.Saturation&&r!==yU.Color&&r!==yU.Luminosity||(e.code.add((0,dc.n)(Mi||(Mi=(0,wu.Z)(["float minv3(in vec3 c) {\nreturn min(min(c.r, c.g), c.b);\n}\nfloat maxv3(in vec3 c) {\nreturn max(max(c.r, c.g), c.b);\n}\nfloat lumv3(in vec3 c) {\nreturn dot(c, vec3(0.3, 0.59, 0.11));\n}\nvec3 clipColor(vec3 color) {\nfloat lum = lumv3(color);\nfloat mincol = minv3(color);\nfloat maxcol = maxv3(color);\nif (mincol < 0.0) {\ncolor = lum + ((color - lum) * lum) / (lum - mincol);\n}\nif (maxcol > 1.0) {\ncolor = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);\n}\nreturn color;\n}\nvec3 setLum(vec3 cbase, vec3 clum) {\nreturn clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));\n}"])))),r!==yU.Hue&&r!==yU.Saturation||e.code.add((0,dc.n)(Ii||(Ii=(0,wu.Z)(["float satv3(vec3 c) {\nreturn maxv3(c) - minv3(c);\n}\nvec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)\n{\nfloat minbase = minv3(cbase);\nfloat sbase = satv3(cbase);\nfloat ssat = satv3(csat);\nreturn setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);\n}"]))))),e.code.add((0,dc.n)(Li||(Li=(0,wu.Z)(["\n    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {\n      ","\n    }\n  "])),r===yU.Multiply?(0,dc.n)(Zi||(Zi=(0,wu.Z)(["return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Average?(0,dc.n)(Ni||(Ni=(0,wu.Z)(["return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Lighten?(0,dc.n)(Fi||(Fi=(0,wu.Z)(["return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Darken?(0,dc.n)(zi||(zi=(0,wu.Z)(["return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Lighter?(0,dc.n)(Ui||(Ui=(0,wu.Z)(["return vec4(cl * ol + cb * ob, ol + ob);"]))):r===yU.Plus?(0,dc.n)(Vi||(Vi=(0,wu.Z)(["return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);"]))):r===yU.Minus?(0,dc.n)(Bi||(Bi=(0,wu.Z)(["return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);"]))):r===yU.Screen?(0,dc.n)(Gi||(Gi=(0,wu.Z)(["return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Difference?(0,dc.n)(Hi||(Hi=(0,wu.Z)(["return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Invert?(0,dc.n)(ji||(ji=(0,wu.Z)(["return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);"]))):r===yU.DestinationOver?(0,dc.n)(qi||(qi=(0,wu.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);"]))):r===yU.DestinationAtop?(0,dc.n)(Wi||(Wi=(0,wu.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);"]))):r===yU.DestinationOut?(0,dc.n)(Xi||(Xi=(0,wu.Z)(["return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));"]))):r===yU.SourceAtop?(0,dc.n)(Yi||(Yi=(0,wu.Z)(["return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);"]))):r===yU.SourceOut?(0,dc.n)(Qi||(Qi=(0,wu.Z)(["return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));"]))):r===yU.Xor?(0,dc.n)(Ki||(Ki=(0,wu.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));"]))):r===yU.DestinationIn?(0,dc.n)(Ji||(Ji=(0,wu.Z)(["return vec4(cb * ob * ol, ol * ob);"]))):r===yU.SourceIn?(0,dc.n)($i||($i=(0,wu.Z)(["return vec4(cl * ol * ob, ol * ob);"]))):r===yU.Hue?(0,dc.n)(ea||(ea=(0,wu.Z)(["\n          vec3 f = setLumSat(cl, cb, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Saturation?(0,dc.n)(ta||(ta=(0,wu.Z)(["\n          vec3 f = setLumSat(cb, cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Color?(0,dc.n)(ra||(ra=(0,wu.Z)(["\n          vec3 f = setLum(cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Luminosity?(0,dc.n)(na||(na=(0,wu.Z)(["\n          vec3 f = setLum(cb, cl);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Exclusion?(0,dc.n)(ia||(ia=(0,wu.Z)(["\n          vec3 f = cl + cb - 2.0 * cl * cb;\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Reflect?(0,dc.n)(aa||(aa=(0,wu.Z)(["\n          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.ColorDodge?(0,dc.n)(oa||(oa=(0,wu.Z)(["\n          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.ColorBurn?(0,dc.n)(sa||(sa=(0,wu.Z)(["\n          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.Overlay?(0,dc.n)(la||(la=(0,wu.Z)(["\n          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.SoftLight?(0,dc.n)(ua||(ua=(0,wu.Z)(["\n          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.HardLight?(0,dc.n)(ca||(ca=(0,wu.Z)(["\n          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):r===yU.VividLight?(0,dc.n)(ha||(ha=(0,wu.Z)(["\n          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):(0,dc.n)(da||(da=(0,wu.Z)([""]))))))}function PU(e,t){var r=t.output===bU.GridComposite,n=t.output===bU.ColorComposite,i=t.output===bU.GroupBackgroundComposite,a=t.output===bU.Composite;r&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(SU)),n&&e.fragment.uniforms.add(new dc.c("backgroundColor",(function(e){return e.backgroundColor})));var o=t.baseOpacityMode===xU.Required;if(o&&e.fragment.uniforms.add(new dc.g("baseOpacity",(function(e){return e.baseOpacity}))),a){var s=t.hasWebGL2Context?dc.$.None:dc.$.InvSize;e.fragment.uniforms.add((0,dc.Z)("fboColor",(function(e){return e.fboTexture}),s))}var l=t.blendMode!==yU.Normal,u=t.premultipliedSource===wU.On;e.fragment.include(OU,t),e.fragment.code.add((0,dc.n)(fa||(fa=(0,wu.Z)(["\n    vec4 getBackground(vec2 uv) {\n      return "," ",";\n    }\n\n    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {\n      ","\n    }"])),o?(0,dc.n)(pa||(pa=(0,wu.Z)(["baseOpacity *"]))):"",i?(0,dc.n)(va||(va=(0,wu.Z)(["vec4(0.0, 0.0, 0.0, 0.0)"]))):n?(0,dc.n)(ma||(ma=(0,wu.Z)(["vec4(backgroundColor, 1.0)"]))):r?(0,dc.n)(ya||(ya=(0,wu.Z)(["gridColor(uv)"]))):(0,dc.n)(ga||(ga=(0,wu.Z)(["",""])),(0,dc._)(t,"fboColor","gl_FragCoord.xy")),l?(0,dc.n)(_a||(_a=(0,wu.Z)(["\n          vec3 Cb = bgColor.a == 0.0 ? bgColor.rgb : vec3(bgColor.rgb * bgColor.a);\n          return applyBlendMode(colorLayer.rgb, colorLayer.a * opacity, Cb, bgColor.a);"]))):(0,dc.n)(ba||(ba=(0,wu.Z)(["\n          vec4 pmColorLayer = vec4(colorLayer.xyz, 1.0);\n          float composeAlpha = colorLayer.a * opacity;\n          return ",""])),u?(0,dc.n)(xa||(xa=(0,wu.Z)(["bgColor * (1.0 - composeAlpha) + colorLayer * opacity;"]))):a&&!o||i?(0,dc.n)(wa||(wa=(0,wu.Z)(["pmColorLayer * composeAlpha;"]))):(0,dc.n)(Ta||(Ta=(0,wu.Z)(["mix(bgColor, pmColorLayer, composeAlpha);"]))))))}!function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(bU||(bU={})),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(xU||(xU={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(wU||(wU={}));var RU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o,s){var l;return(0,Au.Z)(this,r),(l=t.call(this,e,a,o)).colormap=n,l.symbolizer=i,l.u_colormap=s,l.backgroundColor=Vu.a7,l.fboTexture=null,l.baseOpacity=1,l}return(0,ku.Z)(r)}(gU),AU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(RU),kU=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(RU);function EU(e){var t=new dc.o;return t.include(mU),t.include(_U,e),t.include(fU,e),t.include(PU,e),t.fragment.code.add((0,dc.n)(Ca||(Ca=(0,wu.Z)(["vec4 applyBackgroundBlend(vec4 layerColor) {\nvec4 bgColor = getBackground(vuv);\nreturn blendLayers(bgColor, layerColor, u_opacity);\n}"])))),e.colorizerType===aU.Stretch?function(e,t){e.fragment.uniforms.add([new dc.bd("u_bandCount",(function(e){return e.symbolizer.u_bandCount})),new dc.a6("u_minCutOff",(function(e){return e.symbolizer.u_minCutOff}),3),new dc.a6("u_maxCutOff",(function(e){return e.symbolizer.u_maxCutOff}),3),new dc.a6("u_factor",(function(e){return e.symbolizer.u_factor}),3),new dc.g("u_minOutput",(function(e){return e.symbolizer.u_minOutput})),new dc.g("u_maxOutput",(function(e){return e.symbolizer.u_maxOutput})),new dc.v("u_useGamma",(function(e){return e.symbolizer.u_useGamma})),new dc.a6("u_gamma",(function(e){return e.symbolizer.u_gamma}),3),new dc.a6("u_gammaCorrection",(function(e){return e.symbolizer.u_gammaCorrection}),3),new dc.g("u_opacity",(function(e){return e.common.u_opacity}))]),e.fragment.code.add((0,dc.n)(Oa||(Oa=(0,wu.Z)(["float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {\nif (val >= maxCutOff) {\nreturn maxOutput;\n} else if (val <= minCutOff) {\nreturn minOutput;\n}\nfloat stretchedVal;\nif (useGamma) {\nfloat tempf = 1.0;\nfloat outRange = maxOutput - minOutput;\nfloat relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);\nif (gamma > 1.0) {\ntempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);\n}\nstretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;\n} else {\nstretchedVal = minOutput + (val - minCutOff) * factor;\n}\nreturn stretchedVal;\n}"]))));var r=t.applyColormap?(0,dc.n)(Pa||(Pa=(0,wu.Z)(["gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));"]))):(0,dc.n)(Ra||(Ra=(0,wu.Z)(["gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));"])));e.fragment.code.add((0,dc.n)(Aa||(Aa=(0,wu.Z)(["\n      void main() {\n        vec2 pixelLocation = getPixelLocation(uv);\n        if (isOutside(pixelLocation)) {\n          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n\n        vec4 currentPixel = getPixel(pixelLocation);\n        ","\n      }"])),t.stretchType===oU.Noop?(0,dc.n)(ka||(ka=(0,wu.Z)(["\n        gl_FragColor = applyBackgroundBlend(currentPixel);"]))):(0,dc.n)(Ea||(Ea=(0,wu.Z)(["\n        if (currentPixel.a == 0.0) {\n          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n        if (u_bandCount == 1) {\n          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          ","\n        } else {\n          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);\n          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);\n          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));\n        }"])),r)))}(t,e):e.colorizerType===aU.Lut?function(e){e.fragment.code.add((0,dc.n)(Sa||(Sa=(0,wu.Z)(["void main() {\nvec2 pixelLocation = getPixelLocation(uv);\nif (isOutside(pixelLocation)) {\ngl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\nreturn;\n}\nvec4 currentPixel = getPixel(pixelLocation);\ngl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));\n}"]))))}(t):e.colorizerType===aU.Hillshade&&function(e,t){var r=e.fragment;r.uniforms.add([new dc.h("u_image",(function(e){return e.u_image})),new dc.bd("u_hillshadeType",(function(e){return e.symbolizer.u_hillshadeType})),new dc.a6("u_sinZcosAs",(function(e){return e.symbolizer.u_sinZcosAs}),6),new dc.a6("u_sinZsinAs",(function(e){return e.symbolizer.u_sinZsinAs}),6),new dc.a6("u_cosZs",(function(e){return e.symbolizer.u_cosZs}),6),new dc.a6("u_weights",(function(e){return e.symbolizer.u_weights}),6),new dc.b("u_factor",(function(e){return e.symbolizer.u_factor})),new dc.g("u_minValue",(function(e){return e.symbolizer.u_minValue})),new dc.g("u_maxValue",(function(e){return e.symbolizer.u_maxValue})),new dc.b("u_srcImageSize",(function(e){return e.common.u_srcImageSize}))]),r.include(dc.x),r.code.add((0,dc.n)(Da||(Da=(0,wu.Z)(["vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {\nval = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);\nvec3 hsv = rgb2hsv(colormap(vec4(val, val, val, 1.0), false).rgb);\nhsv.z = hillshade;\nreturn vec4(hsv2rgb(hsv) * alpha, alpha);\n}"])))),r.code.add((0,dc.n)(Ma||(Ma=(0,wu.Z)(["float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){\nif (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {\nreturn 0.0;\n}  else {\nreturn e;\n}\n}"]))));var n=t.applyColormap?(0,dc.n)(Ia||(Ia=(0,wu.Z)(["gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));"]))):(0,dc.n)(La||(La=(0,wu.Z)(["hillshade *= alpha;\ngl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));"])));r.code.add((0,dc.n)(Za||(Za=(0,wu.Z)(["\n    void main() {\n      vec2 pixelLocation = getPixelLocation(uv);\n      if (isOutside(pixelLocation)) {\n        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      vec4 currentPixel = getPixel(pixelLocation);\n      if (currentPixel.a == 0.0) {\n        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      //mirror edge pixels\n      vec2 axy = vec2(-1.0, -1.0);\n      vec2 bxy = vec2(0.0, -1.0);\n      vec2 cxy = vec2(1.0, -1.0);\n      vec2 dxy = vec2(-1.0, 0.0);\n      vec2 fxy = vec2(1.0, 0.0);\n      vec2 gxy = vec2(-1.0, 1.0);\n      vec2 hxy = vec2(0.0, 1.0);\n      vec2 ixy = vec2(1.0, 1.0);\n      vec2 onePixel = 1.0 / u_srcImageSize;\n      if (pixelLocation.s < onePixel.s) {\n        axy[0] = 1.0;\n        dxy[0] = 1.0;\n        gxy[0] = 1.0;\n      }\n      if (pixelLocation.t < onePixel.t) {\n        axy[1] = 1.0;\n        bxy[1] = 1.0;\n        cxy[1] = 1.0;\n      }\n      if (pixelLocation.s > 1.0 - onePixel.s) {\n        cxy[0] = -1.0;\n        fxy[0] = -1.0;\n        ixy[0] = -1.0;\n      }\n      if (pixelLocation.t > 1.0 - onePixel.t) {\n        gxy[1] = -1.0;\n        hxy[1] = -1.0;\n        ixy[1] = -1.0;\n      }\n\n      // calculate hillshade\n      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);\n      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);\n      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);\n      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);\n      vec4 ve = texture2D(u_image, pixelLocation);\n      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);\n      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);\n      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);\n      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);\n\n      // calculate the rate of z change along the x, y, and diagonal direction\n      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;\n      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;\n      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);\n      float hillshade = 0.0;\n\n      // traditional single light source\n      if (u_hillshadeType == 0){\n        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;\n        float z = (u_cosZs[0] + cosDelta) / dzd;\n        if (z < 0.0)  z = 0.0;\n        hillshade = z;\n      } else {\n        // multi-directional with 6 light sources\n        for (int k = 0; k < 6; k++) {\n        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;\n        float z = (u_cosZs[k] + cosDelta) / dzd;\n        if (z < 0.0) z = 0.0;\n        hillshade = hillshade + z * u_weights[k];\n        if (k == 5) break;\n        }\n      }\n\n      // set color\n      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);\n      alpha *= u_opacity;\n      ","\n    }\n  "])),n))}(t,e),t}var DU=Object.freeze(Object.defineProperty({__proto__:null,ColorizerUniforms:RU,ColorizerStretchUniforms:AU,ColorizerHillshadeUniforms:kU,build:EU},Symbol.toStringTag,{value:"Module"})),MU={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"},IU=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,Au.Z)(this,e),this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=t,this.source=r,this.width=n||r.width,this.height=i||r.height}return(0,ku.Z)(e,[{key:"source",get:function(){return this._source},set:function(e){this._source=e,this._rasterTexture=(0,Nu.G)(this._rasterTexture),this._memoryUsed=null}},{key:"symbolizerParameters",get:function(){return this.isRendereredSource?(0,Tu.Z)((0,Tu.Z)({},MU),{},{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||MU},set:function(e){this._symbolizerParameters=e}},{key:"bandIds",get:function(){return this._bandIds},set:function(e){var t=this;(0,Nu.r)(e)&&e.length>0?this._bandIds&&e.every((function(e,r){return!!t._bandIds[r]&&e===t._bandIds[r]}))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(e){if(this._interpolation=e,(0,Nu.r)(this._rasterTexture)){var t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?pc.L.LINEAR:pc.L.NEAREST)}}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(e){this._transformGrid=e,this._transformGridTexture=(0,Nu.G)(this._transformGridTexture),this._memoryUsed=null}},{key:"bind",value:function(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(((0,Nu.t)(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),(0,Nu.r)(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&(0,Nu.t)(this._transformGridTexture)&&(this._transformGridTexture=(0,uh.c)(e,this.transformGrid))),!0)}},{key:"getUniforms",value:function(){var e=this.symbolizerParameters,t=this.transformGrid,r=this.width,n=this.height,i=this.opacity,a=(0,uh._)(t,[r,n],[this.source.width,this.source.height],i),o=(0,uh.p)(e.colormap,e.colormapOffset),s="stretch"===this.symbolizerParameters.type?(0,uh.T)(this.symbolizerParameters):null,l="hillshade"===this.symbolizerParameters.type?(0,uh.E)(this.symbolizerParameters):null;return new RU(a,o,s||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}},{key:"memoryUsage",get:function(){if((0,Nu.t)(this._memoryUsed)){var e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((function(e){return(0,Nu.r)(e)?e.descriptor.width*e.descriptor.height*4:0})).reduce((function(e,t){return e+t}),0)}return this._memoryUsed}},{key:"release",value:function(){return this._rasterTexture=(0,Nu.G)(this._rasterTexture),this._transformGridTexture=(0,Nu.G)(this._transformGridTexture),this._colormapTexture=(0,Nu.G)(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}},{key:"_updateRasterTexture",value:function(e,t){var r=this.source?this.source.extractBands(t):null;if(r&&r.pixels&&r.pixels.length>0){var n=(0,Nu.t)(t)&&(0,Nu.t)(this.bandIds)||(0,Nu.r)(t)&&(0,Nu.r)(this.bandIds)&&t.join("")===this.bandIds.join("");if(!(0,Nu.r)(this._rasterTexture)||!n){this._rasterTexture=(0,Nu.G)(this._rasterTexture);var i=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=(0,uh.m)(e,r,i,this.isRendereredSource||this.hasStretchTypeNone())}}else this._rasterTexture=(0,Nu.G)(this._rasterTexture)}},{key:"hasStretchTypeNone",value:function(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}},{key:"_getRasterTextureInterpolation",value:function(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e?"nearest":"bilinear"}},{key:"_updateColormapTexture",value:function(e){var t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some((function(e,r){return e!==t[r]}))?(this._colormapTexture=(0,Nu.G)(this._colormapTexture),this._colormapTexture=(0,uh.l)(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=(0,uh.l)(e,r),void(this._colormap=r)):(this._colormapTexture=(0,Nu.G)(this._colormapTexture),void(this._colormap=null))}}]),e}(),LU=function(){function e(){(0,Au.Z)(this,e),this.waitingAgents=new Eu.a6,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}return(0,ku.Z)(e,[{key:"release",value:function(){this.dispose(),NU.delete(this),ZU.release(this)}},{key:"dispose",value:function(){this.loadingAgent=(0,Nu.G)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=lF(this._data)}},{key:"_init",value:function(e){this.waitingAgents.clear(),this._data=lF(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}},{key:"invalidateSourceData",value:function(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}},{key:"abortRequest",value:function(){this.requestAbort=(0,Nu.l)(this.requestAbort),this.requestPromise=null}},{key:"upsampleInfo",get:function(){return this._upsampleInfo}},{key:"_unsetUpsampleInfo",value:function(){(0,Nu.r)(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}},{key:"setUpsampleInfo",value:function(e,t){if(e===t||(0,Nu.t)(t))this._unsetUpsampleInfo();else{if((0,Nu.t)(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),function(e,t,r){for(var n=1,i=0,a=0;e!==t;)if(n*=.5,i*=.5,a*=.5,1&e.lij[2]&&(i+=.5),0==(1&e.lij[1])&&(a+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");r.init(t,i,a,n)}(e,t,this._upsampleInfo)}}},{key:"data",get:function(){return this._data},set:function(e){lF(this._data),this._data=e}}],[{key:"acquire",value:function(e){var t=ZU.acquire();return t._init(e),t}},{key:"prune",value:function(){ZU.prune(0)}}]),e}(),ZU=new Eu.h(LU,null,(function(){})),NU=new Map;var FU,zU=function(){function e(t){(0,Au.Z)(this,e),this._texture=t,this.type="tile-texture",this._refCount=1}return(0,ku.Z)(e,[{key:"retain",value:function(){++this._refCount}},{key:"release",value:function(){--this._refCount,0===this._refCount&&this._texture.dispose()}},{key:"texture",get:function(){return this._texture}},{key:"generateMipmap",value:function(){this._texture.generateMipmap()}},{key:"descriptor",get:function(){return this._texture.descriptor}}]),e}();!function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"}(FU||(FU={}));var UU=(0,Vu.n)(),VU=(0,Vu.n)(),BU=(0,Vu.n)(),GU=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0})),HU=function(){function e(){(0,Au.Z)(this,e),this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,ju.u)(),this._elevationBounds=(0,cc.n)(),this.layerInfo=[[],[]],this.extentInRadians=(0,ju.u)(),this.centerAtSeaLevel=(0,Vu.n)(),this._center=[(0,Vu.n)(),(0,Qu.R)(),(0,Vu.n)()],this.up=(0,Vu.ac)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0}return(0,ku.Z)(e,[{key:"_isCached",get:function(){return!this.shouldLoad&&this._mapDataRefCount<=0}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"key",get:function(){return"".concat(this.lij[0],"/").concat(this.lij[1],"/").concat(this.lij[2])}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[WU.MIDDLE][3]}},{key:"screenDepth",get:function(){return this._screenDepth}},{key:"visible",get:function(){return this._dirty&&this.computeVisibility(),this._visible}},{key:"frustumVisibility",get:function(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}},{key:"computeVisibility",value:function(){var e,t;this._dirty=!1;var r=null!==(e=null===(t=this.parent)||void 0===t?void 0:t.frustumVisibility)&&void 0!==e?e:YS.INTERSECTS;this._frustumVisibility=r===YS.INSIDE?YS.INSIDE:r===YS.OUTSIDE?YS.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);var n=this._frustumVisibility!==YS.OUTSIDE&&this._intersectsClippingArea;n!==this._visible&&(this._visible=n,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){var e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}},{key:"shouldLoad",get:function(){var e=this._surface.snapLevel;if((0,Nu.r)(e)){var t=this.level-e;if(0===t)return!0;if(1===t)return!1}return this.isLeaf}},{key:"init",value:function(e,t,r){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=(0,Xu.u)(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[WU.MIDDLE][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?(0,uc.a)(this._elevationBounds,t.elevationBounds):(0,uc.r)(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=r,this.updateVisibility();var n,i=(0,Cu.Z)(xz);try{for(i.s();!(n=i.n()).done;){var a,o=n.value,s=r.numLayers(o),l=this.layerInfo[o],u=(0,Cu.Z)(l);try{for(u.s();!(a=u.n()).done;){a.value.release()}}catch(h){u.e(h)}finally{u.f()}l.length=s;for(var c=0;c<s;c++)l[c]=LU.acquire(this._surface.upsampleInfoPool),o===gz.ELEVATION&&this.findElevationBoundsForLayer(c,-1)}}catch(h){i.e(h)}finally{i.f()}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,Fh)}},{key:"release",value:function(){qN(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);var e,t=(0,Cu.Z)(xz);try{for(t.s();!(e=t.n()).done;){var r,n=e.value,i=(0,Cu.Z)(this.layerInfo[n]);try{for(i.s();!(r=i.n()).done;){r.value.release()}}catch(o){i.e(o)}finally{i.f()}this.layerInfo[n].length=0}}catch(o){t.e(o)}finally{t.f()}this._parent=null;for(var a=0;a<4;++a)this._children[a]=null;this._surface=null,this.setMemoryDirty()}},{key:"refMapData",value:function(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}},{key:"unrefMapData",value:function(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();var e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}},{key:"setMemoryDirty",value:function(){this._usedMemory=null}},{key:"usedMemory",get:function(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}},{key:"_cachedMemory",get:function(){return this._isCached?this._mapTileMemory:0}},{key:"_mapTileMemory",get:function(){return this._ensureUsedMemory(),this.layerInfo[gz.MAP].reduce((function(e,t){return e+(t instanceof vh.m?t.memoryUsage:0)}),this._mapTileMemoryInternal)}},{key:"_cpuImageMemorySize",get:function(){var e=this._surface.tilingScheme.pixelSize;return e*e*4}},{key:"_ensureUsedMemory",value:function(){if((0,Nu.r)(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;var e,t=0,r=(0,Cu.Z)(this.layerInfo[gz.MAP]);try{for(r.s();!(e=r.n()).done;){var n=e.value.data;n instanceof vh.m?t+=this._getTerrainDataMemory(n):this._mapTileMemoryInternal+=this._getTerrainDataMemory(n)}}catch(l){r.e(l)}finally{r.f()}var i,a=this._cpuImageMemorySize,o=(0,Cu.Z)(this.layerInfo[gz.ELEVATION]);try{for(o.s();!(i=o.n()).done;){var s=i.value;this._usedMemory+=s.data?a:0}}catch(l){o.e(l)}finally{o.f()}return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=(0,_c.u)(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+t),this._usedMemory}},{key:"getUsedMemoryForLayer",value:function(e,t){var r=this.layerInfo[e][t];return null!==r&&void 0!==r&&r.data?e===gz.MAP?this._isCached?0:this._getTerrainDataMemory(r.data):e===gz.ELEVATION?this._cpuImageMemorySize:0:0}},{key:"_getTerrainDataMemory",value:function(e){return e instanceof zU?(0,_c.u)(e.texture):e instanceof HTMLImageElement||e instanceof IN?this._cpuImageMemorySize:e instanceof vh.m||e instanceof IU?e.memoryUsage:0}},{key:"updateScreenDepth",value:function(e){var t=this._center[WU.MIDDLE],r=e,n=t[0],i=t[1],a=t[2],o=r[2]*n+r[6]*i+r[10]*a+r[14];this._screenDepth=o<0?0:o/(r[3]*n+r[7]*i+r[11]*a+r[15])}},{key:"shouldSplit",value:function(e,t,r){var n=this;if(!this.visible)return FU.NONE;if((0,Nu.r)(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===YS.OUTSIDE))return FU.NONE;var i=this.level;(0,Vu.e)(UU,this._center[WU.MIDDLE],t);var a=(0,Vu.v)(UU),o=WU.MIDDLE;(0,Vu.e)(VU,this._center[WU.TOP],t);var s=(0,Vu.v)(VU);s<a&&(a=s,o=WU.TOP),(0,Vu.e)(VU,this._center[WU.BOTTOM],t);var l=(0,Vu.v)(VU);if(l<a&&(a=l,o=WU.BOTTOM),this._edgeLen2>a&&i<e.maxLod)return FU.SPLIT;var u=Math.sqrt(a),c=e.fovX*u*2,h=this._edgeLen/c,d=function(){var t=i+Math.ceil(-Math.log2(e.relativeWidthLimit/h));return t!==n.vlevel?(n.vlevel=t,FU.VSPLITMERGE):FU.NONE_HIT_MAXLOD};if((0,Nu.r)(r)&&1===r-i)return i>=e.maxLod?d():FU.SPLIT;var f=(0,Vu.P)(this.up,UU),p=this._elevationBounds[1]-this._elevationBounds[0],v=p/this.edgeLen;if(e.aboveGround&&f>0&&v<.001&&f/u-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return FU.NONE;if(h<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,FU.VSPLITMERGE):FU.NONE;if(i>=e.maxLod)return d();if(i>6){(0,Vu.e)(VU,this._center[o],t),(0,Vu.g)(BU,this.up,f),(0,Vu.e)(BU,BU,VU);var m=(0,Vu.v)(BU);if(m>this.radius*this.radius){(0,Vu.g)(BU,BU,this.radius/Math.sqrt(m)),(0,Vu.u)(BU,BU,this._center[o]),(0,Vu.e)(BU,t,BU);var y=Math.min(1,(Math.abs((0,Vu.P)(BU,this.up))+.5*p+this._curvatureHeight)/(0,Vu.s)(BU)),g=.1/e.angledSplitBias,_=e.fovY*u*2;if(y*(this._edgeLen/_)<g*e.relativeHeightLimit)return FU.NONE}}return FU.SPLIT}},{key:"setChildren",value:function(e,t,r,n){qN(!!(e&&t&&r&&n),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=r,this._children[3]=n}},{key:"unsetChildren",value:function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}},{key:"isLoaded",get:function(){var e,t;return null!==(e=null===(t=this.renderData)||void 0===t?void 0:t.hasGeometry)&&void 0!==e&&e}},{key:"load",value:function(){this.refMapData();var e,t=(0,Cu.Z)(xz);try{for(t.s();!(e=t.n()).done;){var r=e.value;this._createOrUpdateAgents(0,r)}}catch(n){t.e(n)}finally{t.f()}this.surface.renderer.loadTile(this)}},{key:"unload",value:function(e){e.unloadTile(this);var t,r=(0,Cu.Z)(xz);try{for(r.s();!(t=r.n()).done;){var n,i=t.value,a=this.layerInfo[i],o=(0,Cu.Z)(a);try{for(o.s();!(n=o.n()).done;){var s=n.value;s.loadingAgent&&s.loadingAgent!==cU&&(qU(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}}catch(l){o.e(l)}finally{o.f()}}}catch(l){r.e(l)}finally{r.f()}this.resetPendingUpdate(FU.GEOMETRY),this.resetPendingUpdate(FU.TEXTURE_NOFADING),this.resetPendingUpdate(FU.TEXTURE_FADING),this.unrefMapData()}},{key:"unloadMapData",value:function(){var e,t=this.layerInfo[gz.MAP],r=(0,Cu.Z)(t);try{for(r.s();!(e=r.n()).done;){var n=e.value;n.loadingAgent&&n.loadingAgent!==cU&&(qU(n.loadingAgent),n.loadingAgent=null),n.pendingUpdates=0}}catch(i){r.e(i)}finally{r.f()}this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}},{key:"updateClippingStatus",value:function(e){if((0,ju.I)(e,this._clippingArea))return!1;var t=this._intersectsClippingArea,r=this._isWithinClippingArea;(0,Nu.r)(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();var n=r&&this._isWithinClippingArea,i=!(r||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||n||i||this.setPendingUpdate(FU.GEOMETRY),!0}},{key:"updateVisibility",value:function(){this._dirty=!0,this._surface.setTileTreeDirty()}},{key:"getLayerInfo",value:function(e,t){return this.layerInfo[t][e]}},{key:"hasLayerData",value:function(e,t){var r=this.layerInfo[t][e];return!(!r||!r.data||r.dataInvalidated)}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;var e,t=(0,Cu.Z)(xz);try{for(t.s();!(e=t.n()).done;){var r,n=e.value,i=this.layerInfo[n],a=(0,Cu.Z)(i);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.loadingAgent&&o.loadingAgent!==cU&&o.loadingAgent.updating)return!0}}catch(s){a.e(s)}finally{a.f()}}}catch(s){t.e(s)}finally{t.f()}return!1}},{key:"_isSuspended",value:function(e){return!!this.hasPendingUpdate(FU.SPLIT)||e!==gz.ELEVATION&&!this.loadable}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"hasPendingUpdate",value:function(e){return(this._pendingUpdates&e)===e}},{key:"setPendingUpdate",value:function(e){this._pendingUpdates|=e,e===FU.SPLIT||e===FU.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}},{key:"resetPendingUpdate",value:function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}},{key:"requestLayerData",value:function(e,t,r){var n=this.layerInfo[t][e];if(n.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(r),n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),t,e),r.dataArrived(this),!0;if(n.requestPromise)return!0;(0,Nu.l)(n.requestAbort),n.requestAbort=new AbortController;var i=this._surface.requestTileData(this,e,t,n.requestAbort);if(!i)return n.requestAbort=null,!1;var a=function(){n.requestPromise===i&&(n.requestPromise=null,n.requestAbort=null)};return n.requestPromise=i,i.then(a,a),!0}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"hasLij",value:function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}},{key:"findByLij",value:function(e){return this.hasLij(e)?this:this.isLeaf?null:this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e)||null}},{key:"distanceToSquared",value:function(e){return(0,Vu.v)((0,Vu.e)(BU,this._center[WU.MIDDLE],e))}},{key:"containsPoint",value:function(e){var t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}},{key:"containsPointXY",value:function(e,t){var r=this.extent;return e>=r[0]&&t>=r[1]&&e<=r[2]&&t<=r[3]}},{key:"unrequestLayerData",value:function(e,t,r){var n=this.layerInfo[t][e],i=n.waitingAgents;qN(null!=i.removeUnordered(r),"agent has not requested this piece of map data"),i.length<1&&(n.abortRequest(),this.setMemoryDirty())}},{key:"dataArrived",value:function(e,t,r){var n=this,i=this.layerInfo[t][e];i.data=r,i.dataInvalidated=!1,i.waitingAgents.forAll((function(e){return e.dataArrived(n)})),i.waitingAgents.clear(),this.setMemoryDirty()}},{key:"dataMissing",value:function(e,t,r){r.notInTilemap||console.error("Tile ".concat(this.lij.toString()," layer ").concat(t,"/").concat(e," error ").concat(r));var n=this.layerInfo[t][e];n.dataMissing=!0,n.waitingAgents.forAll((function(e){return e.dataMissing()})),n.waitingAgents.clear(),this.setMemoryDirty()}},{key:"updateRenderData",value:function(e,t){switch(e){case gz.MAP:return this._updateTexture(t);case gz.ELEVATION:return this._updateGeometry()}}},{key:"_updateTexture",value:function(e){this.renderData&&(this.resetPendingUpdate(e===XS.FADING?FU.TEXTURE_NOFADING:FU.TEXTURE_FADING),this.setPendingUpdate(e===XS.FADING?FU.TEXTURE_FADING:FU.TEXTURE_NOFADING))}},{key:"_updateGeometry",value:function(){this.setPendingUpdate(FU.GEOMETRY);var e,t=(0,Cu.Z)(this.layerInfo[gz.ELEVATION]);try{for(t.s();!(e=t.n()).done;){e.value.pendingUpdates|=FU.GEOMETRY}}catch(r){t.e(r)}finally{t.f()}}},{key:"invalidateLayerData",value:function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}},{key:"computeElevationBounds",value:function(){var e=this._elevationBounds;(0,uc.r)(e,1/0,-1/0);var t,r=this.layerInfo[gz.ELEVATION],n=!0,i=(0,Cu.Z)(r);try{for(i.s();!(t=i.n()).done;){var a=t.value;(0,Nu.r)(a.elevationBounds)&&(e[0]=Math.min(e[0],a.elevationBounds.min),e[1]=Math.max(e[1],a.elevationBounds.max),a.elevationBounds.hasNoDataValues||(n=!1))}}catch(o){i.e(o)}finally{i.f()}n&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}},{key:"_updateCenter",value:function(){var e=this._elevationBounds,t=.5*(e[0]+e[1]);(0,Vu.g)(BU,this.up,t),(0,Vu.u)(this._center[WU.MIDDLE],this.centerAtSeaLevel,BU),(0,Vu.g)(BU,this.up,e[0]),(0,Vu.u)(this._center[WU.TOP],this.centerAtSeaLevel,BU),(0,Vu.g)(BU,this.up,e[1]),(0,Vu.u)(this._center[WU.BOTTOM],this.centerAtSeaLevel,BU)}},{key:"findElevationBoundsForLayer",value:function(e,t){var r=this.layerInfo[gz.ELEVATION][e];if(!((0,Nu.r)(r.elevationBounds)&&r.elevationBounds.level>=t)&&Jz(this,QN(this._surface.layerViewByIndex(e,gz.ELEVATION)),!1)){var n=QU,i=!1;if(r.data){var a=r.data;n.min=a.bounds[0],n.max=a.bounds[1],n.hasNoDataValues=a.hasNoDataValues,n.level=this.level,i=!0}else{for(var o,s,l=0,u=this._parent;u&&(!s||l<Bh(this.level))&&(l=this.vlevel-u.level,o=s||o,!(!(s=u.layerInfo[gz.ELEVATION][e].data)&&o&&l>=Bh(this.level)));u=u.parent);(s=s||o)&&(s.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],n),n.min!==1/0&&(n.level=s.level,i=!0))}i&&((0,Nu.t)(r.elevationBounds)&&(r.elevationBounds=new dz),r.elevationBounds.copyFrom(n))}}},{key:"modifyLayers",value:function(e,t,r){var n,i=this.layerInfo[r],a=(0,Cu.Z)(i);try{for(a.s();!(n=a.n()).done;){var o=n.value;o.loadingAgent&&o.loadingAgent!==cU&&(qU(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear()}}catch(d){a.e(d)}finally{a.f()}for(var s=0;s<i.length;++s)void 0===e[s]&&i[s].release();var l=(0,vu.Z)(Array,(0,mu.Z)(i)),u=t.length;i.length=u;for(var c=0;c<u;c++){var h=t[c];i[c]=h>-1?l[h]:LU.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}},{key:"restartAgents",value:function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,XS.FADING))}},{key:"updateAgents",value:function(e){if(this.renderData){var t,r=this.layerInfo[e],n=(0,Cu.Z)(r);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.loadingAgent===cU&&(i.loadingAgent=null)}}catch(a){n.e(a)}finally{n.f()}this._createOrUpdateAgents(0,e)}}},{key:"updateAgentSuspension",value:function(){var e,t=(0,Cu.Z)(xz);try{for(t.s();!(e=t.n()).done;){var r,n=e.value,i=this._isSuspended(n),a=(0,Cu.Z)(this.layerInfo[n]);try{for(a.s();!(r=a.n()).done;){var o=r.value;o.loadingAgent&&o.loadingAgent!==cU&&(o.loadingAgent.setSuspension(i),o.loadingAgent===cU&&this.updateRenderData(n,XS.FADING))}}catch(s){a.e(s)}finally{a.f()}}}catch(s){t.e(s)}finally{t.f()}}},{key:"removeLayerAgent",value:function(e,t){var r=this.layerInfo[t][e];r.loadingAgent&&r.loadingAgent!==cU&&r.loadingAgent.dispose(),r.loadingAgent=null}},{key:"agentDone",value:function(e,t){var r=this.layerInfo[t][e];r.loadingAgent=cU,!r.data&&(0,Nu.t)(r.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)}},{key:"_hasBlendableAncestor",value:function(e){return"normal"!==e.blendMode||iF(e.parent)&&this._hasBlendableAncestor(e.parent)}},{key:"_hasBlendModes",value:function(e,t,r){for(var n=e;n<t;++n){var i,a,o,s=this._surface.layerViewByIndex(n,r);if(aF(s)&&"normal"!==(null===s||void 0===s||null===(i=s.layer)||void 0===i?void 0:i.blendMode)||iF(null===s||void 0===s||null===(a=s.layer)||void 0===a?void 0:a.parent)&&this._hasBlendableAncestor(null===s||void 0===s||null===(o=s.layer)||void 0===o?void 0:o.parent))return!0}return!1}},{key:"_createOrUpdateAgents",value:function(e,t){var r=this.layerInfo[t];if(0!==r.length)for(var n=this._isSuspended(t),i=e;i<r.length;++i){var a=r[i],o=!1,s=this._surface.layerViewByIndex(i,t),l=QN(s);if(a.loadingAgent?Jz(this,l,!1)?(a.loadingAgent!==cU&&a.loadingAgent.setSuspension(n),a.loadingAgent!==cU&&(o=a.loadingAgent.update())):a.dispose():Jz(this,l,!1)&&(a.loadingAgent=jU(this,i,t,n),(o=a.loadingAgent.startLoading())?a.loadingAgent===cU&&this.setPendingUpdate(FU.GEOMETRY):(qU(a.loadingAgent),a.loadingAgent=cU)),a.loadingAgent===cU&&this.updateRenderData(t,XS.FADING),!this._hasBlendModes(e,r.length,t)&&o&&s.isOpaque)return}}},{key:"_isWithinExtent",value:function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}},{key:"intersectsExtent",value:function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}},{key:"getElevationBasedVerticesPerSide",value:function(e){var t=this.vlevel-this.level,r=Math.max(this.level-e,Bh(this.level)-t);return(0,Vu.a)(1+(this.maxTesselation>>r),2,this.maxTesselation+1)}},{key:"test",get:function(){return{cachedMemory:this._cachedMemory}}},{key:"_findLIJ",value:function(e,t){if(!e)return null;var r=this.surface.rootTiles;if((0,Nu.r)(r)){var n,i=(0,Cu.Z)(r);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(KU(a,e)){for(var o=a,s=e[0]-o.level-1;s>=0&&!o.isLeaf&&!t(o);){var l=e[1]>>s&1,u=e[2]>>s&1;o=o.children[2*l+u],s--}return t(o)?o:null}}}catch(c){i.e(c)}finally{i.f()}}return null}},{key:"findNeighborTile",value:function(e,t){var r=this.lij,n=this.getNeighborLIJ(r,e);return n?function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}(r,n)?t(this)?this:null:this._findLIJ(n,t):null}},{key:"findCorner",value:function(e,t){for(var r=e===jS.NORTH_EAST?1:e===jS.NORTH_WEST?0:e===jS.SOUTH_WEST?2:3,n=this;!(n.isLeaf||t&&t(n));)n=n.children[r];return n}},{key:"findNeighborCornerTileExact",value:function(e,t){var r,n=this;return null===(r=this.findNeighborTile(e,(function(e){return t(e)||e.level===n.level})))||void 0===r?void 0:r.findCorner(yF(e),t)}},{key:"forAllSubtreeOnSide",value:function(e,t){var r=e===jS.NORTH?[0,1]:e===jS.NORTH_EAST?[1]:e===jS.EAST?[1,3]:e===jS.SOUTH_EAST?[3]:e===jS.SOUTH?[2,3]:e===jS.SOUTH_WEST?[2]:e===jS.WEST?[0,2]:[0];!function e(n){t(n)||n.isLeaf||r.forEach((function(t){return e(n.children[t])}))}(this)}},{key:"forallNeighbors",value:function(e){var t=this;CF.forEach((function(r){return t.findNeighborCornerTileExact(r,e)})),TF.forEach((function(r){var n;return null===(n=t.findNeighborTile(r,(function(r){return r.level===t.level||e(r)})))||void 0===n?void 0:n.forAllSubtreeOnSide(gF(r),e)}))}},{key:"getNeighborEdgeStartVertexIndex",value:function(e,t){if(!t)return 0;var r=this.level-t.level;if(YN(!WN||r>=0),0===r)return 0;var n=Math.pow(2,r),i=1==(1&e),a=i?0:1,o=t.lij[a+1]*n,s=this.lij[a+1],l=s-o,u=i?n-1-l:l;return WN&&(YN(o<=s&&s<o+n),YN(0<=u&&u<n)),u}},{key:"forEachLoadedNeighbor",value:function(e){var t=this,r=this.level,n=function(e){return e.level===r||e.isLoaded};TF.forEach((function(r){var i=t.findNeighborTile(r,n);null!=i&&i!==t&&i.forAllSubtreeOnSide(gF(r),(function(t){return!!t.isLoaded&&(e(t,r),!0)}))})),CF.forEach((function(r){var i,a=null===(i=t.findNeighborTile(r,n))||void 0===i?void 0:i.findCorner(yF(r),(function(e){return e.isLoaded}));YN(!a||$U(t,a,r)),(null===a||void 0===a?void 0:a.isLoaded)&&e(a,r)}))}},{key:"getNeighborLIJ",value:function(e,t){var r=wF(t)?-1:xF(t)?1:0,n=_F(t)?-1:bF(t)?1:0,i=[e[0],e[1]+r,e[2]+n];return i[1]<0?null:this.surface.isGlobal?this.wrapLIJ(i):i[2]<0?null:i}},{key:"wrapLIJ",value:function(e){return!e||e[1]<0||e[1]>=Math.pow(2,e[0])?null:this.surface.wrapEastWest(e)}},{key:"westNeighborWestExtent",get:function(){return this.extent[0]*(this.isWestEnd?-1:1)}},{key:"eastNeighborEastExtent",get:function(){return this.extent[2]*(this.isEastEnd?-1:1)}},{key:"isEastEnd",get:function(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}},{key:"isWestEnd",get:function(){return 0===this.lij[2]}},{key:"isNorthEnd",get:function(){return 0===this.lij[1]}},{key:"isSouthEnd",get:function(){return this.extent[1]+(0,Vu.d)()>=this.surface.extent[1]}},{key:"compareLIJs",value:function(e){var t=this.lij,r=t[0],n=e[0];if(r===n)return[t,e];var i=r-n;if(i<0){var a=Math.pow(2,-i);return[[n,t[1]*a,t[2]*a],e]}var o=Math.pow(2,i);return[t,[r,e[1]*o,e[2]*o]]}},{key:"checkGeometryWaterproofness",value:function(){XN&&(YN(this.isLoaded),this.renderData.checkGeometryWaterproofness())}},{key:"shouldHaveNeighbor",value:function(e){var t=this.extent,r=this.surface.rootTilesExtent,n=.25*(t[2]-t[0]);if(wF(e)&&t[3]+n>=r[3])return!1;if(xF(e)&&t[1]-n<=r[1])return!1;var i=this.surface.isGlobal;return!(!i&&_F(e)&&t[0]-n<=r[0])&&!(!i&&bF(e)&&t[2]+n>=r[2])}}],[{key:"prune",value:function(){XU.prune(0),YU.prune(0),LU.prune()}}]),e}();function jU(e,t,r,n){var i=r===gz.ELEVATION?YU.acquire():XU.acquire();return i.init(e,t,r,n),i}function qU(e){e.dispose(),e instanceof hU?YU.release(e):e instanceof dU&&XU.release(e)}var WU,XU=new Eu.h(dU),YU=new Eu.h(hU),QU=new dz;function KU(e,t){var r=e.level,n=t[0];if(r>n)return!1;var i=n-r,a=Math.floor(t[1]/Math.pow(2,i)),o=Math.floor(t[2]/Math.pow(2,i));return a===e.lij[1]&&o===e.lij[2]}function JU(e,t,r){return Math.abs(e-t)<=r}function $U(e,t,r){return!(0,Nu.t)(e)&&!(0,Nu.t)(t)&&t!==e&&(e.level>=t.level?eV(e,t,r):eV(t,e,yF(r)))}function eV(e,t,r){YN(e.level>=t.level);var n=function(e){return e===jS.NORTH_WEST||e===jS.SOUTH_WEST}(r),i=function(e){return e===jS.NORTH_WEST||e===jS.NORTH_EAST}(r),a=e.extent,o=t.extent,s=[n?a[0]:a[2],i?a[3]:a[1]],l=[n?o[2]:o[0],i?o[1]:o[3]],u=1e-5*(a[2]-a[0]),c=JU(s[0],l[0],u)||e.surface.isGlobal&&JU(s[0],-l[0],u),h=JU(s[1],l[1],u);if(c&&h)return!0;if(e.level===t.level)return YN(!1),!1;if(!c&&!h)return YN(!1),!1;var d=c?tV(o[1],o[3],a[1],a[3],u):tV(o[0],o[2],a[0],a[2],u);return YN(d),d}function tV(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,Vu.d)();return e-i<=r&&r<=n&&n<=t+i}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(WU||(WU={}));var rV=function(){function e(){(0,Au.Z)(this,e),this._scales=(0,lc.r)(-1,-1,-1,-1),this._offsets=(0,lc.r)(-1,-1,-1,-1)}return(0,ku.Z)(e,[{key:"clear",value:function(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}},{key:"setScale",value:function(e,t,r){this._scales[2*e]=t,this._scales[2*e+1]=r}},{key:"setOffset",value:function(e,t,r){this._offsets[2*e]=t,this._offsets[2*e+1]=r}},{key:"scales",get:function(){return this._scales}},{key:"offsets",get:function(){return this._offsets}}]),e}();function nV(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add((0,dc.n)(Na||(Na=(0,wu.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))):e.vertex.code.add((0,dc.n)(Fa||(Fa=(0,wu.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = vec3(1.0, 0.0, 0.0);\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))),e.fragment.code.add((0,dc.n)(za||(za=(0,wu.Z)(["mat3 getTBNMatrix(vec3 n) {\nreturn mat3(tbnTangent, tbnBiTangent, n);\n}"]))))}var iV,aV,oV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).slicePlaneLocalOrigin=(0,Vu.n)(),e.origin=e.slicePlaneLocalOrigin,e}return(0,ku.Z)(r)}(dc.be);!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(iV||(iV={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.Depth=2]="Depth",e[e.Normal=3]="Normal",e[e.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"}(aV||(aV={}));var sV,lV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).identifier=iV.Material,e.transparent=!1,e.integratedMesh=!1,e}return(0,ku.Z)(r)}(oV),uV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).identifier=iV.ShadowMap,e}return(0,ku.Z)(r)}(oV),cV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).identifier=iV.Highlight,e}return(0,ku.Z)(r)}(oV),hV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){return(0,Au.Z)(this,r),t.call(this,e,"vec4",dc.s.Draw,(function(t,r,i){return t.setUniform4fv(e,n(r,i))}))}return(0,ku.Z)(r)}(dc.r);function dV(e,t){var r=e.vertex,n=e.fragment;r.uniforms.add([new hV("overlayTexOffset",(function(e,t){return function(e,t){var r,n=(0,Cu.Z)(t.overlays);try{for(n.s();!(r=n.n()).done;){var i=r.value,a=i.index,o=i.extent;(0,ju.y)(o)>0&&(mV[2*a]=e.toMapSpace[0]/(0,ju.s)(o)-o[0]/(0,ju.s)(o),mV[2*a+1]=e.toMapSpace[1]/(0,ju.l)(o)-o[1]/(0,ju.l)(o))}}catch(s){n.e(s)}finally{n.f()}return mV}(e,t)})),new hV("overlayTexScale",(function(e,t){return function(e,t){var r,n=(0,Cu.Z)(t.overlays);try{for(n.s();!(r=n.n()).done;){var i=r.value,a=i.index,o=i.extent;(0,ju.y)(o)>0&&(mV[2*a]=e.toMapSpace[2]/(0,ju.s)(o),mV[2*a+1]=e.toMapSpace[3]/(0,ju.l)(o))}}catch(s){n.e(s)}finally{n.f()}return mV}(e,t)}))]),n.constants.add("overlayOpacity","float",1),n.uniforms.add(new dc.h("ovColorTex",(function(e,t){return pV(e,t)}))),fV(e,t)}function fV(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==dc.B.Water&&t.pbrMode!==dc.B.WaterOnIntegratedMesh||e.include(bR,t);var r=e.vertex,n=e.fragment;e.varyings.add("vtcOverlay","vec4"),r.code.add((0,dc.n)(Ua||(Ua=(0,wu.Z)(["void setOverlayVTC(in vec2 uv) {\nvtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;\n}"])))),n.code.add((0,dc.n)(Va||(Va=(0,wu.Z)(["bool isValid(vec2 uv, vec2 dxdy) {\nreturn (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);\n}\nvec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {\nvec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));\nvec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));\nbool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));\nbool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));\nreturn mix(color1 * float(isValid1), color0, float(isValid0));\n}"])))),n.code.add((0,dc.n)(Ba||(Ba=(0,wu.Z)(["vec4 getCombinedOverlayColor() {\nreturn overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);\n}"])))),t.pbrMode!==dc.B.Water&&t.pbrMode!==dc.B.WaterOnIntegratedMesh||((0,dc.i)(n),(0,dc.w)(n),n.code.add((0,dc.n)(Ga||(Ga=(0,wu.Z)(["vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,\nfloat shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {\nvec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));\nvec3 v = vposEyeDir;\nvec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);\nreturn vec4(final, colorInput.w);\n}"])))))}function pV(e,t){return 0===t.overlays.length?null:e.identifier===iV.Material&&e.subPass===aV.Color?t.overlays[GS.INNER].getColorTextureNoRasterImage():e.identifier===iV.Highlight?t.overlays[GS.INNER].getValidTexture(WS.Highlight):null}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(sV||(sV={}));var vV,mV=(0,lc.n)();!function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(vV||(vV={}));var yV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).overlayOpacity=1,e}return(0,ku.Z)(r)}(dc.t);function gV(e,t){e.vertex.uniforms.add([new wV("overlayTexOffset"),new wV("overlayTexScale")]),e.fragment.uniforms.add([new dc.g("overlayOpacity",(function(e){return e.overlayOpacity})),new dc.h("ovColorTex",(function(e,t){return 0===t.overlays.length?null:t.overlays[GS.INNER].getColorTexture(e.overlaySource)}))]),fV(e,t)}function _V(e,t){var r=e.vertex,n=e.fragment,i=e.varyings;i.add("vtc","vec2"),r.uniforms.add(new wV("texOffsetAndScale")),n.uniforms.add(new TV("tex")),n.uniforms.add(new xV("textureOpacities"));var a=t.textureFadingEnabled&&!t.renderOccluded;a&&(r.uniforms.add(new wV("nextTexOffsetAndScale")),i.add("nvtc","vec2"),n.uniforms.add(new TV("texNext")),n.uniforms.add(new xV("nextTexOpacities")),n.uniforms.add(new bV("fadeFactor")));var o=t.tileBlendInput===vV.ColorComposite,s=t.tileBlendInput===vV.GridComposite;s&&n.include(SU),o&&n.uniforms.add(new xV("backgroundColor")),r.code.add((0,dc.n)(Ha||(Ha=(0,wu.Z)(["\n  void forwardTextureCoordinatesWithTransform(in vec2 uv) {\n    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;\n    ","\n  }"])),a?(0,dc.n)(ja||(ja=(0,wu.Z)(["nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;"]))):(0,dc.n)(qa||(qa=(0,wu.Z)([""]))))),n.code.add((0,dc.n)(Wa||(Wa=(0,wu.Z)(["\n    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {\n      ","\n    }"])),s||o?(0,dc.n)(Xa||(Xa=(0,wu.Z)(["\n              if (opacities.y <= 0.0) {\n                return color * opacities.z * opacities.x;\n              }\n              vec4 bg = "," * opacities.y;\n              float alpha = opacities.z * color.a;\n              return mix(bg, color, alpha) * opacities.x;"])),o?(0,dc.n)(Ya||(Ya=(0,wu.Z)(["vec4(backgroundColor, 1.0)"]))):(0,dc.n)(Qa||(Qa=(0,wu.Z)(["gridColor(uv)"])))):(0,dc.n)(Ka||(Ka=(0,wu.Z)(["return color;"]))))),a?n.code.add((0,dc.n)(Ja||(Ja=(0,wu.Z)(["vec4 getTileColor() {\nvec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);\nif (fadeFactor >= 1.0) {\nreturn color;\n}\nvec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);\nreturn mix(nextColor, color, fadeFactor);\n}"])))):n.code.add((0,dc.n)($a||($a=(0,wu.Z)(["vec4 getTileColor() {\nreturn getColor(texture2D(tex, vtc), vtc, textureOpacities);\n}"]))))}var bV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,e,"float")}return(0,ku.Z)(r)}(dc.r),xV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,e,"vec3")}return(0,ku.Z)(r)}(dc.r),wV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,e,"vec4")}return(0,ku.Z)(r)}(dc.r),TV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,e,"sampler2D")}return(0,ku.Z)(r)}(dc.r),CV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(yV);function SV(e){var t=new dc.o,r=t.vertex,n=t.fragment,i=t.varyings;t.include(dc.b0),t.include(dc.bf,e),t.include(dc.a,e);var a=function(){t.include(_R,e),r.code.add((0,dc.n)(eo||(eo=(0,wu.Z)(["\n  vec3 decodeNormalTerrain(vec2 e) {\n    float z = 1.0 - abs(e.x) - abs(e.y);\n    vec3 n = vec3(e + vec2(e.x >= 0.0 ? 1.0 : -1.0, e.y >= 0.0 ? 1.0 : -1.0) * min(z,0.0),z);\n    return normalize(n);\n  }\n\n  vec3 getNormal() {\n    return  ",";\n  }\n  "])),e.shading?(0,dc.n)(to||(to=(0,wu.Z)(["normalize(decodeNormalTerrain(normalCompressed))"]))):(0,dc.n)(ro||(ro=(0,wu.Z)(["getLocalUp(position, localOrigin)"])))))};(0,dc.T)(r,e),t.include(dc.K,e);var o=e.overlayMode!==sV.Disabled;switch(e.output){case dc.O.Color:t.include(_V,e),t.include(dc.b2,e);var s=e.overlayMode===sV.EnabledWithWater;o&&t.include(gV,(0,Tu.Z)((0,Tu.Z)({},e),{},{pbrMode:dc.B.Water})),s&&t.include(nV,e),i.add("vnormal","vec3"),i.add("vpos","vec3"),a(),(e.atmosphere||e.screenSizePerspective)&&(0,dc.W)(r);var l=e.receiveShadows&&!e.renderOccluded;l&&t.include(dc.aJ,e),e.atmosphere&&i.add("wnormal","vec3"),e.screenSizePerspective&&(i.add("screenSizeDistanceToCamera","float"),i.add("screenSizeCosAngle","float")),r.code.add((0,dc.n)(no||(no=(0,wu.Z)(["\n        void main(void) {\n          //Position\n          vpos = position;\n          vec3 positionWorld = position + localOrigin;\n          gl_Position = transformPosition(proj, view, vpos);\n\n          //Normal\n          vnormal = getNormal();\n\n          ","\n\n          ","\n\n          //Texture UV\n          vec2 uv = getUV0();\n          forwardTextureCoordinatesWithTransform(uv);\n          ","\n          ","\n\n          ","\n\n          ","\n\n        }\n      "])),s?(0,dc.n)(io||(io=(0,wu.Z)(["forwardVertexTangent(vnormal);"]))):(0,dc.n)(ao||(ao=(0,wu.Z)([""]))),e.atmosphere?(0,dc.n)(oo||(oo=(0,wu.Z)(["\n          wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);"]))):"",o?(0,dc.n)(so||(so=(0,wu.Z)(["setOverlayVTC(uv);"]))):"",e.tileBorders?(0,dc.n)(lo||(lo=(0,wu.Z)(["forwardTextureCoordinates();"]))):"",e.screenSizePerspective?(0,dc.n)(uo||(uo=(0,wu.Z)(["\n          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;\n          screenSizeDistanceToCamera = length(viewPos);\n          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;\n          screenSizeCosAngle = abs(viewSpaceNormal.z);"]))):"",l?(0,dc.n)(co||(co=(0,wu.Z)(["forwardLinearDepth();"]))):"")),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(dc.a0,e),t.include(dc.b2,e),t.include(dc.b3,e),t.include(dc.aK,e),s&&(0,dc.U)(n,e),(0,dc.b5)(n),(0,dc.b6)(n),n.uniforms.add([r.uniforms.get("localOrigin"),new dc.c("viewDirection",(function(e,t){return(0,Vu.z)(PV,(0,Vu.o)(PV,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))}))]),s&&n.uniforms.add([new dc.h("ovWaterTex",(function(e,t){return 0===t.overlays.length?null:t.overlays[GS.INNER].getNormalTexture(e.overlaySource)})),new dc.bg("view",(function(e,t){return(0,Wu.c)(OV,t.camera.viewMatrix,e.origin)}))]),n.code.add((0,dc.n)(ho||(ho=(0,wu.Z)(["const float sliceOpacity = 0.2;\nfloat lum(vec3 c) {\nreturn (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;\n}"])))),(0,dc.i)(n),(0,dc.w)(n),n.code.add((0,dc.n)(fo||(fo=(0,wu.Z)(["\n        void main() {\n          vec3 normal = normalize(vnormal);\n          float vndl = dot(normal, mainLightDirection);\n\n          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));\n          float shadow = ",";\n\n          float ssao = evaluateAmbientOcclusionInverse();\n          vec4 tileColor = getTileColor();\n\n          ","\n          if (rejectBySlice(vpos)) {\n            tileColor *= sliceOpacity;\n          }\n          ","\n\n          vec3 albedo = ","\n\n          // heuristic shading function used in the old terrain, now used to add ambient lighting\n\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n          gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);\n          ","\n          ","\n          ","\n          ","\n          gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        }\n      "])),e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical&&e.shading?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",o?(0,dc.n)(po||(po=(0,wu.Z)(["\n              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);\n              vec4 overlayColor = overlayOpacity * overlayColorOpaque;\n              ","\n              vec4 groundColor = tileColor;\n              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;"])),e.transparent?(0,dc.n)(vo||(vo=(0,wu.Z)(["if (overlayColor.a == 0.0) { discard; }"]))):""):"",e.atmosphere?(0,dc.n)(mo||(mo=(0,wu.Z)(["\n              float ndotl = clamp(vndl, 0.0, 1.0);\n              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));\n              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps\n              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe\n              atm *= tileColor.a; // premultiply with tile alpha"]))):"",e.atmosphere?(0,dc.n)(yo||(yo=(0,wu.Z)(["atm + tileColor.rgb;"]))):(0,dc.n)(go||(go=(0,wu.Z)(["tileColor.rgb;"]))),s?(0,dc.n)(_o||(_o=(0,wu.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);\n                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);\n                vec4 viewPosition = view*vec4(vpos, 1.0);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):"",e.screenSizePerspective?(0,dc.n)(bo||(bo=(0,wu.Z)(["\n            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));\n            if (perspectiveScale <= 0.25) {\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);\n            }\n            else if (perspectiveScale <= 0.5) {\n              gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);\n            }\n            else if (perspectiveScale >= 0.99) {\n              gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);\n            }\n            else {\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);\n            }"]))):"",e.visualizeNormals?e.spherical?(0,dc.n)(xo||(xo=(0,wu.Z)(["\n              vec3 localUp = normalize(vpos + localOrigin);\n              vec3 right = normalize(cross(vec3(0.0,0.0,1.0),localUp));\n              vec3 forward = normalize(cross(localUp,right));\n              mat3 tbn = mat3(right, forward, localUp);\n              vec3 tNormal = normalize(normal* tbn);\n              gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n          "]))):(0,dc.n)(wo||(wo=(0,wu.Z)(["\n          vec3 tNormal = normalize(normal);\n          gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n      "]))):"",e.tileBorders?(0,dc.n)(To||(To=(0,wu.Z)(["\n              vec2 dVuv = fwidth(vuv0);\n              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));\n              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);"]))):""));break;case dc.O.Depth:t.include(gV,e),t.include(dc.at,e),(0,dc.au)(t),(0,dc.b1)(t),r.code.add((0,dc.n)(Co||(Co=(0,wu.Z)(["\n              void main(void) {\n                ","\n                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n              }\n          "])),o?(0,dc.n)(So||(So=(0,wu.Z)(["setOverlayVTC(getUV0());"]))):"")),n.code.add((0,dc.n)(Oo||(Oo=(0,wu.Z)(["\n              void main() {\n                ","\n                outputDepth(linearDepth);\n              }\n          "])),o?(0,dc.n)(Po||(Po=(0,wu.Z)(["\n                  vec4 overlayColor = getCombinedOverlayColor();\n                  ",""])),e.transparent?(0,dc.n)(Ro||(Ro=(0,wu.Z)(["if (overlayColor.a == 0.0) { discard; }"]))):""):""));break;case dc.O.Shadow:case dc.O.ShadowHighlight:case dc.O.ShadowExludeHighlight:t.include(dc.at,e),(0,dc.au)(t),(0,dc.b1)(t),r.code.add((0,dc.n)(Ao||(Ao=(0,wu.Z)(["void main(void) {\ngl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n}"])))),n.code.add((0,dc.n)(ko||(ko=(0,wu.Z)(["void main() {\noutputDepth(linearDepth);\n}"]))));break;case dc.O.Normal:i.add("vnormal","vec3"),(0,dc.W)(r),a(),r.code.add((0,dc.n)(Eo||(Eo=(0,wu.Z)(["void main(void) {\nvec3 normal = getNormal();\ngl_Position = transformPosition(proj, view, position);\nvnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);\n}"])))),n.code.add((0,dc.n)(Do||(Do=(0,wu.Z)(["void main() {\nvec3 normal = normalize(vnormal);\nif (gl_FrontFacing == false) {\nnormal = -normal;\n}\ngl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);\n}"]))));break;case dc.O.Highlight:t.include(gV,e),r.code.add((0,dc.n)(Mo||(Mo=(0,wu.Z)(["void main() {\nsetOverlayVTC(getUV0());\ngl_Position = transformPosition(proj, view, position);\n}"])))),t.include(dc.a9,e),n.code.add((0,dc.n)(Io||(Io=(0,wu.Z)(["void main() {\nvec4 overlayColor = getCombinedOverlayColor();\nif (overlayColor.a == 0.0) {\ndiscard;\n}\noutputHighlight();\n}"]))))}return e.output===dc.O.ObjectAndLayerIdColor&&(t.include(gV,(0,Tu.Z)((0,Tu.Z)({},e),{},{pbrMode:dc.B.Disabled})),r.code.add((0,dc.n)(Lo||(Lo=(0,wu.Z)(["void main(void) {\ngl_Position = transformPosition(proj, view, position);\nsetOverlayVTC(getUV0());\n}"])))),n.code.add((0,dc.n)(Zo||(Zo=(0,wu.Z)(["\n        void main() {\n          vec2 texDim =  ",";\n          gl_FragColor =  ",";\n        }\n    "])),(0,dc.as)(e,"ovColorTex"),(0,dc._)(e,"ovColorTex","vec2(vtcOverlay.x * 0.5, vtcOverlay.y)*texDim")))),t}var OV=(0,hc.e)(),PV=(0,Vu.n)(),RV=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:CV,build:SV},Symbol.toStringTag,{value:"Module"})),AV=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).useStencil=!1,e}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2,t.spherical=e.viewingMode===ic.l.Global}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),kV)}},{key:"initializePipeline",value:function(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}},{key:"_createPipeline",value:function(e){var t=this.configuration,r=t.backfaceCullingEnabled&&!t.renderOccluded;return(0,vc.W)({blending:t.renderOccluded?(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA):null,culling:r&&vc.r,depthTest:!t.renderOccluded&&{func:pc.I.LESS},depthWrite:!t.renderOccluded&&vc.b,colorWrite:vc._,stencilTest:e?(0,dc.bh)(vc.t.IntegratedMeshMaskExcluded):null})}},{key:"getPipelineState",value:function(e,t){return this.useStencil?this._stencilPipelineState:(0,_u.Z)((0,bu.Z)(r.prototype),"getPipelineState",this).call(this,e,t)}}]),r}(dc.k);AV.shader=new dc.m(RV,(function(){return r.e(514).then(r.bind(r,80514))}));var kV=new Map([[fc.O.POSITION,0],[fc.O.UV0,1],[fc.O.NORMALCOMPRESSED,2]]),EV=function(){function e(){var t=this;(0,Au.Z)(this,e),this.geometryInfo=new Iz,this.intersectionData=null,this.geometryState=null,this._textureRef=new Yz((function(){return t.tile.surface.textureFadeDuration})),this.overlay=new rV,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}return(0,ku.Z)(e,[{key:"tile",get:function(){return this._tile}},{key:"init",value:function(e){this.clear(),this._tile=e;var t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,(0,Gc.A)(t.boundingBox),t.indexCount=0,t.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new Xz,this.localOrigin=null,this.overlay.clear()}},{key:"clear",value:function(){this._releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}},{key:"updateGeometryIfNeeded",value:function(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._shadingChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),WN&&this.tile.intersectsClippingArea)for(var t=0;t<4;++t)YN(this.geometryInfo.outerEdges[t].count===this.geometryState.neighborData.edgeResolutions[t]+1)}},{key:"_calculateEdgeResolution",value:function(e,t){var r,n=this.tile,i=this.geometryState.numVerticesPerSide-1;if(!n.surface.isGlobal){var a=n.surface.extent;if((0,Nu.r)(a)&&(0===e&&n.extent[3]>a[3]||1===e&&n.extent[2]>a[2]||2===e&&n.extent[1]<a[1]||3===e&&n.extent[0]<a[0]))return i}var o=n.level,s=TF[e];if(!t)return YN((0,Nu.t)(null===(r=n.surface)||void 0===r?void 0:r.rootTiles)||n.surface.updatingRootTiles||!n.shouldHaveNeighbor(s)),i;if(t.isLoaded){var l=t,u=l.renderData.geometryState,c=o-l.level;if(YN(c>=0),0===c){var h=u.numVerticesPerSide-1;return Math.max(h,i)}var d=Math.pow(2,c),f=u.neighborData.edgeResolutions[(e+2)%4]/d;return Math.max(1,f)}YN(!t.isLeaf);var p=i;return t.forAllSubtreeOnSide(gF(s),(function(e){return e===n||(e.isLoaded?(p=Math.max(p,Math.pow(2,e.level-o)),!0):(YN(!e.isLeaf),!1))})),p}},{key:"updateNeighborData",value:function(){var e=this,t=this.tile;if(t.intersectsClippingArea){for(var r=t.renderData.geometryState.neighborData,n=function(e){return(e.isLoaded||e.level===t.level)&&(null===e||void 0===e?void 0:e.intersectsClippingArea)},i=r.edgePeerNeighbors,a=r.edgePeerNeighborSamplerVersions,o=0;o<4;++o){var s,l,u=t.findNeighborTile(TF[o],n),c=UV(t,u),h=null!==(s=null===c||void 0===c||null===(l=c.renderData)||void 0===l?void 0:l.geometryState.samplerDataVersion)&&void 0!==s?s:-1,d=i[o],f=c!==UV(t,d),p=a[o]!==h;i[o]=u,(f||p)&&(a[o]=h,this._markEdgeDirty(o));var v=r.edgeResolutions[o],m=this._calculateEdgeResolution(o,u);YN((0,Vu.ad)(m)),YN(m>=1),r.edgeResolutions[o]=m,v!==m&&this._markEdgeResolutionDirty(o)}for(var y=r.cornerPeerNeighbors,g=function(a){var o=t.findNeighborTile(CF[a],n);y[a]=o;var s=UV(t,i[a]),l=UV(t,i[(a+1)%4]),u=UV(t,o);zV[a]=u,zV[(a+1)%4]=l,zV[(a+2)%4]=t,zV[(a+3)%4]=s,YN(zV.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));var c=zV.reduce((function(e,t){var r;return Math.min(e,null!==(r=null===t||void 0===t?void 0:t.level)&&void 0!==r?r:1/0)}),1/0);zV.forEach((function(e,t){(null===e||void 0===e?void 0:e.level)>c&&(zV[t]=null)})),YN(zV.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));for(var h=r.cornerNeighborData[a].cornerTiles,d=r.cornerNeighborData[a].cornerTileSamplerVersions,f=0;f<4;++f){var p,v=zV[f],m=null!==(p=null===v||void 0===v?void 0:v.renderData.geometryState.samplerDataVersion)&&void 0!==p?p:-1,g=h[f]!==v,_=!g&&d[f]!==m;(g||_)&&(h[f]=v,d[f]=m,e._markCornerDirty(a))}YN(h.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})))},_=0;_<4;++_)g(_);WN&&YN(this.geometryState.neighborData.edgeResolutions.every((function(e){return e>0})));for(var b=0;b<4;++b)zV[b]=null}}},{key:"_updateGeometry",value:function(e){if(this.tile.intersectsClippingArea){WN&&YN(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every((function(e){return e>0}))),this.intersectionData=null;var t=this.tile,r=this._vao,n=this.geometryInfo.vertexAttributes,i=!r||!n||this._wireframeChanged||this._shadingChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,a=!i&&(0!==this._dirtyEdges||0!==this._dirtyEdgeResolutions),o=!a&&0!==this._dirtyCorners;i?(this._releaseGeometry(),this._createGeometry(e)):a||o?t.updateEdgeElevations():o?t.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1}}},{key:"releaseGeometry",value:function(){return this._releaseGeometry()}},{key:"hasGeometry",get:function(){return this._hasGeometry}},{key:"ensureTexture",value:function(e,t){return(0,Nu.r)(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),(0,Nu.t)(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}},{key:"releaseTexture",value:function(){(0,Nu.r)(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}},{key:"_markCornerDirty",value:function(e){var t=1<<e;this._dirtyCorners|=t}},{key:"_markEdgeDirty",value:function(e){var t=1<<e;this._dirtyEdges|=t}},{key:"_markEdgeResolutionDirty",value:function(e){var t=1<<e;this._dirtyEdgeResolutions|=t,this._dirtyEdges|=t}},{key:"_markAllEdgesAndCornersDirty",value:function(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}},{key:"updateGeometryState",value:function(){var e=this._getElevationInfo(),t=this.tile,r=e.samplerData?t.getElevationBasedVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerRowOnLevel(),n=Math.max(r,5),i=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(i=null);var a=this.geometryState,o=!1;a.numVerticesPerSide!==n&&(this._numVerticesPerSideChanged=!0,a.numVerticesPerSide=n,a.samplerDataVersion++,o=!0),e.changed&&(this._samplerDataChanged=!0,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),(0,Nu.k)(a.clippingArea,i)||(this._clippingAreaChanged=!0,a.clippingArea=i,o=!0);var s=t.surface,l=s.wireframe;a.wireframe!==l&&(this._wireframeChanged=!0,a.wireframe=l,o=!0);var u=s.shading;return a.shading!==u&&(this._shadingChanged=u,a.shading=u,o=u),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}},{key:"_createGeometry",value:function(e){this.tile.createGeometry();var t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,n=e.gl;this._vao=new dc.N(e,kV,{geometry:(0,xc.o)(t.layout)},{geometry:_c.E.createVertex(e,n.STATIC_DRAW,t.buffer)},_c.E.createIndex(e,n.STATIC_DRAW,r)),this._hasGeometry=!0}},{key:"_releaseGeometry",value:function(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,function(e){Nz.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}(this.geometryInfo),!0)}},{key:"vao",get:function(){return this._vao}},{key:"setTextureReference",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Hz.Immediate;(0,Nu.r)(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}},{key:"textureReference",get:function(){return this._textureRef.current}},{key:"nextTextureReference",get:function(){return this._textureRef.next}},{key:"textureFadeFactor",get:function(){return this._textureRef.fadeFactor}},{key:"textureIsFading",get:function(){return this._textureRef.isFading}},{key:"_getElevationInfo",value:function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[gz.ELEVATION],r=t.length,n=new Array(r),i=0,a=0,o=!1,s=0;s<r;s++){var l=t[s];if((0,Nu.r)(l.upsampleInfo)){var u=l.upsampleInfo.tile,c=u.layerInfo[gz.ELEVATION][s].data,h=c&&c.samplerData;e&&e[i]===h||(o=!0),n[i++]=h,a=Math.max(a,u.lij[0])}else if(l.data){var d=this.tile.surface.layerViewByIndex(s,gz.ELEVATION);if(Jz(this.tile,d.layer,!1)){var f=l.data;e&&e[i]===f.samplerData||(o=!0),n[i++]=f.samplerData,a=this.tile.level}}}return(0,Nu.r)(e)&&e.length!==i&&(o=!0),i>0?n.length=i:n=null,{changed:o,samplerData:n,maxTileLevel:a}}},{key:"estimatedGeometryMemoryUsage",get:function(){var e,t,r,n,i=(0,Nu.u)(this.intersectionData,0,(function(e){return e.estimatedMemoryUsage}));return(null!==(e=null===(t=this.geometryInfo.indices)||void 0===t?void 0:t.byteLength)&&void 0!==e?e:0)+(null!==(r=null===(n=this.geometryInfo.vertexAttributes)||void 0===n?void 0:n.byteLength)&&void 0!==r?r:0)+i}},{key:"textureDescriptor",get:function(){return(0,Nu.r)(this._texture)?this._texture.descriptor:null}},{key:"test",get:function(){return{hasTexture:null!=this._texture}}},{key:"checkGeometryWaterproofness",value:function(){var e=this;if(WN){var t=this.tile;if(YN(null===t||void 0===t?void 0:t.isLoaded),t.isLoaded&&t.intersectsClippingArea&&0!==t.level){var r=t.surface.extent;if(!(0,Nu.r)(r)||t.intersectsExtent(r)){var n=TF.map((function(e,n){return!!(0,Nu.r)(r)&&(n<2?-1:1)*(t.extent[3-n]-r[3-n])<0})),i=t.level;YN(0===this._dirtyCorners),YN(0===this._dirtyEdges),YN(0===this._dirtyEdgeResolutions),YN(!this._numVerticesPerSideChanged),YN(!this._samplerDataChanged),YN(!this._clippingAreaChanged),YN(!this._wireframeChanged);for(var a=CF.map((function(e){var r;return null!==(r=t.findNeighborCornerTileExact(e,(function(e){return!e.intersectsClippingArea||e.isLoaded||e.level===t.level})))&&void 0!==r?r:null})).map((function(e){return null!==e&&void 0!==e&&e.intersectsClippingArea?e:null})),o=this.geometryState.neighborData,s=0;s<4;++s){var l=o.cornerPeerNeighbors[s],u=a[s];YN(u===l,"Tile[".concat(t.lij,"].corner[").concat(s,"] out of date: cur=[").concat(null===l||void 0===l?void 0:l.lij,"] exp=[").concat(null===u||void 0===u?void 0:u.lij,"]"))}TF.forEach((function(r,a){if(!n[a]){var o=t.findNeighborTile(r,(function(e){return(e.level===i||(null===e||void 0===e?void 0:e.isLoaded))&&(null===e||void 0===e?void 0:e.intersectsClippingArea)}));if(o){YN(o.isLoaded||o.level===t.level),YN(o===e.geometryState.neighborData.edgePeerNeighbors[a]);var s=i-o.level;if(!o.isLoaded)return YN(!o.isLeaf),void YN(0===s);YN(function(e,t,r){if((0,Nu.t)(e)||(0,Nu.t)(t))return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&r===jS.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&r===jS.WEST)return!0}var n=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(r){case jS.NORTH:return JU(e.extent[3],t.extent[1],n);case jS.SOUTH:return JU(e.extent[1],t.extent[3],n);case jS.EAST:return JU(e.extent[2],t.extent[0],n)||JU(e.extent[2],-t.extent[0],n);case jS.WEST:return JU(e.extent[0],t.extent[2],n)||JU(e.extent[0],-t.extent[2],n)}}(t,o,r)),YN(s>=0);var l=Math.pow(2,s);if(s<0)YN(!1);else{var u=t.renderData.geometryInfo,c=u.outerEdges[a],h=u.numVerticesPerSide-1,d=o.renderData.geometryInfo;if(d){var f=e.geometryState.neighborData.edgePeerNeighbors[a];((null===f||void 0===f?void 0:f.isLoaded)||f.isLoaded)&&(YN(f==f),YN(t.renderData.geometryState.neighborData.edgePeerNeighborSamplerVersions[a]===f.renderData.geometryState.samplerDataVersion),YN(e.geometryState.neighborData.edgePeerNeighborSamplerVersions[a]===f.renderData.geometryState.samplerDataVersion));var p=(a+2)%4,v=d.outerEdges[p],m=c.count-1,y=v.count-1;YN(m*l===y,"Tile[".concat(t.lij,"]:e").concat(a,",res=").concat(m," edgeRes mismatch with Neighbor[").concat(o.lij,"]:e").concat(p,",res=").concat(y," (expected:").concat(m*l,")"));var g=t.extent,_=r===jS.NORTH||r===jS.SOUTH,b=v.count-1,x=b/Math.pow(2,s),w=c.count-1;if(x<1)YN(1===w);else{YN(x===w),YN((0,Vu.ad)(x));var T=d.numVerticesPerSide-1;YN(s>0||x===Math.max(T,h));var C=t.getNeighborEdgeStartVertexIndex(a,o);YN(0<=C&&C<l);var S=C*x;YN(0<=S&&S<=b-x);var O=0,P=S;c.getVertexPos(DV,0),c.getVertexPos(MV,c.count-1);for(var R=(0,Vu.x)(DV,MV),A=Math.max(FV,1e-4*R),k=0;k<=x;++k){c.getVertexPos(DV,O),v.getVertexPos(MV,P);var E=k/x,D=_?g[0]+E*(g[2]-g[0]):r===jS.WEST?g[0]:g[2],M=_?r===jS.SOUTH?g[1]:g[3]:g[1]+E*(g[3]-g[1]),I=t.surface.extent;if((0,Nu.t)(I)||(0,ju.w)(I,D,M)){var L=(0,Vu.U)(DV,MV),Z=(0,Vu.Y)(DV)-Yu.s.radius,N=(0,Vu.Y)(MV)-Yu.s.radius,F=L<A;if(!F){console.warn("Tile edge vertex position mismatch: between [".concat(t.lij,"].edge").concat(a,"[").concat(O,"/").concat(c.count,"] and [").concat(o.lij,"].edge").concat(p,"[").concat(P,"/").concat(v.count,"]")),(0,Nu.r)(I)&&console.warn("  surface extent= ",I," x,y=",D,",",M);var z=(0,Vu.n)();(0,Vu.e)(z,t.renderData.localOrigin,o.renderData.localOrigin),(0,Vu.Y)(z)>0&&console.warn("   localOrigins: ".concat(t.renderData.localOrigin," vs ").concat(o.renderData.localOrigin," d=").concat((0,Vu.Y)(z)," [").concat(z,"]")),function(){var e=(0,Vu.t)(DV),r=(0,Vu.t)(MV);t.updateEdgeElevations(),o.updateEdgeElevations(),c.getVertexPos(DV,O),v.getVertexPos(MV,P);var n=(0,Vu.n)();(0,Vu.a0)(n,DV,e),(0,Vu.Y)(n)>0&&console.warn("  XXX Tile[".concat(t.lij,"] edge out of date: ").concat(e," vs ").concat(DV," d=").concat((0,Vu.Y)(n)," [").concat(n,"]")),(0,Vu.a0)(n,MV,r),(0,Vu.Y)(n)>0&&console.warn("  XXX Neighbor[".concat(o.lij,"] edge out of date: ").concat(r," vs ").concat(MV," d=").concat((0,Vu.Y)(n)," [").concat(n,"]"))}(),YN(F,"Mismatch in tile [".concat(t.lij,"].edge[").concat(a,"][").concat(O,"/").concat(c.count,"] vs neighbor [").concat(o.lij,"].edge[").concat(p,"][").concat(P,"/").concat(v.count,"] ").concat(vF(DV)," vs ").concat(vF(MV),"  dist=").concat(L," h(t|n|d)=").concat(Z,"|").concat(N,"|").concat(N-Z))}t.surface.shading&&function(){c.getNormal(IV,O),v.getNormal(LV,P),(0,Vu.z)(ZV,IV),(0,Vu.z)(NV,LV);var e=(0,Vu.P)(ZV,NV),r=1-e<.01||t===o;if(!r){var n=(0,Vu.n)();(0,Vu.a0)(n,IV,LV);var i=function(){return"Mismatch in tile edge normal ".concat(pF(t.lij)," (").concat(O,"/").concat(c.count-1,") edge ").concat(a," vs neighbor ").concat(pF(o.lij),"  (").concat(P,"/").concat(v.count-1,") nedge ").concat(p," :").concat(vF(IV)," vs ").concat(vF(LV),"  dot = ").concat(e," : ").concat(vF(n))};console.warn("Mismatch in tile edge normal: ",i()),t.updateEdgeElevations(),o.updateEdgeElevations();var s=(0,Vu.n)(),l=(0,Vu.n)();c.getNormal(s,O),v.getNormal(l,P),(0,Vu.a2)(IV,s)||console.warn("Missing update in tile normal: ",vF(IV)," => ",vF(s)),(0,Vu.a2)(LV,l)||console.warn("Missing update in neighbor normal: ",vF(LV)," => ",vF(l)),YN(r,i())}}()}O+=1,P+=1}}}else YN(!1)}}else{YN(!(!t.surface.updatingRootTiles&&(0,Nu.r)(t.surface.rootTiles)&&t.surface.rootTiles.length>0&&t.shouldHaveNeighbor(r)))}}}))}}}}}]),e}(),DV=(0,Vu.n)(),MV=(0,Vu.n)(),IV=(0,Vu.n)(),LV=(0,Vu.n)(),ZV=(0,Vu.n)(),NV=(0,Vu.n)(),FV=1,zV=[null,null,null,null];function UV(e,t){return null!==t&&void 0!==t&&t.isLoaded||t===e?t:null}function VV(e,t){var r=e.tile,n=r.extent,i=r.extentInRadians,a=r.surface,o=e.localOrigin,s=e.geometryState,l=a.isWebMercator,u=a.shading||cB,c=s.numVerticesPerSide,h=c-1,d=Math.pow(c-2,2),f=l&&(t===HS.HAS_SOUTH_POLE||t===HS.HAS_BOTH_POLES),p=l&&(t===HS.HAS_NORTH_POLE||t===HS.HAS_BOTH_POLES),v=6*((f?1:0)+(p?1:0))*(h+1),m=s.neighborData,y=m.edgeResolutions.reduce((function(e,t){return e+t+1}),0),g=Fz(d+v+y),_=e.geometryInfo;_.numVerticesPerSide=s.numVerticesPerSide,_.vertexAttributes=g;var b=_.boundingBox;(0,Gc.A)(b);var x=qV(e);aB.update(h,i,x),function(e){var t=e.tile;t.intersectsClippingArea&&(t.surface.shading||cB?function(e){var t=e.geometryState,r=t.numVerticesPerSide,n=r-2,i=r-1,a=e.geometryInfo,o=a.vertexAttributes,s=o.position,l=o.uv0,u=o.normalCompressed,c=e.tile,h=c.extent,d=h[0],f=h[2],p=h[1],v=h[3],m=c.ellipsoid.radius,y=t.samplerData,g=e.localOrigin,_=g[0],b=g[1],x=g[2],w=s.typedBuffer,T=s.typedBufferStride,C=1/i,S=a.boundingBox,O=0;if(1<=n)for(var P=C,R=p*(1-P)+v*P,A=aB.sinLatLUT[1],k=aB.cosLatLUT[1],E=1;E<=n;E++){var D=E*C,M=d*(1-D)+f*D,I=aB.sinLonLUT[E],L=aB.cosLonLUT[E],Z=m+vz(M,R,y),N=Z*L*k-_,F=Z*I*k-b,z=Z*A-x;Gz(N,F,z,S);var U=(E-1)*T;w[U+0]=N,w[U+1]=F,w[U+2]=z,Uz(l,E-1,D,P)}for(var V=1;V<=n;V++)for(var B=V*C,G=p*(1-B)+v*B,H=aB.sinLatLUT[V],j=aB.cosLatLUT[V],q=V+1,W=q*C,X=p*(1-W)+v*W,Y=aB.sinLatLUT[q],Q=aB.cosLatLUT[q],K=aB.sinLonLUT[0],J=aB.cosLonLUT[0],$=m+vz(d,G,y),ee=J*j*$-_,te=K*j*$-b,re=H*$-x,ne=O*T,ie=w[ne+0],ae=w[ne+1],oe=w[ne+2],se=1;se<=n;se++){var le=se*C,ue=d*(1-le)+f*le,ce=aB.sinLonLUT[se],he=aB.cosLonLUT[se],de=he*j,fe=ce*j,pe=H,ve=0,me=0,ye=0,ge=0,_e=0,be=0;if(se<n){var xe=(O+1)*T;ge=w[xe+0],_e=w[xe+1],be=w[xe+2]}else{var we=aB.sinLonLUT[i],Te=aB.cosLonLUT[i],Ce=m+vz(f,G,y);ge=Te*j*Ce-_,_e=we*j*Ce-b,be=H*Ce-x}var Se=ee,Oe=te,Pe=re;ee=ie,te=ae,re=oe,ie=ge,ae=_e,oe=be;var Re=ge-Se,Ae=_e-Oe,ke=be-Pe,Ee=Ae*pe-ke*fe,De=ke*de-Re*pe,Me=Re*fe-Ae*de;ve=De*ke-Me*Ae,me=Me*Re-Ee*ke,ye=Ee*Ae-De*Re;var Ie=0,Le=0,Ze=0;if(V>1){var Ne=(O-n)*T;Ie=w[Ne+0],Le=w[Ne+1],Ze=w[Ne+2]}else{var Fe=aB.sinLatLUT[0],ze=aB.cosLatLUT[0],Ue=m+vz(ue,p,y);Ie=he*ze*Ue-_,Le=ce*ze*Ue-b,Ze=Fe*Ue-x}var Ve=m+vz(ue,X,y),Be=he*Q*Ve-_,Ge=ce*Q*Ve-b,He=Y*Ve-x;if(V<n){var je=O+n,qe=je*T;w[qe+0]=Be,w[qe+1]=Ge,w[qe+2]=He,Gz(Be,Ge,He,S),Uz(l,je,le,W)}var We=Ie-Be,Xe=Le-Ge,Ye=Ze-He,Qe=Xe*pe-Ye*fe,Ke=Ye*de-We*pe,Je=We*fe-Xe*de;ve+=Ke*Ye-Je*Xe,me+=Je*We-Qe*Ye,ye+=Qe*Xe-Ke*We;var $e=1/Math.sqrt(ve*ve+me*me+ye*ye);zz(u,O,ve*$e,me*$e,ye*$e),++O}}(e):function(e){for(var t=e.geometryState,r=t.numVerticesPerSide,n=r-2,i=r-1,a=e.geometryInfo,o=a.vertexAttributes,s=o.position,l=o.uv0,u=e.tile,c=u.extent,h=c[0],d=c[2],f=c[1],p=c[3],v=u.ellipsoid.radius,m=t.samplerData,y=e.localOrigin,g=y[0],_=y[1],b=y[2],x=a.boundingBox,w=s.typedBuffer,T=s.typedBufferStride,C=0,S=1;S<=n;S++)for(var O=S/i,P=f*(1-O)+p*O,R=aB.sinLatLUT[S],A=aB.cosLatLUT[S],k=1;k<=n;k++){var E=k/i,D=h*(1-E)+d*E,M=aB.sinLonLUT[k],I=aB.cosLonLUT[k],L=v+vz(D,P,m),Z=I*A*L-g,N=M*A*L-_,F=R*L-b;Gz(Z,N,F,x);var z=C*T;w[z+0]=Z,w[z+1]=N,w[z+2]=F,Uz(l,C,E,O),++C}}(e))}(e),$V(e,d),BV(e);var w=[];if(function(){var e=d+y,t=o[0],i=o[1],a=o[2],s=r.ellipsoid.radius,l=n[1],v=n[3],m=function(r,n){var o=n*c;Gz(-t,-i,r*s-a,b),w.push({connectedRowOffset:o,connectedOuterEdgeOffset:1===r?0:2,rowOffset:e,latitudeResolution:6});for(var d=jV(-1===r?l:v,s),f=r*Math.PI/2-d,p=.99*(1===r?1:-1),m=s+0,y=g.position,_=g.uv0,x=g.normalCompressed,T=1;T<=6;++T)for(var C=d+f*(T/6),S=Math.cos(C),O=Math.sin(C),P=0;P<=h;P++){var R=P/h,A=aB.sinLonLUT[P],k=aB.cosLonLUT[P]*S,E=A*S,D=O,M=k*m-t,I=E*m-i,L=D*m-a;Gz(M,I,L,b),y.setValues(e,M,I,L),Uz(_,e,R,p),u&&zz(x,e,k,E,D),++e}};f&&m(-1,0),p&&m(1,h)}(),JV(_,s.numVerticesPerSide,w,[0,c-1],[0,c-1],s.wireframe),e.intersectionData=null,WN)for(var T=0;T<4;++T)YN(_.outerEdges[T].count===m.edgeResolutions[T]+1)}function BV(e){e.tile.intersectsClippingArea&&(HV(e),GV(e))}function GV(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.geometryState,n=e.geometryInfo,i=r.neighborData,a=e.tile,o=a.level,s=a.extent,l=a.ellipsoid.radius,u=a.extentInRadians,c=u[0],h=u[2],d=u[1],f=u[3],p=r.samplerData,v=s[0],m=s[2],y=s[1],g=s[3],_=qV(e),b=n.boundingBox,x=e.localOrigin,w=x[0],T=x[1],C=x[2],S=a.surface.shading||cB,O=n.vertexAttributes,P=O.position,R=P.typedBuffer,A=P.typedBufferStride,k=O.uv0,E=function(r){var u=1===r||3===r,x=i.edgeResolutions[r];YN((0,Vu.ad)(x));var O=x+1,P=UV(a,i.edgePeerNeighbors[r]);if(lB(a,P,r))return eB(e,r),"continue";var E=(0,Nu.r)(P);YN(!E||P.level===a.level),YN(!E||$z(a,P)<=0);var D=null===P||void 0===P?void 0:P.renderData,M=null===D||void 0===D?void 0:D.geometryState;if(WN){var I=a.surface;if(!P&&I&&!I.updatingRootTiles){var L=TF[r],Z=a.findNeighborTile(L,(function(e){return e.isLoaded||e.isLeaf||e.level===a.level}));Z?Z.intersectsClippingArea&&(YN(!Z.isLoaded),YN(!Z.isLeaf),YN(Z.level===o)):YN((0,Nu.t)(null===I||void 0===I?void 0:I.rootTiles)||!a.shouldHaveNeighbor(L))}}var N=1===r?s[2]:s[0],F=null===P||void 0===P?void 0:P.extent,z=E&&u?1===r?F[0]:F[2]:N,U=0===r?s[3]:s[1],V=1===r?1:0,B=0===r?1:0,G=1===r?h:c,H=0===r?f:d,j=Math.sin(G),q=Math.cos(G),W=Math.sin(H),X=Math.cos(H),Y=null===M||void 0===M?void 0:M.samplerData,Q=E?function(e,t,r){return.5*(vz(e,t,p)+vz(r,t,Y))}:function(e,t,r){return vz(e,t,p)},K=n.outerEdges[r],J=t&&O>3?O-3:1,$=(0,Nu.r)(p)&&p.some((function(e){return null!=e})),ee=(0,Nu.r)(Y)&&Y.some((function(e){return null!=e})),te=$||ee,re=1/x,ne=K.index0;S?(YN(!E||mF(F[2]-F[0],s[2]-s[0])),function(){var e=1===r?-1:3===r?1:0,t=0===r?-1:2===r?1:0,n=(s[2]-s[0])*re,i=e*n,a=t*n,o=u?e*((h-c)*re):0,d=u?0:t*re,f=B,x=u?G+o:G,S=u?Math.sin(x):j,P=u?Math.cos(x):q,D=u?G-o:G,M=u?Math.sin(D):j,I=u?Math.cos(D):q,L=u?H:_(f+d),Z=u?W:Math.sin(L),F=u?X:Math.cos(L),$=u?H:_(f-d),ee=u?W:Math.sin($),ie=u?X:Math.cos($),ae=(ne+0)*A,oe=R[ae+0]+w,se=R[ae+1]+T,le=R[ae+2]+C,ue=0,ce=0,he=0,de=1*re,fe=u?N:v*(1-de)+m*de,pe=u?z:fe,ve=u?y*(1-de)+g*de:U,me=u?G:c*(1-de)+h*de,ye=u?j:Math.sin(me),ge=u?q:Math.cos(me),_e=u?_(de):H,be=u?Math.sin(_e):W,xe=u?Math.cos(_e):X,we=l+Q(fe,ve,pe);ue=ge*xe*we,ce=ye*xe*we,he=be*we;for(var Te=1;Te<O-1;Te+=J){var Ce=0,Se=0,Oe=0,Pe=(ne+Te+1)*A;if(Te<O-2){var Re=(Te+1)*re,Ae=u?N:v*(1-Re)+m*Re,ke=u?z:Ae,Ee=u?y*(1-Re)+g*Re:U,De=u?G:c*(1-Re)+h*Re,Me=u?j:Math.sin(De),Ie=u?q:Math.cos(De),Le=u?_(Re):H,Ze=u?Math.sin(Le):W,Ne=u?Math.cos(Le):X,Fe=l+Q(Ae,Ee,ke);Ce=Ie*Ne*Fe,Se=Me*Ne*Fe,Oe=Ze*Fe}else Ce=R[Pe+0]+w,Se=R[Pe+1]+T,Oe=R[Pe+2]+C;var ze=Ce,Ue=Se,Ve=Oe,Be=ue,Ge=ce,He=he;ue=ze,ce=Ue,he=Ve;var je=ne+Te,qe=je*A,We=Be-w,Xe=Ge-T,Ye=He-C;R[qe+0]=We,R[qe+1]=Xe,R[qe+2]=Ye,Gz(We,Xe,Ye,b);var Qe=Te*re;Uz(k,je,u?V:Qe,u?Qe:B);var Ke=oe,Je=se,$e=le;oe=Be,se=Ge,le=He;var et=Be,tt=Ge,rt=He,nt=0,it=0,at=0;if(te){var ot=1/Math.sqrt(et*et+tt*tt+rt*rt),st=et*ot,lt=tt*ot,ut=rt*ot,ct=ze-Ke,ht=Ue-Je,dt=Ve-$e,ft=ht*ut-dt*lt,pt=dt*st-ct*ut,vt=ct*lt-ht*st;nt+=pt*dt-vt*ht,it+=vt*ct-ft*dt,at+=ft*ht-pt*ct;var mt=Te*re,yt=u?N:v*(1-mt)+m*mt,gt=u?z:yt,_t=u?y*(1-mt)+g*mt:U,bt=u?G:c*(1-mt)+h*mt,xt=u?j:Math.sin(bt),wt=u?q:Math.cos(bt),Tt=u?_(mt):H,Ct=u?Math.sin(Tt):W,St=u?Math.cos(Tt):X,Ot=et,Pt=tt,Rt=rt;if(E){var At=l+vz(gt-i,_t-a,Y),kt=u?St:ie;Ot=(u?I:wt)*kt*At,Pt=(u?M:xt)*kt*At,Rt=(u?Ct:ee)*At}var Et=l+vz(yt+i,_t+a,p),Dt=u?St:F,Mt=(u?P:wt)*Dt*Et,It=(u?S:xt)*Dt*Et,Lt=(u?Ct:Z)*Et;E||(Ot=2*et-Mt,Pt=2*tt-It,Rt=2*rt-Lt);var Zt=Ot-Mt,Nt=Pt-It,Ft=Rt-Lt,zt=Nt*ut-Ft*lt,Ut=Ft*st-Zt*ut,Vt=Zt*lt-Nt*st;nt+=Ut*Ft-Vt*Nt,it+=Vt*Zt-zt*Ft,at+=zt*Nt-Ut*Zt}else nt=et,it=tt,at=rt;var Bt=1/Math.sqrt(nt*nt+it*it+at*at);K.setNormalFromValues(Te,nt*Bt,it*Bt,at*Bt)}}()):function(){for(var e=1;e<O-1;e+=J){var t=e*re,r=u?V:t,n=u?t:B,i=u?N:v*(1-t)+m*t,a=u?y*(1-t)+g*t:U,o=u?z:i,s=u?G:c*(1-t)+h*t,d=u?j:Math.sin(s),f=u?q:Math.cos(s),p=u?_(t):H,x=u?Math.sin(p):W,S=u?Math.cos(p):X,P=Q(i,a,o),E=l+P,D=f*S*E-w,M=d*S*E-T,I=x*E-C;Gz(D,M,I,b);var L=ne+e,Z=L*A;R[Z+0]=D,R[Z+1]=M,R[Z+2]=I,Uz(k,L,r,n)}}()},D=0;D<4;++D)E(D)}function HV(e){tB(e)}function jV(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function qV(e){var t=e.tile;if(t.surface.isWebMercator){var r=t.extent,n=t.ellipsoid.radius;return function(e){return function(e,t,r,n){return jV(e*(1-n)+t*n,r)}(r[1],r[3],n,e)}}var i=t.extentInRadians;return function(e){return function(e,t,r){return e*(1-r)+t*r}(i[1],i[3],e)}}function WV(e,t){var r=e.tile.extent,n=e.geometryState,i=r[0],a=r[1],o=r[2]-i,s=r[3]-a,l=n.clippingArea,u=(0,Nu.r)(l)?Math.max(0,(l[0]-i)/o):0,c=(0,Nu.r)(l)?Math.max(0,(l[1]-a)/s):0,h=(0,Nu.r)(l)?Math.min(1,(l[2]-i)/o):1,d=(0,Nu.r)(l)?Math.min(1,(l[3]-a)/s):1,f=n.numVerticesPerSide,p=Math.pow(f-2,2),v=n.neighborData.edgeResolutions.reduce((function(e,t){return e+t+1}),0),m=Fz(p+v),y=e.geometryInfo,g=y.boundingBox;(0,Gc.A)(g),y.numVerticesPerSide=n.numVerticesPerSide,y.vertexAttributes=m,(0,Vu.C)(y.uvRange,u,c,h,d),function(e){var t=e.tile;t.intersectsClippingArea&&(t.surface.shading?function(e){var t=e.tile,r=t.surface;if(!r.shading&&!cB)return;for(var n=e.geometryState,i=n.samplerData,a=e.localOrigin,o=r.isWebMercatorOnPlateeCarree,s=n.clippingArea,l=(0,Nu.r)(s)?s:oB,u=t.extent,c=u[0],h=u[1],d=u[2],f=u[3],p=Math.max(c,l[0]),v=Math.min(d,l[2]),m=Math.max(h,l[1]),y=Math.min(f,l[3]),g=t.ellipsoid.radius,_=t.horizontalScale,b=n.numVerticesPerSide,x=b-1,w=b-2,T=e.geometryInfo,C=T.vertexAttributes,S=C.position,O=C.uv0,P=C.normalCompressed,R=T.uvRange,A=R[0],k=R[1],E=R[2],D=R[3],M=T.boundingBox,I=a[0],L=a[1],Z=a[2],N=S.typedBuffer,F=S.typedBufferStride,z=0,U=(0,Vu.a)(h,m,y),V=o?(Math.PI/2-2*Math.atan(Math.exp(-U/g)))*g:U*_,B=1/x,G=(0,Vu.a)(h*(1-B)+f*B,m,y),H=V,j=o?(Math.PI/2-2*Math.atan(Math.exp(-G/g)))*g:G*_,q=1;q<=w;q++){var W=q/x,X=(0,Vu.a)(h*(1-W)+f*W,m,y),Y=(0,Vu.a)(W,k,D),Q=j,K=(q-1)/x,J=(0,Vu.a)(h*(1-K)+f*K,m,y),$=H,ee=(q+1)/x,te=(0,Vu.a)(h*(1-ee)+f*ee,m,y),re=o?(Math.PI/2-2*Math.atan(Math.exp(-te/g)))*g:te*_,ne=(0,Vu.a)(ee,k,D);H=j,j=re;var ie=(0,Vu.a)(c,p,v),ae=ie*_,oe=vz(ie,X,i),se=1/x,le=(0,Vu.a)(se,A,E),ue=(0,Vu.a)(c*(1-le)+d*le,p,v),ce=le,he=ue,de=ue*_,fe=vz(ue,X,i);if(1===q){var pe=de-I,ve=H-L,me=fe-Z,ye=0*F;N[ye+0]=pe,N[ye+1]=ve,N[ye+2]=me,Gz(pe,ve,me,M),Uz(O,z,(0,Vu.a)(se,A,E),Y)}for(var ge=1;ge<=w;ge++){var _e=de,be=fe,xe=(ge+1)/x,we=(0,Vu.a)(xe,A,E),Te=(0,Vu.a)(c*(1-xe)+d*xe,p,v),Ce=he;he=Te;var Se=z+1,Oe=Se*F;if(1===q||ge===w){var Pe=Te*_,Re=Q,Ae=vz(Te,X,i);if(1===q&&ge<w){var ke=Pe-I,Ee=Re-L,De=Ae-Z;N[Oe+0]=ke,N[Oe+1]=Ee,N[Oe+2]=De,Gz(ke,Ee,De,M),Uz(O,Se,we,Y)}de=Pe,fe=Ae}else de=N[Oe+0]+I,fe=N[Oe+2]+Z;var Me=de,Ie=fe,Le=ae,Ze=oe;ae=_e,oe=be;var Ne=(z-w)*F,Fe=1===q?vz(Ce,J,i):N[Ne+2]+Z,ze=vz(Ce,te,i);if(q<w){var Ue=z+w,Ve=Ue*F,Be=_e-I,Ge=re-L,He=ze-Z;N[Ve+0]=Be,N[Ve+1]=Ge,N[Ve+2]=He,Gz(Be,Ge,He,M);var je=ce;ce=we,Uz(O,Ue,je,ne)}var qe=Me-Le,We=-qe*(Ie-Ze),Xe=$-re,Ye=-Xe*(Fe-ze),Qe=qe*qe+Xe*Xe,Ke=We*We+Ye*Ye+Qe*Qe;if(0===Ke)zz(P,z,0,0,1);else{var Je=1/Math.sqrt(Ke);zz(P,z,We*Je,Ye*Je,Qe*Je)}++z}}}(e):function(e){for(var t=e.geometryState,r=t.samplerData,n=e.tile,i=n.surface,a=e.localOrigin,o=i.isWebMercatorOnPlateeCarree,s=t.clippingArea,l=(0,Nu.r)(s)?s:oB,u=n.extent,c=u[0],h=u[1],d=u[2],f=u[3],p=Math.max(c,l[0]),v=Math.min(d,l[2]),m=Math.max(h,l[1]),y=Math.min(f,l[3]),g=a[0],_=a[1],b=a[2],x=n.ellipsoid.radius,w=n.horizontalScale,T=KV(o,x,w),C=t.numVerticesPerSide,S=C-1,O=C-2,P=e.geometryInfo,R=P.uvRange,A=R[0],k=R[1],E=R[2],D=R[3],M=P.boundingBox,I=P.vertexAttributes,L=I.position,Z=I.uv0,N=0,F=1;F<=O;F++)for(var z=F/S,U=(0,Vu.a)(h*(1-z)+f*z,m,y),V=(0,Vu.a)(z,k,D),B=T(U)-_,G=1;G<=O;G++){var H=G/S,j=(0,Vu.a)(c*(1-H)+d*H,p,v),q=(0,Vu.a)(H,A,E),W=j*w-g,X=vz(j,U,r)-b;Gz(W,B,X,M),L.setValues(N,W,B,X),Uz(Z,N,q,V),++N}}(e))}(e),$V(e,p),XV(e),JV(y,n.numVerticesPerSide,[],[0,f-1],[0,f-1],n.wireframe),e.intersectionData=null}function XV(e,t){e.tile.intersectsClippingArea&&(QV(e),YV(e,!1))}function YV(e,t){for(var r=e.geometryState,n=r.neighborData,i=e.tile,a=i.surface,o=a.shading||cB,s=i.extent,l=r.clippingArea,u=(0,Nu.r)(l)?l:oB,c=s[0],h=s[2],d=s[1],f=s[3],p=[f>u[3],h>u[2],d<u[1],c<u[0]],v=e.geometryInfo,m=i.horizontalScale,y=KV(a.isWebMercatorOnPlateeCarree,i.ellipsoid.radius,m),g=v.boundingBox,_=v.uvRange[0],b=v.uvRange[1],x=v.uvRange[2],w=v.uvRange[3],T=Math.max(c,u[0]),C=Math.min(h,u[2]),S=Math.max(d,u[1]),O=Math.min(f,u[3]),P=e.localOrigin,R=P[0],A=P[1],k=P[2],E=r.samplerData,D=function(r){var s=1===r||3===r,l=n.edgeResolutions[r];YN((0,Vu.ad)(l));var u=l+1,P=p[r],D=UV(i,n.edgePeerNeighbors[r]);if(!P&&lB(i,D,r))return eB(e,r),"continue";var M=(0,Nu.r)(D)&&!P,I=null===D||void 0===D?void 0:D.renderData,L=null===I||void 0===I?void 0:I.geometryState;if(WN&&(YN(!M||D.level===i.level),YN(!M||$z(i,D)<=0),i&&!D&&!a.updatingRootTiles)){var Z=TF[r],N=i.findNeighborTile(Z,(function(e){return e.isLoaded||e.isLeaf||e.level===i.level}));a.updatingRootTiles||(N?N.intersectsClippingArea&&(YN(!N.isLoaded),YN(!N.isLeaf),YN(N.level===i.level)):YN((0,Nu.t)(null===a||void 0===a?void 0:a.rootTiles)||!i.shouldHaveNeighbor(Z)))}var F=(0,Vu.a)(1===r?h:c,T,C),z=(0,Vu.a)(0===r?f:d,S,O),U=null===L||void 0===L?void 0:L.samplerData,V=v.outerEdges[r],B=t&&u>3?u-3:1,G=(0,Vu.a)(1===r?1:0,_,x),H=(0,Vu.a)(0===r?1:0,b,w),j=M?function(e,t){return.5*(vz(e,t,U)+vz(e,t,E))}:function(e,t){return vz(e,t,E)};if(o){var q=(h-c)/l,W=s?1===r?q:-q:0,X=s?0:0===r?q:-q,Y=-W,Q=-X,K=V.attributes.position.typedBuffer,J=V.attributes.position.typedBufferStride,$=V.index0,ee=V.stride,te=$*J,re=K[te+0]+R,ne=K[te+1]+A,ie=K[te+2]+k,ae=0,oe=0,se=0,le=1/l,ue=s?F:(0,Vu.a)(c*(1-le)+h*le,T,C),ce=s?(0,Vu.a)(d*(1-le)+f*le,S,O):z,he=j(ue,ce);ae=ue*m,oe=y(ce),se=he;for(var de=1;de<u-1;de+=B){var fe=de/l,pe=ae,ve=oe,me=se,ye=s?G:(0,Vu.a)(fe,_,x),ge=s?(0,Vu.a)(fe,b,w):H,_e=pe-R,be=ve-A,xe=me-k;Gz(pe,be,xe,g),V.setVertexFromValuesRawPositionUV(de,_e,be,xe,ye,ge);var we=de+1;if(de===u-1){var Te=($+we*ee)*J;ae=K[Te+0]+R,oe=K[Te+1]+A,se=K[Te+2]+k}else{var Ce=we/l,Se=s?F:(0,Vu.a)(c*(1-Ce)+h*Ce,T,C),Oe=s?(0,Vu.a)(d*(1-Ce)+f*Ce,S,O):z,Pe=j(Se,Oe);ae=Se*m,oe=y(Oe),se=Pe}var Re=ae,Ae=se,ke=re,Ee=ne,De=ie;re=pe,ne=ve,ie=me;var Me=0,Ie=0,Le=0;if(s){var Ze=oe-ve,Ne=Ee-ve;Ie-=Ne*(De-me)+Ze*(Ae-me),Le+=Ne*Ne+Ze*Ze;var Fe=(0,Vu.a)(d*(1-fe)+f*fe,S,O),ze=F+Y,Ue=ze*m-pe;if(Me-=Ue*(vz(ze,Fe,E)-me),Le+=Ue*Ue,M){var Ve=F+W,Be=Ve*m-pe;Me-=Be*(vz(Ve,Fe,U)-me),Le+=Be*Be}}else{var Ge=Re-pe,He=ke-pe;Me-=Ge*(Ae-me)+He*(De-me),Le+=Ge*Ge+He*He;var je=(0,Vu.a)(c*(1-fe)+h*fe,T,C),qe=z+Q,We=vz(je,qe,E)-me,Xe=y(qe)-ve;if(Ie-=Xe*We,Le+=Xe*Xe,M){var Ye=je,Qe=z+X,Ke=y(Qe)-ve;Ie-=Ke*(vz(Ye,Qe,U)-me),Le+=Ke*Ke}}var Je=1/Math.sqrt(Me*Me+Ie*Ie+Le*Le);V.setNormalFromValues(de,Me*Je,Ie*Je,Le*Je)}}else for(var $e=1;$e<u-1;$e+=B){var et=$e/l,tt=s?F:(0,Vu.a)(c*(1-et)+h*et,T,C),rt=s?(0,Vu.a)(d*(1-et)+f*et,S,O):z,nt=s?G:(0,Vu.a)(et,_,x),it=s?(0,Vu.a)(et,b,w):H,at=j(tt,rt),ot=tt*m-R,st=y(rt)-A,lt=at-k;Gz(ot,st,lt,g),V.setVertexFromValuesRawPositionUV($e,ot,st,lt,nt,it)}},M=0;M<4;++M)D(M)}function QV(e,t){tB(e)}function KV(e,t,r){return e?function(e){return function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t)}:function(e){return function(e,t){return e*t}(e,r)}}function JV(e,t,r,n,i,a){var o=t-1,s=e.vertexAttributes.count,l=2*(Math.min(t-2,n[1])-Math.max(1,n[0]))*(Math.min(t-2,i[1])-Math.max(1,i[0])),u=TF.map((function(e,r){return 0===r&&i[1]<t-2||1===r&&n[1]<t-2||2===r&&i[0]>1||3===r&&n[0]>1})),c=e.outerEdges.reduce((function(e,t,r){return e+(u[r]?0:o-2+t.count-1)}),0),h=r.reduce((function(e,t){return e+o*(2*(t.latitudeResolution-1)+1)}),0),d=a?2:1,f=3*(l+c+h)*d,p=s>=65536?new Uint32Array(f):new Uint16Array(f),v=0,m=t-2,y=o-2;if(YN(y>=0),a){var g=function(e,t,r){p[v++]=e,p[v++]=t,p[v++]=t,p[v++]=r,p[v++]=r,p[v++]=e,WN&&(YN(e<s),YN(t<s),YN(r<s),YN(v<=f))};(function(){for(var e=Math.max(i[0],1)-1;e<Math.min(i[1],t-2)-1;++e)for(var r=Math.max(n[0],1)-1;r<Math.min(n[1],t-2)-1;++r){var a=e*m+r,o=a+1,s=o+m,l=s-1;g(a,o,s),g(s,l,a)}})(),YN(v===3*l*d),function(){for(var t=0;t<4;++t){var r=v;if(!u[t]){var n=e.outerEdges[t],i=e.innerEdges[t],a=0,s=0,l=n.count,c=i.count;YN(c===o-1);for(var h=0,f=1===t||2===t?function(e,t,r){return g(e,t,r)}:function(e,t,r){return g(e,r,t)};a<l-1||s<c-1;){var p=i.getVertexIndex(s),m=n.getVertexIndex(a),_=a<l-1,b=s<c-1;_&&(!b||(_?0+o*(a+.5)/(l-1):0)<=(b?1+y*(s+.5)/(c-1):0))?(++a,WN&&YN(a<l),f(p,m,n.getVertexIndex(a)),h++):(++s,WN&&YN(s<c),f(p,m,i.getVertexIndex(s)),h++)}WN&&(YN(a===l-1),YN(s===c-1),YN(h===l+c-2),YN(h===o-2+n.count-1),YN(v===r+3*h*d))}}}(),YN(v===3*(l+c)*d);var _=function(r){for(var n=e.outerEdges[r.connectedOuterEdgeOffset],i=n.getVertexIndex(0),a=n.stride,s=0;s<r.latitudeResolution;++s){for(var l=0===s?r.rowOffset:i+t,u=0;u<o;u++)g(i,i+1,l+u),s<r.latitudeResolution-1&&g(i+1,l+u+1,l+u),i+=a;i=l,a=1}};r.forEach(_)}else{(function(){for(var e=Math.max(i[0],1)-1,r=Math.min(i[1],t-2)-1,a=Math.max(n[0],1)-1,o=Math.min(n[1],t-2)-1,s=e;s<r;++s)for(var l=s*m,u=a;u<o;++u){var c=l+u,h=c+1,d=h+m,f=d-1;p[v+0]=c,p[v+1]=h,p[v+2]=d,p[v+3]=d,p[v+4]=f,p[v+5]=c,v+=6}})(),YN(v===3*l*d),function(){for(var t=0;t<4;++t)if(!u[t]){var r=e.outerEdges[t],n=e.innerEdges[t],i=0,a=0,s=r.count,l=n.count;YN(l===o-1);for(var c=1===t||2===t,h=c?1:2,d=c?2:1,f=r.index0,m=r.stride,g=n.index0,_=n.stride;i<s-1||a<l-1;){var b=g+a*_,x=f+i*m,w=i<s-1,T=a<l-1,C=w&&(!T||(w?0+o*(i+.5)/(s-1):0)<=(T?1+y*(a+.5)/(l-1):0));C?++i:++a;var S=C?x+m:b+_;p[v+0]=b,p[v+h]=x,p[v+d]=S,v+=3}}}(),YN(v===3*(l+c)*d);var b=function(r){for(var n=e.outerEdges[r.connectedOuterEdgeOffset],i=n.getVertexIndex(0),a=n.stride,s=0;s<r.latitudeResolution;++s){for(var l=0===s?r.rowOffset:i+t,u=0;u<o;u++){var c=l+u;p[v+0]=i,p[v+1]=i+1,p[v+2]=c,s<r.latitudeResolution-1?(p[v+3]=i+1,p[v+4]=c+1,p[v+5]=c,v+=6):v+=3,i+=a}i=l,a=1}};r.forEach(b)}YN(v===f),e.indices=p,e.indexCount=f}function $V(e,t){for(var r=e.localOrigin,n=e.geometryInfo,i=e.geometryState.neighborData.edgeResolutions,a=n.numVerticesPerSide-2,o=n.vertexAttributes,s=t,l=0;l<4;++l){var u=0===l||2===l,c=(0===l?a-1:0)*a+(1===l?a-1:0),h=(u?0:1)*a+(u?1:0);n.innerEdges[l]=new Lz(o,r,c,h,a);var d=s,f=i[l]+1;n.outerEdges[l]=new Lz(o,r,d,1,f),s+=f}}function eB(e,t){var r=(t+2)%4,n=e.geometryState,i=e.tile,a=n.neighborData,o=UV(i,a.edgePeerNeighbors[t]),s=i.level-o.level,l=1===t||3===t,u=a.edgeResolutions[t];YN((0,Vu.ad)(u));var c=u+1,h=e.geometryInfo,d=h.boundingBox,f=h.outerEdges[t],p=h.uvRange[0],v=h.uvRange[1],m=h.uvRange[2],y=h.uvRange[3],g=(0,Vu.a)(1===t?1:0,p,m),_=(0,Vu.a)(0===t?1:0,v,y),b=o.renderData,x=b.geometryState,w=b.geometryInfo.outerEdges[r],T=i.getNeighborEdgeStartVertexIndex(t,o)*u,C=u*Math.pow(2,s);YN(x.neighborData.edgeResolutions[r]===C),YN(w.count-1===C);for(var S=b.localOrigin[0]-e.localOrigin[0],O=b.localOrigin[1]-e.localOrigin[1],P=b.localOrigin[2]-e.localOrigin[2],R=f.attributes,A=f.index0,k=f.stride,E=R.position.typedBuffer,D=R.position.typedBufferStride,M=R.normalCompressed.typedBuffer,I=R.normalCompressed.typedBufferStride,L=R.uv0,Z=w.attributes,N=w.index0,F=w.stride,z=Z.position.typedBuffer,U=Z.position.typedBufferStride,V=Z.normalCompressed.typedBuffer,B=Z.normalCompressed.typedBufferStride,G=1;G<c-1;++G){var H=A+k*G,j=N+F*(T+G),q=H*D,W=j*U,X=z[W+0]+S,Y=z[W+1]+O,Q=z[W+2]+P;E[q+0]=X,E[q+1]=Y,E[q+2]=Q,Gz(X,Y,Q,d);var K=H*I,J=j*B;M[K+0]=V[J+0],M[K+1]=V[J+1];var $=G/u;Uz(L,H,l?g:(0,Vu.a)($,p,m),l?(0,Vu.a)($,v,y):_)}}function tB(e){for(var t,r=e.geometryState,n=r.neighborData,i=e.localOrigin,a=n.cornerNeighborData,o=e.geometryInfo,s=o.outerEdges,l=o.boundingBox,u=e.tile,c="local"===(null===(t=e.tile.surface.view)||void 0===t?void 0:t.viewingMode),h=u.ellipsoid.radius,d=u.extentInRadians,f=u.horizontalScale,p=0,v=0,m=0,y=0,g=0,_=0,b=c?function(){var t=e.geometryState.clippingArea,r=u.extent,n=(0,Nu.r)(t)&&(r[3]>t[3]||r[2]>t[2]||r[1]<t[1]||r[0]<t[0]),i=KV(u.surface.isWebMercatorOnPlateeCarree,u.ellipsoid.radius,f);return function(e,r,a){var o=0===e?O[0]:O[2],s=0===r?O[1]:O[3],l=n?(0,Vu.a)(o,t[0],t[2]):o,u=n?(0,Vu.a)(s,t[1],t[3]):s,c=a;p=l*f,v=i(u),m=c}}():function(e,t,r){var n=d[0===t?1:3],i=d[0===e?0:2],a=Math.cos(n),o=Math.sin(n),s=Math.sin(i),l=Math.cos(i),u=h+r;p=l*a*u,v=s*a*u,m=o*u},x=0,w=0,T=0,C=c&&e.tile.surface.isWebMercatorOnPlateeCarree,S=function(e,t,r,n){if(c){var i=t*f,a=C?(Math.PI/2-2*Math.atan(Math.exp(-r/h)))*h:r*f,o=i-p,s=a-v,l=n-m;x+=-o*l,w+=-s*l,T+=o*o+s*s}else{var u=qV(e),d=e.tile,b=d.extent,S=d.extentInRadians,O=(t-b[0])/(b[2]-b[0]),P=(r-b[1])/(b[3]-b[1]),R=S[0]*(1-O)+S[2]*O,A=u(P),k=Math.cos(A),E=Math.sin(A),D=Math.sin(R),M=Math.cos(R),I=h+n,L=M*k*I-p,Z=D*k*I-v,N=E*I-m,F=Z*_-N*g,z=N*y-L*_,U=L*g-Z*y;x+=z*N-U*Z,w+=U*L-F*N,T+=F*Z-z*L}},O=u.extent,P=r.clippingArea,R=(0,Nu.r)(P)?P:oB,A=O[0],k=O[2],E=O[1],D=O[3],M=[D>R[3],k>R[2],E<R[1],A<R[0]],I=Math.max(A,R[0]),L=Math.min(k,R[2]),Z=Math.max(E,R[1]),N=Math.min(D,R[3]),F=o.uvRange[0],z=o.uvRange[1],U=o.uvRange[2],V=o.uvRange[3],B=u.surface.shading||cB,G=function(e){if(!c){var t=1/Math.sqrt(p*p+v*v+m*m);y=p*t,g=v*t,_=m*t}var r=a[e].cornerTiles;x=0,w=0,T=0;for(var n=1/0,i=0;i<4;++i){var o,s;n=Math.min(n,null!==(o=null===(s=r[i])||void 0===s?void 0:s.level)&&void 0!==o?o:1/0)}for(var l=0;l<4;++l){var u=r[l];sB[l]=(null===u||void 0===u?void 0:u.level)===n?u:null}for(var h=1,d=0,f=0;f<4;++f){var b=sB[f];b&&(h=Math.max(h,null===b||void 0===b?void 0:b.renderData.geometryState.numVerticesPerSide),d=b.extent[2]-b.extent[0])}var C=d,O=h;YN(O>1);for(var P=C/O,R=0;R<4;++R){var A=sB[(R+3)%4],k=sB[(R+0)%4];if(A||k){var E=0===R?1:1===R?2:2===R?3:0,D=0===R?2:1===R?3:2===R?0:1;if(A&&k){var M=iB[R][0]*P,I=iB[R][1]*P,L=A.extent,Z=L[0===E||1===E?2:0]+M,N=L[0===E||3===E?3:1]+I,F=k.extent,z=F[0===D||1===D?2:0]+M,U=F[0===D||3===D?3:1]+I,V=A.renderData,B=k.renderData,G=vz(Z,N,V.geometryState.samplerData),H=vz(z,U,B.geometryState.samplerData);S(V,Z,N,.5*(G+H))}else{var j=null!==A&&void 0!==A?A:k,q=A?E:D,W=j.extent,X=iB[R],Y=W[0===q||1===q?2:0]+X[0]*P,Q=W[0===q||3===q?3:1]+X[1]*P,K=j.renderData,J=vz(Y,Q,K.geometryState.samplerData);S(K,Y,Q,J)}}}var $=1/Math.sqrt(x*x+w*w+T*T);x*=$,w*=$,T*=$},H=0;H<4;++H){for(var j=H,q=(H+1)%4,W=0===H||1===H?1:0,X=0===H||3===H?1:0,Y=(0,Vu.a)(W,F,U),Q=(0,Vu.a)(X,z,V),K=s[j],J=0===H||3===H?K.count-1:0,$=s[q],ee=0===H||1===H?$.count-1:0,te=a[H].cornerTiles,re=-1,ne=0;ne<4;++ne){var ie=te[ne];ie&&(-1===re||$z(te[re],ie)>0)&&(re=ne)}var ae=re,oe=te[ae];if(x=0,w=0,T=1,oe!==u){var se=u.level-oe.level,le=Math.pow(2,se),ue=[oe.lij[0]+se,oe.lij[1]*le,oe.lij[2]*le],ce=[ue[1]+le===u.lij[1],0===H&&(1===ae||0===ae&&oe!==te[3])||1===H&&(0===ae||1===ae&&oe!==te[2]),ue[1]===u.lij[1]+1,2===H&&(3===ae||2===ae&&oe!==te[1])||3===H&&(2===ae||3===ae&&oe!==te[0])],he=ce.reduce((function(e,t){return e+(t?1:0)}),0);YN(1===he||2===he);var de=-1,fe=-1,pe=oe.renderData;if(1===he){var ve=ce.findIndex((function(e){return e}));YN(0<=ve&&ve<=3),de=(ve+2)%4;var me=e.geometryState.neighborData.edgeResolutions[ve];fe=u.getNeighborEdgeStartVertexIndex(ve,oe)*me+me*(0===ve&&0===H||1===ve&&0===H||2===ve&&1===H||3===ve&&3===H?1:0)}else{YN(ce[1]||ce[3]),de=ce[1]?3:1;var ye=pe.geometryState.neighborData.edgeResolutions[de];fe=0===H||3===H?0:ye}var ge=pe.geometryInfo.outerEdges[de],_e=K.index0+J*K.stride,be=$.index0+ee*$.stride,xe=ge.index0+fe*ge.stride,we=ge.attributes.position,Te=we.typedBuffer,Ce=xe*we.typedBufferStride,Se=e.localOrigin,Oe=ge.localOrigin,Pe=Te[Ce+0]+Oe[0]-Se[0],Re=Te[Ce+1]+Oe[1]-Se[1],Ae=Te[Ce+2]+Oe[2]-Se[2];Gz(Pe,Re,Ae,l);var ke=K.attributes.position,Ee=ke.typedBuffer,De=_e*ke.typedBufferStride;Ee[De+0]=Pe,Ee[De+1]=Re,Ee[De+2]=Ae;var Me=$.attributes.position,Ie=Me.typedBuffer,Le=be*Me.typedBufferStride;Ie[Le+0]=Pe,Ie[Le+1]=Re,Ie[Le+2]=Ae,Uz(K.attributes.uv0,_e,Y,Q),Uz($.attributes.uv0,be,Y,Q);var Ze=ge.attributes.normalCompressed.typedBuffer,Ne=xe*ge.attributes.normalCompressed.typedBufferStride,Fe=K.attributes.normalCompressed,ze=Fe.typedBuffer,Ue=_e*Fe.typedBufferStride;ze[Ue+0]=Ze[Ne+0],ze[Ue+1]=Ze[Ne+1];var Ve=$.attributes.normalCompressed,Be=Ve.typedBuffer,Ge=be*Ve.typedBufferStride;Be[Ge+0]=Ze[Ne+0],Be[Ge+1]=Ze[Ne+1]}else{var He=void 0;if(M[j]||M[q])He=vz((0,Vu.a)(A*(1-W)+k*W,I,L),(0,Vu.a)(E*(1-X)+D*X,Z,N),r.samplerData);else He=rB(te);b(W,X,He),(B||cB)&&G(H);var je=p-i[0],qe=v-i[1],We=m-i[2];Gz(je,qe,We,l),K.setVertexFromValuesRawPositionUVNormal(J,je,qe,We,Y,Q,x,w,T),$.setVertexFromValuesRawPositionUVNormal(ee,je,qe,We,Y,Q,x,w,T)}}for(var Xe=0;Xe<4;++Xe)sB[Xe]=null}function rB(e){var t=e.reduce((function(e,t){var r;return Math.min(e,null!==(r=null===t||void 0===t?void 0:t.level)&&void 0!==r?r:1/0)}),1/0);WN&&(YN(!e[0]||!e[2]||$U(e[0],e[2],jS.SOUTH_WEST)),YN(!e[1]||!e[3]||$U(e[1],e[3],jS.NORTH_WEST)));for(var r=0,n=0,i=0;i<4;++i){var a=e[i];if(a&&a.level===t){var o,s,l=0===i||1===i,u=0===i||3===i,c=a.extent;n+=vz(c[l?0:2],c[u?1:3],null===(o=a.renderData)||void 0===o||null===(s=o.geometryState)||void 0===s?void 0:s.samplerData),r++}}var h=r?n/r:0;return YN(null!=h),h}function nB(e){var t=e.vao,r=e.geometryInfo.vertexAttributes.position.typedBuffer;t.vertexBuffers.geometry.setSubData(r,0,0,r.length)}var iB=[[0,1],[1,0],[0,-1],[-1,0]],aB=new jz,oB=(0,ju.o)(-1/0,-1/0,1/0,1/0),sB=[null,null,null,null];function lB(e,t,r){if(!t)return!1;var n=$z(e,t);return n>0||0===n&&r<2}var uB,cB=!0,hB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this))._horizontalScaleFactor=1,a._extentInRenderSR=(0,ju.u)(),void 0!==e&&a.init(e,n,i),a}return(0,ku.Z)(r,[{key:"horizontalScale",get:function(){return this._horizontalScaleFactor}},{key:"init",value:function(e,t,n){(0,_u.Z)((0,bu.Z)(r.prototype),"init",this).call(this,e,t,n);var i=n.view.renderSpatialReference,a=n.spatialReference,o=(0,Nu.r)(i)&&(0,Yu.T)(i)&&(0,Nu.r)(a)&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;var s=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,u=this.extent;if(s){var c=(0,Vu.c)(u[0],u[1],0);(0,Hu.j)(c,Yu.k.WebMercator,c,Yu.k.PlateCarree);var h=(0,Vu.c)(u[2],u[3],0);(0,Hu.j)(h,Yu.k.WebMercator,h,Yu.k.PlateCarree),l[0]=c[0],l[1]=c[1],l[2]=h[0],l[3]=h[1]}else for(var d=0;d<4;++d)l[d]=u[d]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){this._updateCenter();var e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),n=Math.sqrt(t*t+r*r),i=.5*(this.elevationBounds[0]-this.elevationBounds[1]),a=Math.max(n,i);this._center[WU.MIDDLE][3]=a}},{key:"_calculateFrustumVisibilityStatus",value:function(e){for(var t=this._aabb(),r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=!0,u=0;u<6;u++){var c=e[u],h=c[0],d=c[1],f=c[2],p=c[3];if(h*(h>0?r:a)+d*(d>0?n:o)+f*(f>0?i:s)+p>=0)return YS.OUTSIDE;l=l&&h*(h<0?r:a)+d*(d<0?n:o)+f*(f<0?i:s)+p<=0}return l?YS.INSIDE:YS.INTERSECTS}},{key:"_aabb",value:function(){var e=this._extentInRenderSR;return(0,Gc.k)(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}},{key:"intersectsRay",value:function(e,t,r,n){return dB[0]=1/t[0],dB[1]=1/t[1],dB[2]=1/t[2],(0,dc.bi)(this._aabb(),e,dB,r,n)}},{key:"createGeometry",value:function(){WV(this.renderData),this.setMemoryDirty()}},{key:"getDefaultVerticesPerRowOnLevel",value:function(){return this.level<9?3:2}},{key:"updateCornerElevations",value:function(){!function(e,t){e.tile.intersectsClippingArea&&(QV(e),YV(e,!0),nB(e))}(this.renderData)}},{key:"updateEdgeElevations",value:function(){!function(e,t){e.tile.intersectsClippingArea&&(XV(e),nB(e))}(this.renderData)}}]),r}(HU),dB=(0,Vu.n)();!function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(uB||(uB={}));var fB,pB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;(0,Au.Z)(this,r),(a=t.call(this))._obb=new Array(8);for(var o=0;o<8;o++)a._obb[o]=(0,Vu.n)();return void 0!==e&&a.init(e,n,i),a}return(0,ku.Z)(r,[{key:"init",value:function(e,t,n){(0,_u.Z)((0,bu.Z)(r.prototype),"init",this).call(this,e,t,n);var i=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],s=this.extentInRadians[2],l=this.extentInRadians[3],u=e[0],c=(0,Vu.Z)(o,l,.5),h=(0,Vu.Z)(a,s,.5),d=0===u?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(s-a)*Math.cos(d)*i,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=i-Math.sqrt(i*i-this._edgeLen2/4),(0,Hu.f)(this.centerAtSeaLevel,h,c,this.ellipsoid.radius);var f=(0,Vu.a6)(this.centerAtSeaLevel);(0,Vu.z)(f,f),this.up=f,this._updateOBB(),this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){if(0===this.lij[0])(0,Vu.o)(this._center[fB.MIDDLE],0,0,0),(0,Vu.o)(this._center[fB.TOP],0,0,0),(0,Vu.o)(this._center[fB.BOTTOM],0,0,0),this.ellipsoid||(this.ellipsoid=(0,Xu.u)(this.surface.spatialReference)),this._center[fB.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();var e=Math.max((0,Vu.p)(this._center[fB.MIDDLE],this._obb[0]),(0,Vu.p)(this._center[fB.MIDDLE],this._obb[1]));this._center[fB.MIDDLE][3]=Math.sqrt(e)}}},{key:"_calculateFrustumVisibilityStatus",value:function(e){if(!(0,kc.i)(e,this._center[fB.MIDDLE]))return YS.OUTSIDE;if(this.lij[0]<10)return YS.INTERSECTS;for(var t=this._obb,r=this.surface.view.state.camera.near,n=!0,i=0;i<kc.v.NUM;i++){for(var a=i===kc.U.NEAR,o=e[i],s=o[0],l=o[1],u=o[2],c=o[3]-(a?r:0),h=!1,d=0;d<8;++d){var f=t[d];if(s*f[0]+l*f[1]+u*f[2]+c<0){if(h=!0,!n)break}else n=!1}if(!h)return YS.OUTSIDE}return n?YS.INSIDE:YS.INTERSECTS}},{key:"computeElevationBounds",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"computeElevationBounds",this).call(this),this._updateOBB()}},{key:"createGeometry",value:function(){var e=this._getPatchType(this.lij[1],this.lij[0]);VV(this.renderData,e),this.setMemoryDirty()}},{key:"_updateOBB",value:function(){for(var e=this.extentInRadians,t=this._obb,r=0;r<2;r++){var n=this.elevationBounds[r],i=4*r;(0,Hu.f)(t[i++],e[0],e[1],this.ellipsoid.radius+n),(0,Hu.f)(t[i++],e[0],e[3],this.ellipsoid.radius+n),(0,Hu.f)(t[i++],e[2],e[3],this.ellipsoid.radius+n),(0,Hu.f)(t[i++],e[2],e[1],this.ellipsoid.radius+n)}if(this.surface.isWebMercator)switch(this._getPatchType(this.lij[1],this.lij[0])){case HS.HAS_NORTH_POLE:(0,Vu.o)(t[1],0,0,this.ellipsoid.radius),(0,Vu.o)(t[2],0,0,this.ellipsoid.radius),(0,Vu.o)(t[5],0,0,this.ellipsoid.radius),(0,Vu.o)(t[6],0,0,this.ellipsoid.radius);break;case HS.HAS_SOUTH_POLE:(0,Vu.o)(t[0],0,0,-this.ellipsoid.radius),(0,Vu.o)(t[3],0,0,-this.ellipsoid.radius),(0,Vu.o)(t[4],0,0,-this.ellipsoid.radius),(0,Vu.o)(t[7],0,0,-this.ellipsoid.radius)}}},{key:"_getPatchType",value:function(e,t){return e===(1<<t)-1?0===e?HS.HAS_BOTH_POLES:HS.HAS_SOUTH_POLE:0===e?HS.HAS_NORTH_POLE:HS.REGULAR}},{key:"intersectsRay",value:function(e,t,r,n){var i=this._center[fB.MIDDLE],a=i[3]+r,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=i[0]-e[0],l=i[1]-e[1],u=i[2]-e[2],c=(s*t[0]+l*t[1]+u*t[2])/o,h=t[0]*c-s,d=t[1]*c-l,f=t[2]*c-u;return h*h+d*d+f*f<a*a}},{key:"getDefaultVerticesPerRowOnLevel",value:function(){return this.level<vB.length?vB[this.level]+1:2}},{key:"updateCornerElevations",value:function(){!function(e){e.tile.intersectsClippingArea&&(HV(e),GV(e,!0),nB(e))}(this.renderData)}},{key:"updateEdgeElevations",value:function(){!function(e){e.tile.intersectsClippingArea&&(BV(e),nB(e))}(this.renderData)}}]),r}(HU),vB=[128,64,32,16,16,8,8,4];!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(fB||(fB={}));var mB=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.extent=(0,lc.n)(),this.minLevel=0,this.maxLevel=0,this.callback=null})),yB=function(){function e(){(0,Au.Z)(this,e),this._queries=new Eu.a6({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Eu.a6({initialSize:30}),this._queryPool=new Eu.h(mB)}return(0,ku.Z)(e,[{key:"queryVisibleLevelRange",value:function(e,t,r,n){var i=this._queryPool.acquire();(0,Vu.B)(i.extent,e),i.minLevel=t||-Number.MAX_VALUE,i.maxLevel=null!=r?r:Number.MAX_VALUE,i.callback=n,this._queryQueue.push(i)}},{key:"hasPendingQueries",value:function(){return 0!==this._queryQueue.length}},{key:"prepareQueries",value:function(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){var e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}},{key:"processQueries",value:function(){for(var e=0;e<this._queries.length;e++){var t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear()}},{key:"scaleQueriesForTile",value:function(e){for(var t=e.level,r=0;r<this._queriesInvPtr;){var n=this._queries.data[r],i=n.extent;t>=n.minLevel&&t<=n.maxLevel&&i[0]<=e.extent[2]&&i[2]>=e.extent[0]&&i[1]<=e.extent[3]&&i[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}}]),e}(),gB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).blendMode=yU.Normal,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)({count:yU.COUNT})],gB.prototype,"blendMode",void 0);var _B,bB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=bU.Composite,e.baseOpacityMode=xU.NotRequired,e.premultipliedSource=wU.Off,e.hasWebGL2Context=!1,e}return(0,ku.Z)(r)}(gB);function xB(e){var t=new dc.o;if(t.include(mU),e.background===_B.Only){var r=e.output===bU.ColorComposite;return r?t.fragment.uniforms.add(new dc.c("backgroundColor",(function(e){return e.backgroundColor}))):(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(SU)),t.fragment.code.add((0,dc.n)(No||(No=(0,wu.Z)(["\n    void main() {\n      gl_FragColor = ",";\n    }\n  "])),r?(0,dc.n)(Fo||(Fo=(0,wu.Z)(["vec4(backgroundColor, 1.0)"]))):(0,dc.n)(zo||(zo=(0,wu.Z)(["gridColor(uv)"]))))),t}return t.include(PU,e),t.fragment.uniforms.add(new dc.h("tex",(function(e){return e.texture}))),t.fragment.uniforms.add(new dc.g("opacity",(function(e){return e.opacity}))),t.fragment.code.add((0,dc.n)(Uo||(Uo=(0,wu.Z)(["void main() {\nvec4 bgColor = getBackground(uv);\ngl_FragColor = blendLayers(bgColor, texture2D(tex, uv), opacity);\n}"])))),t}(0,Eu.e)([(0,dc.p)({count:bU.COUNT})],bB.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:xU.COUNT})],bB.prototype,"baseOpacityMode",void 0),(0,Eu.e)([(0,dc.p)()],bB.prototype,"premultipliedSource",void 0),(0,Eu.e)([(0,dc.p)()],bB.prototype,"hasWebGL2Context",void 0),function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(_B||(_B={}));var wB=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return _B},build:xB},Symbol.toStringTag,{value:"Module"})),TB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).opacity=1,e.baseOpacity=1,e.texture=null,e.fboTexture=null,e.backgroundColor=Vu.a7,e}return(0,ku.Z)(r)}(vU),CB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}]),r}(dc.k);CB.shader=new dc.m(wB,(function(){return r.e(3767).then(r.bind(r,83767))}));var SB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).background=_B.BelowLayer,e}return(0,ku.Z)(r)}(bB);(0,Eu.e)([(0,dc.p)()],SB.prototype,"background",void 0);var OB=function(){function e(t,r,n,i,a,o){(0,Au.Z)(this,e),this.texture=t,this.type=r,t.retain(),this.offsetAndScale=(0,lc.r)(n.offset[0],n.offset[1],n.scale,n.scale),this.opacities=(0,Vu.c)(i,a,o)}return(0,ku.Z)(e,[{key:"destroy",value:function(){this.texture.release()}}]),e}(),PB=function(){function e(){(0,Au.Z)(this,e),this._renderParams={context:null,drawPhase:1,state:new Ju.U({viewpoint:new Du.u({targetGeometry:new Yu.w(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._renderParams=null}},{key:"render",value:function(e,t,r,n,i,a,o,s,l,u){var c=a.adjustLevel(t[0]),h=this._renderParams;h.context=e,h.painter=n,h.glyphMosaic=n.glyphMosaic,h.spriteMosaic=n.spriteMosaic,h.pixelRatio=u,h.displayLevel=c,h.requiredLevel=c;var d=a.getScale(t[0]),f=a.getShift(t,o*d),p=(0,xu.Z)(f,2),v=p[0],m=p[1],y=.125*o*d/l,g=r.transforms.dvs;g[0]=y,g[4]=-y,g[6]=-1-v-s[0]*o*2,g[7]=1+m+(1-s[1])*o*2-2,h.state.size[0]=l,h.state.size[1]=l,r.stage||r.attachWithContext(e),r.triangleCount=0,n.drawTile(h,r,i)}}]),e}(),RB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}]),r}(dc.k);RB.shader=new dc.m(DU,(function(){return r.e(9413).then(r.bind(r,79413))}));var AB=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).colorizerType=aU.Stretch,e.stretchType=oU.Noop,e.applyColormap=!0,e}return(0,ku.Z)(r)}(bB);(0,Eu.e)([(0,dc.p)({count:aU.COUNT})],AB.prototype,"colorizerType",void 0),(0,Eu.e)([(0,dc.p)({count:oU.COUNT})],AB.prototype,"stretchType",void 0),(0,Eu.e)([(0,dc.p)()],AB.prototype,"applyColormap",void 0);var kB=function(){function e(t){(0,Au.Z)(this,e),this._rctx=t,this._fbos=new Map}return(0,ku.Z)(e,[{key:"get",value:function(e){return this._getPool(e)}},{key:"dispose",value:function(){this._fbos.forEach((function(e){return e.dispose()})),this._fbos.clear()}},{key:"_getPool",value:function(e){var t=this._fbos.get(e);if(t)return t;var r=new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,r),r}}]),e}(),EB=Eu.a.getLogger("esri.views.3d.terrain"),DB=function(){function e(t,r){(0,Au.Z)(this,e),this._rctx=t,this._techniqueRepository=r,this._fbos=[],this._vectorTileHelper=new PB,this._bindParameters=new Df(null,null,null),this._blendLayersTechniqueConfig=new SB,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,dc.u)(this._rctx,dc.A)}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._fbos.forEach((function(e){e.dispose(),e=null})),this._fbos=null,this._vtFBO=(0,Nu.G)(this._vtFBO),this._vaoQuad=(0,Nu.G)(this._vaoQuad),this._vectorTileHelper=(0,Nu.G)(this._vectorTileHelper),this._backgroundTechnique=(0,Nu.F)(this._backgroundTechnique),this._applyOpacityTechnique=(0,Nu.F)(this._applyOpacityTechnique),this._blendLayersTechnique=(0,Nu.F)(this._blendLayersTechnique)}},{key:"_getBlendLayersTechnique",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:wU.Off,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:_B.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=n,this._blendLayersTechniqueConfig.background=i,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(CB,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}},{key:"drawBackground",value:function(e,t){var r=this._getBlendLayersTechnique(yU.Normal,t?bU.ColorComposite:bU.GridComposite,xU.NotRequired,wU.Off,_B.Only),n=this._rctx.bindTechnique(r,e,this._bindParameters);this._render(n)}},{key:"_render",value:function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(this._vaoQuad,"geometry"))}},{key:"drawGroup",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:wU.On;t===bU.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);var o=this._getBlendLayersTechnique(n,t,i,a),s=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(s)}},{key:"drawRasterData",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:wU.Off;if(!(0,Nu.t)(e.texture)){e.fboTexture=t===bU.GroupBackgroundComposite||n===yU.Normal&&i===xU.NotRequired&&a===wU.Off?null:this.switch(r).colorTexture;var o=this._getBlendLayersTechnique(n,t,i,a),s=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(s)}}},{key:"drawImageryTileData",value:function(e,t,r,n,i,a){var o=a.sourceLayerInfo.data;if(o.source&&(a.tile.surface.layerViewByIndex(a.layerIndex,gz.MAP).ensureSymbolizerParameters(o),o.bind(this._rctx))){e.fboTexture=n===yU.Normal&&i===xU.NotRequired?null:this.switch(r).colorTexture;var s=this._getRasterColorizerTechnique(o,t,n,i);o.opacity=e.opacity;var l=o.getUniforms();l.scale=a.scale,l.offset=a.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;var u=this._rctx.bindTechnique(s,l,null);this._render(u)}}},{key:"_getRasterColorizerTechnique",value:function(e,t,r,n){var i=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(i.type);return(0,Nu.t)(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new AB,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=n,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!i.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?oU.Noop:oU.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(RB,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}},{key:"drawVectorData",value:function(e,t,r,n,i,a,o,s,l){var u=this._rctx,c=a.sourceLayerInfo.data,h=a.tile.surface.layerViewByIndex(a.layerIndex,gz.MAP),d=i===xU.Required||e.opacity<1||n!==yU.Normal||t!==bU.Composite,f=d?wU.On:wU.Off;this._getBlendLayersTechnique(n,t,i,f).bindPipelineState(u);var p=null,v=null;d?(v=this.currentFBO(r),(0,Nu.t)(this._vtFBO)&&(this._vtFBO=new kB(this._rctx)),p=this._vtFBO.get(r),u.bindFramebuffer(p),this._clearCurrentFBO()):l&&u.clearSafe(pc._.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(u,a.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/a.scale),a.offset,s,o)}catch(GX){EB.warnOnce("A render call containing vector tiles did not resolve correctly.",GX)}return!(0,Nu.r)(p)||(u.bindFramebuffer(v),e.texture=p.colorTexture,e.offset=cc.f,e.scale=1,this.drawRasterData(e,t,r,n,i,f),l)}},{key:"copyFBOToTexture",value:function(e){var t=this._rctx,r=t.bindTexture(e.texture,Oc.E.TEXTURE_UNIT_FOR_UPDATES),n=e.descriptor;t.gl.copyTexImage2D(pc.M.TEXTURE_2D,0,n.pixelFormat,0,0,n.width,n.height,0),e.generateMipmap(),t.bindTexture(r,Oc.E.TEXTURE_UNIT_FOR_UPDATES)}},{key:"_clearCurrentFBO",value:function(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(pc._.COLOR_BUFFER_BIT|pc._.DEPTH_BUFFER_BIT)}},{key:"_initFBO",value:function(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}},{key:"ensureBuffer",value:function(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}},{key:"bind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(var n=this._fbos.length;n<=t;n++)this._fbos.push(new kB(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}},{key:"_bindNextFreeBuffer",value:function(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}},{key:"openGroup",value:function(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}},{key:"switch",value:function(e){var t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}},{key:"getLastOnHoldId",value:function(){return this._onHoldIds[this._onHoldIds.length-1]}},{key:"closeGroup",value:function(e){var t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}},{key:"unbind",value:function(){this._rctx.bindFramebuffer(null)}},{key:"currentFBO",value:function(e){return this._fbos[this._current].get(e)}}]),e}(),MB=(0,ku.Z)((function e(t,r,n,i){(0,Au.Z)(this,e),this.start=t,this.end=r,this.blendMode=n,this.opacity=i})),IB=function(){function e(t,r,n){(0,Au.Z)(this,e),this._rctx=t,this.tileSize=r,this._techniqueRepository=n,this._passParameters=new TB,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new DB(this._rctx,this._techniqueRepository),this._blackTex=new zU((0,dc.bj)(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._composition=(0,Nu.G)(this._composition),this._backgroundTexture=(0,Nu.F)(this._backgroundTexture),this._blackTex=(0,Nu.F)(this._blackTex)}},{key:"backgroundIsGrid",get:function(){return(0,Nu.t)(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"updateTileTexture",value:function(e,t){if(e.renderData){var r=e.surface,n=r.baseOpacity,i=0,a=0,o=this.tileSize,s=!1,l=r.view.state.pixelRatio,u=!1;BB.clear(),GB.length=0;for(var c=e.layerInfo[gz.MAP],h=c.length,d=0;d<c.length;d++){var f=r.layerViewByIndex(d,gz.MAP),p=f.layer.opacity;zB[d]=p;var v=f.fullOpacity;if(UB[d]=v,(0,$u.i)(f.layer)&&h>=c.length&&(h=d),aF(f)){VB[d]=f.layer.blendMode;var m="normal"!==f.layer.blendMode;if(iF(f.layer.parent)){var y=ZB(f.layer.parent);(0,Nu.r)(y)&&""!==y&&(m=NB(f.layer.parent)||m)}m&&(u=m,s=!1)}if(0!==p||u){++a;var g=LB(e,d);if(g){if(c[d].pendingUpdates&=~(FU.TEXTURE_NOFADING&FU.TEXTURE_FADING),iF(f.layer.parent)){var _=ZB(f.layer.parent);(0,Nu.r)(_)&&""!==_&&FB(f.layer.parent,d)}eF(f)?o=Math.max(o,this.tileSize*l):1===n&&1===v&&(f.isOpaque||this._dataToTexture(g)&&g.sourceLayerInfo.data.descriptor.isOpaque)&&(s=!0),++i}}else c[d].pendingUpdates&=~(FU.TEXTURE_NOFADING&FU.TEXTURE_FADING)}o=function(e){var t=(0,Vu.a8)(e),r=t*t,n=e*e;if(r===n)return e;var i=t/2;return r-n<n-i*i?t:i}(o);var b=o/this.tileSize,x=d-1;this._ensureBackgroundTexture(this.tileSize),0!==i?1===i&&!u&&this._useLayerTexture(e,x,h,UB[x])||this._composeMapLayers(e,t,x,h,zB,VB,o,b,!s||u,BB,u):this._useBackgroundTexture(e,a)}}},{key:"_ensureBackgroundTexture",value:function(e){(0,Nu.t)(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=cc.f,this._passParameters.scale=1,this._passParameters.opacity=1,(0,Nu.r)(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,(0,Nu.r)(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}},{key:"_useBackgroundTexture",value:function(e,t){var r=Hz.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=Hz.Delayed),this._backgroundTexture&&(0,Nu.t)(e.renderData.textureReference)&&(r=Hz.Immediate),e.renderData.setTextureReference((0,Nu.r)(this._backgroundTexture)?new OB(this._backgroundTexture,XS.FADING,jB,e.surface.baseOpacity,0,1):null,r)}},{key:"_useLayerTexture",value:function(e,t,r,n){var i=t<r,a=i?1:e.surface.baseOpacity,o=i?e.surface.baseOpacity:1,s=LB(e,t);return!!this._dataToTexture(s)&&(e.renderData.setTextureReference(new OB(s.sourceLayerInfo.data,XS.FADING,s,a,o,n)),!0)}},{key:"_composeMapLayers",value:function(e,t,r,n,i,a,o,s,l,u,c){var h=this;this._composition.ensureBuffer(o);for(var d=e.surface.baseOpacity,f=!1,p=pc.L.LINEAR_MIPMAP_LINEAR,v=!1,m=0,y=function(t){var r=LB(e,t);if(!r)return"continue";if(0===i[t]&&!c)return"continue";var y=t<n&&d<1&&!f;h._passParameters.baseOpacity=y?d:1;var g=h._passParameters.baseOpacity<1?xU.Required:xU.NotRequired;y&&(f=!0);var _=!1;u.forEach((function(e){e.start===t&&(GB.push(e),h._composition.openGroup(o),_=!0)}));var b=0===m,x=_?bU.GroupBackgroundComposite:l&&b?h.backgroundIsGrid?bU.GridComposite:bU.ColorComposite:bU.Composite,w=TU[a[t]];for(function(e){var t,r=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,Nu.r)(r)&&"type"in r&&"vector-tile"===r.type}(r)?(h._passParameters.opacity=i[t],v=h._composition.drawVectorData(h._passParameters,x,o,w,g,r,s,h.tileSize,v)):function(e){var t,r=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,Nu.r)(r)&&"type"in r&&"raster-tile"===r.type}(r)?(h._passParameters.opacity=i[t],h._composition.drawImageryTileData(h._passParameters,x,o,w,g,r),h._hasNearestInterpolation(r)&&(p=pc.L.NEAREST)):h._dataToTexture(r)&&(h._passParameters.texture=r.sourceLayerInfo.data.texture,h._passParameters.offset=r.offset,h._passParameters.scale=r.scale,h._passParameters.opacity=i[t],h._composition.drawRasterData(h._passParameters,x,o,w,g));GB.length>0&&GB[GB.length-1].end===t;){var T=GB.pop();h._passParameters.opacity=T.opacity,h._passParameters.offset=cc.f,h._passParameters.scale=1;var C=l&&b?h.backgroundIsGrid?bU.GridComposite:bU.ColorComposite:bU.Composite;h._composition.drawGroup(h._passParameters,C,o,TU[T.blendMode],g)}m++},g=r;g>=0;g--)y(g);var _=e.renderData.ensureTexture(o,(function(){return h._buildTexture(o,p)}));this._composition.copyFBOToTexture(_),this._composition.unbind(),e.renderData.setTextureReference(new OB(_,t,jB,f?1:d,0,1))}},{key:"_hasNearestInterpolation",value:function(e){var t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}},{key:"_dataToTexture",value:function(e){if(function(e){var t,r=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return r instanceof HTMLImageElement||r instanceof IN||r instanceof HTMLCanvasElement||r instanceof ImageData}(e)){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return function(e){var t,r=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,Nu.r)(r)&&"type"in r&&"tile-texture"===r.type}(e)}},{key:"setBackground",value:function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}},{key:"_buildTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pc.L.LINEAR_MIPMAP_LINEAR;if((0,Nu.t)(e))return null;var r,n={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;if("number"==typeof e)n.width=n.height=e,r=new zU(new Oc.E(i,n));else if(e instanceof IN)n.isOpaque=e.isOpaque,r=new zU(new Oc.E(i,n,e.image)),e.release();else try{n.width=e.width,n.height=e.height,r=new zU(new Oc.E(i,n,e))}catch(HX){r=new zU((0,dc.bk)(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}var a=i.bindTexture(r.texture,Oc.E.TEXTURE_UNIT_FOR_UPDATES);return r.generateMipmap(),i.bindTexture(a,Oc.E.TEXTURE_UNIT_FOR_UPDATES),r}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function LB(e,t){HB.layerIndex=t;var r=e.layerInfo[gz.MAP][t];if((0,Nu.r)(r.data))return(0,uc.r)(HB.offset,0,0),HB.tile=e,HB.scale=1,HB.sourceLod=e.lij,HB.sourceLayerInfo=r,HB;var n=r.upsampleInfo;if((0,Nu.r)(n)){var i=n.tile.layerInfo[gz.MAP][t];return HB.tile=n.tile,(0,uc.a)(HB.offset,n.offset),HB.scale=n.scale,HB.sourceLod=n.tile.lij,HB.sourceLayerInfo=i,HB}return null}function ZB(e){return e.get("uid")}function NB(e){var t="normal"!==e.blendMode;return iF(e.parent)&&(t=NB(e.parent)||t),t}function FB(e,t){iF(e.parent)&&FB(e.parent,t);var r=ZB(e);(0,Nu.r)(r)&&""!==r&&(BB.has(r)?BB.get(r).start=t:BB.set(r,new MB(t,t,e.blendMode,e.opacity)))}var zB=new Array,UB=new Array,VB=new Array,BB=new Map,GB=new Array,HB={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},jB={offset:[0,0],scale:1},qB=1e-6;var WB=(0,ku.Z)((function e(t,r,n,i,a){(0,Au.Z)(this,e),this.aabb=t,this.axis=r,this.d=n,this.midStartIndex=i,this.rightStartIndex=a})),XB=function(){function e(t,r,n,i){var a=this;(0,Au.Z)(this,e),this.globalTriangleVertexIndices=t,this.firstTriangleIndex=r,this.positionAttribute=i,this._rayDirection=(0,Vu.n)(),this.bspNodeTree=new Array,this.vertexPositionBuffer=i.data,this.vertexPositionStride=i.stride;var o=n-r,s=o<=JB?new Uint16Array(o):new Uint32Array(o);this.indices=s;for(var l=0;l<o;++l)s[l]=l;var u=function(e,t,r,n,i){for(var a=r-t,o=new Float32Array(6*a),s=0;s<a;++s)for(var l=3*(s+t),u=e[l+0]*i,c=e[l+1]*i,h=e[l+2]*i,d=0;d<3;++d){var f=n[u+d],p=n[c+d],v=n[h+d];o[6*s+d]=Math.min(f,p,v),o[6*s+3+d]=Math.max(f,p,v)}return o}(t,r,n,i.data,i.stride),c=(0,Vu.a)(Math.log2(o/40),2,10);(function e(t,r,n){var i=function(e,t,r,n){if(n<=r)return(0,Gc.u)(NaN,NaN,NaN,NaN,NaN,NaN);for(var i=6*e[r],a=0;a<3;++a)QB[a]=t[i+0+a],KB[a]=t[i+3+a];for(var o=r+1;o<n;++o)for(var s=6*e[o],l=0;l<3;++l)QB[l]=Math.min(QB[l],t[s+0+l]),KB[l]=Math.max(KB[l],t[s+3+l]);return(0,Gc.u)(QB[0],QB[1],QB[2],KB[0],KB[1],KB[2])}(s,u,t,r),o=r-t;if(o<=40){var l=new WB(i,void 0,0,t,r);return a.bspNodeTree.push(l),l}var h=function(e){var t=e[3]-e[0],r=e[4]-e[1],n=e[5]-e[2],i=t>r?t>n?0:r>n?1:2:r>n?1:n>t?2:0;return{axis:i,midValue:(e[i]+e[i+3])/2}}(i),d=h.axis,f=h.midValue,p=function(e,t,r,n,i,a){for(var o=r,s=n;o<s;){var l=e[o];t[6*l+i+3]<=a?++o:(--s,e[o]=e[s],e[s]=l)}var u=o;for(s=n;u<s;){var c=e[s-1];t[6*c+i]>=a?--s:(e[s-1]=e[u],e[u]=c,++u)}return{next:o,mid:u}}(s,u,t,r,d,f),v=function(t,r){if(!(n>c)){var i=r-t;return i<40||i>=.8*o?void 0:e(t,r,n+1)}},m=new WB(i,d,f,p.next,p.mid);return a.bspNodeTree.push(m),m.leftNode=v(t,p.next),m.rightNode=v(p.mid,r),m})(0,o,0),this.triangleVertexIndices=function(e,t,r,n){for(var i=n-r,a=0,o=r;o<n;++o)for(var s=0;s<3;++s)a=Math.max(t[3*o+s],a);for(var l=a<=JB?new Uint16Array(3*i):new Uint32Array(3*i),u=0;u<i;++u)for(var c=3*(e[u]+r),h=0;h<3;++h){var d=t[c+h];l[3*u+h]=d}return l}(s,t,r,n)}return(0,ku.Z)(e,[{key:"intersectRayTriangleRange",value:function(t,r){if(!(t>=r)){for(var n=this.triangleVertexIndices,i=this.positionAttribute.data,a=this.positionAttribute.stride,o=this._rayOrigin,s=o[0],l=o[1],u=o[2],c=this._rayDirection,h=c[0],d=c[1],f=c[2],p=t,v=3*t;p<r;++p){var m=n[v++]*a,y=i[m++],g=i[m++],_=i[m];m=n[v++]*a;var b=i[m++],x=i[m++],w=i[m];m=n[v++]*a;var T=b-y,C=x-g,S=w-_,O=i[m++]-y,P=i[m++]-g,R=i[m]-_,A=d*R-P*f,k=f*O-R*h,E=h*P-O*d,D=T*A+C*k+S*E;if(!(Math.abs(D)<=Number.EPSILON)){var M=s-y,I=l-g,L=u-_,Z=M*A+I*k+L*E;if(D>0){if(Z<0||Z>D)continue}else if(Z>0||Z<D)continue;var N=I*S-C*L,F=L*T-S*M,z=M*C-T*I,U=h*N+d*F+f*z;if(D>0){if(U<0||Z+U>D)continue}else if(U>0||Z+U<D)continue;var V=(O*N+P*F+R*z)/D;if(V>=0){var B=this.indices[p]+this.firstTriangleIndex,G=(0,dc.bl)(T,C,S,O,P,R,YB);this._callback(V,G,B,!1)}}}e.numFacesTested+=r-t}}},{key:"intersectRay",value:function(t,r){e.numFacesTested=0;var n=(0,Vu.c)(t.r0[0],t.r0[1],t.r0[2]),i=(0,Vu.c)(t.r1[0],t.r1[1],t.r1[2]),a=i[0]-n[0],o=i[1]-n[1],s=i[2]-n[2];if(!(a*a+o*o+s*s<qB)){this._rayOrigin=n;var l=this._rayDirection;l[0]=a,l[1]=o,l[2]=s;var u=this.triangleVertexIndices.length/3;this._callback=r;var c=this.bspNodeTree[0];this.intersectRayBSP(c,0,u)}}},{key:"intersectRayBSP",value:function(e,t,r){var n=this._rayOrigin,i=this._rayDirection;if(function(e,t,r){for(var n=t,i=r,a=0,o=1/0,s=0;s<3;++s){var l=e[s];if(n[s]<l){if(i[s]<=qB)return!1;var u=(l-n[s])/i[s];a=Math.max(a,u)}else if(i[s]<=-qB){var c=(l-n[s])/i[s];o=Math.min(o,c)}if(a>o)return!1;var h=e[s+3];if(n[s]>h){if(i[s]>=-qB)return!1;var d=(h-n[s])/i[s];a=Math.max(a,d)}else if(i[s]>=qB){var f=(h-n[s])/i[s];o=Math.min(o,f)}if(a>o)return!1}return!0}(e.aabb,n,i)){var a=e.axis,o=e.d;if(n[a]<o||i[a]<0){var s=t,l=e.midStartIndex;if(s<l){var u=e.leftNode;void 0!==u?this.intersectRayBSP(u,s,l):this.intersectRayTriangleRange(s,l)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),n[a]>o||i[a]>0){var c=e.rightStartIndex,h=r;if(c<h){var d=e.rightNode;void 0!==d?this.intersectRayBSP(d,c,h):this.intersectRayTriangleRange(c,h)}}}}},{key:"estimatedMemoryUsage",get:function(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}]),e}();XB.numFacesTested=0;var YB=(0,Vu.n)(),QB=[1/0,1/0,1/0],KB=[-1/0,-1/0,-1/0];var JB=65535,$B=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.overlayMode=sV.Disabled,e.tileBlendInput=vV.LayerOnly,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.atmosphere=!1,e.receiveShadows=!1,e.hasSlicePlane=!1,e.backfaceCullingEnabled=!1,e.stencilEnabled=!1,e.textureFadingEnabled=!1,e.renderOccluded=!1,e.hasScreenSpaceReflections=!1,e.hasCloudsReflections=!1,e.shading=!Ac.t.TERRAIN_USE_LEGACY_SHADING,e.useLegacyTerrainShading=Ac.t.TERRAIN_USE_LEGACY_SHADING,e.transparent=!1,e.tileBorders=!1,e.visualizeNormals=!1,e.screenSizePerspective=!1,e.receiveAmbientOcclusion=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],$B.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:sV.COUNT})],$B.prototype,"overlayMode",void 0),(0,Eu.e)([(0,dc.p)({count:vV.COUNT})],$B.prototype,"tileBlendInput",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"atmosphere",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"receiveShadows",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"backfaceCullingEnabled",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"stencilEnabled",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"textureFadingEnabled",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"renderOccluded",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"hasScreenSpaceReflections",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"hasCloudsReflections",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"shading",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"useLegacyTerrainShading",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"transparent",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"tileBorders",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"visualizeNormals",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"screenSizePerspective",void 0),(0,Eu.e)([(0,dc.p)()],$B.prototype,"receiveAmbientOcclusion",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.B.Disabled})],$B.prototype,"pbrMode",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.bm.CompressedAttribute})],$B.prototype,"normalType",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.d.Compressed})],$B.prototype,"textureCoordinateType",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],$B.prototype,"highStepCount",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],$B.prototype,"useCustomDTRExponentForWater",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],$B.prototype,"useFillLights",void 0);var eG,tG=(0,Gc.a)();!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.Invisible=2]="Invisible"}(eG||(eG={}));var rG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).type=qu.M.TERRAIN,n.isGround=!0,n._tileSize=256,n._techniqueConfiguration=new $B,n._passParameters=new CV,n._rctx=null,n._scaleRangeQueries=new yB,n._renderDataPool=new Eu.h(EV),n._patchGroups=new Map,n._patchGroupsDirty=!0,n._patchSortingDirty=!0,n._tileIterator=new Qz,n._highestVisibleLODTile=null,n._visible=!0,n._transparencyState=eG.Opaque,n._velvetOverground=!0,n._castShadows=!0,n._emptyTex=null,n._tileRenderer=null,n._stencilEnabledLayerExtents=new Array,n._numTilesRendered=0,n._numTilesCulled=0,n._numOriginsRendered=0,n.needsHighlight=!1,n.renderOccludedFlags=dc.ah.Occlude,n}return(0,ku.Z)(r,[{key:"_isGlobal",get:function(){return this._stage.viewingMode===ic.l.Global}},{key:"shading",get:function(){return this._techniqueConfiguration.shading},set:function(e){this._techniqueConfiguration.shading=e}},{key:"initialize",value:function(){var e=[dc.H.OPAQUE_TERRAIN,dc.H.TRANSPARENT_TERRAIN,dc.H.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}},{key:"destroy",value:function(){this._stage.removeRenderPlugin(this),Nz.clear()}},{key:"canRender",get:function(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}},{key:"renderingDisabled",set:function(e){this._set("renderingDisabled",!!e),this.setDirty()}},{key:"transparency",get:function(){return this._transparencyState},set:function(e){this._transparencyState!==e&&(this._techniqueConfiguration.transparent=e===eG.Invisible,this._transparencyState=e,this.setNeedsRender())}},{key:"needsLinearDepth",get:function(){return this._overlayRenderer.hasWater}},{key:"renderPatchBorders",get:function(){return!!this._techniqueConfiguration.tileBorders},set:function(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}},{key:"visualizeNormals",get:function(){return!!this._techniqueConfiguration.visualizeNormals},set:function(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}},{key:"cullBackFaces",get:function(){return this._techniqueConfiguration.backfaceCullingEnabled},set:function(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}},{key:"renderOrder",set:function(e){this._set("renderOrder",e),this._setSortingDirty()}},{key:"velvetOverground",set:function(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}},{key:"layerUid",get:function(){return Ic.j}},{key:"slicePlaneEnabled",get:function(){return this._techniqueConfiguration.hasSlicePlane},set:function(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}},{key:"textureFadingEnabled",set:function(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}},{key:"setDebugScreenSizePerspective",value:function(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}},{key:"setRootTiles",value:function(e){this._rootTiles=e,this.setDirty()}},{key:"setNeedsHighlight",value:function(e){this.needsHighlight=e,this.setNeedsRender()}},{key:"setRenderOccludedOverlay",value:function(e){this.renderOccludedFlags=e?yA:dc.ah.Occlude,this.setNeedsRender()}},{key:"setStencilEnabledLayerExtents",value:function(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}},{key:"setTileSize",value:function(e){this._tileSize=e,(0,Nu.r)(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}},{key:"_prepareTileForLoading",value:function(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}},{key:"loadTile",value:function(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,FU.TEXTURE_FADING)}},{key:"queryVisibleLevelRange",value:function(e,t,r,n){this._scaleRangeQueries.queryVisibleLevelRange(e,t,r,n),this.setNeedsRender()}},{key:"updateTileTexture",value:function(e,t){(0,Nu.r)(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,t===FU.TEXTURE_FADING?XS.FADING:XS.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}},{key:"updateTileGeometryState",value:function(e){var t,r=(0,Cu.Z)(e.layerInfo[gz.ELEVATION]);try{for(r.s();!(t=r.n()).done;){t.value.pendingUpdates&=~FU.GEOMETRY}}catch(i){r.e(i)}finally{r.f()}e.resetPendingUpdate(FU.GEOMETRY);var n=e.renderData.updateGeometryState();return n&&this.setDirty(),n}},{key:"updateGeometryIfNeeded",value:function(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}},{key:"unloadTile",value:function(e){var t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}},{key:"_getLocalOriginOfTile",value:function(e){var t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return Vu.a7;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}},{key:"setVisibility",value:function(e){this._visible=e,this.setDirty()}},{key:"getStats",value:function(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}},{key:"wireframe",set:function(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}},{key:"setDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vc.N.UPDATE;this._patchGroupsDirty=!0,this._context.requestRender(e)}},{key:"_setSortingDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vc.N.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}},{key:"setNeedsRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vc.N.UPDATE;this._context.requestRender(e)}},{key:"initializeRenderContext",value:function(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.shaderTechniqueRepository,this._tileRenderer=new IB(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=(0,dc.bk)(this._rctx)}},{key:"uninitializeRenderContext",value:function(){this._emptyTex=(0,Nu.G)(this._emptyTex),this._tileRenderer=(0,Nu.G)(this._tileRenderer)}},{key:"intersect",value:function(e,t,r,n){var i=this;if(!(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==eG.Opaque)){var a=nG,o=iG;(0,Vu.e)(a,n,r),(0,Vu.o)(o,1/a[0],1/a[1],1/a[2]);var s,l=e.results.min,u=e.results.max,c=e.results.ground,h=e.options.store===qu.J.MIN,d=!!e.results.ground.target,f=(0,Ic.L)(e.verticalOffset),p=e.tolerance,v=h&&(0,Nu.r)(l.dist)?l.dist:1/0,m=function(d){var m=d.renderData;if(null!==m&&void 0!==m&&m.vao){var y=m.geometryInfo;(0,Gc.w)(tG,y.boundingBox);var g=m.localOrigin;(0,Nu.r)(f)&&(f.localOrigin=g,f.applyToAabb(tG));var _=tG;if(aG[0]=r[0]-g[0],aG[1]=r[1]-g[1],aG[2]=r[2]-g[2],(0,dc.bi)(_,aG,o,p,v)){var b=function(e,t,r){e.set(i.type,d,t,r,hc.o),v=h&&(0,Nu.r)(l.dist)?l.dist:1/0},x=function(i,o){if((0,Nu.r)(o)&&i>=0&&(e.options.backfacesTerrain||(0,Vu.P)(o,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(r,n,i))){if((null==c.dist||i<c.dist)&&b(c,i,o),e.options.isFiltered)return;e.options.store===qu.J.ALL&&((0,Nu.t)(s)?(s=(0,qu.L)(e.ray),b(s,i,o),e.results.all.push(s)):i<s.dist&&b(s,i,o)),(null==l.dist||i<l.dist)&&b(l,i,o),e.options.store!==qu.J.MIN&&(null==u.dist||i>u.dist)&&b(u,i,o)}},w=oG;(0,Vu.e)(w,n,g);var T=y.indices,C=y.vertexAttributes,S={data:C.getField(fc.O.POSITION,Zc.i).typedBuffer,size:3,stride:C.stride/4},O=y.indexCount/3;if((0,Nu.t)(f)&&O>200){var P=d.renderData;(0,Nu.t)(P.intersectionData)&&(P.intersectionData=new XB(T,0,O,S)),P.intersectionData.intersectRay({r0:aG,r1:w},x)}else(0,dc.a$)(aG,w,0,O,T,S,null,f,x)}}},y=this._rootTiles;(0,Nu.r)(y)&&function(){var t=i._tileIterator;t.reset(y);for(var n=e.options.invisibleTerrain;!t.done;){var o=t.next();!(o.visible||n&&o.intersectsClippingArea)||!(0,Nu.r)(f)&&!o.intersectsRay(r,a,p,v)||d&&i._useStencilForTile(o)?t.skipSubtree():m(o)}}()}}},{key:"prepareTechnique",value:function(e){if(e.bindParameters.slot===dc.H.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&yA))return null}else{var t=this.transparency===eG.Opaque?dc.H.OPAQUE_TERRAIN:dc.H.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.output){case dc.O.Color:this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=(0,Nu.r)(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.ready,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty()?sV.Disabled:this._overlayRenderer.hasWater?sV.EnabledWithWater:sV.Enabled;var r=e.bindParameters.slot===dc.H.OCCLUDED_TERRAIN?KS.Occluded:KS.ColorAndWater;return this._updateTechnique(dc.O.Color,r===KS.Occluded);case dc.O.Shadow:case dc.O.ShadowExludeHighlight:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(dc.O.Shadow,!1)):null;case dc.O.Depth:return this.transparency===eG.Invisible&&this._overlayRenderer.isEmpty()?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(dc.O.Depth,!1));case dc.O.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(dc.O.Normal,!1);case dc.O.ObjectAndLayerIdColor:return this._updateTechnique(dc.O.ObjectAndLayerIdColor,!1);case dc.O.Highlight:return this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(dc.O.Highlight,!1)):null}return null}},{key:"render",value:function(e,t){var r=this,n=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case dc.O.Color:var i=e.bindParameters.slot===dc.H.OCCLUDED_TERRAIN?KS.Occluded:KS.ColorAndWater;this.transparency===eG.Opaque?this._renderMaterialPass(e,t,i):e.offscreenRenderingHelper.renderToTargets((function(){return r._renderMaterialPass(e,t,i)}),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break;case dc.O.Shadow:case dc.O.ShadowExludeHighlight:this._castShadows&&n&&this._renderAuxiliaryPass(e,t,KS.None);break;case dc.O.Depth:this.transparency===eG.Invisible&&this._overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,KS.None);break;case dc.O.Normal:this._renderAuxiliaryPass(e,t,KS.None);break;case dc.O.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,KS.ObjectAndLayerIdColor);break;case dc.O.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,t,KS.Highlight)}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}},{key:"_renderMaterialPass",value:function(e,t,r){var n=e.rctx;this._passParameters.overlaySource=r,n.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this._renderPatchGroups(e,t,r),this._scaleRangeQueries.processQueries()}},{key:"_renderAuxiliaryPass",value:function(e,t,r){var n=e.rctx;this._passParameters.overlaySource=r,n.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,r)}},{key:"updateTileBackground",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!(0,Nu.t)(this._tileRenderer)){var t=this._tileRenderer,r=null;if((0,Nu.r)(e)){var n=sc.l.toUnitRGBA(e);r=(0,Vu.c)(n[0]||0,n[1]||0,n[2]||0)}t.setBackground(r),this._allTiles.forAll((function(e){return t.updateTileTexture(e,XS.FADING)})),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?vV.GridComposite:(0,Nu.r)(t.backgroundColor)?vV.ColorComposite:vV.LayerOnly,this.setNeedsRender()}}},{key:"_updatePatchGroups",value:function(){var e=this;if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==uB.NONE){var t=Array.from(this._patchGroups.values());t.forEach((function(t){return eU(e.renderOrder,t,e._stencilEnabledLayerExtents)})),t.sort((function(t,r){return tU(t[0],r[0],e.renderOrder)})),this._patchGroups=new Map(t.map((function(e){return[e[0].renderData.localOrigin,e]}))),this._patchSortingDirty=!1}}},{key:"_rebuildPatchGroups",value:function(){var e=this._rootTiles;if(!(0,Nu.t)(e)){var t;null!==(t=e[0])&&void 0!==t&&t.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();var r,n=(0,Cu.Z)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;this._rebuildPatchGroupsForRootTile(i)}}catch(a){n.e(a)}finally{n.f()}}}},{key:"_rebuildPatchGroupsForRootTile",value:function(e){var t=this._tileIterator;for(t.resetOne(e);!t.done;){var r=t.next(),n=r.renderData;if(!n||r.visible)if(r.rendered){if(n){var i=this._patchGroups.get(n.localOrigin)||new Array;this._patchGroups.set(n.localOrigin,i),i.push(r),(!this._highestVisibleLODTile||r.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=r),t.skipSubtree()}}else this._numTilesCulled++;else this._numTilesCulled++,t.skipSubtree()}}},{key:"_useStencilForTile",value:function(e){var t,r=(0,Cu.Z)(this._stencilEnabledLayerExtents);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(e.intersectsExtent(n))return!0}}catch(i){r.e(i)}finally{r.f()}return!1}},{key:"_renderPatchGroupsAuxiliary",value:function(e,t,r){var n=this,i=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((function(a){var o=a[0].renderData.localOrigin;t.program.bindDraw(new fR(o),e.bindParameters,n._passParameters);for(var s=0;s<a.length;s++)n._renderPatch(e,t,a[s],pc.E.TRIANGLES,i,r)})),e.rctx.bindVAO(null)}},{key:"_renderPatchGroups",value:function(e,t,r){var n=this,i=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){var o=(0,dc.bb)(this._stage.viewingMode,this._ellipsoidRadius),s=this.pointsOfInterest.centerOnSurfaceFrequent.distance;o.update({distance:s,fovY:i.fovY})}var l=this._stencilEnabledLayerExtents.length>0,u=r===KS.Occluded;u&&(a.bindTexture("tex",this._emptyTex),a.setUniform1f("blend",1),a.setUniform4fv("texOffsetAndScale",lc.l));var c=(0,Nu.r)(this._tileRenderer)&&(0,Nu.r)(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:Vu.a7;this._techniqueConfiguration.tileBlendInput===vV.ColorComposite&&a.setUniform3fv("backgroundColor",c);var h=this.wireframe?pc.E.LINES:pc.E.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex),this._patchGroups.forEach((function(i){var o=i[0].renderData.localOrigin;t.program.bindDraw(new fR(o),e.bindParameters,n._passParameters),n._numOriginsRendered++;for(var s=0;s<i.length;s++){var c=i[s],d=c.renderData.textureReference;if(!(0,Nu.t)(d)){if(!u){n._scaleRangeQueries.scaleQueriesForTile(c),a.setUniform4fv("texOffsetAndScale",d.offsetAndScale),a.bindTexture("tex",d.texture.texture);var f=c.renderData.textureFadeFactor,p=f<1?c.renderData.nextTextureReference:null;n._techniqueConfiguration.textureFadingEnabled&&(0,Nu.r)(p)&&f<1?(a.setUniform1f("fadeFactor",f),a.setUniform4fv("nextTexOffsetAndScale",p.offsetAndScale),a.setUniform3fv("nextTexOpacities",p.opacities),a.bindTexture("texNext",p.texture.texture)):a.setUniform1f("fadeFactor",1),c.renderData.textureIsFading&&n.setNeedsRender(),a.setUniform3fv("textureOpacities",d.opacities)}n._renderPatch(e,t,c,h,l,r),c.renderOrder=n._numTilesRendered,n._numTilesRendered++}}})),e.rctx.bindVAO(null)}},{key:"_renderPatch",value:function(e,t,r,n,i,a){var o=r.renderData,s=o.vao,l=s.indexBuffer;if((0,Nu.t)(l))WN&&console.error("Rendered tile with no indices: ",r.lij," : ",o);else{var u=t.program;a!==KS.None&&this._bindOverlayPatchData(u,o.overlay),i&&(t.useStencil=this._useStencilForTile(r),t.bindPipelineState(e.rctx,e.bindParameters.slot));var c=o.geometryInfo.indexCount;e.rctx.bindVAO(s),u.assertCompatibleVertexAttributeLocations(s),e.rctx.drawElements(n,c,l.indexType,0)}}},{key:"_bindOverlayPatchData",value:function(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}},{key:"_updateTechnique",value:function(e,t){return this._techniqueConfiguration.output=e,e===dc.O.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(AV,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}},{key:"test",get:function(){return{tileRenderer:this._tileRenderer}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rG.prototype,"_overlayRenderer",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rG.prototype,"_stage",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],rG.prototype,"_isGlobal",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rG.prototype,"_allTiles",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],rG.prototype,"_ellipsoidRadius",void 0),(0,Eu.e)([(0,Eu.y)({value:!1})],rG.prototype,"renderingDisabled",null),(0,Eu.e)([(0,Eu.y)()],rG.prototype,"renderPatchBorders",null),(0,Eu.e)([(0,Eu.y)()],rG.prototype,"visualizeNormals",null),(0,Eu.e)([(0,Eu.y)()],rG.prototype,"cullBackFaces",null),(0,Eu.e)([(0,Eu.y)({value:uB.FRONT_TO_BACK})],rG.prototype,"renderOrder",null),(0,Eu.e)([(0,Eu.y)()],rG.prototype,"wireframe",null),rG=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.TerrainRenderer")],rG);var nG=(0,Vu.n)(),iG=(0,Vu.n)(),aG=(0,Vu.n)(),oG=(0,Vu.n)(),sG=(0,ku.Z)((function e(){(0,Au.Z)(this,e),this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array})),lG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){var e=this;this._handles.add(this.layers.on("change",(function(){return e._update()}))),this._handles.add((0,Fu.l)((function(){return e.extentHelper.layerViewsExtent}),(function(){return e._setAdHocTilingScheme()}))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}},{key:"destroy",value:function(){this._handles=(0,Nu.g)(this._handles),this._waitTask=null}},{key:"_update",value:function(){var e,t=this;if((this._waitTask=null,!this.tilingSchemeLocked)&&(this.layers.some((function(r){return!(!(0,$u.t)(r)||r.isRejected())&&!(r.isFulfilled()&&!function(e,t,r){return(0,Nu.r)(hF(e,t,r))}(r,t.viewSpatialReference,t.viewingMode))&&(e=r,!("vector-tile"===(null===r||void 0===r?void 0:r.type)||KN(r)))})),e))if(e.isResolved()){var r=hF(e,this.viewSpatialReference,this.viewingMode);if((0,Nu.r)(r)){var n=new Ih(r.tileInfo);this._lockTilingScheme(n)}}else this._updateWhen(e)}},{key:"_updateWhen",value:function(e){var t=this,r=e.when().catch((function(){})).then((function(){r!==t._waitTask||t.destroyed||t._update()}));this._waitTask=r}},{key:"_lockTilingScheme",value:function(e){var t=this;if(this.viewingMode===ic.l.Global){var r=e.levels.length-1;e.spatialReference.isWebMercator?e=Ih.makeWebMercatorAuxiliarySphere(r):(0,Hu.R)(e.spatialReference)&&(e=Ih.makeGCSWithTileSize(e.spatialReference,e.pixelSize,r))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add((0,Fu.l)((function(){return t.extentHelper.tiledLayersExtent}),(function(){return t._updateTiledLayerExtent()})))}},{key:"_updateTiledLayerExtent",value:function(){this._set("extent",this.extentHelper.tiledLayersExtent)}},{key:"_setAdHocTilingScheme",value:function(){if(this.viewingMode===ic.l.Global){var e=this.extentHelper.viewSpatialReference,t=(0,Hu.R)(e)||(0,Yu.P)(e)||(0,Yu.c)(e);e.isWebMercator?this.tilingScheme=Ih.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Ih.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{var r=this.extentHelper.layerViewsExtent;(0,Nu.r)(r)&&!(0,ju.I)(r,this.extent)&&(this.tilingScheme=Ih.fromExtent(r,this.extentHelper.viewSpatialReference),this._set("extent",r))}}},{key:"test",get:function(){var e=this;return{lockTilingScheme:function(t){return e._lockTilingScheme(t)},done:!this._waitTask}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],lG.prototype,"tilingScheme",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],lG.prototype,"extent",void 0),(0,Eu.e)([(0,Eu.y)({value:!1})],lG.prototype,"tilingSchemeLocked",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],lG.prototype,"viewSpatialReference",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],lG.prototype,"layers",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],lG.prototype,"extentHelper",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],lG.prototype,"viewingMode",void 0),lG=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.TilingSchemeLogic")],lG);var uG=function(){function e(){(0,Au.Z)(this,e),this.offset=(0,cc.n)(),this.scale=0,this.tile=null}return(0,ku.Z)(e,[{key:"init",value:function(e,t,r,n){this.tile=e,this.offset[0]=t,this.offset[1]=r,this.scale=n}},{key:"dispose",value:function(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}]),e}(),cG=function(e){(0,Pu.Z)(n,e);var t=(0,Ru.Z)(n);function n(e){var r,i,a;return(0,Au.Z)(this,n),(a=t.call(this,e))._iteratorPool=new Eu.h(Qz,(function(e){return e.remove=function(){return a._iteratorPool.release(e)}})),a._postorderIterator=new Kz,a._hasPendingUpdates=!1,a._pendingUpdates=0,a._asyncWorkItems=0,a._allTilesDirty=!0,a._allTilesSorted=!0,a._visibleCached=!1,a._usedMemory=null,a._performanceInfo=new sG,a._viewChanged=!1,a._inFrameTask=!1,a._viewChangeUpdateDirty=!1,a._eyePosRenderSR=(0,Vu.n)(),a._eyePosSurfaceSR=(0,Vu.n)(),a._splitLimits=new GU,a._frustum=(0,kc.H)(),a._viewProjectionMatrix=(0,hc.e)(),a._layerViews=[new Array,new Array],a._layerIndexByUid=[new Map,new Map],a._basemapLayerViewHandles=new Map,a._handles=new Eu.X,a._watchUpdatingTracking=new oc.c,a._frameTask=bc.y,a._allTiles=new Eu.a6,a._upsampleInfoPool=new Eu.h(uG),a._rootTilesExtent=(0,ju.u)(),a._maxNumUpdating=1,a.maxTextureScale=1.2,a._spatialReference=Yu.k.WebMercator,a.visibleElevationBounds=new dz(1/0,-1/0),a.rootTileElevationBounds=new dz(1/0,-1/0),a._updatingRootTiles=!1,a._pendingTilesForElevationUpdateEvent=new Set,a._pendingTilesToUpdate=new Set,a.totalGeometryUpdates=0,a.totalTileUpdates=0,a.oneBatchPerFrameTask=!0,a._layerViewsDirty=!1,a._shading=!0,a._isWebMercator=!1,a._isWebMercatorOnPlateeCarree=!1,a._isGlobal=!(null!==(r=e.view)&&void 0!==r&&null!==(i=r.state)&&void 0!==i&&i.isLocal),a}return(0,ku.Z)(n,[{key:"initialize",value:function(){var e=this;this._lercDecoder=(0,ph.n)(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Eu.h(hB):new Eu.h(pB);var t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("esri.views.3d.terrain.upsample",(function(e){return e.unloadMapData()})),this._elevationQueryCache=new uz(t.newCache("elevation-query")),this._set("overlayManager",new Sz({surface:this})),this._handles.add([(0,Fu.l)((function(){return e.overlayManager.hasHighlights}),(function(t){return e._renderer.setNeedsHighlight(t)})),(0,Fu.l)((function(){return e.overlayManager.rendersOccluded}),(function(t){return e._renderer.setRenderOccludedOverlay(t)}))],"overlayManager"),this._renderer=new rG({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:(0,Xu.u)(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([(0,Fu.l)((function(){return e.baseOpacity}),(function(t){e._handleLayerViewChanges(),e._updateBaseOpacity(t)}),Fu.w),(0,Fu.l)((function(){return e.hasCompositeBlendMode}),(function(){e._updateBaseOpacity(e.baseOpacity)}),Fu.w),(0,Fu.l)((function(){return e.renderingDisabled}),(function(){var t,r;return null===(t=e.view)||void 0===t||null===(r=t._stage)||void 0===r?void 0:r.renderView.setRenderParameters({terrainRenderingEnabled:!e.renderingDisabled})}),Fu.U),(0,Fu.l)((function(){return e.backgroundColor}),(function(t){e._handleLayerViewChanges(),e._renderer.updateTileBackground(t)}),Fu.w),(0,Fu.l)((function(){return e.snapLevel}),(function(){return e._viewChanged=!0}),Fu.U),(0,Fu.l)((function(){return e.view.pointsOfInterest}),(function(t){e._renderer.pointsOfInterest=t,e._watchUpdatingTracking.removeAll(),t&&e._watchUpdatingTracking.add((function(){return t.focus.renderLocation}),(function(){return e._allTilesSorted=!1}))})),(0,Fu.l)((function(){return Ac.t.TERRAIN_TILE_TREE_SHOW_TILES}),(function(t){t&&!e._treeDebugger?r.e(4333).then(r.bind(r,34333)).then((function(t){var r=t.TerrainTileTree3DDebugger;!e._treeDebugger&&Ac.t.TERRAIN_TILE_TREE_SHOW_TILES&&(e._treeDebugger=new r({view:e.view}))})):t||(e._treeDebugger=(0,Nu.g)(e._treeDebugger))}),Fu.h)]),this._extentHelper=function(e,t){return e===ic.l.Global?new yz(t):new _z(t)}(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});var n=new dh.l({getCollections:function(){var t,r,n;return null===(t=e.view)||void 0===t||null===(r=t.defaultsFromMap)||void 0===r||null===(n=r.mapCollections)||void 0===n?void 0:n.map((function(e){return e.layers}))},getChildrenFunction:function(e){return e&&"layers"in e?e.layers:null}}),i=new lG({layers:n,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(bN.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(bN.BASEMAP);var a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(bc.I.TERRAIN_SURFACE,this),this._handles.add([(0,Fu.l)((function(){return e._extentHelper.stencilEnabledExtents}),(function(t){return e._renderer.setStencilEnabledLayerExtents(t)}),Fu.h),(0,Fu.l)((function(){return e.tilingSchemeLogic.tilingScheme}),(function(){return e._updateTilingScheme()}),Fu.U),(0,Fu.l)((function(){return e.extent}),(function(){return e._updateRootTiles()}),Fu.h),this.view.on("resize",(function(){return e._viewChangeUpdate()})),(0,Fu.l)((function(){var t,r,n=e.view,i=n.state;return[e._lodBias,e.lodSnapping,null===(t=n.resourceController)||void 0===t||null===(r=t.memoryController)||void 0===r?void 0:r.memoryFactor,i.camera,i.contentCamera,i.fixedContentCamera]}),(function(){return e._viewChangeUpdate()}),Fu.w),(0,Fu.l)((function(){var t,r;return null===(t=e.view.qualitySettings)||void 0===t||null===(r=t.tiledSurface)||void 0===r?void 0:r.textureFadeDuration}),(function(t){return e._renderer.textureFadingEnabled=t>0}),Fu.h),(0,Fu.l)((function(){return e._userClippingExtent}),(function(){return e._updateClippingExtent()}),Fu.U)]),this._handles.add(this.view.allLayerViews.on("after-changes",(function(){return e._layerViewsDirty=!0}))),this._handles.add([(0,Fu.l)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.map.ground.shading}),(function(){e._updateShadingIfChanged()}))]),this._updateShading(),this._layerViewsDirty=!0,this._handleLayerViewChanges()}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=(0,Nu.F)(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=(0,Nu.g)(this._upsampleMapCache),this._elevationQueryCache=(0,Nu.g)(this._elevationQueryCache);var t=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",(0,Nu.g)(this.tilingSchemeLogic)),t.destroy(),this._basemapLayerViewHandles.forEach((function(t,r){return e._unregisterTiledLayerView(r)})),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,Nu.g)(this.overlayManager)),this._tilePool=(0,Nu.g)(this._tilePool),HU.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=(0,Nu.g)(this._renderer),this._iteratorPool=(0,Nu.g)(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=(0,Nu.g)(this._upsampleInfoPool),(0,vh.p)(),NU.size>0&&(console.log("".concat(NU.size," live TilePerLayerInfo allocations:")),NU.forEach((function(e){return console.log(e,"\n")})))}},{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===qS.ON){var e,t,r=this.view,n=this.tilingScheme,i=null===(e=r.pointsOfInterest)||void 0===e||null===(t=e.contentCameraOnSurface)||void 0===t?void 0:t.scale;if(i&&n){var a=r.state.contentCamera,o=(0,qu.W)(r,a.eye,a.viewForward,a.up).tilt;o>90&&(o=180-o);var s=2*Math.pow(o/90,2),l=n.levelAtScale(i)-s;return Math.round(l)}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?qS.ON:qS.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var e=this.spatialReference,t=this.view.clippingArea;if((0,Nu.t)(t)||(0,Nu.t)(e))return null;var r=(0,ju.u)(),n=IZ(t,r,e)?r:null,i=this._get("extent");return(0,ju.I)(n,i)?i:n}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){var e=(0,ju.U)(this.groundExtent,this._userClippingExtent,(0,ju.u)()),t=this._get("extent");return(0,ju.I)(e,t)?t:e}},{key:"groundExtent",get:function(){return(0,Nu.r)(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var e;return null===(e=this.tilingSchemeLogic)||void 0===e?void 0:e.extent}},{key:"updating",get:function(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){return this.view.map.ground.opacity},set:function(e){this.view.map.ground.opacity=e}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return(0,Nu.r)(this.rootTiles)}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"spatialReference",get:function(){var e,t;return null!==(e=null===(t=this.tilingScheme)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:null}},{key:"backgroundColor",get:function(){return this.view.map.ground.surfaceColor},set:function(e){this.view.map.ground.surfaceColor=e}},{key:"slicePlaneEnabled",set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency(this.baseOpacity)}},{key:"tilingSchemeLocked",get:function(){var e,t;return null!==(e=null===(t=this.tilingSchemeLogic)||void 0===t?void 0:t.tilingSchemeLocked)&&void 0!==e&&e}},{key:"velvetOverground",set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}},{key:"wireframe",get:function(){return this._renderer.wireframe},set:function(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}},{key:"_visible",set:function(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}},{key:"opaque",get:function(){return this._renderer.transparency===eG.Opaque}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"textureFadeDuration",get:function(){var e;return null!==(e=this.view.qualitySettings.tiledSurface.textureFadeDuration)&&void 0!==e?e:0}},{key:"intersect",value:function(e,t,r,n){this._renderer.intersect(e,t,r,n)}},{key:"getElevation",value:function(e,t,r,n){var i=this.rootTiles;if((0,Nu.t)(i)||!i.length)return null;if(0===i[0].layerInfo[gz.ELEVATION].length)return null;var a=pG;return a[0]=e,a[1]=t,a[2]=r,(0,Hu.j)(a,n,a,this._spatialReference)?bG(i,a[0],a[1]):(Eu.a.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}},{key:"getElevations",value:function(e,t,r){var n=this.rootTiles,i=n?n[0].layerInfo[gz.ELEVATION].length:0;if(!(0,Nu.t)(n)&&n.length&&0!==i)for(var a=0;a<t;++a){var o=3*a;r(a,bG(n,e[o+0],e[o+1]))}else for(var s=0;s<t;++s)r(s,null)}},{key:"getScale",value:function(e){if(this.tilingScheme){if(!(0,Hu.g)(e,pG,this.spatialReference))return Eu.a.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;var t=this.rootTiles;if((0,Nu.r)(t)){var r,n=(0,Cu.Z)(t);try{for(n.s();!(r=n.n()).done;){var i,a=r.value;if(null!==(i=a)&&void 0!==i&&i.containsPoint(pG)){for(;!a.isLeaf&&!a.rendered;){var o=0;pG[0]>a.children[0].extent[2]&&(o+=1),pG[1]<a.children[0].extent[1]&&(o+=2),a=a.children[o]}return this._getLodBiasCorrectedScale(a.level)}}}catch(s){n.e(s)}finally{n.f()}}}return 1e100}},{key:"getSphereElevationBounds",value:function(e,t,r,n,i){var a;if(pG[0]=e,pG[1]=t,pG[2]=r,pG[3]=n,!(0,Hu.j)(pG,i,pG,null===(a=this.tilingScheme)||void 0===a?void 0:a.spatialReference))return Eu.a.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;var o=1/0,s=-1/0,l=function e(t){if(t&&(0,ju.g)(t.extent,pG))if(t.isLeaf||t.rendered)o=Math.min(o,t.elevationBounds[0]),s=Math.max(s,t.elevationBounds[1]);else{var r,n=(0,Cu.Z)(t.children);try{for(n.s();!(r=n.n()).done;){e(r.value)}}catch(i){n.e(i)}finally{n.f()}}},u=this.rootTiles;if((0,Nu.r)(u)){var c,h=(0,Cu.Z)(u);try{for(h.s();!(c=h.n()).done;){l(c.value)}}catch(d){h.e(d)}finally{h.f()}}return{min:o,max:s}}},{key:"getSphereScale",value:function(e,t){var r=this;if(!this.tilingScheme)return null;if(!(0,Hu.g)(e,pG,this.spatialReference))return Eu.a.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;pG[3]=t;var n=null,i=function e(t){if(t&&(0,ju.g)(t.extent,pG))if(t.isLeaf||t.rendered){var i=r._getLodBiasCorrectedScale(t.level);n=null==n?i:Math.min(n,i)}else{var a,o=(0,Cu.Z)(t.children);try{for(o.s();!(a=o.n()).done;){e(a.value)}}catch(s){o.e(s)}finally{o.f()}}},a=this.rootTiles;if((0,Nu.r)(a)){var o,s=(0,Cu.Z)(a);try{for(s.s();!(o=s.n()).done;){i(o.value)}}catch(l){s.e(l)}finally{s.f()}}return n}},{key:"queryVisibleScaleRange",value:function(e,t,r,n){var i=t?this.tilingScheme.levelAtScale(t):0,a=r?this.tilingScheme.levelAtScale(r):1/0,o=this._lodBias;this._renderer.queryVisibleLevelRange(e,i+o,a+o,n)}},{key:"_evaluateTransparency",value:function(e){var t,r,n=this._renderer.transparency,i=this._allSurfaceLayersTransparent()?eG.Invisible:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?eG.Opaque:eG.Semitransparent,a=n!==i;return a&&(this._renderer.transparency=i,null!==(t=this.view)&&void 0!==t&&null!==(r=t._stage)&&void 0!==r&&r.renderView.setRenderParameters({terrainTransparency:this._renderer.transparency})),a}},{key:"_updateBaseOpacity",value:function(e){var t=this._evaluateTransparency(e);this._updateTileTextures(t?XS.UNFADED:XS.IMMEDIATE)}},{key:"_updateTilingScheme",value:function(){var e,t,r,n,i,a=this.tilingSchemeLogic.tilingScheme;a!==this.tilingScheme&&(qN(!!a,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!==(e=this.view)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.isLocal),this.tilingScheme&&this._removeAllTiles(),this._spatialReference=null!==(r=null===a||void 0===a?void 0:a.spatialReference)&&void 0!==r?r:Yu.k.WebMercator,this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference),this._updateRootTiles()),this._isWebMercator=!(null===(n=this.tilingScheme)||void 0===n||!n.spatialReference.isWebMercator),this._isWebMercatorOnPlateeCarree=this._isWebMercator&&(0,Yu.T)(null===(i=this.view)||void 0===i?void 0:i.renderSpatialReference))}},{key:"_acquireTile",value:function(e,t,r,n){var i=this._tilePool.acquire();return mG[0]=e,mG[1]=t,mG[2]=r,i.init(mG,n,this),i}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"_updateRootTiles",value:function(){var e=this,t=this.extent,r=this.tilingScheme;if(r){var n=vG,i=r.rootTilesInExtent(t,n,320);if((0,Nu.r)(this.rootTiles)){if(i.length>Nh)return void Eu.a.getLogger(this.declaredClass).warn("Cannot extend surface to encompass all layers because it would result in too many root tiles.");var a=this.rootTiles.map((function(e){return e.lij})),o=(0,Nu.M)(a,i,dG);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){var s=this.rootTiles.filter((function(t){return!(o.removed.findIndex((function(e){return dG(e,t.lij)}))>-1)||(e._purgeTile(t),!1)}));o.added.forEach((function(t){return s.push(e._newRootTile(t))})),this._setRootTiles(s)}}else this._updatingRootTiles=!0,i.length>Nh&&(Eu.a.getLogger(this.declaredClass).warn("Surface extent is too large for tile resolution at level 0."),i=r.rootTilesInExtent(t,n,Nh)),this._setRootTiles(i.map((function(t){return e._newRootTile(t)})));(0,ju.I)(n,this._rootTilesExtent)||(this._rootTilesExtent=(0,ju.u)(n)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}}},{key:"_updateAllTileGeometries",value:function(){var e=this,t=this._allTiles.filter((function(e){return e.isLoaded&&e.intersectsClippingArea}));t.forEach((function(t){return e._renderer.updateTileGeometryState(t)})),t.forEach((function(e){return e.renderData.updateNeighborData()})),this._updateTilesGeometries(t),this._pendingTilesToUpdate.clear()}},{key:"_updateTilesGeometries",value:function(e){var t=this;if(0!==e.length){e.sort($z);var r=this.renderer;e.forEach((function(e){return r.updateGeometryIfNeeded(e)})),e.forEach((function(e){return t._pendingTilesForElevationUpdateEvent.add(e)}))}}},{key:"_shouldSplit",value:function(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===FU.SPLIT}},{key:"_newRootTile",value:function(e){var t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(FU.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}},{key:"_setRootTiles",value:function(e){if(this._set("rootTiles",e),this._allTiles.clear(),(0,Nu.r)(e)){var t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)}},{key:"_runViewChangeUpdateIfDirty",value:function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}},{key:"_viewChangeUpdate",value:function(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this.rootTiles)))}},{key:"_updateClippingStatus",value:function(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(FU.GEOMETRY)&&this._updateTileGeometryState(e)}},{key:"_updateTilesVisibility",value:function(e){if(!(0,Nu.t)(e)){var t=function(e){for(var t=0;t<e.length;t++){var r=e[t],n=r.parent;if(n)for(var i=0;i<4;i++){var a=n.children[i];if(a&&a!==r)return!0}}return!1}(e),r=this.visibleElevationBounds,n=t?r.min:1/0,i=t?r.max:-1/0,a=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();var s=this._iteratorPool.acquire();for(s.reset(e);!s.done;){var l=s.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(FU.GEOMETRY)&&this._updateTileGeometryState(l),l.setPendingUpdate(FU.RENDERDATA),l.computeVisibility(),l.updateScreenDepth(o),l.renderData&&(n=Math.min(l.elevationBounds[0],n),i=Math.max(l.elevationBounds[1],i))}s.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(n)&&isFinite(i)&&(r.min!==n||r.max!==i)&&(this.visibleElevationBounds=new dz(n,i))}}},{key:"_updateRootTileElevationBounds",value:function(){var e=1/0,t=-1/0,r=this.rootTiles;(0,Nu.r)(r)&&r.forEach((function(r){var n=r.elevationBounds;e=Math.min(e,n[0]),t=Math.max(t,n[1])}));var n=this.rootTileElevationBounds;n.min===e&&n.max===t||(this.rootTileElevationBounds=new dz(e,t))}},{key:"_updateViewDependentParameters",value:function(){var e=this.view.state.camera,t=this.view.state.contentCamera,r=Math.tan(.5*t.fovX),n=Math.tan(.5*t.fovY),i=this.tilingScheme.pixelSize,a=Math.pow(2,-this._lodBias)*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=r,this._splitLimits.fovY=n,this._splitLimits.relativeWidthLimit=i/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=i/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?((0,Nu.t)(this._splitLimits.frustum)&&(this._splitLimits.frustum=(0,kc.H)()),(0,kc.u)(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,(0,kc.u)(this._frustum,e.frustum),(0,Wu.u)(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),(0,Vu.r)(this._eyePosRenderSR,t.eye),(0,Hu.j)(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}},{key:"_updateRenderData",value:function(e){e.rendered&&!e.shouldLoad&&(fG(e)?this._loadChildren(e):function(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}(e)&&this._loadParent(e))}},{key:"_updateTileGeometryState",value:function(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}},{key:"_markAllTileNeighborsForGeometryUpdate",value:function(e){var t=this._pendingTilesToUpdate;e.forEachLoadedNeighbor((function(e){t.add(e)}))}},{key:"_updateTileTexture",value:function(e,t){var r=e.resetPendingUpdate(FU.TEXTURE_FADING)?FU.TEXTURE_FADING:!!e.resetPendingUpdate(FU.TEXTURE_NOFADING)&&FU.TEXTURE_NOFADING;r&&(this._renderer.updateTileTexture(e,r),this._usedMemory=null,t.madeProgress())}},{key:"_emitElevationUpdateEventForTiles",value:function(){var e=gG.extent;(0,ju.D)(e),this._pendingTilesForElevationUpdateEvent.forEach((function(t){return(0,ju.h)(e,t.extent,e)})),this._pendingTilesForElevationUpdateEvent.clear(),gG.spatialReference=this.spatialReference,this.emit("elevation-change",gG)}},{key:"runTask",value:function(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);var t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done?this.requestUpdate():this.getUsedMemory(),this.notifyChange("updatingProgressValue")}},{key:"_updateAllTilesStatus",value:function(e){if(this._viewChanged&&this.rootTiles&&!e.done){this._viewChanged=!1;var t=this._iteratorPool.acquire();t.reset(this.rootTiles);for(var r=this.snapLevel,n=this._splitLimits,i=this._eyePosRenderSR;!t.done;){var a=t.next(),o=a.shouldSplit(n,i,r);if(o!==FU.SPLIT){if(a.resetPendingUpdate(FU.SPLIT)&&a.updateAgentSuspension(),o===FU.VSPLITMERGE&&a.updateAgents(gz.ELEVATION),t.skipSubtree(),!a.isLeaf){a.setPendingUpdate(FU.MERGE),a.resetPendingUpdate(FU.SPLIT);var s=this._iteratorPool.acquire();s.resetOne(a);for(var l=this._viewProjectionMatrix,u=s.next();!s.done;u=s.next())this._updateClippingStatus(u),u.updateVisibility(),u.updateScreenDepth(l);s.remove()}}else a.resetPendingUpdate(FU.MERGE),a.isLeaf&&(a.setPendingUpdate(FU.SPLIT),t.skipSubtree()),a.rendered&&a.setPendingUpdate(FU.RENDERDATA)}t.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}}},{key:"_sortTiles",value:function(e){e.done||this._allTilesSorted||(function(e,t){var r=new Map;e.forAll((function(e){return r.set(e.lij,e.distanceToSquared(t))})),e.sort((function(e,t){return r.get(e.lij)-r.get(t.lij)||$z(e,t)}))}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}},{key:"_markTileToUpdate",value:function(e){YN(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}},{key:"_batchUpdatePendingTileGeometries",value:function(){var e=this._pendingTilesToUpdate;if(0!==e.size){var t=Array.from(this._pendingTilesToUpdate.keys()).filter((function(e){return e.isLoaded&&e.intersectsClippingArea})),r=function(r,n){null===n||void 0===n||!n.isLoaded||!n.intersectsClippingArea||n.level<r.level||e.has(n)||(e.add(n),t.push(n),n.renderData.updateNeighborData())};t.sort($z);for(var n=t.length,i=function(n){var i=t[n];YN(i.isLoaded),YN(i.intersectsClippingArea);var a=i.renderData;a.updateNeighborData();for(var o=a._dirtyEdgeResolutions,s=a.geometryState.neighborData,l=0;l<4;++l)if(o&1<<l){var u=i.renderData.geometryState.neighborData.edgePeerNeighbors[l];u&&(null===u||void 0===u?void 0:u.level)>=i.level&&u.forAllSubtreeOnSide(gF(TF[l]),(function(t){return!(!t.isLoaded||!t.intersectsClippingArea)&&(YN(e.has(t)||$z(i,t)<0),r(i,t),!0)})),r(i,s.cornerPeerNeighbors[l]),r(i,s.cornerPeerNeighbors[(l+1)%4])}},a=0;a<n;++a)i(a);e.clear(),this._updateTilesGeometries(t),WN&&XN&&this.checkAllTilesWaterproofness()}}},{key:"_mergeAndSplit",value:function(e,t){var r=this;if(!this.suspended&&!e.done&&this._allTilesDirty){this._allTilesDirty=!1,this.requestUpdate();for(var n=!1,i=!1;!e.done;){i=!0;var a=!1,o=!this._allTiles.some((function(i){if(!n&&!i.loadable)return e.done;var o=i;if(i.resetPendingUpdate(FU.MERGE)){if(!t)return i.setPendingUpdate(FU.MERGE),e.done;for(;null!==(s=o.parent)&&void 0!==s&&s.resetPendingUpdate(FU.MERGE);){var s;o=o.parent}r._mergeTile(o),a=!0,e.madeProgress()}else i.resetPendingUpdate(FU.SPLIT)&&(r._splitTile(i),a=!0,e.madeProgress());return!e.done&&o===i&&i.resetPendingUpdate(FU.RENDERDATA)&&(r._updateRenderData(i),e.madeProgress()),e.done}));if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0),o){if(!n){n=!0;continue}if(!a)break}else this._allTilesDirty=!0}i||(this._allTilesDirty=!0),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}}},{key:"_updateElevation",value:function(e){var t=this;e.done||(this._allTiles.some((function(r){return r.resetPendingUpdate(FU.GEOMETRY)&&(t._updateTileGeometryState(r),t._updateTileTexture(r,e),t.shortBatches&&t._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done})),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}},{key:"_updateTextures",value:function(e){var t=this;e.done||this._allTiles.some((function(r){return t._updateTileTexture(r,e),e.done}))}},{key:"_updateClippingExtent",value:function(){this.spatialReference&&(this.updateTileOverlayParams(vc.N.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}},{key:"_lodBias",get:function(){var e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-2.5*(1-e)}},{key:"_getLodBiasCorrectedScale",value:function(e){var t=this.tilingScheme.levels,r=(0,Vu.a)(e-this._lodBias,0,t.length-1),n=r-Math.floor(r);return t[Math.floor(r)].scale*(1-n)+t[Math.ceil(r)].scale*n}},{key:"_removeAllTiles",value:function(){var e=this;(0,Nu.r)(this.rootTiles)&&(this.rootTiles.forEach((function(t){return e._purgeTile(t)})),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}},{key:"_purgeDescendantTiles",value:function(e){if(e.isLeaf)return!1;for(var t=!1,r=0;r<4;++r)t=this._purgeTile(e.children[r])||t;return e.unsetChildren(),t}},{key:"_purgeTile",value:function(e){var t=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),t}},{key:"_unloadTile",value:function(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}},{key:"_splitTile",value:function(e){qN(e.isLeaf,"tile that is already split should not be split again!");var t=e.level+1,r=2*e.lij[1],n=2*e.lij[2];e.setChildren(this._createTile(t,r,n,e),this._createTile(t,r,n+1,e),this._createTile(t,r+1,n,e),this._createTile(t,r+1,n+1,e)),e.setPendingUpdate(FU.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}},{key:"_emitTileScaleChange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;_G.spatialReference=this.spatialReference,_G.extent=e.extent,_G.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",_G)}},{key:"_createTile",value:function(e,t,r,n){qN(!!n,"_createTile sanity check");var i=this._acquireTile(e,t,r,n);return i.updateClippingStatus(this.extent),i.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(i)&&i.setPendingUpdate(FU.SPLIT),i}},{key:"shortBatches",get:function(){return this.view.state.mode!==bc.a.IDLE}},{key:"_mergeTile",value:function(e){qN(!e.hasPendingUpdate(FU.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(qN(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}},{key:"_loadChildren",value:function(e){var t=this;qN(e.rendered,"parent should be rendered"),this._unloadTile(e);var r=e.children;r.forEach((function(e){return t._loadTile(e)})),r.forEach((function(e){return t._pendingTilesToUpdate.add(e)})),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}},{key:"_loadParent",value:function(e){var t=e.parent;this._unloadChildren(t),this._loadTile(t),this._markTileToUpdate(t),this._emitTileScaleChange(t,t.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}},{key:"_unloadChildren",value:function(e){if(!e.isLeaf)for(var t=0;t<4;++t){var r=e.children[t];this._unloadChildren(r),this._unloadTile(r)}}},{key:"_loadTile",value:function(e){e.load(),e.setPendingUpdate(FU.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}},{key:"_elevationDataArrived",value:function(e,t,r){var n=new fz(e.lij,e.extent,r);e.dataArrived(t,gz.ELEVATION,n);var i=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){var s=o.next();s.findElevationBoundsForLayer(t,a),s.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(i)}},{key:"_handleLayerViewChanges",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bc.F;if(this._layerViewsDirty){this._layerViewsDirty=!1;var r,n=!1,i=new Set,a=-1,o=(0,Cu.Z)(this.view.allLayerViews.items);try{for(o.s();!(r=o.n()).done;){var s=r.value;if(i.add(s.uid),sF(s)||nF(s))if(this._basemapLayerViewHandles.has(s.uid)&&!nF(s)){var l=this._layerClassFromLayerView(s),u=this._getLayerIdxByUID(l,s.uid);(0,Nu.r)(u)&&((u<a||(0,Nu.t)(a))&&(n=!0),a=u)}else this._registerTiledLayerView(s),s.layer.loaded&&(n=!0)}}catch(c){o.e(c)}finally{o.f()}this._basemapLayerViewHandles.forEach((function(t,r){i.has(r)||(e._unregisterTiledLayerView(r),n=!0)})),n&&this._updateTiledLayers(),this._renderer.transparency=this._allSurfaceLayersTransparent()?eG.Invisible:this._renderer.transparency,this.hasCompositeBlendMode=this._hasCompositeBlendMode(),t.madeProgress()}}},{key:"_allSurfaceLayersTransparent",value:function(){var e,t,r,n=0===(null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t?void 0:t.opacity),i=(0,Cu.Z)(this.view.allLayerViews.items);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(oF(a)&&!(0,$u.i)(a.layer)&&0!==a.fullOpacity)return n=!1}}catch(o){i.e(o)}finally{i.f()}return n}},{key:"_hasCompositeBlendMode",value:function(){var e,t=(0,Cu.Z)(this.view.allLayerViews.items);try{for(t.s();!(e=t.n()).done;){var r=e.value;if((aF(r)||nF(r))&&CU(TU[r.layer.blendMode]))return!0}}catch(n){t.e(n)}finally{t.f()}return!1}},{key:"_layerClassFromLayerView",value:function(e){return rF(e)?gz.ELEVATION:gz.MAP}},{key:"_registerTiledLayerView",value:function(e){var t=this,r=[];if((aF(e)||nF(e))&&r.push((0,Fu.l)((function(){return e.layer.blendMode}),(function(){t.hasCompositeBlendMode=t._hasCompositeBlendMode(),t._updateTileTextures(XS.UNFADED)}))),!nF(e)){var n=this._layerClassFromLayerView(e);r.push((0,Fu.l)((function(){return e.suspended}),(function(){return t._updateTiledLayers()}))),r.push((0,Fu.l)((function(){return e.fullOpacity}),(function(){return t._updateTileTextures(XS.UNFADED)}))),r.push((0,Fu.l)((function(){return"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null}),(function(){return t._restartAllAgents(n)}))),e.on("data-changed",(function(){var r=t._getLayerIdxByUID(n,e.uid);(0,Nu.r)(r)&&t._invalidateLayerData(r,n)})),this._basemapLayerViewHandles.set(e.uid,r)}}},{key:"_unregisterTiledLayerView",value:function(e){var t=this._basemapLayerViewHandles.get(e);if(t){for(var r=0;r<t.length;r++)t[r].remove();this._basemapLayerViewHandles.delete(e)}}},{key:"_updateTiledLayers",value:function(){var e=this;if(this.tilingScheme&&!this.view.suspended){var t=this.view.allLayerViews,r=[[],[]],n=null;t.forEach((function(t){if(t.layer&&!t.suspended&&sF(t)&&t.fullExtent){var i=e._layerClassFromLayerView(t);if(i===gz.MAP){var a=t.displayLevelRange.maxLevel;a!==1/0&&(null===n||a>n)&&(n=a)}r[i].push(t)}}));var i,a=(0,Cu.Z)(xz);try{for(a.s();!(i=a.n()).done;){var o=i.value,s=this._layerViews[o],l=r[o];l.reverse();var u=l.length,c=s.length!==u,h=new Array(u),d=new Array(s.length);this._layerIndexByUid[o].clear();for(var f=0;f<u;f++){var p=l[f].uid;this._layerIndexByUid[o].set(p,f);var v=s.indexOf(l[f]);h[f]=v,f!==v&&(c=!0),v>-1&&(d[v]=f)}if(c){var m=this._postorderIterator;for(m.reset(this.rootTiles);!m.done;)m.next().modifyLayers(d,h,o);this._layerViews[o]=l,this._restartAllAgents(o),this._updateTilesVisibility(this.rootTiles)}}}catch(y){a.e(y)}finally{a.f()}this.tilingScheme.ensureMaxLod(n)&&this._viewChangeUpdate()}}},{key:"_restartAllAgents",value:function(e){var t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){var r=t.next();r.restartAgents(e),e===gz.ELEVATION&&r.computeElevationBounds()}this._updateRootTileElevationBounds()}},{key:"layerViewByIndex",value:function(e,t){return this._layerViews[t][e]}},{key:"numLayers",value:function(e){return this._layerViews[e].length}},{key:"_updateTileTextures",value:function(e){var t=this;this._allTiles.forAll((function(r){r.updateAgents(gz.MAP),e===XS.IMMEDIATE?t.renderer.updateTileTexture(r,FU.TEXTURE_NOFADING):r.updateRenderData(gz.MAP,e)})),this._renderer.transparency=this._allSurfaceLayersTransparent()?eG.Invisible:this._renderer.transparency}},{key:"_invalidateLayerData",value:function(e,t){this._allTiles.forAll((function(r){return r.removeLayerAgent(e,t)})),this._allTiles.forAll((function(r){return r.invalidateLayerData(e,t)}))}},{key:"setTileTreeDirty",value:function(){this._allTilesDirty=!0}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vc.N.UPDATE;this.renderer.setNeedsRender(e)}},{key:"requestUpdate",value:function(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}},{key:"requestTileData",value:function(e,t,r,n){var i=this,a=this.layerViewByIndex(t,r),o=a.layer;return!o.tilemapCache||eF(a)?this._requestTileData(e,r,a,n):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],(0,Tu.Z)((0,Tu.Z)({},n),{},{timeout:6e3})).then((function(){return--i._asyncWorkItems})).catch((function(t){throw--i._asyncWorkItems,(0,Eu.f)(n),(0,Eu.j)(t)||i._dataMissing(e,r,a,{notInTilemap:!0}),t})).then((function(){return i._frameTask.schedule((function(){return i._requestTileData(e,r,a,n)}),n.signal)})))}},{key:"_requestTileData",value:function(e,t,r,n){return t===gz.ELEVATION?rF(r)?this._requestElevationTileData(e,r,n):Promise.reject():oF(r)?this._requestMapTileData(e,r,n):Promise.reject()}},{key:"_requestElevationTileData",value:function(e,t,r){var n=this;++this._asyncWorkItems;var i=function(i){if(!(0,Eu.p)(r)){var a=n._layerIndexByUid[gz.ELEVATION].get(t.uid);null!=a?(n._usedMemory=null,n.requestUpdate(),n._elevationDataArrived(e,a,i)):Eu.a.getLogger(n.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",gz.ELEVATION,e.lij.toString())}},a=function(r){(0,Eu.j)(r)||(n._dataMissing(e,gz.ELEVATION,t,r),n.requestUpdate())};if(uF(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:zh,signal:r.signal}).then((function(e){if(!(0,Eu.p)(r))return n._frameTask.schedule((function(){return i(e)}),r.signal,a);Eu.a.getLogger(n.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),a).finally((function(){--n._asyncWorkItems}));var o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(o,"binary",r).then((function(e){return n._lercDecoder.decode(e,{noDataValue:zh},r.signal)})).then((function(e){e?i({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue}):a(new Error("LERC decoding failed"))}),a).finally((function(){--n._asyncWorkItems}))}},{key:"_requestMapTileData",value:function(e,t,r){var n=this;++this._asyncWorkItems;var i=function(i,a){--n._asyncWorkItems,lF(a),(0,Eu.p)(r)||(n._dataMissing(e,gz.MAP,t,i),n.requestUpdate())},a=function(e){return function(t){return i(t,e)}},o=function(i){return n._frameTask.schedule((function(){--n._asyncWorkItems,n.requestUpdate(),(0,Eu.p)(r)?lF(i):n._mapTileDataArrived(e,t,i)}),r.signal,a(i)).catch(a(i))},s=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n._frameTask.schedule((function(){return i(e,t)}))};if(eF(t)){var l=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(l[0],l[1],l[2],r).then(o,s)}if(JN(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],r).then(o,s);if($N(t)&&uF(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],r).then((function(e){if((0,Eu.p)(r))return Eu.a.getLogger(n.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s((0,Eu.d)());o(e)}),s);var u=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(0,fh.n)(t.layer)&&t.layer.refreshTimestamp&&(u+="".concat(u.includes("?")?"&":"?","_ts=").concat(t.layer.refreshTimestamp));var c=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(u,c,r).then(o,s)}},{key:"_mapTileDataArrived",value:function(e,t,r){var n=this._getLayerIdxByUID(gz.MAP,t.uid);(0,Nu.r)(n)?e.dataArrived(n,gz.MAP,r):(lF(r),Eu.a.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}},{key:"_getLayerIdxByUID",value:function(e,t){return this._layerIndexByUid[e].get(t)}},{key:"_dataMissing",value:function(e,t,r,n){var i=this._getLayerIdxByUID(t,r.uid);(0,Nu.r)(i)?e.dataMissing(i,t,n):Eu.a.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}},{key:"updateTileOverlayParams",value:function(e){var t=this;this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((function(e){e.renderData&&t.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}},{key:"performanceInfo",get:function(){var e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((function(t){t.isLeaf&&e.numLeaves++;var r=t.level;t.renderData&&(e.numLoadedPerLevel[r]=(e.numLoadedPerLevel[r]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[r]=(e.numRenderedPerLevel[r]||0)+1,e.numRendered++))})),e}},{key:"getUsedMemory",value:function(){return this.tilingScheme?((0,Nu.t)(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),(0,Nu.r)(this._usedMemory)?this._usedMemory:0):0}},{key:"_recalculateUsedMemory",value:function(){return this.tilingScheme?this._allTiles.reduce((function(e,t){return e+t.usedMemory}),0):null}},{key:"getUsedMemoryForLayerView",value:function(e){var t=0,r=this._layerClassFromLayerView(e),n=this._getLayerIdxByUID(r,e.uid);return(0,Nu.r)(n)&&this._allTiles.forAll((function(e){return t+=e.getUsedMemoryForLayer(r,n)})),t}},{key:"getTile",value:function(e){if((0,Nu.t)(e)||(0,Nu.t)(this.rootTiles))return null;var t=e.split("/").map((function(e){return+e}));if(0===t[0])return this.rootTiles.find((function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]}));var r,n=Math.pow(2,t[0]),i=Math.floor(t[1]/n),a=Math.floor(t[2]/n);if(this.rootTiles.some((function(e){return e.lij[1]===i&&e.lij[2]===a&&(r=e,!0)})),r){for(var o=1<<t[0]-1;r.lij[0]<t[0];){var s=t[1]&o?2:0;if((t[2]&o)>0&&s++,!r.children[s])return null;r=r.children[s],o>>=1}return qN(r.lij[0]===t[0]&&r.lij[1]===t[1]&&r.lij[2]===t[2],"not the right tile?"),r}return null}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(e){this._renderer.renderPatchBorders=e}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(e){this._renderer.visualizeNormals=e}},{key:"renderingDisabled",get:function(){return this._renderer.renderingDisabled},set:function(e){this._renderer.renderingDisabled=e}},{key:"test",get:function(){var e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:function(){(0,Nu.r)(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:function(){return e._allTiles.toArray()},getRenderedTiles:function(){yG.clear(),e._allTiles.forAll((function(e){e.visible&&e.rendered&&yG.push(e)}));var t=yG.toArray();return eU(e.renderOrder,t),t},lockTilingScheme:function(t,r){e._extentHelper.defaultTiledLayersExtent=r,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}},{key:"checkAllTilesWaterproofness",value:function(){if(XN){var e=this.rootTiles;if(!(0,Nu.t)(e)){var t,r=function(e){var t,r,n;return(null===e||void 0===e||null===(t=e.renderData)||void 0===t||null===(r=t.geometryInfo)||void 0===r||null===(n=r.indices)||void 0===n?void 0:n.length)>0},n=function(e,t){r(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",t.lij,"] has geom")},i=function e(t){var i,a,o;if(t.intersectsClippingArea)if(t.renderData&&!t.renderData.geometryState&&console.error("Tile[",t.lij,"] has renderData but not geometryState"),t.renderData&&!t.renderData.geometryInfo&&console.error("Tile[",t.lij,"] has renderData but not geometryInfo"),!(null!==(i=t.renderData)&&void 0!==i&&i.geometryInfo)||(null!==(a=null===(o=t.renderData.geometryInfo.indices)||void 0===o?void 0:o.length)&&void 0!==a?a:0)>0||console.error("Tile[",t.lij,"] has renderData but no indices - geometryInfo: ",t.renderData.geometryInfo),r(t)){t.checkGeometryWaterproofness();var s,l=(0,Cu.Z)(t.children);try{for(l.s();!(s=l.n()).done;){var u=s.value;n(u,t)}}catch(d){l.e(d)}finally{l.f()}}else if(t.isLeaf)console.error("Tile[",t.lij,"] has no geometry and no children, from root to leaf");else{var c,h=(0,Cu.Z)(t.children);try{for(h.s();!(c=h.n()).done;){e(c.value)}}catch(d){h.e(d)}finally{h.f()}}},a=function e(t){var r,n,i=null===(r=null===(n=t.parent)||void 0===n?void 0:n.visible)||void 0===r||r,a=t.visible;t.computeVisibility();var o=t.visible;if(a!==o&&i&&console.error(" Tile[",t.lij,"] has out of date visibility: ",a," instead of ",o),!t.isLeaf){var s,l=(0,Cu.Z)(t.children);try{for(l.s();!(s=l.n()).done;){e(s.value)}}catch(u){l.e(u)}finally{l.f()}}},o=(0,Cu.Z)(e);try{for(o.s();!(t=o.n()).done;){var s=t.value;i(s),a(s)}}catch(l){o.e(l)}finally{o.f()}}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"shading",get:function(){return this._shading}},{key:"_updateShadingIfChanged",value:function(){var e,t,r;(null===(e=this.view)||void 0===e||null===(t=e.map)||void 0===t||null===(r=t.ground)||void 0===r?void 0:r.shading)!==this._shading&&this._updateShading()}},{key:"_updateShading",value:function(){var e,t,r,n=null===(e=this.view)||void 0===e||null===(t=e.map)||void 0===t||null===(r=t.ground)||void 0===r?void 0:r.shading;this._shading=n,this.renderer&&(this.renderer.shading=n,this.renderer.setNeedsRender()),this._updateAllTileGeometries()}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateeCarree",get:function(){return this._isWebMercatorOnPlateeCarree}},{key:"isEastEndWrap",value:function(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}},{key:"isWestEndWrap",value:function(e){return this.isGlobal&&0===e[2]}},{key:"lijEastEnd",value:function(e){return Math.pow(2,e+((0,Nu.r)(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}},{key:"wrapEastWest",value:function(e){var t=this.lijEastEnd(e[0]),r=e[2];if(0<=r&&r<t)return e;if(!this.isGlobal)return null;var n=(r+(r<0?t:0))%t;return[e[0],e[1],n]}},{key:"enableInternalChecks",value:function(e){!function(e){WN=e}(e)}},{key:"enableWaterproofnessChecks",value:function(e){!function(e){XN=e,WN=WN||e}(e)}}]),n}(ec.n.EventedMixin(Eu.m));(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_renderer",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_hasPendingUpdates",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_asyncWorkItems",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_allTilesDirty",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_allTilesSorted",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_viewChanged",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"_watchUpdatingTracking",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_frameTask",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"snapLevel",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"lodSnapping",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],cG.prototype,"view",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_userClippingExtent",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_rootTilesExtent",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"extent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"groundExtent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"_tilingSchemeExtent",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"running",null),(0,Eu.e)([(0,Eu.y)(hz)],cG.prototype,"updatingProgress",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"updatingProgressValue",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_maxNumUpdating",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"baseOpacity",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"hasCompositeBlendMode",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"overlayManager",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"viewingMode",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"maxTextureScale",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"ready",null),(0,Eu.e)([(0,Eu.y)({value:uB.FRONT_TO_BACK})],cG.prototype,"renderOrder",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"rootTiles",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"spatialReference",null),(0,Eu.e)([(0,Eu.y)({type:sc.l})],cG.prototype,"backgroundColor",null),(0,Eu.e)([(0,Eu.y)({value:!1})],cG.prototype,"slicePlaneEnabled",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"tilingScheme",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"tilingSchemeLocked",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],cG.prototype,"tilingSchemeLogic",void 0),(0,Eu.e)([(0,Eu.y)({value:!0})],cG.prototype,"velvetOverground",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"wireframe",null),(0,Eu.e)([(0,Eu.y)({value:!1})],cG.prototype,"suspended",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"textureFadeDuration",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"visibleElevationBounds",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"rootTileElevationBounds",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"_layerViewsDirty",void 0),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"renderPatchBorders",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"visualizeNormals",null),(0,Eu.e)([(0,Eu.y)()],cG.prototype,"renderingDisabled",null);var hG=cG=(0,Eu.e)([(0,Eu.n)("esri.views.3d.terrain.TerrainSurface")],cG);function dG(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function fG(e){return!e.isLeaf&&(e.children.some((function(e){return e.shouldLoad}))||e.children.some((function(e){return fG(e)})))}var pG=(0,lc.n)(),vG=(0,ju.u)(),mG=[0,0,0],yG=new Eu.a6,gG={spatialReference:null,extent:(0,ju.u)(),context:"ground"},_G={spatialReference:null,extent:null,scale:0};function bG(e,t,r){var n,i=(0,Cu.Z)(e);try{for(i.s();!(n=i.n()).done;){var a,o,s,l=n.value;if(l.containsPointXY(t,r)){for(var u=l;u&&!u.renderData;){var c=(t>u.extentMidX?1:0)+(r<u.extentMidY?2:0);u=u.children[c]}return vz(t,r,null!==(a=null===(o=u)||void 0===o||null===(s=o.renderData)||void 0===s?void 0:s.geometryState.samplerData)&&void 0!==a?a:null)}}}catch(h){i.e(h)}finally{i.f()}return null}var xG=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.geometryRecord=t,this.renderGeometry=r})),wG=(0,ku.Z)((function e(t,r,n){(0,Au.Z)(this,e),this.operation=t,this.geometryRecord=r,this.states=n})),TG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._residentGeomRecords=new Map,n._dirtyGeomRecords=new Map,n.dirty=!1,n}return(0,ku.Z)(r,[{key:"commit",value:function(e){var t=this;this.dirty=!1,this._dirtyGeomRecords.forEach((function(r,n){return t.commitLayer(n,e)}))}},{key:"commitLayer",value:function(e,t){var r=this,n=this._dirtyGeomRecords.get(e);n&&(n.forEach((function(n,i){var a=r._ensureGeomRecord(e,i);n.forEach((function(e,n){var o=e.geometryRecord,s=e.operation,l=e.states,u=!1;if(s===aR.UPDATE){var c=a.get(n);if(c){var h=c.renderGeometry;if(l&oR.TRANSFORMATION){var d=r.model.getObject(i);r.model.updateRenderGeometryTransformation(d,o,h)&&(u=!0)}u||t.updates.push({renderGeometry:h,updateType:l})}else(0,Sc.e)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(s===aR.REMOVE||u){var f=a.get(n);f?(t.removes.push(f.renderGeometry),a.delete(n),f.geometryRecord.disposed&&$C.pool.release(f.geometryRecord)):s===aR.REMOVE&&(0,Sc.e)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(s===aR.ADD||u){var p=r.model.getObject(i);if((0,Nu.r)(p)){var v=r.model.getRenderGeometry(p,o),m=new xG(o,v);t.adds.push(v),a.set(n,m)}}})),0===a.size&&r._residentGeomRecords.get(e).delete(i)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}},{key:"getResidentRenderGeometries",value:function(e,t){var r=this._residentGeomRecords.get(e);r&&r.forEach((function(e){return e.forEach((function(e){return t.push(e.renderGeometry)}))}))}},{key:"_objectStateChanged",value:function(e,t){var r,n=(0,Cu.Z)(t.geometryRecords);try{for(n.s();!(r=n.n()).done;){var i=r.value;this._updateOrCreateDirtyRecord(t,i,null,aR.UPDATE,e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"visibilityChanged",value:function(e){this._objectStateChanged(oR.VISIBILITIES,e)}},{key:"highlightChanged",value:function(e){this._objectStateChanged(oR.HIGHLIGHTS,e)}},{key:"occlusionChanged",value:function(e){this._objectStateChanged(oR.OCCLUDEES,e)}},{key:"vertexAttrsUpdated",value:function(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,aR.UPDATE,oR.VERTEXATTRS)}},{key:"layerAdded",value:function(e){var t=this;e.objects.forAll((function(r){return t._layerObjectAdded(e,r)}))}},{key:"layerRemoved",value:function(e){var t=this;e.objects.forAll((function(r){return t._layerObjectRemoved(e,r)}))}},{key:"layerObjectAdded",value:function(e){this._layerObjectAdded(e.layer,e.object)}},{key:"_layerObjectAdded",value:function(e,t){var r,n=e.id,i=(0,Cu.Z)(t.geometryRecords);try{for(i.s();!(r=i.n()).done;){var a=r.value;this._objectGeometryAdded(t,a,n)}}catch(o){i.e(o)}finally{i.f()}}},{key:"layerObjectRemoved",value:function(e){this._layerObjectRemoved(e.layer,e.object)}},{key:"layerObjectsAdded",value:function(e){var t,r=(0,Cu.Z)(e.objects);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._layerObjectAdded(e.layer,n)}}catch(i){r.e(i)}finally{r.f()}}},{key:"layerObjectsRemoved",value:function(e){var t,r=(0,Cu.Z)(e.objects);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._layerObjectRemoved(e.layer,n)}}catch(i){r.e(i)}finally{r.f()}}},{key:"_layerObjectRemoved",value:function(e,t){var r,n=e.id,i=(0,Cu.Z)(t.geometryRecords);try{for(i.s();!(r=i.n()).done;){var a=r.value;this._objectGeometryRemoved(t,a,n)}}catch(o){i.e(o)}finally{i.f()}}},{key:"shaderTransformationChanged",value:function(e){var t=this,r=this._residentGeomRecords.get(e.id);r&&r.forEach((function(e,r){var n=t.model.getObject(r);n&&n.hasVolativeTransformation()&&e.forEach((function(e){e.renderGeometry.shaderTransformationChanged()}))}))}},{key:"objectTransformation",value:function(e){var t=this,r=this._getParentLayerId(e),n=e.id;this._ensureGeomRecord(r,n).forEach((function(n){t._updateOrCreateDirtyRecord(e,n.geometryRecord,r,aR.UPDATE,oR.TRANSFORMATION)}))}},{key:"objectGeometryAdded",value:function(e){this._objectGeometryAdded(e.object,e.record)}},{key:"_objectGeometryAdded",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,r,aR.ADD)}},{key:"objectGeometryRemoved",value:function(e){this._objectGeometryRemoved(e.object,e.record)}},{key:"_objectGeometryRemoved",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,r,aR.REMOVE)}},{key:"_updateOrCreateDirtyRecord",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:oR.NONE;r=(0,Nu.v)(r,this._getParentLayerId(e));var a=e.id,o=t.id,s=this._ensureDirtyRecord(r,a),l=s.get(o);if(l){var u=l.operation;u===aR.REMOVE&&n===aR.ADD&&l.states!==oR.NONE?l.operation=aR.UPDATE:u===aR.REMOVE&&n===aR.ADD||u===aR.ADD&&n===aR.REMOVE?(s.delete(o),l.geometryRecord.disposed&&$C.pool.release(l.geometryRecord)):u!==aR.UPDATE||n!==aR.REMOVE&&n!==aR.UPDATE?((0,Sc.e)((u===aR.REMOVE||u===aR.ADD)&&n===aR.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),l.states|=i):(l.operation=n,l.states|=i)}else s.set(o,new wG(n,t,i));this.dirty=this._hasDirtyGeometryRecords}},{key:"_ensureGeomRecord",value:function(e,t){var r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));var n=r.get(t);return n||(n=new Map,r.set(t,n)),n}},{key:"_hasDirtyGeometryRecords",get:function(){return(0,Eu.a9)(this._dirtyGeomRecords,(function(e){return(0,Eu.a9)(e,(function(e){return e&&e.size>0}))}))}},{key:"_ensureDirtyRecord",value:function(e,t){var r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));var n=r.get(t);return n||(n=new Map,r.set(t,n)),n}},{key:"_getParentLayerId",value:function(e){return(0,Nu.r)(e.parentLayer)?e.parentLayer.id:Eu.au}},{key:"formatDebugInfo",value:function(){var e=["ADD","UPD",void 0,"REM"],t="";return this._dirtyGeomRecords.forEach((function(r,n){r.forEach((function(r,i){t.length>0&&(t+="\n"),t+=n+"."+i;var a=[];r.forEach((function(e){var t=e.operation;a[t]||(a[t]=[]),a[t].push(e.geometryRecord.geometry.id)}));for(var o=0;o<a.length;o++)if(a[o]){t+=" "+e[o-1]+": ";for(var s=0;s<a[o].length;s++)t+=a[o][s]+", "}}))})),t}},{key:"test",get:function(){var e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((function(e,t){return e+t.size}),0)}}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],TG.prototype,"model",void 0),(0,Eu.e)([(0,Eu.y)()],TG.prototype,"dirty",void 0);var CG=TG=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],TG),SG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).dirtySet=new CG({model:(0,gu.Z)(e)}),e._content=new Map,e._originFactory=new _P(null),e}return(0,ku.Z)(r,[{key:"getObject",value:function(e){return this._content.get(e)}},{key:"add",value:function(e){var t=e.id;(0,Sc.e)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),bO(e)&&this.dirtySet.layerAdded(e)}},{key:"remove",value:function(e){(0,Sc.e)(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),bO(e)&&this.dirtySet.layerRemoved(e)}},{key:"addMany",value:function(e){var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;(0,Nu.r)(n)&&((0,Sc.e)(!this._content.has(n.id),"Model/Stage already contains object to be added"),this._content.set(n.id,n))}}catch(i){r.e(i)}finally{r.f()}}},{key:"removeMany",value:function(e){var t,r=(0,Cu.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;(0,Sc.e)(this._content.has(n.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(n.id),n.unload()}}catch(i){r.e(i)}finally{r.f()}}},{key:"has",value:function(e){return this._content.has(e.id)}},{key:"forEachOfType",value:function(e,t){this._content.forEach((function(r){r.type===e&&t(r)}))}},{key:"getRenderGeometry",value:function(e,t){var r=t.geometry,n=t.material,i=t.id,a=t.shaderTransformation,o=t.origin,s=t.instanceParameters,l=new Zk(r,n,{id:i,boundingInfo:r.boundingInfo,calculateShaderTransformation:a,castShadow:e.castShadow});return l.updateTransformation((function(r){return e.getCombinedStaticTransformation(t,r)})),l.origin=(0,Nu.r)(o)?o:this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=s,l}},{key:"updateRenderGeometryTransformation",value:function(e,t,r){if((0,Nu.t)(e))return!1;r.updateTransformation((function(r){return e.getCombinedStaticTransformation(t,r)}));var n=this._originFactory.getOrigin(r.boundingSphere);return r.origin!==n}},{key:"getStats",value:function(){for(var e={},t=Array.from(this._content.values()),r=function(r){e[r]=t.filter((function(e){return e.type===r})).length},n=0;n<dc.ap.COUNT;++n)r(n);return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}},{key:"test",get:function(){return{content:Array.from(this._content.values())}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],SG.prototype,"dirtySet",void 0),SG=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.parts.Model")],SG);var OG=function(){function e(t){(0,Au.Z)(this,e),this._totalCount=t,this._indexRanges=[0,t]}return(0,ku.Z)(e,[{key:"allVisible",value:function(){return this.componentCount()===this._totalCount}},{key:"allInvisible",value:function(){return 0===this._indexRanges.length}},{key:"componentCount",value:function(){for(var e=this._indexRanges,t=0,r=0;r<e.length;r+=2)t+=e[r+1];return t}},{key:"reset",value:function(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){var t=new Array;if(0===e.length)return t;for(var r=e[0],n=1,i=1;i<e.length;i++){var a=e[i];r+n===a?n+=1:(t.push(r),t.push(n),r=a,n=1)}return t.push(r),t.push(n),t}(e)}},{key:"forEachComponent",value:function(e){for(var t=this._indexRanges,r=0;r<t.length;r+=2)for(var n=t[r],i=n+t[r+1],a=n;a<i;a++)if(!e(a))return!1;return!0}},{key:"forEachComponentRange",value:function(e){for(var t=this._indexRanges,r=0;r<t.length;r+=2){var n=t[r];if(!e(n,n+t[r+1]))return!1}return!0}},{key:"computeOffsetRanges",value:function(e){for(var t=new Array(this._indexRanges.length),r=this._indexRanges,n=0;n<r.length;n+=2){var i=r[n],a=i+r[n+1],o=e[i],s=e[a];t[n]=o,t[n+1]=s-o}return t}}]),e}();var PG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;(0,Au.Z)(this,r),(i=t.call(this)).pickability=null,i.highlightCounts=null,i.verticalOffsets=null,i.cachedGeometryRanges=null,i.cachedHighlightRanges=null,i.cachedDefaultRanges=null,i.offsets=(0,Nu.K)(n);var a=i.count;i.visibility=new OG(a),i.materialDataBuffer=e.getBuffer(a),i.materialDataIndices=new Uint16Array(a);for(var o=0;o<a;o++)i.materialDataIndices[o]=i.materialDataBuffer.acquireIndex();return i}return(0,ku.Z)(r,[{key:"dispose",value:function(){(0,_u.Z)((0,bu.Z)(r.prototype),"dispose",this).call(this);for(var e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}},{key:"count",get:function(){return this.offsets.length-1}},{key:"geometryRanges",get:function(){return(0,Nu.t)(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}},{key:"highlightRanges",get:function(){return(0,Nu.t)(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}},{key:"defaultShadowMapRanges",get:function(){return(0,Nu.t)(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}},{key:"highlightsDirty",value:function(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}},{key:"visibilityDirty",value:function(){this.cachedGeometryRanges=null,this.highlightsDirty()}},{key:"_updateCachedHighlightRanges",value:function(){if(((0,Nu.t)(this.cachedHighlightRanges)||(0,Nu.t)(this.cachedDefaultRanges))&&(0,Nu.r)(this.highlightCounts)){var e=function(e,t,r){var n=[],i=[],a=r.length,o=r.length;return t.forEachComponent((function(t){return e[t]>0?(a!==t-1&&(n.length&&n.push(r[a+1]-n[n.length-1]),n.push(r[t])),a=t):(o!==t-1&&(i.length&&i.push(r[o+1]-i[i.length-1]),i.push(r[t])),o=t),!0})),n.length&&n.push(r[a+1]-n[n.length-1]),i.length&&i.push(r[o+1]-i[i.length-1]),{highlightRanges:n,defaultRanges:i}}(this.highlightCounts,this.visibility,this.offsets),t=e.highlightRanges,r=e.defaultRanges;this.cachedHighlightRanges=t,this.cachedDefaultRanges=r}}}]),r}(hO);var RG,AG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).visible=RG.Hidden,e}return(0,ku.Z)(r)}(hO);function kG(e,t,r,n){if(r>=t)return e;null==e&&(e=function(){return{isVisibleBit:!(!(arguments.length>0&&void 0!==arguments[0])||arguments[0]),data:new Uint32Array(0)}}());var i=e.isVisibleBit,a=e.data,o=DG(a),s=r/o|0,l=r-o*s,u=(t-1)/o|0,c=a,h=n===i;if(!(r<c.length*o)&&h){var d=s+1,f=Math.ceil(1.5*c.length),p=u+1,v=Math.max(d,f);v=Math.min(v,p),(a=new Uint32Array(v)).set(c)}return s<a.length&&(a[s]=function(e,t,r){return e&~(1<<t)|(r?1:0)<<t}(a[s],l,h)),e.data=a,e}function EG(e,t){if(null==e)return!0;var r=e.isVisibleBit,n=e.data,i=DG(n);return t<n.length*i?function(e,t,r,n){var i=r/n|0,a=r-i*n;return function(e,t){return 0!=(e&1<<t)}(t[i],a)===e}(r,n,t,i):!e.isVisibleBit}function DG(e){return 8*e.BYTES_PER_ELEMENT}(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AG.prototype,"renderable",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AG.prototype,"components",void 0),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(RG||(RG={}));var MG=function(){function e(t,r){(0,Au.Z)(this,e),this._indices=(0,Nu.r)(t.indices)?t.indices:(0,Cc.u)(t.positions.length/3),this._positions=new Zc.i(t.positions),this._components=r,this._componentIntersectionData=new Array(r.count)}return(0,ku.Z)(e,[{key:"getComponentAabb",value:function(e,t){if((0,Nu.r)(this._perComponentAabbs)){for(var r=0;r<6;r++)t[r]=this._perComponentAabbs[6*e+r];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}},{key:"getComponentPositions",value:function(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}},{key:"intersect",value:function(e,t,r,n,i,a,o){var s=this,l={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},u=this._indices,c=this._components.offsets,h=(0,dc.bn)(e,t,IG),d=e[2],f=t[2];this._components.visibility.forEachComponent((function(p){if(!EG(s._components.pickability,p))return!0;var v=s.getComponentAabb(p,LG);if((0,Nu.r)(a)){var m=a[p];(0,Nu.r)(i)?i.componentOffset=m:(e[2]=d-m,t[2]=f-m)}if((0,Nu.r)(i)&&i.applyToAabb(v),!(0,dc.b8)(v,e,h,r))return!0;var y=c[p]/3,g=c[p+1]/3,_=function(e,t,r){o(p,e,(0,Vu.S)(t,t,n),r)},b=g-y;return(0,Nu.t)(i)&&b>200?(null==s._componentIntersectionData[p]&&(s._componentIntersectionData[p]=new XB(s._indices,y,g,l)),s._componentIntersectionData[p].intersectRay({r0:e,r1:t},_)):(0,dc.a$)(e,t,y,g,u,l,void 0,i,_),!0}))}},{key:"_computePerComponentAabbs",value:function(){var e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(var t=this._indices,r=this._positions.typedBuffer,n=this._positions.typedBufferStride,i=this._components.offsets,a=0,o=0;o<e;o++){for(var s=i[o],l=i[o+1],u=1/0,c=1/0,h=1/0,d=-1/0,f=-1/0,p=-1/0,v=s;v<l;v++){var m=t[v]*n,y=r[m],g=r[m+1],_=r[m+2];u=Math.min(u,y),c=Math.min(c,g),h=Math.min(h,_),d=Math.max(d,y),f=Math.max(f,g),p=Math.max(p,_)}this._perComponentAabbs[a++]=u,this._perComponentAabbs[a++]=c,this._perComponentAabbs[a++]=h,this._perComponentAabbs[a++]=d,this._perComponentAabbs[a++]=f,this._perComponentAabbs[a++]=p}}},{key:"positions",get:function(){return this._positions}},{key:"indices",get:function(){return this._indices}}]),e}(),IG=(0,Vu.n)(),LG=(0,Gc.a)(),ZG=function(){function e(t,r,n){(0,Au.Z)(this,e),this.material=t,this.geometry=r,this.meta=n}return(0,ku.Z)(e,[{key:"dispose",value:function(){this.material.dispose(),this.geometry.dispose()}}]),e}(),NG=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this)).primitiveType=n,o.parameters=i,o.indexed=a,o.vao=e,o}return(0,ku.Z)(r)}(hO);function FG(e){return e?zG(e,1/0,-1/0):function(e,t){return{near:e,far:t}}(1/0,-1/0)}function zG(e,t,r){return e.near=t,e.far=r,e}function UG(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return r.near=Math.min(e.near,t.near),r.far=Math.max(e.far,t.far),r}function VG(e,t){return e.near<=t&&t<=e.far}(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],NG.prototype,"vao",void 0);var BG={near:0,far:0};function GG(e,t){var r=FG(),n=e.eye,i=e.frustum,a=e.viewForward;t.forAll((function(e){var t=(0,Nu.r)(e.offsetObb)?e.offsetObb:e.obb,o=(0,Vu.P)((0,Vu.a0)(nH,t.center,n),a),s=(0,qc.U)(t,a);if(!VG(r,o-s)||!VG(r,o+s)){var l=function(e,t){for(var r=0,n=0;n<eH;n++){var i=(0,qc.J)(e,t[n]);if(i>0)return-1;0===i&&(r|=1<<n)}return r}(t,i);if(-1!==l){if(0===l)return jG.far=o+s,jG.near=o-s,void UG(r,jG);var u=HG.pushNew();u.near=o-s,u.far=o+s,u.mask=l,u.object=e}}}));for(var o=function(e){var t=HG.data[e];if(VG(r,t.near)&&VG(r,t.far))return"continue";jG.far=t.far,jG.near=1/0;var o=function(e,t,r,n){(0,Dc.S)(rH,e.quaternion),(0,Vu.a0)(nH,t,e.center),(0,Vu.E)(nH,nH,rH);var i=8*((nH[0]<-e.halfSize[0]?-1:nH[0]>e.halfSize[0]?1:0)+3*(nH[1]<-e.halfSize[1]?-1:nH[1]>e.halfSize[1]?1:0)+9*(nH[2]<-e.halfSize[2]?-1:nH[2]>e.halfSize[2]?1:0)+13),a=$G[i];if(0===a)return a;(0,mc.p)(tH,e.quaternion),(0,mc.f)(tH,tH,e.halfSize);var o=function(t,r){var n=$G[i+r+1];return(0,Vu.o)(t,((1&n)<<1)-1,(2&n)-1,((4&n)>>1)-1),(0,Vu.S)(t,t,tH),(0,Vu.u)(t,e.center,t)};return r.length=0,JG(r,o(iH,0)),JG(r,o(aH,1)),JG(r,o(nH,2)),JG(r,o(oH,3)),n(r),1===a||(r.length=0,JG(r,iH),JG(r,oH),JG(r,o(nH,4)),JG(r,o(sH,5)),n(r),2===a||(r.length=0,JG(r,iH),JG(r,sH),JG(r,o(nH,6)),JG(r,aH),n(r))),a}((0,Nu.r)(t.object.offsetObb)?t.object.offsetObb:t.object.obb,n,XG,(function(e){for(var r=YG,o=0;o<eH&&e.length>0;o++)if(0!=(t.mask&1<<o)){QG(i[o],e,r);var s=e;e=r,r=s}for(var l=0;l<e.length;l+=3){(0,Vu.o)(qG,e.data[l+0],e.data[l+1],e.data[l+2]);var u=(0,Vu.P)((0,Vu.a0)(qG,qG,n),a);jG.near=Math.min(jG.near,u)}}));0===o&&(jG.near=0),UG(r,jG)},s=0;s<HG.length;s++)o(s);return HG.length=0,r}var HG=new Eu.a6({allocator:function(e){return e||{near:1/0,far:-1/0,mask:0,object:null}},deallocator:function(e){return e.object=(0,Nu.d)(),e}}),jG=FG(),qG=(0,Vu.n)(),WG=(0,Vu.n)(),XG=new Eu.a6({deallocator:null}),YG=new Eu.a6({deallocator:null});function QG(e,t,r){r.length=0;var n=t.length-3;KG(qG,t,n);var i=(0,Tc.R)(e,qG);i<=0&&(r.push(qG[0]),r.push(qG[1]),r.push(qG[2]));for(var a=0,o=i;a<n;a+=3){KG(WG,t,a);var s=(0,Tc.R)(e,WG);o*s<0&&((0,Vu.A)(qG,WG,qG,s/(s-o)),JG(r,qG)),s<=0&&JG(r,WG),o=s,(0,Vu.r)(qG,WG)}o*i<0&&(KG(WG,t,n),(0,Vu.A)(qG,WG,qG,i/(i-o)),JG(r,qG))}function KG(e,t,r){return(0,Vu.o)(e,t.data[r+0],t.data[r+1],t.data[r+2])}function JG(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}var $G=function(){var e=new Int8Array(216),t=0,r=function(r){for(var n=0;n<r.length;n++)e[t+n]=r[n];t+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),e}(),eH=4;var tH=(0,gc.e)(),rH=(0,Mc.e)(),nH=(0,Vu.n)(),iH=(0,Vu.n)(),aH=(0,Vu.n)(),oH=(0,Vu.n)(),sH=(0,Vu.n)(),lH=function(){function e(t){(0,Au.Z)(this,e),this._objects=t}return(0,ku.Z)(e,[{key:"submit",value:function(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((function(r){return r.renderable.material.submit(e,t,r)}))}},{key:"queryShadowCasterDepthRange",value:function(e){return this._objects.visibleObjects.length?GG(e,this._objects.visibleObjects):null}}]),e}();function uH(e){var t=(0,wc.T)().vec3f(fc.O.POSITION);return e.normals&&t.vec2i16(fc.O.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===dc.d.Default?t.vec2f(fc.O.UV0):e.textureCoordinates===dc.d.Atlas&&(t.vec2f(fc.O.UV0),t.vec4u16(fc.O.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(fc.O.COLOR,{glNormalized:!0}),t.alignTo(4)}var cH,hH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){return(0,Au.Z)(this,r),t.call(this,e,"int",dc.s.Draw,(function(t,r,i){return t.setUniform1i(e,n(r,i))}))}return(0,ku.Z)(r)}(dc.r);!function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"}(cH||(cH={}));var dH,fH,pH,vH=429496.7296;function mH(e,t){(0,Nc.o)(e/vH*.5+.5,t)}function yH(e,t){switch(t.componentData){case cH.Varying:return function(e,t){var r=e.vertex,n=e.fragment;r.include(dc.y),r.uniforms.add((0,dc.bo)("componentColorTex",(function(e){return e.componentParameters.texture.texture}),t.hasWebGL2Context?dc.$.None:dc.$.Size)),e.attributes.add(fc.O.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");var i=t.output===dc.O.ObjectAndLayerIdColor;i&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(dc.bp),r.constants.add("elevationScale","float",2*vH),r.constants.add("stride","float",(0,Nu.h)("enable-feature:objectAndLayerId-rendering")?3:2),r.code.add((0,dc.n)(Vo||(Vo=(0,wu.Z)(["\n  vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {\n    vec2 textureSize = ",";\n\n    float index = componentIndex * stride + typeOffset;\n    float coordX = mod(index, textureSize.x);\n    float coordY = floor(index / textureSize.x);\n\n    return vec2(coordX, coordY) + 0.5;\n  }\n  "])),(0,dc.as)(t,"componentColorTex"))),r.code.add((0,dc.n)(Bo||(Bo=(0,wu.Z)(["\n  vec4 _readComponentColor() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);\n\n    return ",";\n   }\n\n   float readElevationOffset() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);\n\n    vec4 encodedElevation = ",";\n    return (rgba2float(encodedElevation) - 0.5) * elevationScale;\n  }\n\n  ","\n\n  vec4 forwardExternalColor(out bool castShadows) {\n    vec4 componentColor = _readComponentColor() * 255.0;\n\n    float shadowFlag = mod(componentColor.b * 255.0, 2.0);\n    componentColor.b -= shadowFlag;\n    castShadows = shadowFlag >= 1.0;\n\n    int decodedColorMixMode;\n    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;\n    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts\n\n    return vExternalColor;\n  }\n"])),(0,dc._)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize"),(0,dc._)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize"),i?(0,dc.n)(Go||(Go=(0,wu.Z)(["\n          void forwardObjectAndLayerIdColor() {\n            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);\n\n            vObjectAndLayerIdColor = ",";\n          }"])),(0,dc._)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")):(0,dc.n)(Ho||(Ho=(0,wu.Z)(["void forwardObjectAndLayerIdColor() {}"]))))),n.code.add((0,dc.n)(jo||(jo=(0,wu.Z)(["\n  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {\n    externalColor = vExternalColor;\n    externalColorMixMode = int(vExternalColorMixMode);\n  }\n\n  void outputObjectAndLayerIdColor() {\n     ","\n  }\n"])),i?(0,dc.n)(qo||(qo=(0,wu.Z)(["gl_FragColor = vObjectAndLayerIdColor;"]))):""))}(e,t);case cH.Uniform:return function(e){var t=e.vertex,r=e.fragment;t.uniforms.add(new hV("externalColor",(function(e){return e.componentParameters.externalColor}))),r.uniforms.add(new hH("externalColorMixMode",(function(e){return e.componentParameters.externalColorMixMode}))),e.varyings.add("vExternalColor","vec4"),t.code.add((0,dc.n)(Wo||(Wo=(0,wu.Z)(["float readElevationOffset() {\nreturn 0.0;\n}\nvoid forwardObjectAndLayerIdColor() {\n}\nvec4 forwardExternalColor(out bool castShadows) {\nvExternalColor = externalColor;\ncastShadows = true;\nreturn externalColor;\n}"])))),r.code.add((0,dc.n)(Xo||(Xo=(0,wu.Z)(["void readExternalColor(out vec4 color, out int colorMixMode) {\ncolor = vExternalColor;\ncolorMixMode = externalColorMixMode;\n}\nvoid outputObjectAndLayerIdColor() {\ngl_FragColor = vec4(1.0,0.0,0.0,0.0);\n}"]))))}(e);case cH.COUNT:return}}function gH(e,t){var r=e.vertex;switch(r.code.add((0,dc.n)(Yo||(Yo=(0,wu.Z)(["#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)"])))),t.vertexDiscardMode){case dH.None:r.code.add((0,dc.n)(Qo||(Qo=(0,wu.Z)(["#define vertexDiscardByOpacity(_opacity_) {}"]))));break;case dH.Opaque:r.code.add((0,dc.n)(Ko||(Ko=(0,wu.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case dH.Transparent:r.code.add((0,dc.n)(Jo||(Jo=(0,wu.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))))}}function _H(e){return e&&(0,Yu.P)(e)?fH.Mars:e&&(0,Yu.c)(e)?fH.Moon:fH.Earth}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(dH||(dH={})),function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(fH||(fH={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(pH||(pH={}));var bH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).output=dc.O.Color,e.textureCoordinateType=dc.d.None,e.componentData=cH.Uniform,e.cullFace=vc.n.Back,e.vertexDiscardMode=dH.None,e.doubleSidedMode=dc.b7.WindingOrder,e.alphaDiscardMode=vc.C.Opaque,e.integratedMeshMode=pH.None,e.transparencyPassType=vc.o.NONE,e.ellipsoidMode=fH.Earth,e.pbrMode=dc.B.Disabled,e.normalType=dc.bm.Attribute,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasVertexColors=!1,e.hasNormals=!1,e.hasSlicePlane=!1,e.hasBaseColorTexture=!1,e.receiveAmbientOcclusion=!0,e.receiveShadows=!0,e.blendingEnabled=!0,e.hasScreenSpaceReflections=!1,e.hasPolygonOffset=!1,e.hasMetallicRoughnessTexture=!1,e.hasEmissionTexture=!1,e.hasOcclusionTexture=!1,e.hasNormalTexture=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.useLegacyTerrainShading=!1,e.hasCloudsReflections=!0,e.snowCover=!1,e.objectAndLayerIdColor=!1,e.hasWebGL2Context=!1,e}return(0,ku.Z)(r)}(dc.q);function xH(e,t){e.include(dc.aU,t),e.fragment.include(dc.bq);var r=e.fragment;r.uniforms.add(new hV("baseColor",(function(e){return e.baseColor}))),r.uniforms.add(new dc.br("objectOpacity",(function(e){return e.objectOpacity}))),t.hasVertexColors?r.code.add((0,dc.n)($o||($o=(0,wu.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb * vColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a * vColor.a;\n}"])))):r.code.add((0,dc.n)(es||(es=(0,wu.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a;\n}"])))),r.code.add((0,dc.n)(ts||(ts=(0,wu.Z)(["vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {\nvec3 baseColor = _baseColor();\nfloat baseOpacity = _baseOpacity();\nvec3 color = mixExternalColor(\nbaseColor,\ntextureColor.rgb,\nexternalColor.rgb,\nexternalColorMixMode\n);\nfloat opacity = objectOpacity * mixExternalOpacity(\nbaseOpacity,\ntextureColor.a,\nexternalColor.a,\nexternalColorMixMode\n);\nreturn vec4(color, opacity);\n}"]))))}function wH(e,t){var r=e.fragment;switch(t.doubleSidedMode){case dc.b7.None:r.code.add((0,dc.n)(rs||(rs=(0,wu.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn normal;\n}"]))));break;case dc.b7.View:e.include(dc.bs,t),r.code.add((0,dc.n)(ns||(ns=(0,wu.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;\n}"]))));break;case dc.b7.WindingOrder:r.code.add((0,dc.n)(is||(is=(0,wu.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));default:case dc.b7.COUNT:}switch(t.normalType){case dc.bm.Attribute:case dc.bm.CompressedAttribute:e.include(dc.bt,t),r.code.add((0,dc.n)(as||(as=(0,wu.Z)(["vec3 shadingNormalWorld() {\nreturn _adjustDoublesided(normalize(vNormalWorld));\n}\nvec3 shadingNormal_view() {\nvec3 normal = normalize(vNormalView);\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;case dc.bm.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(dc.bs,t),r.code.add((0,dc.n)(os||(os=(0,wu.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(cross(\ndFdx(vPositionWorldCameraRelative),\ndFdy(vPositionWorldCameraRelative)\n));\n}\nvec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));\n}"]))));break;case dc.bm.Ground:t.spherical?(e.include(dc.bs,t),r.code.add((0,dc.n)(ss||(ss=(0,wu.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(positionWorld());\n}"]))))):r.code.add((0,dc.n)(ls||(ls=(0,wu.Z)(["vec3 shadingNormalWorld() {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),e.extensions.add("GL_OES_standard_derivatives"),r.code.add((0,dc.n)(us||(us=(0,wu.Z)(["vec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;\n}"]))));default:case dc.bm.COUNT:}}function TH(e,t){var r=e.fragment;if(!t.hasBaseColorTexture||t.output!==dc.O.Color&&t.alphaDiscardMode===vc.C.Opaque)r.code.add((0,dc.n)(ds||(ds=(0,wu.Z)(["vec4 readBaseColorTexture() { return vec4(1.0); }"]))));else{e.include(dc.bu,t);var n=t.textureCoordinateType===dc.d.Atlas;r.uniforms.add((0,dc.bo)("baseColorTexture",(function(e){return e.texture}),n?t.hasWebGL2Context?dc.$.None:dc.$.Size:dc.$.None)),n?(e.include(dc.bv),r.code.add((0,dc.n)(cs||(cs=(0,wu.Z)(["\n        vec4 readBaseColorTexture() {\n          vec2 textureSize = ",";\n          return textureAtlasLookup(baseColorTexture, textureSize, vuv0, vuvRegion);\n        }\n      "])),(0,dc.as)(t,"baseColorTexture")))):r.code.add((0,dc.n)(hs||(hs=(0,wu.Z)(["vec4 readBaseColorTexture() {\nreturn texture2D(baseColorTexture, vuv0);\n}"]))))}}function CH(e){var t=new dc.o;t.include(dc.bs,e),t.include(dc.bt,e),t.include(dc.aU,e),t.include(dc.a,e),t.include(dc.aJ,e),t.include(yH,e),t.include(dc.bw,e),t.include(dc.bx,e),t.include(TH,e),t.include(gH,e);var r=t.vertex,n=t.fragment;e.pbrMode!==dc.B.Normal&&e.pbrMode!==dc.B.Schematic||(t.include(dc.by,e),e.hasNormalTexture&&t.include(dc.bz,e));var i=e.output===dc.O.Shadow||e.output===dc.O.ShadowHighlight||e.output===dc.O.ShadowExludeHighlight;i&&e.componentData===cH.Varying?r.code.add((0,dc.n)(fs||(fs=(0,wu.Z)(["#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"])))):r.code.add((0,dc.n)(ps||(ps=(0,wu.Z)(["#define discardShadows(castShadows) {}"]))));var a=e.integratedMeshMode===pH.ColorOverlay||e.integratedMeshMode===pH.ColorOverlayWithWater,o=a&&e.output===dc.O.Color&&e.pbrMode===dc.B.WaterOnIntegratedMesh;return a&&(t.include(dc.b2,e),t.include(dV,e),e.spherical?r.code.add((0,dc.n)(vs||(vs=(0,wu.Z)(["\n      const float invEllipsoidRadius = ",";\n      vec2 projectOverlay(vec3 pos) {\n        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);\n      }\n      "])),dc.n.float(1/(e.ellipsoidMode===fH.Earth?Yu.s.radius:e.ellipsoidMode===fH.Mars?Yu.t.radius:Yu.e.radius)))):r.code.add((0,dc.n)(ms||(ms=(0,wu.Z)(["vec2 projectOverlay(vec3 pos) { return pos.xy; }"]))))),o&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),r.code.add((0,dc.n)(ys||(ys=(0,wu.Z)(["\n    void main() {\n      bool castShadows;\n      vec4 externalColor = forwardExternalColor(castShadows);\n      discardShadows(castShadows);\n\n      vertexDiscardByOpacity(externalColor.a);\n\n      if (externalColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      forwardPosition(readElevationOffset());\n      forwardNormal();\n      forwardTextureCoordinates();\n      forwardVertexColor();\n      forwardLinearDepth();\n      ","\n      ","\n      ","\n    }\n  "])),dc.n.float(dc.a7),e.output===dc.O.ObjectAndLayerIdColor?(0,dc.n)(gs||(gs=(0,wu.Z)(["forwardObjectAndLayerIdColor();"]))):"",o?e.spherical?(0,dc.n)(_s||(_s=(0,wu.Z)(["\n                groundNormal = normalize(positionWorld());\n                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));\n                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));"]))):(0,dc.n)(bs||(bs=(0,wu.Z)(["\n                groundNormal = vec3(0.0, 0.0, 1.0);\n                tbnTangent = vec3(1.0, 0.0, 0.0);\n                tbnBiTangent = vec3(0.0, 1.0, 0.0);"]))):"",a?(0,dc.n)(xs||(xs=(0,wu.Z)(["setOverlayVTC(projectOverlay(position));"]))):"")),e.output===dc.O.Alpha&&(n.include(dc.j),t.include(dc.aw,e),t.include(xH,e),a&&n.uniforms.add(new dc.h("ovColorTex",(function(e,t){return pV(e,t)}))),n.code.add((0,dc.n)(ws||(ws=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n\n        gl_FragColor = vec4(materialColor.a);\n      }\n    "])),e.hasMultipassTerrain?(0,dc.n)(Ts||(Ts=(0,wu.Z)(["terrainDepthTest(gl_FragCoord, vPosition_view.z);"]))):"",a?(0,dc.n)(Cs||(Cs=(0,wu.Z)(["\n                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);\n                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))),e.output===dc.O.Color&&(n.include(dc.j),t.include(dc.aw,e),t.include(xH,e),t.include(wH,e),t.include(dc.b2,e),e.receiveShadows?(t.include(dc.bA,e),n.code.add((0,dc.n)(Ss||(Ss=(0,wu.Z)(["float evaluateShadow() {\nreturn readShadowMap(vPositionWorldCameraRelative, linearDepth);\n}"]))))):n.code.add((0,dc.n)(Os||(Os=(0,wu.Z)(["float evaluateShadow() { return 0.0; }"])))),a&&n.uniforms.add(new dc.h("ovColorTex",(function(e,t){return pV(e,t)}))),n.code.add((0,dc.n)(Ps||(Ps=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n    "])),e.hasMultipassTerrain?(0,dc.n)(Rs||(Rs=(0,wu.Z)(["terrainDepthTest(gl_FragCoord, vPosition_view.z);"]))):"",a?(0,dc.n)(As||(As=(0,wu.Z)(["vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);"]))):"")),e.pbrMode===dc.B.Normal||e.pbrMode===dc.B.Schematic?((0,dc.w)(n),n.code.add((0,dc.n)(ks||(ks=(0,wu.Z)(["\n        ","\n        vec3 normalVertex = shadingNormalWorld();\n        float additionalIrradiance = 0.02 * mainLightIntensity[2];\n      "])),e.pbrMode===dc.B.Normal?(0,dc.n)(Es||(Es=(0,wu.Z)(["\n                applyPBRFactors();\n                if (int(externalColorMixMode) == 3) {\n                  mrr = vec3(0.0, 0.6, 0.2);\n                }"]))):"")),e.hasNormalTexture?n.code.add((0,dc.n)(Ds||(Ds=(0,wu.Z)(["mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);\nvec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])))):n.code.add((0,dc.n)(Ms||(Ms=(0,wu.Z)(["vec3 shadingNormal = normalVertex;"])))),n.code.add((0,dc.n)(Is||(Is=(0,wu.Z)(["","\n      "])),e.spherical?(0,dc.n)(Ls||(Ls=(0,wu.Z)(["vec3 normalGround = normalize(positionWorld());"]))):(0,dc.n)(Zs||(Zs=(0,wu.Z)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))))),n.code.add((0,dc.n)(Ns||(Ns=(0,wu.Z)(["\n        vec3 viewDir = normalize(vPositionWorldCameraRelative);\n        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());\n\n        ","\n\n        ","\n\n        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());\n        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);\n        "])),e.snowCover?(0,dc.n)(Fs||(Fs=(0,wu.Z)(["\n                vec3 surfaceNormal = normalize(shadingNormalWorld());\n                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\n                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);\n\n                shadingNormal = mix(shadingNormal, surfaceNormal, snow);\n                ssao = mix(ssao, 0.0, snow);\n                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);\n                emission = mix(emission, vec3(0.0), snow);"]))):"",a?(0,dc.n)(zs||(zs=(0,wu.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))):(e.receiveShadows?n.code.add((0,dc.n)(Us||(Us=(0,wu.Z)(["float shadow = evaluateShadow();"])))):e.spherical?((0,dc.b6)(n),n.code.add((0,dc.n)(Vs||(Vs=(0,wu.Z)(["float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());\nfloat shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);"]))))):n.code.add((0,dc.n)(Bs||(Bs=(0,wu.Z)(["float shadow = 0.0;"])))),o&&n.uniforms.add(new dc.h("ovNormalTex",(function(e,t){return SH(t)}))),e.snowCover&&(t.extensions.add("GL_OES_standard_derivatives"),n.code.add((0,dc.n)(Gs||(Gs=(0,wu.Z)(["vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));\nfloat snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\nmaterialColor.rgb = mix(materialColor.rgb, vec3(1), snow);"]))))),n.code.add((0,dc.n)(Hs||(Hs=(0,wu.Z)(["\n        float ambientOcclusion = evaluateAmbientOcclusion();\n        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());\n\n        ","\n\n        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);\n      ","\n      "])),a?(0,dc.n)(js||(js=(0,wu.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",o?(0,dc.n)(qs||(qs=(0,wu.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):""))),n.code.add((0,dc.n)(Ws||(Ws=(0,wu.Z)(["\n        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);\n        ","\n      }\n    "])),e.transparencyPassType===vc.o.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),(e.output===dc.O.Depth||i)&&(t.include(dc.at,e),n.code.add((0,dc.n)(Xs||(Xs=(0,wu.Z)(["void main() {\ndiscardBySlice(vPositionWorldCameraRelative);\nvec4 textureColor = readBaseColorTexture();\ndiscardOrAdjustAlpha(textureColor);\noutputDepth(linearDepth);\n}"]))))),e.output===dc.O.Normal&&(t.include(wH,e),n.code.add((0,dc.n)(Ys||(Ys=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        // note: the alpha component needs to be 1.0 in order for this material\n        // to influence ambient occlusion, see the ssao fragment shader\n        float alpha = ",";\n        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);\n      }\n    "])),e.normalType===dc.bm.Ground?"0.0":"1.0"))),e.output===dc.O.ObjectAndLayerIdColor&&t.fragment.code.add((0,dc.n)(Qs||(Qs=(0,wu.Z)(["void main() {\ndiscardBySlice(vPositionWorldCameraRelative);\nvec4 textureColor = readBaseColorTexture();\ndiscardOrAdjustAlpha(textureColor);\noutputObjectAndLayerIdColor();\n}"])))),e.output===dc.O.Highlight&&(t.include(dc.a9,e),n.code.add((0,dc.n)(Ks||(Ks=(0,wu.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n\n        outputHighlight();\n      }\n    "])),a?(0,dc.n)(Js||(Js=(0,wu.Z)(["\n                vec4 overlayColor = getCombinedOverlayColor();\n                if (overlayColor.a == 0.0) {\n                  gl_FragColor = vec4(0.0);\n                  return;\n                }"]))):""))),t}function SH(e){return 0===e.overlays.length?null:e.overlays[GS.INNER].getValidTexture(WS.Water)}(0,Eu.e)([(0,dc.p)({count:dc.O.COUNT})],bH.prototype,"output",void 0),(0,Eu.e)([(0,dc.p)({count:dc.d.COUNT})],bH.prototype,"textureCoordinateType",void 0),(0,Eu.e)([(0,dc.p)({count:cH.COUNT})],bH.prototype,"componentData",void 0),(0,Eu.e)([(0,dc.p)({count:vc.n.COUNT})],bH.prototype,"cullFace",void 0),(0,Eu.e)([(0,dc.p)({count:dH.COUNT})],bH.prototype,"vertexDiscardMode",void 0),(0,Eu.e)([(0,dc.p)({count:dc.b7.COUNT})],bH.prototype,"doubleSidedMode",void 0),(0,Eu.e)([(0,dc.p)({count:vc.C.COUNT})],bH.prototype,"alphaDiscardMode",void 0),(0,Eu.e)([(0,dc.p)({count:pH.COUNT})],bH.prototype,"integratedMeshMode",void 0),(0,Eu.e)([(0,dc.p)({count:vc.o.COUNT})],bH.prototype,"transparencyPassType",void 0),(0,Eu.e)([(0,dc.p)({count:fH.COUNT})],bH.prototype,"ellipsoidMode",void 0),(0,Eu.e)([(0,dc.p)({count:dc.B.COUNT})],bH.prototype,"pbrMode",void 0),(0,Eu.e)([(0,dc.p)({count:dc.bm.COUNT})],bH.prototype,"normalType",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"spherical",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasVertexColors",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasNormals",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasBaseColorTexture",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"receiveAmbientOcclusion",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"receiveShadows",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"blendingEnabled",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasScreenSpaceReflections",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasPolygonOffset",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasMetallicRoughnessTexture",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasEmissionTexture",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasOcclusionTexture",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasNormalTexture",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasOccludees",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"useLegacyTerrainShading",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasCloudsReflections",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"snowCover",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"objectAndLayerIdColor",void 0),(0,Eu.e)([(0,dc.p)()],bH.prototype,"hasWebGL2Context",void 0),(0,Eu.e)([(0,dc.p)({constValue:dc.s.Draw})],bH.prototype,"pbrTextureBindType",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],bH.prototype,"hasSliceHighlight",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"hasSliceInVertexProgram",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"useCustomDTRExponentForWater",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"hasVertexTangents",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],bH.prototype,"supportsTextureAtlas",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"highStepCount",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"instancedDoublePrecision",void 0),(0,Eu.e)([(0,dc.p)({constValue:!0})],bH.prototype,"useFillLights",void 0),(0,Eu.e)([(0,dc.p)({constValue:!1})],bH.prototype,"objectAndLayerIdColorInstanced",void 0);var OH=Object.freeze(Object.defineProperty({__proto__:null,build:CH,getOverlayNormalTexture:SH},Symbol.toStringTag,{value:"Module"})),PH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2,t.spherical=e.viewingMode===ic.l.Global,t.doublePrecisionRequiresObfuscation=(0,dc.aL)(e.rctx)}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),RH)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,r=t.integratedMeshMode!==pH.None,n=e===vc.o.NONE,i=e===vc.o.FrontFace;return(0,vc.W)({blending:t.output!==dc.O.Color&&t.output!==dc.O.Alpha||!t.blendingEnabled?null:n?vc.d:(0,vc.A)(e),culling:(0,vc.k)(t.cullFace),depthTest:{func:(0,vc.e)(e)},depthWrite:n||i?vc.b:null,colorWrite:vc._,stencilWrite:r||t.hasOccludees?dc.ax:null,stencilTest:r?(0,dc.bB)(vc.t.IntegratedMeshMaskExcluded):t.hasOccludees?dc.az:null,polygonOffset:n||i?t.hasPolygonOffset?{factor:2,units:2}:null:vc.f})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}}]),r}(dc.k);PH.shader=new dc.m(OH,(function(){return r.e(1643).then(r.bind(r,31643))}));var RH=new Map([[fc.O.POSITION,0],[fc.O.NORMAL,1],[fc.O.NORMALCOMPRESSED,1],[fc.O.COLOR,2],[fc.O.UV0,3],[fc.O.UVREGION,4],[fc.O.COMPONENTINDEX,5]]),AH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._dirty=!0,e}return(0,ku.Z)(r,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){if(this._dirty=!1,null!=this._parameterBlocks){var e,t=(0,Cu.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){this[e.value]._setClean()}}catch(r){t.e(r)}finally{t.f()}}}},{key:"dirty",get:function(){return this._dirty||this._checkParameterBlocksDirty()}},{key:"_checkParameterBlocksDirty",value:function(){if(null==this._parameterBlocks)return!1;var e,t=(0,Cu.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){if(this[e.value].dirty)return!0}}catch(r){t.e(r)}finally{t.f()}return!1}}]),r}(dc.t),kH=function(){function e(){(0,Au.Z)(this,e),this._dirty=!0}return(0,ku.Z)(e,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){this._dirty=!1}},{key:"dirty",get:function(){return this._dirty}}]),e}();function EH(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,r){var n,i=null!==(n=t._parameterCount)&&void 0!==n?n:0;if(t._parameterCount=i+1,e.vectorOps){var a=e.vectorOps;Object.defineProperty(t,r,{get:function(){return this[i]},set:function(e){var t=this[i];if(null==t)this[i]=e;else{if(a.equals(t,e))return;a.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,r,{get:function(){return this[i]},set:function(t){this[i]!==t&&(e.dispose&&this[i]&&this[i].dispose(),this[i]=t,this._setDirty())}})}}function DH(){return function(e,t){var r,n=null!==(r=e._parameterCount)&&void 0!==r?r:0;e._parameterCount=n+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(n),Object.defineProperty(e,t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this._setDirty())}})}}var MH,IH,LH=function(){function e(t){(0,Au.Z)(this,e),this._low=(0,yc.n)(),this._high=(0,yc.n)(),t&&this.set(t)}return(0,ku.Z)(e,[{key:"low",get:function(){return this._low}},{key:"high",get:function(){return this._high}},{key:"set",value:function(e){var t=this._low,r=this._high;(0,Vu.r)(t,e),(0,Vu.a0)(r,e,t)}},{key:"setElements",value:function(e,t,r){(0,Vu.o)(ZH,e,t,r),this.set(ZH)}},{key:"get",value:function(e){return(0,Vu.u)(e,this._low,this._high)}},{key:"getLowScaled",value:function(e){return(0,Vu.g)(e,this._low,1)}}]),e}(),ZH=(0,Vu.n)(),NH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;(0,Au.Z)(this,r),(i=t.call(this)).toMapSpace=n,i.baseColor=(0,uh.r)(1,1,1,1),i.usePBR=!1,i.hasParametersFromSource=!1,i.mrrFactors=(0,yc.r)(1,1,.5),i.emissiveFactor=(0,yc.r)(0,0,0),i.baseColorTexture=null,i.metallicRoughnessTexture=null,i.emissionTexture=null,i.occlusionTexture=null,i.normalTexture=null,i.objectOpacity=1,i.commonMaterialParameters=new FH,i.componentParameters=new zH,i.textureAlphaCutoff=dc.a8,i.alphaDiscardMode=vc.C.Opaque,i.isIntegratedMesh=!1,i.polygonOffsetEnabled=!1,i.ellipsoidMode=fH.Earth,i.hasOccludees=!1,i._techniqueConfiguration=new bH;var a=new LH(e.position),o=(0,mh.r)(e.rotationScale);return(0,mc.u)(o,o),i.transformNormalGlobalFromModel=(0,mc.o)(o,o),i.transformWorldFromModelTL=a.low,i.transformWorldFromModelTH=a.high,i.transformWorldFromModelRS=e.rotationScale,i}return(0,ku.Z)(r,[{key:"dispose",value:function(){this._technique=(0,Nu.F)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}},{key:"texture",get:function(){return(0,Nu.r)(this.baseColorTexture)?this.baseColorTexture.glTexture:null}},{key:"textureMetallicRoughness",get:function(){return(0,Nu.r)(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}},{key:"textureEmissive",get:function(){return(0,Nu.r)(this.emissionTexture)?this.emissionTexture.glTexture:null}},{key:"textureOcclusion",get:function(){return(0,Nu.r)(this.occlusionTexture)?this.occlusionTexture.glTexture:null}},{key:"textureNormal",get:function(){return(0,Nu.r)(this.normalTexture)?this.normalTexture.glTexture:null}},{key:"prepareTechnique",value:function(e,t,r,n){var i=this._techniqueConfiguration;i.hasVertexColors=n.colors,i.hasNormals=n.normals,i.textureCoordinateType=n.textureCoordinates,i.hasMetallicRoughnessTexture=(0,Nu.r)(this.metallicRoughnessTexture),i.hasEmissionTexture=(0,Nu.r)(this.emissionTexture),i.hasOcclusionTexture=(0,Nu.r)(this.occlusionTexture),i.hasNormalTexture=(0,Nu.r)(this.normalTexture),i.transparencyPassType=t.identifier===iV.Material&&null!=r.transparencyPassType?r.transparencyPassType:vc.o.NONE,i.hasMultipassTerrain=t.identifier===iV.Material&&null!=r.multipassTerrain&&r.multipassTerrain.enabled,i.cullAboveGround=t.identifier===iV.Material&&null!=r.multipassTerrain&&r.multipassTerrain.cullAboveGround,i.ellipsoidMode=this.ellipsoidMode,i.componentData=this.componentParameters.type,i.cullFace=this.commonMaterialParameters.cullFace,i.doubleSidedMode=this.commonMaterialParameters.doubleSided?dc.b7.View:dc.b7.None,i.hasBaseColorTexture=(0,Nu.r)(this.baseColorTexture);var a=this._computeWhichMaterialPass();i.blendingEnabled=a===MH.Transparent||a===MH.OpaqueAndTransparent,i.alphaDiscardMode=this.alphaDiscardMode,i.integratedMeshMode=this.isIntegratedMesh?function(e){return 0!==e.overlays.length&&(0,Nu.r)(e.overlays[GS.INNER].getColorTextureNoRasterImage())}(r)?SH(r)?pH.ColorOverlayWithWater:pH.ColorOverlay:pH.NoOverlay:pH.None,i.useLegacyTerrainShading=this.isIntegratedMesh&&Ac.t.TERRAIN_USE_LEGACY_SHADING,i.hasPolygonOffset=this.polygonOffsetEnabled;var o=this.hasParametersFromSource&&(0,Nu.t)(this.baseColorTexture);return i.pbrMode=i.integratedMeshMode===pH.ColorOverlayWithWater?dc.B.WaterOnIntegratedMesh:this.usePBR?o?dc.B.Schematic:dc.B.Normal:dc.B.Disabled,i.normalType=i.integratedMeshMode===pH.None?i.hasNormals?dc.bm.CompressedAttribute:dc.bm.ScreenDerivative:dc.bm.Ground,i.hasSlicePlane=(0,Nu.r)(r.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===iV.ShadowMap?(i.output=dc.O.Shadow,i.vertexDiscardMode=dH.None):t.identifier===iV.Highlight?(i.output=dc.O.Highlight,i.vertexDiscardMode=dH.None):(this._computeWhichMaterialPass()===MH.OpaqueAndTransparent?i.vertexDiscardMode=t.transparent?dH.Opaque:dH.Transparent:i.vertexDiscardMode=dH.None,i.output=function(e){switch(e){case aV.Color:return dc.O.Color;case aV.Alpha:return dc.O.Alpha;case aV.Depth:return dc.O.Depth;case aV.Normal:return dc.O.Normal;case aV.ObjectAndLayerIdColor:return dc.O.ObjectAndLayerIdColor}}(t.subPass),t.subPass===aV.Alpha&&(i.hasOccludees=r.hasOccludees),t.subPass===aV.Color?(i.receiveAmbientOcclusion=r.ssaoHelper.ready,i.hasOccludees=r.hasOccludees,i.receiveShadows=r.shadowMap.ready,i.hasScreenSpaceReflections=r.ssr.enabled,i.hasCloudsReflections=(0,Nu.r)(r.cloudsFade.data)):(i.receiveAmbientOcclusion=!1,i.receiveShadows=!1),i.snowCover=this.hasSnowCover(r),t.subPass===aV.ObjectAndLayerIdColor&&(i.objectAndLayerIdColor=!0)),this._technique=e.releaseAndAcquire(PH,i,this._technique),this._setClean(),this._technique}},{key:"hasSnowCover",value:function(e){return(0,Nu.r)(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}},{key:"submit",value:function(e,t,r){if(0!==this.objectOpacity){var n=r.renderable.geometry,i=r.components,a=r.renderable.meta.cameraDepthSquared,o=i.geometryRanges,s=i.highlightRanges,l=i.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case MH.Opaque:e.materialOpaque.submitDraw(this,n,o,a);break;case MH.Transparent:e.materialTransparent.submitDraw(this,n,o,a);break;case MH.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,n,o,a),e.materialTransparent.submitDraw(this,n,o,a);break;case MH.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,n,o,a),function(e){return 0!==e.overlays.length&&(0,Nu.r)(e.overlays[GS.INNER].getValidTexture(WS.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,o,a)}var u=this.componentParameters.castShadows!==IH.None;u&&e.shadowMap.submitDraw(this,n,o,a),(0,Nu.r)(s)&&(e.highlight.submitDraw(this,n,s,a),u&&e.highlightShadowMap.submitDraw(this,n,s,a)),u&&(0,Nu.r)(l)&&e.defaultShadowMap.submitDraw(this,n,l,a)}}},{key:"_computeWhichMaterialPass",value:function(){return this.isIntegratedMesh?MH.IntegratedMesh:this.objectOpacity<1?MH.Transparent:this.componentParameters.opaqueOverride===IH.All?MH.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===vc.C.Blend||this.alphaDiscardMode===vc.C.MaskBlend?MH.Transparent:this.componentParameters.transparent===IH.None?MH.Opaque:this.componentParameters.transparent===IH.All?MH.Transparent:MH.OpaqueAndTransparent}}]),r}(AH);(0,Eu.e)([EH({vectorOps:Vu.af})],NH.prototype,"baseColor",void 0),(0,Eu.e)([EH()],NH.prototype,"usePBR",void 0),(0,Eu.e)([EH()],NH.prototype,"hasParametersFromSource",void 0),(0,Eu.e)([EH({vectorOps:Vu.ae})],NH.prototype,"mrrFactors",void 0),(0,Eu.e)([EH({vectorOps:Vu.ae})],NH.prototype,"emissiveFactor",void 0),(0,Eu.e)([EH({dispose:!0})],NH.prototype,"baseColorTexture",void 0),(0,Eu.e)([EH({dispose:!0})],NH.prototype,"metallicRoughnessTexture",void 0),(0,Eu.e)([EH({dispose:!0})],NH.prototype,"emissionTexture",void 0),(0,Eu.e)([EH({dispose:!0})],NH.prototype,"occlusionTexture",void 0),(0,Eu.e)([EH({dispose:!0})],NH.prototype,"normalTexture",void 0),(0,Eu.e)([EH()],NH.prototype,"objectOpacity",void 0),(0,Eu.e)([DH()],NH.prototype,"commonMaterialParameters",void 0),(0,Eu.e)([DH()],NH.prototype,"componentParameters",void 0),(0,Eu.e)([EH()],NH.prototype,"textureAlphaCutoff",void 0),(0,Eu.e)([EH()],NH.prototype,"alphaDiscardMode",void 0),(0,Eu.e)([EH()],NH.prototype,"isIntegratedMesh",void 0),(0,Eu.e)([EH()],NH.prototype,"polygonOffsetEnabled",void 0),(0,Eu.e)([EH()],NH.prototype,"ellipsoidMode",void 0),(0,Eu.e)([EH()],NH.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(MH||(MH={}));var FH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).doubleSided=!1,e.cullFace=vc.n.Back,e.hasSlicePlane=!0,e}return(0,ku.Z)(r)}(kH);(0,Eu.e)([EH()],FH.prototype,"doubleSided",void 0),(0,Eu.e)([EH()],FH.prototype,"cullFace",void 0),(0,Eu.e)([EH()],FH.prototype,"hasSlicePlane",void 0);var zH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).externalColor=(0,uh.r)(1,1,1,1),e.externalColorMixMode=lh.r.Multiply,e.castShadows=IH.All,e}return(0,ku.Z)(r,[{key:"transparent",get:function(){return this.externalColor[3]<1?IH.All:IH.None}},{key:"opaqueOverride",get:function(){return this.externalColorMixMode===lh.r.Replace&&1===this.externalColor[3]?IH.All:IH.None}},{key:"visible",get:function(){return this.externalColor[3]>0?IH.All:IH.None}},{key:"type",get:function(){return cH.Uniform}}]),r}(kH);(0,Eu.e)([EH({vectorOps:Vu.af})],zH.prototype,"externalColor",void 0),(0,Eu.e)([EH()],zH.prototype,"externalColorMixMode",void 0),(0,Eu.e)([EH()],zH.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(IH||(IH={}));var UH=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).texture=null,e.transparent=IH.None,e.opaqueOverride=IH.None,e.castShadows=IH.None,e}return(0,ku.Z)(r,[{key:"type",get:function(){return cH.Varying}}]),r}(kH);(0,Eu.e)([EH()],UH.prototype,"texture",void 0),(0,Eu.e)([EH()],UH.prototype,"transparent",void 0),(0,Eu.e)([EH()],UH.prototype,"opaqueOverride",void 0),(0,Eu.e)([EH()],UH.prototype,"castShadows",void 0);var VH=function(){function e(t){(0,Au.Z)(this,e),this._maxCount=t,this._nextIndex=0,this._recycledIndices=[]}return(0,ku.Z)(e,[{key:"activeCount",get:function(){return this._nextIndex-this._recycledIndices.length}},{key:"availableCount",get:function(){return this._recycledIndices.length+this._maxCount-this._nextIndex}},{key:"acquire",value:function(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}},{key:"release",value:function(e){this._recycledIndices.push(e)}}]),e}(),BH=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,Au.Z)(this,e),this._rctx=t,this._fieldCount=r,this.textureWidth=4096,this._dirty=!0,this._texture=new Oc.E(this._rctx,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.NEAREST,wrapMode:pc.D.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new Zc.x(new ArrayBuffer(4*this.textureWidth))}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._texture.dispose(),this._texture=void 0,this._data=void 0}},{key:"setData",value:function(e,t,r,n,i,a){var o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,r),this._data.set(o,1,n),this._data.set(o,2,i),this._data.set(o,3,a)}},{key:"setDataElement",value:function(e,t,r,n){var i=e*this._fieldCount+t;this._dirty=!0,this._data.set(i,r,n)}},{key:"resizeToFit",value:function(e){var t=e*this._fieldCount;if(t>=this._data.count){var r=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,n=new Zc.x(new ArrayBuffer(4*r));n.typedBuffer.set(this._data.typedBuffer),this._data=n}}},{key:"updateTexture",value:function(){if(this._dirty){var e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}}},{key:"texture",get:function(){return this._texture}}]),e}(),GH=65536,HH=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,Au.Z)(this,e),this.textureBuffer=new BH(t,r),this._indexManager=new VH(GH)}return(0,ku.Z)(e,[{key:"dispose",value:function(){this.textureBuffer.dispose(),this.textureBuffer=void 0}},{key:"availableCount",get:function(){return this._indexManager.availableCount}},{key:"activeCount",get:function(){return this._indexManager.activeCount}},{key:"acquireIndex",value:function(){var e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}},{key:"releaseIndex",value:function(e){this._indexManager.release(e)}}]),e}(),jH=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,Au.Z)(this,e),this._rctx=t,this._fieldCount=r,this._buffers=[]}return(0,ku.Z)(e,[{key:"garbageCollect",value:function(){this._buffers=this._buffers.filter((function(e){return 0!==e.activeCount||(e.dispose(),!1)}))}},{key:"destroy",value:function(){this._buffers.forEach((function(e){return e.dispose()})),this._buffers=[]}},{key:"getBuffer",value:function(e){var t,r=(0,Cu.Z)(this._buffers);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.availableCount>=e)return n}}catch(a){r.e(a)}finally{r.f()}if(e>GH)return null;var i=new HH(this._rctx,this._fieldCount);return this._buffers.push(i),i}},{key:"updateTextures",value:function(){var e,t=(0,Cu.Z)(this._buffers);try{for(t.s();!(e=t.n()).done;){e.value.textureBuffer.updateTexture()}}catch(r){t.e(r)}finally{t.f()}}}]),e}(),qH=Eu.a.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),WH=function(){function e(t,r){(0,Au.Z)(this,e),this._renderManager=t,this._viewingMode=r,this._objects=[new Eu.a6,new Eu.a6],this._renderSubmit=new lH(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=(0,Nu.h)("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new jH(t.rctx,2+(this._hasObjectAndLayerId?1:0))}return(0,ku.Z)(e,[{key:"dispose",value:function(){(0,Sc.e)(0===this._objects[RG.Hidden].length&&0===this._objects[RG.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}},{key:"createObject",value:function(e){var t=new AG;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=(0,qc.F)(e.obb),t.components=new PG(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new MG(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}},{key:"destroyObject",value:function(e){var t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()}},{key:"setObjectVisibility",value:function(e,t){var r=e;t!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[t].push(r),r.visible=t,this._notifyDirty())}},{key:"preSubmit",value:function(e){var t=e.camera.eye;this.visibleObjects.forAll((function(e){return e.renderable.meta.cameraDepthSquared=(0,Vu.p)(t,e.obb.center)}))}},{key:"getMaterial",value:function(e){return e.renderable.material}},{key:"updateMaterial",value:function(e,t){var r=e.renderable.material;t(r),r.dirty&&this._notifyDirty()}},{key:"setAllComponentVisibilities",value:function(e,t){var r=e;r.components.visibility.reset(t),r.components.visibilityDirty(),this._notifyDirty()}},{key:"forEachVisibleComponent",value:function(e,t){return e.components.visibility.forEachComponent(t)}},{key:"getComponentCount",value:function(e){var t=e,r=t.components.visibility.componentCount();return{visible:r,invisible:t.components.count-r}}},{key:"setComponentData",value:function(e,t){for(var r=e,n=r.renderable.material,i=r.components,a=i.materialDataBuffer,o=i.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:(0,uh.n)(),externalColorMixMode:lh.r.Multiply,elevationOffset:0,objectAndLayerIdColor:this._hasObjectAndLayerId?(0,uh.n)():null},l=a.textureBuffer,u=new Uint8Array(4),c=new Uint32Array(u.buffer),h=0,d=0,f=0,p=i.verticalOffsets,v=1/0,m=-1/0,y=!1,g=!1,_=0,b=0;b<i.count;b++){if(t(b,s),h+=+(s.externalColor[3]<1),d+=+(s.externalColorMixMode===lh.r.Replace&&1===s.externalColor[3]),f+=+s.castShadows,(0,lh.o)(s.externalColor,s.externalColorMixMode,u),u[2]=254&u[2]|+s.castShadows,l.setData(o[b],0,u[0],u[1],u[2],u[3]),y||(y=b>0&&_!==c[0]),_=c[0],g||(g=0!==s.elevationOffset),g&&(0,Nu.t)(p)&&(p=new Array(b).fill(0)),(0,Nu.r)(p)&&(p[b]=s.elevationOffset),v=Math.min(v,s.elevationOffset),m=Math.max(m,s.elevationOffset),mH(s.elevationOffset,u),l.setData(o[b],1,u[0],u[1],u[2],u[3]),this._hasObjectAndLayerId){var x=s.objectAndLayerIdColor;l.setData(o[b],2,x[0],x[1],x[2],x[3])}s.pickable!==EG(i.pickability,b)&&(i.pickability=kG(i.pickability,i.count,b,s.pickable))}i.verticalOffsets=g?p:null,r.offsetObb=g?(0,qc.O)(r.obb,v,m,this._viewingMode,(0,Nu.r)(r.offsetObb)?r.offsetObb:(0,qc.F)(r.obb)):null,y||g||this._hasObjectAndLayerId?(n.componentParameters=new UH,n.componentParameters.castShadows=YH(f,i.count),n.componentParameters.transparent=YH(h,i.count),n.componentParameters.opaqueOverride=YH(d,i.count),n.componentParameters.texture=l,l.updateTexture()):(n.componentParameters=new zH,n.componentParameters.castShadows=s.castShadows?IH.All:IH.None,n.componentParameters.externalColor=s.externalColor,n.componentParameters.externalColorMixMode=s.externalColorMixMode),this._notifyDirty()}},{key:"getComponentAabb",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,r);var i=e,a=i.components.verticalOffsets;if(n||(0,Nu.t)(a))return r;var o=a[t];if(this._viewingMode===ic.l.Local||0===o)return r[2]+=o,r[5]+=o,r;var s=(0,Nu.e)((0,Ic.V)(o));return s.localOrigin=i.transform.position,s.applyToAabb(r)}},{key:"getComponentObb",value:function(e){return e.obb}},{key:"getObjectTransform",value:function(e){return e.transform}},{key:"getComponentPositions",value:function(e,t,r){return e.intersectionGeometry.getComponentPositions(t,r)}},{key:"intersect",value:function(e,t,r,n,i,a){var o=e;(0,Nu.r)(i)&&(i.localOrigin=o.transform.position);var s=(0,mc.u)(QH,o.transform.rotationScale);(0,Vu.a0)(KH,t,o.transform.position),(0,Vu.a0)(JH,r,o.transform.position),(0,Vu.S)(KH,KH,s),(0,Vu.S)(JH,JH,s);var l=(0,mc.o)(QH,s);return o.intersectionGeometry.intersect(KH,JH,n,l,i,o.components.verticalOffsets,a)}},{key:"addEdges",value:function(e,t,r,n){var i=e,a=i.intersectionGeometry,o=a.indices,s=a.positions,l=i.components.offsets;return t.addComponentObject(e,i.transform,{center:i.obb.center,radius:(0,qc.W)(i.obb)},s,o,l,r,n)}},{key:"extractEdgeInformation",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n){var i,a,o,s,l,u,c,h,d;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=(i=t).components.visibility).allInvisible()){e.next=3;break}return e.abrupt("return",{buffer:xc.m.createBuffer(0),origin:[0,0,0]});case 3:return o=i.intersectionGeometry,s=o.indices,l=o.positions,u=i.components.offsets,c=xc.A.createBuffer(l.count),(0,Kc.e)(c.position,l),(0,Kc.r)(c.position,c.position,i.transform.rotationScale),this._setComponentIndices(c.componentIndex,s,u),h=c.count,d=this._computeVisibilityIndices(s,a,u,h),e.t0=(0,Vu.t)(i.transform.position),e.next=9,r.extractComponentsEdgeLocations({indices:d,indicesLength:d.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},n);case 9:return e.t1=e.sent,e.abrupt("return",{origin:e.t0,buffer:e.t1});case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_setComponentIndices",value:function(e,t,r){for(var n=0,i=0;i<r.length-1;i++){for(var a=r[i],o=r[i+1],s=a;s<o;s++){var l=t?t[s]:s;e.set(l,n)}n++}}},{key:"_computeVisibilityIndices",value:function(e,t,r,n){if(e&&t.allVisible())return e;var i=0;t.forEachComponentRange((function(e,t){return i+=r[t]-r[e],!0}));var a=Array.isArray(e)?new Array(i):2===(null===e||void 0===e?void 0:e.BYTES_PER_ELEMENT)||n<=65536?new Uint16Array(i):new Uint32Array(i),o=0;return t.forEachComponentRange((function(t,n){for(var i=r[t],s=r[n],l=i;l<s;l++)a[o++]=e?e[l]:l;return!0})),a}},{key:"addComponentHighlight",value:function(e,t){var r=e.components;(0,Nu.t)(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),0===r.highlightCounts[t]++&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}},{key:"removeComponentHighlight",value:function(e,t){var r=e.components;if((0,Nu.t)(r.highlightCounts))qH.warn("Removing non-existing highlight.");else{var n=r.highlightCounts[t],i=r.highlightCounts[r.count];if(0!==n){if(n>1)return r.highlightCounts[t]=n-1,void(r.highlightCounts[r.count]=i-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),1===i?r.highlightCounts=null:r.highlightCounts[r.count]=i-1}else qH.warn("Removing non-existing highlight.")}}},{key:"clearHighlights",value:function(e){var t=e.components;(0,Nu.r)(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}},{key:"getObjectGPUMemoryUsage",value:function(e){return e.renderable.meta.gpuMemoryEstimate}},{key:"visibleObjects",get:function(){return this._objects[RG.Visible]}},{key:"_createRenderable",value:function(e,t){for(var r=this._renderManager.rctx,n=e.geometry,i=n.vertices.layoutParameters,a=_c.E.createVertex(r,pc.F.STATIC_DRAW,n.vertices.data),o=(0,Nu.n)(n.indices,(function(e){return _c.E.createIndex(r,pc.F.STATIC_DRAW,e)})),s=(0,xc.o)(uH(i)),l=new Uint16Array(n.vertices.count),u=0;u<t.count;u++){var c=t.offsets[u],h=t.offsets[u+1],d=t.materialDataIndices[u];if((0,Nu.r)(n.indices))for(var f=c;f<h;f++)l[n.indices[f]]=d;else for(var p=c;p<h;p++)l[p]=d}var v=_c.E.createVertex(r,pc.F.STATIC_DRAW,l.buffer),m=new NH(e.transform,e.toMapSpace),y=new _c.b(r,RH,{data:s,componentIndices:XH},{data:a,componentIndices:v},(0,Nu.e)(o)),g=new NG(y,pc.E.TRIANGLES,i,(0,Nu.r)(o)),_={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+v.byteSize+((0,Nu.r)(o)?o.byteSize:0)};return new ZG(m,g,_)}},{key:"_notifyDirty",value:function(){this._renderManager.notifyDirty()}}]),e}(),XH=(0,xc.o)((0,wc.T)().u16(fc.O.COMPONENTINDEX));function YH(e,t){return e===t?IH.All:0===e?IH.None:IH.Some}var QH=(0,mh.e)(),KH=(0,Vu.n)(),JH=(0,Vu.n)(),$H=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).opacity=1,e}return(0,ku.Z)(r)}(dc.t);function ej(e){var t=new dc.o;return t.include(dc.F),t.fragment.uniforms.add(new dc.h("tex",(function(e){return e.texture}))),e.hasOpacityFactor&&t.fragment.uniforms.add(new dc.g("opacity",(function(e){return e.opacity}))),t.fragment.code.add((0,dc.n)($s||($s=(0,wu.Z)(["\n    void main() {\n      gl_FragColor = texture2D(tex, uv) ",";\n    }"])),e.hasOpacityFactor?"* opacity":"")),t}var tj,rj=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:$H,build:ej},Symbol.toStringTag,{value:"Module"}));!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(tj||(tj={}));var nj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).alphaMode=tj.None,e.hasOpacityFactor=!1,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)({count:tj.COUNT})],nj.prototype,"alphaMode",void 0),(0,Eu.e)([(0,dc.p)()],nj.prototype,"hasOpacityFactor",void 0);var ij=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){switch(this.configuration.alphaMode){case tj.None:return(0,vc.W)({colorWrite:vc._});case tj.Alpha:return(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._});case tj.PremultipliedAlpha:case tj.COUNT:return(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}}]),r}(dc.k);ij.shader=new dc.m(rj,(function(){return r.e(8447).then(r.bind(r,28447))}));var aj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(dc.t);function oj(){var e=new dc.o;return e.include(dc.F),e.fragment.uniforms.add(new dc.h("tex",(function(e){return e.texture}))),e.fragment.code.add((0,dc.n)(el||(el=(0,wu.Z)(["void main() {\ngl_FragColor = vec4(1.0 - texture2D(tex, uv).a);\n}"])))),e}var sj=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:aj,build:oj},Symbol.toStringTag,{value:"Module"})),lj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}]),r}(dc.k);lj.shader=new dc.m(sj,(function(){return r.e(6686).then(r.bind(r,16686))}));var uj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(dc.t);function cj(){var e=new dc.o;return e.include(dc.F),e.fragment.uniforms.add([new dc.h("colorTexture",(function(e){return e.colorTexture})),new dc.h("alphaTexture",(function(e){return e.alphaTexture})),new dc.h("frontFaceTexture",(function(e){return e.frontFaceTexture}))]),e.fragment.code.add((0,dc.n)(tl||(tl=(0,wu.Z)(["void main() {\nvec4 srcColor = texture2D(colorTexture, uv);\nif(srcColor.a <= 1e-5){\ndiscard;\n}\nfloat srcAlpha = texture2D(alphaTexture, uv).r;\nvec4 frontFace = texture2D(frontFaceTexture, uv);\ngl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);\n}"])))),e}var hj=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:uj,build:cj},Symbol.toStringTag,{value:"Module"})),dj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}]),r}(dc.k);dj.shader=new dc.m(hj,(function(){return r.e(1784).then(r.bind(r,31784))}));var fj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).overlayIndex=GS.INNER,e.opacity=1,e}return(0,ku.Z)(r)}(dc.t);function pj(){var e=new dc.o;return e.include(dc.F),e.fragment.uniforms.add(new dc.h("tex",(function(e){return e.texture}))),e.fragment.uniforms.add(new dc.bd("overlayIdx",(function(e){return e.overlayIndex}))),e.fragment.uniforms.add(new dc.g("opacity",(function(e){return e.opacity}))),e.fragment.code.add((0,dc.n)(rl||(rl=(0,wu.Z)(["void main() {\nvec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);\ngl_FragColor = texture2D(tex, overlayUV) * opacity;\n}"])))),e}var vj=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:fj,build:pj},Symbol.toStringTag,{value:"Module"})),mj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}]),r}(dc.k);mj.shader=new dc.m(vj,(function(){return r.e(4218).then(r.bind(r,94218))}));var yj=function(){function e(t,r){(0,Au.Z)(this,e),this._rctx=t,this._techniqueRepository=r,this._configuration=new nj,this._passParameters=new $H,this._oitParameters=new uj,this._hudParameters=new aj,this._overlayParameters=new fj}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._vao=(0,Nu.G)(this._vao)}},{key:"compositeOIT",value:function(e,t,r,n){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=r,this._oitParameters.frontFaceTexture=n;var i=this._rctx,a=this._techniqueRepository.acquire(dj);i.bindTechnique(a,this._oitParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(o,"geometry")),a.release()}},{key:"compositeHUD",value:function(e,t){this._hudParameters.texture=t;var r=this._rctx,n=this._techniqueRepository.acquire(lj);r.bindTechnique(n,this._hudParameters,e);var i=this._ensureVAO();r.bindVAO(i),r.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(i,"geometry")),n.release()}},{key:"compositeOverlay",value:function(e,t,r,n){this._overlayParameters.texture=t,this._overlayParameters.opacity=r,this._overlayParameters.overlayIndex=n;var i=this._rctx,a=this._techniqueRepository.acquire(mj);i.bindTechnique(a,this._overlayParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(o,"geometry")),a.release()}},{key:"composite",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:tj.None,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=this._rctx;this._configuration.alphaMode=r,this._configuration.hasOpacityFactor=1!==n,this._passParameters.texture=t,this._passParameters.opacity=n;var a=this._techniqueRepository.acquire(ij,this._configuration);i.bindTechnique(a,this._passParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(o,"geometry")),a.release()}},{key:"_ensureVAO",value:function(){return(0,Nu.t)(this._vao)&&(this._vao=(0,dc.u)(this._rctx)),this._vao}}]),e}();function gj(e,t,r){return(0,Nc.r)(t,e)*(r[1]-r[0])+r[0]}function _j(e,t,r){if(t.size<1e4)return Ej.compute(e,t);var n=FG();return r.forAll((function(t){t.isVisible&&UG(n,function(e,t){if(!t.isVisible)return;var r=FG(),n=t.getSpatialQueryAccelerator();return(0,Nu.r)(n)?function(e,t,r){var n=t.eye,i=t.viewForward,a=t.frustum,o=function(e){return e.isVisible},s=r.objectCount;if(s<500)zG(Aj,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(n,i,rh.G.DepthOrder.FRONT_TO_BACK,Aj,(function(r,n){bj(e,t,r),Aj.far=e.near,n.setRange(Aj)}),a,o),zG(Aj,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(n,i,rh.G.DepthOrder.BACK_TO_FRONT,Aj,(function(r,n){bj(e,t,r),Aj.near=e.far,n.setRange(Aj)}),a,o);else{var l=Math.max(Math.min(s,500),Math.ceil(.1*s)),u=r.findClosest(i,rh.G.DepthOrder.FRONT_TO_BACK,a,o,l),c=r.findClosest(i,rh.G.DepthOrder.BACK_TO_FRONT,a,o,l);u&&c&&(wj(e,t,u.boundingVolumeWorldSpace.bounds),wj(e,t,c.boundingVolumeWorldSpace.bounds))}}(r,e,n):function(e,t,r){kj.clear(),r.forAll((function(e){e.isVisible&&0!==e.geometryRecords.length&&kj.add(e)})),kj.empty||(kj.sort(t),zG(Aj,t.near,Math.min(e.near,t.far)),kj.forEachInDepthRange(Aj,rh.G.DepthOrder.FRONT_TO_BACK,(function(r,n){n<e.near&&bj(e,t,r)})),zG(Aj,Math.max(e.far,t.near),t.far),kj.forEachInDepthRange(Aj,rh.G.DepthOrder.BACK_TO_FRONT,(function(t,r,n){e.far=Math.max(e.far,n)})))}(r,e,t.objects),r}(e,t))})),n}function bj(e,t,r){if(r.isVisible&&(0,kc.i)(t.frustum,r.boundingVolumeWorldSpace.bounds)){var n=r.transformation,i=Rj;r.geometryRecords.forEach((function(r){(0,Wu.u)(i,n,r.getShaderTransformation());var a=(0,qu.I)(i);xj(e,t,r.geometry.boundingInfo,i,a)}))}}function xj(e,t,r,n,i){if(!(0,Nu.t)(r)){(0,Vu.O)(Pj,r.center,n);var a=t.eye,o=t.viewForward,s=o[0]*(Pj[0]-a[0])+o[1]*(Pj[1]-a[1])+o[2]*(Pj[2]-a[2]);if(Pj[3]=r.radius*i,!(s-Pj[3]>e.near&&s+Pj[3]<e.far)&&(0,kc.i)(t.frustum,Pj))if(r.radius>100&&r.getChildren())for(var l=r.getChildren(),u=0;u<8;++u)l[u]&&xj(e,t,l[u],n,i);else Dj.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,r.bbMin,r.bbMax)}}function wj(e,t,r){var n=t.eye,i=t.viewForward,a=(r[0]-n[0])*i[0]+(r[1]-n[1])*i[1]+(r[2]-n[2])*i[2];e.near=Math.min(e.near,a-r[3]),e.far=Math.max(e.far,a+r[3])}var Tj=function(){function e(){(0,Au.Z)(this,e),this._items=new Eu.a6({allocator:function(e){return e||{obj:null,distance:0,near:0,far:0}},deallocator:function(e){return e.obj=null,e.distance=0,e.near=0,e.far=0,e}})}return(0,ku.Z)(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}},{key:"clear",value:function(){this._items.clear()}},{key:"add",value:function(e){this._items.pushNew().obj=e}},{key:"sort",value:function(e){var t=e.eye,r=e.viewForward;this._items.forAll((function(e){var n=e.obj.boundingVolumeWorldSpace.bounds,i=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];e.distance=i,e.near=i-n[3],e.far=i+n[3]})),this._items.sort((function(e,t){return e.distance-t.distance}))}},{key:"forEachInDepthRange",value:function(e,t,r){if(t===rh.G.DepthOrder.FRONT_TO_BACK)for(var n=0;n<this._items.length;++n){var i=this._items.data[n];i.far<e.near||i.near>e.far||r(i.obj,i.near,i.far)}else for(var a=this._items.length-1;a>=0;--a){var o=this._items.data[a];o.far<e.near||o.near>e.far||r(o.obj,o.near,o.far)}}}]),e}(),Cj=function(){function e(){(0,Au.Z)(this,e),this._view=(0,hc.e)(),this._viewProj=(0,hc.e)(),this._frustum=(0,kc.H)(),this._geometries=[],this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._range={near:0,far:0},this._looseRange={near:0,far:0}}return(0,ku.Z)(e,[{key:"compute",value:function(e,t){var r=this;this._reset(),(0,Wu.n)(this._view,e.viewMatrix),(0,Wu.u)(this._viewProj,e.projectionMatrix,this._view),(0,kc.u)(this._frustum,e.frustum);var n=this._view,i=n[2],a=n[6],o=n[10],s=n[14],l=this._range,u=0;if(t.forEach((function(e){if(e.instanceParameters.visible&&e.castShadow){var t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),Pj,1),t=Pj):t=e.boundingSphere;var n=i*t[0]+a*t[1]+o*t[2]+s,l=n-t[3],c=n+t[3];r._geometries[u]=e,r._near[u]=-c,r._far[u]=-l,++u}})),0===this._geometries.length)return l;for(var c=0;c<this._geometries.length;++c)this._near[c]>l.far&&(l.far=this._near[c]),this._near[c]>2&&this._far[c]<l.near&&(l.near=this._far[c]);var h=this._looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;for(var d=0,f=0,p=0;p<this._geometries.length;++p)this._near[p]<l.near&&(this._near[p]>=h.near?l.near=this._near[p]:this._nearCandidates[d++]=p),this._far[p]>l.far&&(this._far[p]<=h.far?l.far=this._far[p]:this._farCandidates[f++]=p);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return l;this._nearCandidates.sort((function(e,t){return r._near[e]<r._near[t]?-1:r._near[e]>r._near[t]?1:0})),this._farCandidates.sort((function(e,t){return r._far[e]<r._far[t]?1:r._far[e]>r._far[t]?-1:0}));for(var v=0;v<this._nearCandidates.length;++v){var m=this._nearCandidates[v];if(this._near[m]<l.near){var y=this._geometries[m],g=y.boundingInfo;this._includeNearBoundingInfoRec(g,y.getShaderTransformation())}}for(var _=0;_<this._farCandidates.length;++_){var b=this._farCandidates[_];if(this._far[b]>l.far){var x=this._geometries[b],w=x.boundingInfo;this._includeFarBoundingInfoRec(w,x.getShaderTransformation())}}return l}},{key:"_reset",value:function(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0,this._range.near=Number.MAX_VALUE,this._range.far=-Number.MAX_VALUE}},{key:"_includeNearBoundingInfoRec",value:function(e,t){if(!(0,Nu.t)(e)){var r=e.getCenter();(0,Vu.O)(Pj,r,t);var n=(0,qu.I)(t),i=Pj[0],a=Pj[1],o=Pj[2],s=e.getBSRadius()*n,l=this._frustum;if(!(l[0][0]*i+l[0][1]*a+l[0][2]*o+l[0][3]>s||l[1][0]*i+l[1][1]*a+l[1][2]*o+l[1][3]>s||l[2][0]*i+l[2][1]*a+l[2][2]*o+l[2][3]>s||l[3][0]*i+l[3][1]*a+l[3][2]*o+l[3][3]>s)){var u=this._view[2]*i+this._view[6]*a+this._view[10]*o+this._view[14],c=u+s;if(!(-(u-s)<2||-c>=this._range.near))if(-c>this._looseRange.near)this._range.near=-c;else{if(s>100){var h=e.getChildren();if(void 0!==h){for(var d=0;d<8;++d)void 0!==h[d]&&this._includeNearBoundingInfoRec(h[d],t);return}}Dj.unionDepthRangeWithAABB(this._range,this._viewProj,t,e.getBBMin(),e.getBBMax())}}}}},{key:"_includeFarBoundingInfoRec",value:function(e,t){if(!(0,Nu.t)(e)){var r=e.getBSRadius(),n=e.getCenter();(0,Vu.O)(Pj,n,t);var i=(0,qu.I)(t),a=Pj[0],o=Pj[1],s=Pj[2];r*=i;var l=this._frustum;if(!(l[0][0]*a+l[0][1]*o+l[0][2]*s+l[0][3]>r||l[1][0]*a+l[1][1]*o+l[1][2]*s+l[1][3]>r||l[2][0]*a+l[2][1]*o+l[2][2]*s+l[2][3]>r||l[3][0]*a+l[3][1]*o+l[3][2]*s+l[3][3]>r)){var u=this._view[2]*a+this._view[6]*o+this._view[10]*s+this._view[14]-r;if(!(-u<=this._range.far))if(-u<this._looseRange.far)this._range.far=-u;else{if(r>100){var c=e.getChildren();if(void 0!==c){for(var h=0;h<8;++h)void 0!==c[h]&&this._includeFarBoundingInfoRec(c[h],t);return}}Dj.unionDepthRangeWithAABB(this._range,this._viewProj,t,e.getBBMin(),e.getBBMax())}}}}}]),e}(),Sj=function(){function e(){(0,Au.Z)(this,e),this._modelViewProj=(0,hc.e)(),this._clipPosition=[(0,lc.n)(),(0,lc.n)(),(0,lc.n)(),(0,lc.n)(),(0,lc.n)(),(0,lc.n)(),(0,lc.n)(),(0,lc.n)()]}return(0,ku.Z)(e,[{key:"unionDepthRangeWithAABB",value:function(e,t,r,n,i){var a=this._modelViewProj;(0,Wu.u)(a,t,r);for(var o=!1,s=0;s<8;++s){var l=this._clipPosition[s],u=0===s||3===s||4===s||7===s?n[0]:i[0],c=0===s||1===s||4===s||5===s?n[1]:i[1],h=s<4?n[2]:i[2];l[0]=a[0]*u+a[4]*c+a[8]*h+a[12],l[1]=a[1]*u+a[5]*c+a[9]*h+a[13],l[2]=a[2]*u+a[6]*c+a[10]*h+a[14],l[3]=a[3]*u+a[7]*c+a[11]*h+a[15]}for(var d=0;d<12;++d){for(var f=this._clipPosition[Oj[d][0]],p=this._clipPosition[Oj[d][1]],v=this._clipPosition[Oj[d][2]],m=this._clipTriangle(f,p,v),y=!0,g=0;g<m.length;++g)if(m[g][3]>=2){y=!1;break}if(!y){o=!0;for(var _=0;_<m.length;++_){var b=m[_][3];Number.isFinite(b)&&(e.near=Math.min(b,e.near),e.far=Math.max(b,e.far))}}}return o}},{key:"_inside",value:function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,Sc.e)(!1)}},{key:"_intersect",value:function(e,t,r){var n=0;return 0===r?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Vu.j)((0,lc.n)(),e,t,n)}},{key:"_clipTriangle",value:function(e,t,r){for(var n=[e,t,r],i=0;i<4;++i){var a=n;n=[];for(var o=0;o<a.length;++o){var s=a[o],l=a[(o+1)%a.length];this._inside(l,i)?(this._inside(s,i)||n.push(this._intersect(s,l,i)),n.push(l)):this._inside(s,i)&&n.push(this._intersect(s,l,i))}}return n}}]),e}(),Oj=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Pj=(0,Qu.R)(),Rj=(0,hc.e)(),Aj=FG(),kj=new Tj,Ej=new Cj,Dj=new Sj,Mj=(0,ku.Z)((function e(){(0,Au.Z)(this,e)})),Ij=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).textures=new Mj,e}return(0,ku.Z)(r)}(dc.t);function Lj(){var e=new dc.o;return e.attributes.add(fc.O.POSITION,"vec2"),e.vertex.uniforms.add(new dc.f("drawPosition",(function(e,t){return function(e,t){var r=t.camera.pixelRatio,n=e.magnifier.offset.x*r,i=e.magnifier.offset.y*r;(0,zu.d)(e.magnifier.position,Zj);var a=t.camera.screenToRender(Zj,Nj),o=Math.ceil(r*e.magnifier.size),s=t.camera.fullWidth,l=t.camera.fullHeight;return(0,Vu.C)(Fj,(a[0]+n)/s*2-1,(a[1]-i)/l*2-1,o/s*2,o/l*2)}(e,t)}))),e.varyings.add("vUV","vec2"),e.vertex.code.add((0,dc.n)(nl||(nl=(0,wu.Z)(["void main(void) {\nvUV = position;\ngl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);\n}"])))),e.fragment.uniforms.add(new dc.h("textureInput",(function(e){return e.textures.input}))),e.fragment.uniforms.add(new dc.h("textureMask",(function(e){return e.textures.mask}))),e.fragment.uniforms.add(new dc.h("textureOverlay",(function(e){return e.textures.overlay}))),e.fragment.uniforms.add(new dc.v("maskEnabled",(function(e){return e.magnifier.maskEnabled}))),e.fragment.uniforms.add(new dc.v("overlayEnabled",(function(e){return e.magnifier.overlayEnabled}))),e.fragment.code.add((0,dc.n)(il||(il=(0,wu.Z)(["const float barrelFactor = 1.1;\nvec2 barrel(vec2 uv) {\nvec2 uvn = uv * 2.0 - 1.0;\nif (uvn.x == 0.0 && uvn.y == 0.0) {\nreturn vec2(0.5, 0.5);\n}\nfloat theta = atan(uvn.y, uvn.x);\nfloat r = pow(length(uvn), barrelFactor);\nreturn r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;\n}\nvoid main() {\nfloat mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;\nvec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;\nvec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);\ngl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;\n}"])))),e}var Zj=(0,zu.i)(),Nj=(0,zu.s)(),Fj=(0,lc.n)(),zj=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._handles=new Eu.X,e._magnifier=null,e._imageSources=null,e._imageLoadTask=null,e._resources=null,e._passParameters=new Ij,e.events=new ec.n,e.attributeLocations=new Map([[fc.O.POSITION,0]]),e._tmpScreenPoint=(0,zu.i)(),e._tmpRenderPoint=(0,zu.s)(),e}return(0,ku.Z)(r,[{key:"updating",get:function(){return(0,Nu.t)(this._imageSources)&&(0,Nu.r)(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;if(e!==this._magnifier){this._handles.removeAll(),this._magnifier=e;var r=function(){t._updateResourceLoading(),t.events.emit("request-render")};(0,Nu.r)(this._magnifier)&&this._handles.add((0,Fu.l)((function(){return(0,Nu.n)(t._magnifier,(function(e){return e.version}))}),r)),r()}}},{key:"enabled",get:function(){return(0,Nu.r)(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return(0,Nu.r)(this._magnifier)&&this._magnifier.visible&&(0,Nu.r)(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"_factor",get:function(){return(0,Nu.r)(this._magnifier)&&this._magnifier.factor||1}},{key:"dispose",value:function(){this._magnifier=null,this._handles.destroy(),(0,Nu.r)(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}},{key:"render",value:function(e,t){var r=this._validMagnifier;if(!(0,Nu.t)(r)){var n=t.camera.pixelRatio,i=Math.ceil(n*r.size);if(this._updateResources(e,i),!(0,Nu.t)(this._resources)){var a=this._passParameters.textures,o=Math.ceil(1/this._factor*i);a.input.resize(o,o),(0,zu.d)(r.position,this._tmpScreenPoint);var s=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),l=t.camera.fullWidth,u=t.camera.fullHeight,c=.5*o,h=.5*o;s[0]=(0,Vu.a)(s[0],c,l-c-1),s[1]=(0,Vu.a)(s[1],h,u-h-1);var d=Math.floor(s[0]-c),f=Math.floor(s[1]-h),p=this._resources.program;p.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,d,f,o,o,0),this._passParameters.magnifier=r,e.useProgram(p),p.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(pc.E.TRIANGLE_STRIP,0,4)}}}},{key:"_updateResourceLoading",value:function(){var e=this,t=this._validMagnifier;if(!(0,Nu.t)(t)){var r=t.maskUrl,n=t.overlayUrl;!(0,Nu.r)(this._imageLoadTask)||this._imageLoadTask.maskUrl===r&&this._imageLoadTask.overlayUrl===n||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),(0,Nu.r)(this._imageSources)||(0,Nu.r)(this._imageLoadTask)||(this._imageLoadTask={maskUrl:r,overlayUrl:n,task:(0,ac.j)(function(){var t=(0,Ou.Z)((0,Su.Z)().mark((function t(i){var a,o,s;return(0,Su.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=(0,Nu.t)(r)||(0,Nu.t)(n)?(0,Lc.c)(i):null,o=(0,Nu.r)(r)?(0,yh.t)(r,{signal:i}):a.then((function(e){return e.mask})),s=(0,Nu.r)(n)?(0,yh.t)(n,{signal:i}):a.then((function(e){return e.overlay})),t.next=3,o;case 3:return t.t0=t.sent,t.next=6,s;case 6:t.t1=t.sent,e._imageSources={mask:t.t0,overlay:t.t1},e._disposeResources(),e.events.emit("request-render");case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((function(){return e.notifyChange("updating")}),(function(){return e.notifyChange("updating")})))}}},{key:"_updateResources",value:function(e,t){if(this.enabled)if((0,Nu.r)(this._resources)){if(this._passParameters.textures.size!==t){var r=this._createTextureResources(e,t);if((0,Nu.t)(r))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=r}}else{var n=this._createTextureResources(e,t);(0,Nu.t)(n)||(this._resources={program:this._createProgram(e),vao:(0,dc.u)(e,dc.bC,this.attributeLocations,0,1),pipelineState:(0,vc.W)({blending:(0,vc.s)(pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:vc._})},this._passParameters.textures=n)}else this._disposeResources()}},{key:"_disposeResources",value:function(){(0,Nu.t)(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}},{key:"_disposeTextureResources",value:function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}},{key:"_createTextureResources",value:function(e,t){if((0,Nu.t)(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;var r=new Oc.E(e,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,internalFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,flipped:!0,preMultiplyAlpha:!(0,ih.I)(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),n=new Oc.E(e,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.ALPHA,internalFormat:pc.P.ALPHA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,flipped:!0},this._imageSources.mask);return{input:new Oc.E(e,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,internalFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,samplingMode:pc.L.LINEAR,flipped:!1}),mask:n,overlay:r,size:t}}},{key:"_createProgram",value:function(e){return new dc.l(e,Lj(),this.attributeLocations)}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],zj.prototype,"_imageSources",void 0),(0,Eu.e)([(0,Eu.y)()],zj.prototype,"_imageLoadTask",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],zj.prototype,"updating",null),zj=(0,Eu.e)([(0,Eu.n)("esri/views/3d/webgl-engine/lib/MagnifierHelper")],zj);var Uj,Vj=function(){function e(){(0,Au.Z)(this,e),this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Zc.x(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}return(0,ku.Z)(e,[{key:"setUidToObjectAndLayerId",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(e&&t&&r&&n&&(this._layerUidToId.set(n,r),this._layerUidToPopupEnabled.set(n,i),i)){var l=this._layerUidToGraphicsUidToObjectId.get(n);l||(l=new Map,this._layerUidToGraphicsUidToObjectId.set(n,l)),l.set(t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:s})}}},{key:"getObjectAndLayerIdColor",value:function(e){var t=this.getObjectAndLayerIdColorArray(e);return(0,lc.r)(t.get(0,1),t.get(0,2),t.get(0,3),255)}},{key:"getObjectAndLayerIdColorArray",value:function(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;var t=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===t)return Eu.a.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(!1===t)return this.colorZero;var r=this._uidToRenderColor.get(e.layerUid);r||(r=new Map,this._uidToRenderColor.set(e.layerUid,r));var n=r.get(e.graphicUid);if(!n){for(;!n;){var i=Math.floor(16777214*Math.random())+1;this._colorToUID.has(i)||(n=i)}if(n>16777215)throw new Error("Object ID Overflow");r.set(e.graphicUid,n),this._colorToUID.set(n,e)}var a=new ArrayBuffer(4);return new DataView(a).setUint32(0,n,!1),new Zc.x(a)}},{key:"getColorToObjectAndLayerIdMapping",value:function(){var e,t=new Map,r=(0,Cu.Z)(this._colorToUID.entries());try{for(r.s();!(e=r.n()).done;){var n=(0,xu.Z)(e.value,2),i=n[0],a=n[1],o=this._layerUidToGraphicsUidToObjectId.get(a.layerUid),s=null;o?(s=o.get(a.graphicUid))||Eu.a.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+a.graphicUid):Eu.a.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+a.layerUid);var l=this._layerUidToId.get(a.layerUid);l||Eu.a.getLogger(this.declaredClass).warn("no layerId found for uid "+a.layerUid),s&&l&&t.set(i,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:s.objectId,lid:l,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",oid:s.objectId,lid:l})}}catch(u){r.e(u)}finally{r.f()}return t}}]),e}(),Bj=(0,Eu.aj)(1e3),Gj=(0,Eu.aj)(1e3/30);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(Uj||(Uj={}));var Hj=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Uj.FrontToBack;(0,Au.Z)(this,e),this._rctx=t,this._techniqueRepository=r,this._sorting=n,this._draws=new Eu.a6({initialSize:32,allocator:function(e){return e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}}),this._previouslyBoundDraw=new Map}return(0,ku.Z)(e,[{key:"submitDraw",value:function(e,t,r,n){var i=this._draws.pushNew();i.geometry=t,i.geometryRanges=r,i.material=e,i.depthSquaredHint=n,i.indexType=t.indexed?(0,Nu.e)(t.vao.indexBuffer).indexType:0}},{key:"dispatch",value:function(e,t){var r=this,n=this._rctx;this._previouslyBoundDraw.clear();for(var i=null,a=this._draws.map((function(n){return n.material.prepareTechnique(r._techniqueRepository,e,t,n.geometry.parameters)})),o=this._draws.length,s=0;s<o;s++){var l=a[s];l===i&&l.configuration.transparencyPassType===vc.o.NONE||(n.bindTechnique(l,e,t),i=l);var u=this._draws.data[s],c=u.geometry;n.bindVAO(c.vao),this._previouslyBoundDraw.get(l)!==u.material&&(l.program.bindDraw(u.material,t,e),this._previouslyBoundDraw.set(l,u.material));var h=u.geometryRanges,d=h.length;if(0!==u.indexType)for(var f=jj.get(u.indexType),p=0;p<d;p+=2){var v=h[p],m=h[p+1];n.drawElements(c.primitiveType,m,u.indexType,v*f)}else for(var y=0;y<d;y+=2){var g=h[y],_=h[y+1];n.drawArrays(c.primitiveType,g,_)}}}},{key:"prepareSubmit",value:function(){this._draws.clear()}},{key:"finishSubmit",value:function(){var e=this._sorting===Uj.FrontToBack?1:-1;this._draws.sort((function(t,r){var n=e*(t.depthSquaredHint-r.depthSquaredHint);return 0!==n?n:t.geometry.vao.size-r.geometry.vao.size}))}},{key:"count",get:function(){return this._draws.length}}]),e}(),jj=new Map;jj.set(pc.C.UNSIGNED_BYTE,1),jj.set(pc.C.UNSIGNED_SHORT,2),jj.set(pc.C.UNSIGNED_INT,4);var qj=function(){function e(t,r){(0,Au.Z)(this,e),this.rctx=t,this.shaderTechniqueRepository=r,this.canRender=!0,this._materialPassParameters=new lV,this._shadowPassParameters=new uV,this._highlightPassParameters=new cV,this._systems=new Set,this._passes={materialOpaque:new Hj(t,r),materialTransparent:new Hj(t,r,Uj.BackToFront),materialIntegratedMesh:new Hj(t,r),shadowMap:new Hj(t,r),highlight:new Hj(t,r),highlightIntegratedMesh:new Hj(t,r),highlightShadowMap:new Hj(t,r),defaultShadowMap:new Hj(t,r)}}return(0,ku.Z)(e,[{key:"register",value:function(e){this._systems.add(e)}},{key:"prepareRender",value:function(e){var t=this;if(0!==this._systems.size){for(var r=0,n=Object.values(this._passes);r<n.length;r++){n[r].prepareSubmit()}this._systems.forEach((function(r){return r.submit(t._passes,e.bindParameters)}));for(var i=0,a=Object.values(this._passes);i<a.length;i++){a[i].finishSubmit()}this.shaderTechniqueRepository.frameUpdate()}}},{key:"render",value:function(e){if(0!==this._systems.size)switch(this._configure(e),e.bindParameters.slot){case dc.H.OPAQUE_MATERIAL:switch(e.output){case dc.O.Color:return this._materialPassParameters.subPass=aV.Color,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Depth:return this._materialPassParameters.subPass=aV.Depth,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Normal:return this._materialPassParameters.subPass=aV.Normal,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case dc.O.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case dc.O.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case dc.O.ShadowExludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case dc.O.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=aV.ObjectAndLayerIdColor,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters)}return;case dc.H.TRANSPARENT_MATERIAL:switch(e.output){case dc.O.Color:return this._materialPassParameters.subPass=aV.Color,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Alpha:return this._materialPassParameters.subPass=aV.Alpha,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Depth:return this._materialPassParameters.subPass=aV.Depth,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Normal:return this._materialPassParameters.subPass=aV.Normal,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=aV.ObjectAndLayerIdColor,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case dc.H.INTEGRATED_MESH:switch(e.output){case dc.O.Color:return this._materialPassParameters.subPass=aV.Color,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Depth:return this._materialPassParameters.subPass=aV.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Normal:return this._materialPassParameters.subPass=aV.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case dc.O.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters);case dc.O.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=aV.ObjectAndLayerIdColor,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters)}return}}},{key:"notifyDirty",value:function(){this._context.requestRender()}},{key:"slots",value:function(){return[dc.H.OPAQUE_MATERIAL,dc.H.TRANSPARENT_MATERIAL,dc.H.INTEGRATED_MESH]}},{key:"initializeRenderContext",value:function(e){this._context=e}},{key:"uninitializeRenderContext",value:function(){}},{key:"queryDepthRange",value:function(e){var t={near:1/0,far:-1/0};return this._systems.forEach((function(r){var n=r.queryShadowCasterDepthRange(e);(0,Nu.r)(n)&&UG(t,n,t)})),t}},{key:"_configure",value:function(e){var t=e.output===dc.O.Shadow||e.output===dc.O.ShadowHighlight||e.output===dc.O.ShadowExludeHighlight?this._shadowPassParameters:e.output===dc.O.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)}},{key:"_updateParameters",value:function(e,t){var r=e.bindParameters.camera,n=r.viewInverseTransposeMatrix;(0,Vu.o)(Wj,n[3],n[7],n[11]),Yj.set(Wj),(0,Vu.r)(t.transformWorldFromViewTH,Yj.high),(0,Vu.r)(t.transformWorldFromViewTL,Yj.low),(0,Vu.r)(t.slicePlaneLocalOrigin,Wj),(0,mc.a)(t.transformViewFromCameraRelativeRS,r.viewMatrix),(0,Wu.n)(t.transformProjFromView,r.projectionMatrix),t.identifier===iV.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===dc.H.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===dc.H.INTEGRATED_MESH,(0,mc.o)(Xj,t.transformViewFromCameraRelativeRS),(0,mc.u)(t.transformNormalViewFromGlobal,Xj))}},{key:"needsHighlight",get:function(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}},{key:"needsTransparentPass",get:function(){return this._passes.materialTransparent.count>0}}]),e}(),Wj=(0,Vu.n)(),Xj=(0,gc.e)(),Yj=new LH;function Qj(){var e=new dc.o,t=e.vertex,r=e.fragment,n=t.code,i=r.code;return e.attributes.add(fc.O.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(fc.O.UV0,"vec2"),t.uniforms.add(new dc.h("coverageTex",(function(e){return e.coverageTexture}))),n.add((0,dc.n)(al||(al=(0,wu.Z)(["void main() {\nvec4 cov = texture2D(coverageTex, uv0);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\nreturn;\n}\ngl_Position = vec4(position, 0.0, 1.0);\nuv = position.xy * 0.5 + vec2(0.5);\n}"])))),r.uniforms.add(new dc.h("tex",(function(e){return e.blurColorTexture}))),r.uniforms.add(new dc.h("origin",(function(e){return e.highlightColorTexture}))),r.uniforms.add(new dc.f("uColor",(function(e){return e.color}))),r.uniforms.add(new dc.f("haloColor",(function(e){return e.haloColor}))),r.uniforms.add(new dc.f("opacities",(function(e){return(0,Vu.C)(Kj,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}))),r.constants.add("outlineSize","float",8.6),r.constants.add("blurSize","float",.4),i.add((0,dc.n)(ol||(ol=(0,wu.Z)(["void main() {\nvec4 blurredHighlightValue = texture2D(tex, uv);\nfloat highlightIntensity = blurredHighlightValue.a;\nif (highlightIntensity == 0.0) {\ndiscard;\n}\nvec4 origin_color = texture2D(origin, uv);\nfloat outlineIntensity;\nfloat fillIntensity;\nif (blurredHighlightValue.g > blurredHighlightValue.b) {\noutlineIntensity = haloColor.w * opacities[1];\nfillIntensity = uColor.w * opacities[3];\n}\nelse {\noutlineIntensity = haloColor.w * opacities[0];\nfillIntensity = uColor.w * opacities[2];\n}\nfloat inner = 1.0 - outlineSize / 9.0;\nfloat outer = 1.0 - (outlineSize + blurSize) / 9.0;\nfloat outlineFactor = smoothstep(outer, inner, highlightIntensity);\nfloat fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;\nfloat intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;\ngl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);\n}"])))),e}var Kj=(0,lc.n)(),Jj=Object.freeze(Object.defineProperty({__proto__:null,build:Qj},Symbol.toStringTag,{value:"Module"})),$j=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._})}}]),r}(dc.k);$j.shader=new dc.m(Jj,(function(){return r.e(9707).then(r.bind(r,39707))}));var eq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).blurSize=(0,cc.n)(),e}return(0,ku.Z)(r)}(dc.t);function tq(){var e=new dc.o,t=e.vertex,r=e.fragment,n=t.code,i=r.code;return e.attributes.add(fc.O.POSITION,"vec2"),e.attributes.add(fc.O.UV0,"vec2"),e.varyings.add("blurCoordinate","vec3"),t.uniforms.add(new dc.h("coverageTex",(function(e){return e.coverageTexture}))),r.uniforms.add(new dc.bD("blurSize",(function(e){return e.blurSize}))),n.add((0,dc.n)(sl||(sl=(0,wu.Z)(["void main() {\ngl_Position = vec4(position, 0.0, 1.0);\nvec4 cov = texture2D(coverageTex, uv0);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\n}\nblurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));\n}"])))),r.uniforms.add(new dc.bE("tex",(function(e){return e.blurInputTexture}))),i.add((0,dc.n)(ll||(ll=(0,wu.Z)(["void main() {\nvec2 uv = blurCoordinate.xy;\nvec4 center = texture2D(tex, uv);\nif (blurCoordinate.z == 1.0) {\ngl_FragColor = center;\n} else {\nvec4 sum = vec4(0.0);\nsum += center * 0.204164;\nsum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;\nsum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;\nsum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;\nsum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;\ngl_FragColor = sum;\n}\n}"])))),e}var rq=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:eq,build:tq},Symbol.toStringTag,{value:"Module"})),nq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);nq.shader=new dc.m(rq,(function(){return r.e(9761).then(r.bind(r,59761))}));var iq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).invFramebufferDim=(0,cc.n)(),e}return(0,ku.Z)(r)}(dc.t);function aq(){var e=new dc.o,t=e.vertex,r=e.fragment,n=t.code,i=r.code;return e.attributes.add(fc.O.POSITION,"vec2"),n.add((0,dc.n)(ul||(ul=(0,wu.Z)(["void main() {\ngl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);\n}"])))),r.uniforms.add(new dc.bE("tex",(function(e){return e.inputTexture}))),r.uniforms.add(new dc.bD("invFramebufferDim",(function(e){return e.invFramebufferDim}))),i.add((0,dc.n)(cl||(cl=(0,wu.Z)(["void main() {\nvec2 coord = gl_FragCoord.xy * invFramebufferDim;\nvec4 value = texture2D(tex, coord);\nfloat mx = floor(max(value.g, value.b));\ngl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);\n}"])))),e}var oq=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:iq,build:aq},Symbol.toStringTag,{value:"Module"})),sq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);sq.shader=new dc.m(oq,(function(){return r.e(4618).then(r.bind(r,54618))}));var lq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).color=(0,uh.r)(1,0,1,1),e.haloColor=(0,uh.r)(1,0,1,1),e.haloOpacity=1,e.haloOpacityOccluded=.25,e.fillOpacity=.2,e.fillOpacityOccluded=.05,e.shadowColor=(0,lc.r)(1,0,1,1),e.shadowOpacity=.15,e.occludedShadowOpacity=.075,e}return(0,ku.Z)(r)}(dc.t),uq=function(){function e(t,r){(0,Au.Z)(this,e),this._techniqueRep=t,this._rctx=r,this._viewportToRestore=(0,lc.n)(),this._passParameters=new lq,this._downsampleDrawParameters=new iq,this._blurDrawParameters=new eq,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}return(0,ku.Z)(e,[{key:"_assertResources",value:function(){if(!this._quadVAO){this._quadVAO=(0,dc.u)(this._rctx);var e={colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE,width:0,height:0},t={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new _c.x(this._rctx,e,t),this._blur1Fbo=new _c.x(this._rctx,e,t),this._blurTechnique=this._techniqueRep.acquire(nq),this._downsampleTechnique=this._techniqueRep.acquire(sq),this._applyTechnique=this._techniqueRep.acquire($j)}}},{key:"dispose",value:function(){if(this._blurTechnique=(0,Nu.F)(this._blurTechnique),this._downsampleTechnique=(0,Nu.F)(this._downsampleTechnique),this._applyTechnique=(0,Nu.F)(this._applyTechnique),this._grid.coverageMipmap)for(var e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=(0,Nu.G)(this._blur0Fbo),this._blur1Fbo=(0,Nu.G)(this._blur1Fbo)}},{key:"setDefaultOptions",value:function(e){this._passParameters=(0,Tu.Z)((0,Tu.Z)({},new lq),e)}},{key:"render",value:function(e,t,r){this._passParameters.highlightColorTexture=t.colorTexture,this._assertResources();var n=e.camera;(0,Vu.B)(this._viewportToRestore,n.fullViewport);var i=n.fullWidth,a=n.fullHeight,o=n.pixelRatio,s=Math.ceil(i/o),l=Math.ceil(a/o);this._blur0Fbo.resize(s,l),this._blur1Fbo.resize(s,l);var u=this._rctx;u.bindVAO(this._quadVAO);var c;this._gridUpdateResources(t,32),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,c=this._grid.vao;var h=u.bindTechnique(this._blurTechnique,this._passParameters,e);u.bindVAO(c),u.bindFramebuffer(this._blur0Fbo),u.setViewport(0,0,s,l),u.setClearColor(0,0,0,0),u.clear(pc._.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=t.colorTexture,(0,uc.r)(this._blurDrawParameters.blurSize,1/s,0),h.bindDraw(this._blurDrawParameters,e,this._passParameters),u.drawArrays(this._blurTechnique.primitiveType,0,(0,_c.n)(c,"geometry")),u.bindFramebuffer(this._blur1Fbo),u.clear(pc._.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,(0,uc.r)(this._blurDrawParameters.blurSize,0,1/l),h.bindDraw(this._blurDrawParameters,e,this._passParameters),u.drawArrays(this._blurTechnique.primitiveType,0,(0,_c.n)(c,"geometry")),u.bindFramebuffer(r),u.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,u.bindTechnique(this._applyTechnique,this._passParameters,e),u.drawArrays(this._applyTechnique.primitiveType,0,(0,_c.n)(c,"geometry")),u.bindVAO(null)}},{key:"_gridUpdateResources",value:function(e,t){var r=this._rctx,n=this._grid,i=!1;if(null===n.coverageMipmap&&(n.coverageMipmap=[e],i=!0),n.viewportWidth===e.width&&n.viewportHeight===e.height||(i=!0,n.viewportWidth=e.width,n.viewportHeight=e.height),n.coverageMipmap[0]=e,n.cellPixelSize!==t&&(n.cellPixelSize=t,i=!0),i){for(var a=1;a<n.coverageMipmap.length;a++)n.coverageMipmap[a].dispose();n.mipmapLevels=Math.ceil(Math.log(n.cellPixelSize)*Math.LOG2E),n.coverageMipmap.length=n.mipmapLevels+1;for(var o=0;o<n.mipmapLevels;o++){var s=n.coverageMipmap[o],l={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGB,dataType:pc.G.UNSIGNED_SHORT_5_6_5,samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},u={colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)};n.coverageMipmap[o+1]=new _c.x(r,u,l)}}var c=Math.ceil(e.height/n.cellPixelSize),h=Math.ceil(e.width/n.cellPixelSize);if(!n.vao||n.verticalCellCount!==c||n.horizontalCellCount!==h){n.verticalCellCount=c,n.horizontalCellCount=h;for(var d=c+1,f=h+1,p=1/c,v=1/h,m=new Float32Array(24*d*f),y=0,g=0;g<d;g++)for(var _=0;_<f;_++)m[y+0]=(_-.5)*v*2-1,m[y+1]=(g-.5)*p*2-1,m[y+2]=_*v,m[y+3]=g*p,m[y+4]=(_+.5)*v*2-1,m[y+5]=(g-.5)*p*2-1,m[y+6]=_*v,m[y+7]=g*p,m[y+8]=(_-.5)*v*2-1,m[y+9]=(g+.5)*p*2-1,m[y+10]=_*v,m[y+11]=g*p,m[y+12]=(_-.5)*v*2-1,m[y+13]=(g+.5)*p*2-1,m[y+14]=_*v,m[y+15]=g*p,m[y+16]=(_+.5)*v*2-1,m[y+17]=(g-.5)*p*2-1,m[y+18]=_*v,m[y+19]=g*p,m[y+20]=(_+.5)*v*2-1,m[y+21]=(g+.5)*p*2-1,m[y+22]=_*v,m[y+23]=g*p,y+=24;n.vao&&n.vao.dispose(!0),n.vao=new dc.N(r,dc.E,{geometry:dc.A},{geometry:_c.E.createVertex(r,pc.F.STATIC_DRAW,m)})}}},{key:"_gridComputeMipmap",value:function(e){var t=this._rctx,r=this._grid,n=t.bindTechnique(this._downsampleTechnique,this._passParameters,e);t.bindVAO(this._quadVAO);for(var i=0;i<r.mipmapLevels;i++){t.bindFramebuffer(r.coverageMipmap[i+1]);var a=r.coverageMipmap[i+1].width,o=r.coverageMipmap[i+1].height;this._downsampleDrawParameters.inputTexture=r.coverageMipmap[i].colorTexture,(0,uc.r)(this._downsampleDrawParameters.invFramebufferDim,1/a,1/o),n.bindDraw(this._downsampleDrawParameters,e,this._passParameters),t.setViewport(0,0,a,o),t.drawArrays(pc.E.TRIANGLE_STRIP,0,(0,_c.n)(this._quadVAO,"geometry"))}}},{key:"gpuMemoryUsage",get:function(){var e=((0,Nu.r)(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+((0,Nu.r)(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap){var t,r=(0,Cu.Z)(this._grid.coverageMipmap);try{for(r.s();!(t=r.n()).done;){e+=t.value.gpuMemoryUsage}}catch(n){r.e(n)}finally{r.f()}}return e}},{key:"test",get:function(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}}]),e}(),cq={dataType:pc.G.UNSIGNED_BYTE,internalFormat:pc.P.RGBA},hq={},dq=function(){function e(t){(0,Au.Z)(this,e),this._rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._depthBuffers.forEach((function(e){return e.dispose()})),this._depthBuffers.clear(),this._depthTextures.forEach((function(e){return e.dispose()})),this._depthTextures.clear(),this._colorTextures.forEach((function(e){return e.dispose()})),this._colorTextures.clear(),this._framebuffers.forEach((function(e){return e.dispose()})),this._framebuffers.clear(),this._activeTargets.clear()}},{key:"disposeTargetResource",value:function(e){var t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._disposeWithFramebuffers(this._depthTextures,t),this._disposeWithFramebuffers(this._depthBuffers,t),this._disposeWithFramebuffers(this._colorTextures,t))}},{key:"_disposeWithFramebuffers",value:function(e,t){var r=this,n=e.get(t);n&&(this._framebuffers.forEach((function(e,t){e.colorAttachment!==n&&e.depthStencilAttachment!==n||(e.detachAll(),e.dispose(),r._framebuffers.delete(t))})),n.dispose(),e.delete(t))}},{key:"getDepthTexture",value:function(e,t){if(!this.depthTextureSupported)return null;var r=this._depthTextures.get(e.id);return!r||r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=(0,Nu.d)()),r||(r=new Oc.E(this._rctx,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.DEPTH_STENCIL,dataType:pc.G.UNSIGNED_INT_24_8,samplingMode:pc.L.NEAREST,wrapMode:pc.D.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r}},{key:"getAllocatedDepthTexture",value:function(e){return this._depthTextures.get(e.id)}},{key:"getDepthBuffer",value:function(e,t){if(this.depthTextureSupported)return null;var r=this._depthBuffers.get(e.id);return r?r.descriptor.width===t.width&&r.descriptor.height===t.height||r.resize(t.width,t.height):(r=new _c.s(this._rctx,(0,Tu.Z)({internalFormat:pc.B.DEPTH_STENCIL},t)),this._depthBuffers.set(e.id,r),this._activeTargets.add(e.id)),r}},{key:"getColorTexture",value:function(e,t){var r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=(0,Nu.d)())),r||(r=new Oc.E(this._rctx,{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r}},{key:"getAllocatedColorTexture",value:function(e){return this._colorTextures.get(e.id)}},{key:"registerDepthTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Tu.Z)((0,Tu.Z)({id:(0,Eu.a4)()},hq),e)}},{key:"registerColorTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Tu.Z)((0,Tu.Z)({id:(0,Eu.a4)()},cq),e)}},{key:"getFramebuffer",value:function(e,t,r){var n=this._getKey(t,r),i=this._framebuffers.get(n),a=this.getColorTexture(t,e);if(this.depthTextureSupported){var o=r?this.getDepthTexture(r,e):void 0;return i?((i.width!==e.width||i.height!==e.height||i.colorTexture!==a||i.depthStencilTexture!==o)&&(i.detachAll(),i.resize(e.width,e.height),i.attachColorTexture(a),i.attachDepthStencilTexture(o)),i):(i=(0,Nu.r)(r)?new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.DEPTH_STENCIL_TEXTURE},a,o):new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE},a),this._framebuffers.set(n,i),i)}var s=r?this.getDepthBuffer(r,e):void 0;return i?((i.width!==e.width||i.height!==e.height||i.colorTexture!==a)&&(i.detachAll(),i.resize(e.width,e.height),i.attachColorTexture(a),i.attachDepthStencilBuffer(s)),i):(i=new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:r?pc.V.DEPTH_STENCIL_RENDER_BUFFER:pc.V.NONE},a,s),this._framebuffers.set(n,i),i)}},{key:"_getKey",value:function(e,t){return"".concat(e.id,"_").concat(t?t.id:"X","_").concat(e.name).concat(t?"_"+t.name:"")}},{key:"gpuMemoryUsage",get:function(){var e=0,t=new Set,r=function(r){t.has(r)||(t.add(r),e+=(0,_c.u)(r))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}]),e}(),fq=function(){function e(t,r){(0,Au.Z)(this,e),this._rctx=t,this._compositingHelper=r,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};var n=t.type===Fc.r.WEBGL2;this._renderTargetHelper=new dq(t);var i=this._renderTargetHelper;this._mainColorTargets=[i.registerColorTarget({name:"mainColorTarget0"}),i.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=i.registerColorTarget({name:"frontFaceTarget"});var a=function(e){return i.registerColorTarget({name:e,dataType:pc.G.FLOAT,internalFormat:n?pc.U.RGBA32F:pc.P.RGBA,samplingMode:pc.L.NEAREST})};this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=i.registerDepthTarget({name:"mainDepth"}),this.linearDepth=i.registerColorTarget({name:"linearDepth",samplingMode:pc.L.NEAREST}),this.terrainLinearDepth=i.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=i.registerColorTarget({name:"geometryLinearDepth"}),this.normal=i.registerColorTarget({name:"normal"}),this.highlight=i.registerColorTarget({name:"highlight",internalFormat:n?pc.U.RGBA4:pc.P.RGBA,dataType:pc.G.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=i.registerColorTarget({name:"hudVisibility",internalFormat:n?pc.U.RGBA4:pc.P.RGBA,dataType:pc.G.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=i.registerColorTarget({name:"tmpColor"}),this.tmpDepth=i.registerDepthTarget({name:"tmpDepth"}),this.hudColor=i.registerColorTarget({name:"hudColor"})}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._renderTargetHelper.dispose()}},{key:"width",get:function(){return this._dimensions.width}},{key:"height",get:function(){return this._dimensions.height}},{key:"background",get:function(){return this._background},set:function(e){this._background=e}},{key:"currentColorTarget",get:function(){return this._mainColorTargets[this._mainColorTarget]}},{key:"previousColorTarget",get:function(){return this._mainColorTargets[1-this._mainColorTarget]}},{key:"framebuffer",get:function(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}},{key:"getFramebuffer",value:function(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}},{key:"colorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}},{key:"depthTexture",get:function(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}},{key:"linearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}},{key:"terrainLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}},{key:"geometryLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}},{key:"lastFrameColorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}},{key:"normalTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}},{key:"highlightTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}},{key:"hudVisibilityTexture",get:function(){return this._getColorTexture(this.hudVisibility)}},{key:"tmpColorTexture",get:function(){return this._getColorTexture(this.tmpColor)}},{key:"hudColorTexture",get:function(){return this._getColorTexture(this.hudColor)}},{key:"mainColorTexture",get:function(){return this._getColorTexture(this.currentColorTarget)}},{key:"setupRenderTarget",value:function(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=0===this._mainColorTarget&&e?1:0}},{key:"initializeFrame",value:function(e){var t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);var r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(pc._.COLOR_BUFFER_BIT|pc._.DEPTH_BUFFER_BIT|pc._.STENCIL_BUFFER_BIT)}},{key:"composite",value:function(e){(0,Nu.r)(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,tj.None)}},{key:"renderTmpAndCompositeToMain",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.renderToTargets(e,this.tmpColor,n?this.tmpDepth:this.mainDepth,pq),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),r)}},{key:"renderHUDVisibility",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,vq)}},{key:"compositeTransparentTerrainOntoHUDVisibility",value:function(e){var t=this;this.renderToTargets((function(){return t._compositingHelper.compositeHUD(e,t._getColorTexture(t.tmpColor))}),this.hudVisibility,this.tmpDepth)}},{key:"renderOITPass",value:function(e,t,r){var n,i;switch(t){case vc.o.Color:n=this.colorFloatTarget,i=[0,0,0,0];break;case vc.o.Alpha:n=this.alphaFloatTarget,i=[1,1,1,1];break;case vc.o.FrontFace:n=this.frontFaceTarget,i=[0,0,0,0]}r?this.renderToTargets(e,n,this.tmpDepth,i,!0,!0):this.renderToTargets(e,n,this.mainDepth,i,!1)}},{key:"compositeTransparentTerrainOntoMain",value:function(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),tj.PremultipliedAlpha)}},{key:"compositeOccludedOntoMain",value:function(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),tj.PremultipliedAlpha,t)}},{key:"compositeTransparentOntoOpaque",value:function(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(pc._.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}},{key:"bindFramebuffer",value:function(){this._rctx.bindFramebuffer(this.framebuffer)}},{key:"renderDepthDetached",value:function(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}},{key:"disposeTarget",value:function(e){this._renderTargetHelper.disposeTargetResource(e)}},{key:"renderToFBO",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this._rctx,a=0;if(t){var o=1e-13,s=Math.max(o,t[3]);i.setClearColor(t[0],t[1],t[2],s),a|=pc._.COLOR_BUFFER_BIT}r&&(a|=pc._.DEPTH_BUFFER_BIT),!1===n?n=0:(!0===n&&(n=255),a|=pc._.STENCIL_BUFFER_BIT),a&&i.clearSafe(a,n),e(),i.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}},{key:"renderToTargets",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=this.bindTarget(t,r);return this.renderToFBO(e,n,i,a),o}},{key:"bindTarget",value:function(e,t){var r=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(r),r}},{key:"_getColorTexture",value:function(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}},{key:"gpuMemoryUsage",get:function(){var e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}]),e}(),pq=[0,0,0,0],vq=[0,1,0,1],mq=function(){function e(t){(0,Au.Z)(this,e),this._context=t,this._renderPlugins=new Eu.a6,this._slots=[];for(var r=0;r<dc.H.MAX_SLOTS;++r)this._slots[r]=[]}return(0,ku.Z)(e,[{key:"add",value:function(e,t,r){var n=this,i=function(){if(null!==r&&void 0!==r&&r.aborted)throw t.uninitializeRenderContext(),(0,Eu.d)();n._renderPlugins.push(t);var i,a=(0,Cu.Z)(e);try{for(a.s();!(i=a.n()).done;){var o=i.value;n._slots[o].push(t)}}catch(s){a.e(s)}finally{a.f()}n._context.requestRender()},a=t.initializeRenderContext(this._context,r);if((0,Eu.V)(a))return a.then(i);i()}},{key:"remove",value:function(e){if(null!=this._renderPlugins.removeUnordered(e)){for(var t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((function(t){return t!==e}));e.uninitializeRenderContext(),this._context.requestRender()}}},{key:"prepareRender",value:function(){var e=this;this._renderPlugins.forAll((function(t){t.prepareRender&&t.prepareRender(e._context.renderContext)}))}},{key:"updateAnimation",value:function(e){var t=!1;return this._renderPlugins.forAll((function(r){r.updateAnimation&&(t=r.updateAnimation(e)||t)})),t}},{key:"render",value:function(){var e=this,t=this._slots[this._context.renderContext.bindParameters.slot],r=new Array;t.filter((function(t){if(!t.canRender)return!1;if(function(e){return"prepareTechnique"in e}(t)){var n=t.prepareTechnique(e._context.renderContext);return!!n&&(r.push(n),!0)}return r.push(null),!0})).forEach((function(t,n){return t.render(e._context.renderContext,r[n])}))}},{key:"queryDepthRange",value:function(e){var t=yq;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll((function(r){if(r.queryDepthRange){var n=r.queryDepthRange(e);n&&UG(t,n,t)}})),t}},{key:"needsTransparentPass",get:function(){return this._renderPlugins.some((function(e){return e.needsTransparentPass}))}},{key:"needsHighlight",get:function(){return this._renderPlugins.some((function(e){return e.needsHighlight}))}},{key:"needsLinearDepth",get:function(){return this._renderPlugins.some((function(e){return e.needsLinearDepth}))}},{key:"needsLaserlineWithContrastControl",get:function(){var e=this._slots[dc.H.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}},{key:"renderOccludedFlags",get:function(){return this._renderPlugins.reduce((function(e,t){return e|t.renderOccludedFlags}),0)}}]),e}();var yq={near:0,far:0},gq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(dc.bF),_q=255,bq=1/_q;function xq(e){var t=new dc.o,r=t.fragment;return r.include(dc.y),r.include(dc.j),t.include(dc.bG),t.include(dc.F),t.include(dc.bA,e),r.uniforms.add([new dc.h("depthMap",(function(e){return e.linearDepthTexture})),new dc.e("inverseViewMatrix",(function(e,t){return(0,Wu.h)(Tq,(0,Wu.c)(Tq,t.camera.viewMatrix,t.camera.center))})),new dc.b("nearFar",(function(e,t){return t.camera.nearFar}))]),r.constants.add("sampleValue","float",bq),r.code.add((0,dc.n)(hl||(hl=(0,wu.Z)(["void main(void) {\nfloat depth = rgba2float(texture2D(depthMap, uv));\nif (depth == 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearDepthFromFloat(depth, nearFar);\nif (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {\ndiscard;\n}\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nvec2 uvShadow = cascadeCoordinates(i, lvpos);\nfloat depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);\nbool shadow = depthShadow < lvpos.z;\nif (!shadow) {\ndiscard;\n}\ngl_FragColor = vec4(sampleValue);\n}"])))),t}var wq,Tq=(0,hc.e)(),Cq=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:gq,shadowCastMaxSamples:_q,build:xq},Symbol.toStringTag,{value:"Module"}));!function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"}(wq||(wq={}));var Sq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).visualization=wq.Gradient,e.bandsEnabled=!1,e}return(0,ku.Z)(r)}(dc.q);function Oq(e){var t=new dc.o,r=t.fragment;r.include(dc.y),r.include(dc.j),t.include(dc.bG),t.include(dc.F);var n=e.visualization,i=e.bandsEnabled;r.constants.add("inverseSampleValue","float",_q),r.uniforms.add([new dc.h("shadowCastMap",(function(e){return e.shadowCastMap})),new dc.g("sampleScale",(function(e){return e.sampleScale})),new dc.g("opacityFromElevation",(function(e){return e.opacityFromElevation})),new dc.f("uColor",(function(e){return e.color}))]);var a=n===wq.Gradient,o=n===wq.Threshold;return a&&i?r.uniforms.add(new dc.g("bandSize",(function(e){return e.bandSize}))):o&&r.uniforms.add(new dc.g("threshold",(function(e){return e.threshold}))),r.code.add((0,dc.n)(dl||(dl=(0,wu.Z)(["\n      void main(void) {\n        vec4 record = texture2D(shadowCastMap, uv);\n        float pixelSamples = record.r * inverseSampleValue;\n        if (pixelSamples < 1.0) {\n          discard;\n        }\n\n        float strength = pixelSamples * sampleScale;\n\n        ","\n\n        ","\n\n        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ",");\n      }\n    "])),o?(0,dc.n)(fl||(fl=(0,wu.Z)(["\n            if (strength <= threshold) {\n              discard;\n            }"]))):"",a&&i?(0,dc.n)(pl||(pl=(0,wu.Z)(["strength = ceil(strength / bandSize) * bandSize;"]))):"",a?(0,dc.n)(vl||(vl=(0,wu.Z)(["* strength"]))):"")),t}(0,Eu.e)([(0,dc.p)({count:wq.COUNT})],Sq.prototype,"visualization",void 0),(0,Eu.e)([(0,dc.p)()],Sq.prototype,"bandsEnabled",void 0);var Pq=Object.freeze(Object.defineProperty({__proto__:null,build:Oq},Symbol.toStringTag,{value:"Module"})),Rq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),i=t.call(this,e,n,(function(){return i.destroy()}))}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:vc.d,colorWrite:vc._,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return pc.E.TRIANGLE_STRIP}}]),r}(dc.k);Rq.shader=new dc.m(Pq,(function(){return r.e(3567).then(r.bind(r,23567))}));var Aq=(0,lc.r)(.01,0,.25,1),kq=1/512,Eq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this,{}))._techniqueRepository=e,o._rctx=n,o._shadowAccumulator=i,o._requestRender=a,o._passParameters={shadowCastMap:o._shadowCastTexture,sampleScale:0,color:Aq,threshold:.5,bandSize:.1,opacityFromElevation:1,__tagStrict:"NoParameters"},o._techniqueConfig=new Sq,o._enabled=!1,o._vao=(0,dc.u)(n),o._techniqueConfig.visualization=wq.Gradient,o}return(0,ku.Z)(r,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._stop(),this._vao=(0,Nu.G)(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}},{key:"_visualizeShadowCastTechnique",get:function(){return this._technique=this._techniqueRepository.releaseAndAcquire(Rq,this._techniqueConfig,this._technique),this._technique}},{key:"render",value:function(e){if(this._isRenderingVisualization){this._passParameters.sampleScale=1/this._computedSamples;var t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,(0,_c.n)(this._vao,"geometry"))}}},{key:"setOptions",value:function(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}},{key:"opacityFromElevation",get:function(){return this._passParameters.opacityFromElevation},set:function(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}},{key:"_isRenderingVisualization",get:function(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>kq}},{key:"_computedSamples",get:function(){return this._shadowAccumulator.computedSamples}},{key:"_shadowCastTexture",get:function(){return this._shadowAccumulator.shadowCastTexture}},{key:"_threshold",get:function(){return this._passParameters.threshold},set:function(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}},{key:"_visualization",get:function(){return this._techniqueConfig.visualization},set:function(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_bandSize",get:function(){return this._passParameters.bandSize},set:function(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}},{key:"_bandsEnabled",get:function(){return this._techniqueConfig.bandsEnabled},set:function(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_setColor",value:function(e){var t=this._passParameters.color;(0,Vu.Q)(e,t)||((0,Vu.B)(this._passParameters.color,e),this._requestRenderIfRunning())}},{key:"_setEnabled",value:function(e){e!==this._enabled&&(e?this._start():this._stop())}},{key:"_requestRenderIfRunning",value:function(){this._enabled&&this._requestRender()}},{key:"_start",value:function(){this._enabled=!0,this._requestRender()}},{key:"_stop",value:function(){this._enabled=!1,this._requestRender()}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],Eq.prototype,"opacityFromElevation",null),Eq=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Eq);var Dq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).receiveShadows=!0,e.hasWebGL2Context=!1,e}return(0,ku.Z)(r)}(dc.q);(0,Eu.e)([(0,dc.p)()],Dq.prototype,"receiveShadows",void 0),(0,Eu.e)([(0,dc.p)()],Dq.prototype,"hasWebGL2Context",void 0);var Mq,Iq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),n=t.call(this,e,new Dq,(function(){return n.destroy()}))}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ONE,pc.R.ONE,pc.R.ONE),colorWrite:vc._,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return pc.E.TRIANGLE_STRIP}}]),r}(dc.k);Iq.shader=new dc.m(Cq,(function(){return r.e(9409).then(r.bind(r,69409))}));var Lq=Mq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o,s){var l;(0,Au.Z)(this,r),(l=t.call(this,{}))._rctx=e,l._stage=i,l._prepareForShadowMapPass=a,l._renderToShadowMap=o,l._requestRender=s,l._progress=0,l._sampleCount=0,l._passParameters=new gq,l._enabledInternal=!1,l._cachedLightDirections=[],l._depthRange=BG,l._previewingCached=!1,l._handles=new Eu.X,l._cameraForcedForScreenshot=!1,l._bindParameters=new Df(new SP(e,i.viewingMode),null,null),l._bindParameters.shadowMap.enabled=!0,l._bindParameters.camera=new Jy,l._vao=(0,dc.u)(e);var u={colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE,width:0,height:0},c={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:0,height:0};l._fbo=new _c.x(e,u,c),l._accumulationRenderer=new Eq(n,e,(0,gu.Z)(l),s);var h=l._stage.resourceController.scheduler;return l._handles.add(h.registerTask(bc.I.SHADOW_ACCUMULATOR,(0,gu.Z)(l))),l._handles.add((0,Fu.l)((function(){return i.renderView}),(function(e){l._handles.remove(Mq.renderViewHandleKey),(0,Nu.t)(e)||l._handles.add(e.events.on("force-camera-for-screenshot",(function(){return l._cameraForcedForScreenshot=!0})),Mq.renderViewHandleKey)}),Fu.w)),l}return(0,ku.Z)(r,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if((0,Nu.t)(this._accumulationTechniqueCached)){var e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new Iq(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewingCached}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewingCached}},{key:"_isActive",get:function(){return this._enabledInternal&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==BG&&this._opacityFromElevation>kq}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirectionsInternal",get:function(){return this._cachedLightDirections},set:function(e){var t=this._cachedLightDirections;if(!(0,Nu.k)(t,e,Vu.a2)){var r=e.length;t.length=r,this._sampleCount=Math.min(_q,r);for(var n=0;n<r;++n){var i=e[n],a=t[n]||(0,Vu.n)();(0,Vu.r)(a,i),t[n]=a}this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"runTask",value:function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}},{key:"renderAccumulation",value:function(e,t,r,n){if(this._passParameters.linearDepthTexture=e,this._depthRange=t,this._updateCamera(r),this._bindParameters.contentCamera=n,this.notifyChange("canAccumulate"),this.isAccumulating&&this.canAccumulate){(this._previewingCached||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();for(var i=this._cameraForcedForScreenshot?this._sampleCount:Math.min(Mq.previewSamples,this._sampleCount-this._progress),a=0;a<i;++a)this._accumulateShadow();this._cameraForcedForScreenshot=!1}}},{key:"render",value:function(e){this._accumulationRenderer.render(e)}},{key:"dispose",value:function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=(0,Nu.G)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,Nu.G)(this._fbo),this._vao=(0,Nu.G)(this._vao),this._accumulationTechniqueCached=(0,Nu.F)(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}},{key:"setOptions",value:function(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}},{key:"_previewing",set:function(e){this._previewingCached!==e&&(this._previewingCached=e,this._requestRenderIfEnabled())}},{key:"_lightDirections",set:function(e){this._lightDirectionsInternal=e}},{key:"readAccumulatedShadow",value:function(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;var r=Zq;return this._fbo.readPixels(e,t,1,1,pc.P.RGBA,pc.G.UNSIGNED_BYTE,r),r[0]/this._progress}},{key:"_start",value:function(){this._progress=0,this._enabledInternal=!0}},{key:"_stop",value:function(){this._enabledInternal=!1}},{key:"_invalidate",value:function(){this._progress=0,this._requestRenderIfEnabled()}},{key:"_clear",value:function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(pc._.COLOR_BUFFER_BIT),this._progress=0}},{key:"_accumulateShadow",value:function(){var e=this._lightDirectionsInternal[this._progress];this._renderToShadowMap(this._bindParameters,e,this._depthRange),this._passParameters.origin=this._bindParameters.camera.center,this._rctx.bindFramebuffer(this._fbo);var t=this._accumulationTechnique;this._rctx.bindTechnique(t,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,(0,_c.n)(this._vao,"geometry")),this._progress++}},{key:"_updateCamera",value:function(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,Vu.$)(4e4,5e4,e.relativeElevation))}},{key:"_enabled",set:function(e){e!==this._enabledInternal&&(e?this._start():this._stop())}},{key:"_requestRenderIfEnabled",value:function(){this._enabledInternal&&this._requestRender()}},{key:"test",get:function(){var e=this;return{lightDirections:this._lightDirectionsInternal,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}}]),r}(Eu.m);Lq.previewSamples=6,Lq.renderViewHandleKey="renderView",(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_progress",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_sampleCount",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_enabledInternal",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_depthRange",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_previewingCached",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_accumulationRenderer",void 0),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_isRefining",null),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_isActive",null),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"canAccumulate",null),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_isDoneAccumulating",null),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"_opacityFromElevation",null),(0,Eu.e)([(0,Eu.y)()],Lq.prototype,"running",null),Lq=Mq=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Lq);var Zq=new Uint8Array(4),Nq=.99999,Fq=.025;function zq(e){var t=new dc.o;t.include(dc.aK,e);var r=t.fragment;return r.include(dc.y),r.include(dc.j),t.include(dc.bG),t.include(dc.F),r.uniforms.add([new dc.h("defaultDepthTex",(function(e,t){return t.shadowMap.getSnapshot(JO.Default)})),new dc.h("highlightDepthTex",(function(e,t){return t.shadowMap.getSnapshot(JO.Highlight)})),new dc.h("depthMap",(function(e,t){return t.linearDepthTexture})),new dc.h("highlightMap",(function(e,t){return t.highlightColorTexture})),new dc.f("uColor",(function(e){return e.shadowColor})),new dc.b("nearFar",(function(e,t){return t.camera.nearFar})),new dc.g("opacity",(function(e){return e.shadowOpacity})),new dc.g("occludedOpacity",(function(e){return e.occludedShadowOpacity})),new dc.g("terminationFactor",(function(e){return e.opacityElevation*e.dayNightTerminator})),new dc.c("lightingMainDirectionView",(function(e,t){return(0,Vu.z)(Vq,(0,Vu.O)(Vq,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix))})),new dc.b("texelSize",(function(e,t){return(0,Nu.r)(t.linearDepthTexture)?(0,uc.r)(Bq,1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height):cc.f})),new dc.e("inverseViewMatrix",(function(e,t){return(0,Wu.h)(Uq,(0,Wu.c)(Uq,t.camera.viewMatrix,t.camera.center))}))]),r.constants.add("unoccludedHighlightFlag","vec4",dc.bH).add("highlightedThreshold","float",Nq).add("selfShadowThreshold","float",Fq),r.code.add((0,dc.n)(ml||(ml=(0,wu.Z)(["vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {\nfloat leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);\nfloat rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);\nfloat bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);\nfloat topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);\nbool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);\nbool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);\nvec3 fragCoordHorizontal = pickLeft\n? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)\n: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);\nvec3 fragCoordVertical = pickBottom\n? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)\n: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);\nvec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);\nvec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);\nvec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));\nreturn pickLeft == pickBottom ? normal : -normal;\n}"])))),r.code.add((0,dc.n)(yl||(yl=(0,wu.Z)(["void main(void) {\nvec4 highlightInfo = texture2D(highlightMap, uv);\nfloat visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;\nif (visiblyHighlighted > highlightedThreshold) {\ndiscard;\n}\nfloat depth = rgba2float(texture2D(depthMap, uv));\nif (depth == 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearDepthFromFloat(depth, nearFar);\nif (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {\ndiscard;\n}\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nvec2 uvShadow = cascadeCoordinates(i, lvpos);\nfloat depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);\nbool shadowHighlight = depthHighlight < lvpos.z;\nif (!shadowHighlight) {\ndiscard;\n}\nfloat depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);\nbool shadowDefault = depthDefault < lvpos.z;\nvec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);\nbool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;\nfloat fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;\ngl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);\n}"])))),t}var Uq=(0,hc.e)(),Vq=(0,Vu.n)(),Bq=(0,cc.n)(),Gq=Object.freeze(Object.defineProperty({__proto__:null,build:zq},Symbol.toStringTag,{value:"Module"})),Hq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).shadowColor=(0,lc.r)(1,0,1,1),e.shadowOpacity=.2,e.occludedShadowOpacity=.1,e.opacityElevation=1,e.dayNightTerminator=1,e}return(0,ku.Z)(r)}(dc.t),jq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),n=t.call(this,e,new Dq,(function(){return n.destroy()}))}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({blending:(0,vc.l)(pc.R.SRC_ALPHA,pc.R.ONE,pc.R.ONE_MINUS_SRC_ALPHA,pc.R.ONE_MINUS_SRC_ALPHA),colorWrite:vc._,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return pc.E.TRIANGLE_STRIP}}]),r}(dc.k);jq.shader=new dc.m(Gq,(function(){return r.e(3613).then(r.bind(r,53613))}));var qq=function(){function e(t,r){(0,Au.Z)(this,e),this._rctx=t,this._viewingMode=r,this._maxOpacity=1,this._passParameters=new Hq,this._drawParameters=new dc.bF,this._vao=(0,dc.u)(this._rctx)}return(0,ku.Z)(e,[{key:"_technique",get:function(){return(0,Nu.t)(this._techniqueCached)&&(this._techniqueCached=new jq({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}},{key:"render",value:function(e,t){if(e.shadowMap.enabled&&e.linearDepthTexture&&this.isVisible){var r=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(t),this._rctx.bindTechnique(r,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,(0,_c.n)(this._vao,"geometry"))}}},{key:"gpuMemoryUsage",get:function(){var e,t;return null!==(e=null===(t=this._vao)||void 0===t?void 0:t.size)&&void 0!==e?e:0}},{key:"setDefaultOptions",value:function(e){this._passParameters=(0,Tu.Z)((0,Tu.Z)({},this._passParameters),e),this._updateMaxOpacity()}},{key:"updateParameters",value:function(e,t){this._passParameters.opacityElevation=1-(0,Vu.$)(4e4,5e4,e.relativeElevation);var r=this._viewingMode===ic.l.Global?(0,Vu.z)(Wq,e.center):(0,Vu.o)(Wq,0,0,1),n=(0,Vu.P)(r,t);this._passParameters.dayNightTerminator=(0,Vu.$)(0,1,(0,Vu.a)(30*n,0,1))}},{key:"dispose",value:function(){this._vao=(0,Nu.G)(this._vao),this._techniqueCached=(0,Nu.F)(this._techniqueCached)}},{key:"isVisible",get:function(){var e=this._passParameters,t=e.opacityElevation,r=e.dayNightTerminator;return this._maxOpacity*t*r>=.001953125}},{key:"_updateMaxOpacity",value:function(){var e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}}]),e}(),Wq=(0,Vu.n)(),Xq=(0,qu.G)(),Yq=function(){function e(){(0,Au.Z)(this,e),this._plane=(0,qu.G)()}return(0,ku.Z)(e,[{key:"isEnabled",get:function(){return!(0,qu.Y)(this.plane,Xq)}},{key:"plane",get:function(){return this._plane},set:function(e){(0,qu.X)(e||Xq,this._plane)}}]),e}(),Qq=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(dc.t);function Kq(e){e.uniforms.add(new dc.f("resolution",(function(e){return(0,Vu.C)(Jq,1/e.colorTexture.descriptor.width,1/e.colorTexture.descriptor.height,e.colorTexture.descriptor.width,e.colorTexture.descriptor.height)})))}var Jq=(0,lc.n)(),$q=8,eW=16;function tW(){var e=new dc.o,t=e.attributes,r=e.varyings,n=e.vertex,i=e.fragment;return t.add(fc.O.POSITION,"vec2"),r.add("fTexCoord","vec2"),r.add("fOffset[3]","vec4"),r.add("fPixCoord","vec2"),Kq(n),n.code.add((0,dc.n)(gl||(gl=(0,wu.Z)(["\n      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {\n        fPixCoord = texcoord * resolution.zw;\n        fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );\n        fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );\n        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( "," );\n      }\n\n      void main() {\n        fTexCoord = (position + 1.0 ) * 0.5;\n        gl_Position = vec4(position, 0, 1);\n        SMAABlendingWeightCalculationVS( fTexCoord );\n      }\n    "])),dc.n.int($q))),i.uniforms.add(new dc.h("tEdges",(function(e){return e.edges.colorTexture}))),i.uniforms.add(new dc.h("tArea",(function(e){return e.areaTexture}))),i.uniforms.add(new dc.h("tSearch",(function(e){return e.searchTexture}))),i.uniforms.add(new dc.h("tColor",(function(e){return e.colorTexture}))),Kq(i),i.code.add((0,dc.n)(_l||(_l=(0,wu.Z)(["\n      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )\n      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )\n\n      vec4 SMAASampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {\n        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);\n      }\n\n      vec2 round( vec2 x ) {\n        return sign( x ) * floor( abs( x ) + 0.5 );\n      }\n\n      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {\n        e.r = bias + e.r * scale;\n        return 255.0 * texture2D( searchTex, e, 0.0 ).r;\n      }\n\n      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 0.0, 1.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;\n          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n        }\n        texcoord.x += 0.25 * resolution.x;\n        texcoord.x += resolution.x;\n        texcoord.x += 2.0 * resolution.x;\n        texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);\n        return texcoord.x;\n      }\n\n      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 0.0, 1.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;\n          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n        }\n        texcoord.x -= 0.25 * resolution.x;\n        texcoord.x -= resolution.x;\n        texcoord.x -= 2.0 * resolution.x;\n        texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );\n        return texcoord.x;\n      }\n\n      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 1.0, 0.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;\n          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n        }\n        texcoord.y -= 0.25 * resolution.y;\n        texcoord.y -= resolution.y;\n        texcoord.y -= 2.0 * resolution.y;\n        texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );\n        return texcoord.y;\n      }\n\n      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 1.0, 0.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;\n          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n        }\n        texcoord.y += 0.25 * resolution.y;\n        texcoord.y += resolution.y;\n        texcoord.y += 2.0 * resolution.y;\n        texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );\n        return texcoord.y;\n      }\n\n      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n        vec2 texcoord = float( "," ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n        return texture2D( areaTex, texcoord, 0.0 ).rg;\n      }\n\n      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {\n        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );\n        vec2 e = texture2D( edgesTex, texcoord ).rg;\n        if ( e.g > 0.0 ) {\n          vec2 d;\n          vec2 coords;\n          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );\n          coords.y = offset[ 1 ].y;\n          d.x = coords.x;\n          float e1 = texture2D( edgesTex, coords, 0.0 ).r;\n          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );\n          d.y = coords.x;\n          d = d * resolution.z - pixcoord.x;\n          vec2 sqrt_d = sqrt( abs( d ) );\n          coords.y -= 1.0 * resolution.y;\n          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;\n          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n        }\n\n        if ( e.r > 0.0 ) {\n          vec2 d;\n          vec2 coords;\n          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );\n          coords.x = offset[ 0 ].x;\n          d.x = coords.y;\n          float e1 = texture2D( edgesTex, coords, 0.0 ).g;\n          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );\n          d.y = coords.y;\n          d = d * resolution.w - pixcoord.y;\n          vec2 sqrt_d = sqrt( abs( d ) );\n          coords.y -= 1.0 * resolution.y;\n          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;\n          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\n          // for some reason the following lines are necessary to prevent\n          // texture lookup precision issues on some Intel integrated graphics chips\n          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);\n          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);\n        }\n        return weights;\n      }\n\n      void main() {\n        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );\n      }\n    "])),dc.n.int($q),dc.n.int($q),dc.n.int($q),dc.n.int($q),dc.n.int(eW))),e}var rW=Object.freeze(Object.defineProperty({__proto__:null,build:tW},Symbol.toStringTag,{value:"Module"})),nW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);function iW(){var e=new dc.o,t=e.attributes,r=e.varyings,n=e.vertex,i=e.fragment;return t.add(fc.O.POSITION,"vec2"),r.add("fTexCoord","vec2"),r.add("fOffset[2]","vec4"),Kq(n),n.code.add((0,dc.n)(bl||(bl=(0,wu.Z)(["void SMAANeighborhoodBlendingVS( vec2 texcoord ) {\nfOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );\nfOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );\n}\nvoid main() {\nfTexCoord = (position + 1.0 ) * 0.5;\ngl_Position = vec4(position, 0, 1);\nSMAANeighborhoodBlendingVS(fTexCoord);\n}"])))),i.uniforms.add(new dc.h("tBlendWeights",(function(e){return e.blend.colorTexture}))),i.uniforms.add(new dc.h("tColor",(function(e){return e.colorTexture}))),Kq(i),i.code.add((0,dc.n)(xl||(xl=(0,wu.Z)(["vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {\nvec4 a;\na.xz = texture2D( blendTex, texcoord ).xz;\na.y = texture2D( blendTex, offset[ 1 ].zw ).g;\na.w = texture2D( blendTex, offset[ 1 ].xy ).a;\nif ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {\nreturn texture2D( colorTex, texcoord, 0.0 );\n} else {\nvec2 offset;\noffset.x = a.a > a.b ? a.a : -a.b;\noffset.y = a.g > a.r ? -a.g : a.r;\nif ( abs( offset.x ) > abs( offset.y )) {\noffset.y = 0.0;\n} else {\noffset.x = 0.0;\n}\nvec4 C = texture2D( colorTex, texcoord, 0.0 );\ntexcoord += sign( offset ) * resolution.xy;\nvec4 Cop = texture2D( colorTex, texcoord, 0.0 );\nfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\nvec4 mixed = mix(C, Cop, s);\nreturn mixed;\n}\n}\nvoid main() {\ngl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );\n}"])))),e}nW.shader=new dc.m(rW,(function(){return r.e(8712).then(r.bind(r,98712))}));var aW=Object.freeze(Object.defineProperty({__proto__:null,build:iW},Symbol.toStringTag,{value:"Module"})),oW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);oW.shader=new dc.m(aW,(function(){return r.e(5097).then(r.bind(r,66727))}));var sW=.05,lW=2;function uW(){var e=new dc.o,t=e.attributes,r=e.varyings,n=e.vertex,i=e.fragment;return t.add(fc.O.POSITION,"vec2"),Kq(n),r.add("fTexCoord","vec2"),r.add("fOffset[3]","vec4"),n.code.add((0,dc.n)(wl||(wl=(0,wu.Z)(["void EdgeDetectEdgeDetectionVS( vec2 texcoord ) {\nfOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );\nfOffset[1] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );\nfOffset[2] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );\n}\nvoid main() {\nfTexCoord = (position + 1.0) * 0.5;\ngl_Position = vec4(position, 0, 1);\nEdgeDetectEdgeDetectionVS(fTexCoord);\n}"])))),i.uniforms.add(new dc.h("tColor",(function(e){return e.colorTexture}))),i.code.add((0,dc.n)(Tl||(Tl=(0,wu.Z)(["\n    vec4 EdgeDetectColorEdgeDetectionPS(vec2 texcoord, vec4 offset[3], sampler2D colorTex) {\n      vec2 threshold = vec2( "," );\n\n      // Calculate color deltas:\n      vec4 delta;\n      vec3 C = texture2D( colorTex, texcoord ).rgb;\n\n      vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;\n      vec3 t = abs( C - Cleft );\n      delta.x = max( max( t.r, t.g ), t.b );\n\n      vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;\n      t = abs( C - Ctop );\n      delta.y = max( max( t.r, t.g ), t.b );\n\n      // We do the usual threshold:\n      vec2 edges = step( threshold, delta.xy );\n\n      // Then discard if there is no edge:\n      if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )\n          discard;\n\n      // Calculate right and bottom deltas:\n      vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;\n      t = abs( C - Cright );\n      delta.z = max( max( t.r, t.g ), t.b );\n\n      vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;\n      t = abs( C - Cbottom );\n      delta.w = max( max( t.r, t.g ), t.b );\n\n      // Calculate the maximum delta in the direct neighborhood:\n      float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );\n\n      // Calculate left-left and top-top deltas:\n      vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;\n      t = abs( C - Cleftleft );\n      delta.z = max( max( t.r, t.g ), t.b );\n\n      vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;\n      t = abs( C - Ctoptop );\n      delta.w = max( max( t.r, t.g ), t.b );\n\n      // Calculate the final maximum delta:\n      maxDelta = max( max( maxDelta, delta.z ), delta.w );\n\n      // Local contrast adaptation in action:\n      edges.xy *= step( maxDelta, float(",") * delta.xy );\n\n      return vec4( edges, 0.0, 0.0 );\n    }\n\n    void main() {\n      gl_FragColor = EdgeDetectColorEdgeDetectionPS(fTexCoord, fOffset, tColor);\n    }\n  "])),dc.n.float(sW),dc.n.float(lW))),e}var cW=Object.freeze(Object.defineProperty({__proto__:null,build:uW},Symbol.toStringTag,{value:"Module"})),hW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(),dc.E)}},{key:"initializePipeline",value:function(){return(0,vc.W)({colorWrite:vc._})}}]),r}(dc.k);hW.shader=new dc.m(cW,(function(){return r.e(2891).then(r.bind(r,52891))}));var dW=function(e){(0,Pu.Z)(n,e);var t=(0,Ru.Z)(n);function n(e,r){var i;return(0,Au.Z)(this,n),(i=t.call(this,{}))._rctx=e,i._techniqueRep=r,i._passParameters=new Qq,i._isEnabled=!1,i}return(0,ku.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._abortController=(0,Nu.l)(this._abortController),this.disable()}},{key:"_loadResources",value:function(e){var t=this;if((0,Nu.r)(this._abortController))return!1;if((0,Nu.r)(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;var n=this._abortController.signal;return r.e(9999).then(r.bind(r,59999)).then((function(e){return t._loadTextures(e,n)})).then((function(){return e()})).finally((function(){return t._abortController=null})),!1}},{key:"_loadTextures",value:function(e,t){var r=this;return(0,Eu.f)(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,pc.L.LINEAR,pc.P.RGB),this._loadTextureFromBase64(e.searchTexure,pc.L.NEAREST,pc.P.LUMINANCE)]).then((function(e){var n=(0,xu.Z)(e,2),i=n[0],a=n[1];(0,Eu.p)(t)?(i.dispose(),a.dispose(),(0,Eu.f)(t)):(r._passParameters.areaTexture=i,r._passParameters.searchTexture=a)}))}},{key:"updating",get:function(){return(0,Nu.r)(this._abortController)}},{key:"enable",value:function(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){var t=new dc.q;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(hW,t,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(nW,t,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(oW,t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=(0,dc.bI)(this._rctx),this._passParameters.edges=new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE},{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGB,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new _c.x(this._rctx,{colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.NONE},{target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,samplingMode:pc.L.LINEAR,wrapMode:pc.D.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}},{key:"disable",value:function(){this._isEnabled&&(this._vao=(0,Nu.G)(this._vao),this._passParameters.areaTexture=(0,Nu.G)(this._passParameters.areaTexture),this._passParameters.searchTexture=(0,Nu.G)(this._passParameters.searchTexture),this._passParameters.blend=(0,Nu.G)(this._passParameters.blend),this._passParameters.edges=(0,Nu.G)(this._passParameters.edges),this._isEnabled=!1)}},{key:"_validPassParameters",get:function(){return this._isEnabled?this._passParameters:null}},{key:"render",value:function(e){var t=this._validPassParameters;if(!(0,Nu.t)(t)){t.colorTexture=e;var r=this._rctx,n=r.getBoundFramebufferObject(),i=e.descriptor.width,a=e.descriptor.height;r.bindVAO(this._vao),r.setViewport(0,0,i,a),t.edges.resize(i,a),r.bindFramebuffer(t.edges),r.setClearColor(0,0,0,1),r.clear(pc._.COLOR_BUFFER_BIT),r.bindTechnique(this._edgeDetectTechnique,t,null),r.drawArrays(pc.E.TRIANGLES,0,3),t.blend.resize(i,a),r.bindFramebuffer(t.blend),r.setClearColor(0,0,1,1),r.clear(pc._.COLOR_BUFFER_BIT),r.bindTechnique(this._blendWeightsTechnique,t,null),r.drawArrays(pc.E.TRIANGLES,0,3),r.bindFramebuffer(n),r.setClearColor(0,1,0,1),r.clear(pc._.COLOR_BUFFER_BIT),r.bindTechnique(this._blurTechnique,t,null),r.drawArrays(pc.E.TRIANGLES,0,3)}}},{key:"_loadTextureFromBase64",value:function(e,t,r){var n=this;return(0,yh.t)(e).then((function(e){return new Oc.E(n._rctx,{pixelFormat:r,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.CLAMP_TO_EDGE,width:e.width,height:e.height,samplingMode:t},e)}))}}]),n}(Eu.m);(0,Eu.e)([(0,Eu.y)()],dW.prototype,"_abortController",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],dW.prototype,"updating",null),dW=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],dW);var fW=function(){function e(t){(0,Au.Z)(this,e),this._factory=t,this._originData=new Map}return(0,ku.Z)(e,[{key:"acquire",value:function(e){return this.register(this._factory.getOrigin(e))}},{key:"register",value:function(e){var t=this._originData.get(e.id)||new pW(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}},{key:"release",value:function(e){e.refCount--,0===e.refCount&&this._originData.delete(e.origin.id)}},{key:"updateViewMatrices",value:function(e){this._originData.forEach((function(t){(0,Wu.n)(t.viewMatrix,e),function(e,t){var r=e[0],n=e[1],i=e[2];t[12]+=r*t[0]+n*t[4]+i*t[8],t[13]+=r*t[1]+n*t[5]+i*t[9],t[14]+=r*t[2]+n*t[6]+i*t[10],t[14]+=r*t[3]+n*t[7]+i*t[11]}(t.origin.vec3,t.viewMatrix)}))}}]),e}(),pW=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.origin=t,this.refCount=0,this.viewMatrix=(0,hc.e)()})),vW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n){var i;return(0,Au.Z)(this,r),(i=t.call(this)).distanceFalloffFactor=e,i.transparency=n,i.transformNormalViewFromGlobal=(0,gc.e)(),i}return(0,ku.Z)(r)}(dc.bJ),mW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).transformNormalViewFromGlobal=(0,gc.e)(),e.slicePlaneLocalOrigin=(0,Vu.n)(),e.transformNormalGlobalFromModel=(0,gc.e)(),e}return(0,ku.Z)(r)}(dc.bK);function yW(e){var t=(0,dc.n)(Cl||(Cl=(0,wu.Z)(["bool isNaN( float val )\n{\nreturn ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n}"])));e.code.add(t)}var gW,_W=(0,cc.r)(.5,-4e-4);function bW(e,t){var r=e.vertex;r.include(yW),r.constants.add("depthBias","vec2",_W),r.uniforms.add(new dc.b("inverseViewport",(function(e,t){return t.inverseViewport}))),t.legacy?(r.uniforms.add(new dc.e("proj",(function(e,t){return t.camera.projectionMatrix}))),r.code.add((0,dc.n)(Sl||(Sl=(0,wu.Z)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = proj * localView * vec4(globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))):(r.uniforms.add(new dc.bL("transformNormalViewFromGlobal",(function(e){return e.transformNormalViewFromGlobal}))),r.uniforms.add(new dc.e("transformProjFromView",(function(e){return e.transformProjFromView}))),r.code.add((0,dc.n)(Ol||(Ol=(0,wu.Z)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))),r.code.add((0,dc.n)(Pl||(Pl=(0,wu.Z)(["float _calculateProjectedBiasZ(vec4 projPos) {\nfloat offsetZ = depthBias.y;\nreturn sqrt(max(projPos.z,0.0)) * offsetZ;\n}\nvec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {\nvec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);\nif (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {\nprojPos.xy += offsetXY;\n}\nprojPos.z += _calculateProjectedBiasZ(projPos);\nreturn projPos;\n}"]))))}function xW(e,t){var r=e.fragment;r.constants.add("coverageTestThreshold","float",.01),t.antialiasing?r.code.add((0,dc.n)(Rl||(Rl=(0,wu.Z)(["#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }"])))):r.code.add((0,dc.n)(Al||(Al=(0,wu.Z)(["#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }"]))))}function wW(e,t){var r=e.vertex;t.silhouette?(r.code.add((0,dc.n)(kl||(kl=(0,wu.Z)(["bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {\nfloat faceAVisible = dot(viewDir, normalA);\nfloat faceBVisible = dot(viewDir, normalB);\nreturn faceAVisible * faceBVisible < 0.0;\n}"])))),t.legacy?r.code.add((0,dc.n)(El||(El=(0,wu.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nvec3 viewNormalA = _modelToViewNormal(normalA);\nvec3 viewNormalB = _modelToViewNormal(normalB);\nvec3 viewDir = -viewPos;\nif (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"])))):r.code.add((0,dc.n)(Dl||(Dl=(0,wu.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nvec3 worldNormalA = _modelToWorldNormal(normalA);\nvec3 worldNormalB = _modelToWorldNormal(normalB);\nvec3 viewDir = -worldPos;\nif (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"]))))):r.code.add((0,dc.n)(Ml||(Ml=(0,wu.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nreturn false;\n}"]))))}function TW(e,t){var r=e.vertex;r.include(dc.y),r.uniforms.add(new dc.g("distanceFalloffFactor",(function(e){return e.distanceFalloffFactor}))),r.code.add((0,dc.n)(Il||(Il=(0,wu.Z)(["float distanceBasedPerspectiveFactor(float distance) {\nreturn clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);\n}"])))),r.uniforms.add((0,dc.bo)("componentDataTex",(function(e){return e.componentDataTexture}),t.hasWebGL2Context?dc.$.None:dc.$.InvSize)),e.attributes.add(fc.O.COMPONENTINDEX,"float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentVerticalOffsetFieldOffset","float",2),r.constants.add("componentFieldCount","float",3),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("verticalOffsetScale","float",2*vH),r.code.add((0,dc.n)(Ll||(Ll=(0,wu.Z)(["\n    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {\n      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;\n\n      vec2 textureSizeInverse = ",";\n\n      float colIndex = mod(fieldIndex, 1.0 / textureSizeInverse.x);\n      float rowIndex = floor(fieldIndex * textureSizeInverse.x);\n\n      vec2 textureCoordinates = vec2(colIndex, rowIndex) + 0.5;\n\n      return textureCoordinates;\n    }\n\n    struct ComponentData {\n      vec4 color;\n      float lineWidth;\n      float extensionLength;\n      float type;\n      float verticalOffset;\n    };\n\n    ComponentData readComponentData() {\n      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);\n      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);\n      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);\n\n      vec4 colorValue = ",";\n      vec4 otherValue = ",";\n      float verticalOffset = (rgba2float(",") - 0.5) * verticalOffsetScale;\n\n      return ComponentData(\n        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity\n        otherValue.x * (255.0 / lineWidthFractionFactor),\n        otherValue.y * 255.0 - extensionLengthOffset,\n        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;\n        verticalOffset\n      );\n    }\n  "])),(0,dc.as)(t,"componentDataTex",!0),(0,dc._)(t,"componentDataTex","colorIndex"),(0,dc._)(t,"componentDataTex","otherIndex"),(0,dc._)(t,"componentDataTex","verticalOffsetIndex"))),t.legacy?r.code.add((0,dc.n)(Zl||(Zl=(0,wu.Z)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn (model * vec4(normal, 0.0)).xyz;\n}\nvec3 _modelToViewNormal(vec3 normal) {\nreturn (localView * model * vec4(normal, 0.0)).xyz;\n}"])))):(r.uniforms.add(new dc.G("transformNormalGlobalFromModel",(function(e){return e.transformNormalGlobalFromModel}))),r.code.add((0,dc.n)(Nl||(Nl=(0,wu.Z)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn transformNormalGlobalFromModel * normal;\n}"]))))),t.silhouette?(e.attributes.add(fc.O.NORMALA,"vec3"),e.attributes.add(fc.O.NORMALB,"vec3"),r.code.add((0,dc.n)(Fl||(Fl=(0,wu.Z)(["vec3 worldNormal() {\nreturn _modelToWorldNormal(normalize(normalA + normalB));\n}"]))))):(e.attributes.add(fc.O.NORMAL,"vec3"),r.code.add((0,dc.n)(zl||(zl=(0,wu.Z)(["vec3 worldNormal() {\nreturn _modelToWorldNormal(normal);\n}"]))))),t.legacy?r.code.add((0,dc.n)(Ul||(Ul=(0,wu.Z)(["void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\nworldPos = (model * vec4(modelPos, 1.0)).xyz;\nviewPos = (localView * vec4(worldPos, 1.0)).xyz;\n}"])))):(r.include(dc.bM,t),r.include(dc.bM,t),r.uniforms.add([new dc.bL("transformViewFromCameraRelativeRS",(function(e){return e.transformViewFromCameraRelativeRS})),new dc.G("transformWorldFromModelRS",(function(e){return e.transformWorldFromModelRS})),new dc.bN("transformWorldFromModelTL",(function(e){return e.transformWorldFromModelTL})),new dc.bN("transformWorldFromModelTH",(function(e){return e.transformWorldFromModelTH})),new dc.c("transformWorldFromViewTL",(function(e){return e.transformWorldFromViewTL})),new dc.c("transformWorldFromViewTH",(function(e){return e.transformWorldFromViewTH}))]),r.code.add((0,dc.n)(Vl||(Vl=(0,wu.Z)(["\n      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\n        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;\n\n        vec3 transformCameraRelativeFromModel = dpAdd(\n          transformWorldFromModelTL,\n          transformWorldFromModelTH,\n          -transformWorldFromViewTL,\n          -transformWorldFromViewTH\n        );\n\n        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;\n\n        if (verticalOffset != 0.0) {\n          vec3 vUp = ","\n          worldPos += verticalOffset * vUp;\n        }\n\n        viewPos = transformViewFromCameraRelativeRS * worldPos;\n      }\n    "])),t.spherical?(0,dc.n)(Bl||(Bl=(0,wu.Z)(["normalize(transformWorldFromModelTL + rotatedModelPosition);"]))):(0,dc.n)(Gl||(Gl=(0,wu.Z)(["vec3(0.0, 0.0, 1.0);"])))))),r.uniforms.add(new dc.e("transformProjFromView",(function(e,t){return t.camera.projectionMatrix}))),r.code.add((0,dc.n)(Hl||(Hl=(0,wu.Z)(["vec4 projFromViewPosition(vec3 position) {\nreturn transformProjFromView * vec4(position, 1.0);\n}"])))),r.code.add((0,dc.n)(jl||(jl=(0,wu.Z)(["float calculateExtensionLength(float extensionLength, float lineLength) {\nreturn extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);\n}"]))))}function CW(e,t){var r=e.vertex;switch(t.mode){case gW.SKETCH:r.code.add((0,dc.n)(ql||(ql=(0,wu.Z)(["#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}"]))));break;case gW.MIXED:r.code.add((0,dc.n)(Wl||(Wl=(0,wu.Z)(["#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}"]))));break;case gW.SOLID:r.code.add((0,dc.n)(Xl||(Xl=(0,wu.Z)(["#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}"]))))}}function SW(e,t){var r=e.vertex;switch(e.attributes.add(fc.O.SIDENESS,"vec2"),t.mode===gW.MIXED?r.code.add((0,dc.n)(Yl||(Yl=(0,wu.Z)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\nfloat type;\n};"])))):r.code.add((0,dc.n)(Ql||(Ql=(0,wu.Z)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\n};"])))),t.mode){case gW.MIXED:r.code.add((0,dc.n)(Kl||(Kl=(0,wu.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat fType = component.type;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nif (fType <= 0.0) {\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\n}\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);\n}"]))));break;case gW.SKETCH:r.code.add((0,dc.n)(Jl||(Jl=(0,wu.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))));break;case gW.SOLID:r.code.add((0,dc.n)($l||($l=(0,wu.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))))}}function OW(e,t){var r=e.vertex;switch(e.include(SW,t),t.mode){case gW.SOLID:r.code.add((0,dc.n)(eu||(eu=(0,wu.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn 0.0;\n}"]))));break;case gW.SKETCH:r.uniforms.add(new dc.br("strokesAmplitude",(function(e){return e.strokesTexture.amplitude}))),r.code.add((0,dc.n)(tu||(tu=(0,wu.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn strokesAmplitude;\n}"]))));break;case gW.MIXED:r.uniforms.add(new dc.br("strokesAmplitude",(function(e){return e.strokesTexture.amplitude}))),r.code.add((0,dc.n)(ru||(ru=(0,wu.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nfloat type = unpackedAttributes.type;\nif (type <= 0.0) {\nreturn strokesAmplitude;\n}\nelse {\nreturn 0.0;\n}\n}"]))))}}function PW(e,t){e.include(SW,t);var r=e.vertex,n=e.fragment;switch(function(e){return e.mode===gW.SKETCH||e.mode===gW.MIXED}(t)&&(r.uniforms.add((0,dc.bo)("strokesTexture",(function(e){return e.strokesTexture.texture}),t.hasWebGL2Context?dc.$.None:dc.$.InvSize)),r.uniforms.add([new dc.br("strokesLog2Resolution",(function(e){return Math.log2(e.strokesTexture.resolution)})),new dc.br("strokeVariants",(function(e){return e.strokesTexture.variants}))]),e.varyings.add("vStrokeUV","vec2"),n.uniforms.add([new dc.bE("strokesTexture",(function(e){return e.strokesTexture.texture})),new dc.br("strokesNormalizationScale",(function(e){return e.strokesTexture.normalizationScale}))]),r.code.add((0,dc.n)(nu||(nu=(0,wu.Z)(["\n      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {\n        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;\n\n        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);\n\n        vec2 textureSizeInverse = ",";\n        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * textureSizeInverse;\n        vStrokeUV.x += variantOffset;\n      }\n    "])),(0,dc.as)(t,"strokesTexture",!0))),e.fragment.include(dc.y),n.code.add((0,dc.n)(iu||(iu=(0,wu.Z)(["float calculateLineOffsetSketch() {\nfloat offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));\nreturn (offsetNorm - 0.5) * strokesNormalizationScale;\n}\nfloat calculateLinePressureSketch() {\nreturn rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));\n}"]))))),t.mode){case gW.SOLID:r.code.add((0,dc.n)(au||(au=(0,wu.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}"])))),n.code.add((0,dc.n)(ou||(ou=(0,wu.Z)(["float calculateLineOffset() {\nreturn 0.0;\n}\nfloat calculateLinePressure() {\nreturn 1.0;\n}"]))));break;case gW.SKETCH:r.code.add((0,dc.n)(su||(su=(0,wu.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}"])))),n.code.add((0,dc.n)(lu||(lu=(0,wu.Z)(["float calculateLineOffset() {\nreturn calculateLineOffsetSketch();\n}\nfloat calculateLinePressure() {\nreturn calculateLinePressureSketch();\n}"]))));break;case gW.MIXED:e.varyings.add("vType","float"),r.code.add((0,dc.n)(uu||(uu=(0,wu.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\nvType = unpackedAttributes.type;\nif (unpackedAttributes.type <= 0.0) {\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}\n}"])))),n.code.add((0,dc.n)(cu||(cu=(0,wu.Z)(["float calculateLineOffset() {\nif (vType <= 0.0) {\nreturn calculateLineOffsetSketch();\n}\nelse {\nreturn 0.0;\n}\n}\nfloat calculateLinePressure() {\nif (vType <= 0.0) {\nreturn calculateLinePressureSketch();\n}\nelse {\nreturn 1.0;\n}\n}"]))))}}function RW(e){var t=new dc.o,r=t.vertex,n=t.fragment;return e.antialiasing&&(r.code.add((0,dc.n)(hu||(hu=(0,wu.Z)(["#define ANTIALIASING 1"])))),n.code.add((0,dc.n)(du||(du=(0,wu.Z)(["#define ANTIALIASING 1"]))))),e.legacy&&r.uniforms.add([new kW("model"),new kW("localView")]),t.include(bW,e),t.include(TW,e),t.include(OW,e),t.include(SW,e),t.include(PW,e),t.include(dc.a0,e),t.include(wW,e),t.include(xW,e),t.include(CW,e),t.include(dc.aw,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),r.uniforms.add([new dc.b("pixelToNDC",(function(e,t){return(0,uc.r)(AW,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3])})),new dc.f("viewport",(function(e,t){return t.camera.fullViewport})),new dc.g("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),t.attributes.add(fc.O.POSITION0,"vec3"),t.attributes.add(fc.O.POSITION1,"vec3"),t.attributes.add(fc.O.VARIANTOFFSET,"float"),t.attributes.add(fc.O.VARIANTSTROKE,"float"),t.attributes.add(fc.O.VARIANTEXTENSION,"float"),r.code.add((0,dc.n)(fu||(fu=(0,wu.Z)(["const float opaqueCutoff = 1.0 / 255.0;\nvoid calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {\nvec2 sideness = unpackedAttributes.sideness;\nvec2 sidenessNorm = unpackedAttributes.sidenessNorm;\nvWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;\nvec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);\nvViewPos = viewPos;\nvec4 projPosV0 = projFromViewPosition(viewPosV0);\nvec4 projPosV1 = projFromViewPosition(viewPosV1);\nvec4 projPos = projFromViewPosition(viewPos);\nvec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);\nvec2 ndcToPixel = viewport.zw * 0.5;\nvec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;\nfloat lineLengthPixels = length(screenSpaceLinePixels);\nfloat dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;\nvec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;\nvec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;\nfloat falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;\nfloat lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;\nfloat extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;\nfloat lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;\nvSizeFalloffFactor = falloffFactor;\nfloat lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;\nfloat extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;\n#ifdef ANTIALIASING\nconst float aaPaddingPixels = 1.0;\nfloat halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;\nfloat aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;\n#else\nfloat halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;\nfloat aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;\n#endif\nvec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;\nvec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;\nvec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;\nvec2 ndcOffset = (\nscreenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)\n+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC\n);\nprojPos.xy += ndcOffset * projPos.w;\nprojPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;\nprojPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));\nfloat aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;\nfloat pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;\nvPosition = vec3(\nhalfAAPaddedLineWidthAndAmplitudePixels * sideness.x,\npixelPositionAlongLine,\npixelPositionAlongLine / extendedLineLengthPixels\n);\nvRadius = lineWidthPixels * 0.5;\nvLineLengthPixels = extendedLineLengthPixels;\ndiscardShortEdges(unpackedAttributes, lineLengthPixels);\ngl_Position = projPos;\n}\nvoid main() {\nComponentData component = readComponentData();\nUnpackedAttributes unpackedAttributes = unpackAttributes(component);\nvec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;\nworldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);\nworldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);\nvColor = component.color;\nif (vColor.a < opaqueCutoff) {\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn;\n}\nif (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {\nreturn;\n}\ncalculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);\ncalculateStyleOutputs(unpackedAttributes);\n}"])))),t.fragment.code.add((0,dc.n)(pu||(pu=(0,wu.Z)(["\n    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {\n      float lineOffset = calculateLineOffset();\n      float positionX = position.x - lineOffset;\n\n      if (radius < 1.0) {\n        // Handle this specifically for subpixel sizes:\n        // 1. Compute correct coverage (note coverage is computed by\n        //    0.5 - dist, so we make sure that that will lead to correct\n        //    subpixel coverage\n        // 2. Ignore rounded caps\n        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);\n        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);\n\n        float coverage = min(coverageX, coverageY);\n\n        return vec2(0.5 - coverage, 0.0);\n      }\n      else {\n        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius\n        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);\n\n        vec2 lineToPosition = vec2(positionX, positionOnCap);\n        return vec2(length(lineToPosition) - radius, positionOnCap / radius);\n      }\n    }\n\n    void main() {\n      ","\n      float radius = vRadius * calculateLinePressure();\n\n      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);\n      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);\n\n      discardByCoverage(radius, coverage);\n      discardBySlice(vWorldPosition);\n\n      float alpha = vColor.a * coverage;\n\n      gl_FragColor = vec4(vColor.rgb, alpha);\n\n    }\n  "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":"")),t}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"}(gW||(gW={}));var AW=(0,cc.n)(),kW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,e,"mat4")}return(0,ku.Z)(r)}(dc.r),EW=Object.freeze(Object.defineProperty({__proto__:null,build:RW},Symbol.toStringTag,{value:"Module"})),DW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Fc.r.WEBGL2}},{key:"initializeProgram",value:function(e){return new dc.l(e.rctx,r.shader.get().build(this.configuration),xc.a)}},{key:"initializePipeline",value:function(e){return e.blendMinMax?(0,vc.W)({blending:(0,vc.l)(pc.R.ONE,pc.R.ONE,pc.R.ZERO,pc.R.ONE,pc.T.ADD,e.blendMinMax.MAX),depthTest:{func:pc.I.LEQUAL},colorWrite:vc._}):(0,vc.W)({depthTest:{func:pc.I.LEQUAL},depthWrite:vc.b,colorWrite:vc._})}}]),r}(dc.k);DW.shader=new dc.m(EW,(function(){return r.e(4940).then(r.bind(r,64940))}));var MW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments)).mode=gW.SOLID,e.hasSlicePlane=!1,e.silhouette=!1,e.legacy=!1,e.antialiasing=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.spherical=!1,e}return(0,ku.Z)(r)}(dc.J);(0,Eu.e)([(0,dc.p)({count:gW.COUNT})],MW.prototype,"mode",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"hasSlicePlane",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"silhouette",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"legacy",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"antialiasing",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"hasMultipassTerrain",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"cullAboveGround",void 0),(0,Eu.e)([(0,dc.p)()],MW.prototype,"spherical",void 0);var IW,LW={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},ZW={solid:gW.SOLID,sketch:gW.SKETCH,uber:gW.MIXED},NW=function(){function e(t,r,n){var i,a,o;(0,Au.Z)(this,e),this._rctx=t,this._shaderTechniqueRepository=r,this._configuration=new MW,this.refCount=0,this._renderables=new Set,this._sortedRenderables=(o={},(0,yu.Z)(o,qc.A.TRANSPARENT,(i={},(0,yu.Z)(i,qc.A.TRANSPARENT,new Eu.a6),(0,yu.Z)(i,qc.A.OPAQUE,new Eu.a6),i)),(0,yu.Z)(o,qc.A.OPAQUE,(a={},(0,yu.Z)(a,qc.A.TRANSPARENT,new Eu.a6),(0,yu.Z)(a,qc.A.OPAQUE,new Eu.a6),a)),o),this._renderablesDirty=!1,this._drawParameters=new mW,this._settings=(0,Tu.Z)((0,Tu.Z)({},LW),n),this.key=e.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);var s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:Ac.t.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=ZW[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=(0,dc.aL)(t),this._configuration.spherical=n.spherical}return(0,ku.Z)(e,[{key:"dispose",value:function(){this._technique=(0,Nu.F)(this._technique)}},{key:"addRenderable",value:function(e){this._renderables.add(e),this._renderablesDirty=!0}},{key:"removeRenderable",value:function(e){this._renderables.delete(e),this._renderablesDirty=!0}},{key:"setRenderablesDirty",value:function(){this._renderablesDirty=!0}},{key:"forEachRenderable",value:function(e,t){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[t][qc.A.TRANSPARENT].forAll(e),this._sortedRenderables[t][qc.A.OPAQUE].forAll(e)}},{key:"updateTechnique",value:function(e,t){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(DW,this._configuration,this._technique),this._technique}},{key:"bindRegularEdges",value:function(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),e,t)}},{key:"bindSilhouetteEdges",value:function(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),e,t)}},{key:"renderRegularEdges",value:function(e,t,r,n,i){this._render(e,t,t.regular.vao,r,n,i)}},{key:"renderSilhouetteEdges",value:function(e,t,r,n,i){this._render(e,t,t.silhouette.vao,r,n,i)}},{key:"_render",value:function(e,t,r,n,i,a){a>0&&(this._bindDraw(e,t,n,i),this._rctx.bindVAO(r),this._rctx.capabilities.instancing.drawArraysInstanced(pc.E.TRIANGLE_FAN,0,4,a))}},{key:"_bindDraw",value:function(e,t,r,n){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{var i=new LH(t.transform.position),a=(0,mc.o)(FW,(0,mc.u)(FW,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=i.low,this._drawParameters.transformWorldFromModelTH=i.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=a;var o=n.camera.viewInverseTransposeMatrix;(0,Vu.o)(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,n,r)}},{key:"_sortRenderables",value:function(){var e=this;this._renderablesDirty=!1,this._sortedRenderables[qc.A.TRANSPARENT][qc.A.TRANSPARENT].clear(),this._sortedRenderables[qc.A.TRANSPARENT][qc.A.OPAQUE].clear(),this._sortedRenderables[qc.A.OPAQUE][qc.A.TRANSPARENT].clear(),this._sortedRenderables[qc.A.OPAQUE][qc.A.OPAQUE].clear(),this._renderables.forEach((function(t){t.objectTransparency!==qc.A.INVISIBLE&&t.edgeTransparency!==qc.A.INVISIBLE&&e._sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)}));var t=function(e,t){return"origin"in e.transform?"origin"in t.transform?e.transform.origin.origin.id<t.transform.origin.origin.id?-1:e.transform.origin.origin.id>t.transform.origin.origin.id?1:0:1:0};this._sortedRenderables[qc.A.TRANSPARENT][qc.A.TRANSPARENT].sort(t),this._sortedRenderables[qc.A.TRANSPARENT][qc.A.OPAQUE].sort(t),this._sortedRenderables[qc.A.OPAQUE][qc.A.TRANSPARENT].sort(t),this._sortedRenderables[qc.A.OPAQUE][qc.A.OPAQUE].sort(t)}}],[{key:"getKey",value:function(e,t,r){return"edges-t:".concat(e,":").concat(t,":").concat(r)}}]),e}(),FW=(0,mh.e)(),zW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){return(0,Au.Z)(this,r),t.call(this,"EdgeProcessingWorker","extract",{extract:function(e){return[e.dataBuffer]},extractComponentsEdgeLocations:function(e){return[e.dataBuffer]},extractEdgeLocations:function(e){return[e.dataBuffer]}},e)}return(0,ku.Z)(r,[{key:"process",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n){var i;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n){e.next=2;break}return e.abrupt("return",(0,xc.f)(t));case 2:return e.next=4,this.invoke(new UW(t),r);case 4:return i=e.sent,e.abrupt("return",this._unpackOutput(i));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"extractEdgeLocations",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.invokeMethod("extractEdgeLocations",new UW(t),r);case 2:return n=e.sent,e.abrupt("return",(0,gh.D)(n));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"extractComponentsEdgeLocations",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.invokeMethod("extractComponentsEdgeLocations",new UW(t),r);case 2:return n=e.sent,e.abrupt("return",(0,gh.D)(n));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_unpackOutput",value:function(e){return{regular:{instancesData:(0,gh.D)(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:(0,gh.D)(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}]),r}(ph.h),UW=(0,ku.Z)((function e(t){(0,Au.Z)(this,e),this.dataBuffer=t.data.buffer,this.writerSettings=t.writerSettings,this.skipDeduplicate=t.skipDeduplicate,this.indices=Array.isArray(t.indices)?t.indices:t.indices.buffer,this.indicesType=Array.isArray(t.indices)?"Array":(0,Nu.O)(t.indices)?"Uint32Array":"Uint16Array",this.indicesLength=t.indicesLength}));function VW(e,t){if(!e)return null;for(var r=e.length/2,n=BW*r,i=new Array(r),a=0,o=t===IW.PRESSURE,s=0;s<e.length;s+=2){var l=(e[s]+e[s+1])/2;i[a++]=o?Math.min(n,1-(1-l)*GW):Math.min(n,l*GW)}return i}!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(IW||(IW={}));var BW=.1,GW=.5,HW=function(){function e(t,r,n,i,a){(0,Au.Z)(this,e),this.resolution=t,this.normalizationScale=r,this.amplitude=n,this.variants=i,this.texture=a}return(0,ku.Z)(e,[{key:"dispose",value:function(){this.texture=(0,Nu.G)(this.texture)}}]),e}(),jW={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function qW(e){var t,r=null,n=(0,Cu.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value,a=i.type;if(QW(i))if((0,Nu.t)(r))r=a;else if(r!==a)return"uber"}}catch(o){n.e(o)}finally{n.f()}return(0,Nu.r)(r)?r:"uber"}function WW(e){var t,r=qc.A.INVISIBLE,n=(0,Cu.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value.material;if(YW(i)){if(i.color[3]*i.opacity<1)return qc.A.TRANSPARENT;r=qc.A.OPAQUE}}}catch(a){n.e(a)}finally{n.f()}return r}function XW(e){var t,r=qc.A.INVISIBLE,n=(0,Cu.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value.material;if(YW(i)){switch(i.objectTransparency){case qc.A.TRANSPARENT:case qc.A.INVISIBLE:return qc.A.TRANSPARENT;case qc.A.OPAQUE:if(i.opacity<1)return qc.A.TRANSPARENT}r=qc.A.OPAQUE}}}catch(a){n.e(a)}finally{n.f()}return r}function YW(e){return e.size*e.color[3]*e.opacity>0}function QW(e){return e.size*e.color[3]>0}function KW(e,t,r,n){for(var i=0;i<e.length;i++){var a=e[i].index,o=t[i],s=t[i+1];if(n)for(var l=o;l<s;l++){var u=n[l];r.set(u,a)}else for(var c=o;c<s;c++)r.set(c,a)}}var JW=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._updatingHandles=new oc.c,n._perObjectData=new Map,n._perObjectDataEvictionCache=new Set,n._renderers=new Map,n._gpuMemoryUsage=0,n._workerAbort=new AbortController,n._tmpModelPosition=(0,Vu.n)(),n._localOrigins=new fW(new _P(e.renderSR)),n}return(0,ku.Z)(r,[{key:"initialize",value:function(){this._worker=new zW(this.schedule),this._componentColorManager=new jH(this.rctx,3);for(var e=xc.e.createBuffer(4),t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=_c.E.createVertex(this.rctx,pc.F.STATIC_DRAW,e.buffer)}},{key:"destroy",value:function(){var e=this;this.destroyed||(this._perObjectData.forEach((function(t){return e._discardObjectEntry(t)})),this._perObjectData.clear(),this._strokesTexture=(0,Nu.G)(this._strokesTexture),this._componentColorManager=(0,Nu.g)(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=(0,Nu.G)(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}},{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"shouldRender",value:function(){return this._renderers.size>0}},{key:"addComponentObject",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a,o,s,l){var u,c,h;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.hasObject(t)){e.next=2;break}return e.abrupt("return",this.getObjectMemoryUsage(t));case 2:return c=new eX(new Promise((function(e){return u=e})),n.center,n.radius),this._perObjectData.set(t,c),e.next=6,this._updatingHandles.addPromise(this._addComponentGeometry(r,c,i,a,o,s,l));case 6:return h=e.sent,e.abrupt("return",(this.setNeedsRender(),u(),h));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a,o,s,l){return e.apply(this,arguments)}}()},{key:"addOrUpdateObject3D",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i){var a,o,s,l,u,c,h,d;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.destroyed){e.next=2;break}return e.abrupt("return",void Eu.a.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance"));case 2:if((null===(a=this._perObjectData.get(t))||void 0===a?void 0:a.renderables.length)>0&&this._perObjectDataEvictionCache.add(a),s=t.boundingVolumeWorldSpace.bounds,l=new eX(new Promise((function(e){return o=e})),(0,Qu.g)(s),(0,Qu.T)(s)),this._perObjectData.set(t,l),u=new Array,!(n.mergeGeometries&&t.geometries.length>1&&$W(t))){e.next=11;break}u.push(this._addObjectMergedGeometries(t,l,r,n,i)),e.next=21;break;case 11:c=0;case 12:if(!(c<t.geometries.length)){e.next=21;break}if((h=t.geometryRecords[c]).material.supportsEdges){e.next=16;break}return e.abrupt("continue",18);case 16:d=t.geometries[c],u.push(this._addGeometry(t,l,d,h,r[0],n,i));case 18:c++,e.next=12;break;case 21:return e.next=23,this._updatingHandles.addPromise(Promise.all(u));case 23:this._perObjectDataEvictionCache.delete(l),this._discardObjectEntry(a),this.setNeedsRender(),o();case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_discardObjectEntry",value:function(e){var t=this;e&&(e.renderables.length&&(e.renderables.forEach((function(e){return t._removeRenderable(e)})),this.setNeedsRender()),e.loaded=null)}},{key:"hasObject",value:function(e){return this._perObjectData.has(e)}},{key:"updateAllComponentOpacities",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:if(n=e.sent,!(0,Nu.t)(n)){e.next=5;break}return e.abrupt("return");case 5:i=r instanceof Array?function(e){return r[e]}:function(){return r},n.renderables.forEach((function(e){for(var t=e.components.meta.length,r=0;r<t;r++){var n=i(r),o=e.components.meta[r],s=o.index;o.material.opacity=n,e.components.buffer.textureBuffer.setDataElement(s,1,3,255*n)}a._updateTransparency(e)})),this.setNeedsRender();case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getObjectMemoryUsage",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getObjectEntry(t);case 2:return r=e.sent,e.abrupt("return",(0,Nu.r)(r)?r.renderables.reduce((function(e,t){return e+t.statistics.gpuMemoryUsage}),0):0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateAllComponentMaterials",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i){var a,o,s,l,u,c=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t instanceof tS,o=!!n.hasSlicePlane,s=qW(r),l=NW.getKey(s,o,a),e.next=6,this._updatingHandles.addPromise(this._getObjectEntry(t));case 6:u=e.sent,(0,Nu.t)(u)||(u.renderables.forEach((function(e){if(l!==e.rendererKey){var t=c._renderers.get(e.rendererKey),n=c._acquireRenderer(s,o,a);t.removeRenderable(e),--t.refCount,e.rendererKey=l,n.addRenderable(e)}for(var u=0;u<r.length;u++)e.components.meta[u].material=r[u];i&&c._updateComponentBuffer(e.components),c._updateTransparency(e)})),this.setNeedsRender());case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"updateAllVerticalOffsets",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:n=e.sent,(0,Nu.t)(n)||(n.renderables.forEach((function(e){for(var t=e.components.meta,n=0;n<t.length;n++){var a;e.components.meta[n].verticalOffset=null!==(a=null===r||void 0===r?void 0:r[n])&&void 0!==a?a:0}i._updateComponentBuffer(e.components)})),this.setNeedsRender());case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateObjectVisibility",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:n=e.sent,(0,Nu.r)(n)&&(n.renderables.forEach((function(e){return e.visible=r})),this.setNeedsRender());case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeObject",value:function(e){var t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}},{key:"_getObjectEntry",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._perObjectData.get(t)){e.next=3;break}throw"no object";case 3:return e.next=5,r.loaded;case 5:return e.abrupt("return",null==r.loaded?null:r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"render",value:function(e,t){var r=this;if(!(0,Nu.t)(this._componentColorManager)){this._localOrigins.updateViewMatrices(e.camera.viewMatrix);var n=e.camera.viewInverseTransposeMatrix,i=(0,Vu.n)(),a=new LH,o=0,s=0;if(this._renderers.forEach((function(n){if(0===n.refCount)r._renderers.delete(n.key),n.dispose();else{var i=!0,a=!0;n.forEachRenderable((function(t){t.visible&&(o+=t.statistics.averageEdgeLength,s++,i&&t.regular&&(n.updateTechnique(e,!1),i=!1),a&&t.silhouette&&(n.updateTechnique(e,!0),a=!1))}),t)}})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0!==s){var l=new vW(40*o/s,t);(0,Vu.o)(i,n[3],n[7],n[11]),a.set(i),(0,Vu.r)(l.transformWorldFromViewTH,a.high),(0,Vu.r)(l.transformWorldFromViewTL,a.low),(0,mc.a)(l.transformViewFromCameraRelativeRS,e.camera.viewMatrix),(0,mc.o)(uX,l.transformViewFromCameraRelativeRS),(0,mc.u)(l.transformNormalViewFromGlobal,uX),l.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((function(t){r._renderRegularEdges(t,e,l),r._renderSilhouetteEdges(t,e,l)}))}}}},{key:"_updateTransparency",value:function(e){var t=WW(e.components.meta),r=XW(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this._renderers.get(e.rendererKey).setRenderablesDirty())}},{key:"_computeModelTransformWithLocalOrigin",value:function(e,t,r){e.getCombinedStaticTransformation(t,r);var n=(0,Nu.r)(t.origin)?this._localOrigins.register(t.origin):this._localOrigins.acquire((0,Vu.o)(this._tmpModelPosition,r[12],r[13],r[14]));return t.origin=n.origin,function(e,t){var r=-e[0],n=-e[1],i=-e[2],a=t[3],o=t[7],s=t[11],l=t[15];t[0]+=a*r,t[1]+=a*n,t[2]+=a*i,t[4]+=o*r,t[5]+=o*n,t[6]+=o*i,t[8]+=s*r,t[9]+=s*n,t[10]+=s*i,t[12]+=l*r,t[13]+=l*n,t[14]+=l*i}(n.origin.vec3,r),n}},{key:"_updateComponentBuffer",value:function(e){for(var t=e.meta,r=e.buffer,n=new Uint8Array(4),i=0;i<t.length;i++){var a=t[i].material,o=t[i].index,s=(0,Vu.a)(Math.round(8*a.size),0,255),l=(0,Vu.a)(a.extensionLength,-128,127)+128,u="solid"===a.type?xc.u.SOLID:xc.u.SKETCH,c=255*a.opacity,h=a.color,d=255*h[0],f=255*h[1],p=255*h[2],v=255*h[3];r.textureBuffer.setData(o,0,d,f,p,v),r.textureBuffer.setData(o,1,s,l,u,c),mH(t[i].verticalOffset,n),r.textureBuffer.setData(o,2,n[0],n[1],n[2],n[3])}}},{key:"_createComponentBuffers",value:function(e){if((0,Nu.t)(this._componentColorManager))return null;for(var t=new Array,r=this._componentColorManager.getBuffer(e.length),n=0;n<e.length;n++){var i=e[n],a=r.acquireIndex();t.push({index:a,verticalOffset:0,material:i})}var o=new tX(r,t);return this._updateComponentBuffer(o),o}},{key:"_extractEdges",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:i.length;return this._worker.process({data:t,indices:i,indicesLength:a,writerSettings:e,skipDeduplicate:r},this._workerAbort.signal,n)}},{key:"_createRenderable",value:function(e,t,r,n,i){var a=(0,Nu.r)(this._verticesBufferObject)&&e.regular.lodInfo.lengths.length>0?new rX(new dc.N(this.rctx,xc.a,{vertices:xc.T,instances:xc.d.glLayout},{vertices:this._verticesBufferObject,instances:_c.E.createVertex(this.rctx,pc.F.STATIC_DRAW,e.regular.instancesData.buffer)}),e.regular.lodInfo):null,o=(0,Nu.r)(this._verticesBufferObject)&&e.silhouette.lodInfo.lengths.length>0?new rX(new dc.N(this.rctx,xc.a,{vertices:xc.T,instances:xc.w.glLayout},{vertices:this._verticesBufferObject,instances:_c.E.createVertex(this.rctx,pc.F.STATIC_DRAW,e.silhouette.instancesData.buffer)}),e.silhouette.lodInfo):null,s=((0,Nu.r)(a)?a.vao.size:0)+((0,Nu.r)(o)?o.vao.size:0);return new iX(a,o,{gpuMemoryUsage:s,externalMemoryUsage:i,averageEdgeLength:e.averageEdgeLength},r,WW(t.meta),XW(t.meta),t,n)}},{key:"_addGeometry",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a,o,s){var l,u,c,h,d;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l=n.vertexAttributes.get(fc.O.POSITION),u=n.indices.get(fc.O.POSITION),c=(0,hc.e)(),h=this._computeModelTransformWithLocalOrigin(t,i,c),d=new lX(l,u,c,h),e.abrupt("return",this._addPositionData(r,d,n.edgeIndicesLength,a,o,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a,o,s){return e.apply(this,arguments)}}()},{key:"_addPositionData",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u,c,h,d,f,p,v,m,y,g=arguments;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=g.length>5&&void 0!==g[5]&&g[5],null!=t.loaded){e.next=3;break}return e.abrupt("return");case 3:if(s=this._createComponentBuffers([i]),!((0,Nu.t)(s)||n<=0)){e.next=6;break}return e.abrupt("return");case 6:for(l=this._acquireRenderer(i.type,!!a.hasSlicePlane,!0),u=r.modelTransform,c=r.origin,h=r.indices,d=r.position,f=d.data.length/d.size,p=xc.A.createBuffer(f),v=0;v<f;v++)p.position.set(v,0,d.data[v*d.size+0]),p.position.set(v,1,d.data[v*d.size+1]),p.position.set(v,2,d.data[v*d.size+2]);return KW(s.meta,[0,p.componentIndex.count],p.componentIndex),e.next=11,this._updatingHandles.addPromise(this._extractEdges(l.writerSettings,p,!1,o,h,n));case 11:if(m=e.sent,null!=t.loaded){e.next=14;break}return e.abrupt("return");case 14:y=this._createRenderable(m,s,new nX(u,c),l.key,!1),t.renderables.push(y),l.addRenderable(y),this._gpuMemoryUsage+=y.statistics.gpuMemoryUsage;case 16:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_addComponentGeometry",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a,o,s){var l,u,c,h,d,f,p;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r.loaded){e.next=2;break}return e.abrupt("return",0);case 2:if(l=this._createComponentBuffers(o),!(0,Nu.t)(l)){e.next=5;break}return e.abrupt("return",0);case 5:return u=qW(o),c=this._acquireRenderer(u,s.hasSlicePlane||!1,!1),h=xc.A.createBuffer(n.count),(0,Kc.e)(h.position,n),KW(l.meta,a,h.componentIndex,i),!0,d=c.writerSettings,e.next=11,this._updatingHandles.addPromise(this._extractEdges(d,h,true,!1,i));case 11:if(f=e.sent,null!=r.loaded){e.next=14;break}return e.abrupt("return",0);case 14:return p=this._createRenderable(f,l,t,c.key,!0),e.abrupt("return",(r.renderables.push(p),c.addRenderable(p),p.statistics.gpuMemoryUsage));case 16:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a,o,s){return e.apply(this,arguments)}}()},{key:"_addObjectMergedGeometries",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r,n,i,a){var o,s,l,u,c,h,d,f,p,v,m,y,g,_,b,x,w,T,C,S,O,P,R,A;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=new Map,s=0,l=null,u=0,c=0;case 3:if(!(c<t.geometries.length)){e.next=13;break}if(h=t.geometries[c],(d=t.geometryRecords[c]).material.supportsEdges){e.next=7;break}return e.abrupt("continue",10);case 7:!l&&d.origin&&(l=d),f=h.vertexAttributes.get(fc.O.POSITION),u+=f.data.length/f.size,s+=h.edgeIndicesLength;case 10:c++,e.next=3;break;case 13:p=u>=65536?Uint32Array:Uint16Array,v=s?new p(s):null,m=[],y=0,g=0;case 16:if(!(g<t.geometries.length)){e.next=27;break}if(_=t.geometries[g],t.geometryRecords[g].material.supportsEdges){e.next=20;break}return e.abrupt("continue",24);case 20:if(b=_.vertexAttributes.get(fc.O.POSITION),x=_.indices.get(fc.O.POSITION),null==(w=o.get(b.data))){for(w=m.length/3,T=0;T<b.data.length;T+=b.size)m.push(b.data[T+0]),m.push(b.data[T+1]),m.push(b.data[T+2]);o.set(b.data,w)}if(x)for(C=0;C<_.edgeIndicesLength;C++)v[y++]=w+x[C];case 24:g++,e.next=16;break;case 27:for(S=l||t.geometryRecords[0],O=(0,hc.e)(),P=this._computeModelTransformWithLocalOrigin(t,S,O),R=0;R<t.geometryRecords.length;R++)t.geometryRecords[R].origin=P.origin;return A=new lX({data:m,size:3},v,O,P),e.next=32,this._updatingHandles.addPromise(this._addPositionData(r,A,v.length,n[0],i,a));case 32:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_acquireRenderer",value:function(e,t,r){var n=NW.getKey(e,t,r),i=this._renderers.get(n);return(0,Nu.t)(this._strokesTexture)&&(this._strokesTexture=function(e){var t,r=jW.resolution,n=r/2,i=new Uint8Array(4*r*r),a=4*r*n,o=jW.amplitude,s=2*o,l=4*r,u=Math.log2(r)+1,c=jW.strokes.length,h=(u-1)*c*l,d=(0,Cu.Z)(jW.strokes);try{for(d.s();!(t=d.n()).done;){for(var f=t.value,p=f.distance,v=f.pressure,m=p,y=v,g=h,_=0;_<u;_++){0!==_&&(m=VW(m,IW.DISTANCE),y=VW(y,IW.PRESSURE));for(var b=0;b<jW.resolution;b++){var x=.5+(m?m[b%m.length]/s:0),w=y?y[b%y.length]:1;(0,Nc.o)(x,i,g),(0,Nc.o)(w,i,g+a),g+=4}g-=l*(c+1)}h+=l}}catch(C){d.e(C)}finally{d.f()}var T=new Oc.E(e,{pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:pc.L.LINEAR,width:r,height:r,wrapMode:pc.D.REPEAT},i);return new HW(r,s,o,c,T)}(this.rctx)),i||(i=new NW(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===ic.l.Global}),this._renderers.set(n,i)),++i.refCount,i}},{key:"_removeRenderable",value:function(e){!function(e){(0,Nu.r)(e.regular)&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),(0,Nu.r)(e.silhouette)&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}(e);var t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;var r,n=(0,Cu.Z)(e.components.meta);try{for(n.s();!(r=n.n()).done;){var i=r.value;e.components.buffer.releaseIndex(i.index)}}catch(a){n.e(a)}finally{n.f()}}}},{key:"_updateObjectCameraDistances",value:function(e){var t=e.camera.eye,r=e.camera.viewForward,n=(0,Vu.n)(),i=function(e){(0,Vu.a0)(n,e.center,t);var i=(0,Vu.P)(n,r),a=e.radius,o=i<-a?1/0:i<a?0:i-a;e.renderables.forEach((function(e){return e.distanceToCamera=o}))};this._perObjectData.forEach(i),this._perObjectDataEvictionCache.forEach(i)}},{key:"_renderRegularEdges",value:function(e,t,r){var n=e.bindRegularEdges(r,t),i=r.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((function(i){if(aX(i)&&i.visible){var o=sX(i.regular.lod.lengths,i.distanceToCamera,a);e.renderRegularEdges(n,i,r,t,o)}}),i)}},{key:"_renderSilhouetteEdges",value:function(e,t,r){var n=e.bindSilhouetteEdges(r,t),i=r.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((function(i){if(oX(i)&&i.visible){var o=sX(i.silhouette.lod.lengths,i.distanceToCamera,a);e.renderSilhouetteEdges(n,i,r,t,o)}}),i)}},{key:"test",get:function(){var e=this;return{hasRenderedPrimitives:function(t){var r=!1,n=t.perScreenPixelRatio,i=function(e,t){return e.forEachRenderable((function(e){e.visible&&!r&&(aX(e)&&(r=sX(e.regular.lod.lengths,e.distanceToCamera,n)>0),!r&&oX(e)&&(r=sX(e.silhouette.lod.lengths,e.distanceToCamera,n)>0))}),t)};return e._renderers.forEach((function(e){r||(i(e,qc.A.OPAQUE),i(e,qc.A.TRANSPARENT))})),r}}}}]),r}(Eu.m);function $W(e){for(var t=null,r=null,n=0;n<e.geometries.length;n++){var i=e.geometryRecords[n];if(i.material.supportsEdges){var a;if(t){if(!(0,Nu.k)(t,i.transformation))return!1}else t=i.transformation;if(!r&&(0,Nu.r)(i.origin))r=i;else if((0,Nu.r)(null===(a=r)||void 0===a?void 0:a.origin)&&(0,Nu.r)(i.origin)&&r.origin.id!==i.origin.id)return!1}}return!0}(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"rctx",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"renderSR",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"viewingMode",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"techniqueRepository",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"setNeedsRender",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],JW.prototype,"schedule",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],JW.prototype,"_updatingHandles",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],JW.prototype,"updating",null),JW=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],JW);var eX=(0,ku.Z)((function e(t,r,n){var i=this;(0,Au.Z)(this,e),this.center=r,this.radius=n,this.renderables=new Array,this.loaded=t,this.loaded.then((function(){null!=i.loaded&&(i.loaded=!0)}))})),tX=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.buffer=t,this.meta=r})),rX=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.vao=t,this.lod=r})),nX=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.modelMatrix=t,this.origin=r})),iX=(0,ku.Z)((function e(t,r,n,i,a,o,s,l){(0,Au.Z)(this,e),this.regular=t,this.silhouette=r,this.statistics=n,this.transform=i,this.edgeTransparency=a,this.objectTransparency=o,this.components=s,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}));function aX(e){return(0,Nu.r)(e.regular)}function oX(e){return(0,Nu.r)(e.silhouette)}function sX(e,t,r){var n=t*r,i=(0,Nu.P)(e,n,!0);return-1===i?n<e[0]?e.length:0:e.length-i}var lX=(0,ku.Z)((function e(t,r,n,i){(0,Au.Z)(this,e),this.position=t,this.indices=r,this.modelTransform=n,this.origin=i})),uX=(0,gc.e)();var cX,hX=function(){function e(t,r){var n=this;(0,Au.Z)(this,e),this._timer=t,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,r.forEach((function(e){var t=n._timer.createQuery(),r=n._timer.createQuery();n._queryPool.push(t,r),n._queryResults.set(e,null)}))}return(0,ku.Z)(e,[{key:"start",value:function(){_h.E||(this._currentQuery=this._queryPool.pop(),(0,Nu.t)(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}},{key:"stop",value:function(e){if(this._timer.disjoint()||(0,Nu.t)(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();var t=this._queryResults.get(e);if((0,Nu.t)(t))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;var r=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}},{key:"abort",value:function(){(0,Nu.r)(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}},{key:"dispose",value:function(){var e=this;(0,Nu.r)(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((function(t){e._timer.deleteQuery(t)})),this._queryResults.forEach((function(t){(0,Nu.t)(t)||e._timer.deleteQuery(t)}))}}]),e}();!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.LINEAR_DEPTH="linear depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.NORMALS="normals",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.SSAO="SSAO",e.OPAQUE="opaque",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.ENVIRONMENT="environment",e.LASER_LINE="laser line",e.OCCLUDED="occluded",e.ANTIALIASING="antialiasing",e.HIGHLIGHTS="highlights",e.HUD_OCCLUDED="HUD occluded",e.HUD_NOT_OCCLUDED="HUD not occluded",e.FINISH="finish"}(cX||(cX={}));var dX,fX="Total",pX=function(){function e(t){(0,Au.Z)(this,e),this._rctx=t,this._startTimeStampCPU=(0,Eu.aj)(0),this._lastTimeStampCPU=(0,Eu.aj)(0),this._totalCPUTime=new Eu.an(fX),this._cpuTimeSamplers=new Map(Object.values(cX).map((function(e){return[e,new Eu.an(e)]}))),this._enableGPUTimer=0,this._totalGPUTime=new Eu.an("GPU"),this._gpuTimeSamplers=new Map(Object.values(cX).map((function(e){return[e,new Eu.an(e)]}))),this._totalTime=(0,Eu.aj)(0),this._totalFrameCount=0}return(0,ku.Z)(e,[{key:"totalCPUTimeSampler",get:function(){return this._totalCPUTime}},{key:"cpuTimeSamplers",get:function(){return Array.from(this._cpuTimeSamplers.values())}},{key:"totalGPUTimeSampler",get:function(){return this._totalGPUTime}},{key:"gpuTimeSamplers",get:function(){return Array.from(this._gpuTimeSamplers.values())}},{key:"gpuSamplingEnabled",get:function(){return(0,Nu.r)(this._gpuTimerPool)}},{key:"totalTime",get:function(){return this._totalTime}},{key:"totalFrameCount",get:function(){return this._totalFrameCount}},{key:"elapsedTime",get:function(){return(0,Eu.aj)(performance.now()-this._startTimeStampCPU)}},{key:"enableGPUPerformanceInfo",value:function(){var e=this;if((0,Nu.t)(this._gpuTimerPool)){var t=[].concat((0,mu.Z)(Object.values(cX)),[fX]);this._gpuTimerPool=function(e,t){var r=e.capabilities.disjointTimerQuery;return(0,Nu.t)(r)?null:new hX(r,t)}(this._rctx,t)}return(0,Nu.t)(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:function(){}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:(0,Eu.av)((function(){--e._enableGPUTimer,0===e._enableGPUTimer&&(e._gpuTimerPool=(0,Nu.G)(e._gpuTimerPool))}))})}},{key:"startFrame",value:function(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,Eu.aj)(performance.now()),(0,Nu.r)(this._gpuTimerPool)&&this._gpuTimerPool.start()}},{key:"advance",value:function(e){var t=(0,Eu.aj)(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,(0,Nu.r)(this._gpuTimerPool)){var r=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(r),this._gpuTimerPool.start()}}},{key:"finishFrame",value:function(){if((0,Nu.r)(this._gpuTimerPool)){var e=this._gpuTimerPool.stop(cX.FINISH);this._gpuTimeSamplers.get(cX.FINISH).record(e)}var t=(0,Eu.aj)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,Eu.aj)(this._totalTime+t),this._totalCPUTime.record(t),(0,Nu.r)(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((function(e,t){return e+(t.last||0)}),0)),++this._totalFrameCount}}]),e}(),vX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a,o,s,l,u,c){var h;return(0,Au.Z)(this,r),(h=t.call(this,{}))._materialRepository=e,h._shaderTechniqueRepository=i,h._rctx=a,h._compositingHelper=o,h._magnifierHelper=s,h._requestRender=l,h._stage=c,h._materialRenderers=new Map,h._needsTransparentPass=!1,h._hasHUDElements=!1,h._hasHighlights=!1,h._hasWater=!1,h._hasOverlayWater=!1,h._renderOverlay=function(e){},h._content=new Map,h._isRendering=!1,h._fallbackDepthStencilTexture=null,h._sliceHelper=new Yq,h._antialiasing=!0,h._oitEnabled=!1,h._multipassTerrain=!0,h._terrainRenderingEnabled=!0,h._terrainTransparency=eG.Opaque,h._waterReflectionEnabled=!1,h._hasAnimations=!1,h._animationTimestep=Bj,h._handles=new Eu.X,h._renderHiddenTransparentEdges=function(){},h._oitUsed=!1,h._smaaPass=new dW(h._rctx,i),h._oitEnabled=h._hasOITSupport,h._requestRender(),h._offscreenRendering=new fq(h._rctx,h._compositingHelper),h.performanceInfo=new pX(h._rctx),h._shadowMap=new SP(h._rctx,c.viewingMode),h._ssaoHelper=new dc.aQ(i,h._rctx,(function(){return h._requestRender()})),h._highlight=new uq(i,h._rctx),h._shadowHighlight=new qq(h._rctx,c.viewingMode),h._shadowAccumulator=new Lq(h._rctx,i,c,(function(e){var t=h.shadowsEnabled;h._shadowMap.enabled=!0,h._prepare(e.camera,e.contentCamera),h._renderPlugins.prepareRender(),h._shadowMap.enabled=t}),(function(e,t,r){e.shadowMap.start(e.camera,t,r),h._renderShadowCascades(dc.O.Shadow,e.shadowMap),e.camera.setGLViewport(h._rctx),h._prepare(e.camera,e.contentCamera)}),(function(){return h._requestRender()})),h._renderContext=new wP(h._rctx,h._offscreenRendering,h._shadowMap,h._ssaoHelper,h._sliceHelper),h._renderPlugins=new mq({renderContext:h._renderContext,shaderTechniqueRepository:i,textureRep:n,materialRep:h._materialRepository,requestRender:h._requestRender,schedule:u}),h.renderPassManager=new qj(h._rctx,h._shaderTechniqueRepository),h._renderPlugins.add(h.renderPassManager.slots(),h.renderPassManager),h._handles.add([(0,Fu.l)((function(){return h._stage.state.camera}),(function(){return h._requestRender()}),Fu.w),(0,Fu.l)((function(){return Ac.t.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES}),(function(e){h._renderHiddenTransparentEdges=e?function(){return h._renderEdges(qc.A.TRANSPARENT)}:function(){},h._requestRender()}),Fu.h)]),h}return(0,ku.Z)(r,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"hasWaterReflection",get:function(){return this.hasWater&&this._waterReflectionEnabled}},{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._edgeView=(0,Nu.g)(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=(0,Nu.G)(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),dc.bO.prune(),this._content.clear()}},{key:"disposeOffscreenBuffers",value:function(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||(0,Nu.r)(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"ensureEdgeView",value:function(){var e=this;return(0,Nu.t)(this._edgeView)&&(this._edgeView=new JW({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:function(){return e._requestRender()},schedule:function(t){return e._stage.resourceController.schedule(t)}}),this._handles.add((0,Fu.l)((function(){return(0,Nu.n)(e._edgeView,(function(e){return e.updating}))}),(function(){return e._requestRender()}),Fu.U)),this._requestRender()),this._edgeView}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return(0,Wu.C)(this._bindParameters.ssr.reprojectionMatrix,hc.o)}},{key:"_reprojectionMatrix",set:function(e){(0,Nu.Q)(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){var e;return!(null===(e=this._shadowMap)||void 0===e||!e.enabled)}},{key:"setRenderParameters",value:function(e){var t=this._shadowMap,r=this._ssaoHelper,n=this._bindParameters;if(void 0!==e.screenSpaceReflectionsEnabled&&n.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(n.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&t.enabled!==e.shadowMap&&(t.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),(0,Nu.r)(e.environment)){(0,Nu.r)(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&r.enabled!==e.environment.lighting.ambientOcclusionEnabled&&(r.enabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());var i="virtual"!==e.environment.lighting.type;n.enableFillLights!==i&&(n.enableFillLights=i,this._requestRender())}e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasing!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=(0,Nu.e)(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlendWorking}},{key:"modify",value:function(e){var t=this;this._isRendering&&console.warn("Renderer.modify called while rendering");var r=e.adds,n=e.removes,i=e.updates;if(0!==r.length||0!==n.length||0!==i.length){n.forAll((function(e){var r=e.id;return t._content.delete(r)})),r.forAll((function(e){return t._content.set(e.id,e)}));var a=cR(e),o=!1;a.forEach((function(e,r){var n=t._materialRenderers.get(r);if(!n){if(!(e.adds.length>0))return;n=new WR(t._rctx,t._materialRepository,r),t._materialRenderers.set(r,n)}n.modify(e),n.isEmpty&&(o=!0)})),o&&this._materialRenderers.forEach((function(e,r){e.isEmpty&&(t._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=(0,Eu.a9)(this._materialRenderers,(function(e){return e.hasHighlights})),this._bindParameters.hasOccludees=(0,Eu.a9)(this._materialRenderers,(function(e){return e.hasOccludees})),this._hasWater=(0,Eu.a9)(this._materialRenderers,(function(e){return e.hasWater})),this._hasHUDElements=(0,Eu.a9)(this._materialRenderers,(function(e){return e.requiresSlot(dc.H.LINE_CALLOUTS_HUD_DEPTH,dc.O.Color)||e.requiresSlot(dc.H.HUD_MATERIAL,dc.O.Color)||e.requiresSlot(dc.H.LABEL_MATERIAL,dc.O.Color)})),this._requestRender()}}},{key:"updateAnimation",value:function(e){var t=this;return this._hasAnimations=!1,this._materialRenderers.forEach((function(r){return t._hasAnimations=r.updateAnimation(e)||t._hasAnimations})),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}},{key:"animationTimestep",get:function(){return this._animationTimestep}},{key:"render",value:function(e,t,r,n,i){var a=this;this._isRendering=!0;var o=r.camera,s=r.contentCamera;this._renderContext.time=i,this.performanceInfo.startFrame(),this._renderOverlay(i),this.performanceInfo.advance(cX.OVERLAY),this._bindParameters.transparencyPassType=vc.o.NONE;var l=this._offscreenRendering;l.setupRenderTarget(this.hasWaterReflection);var u=(0,qu.G)(this._sliceHelper.plane);n===vc.D.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),o.setGLViewport(this._rctx),this._prepare(o,s),this._renderPlugins.prepareRender(),this.performanceInfo.advance(cX.PREPARE);var c=this._computeDepthRange(o);this._renderShadowMap(e,o,this._bindParameters.lighting.mainLight.direction,c),this.performanceInfo.advance(cX.SHADOW_MAP),l.initializeFrame(o),this._ensureBindParameters(o,s),this._renderLinearDepth(),this.performanceInfo.advance(cX.LINEAR_DEPTH),this._accumulateShadows(c,o,s),this.performanceInfo.advance(cX.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(cX.NORMALS),this._ensureBindParametersSSR(),this._renderSSAO(),this.performanceInfo.advance(cX.SSAO),this._renderContext.output=dc.O.Color,l.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(cX.OPAQUE);var h=this._terrainRenderingEnabled&&this._terrainTransparency!==eG.Opaque,d=this._multipassTerrain&&h;this._renderTerrainLinearDepth(d),this._setMultipassEnabled(d),this._setTerrainCulling(d),this._renderEdges(qc.A.OPAQUE),this.performanceInfo.advance(cX.OPAQUE_EDGES),this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth),this._renderSlot(dc.H.VOXEL),this.performanceInfo.advance(cX.VOXEL),this._renderHiddenTransparentEdges();var f=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;f&&(this._oitEnabled?this._renderOrderIndependentTransparency((function(){return a._renderTransparentGeometry()}),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(cX.TRANSPARENT),this._renderGeometryLinearDepth(d);var p=this._renderHUDVisibility(this._multipassTerrain&&h);d||this._renderInternalSlot(dc.H.LINE_CALLOUTS),this.performanceInfo.advance(cX.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(t),this.performanceInfo.advance(cX.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(qc.A.TRANSPARENT,d),this.performanceInfo.advance(cX.TRANSPARENT_EDGES),this._renderTransparentTerrain(),h&&p&&(d?this._renderLineCallouts(Lx.Occluded):l.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(Lx.Occluded,l.framebuffer),this.performanceInfo.advance(cX.HUD_OCCLUDED)),this.performanceInfo.advance(cX.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),h&&(l.compositeTransparentTerrainOntoMain(this._bindParameters),d&&(this._renderEdges(qc.A.OPAQUE),this.performanceInfo.advance(cX.OPAQUE_EDGES),f&&(this._oitEnabled?this._renderOrderIndependentTransparency((function(){return a._renderTransparentGeometry()}),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(cX.TRANSPARENT),this._renderEdges(qc.A.TRANSPARENT),this.performanceInfo.advance(cX.TRANSPARENT_EDGES))),d&&this._renderLineCallouts(Lx.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),l.renderToTargets((function(){a._renderInternalSlot(dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),a._renderSlot(dc.H.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),a._renderSlot(dc.H.LASERLINES)}),l.currentColorTarget,l.mainDepth),this.performanceInfo.advance(cX.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&l.renderTmpAndCompositeToMain((function(){return a._renderSlot(dc.H.LASERLINES_CONTRAST_CONTROL)}),this._bindParameters,tj.PremultipliedAlpha),this.performanceInfo.advance(cX.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(cX.OCCLUDED);var v=n===vc.D.ON&&this._magnifierHelper.enabled,m=v&&(0,Nu.t)(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(m);var y=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(y)&&(0,Nu.r)(y)&&this._compositingHelper.composite(this._bindParameters,y,tj.None),this.performanceInfo.advance(cX.ANTIALIASING),this._renderHUD(Lx.NotOccluded,m),this.performanceInfo.advance(cX.HUD_NOT_OCCLUDED),this._renderHighlights(m,this._bindParameters),this.performanceInfo.advance(cX.HIGHLIGHTS),v&&this._magnifierHelper.render(this._rctx,this._bindParameters),m!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,tj.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=u,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}},{key:"_renderObjectAndLayerIdColor",value:function(e){var t=this;(0,Nu.r)(e)&&(0,Nu.h)("enable-feature:objectAndLayerId-rendering")&&(this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((function(){return t._renderGeometryAndTransparentTerrainPass(dc.O.ObjectAndLayerIdColor)}),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((function(){t._bindParameters.renderTransparentlyOccludedHUD=Lx.NotOccluded,t._renderInternalSlot(dc.H.HUD_MATERIAL)}),null,!0,!0))}},{key:"finish",value:function(e){if(this._hasAnimations||(this._animationTimestep=(0,Eu.aj)(0)),e===vc.N.BACKGROUND){var t=0;this.performanceInfo.gpuSamplingEnabled?t=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();var r=this.performanceInfo.elapsedTime,n=Math.max(r,t),i=(0,Vu.a)(n/.5,Gj,Bj);this._animationTimestep=(0,Eu.aj)(.9*this._animationTimestep+i*(1-.9))}}},{key:"readDepthPixels",value:function(e,t,r){var n=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);var i=pc._.COLOR_BUFFER_BIT|pc._.DEPTH_BUFFER_BIT|pc._.STENCIL_BUFFER_BIT;this._rctx.clearSafe(i),this._renderGeometryAndTransparentTerrainPass(dc.O.Depth)}n.readPixels(t[0],t[1],t[2],t[3],pc.P.RGBA,pc.G.UNSIGNED_BYTE,r)}},{key:"readHUDVisibility",value:function(e,t,r,n,i){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(e,t,r,n,pc.P.RGBA,pc.G.UNSIGNED_BYTE,i)}},{key:"readAccumulatedShadow",value:function(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}},{key:"_setMultipassEnabled",value:function(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}},{key:"_setTerrainCulling",value:function(e){this._bindParameters.multipassTerrain.cullAboveGround=e}},{key:"_renderSlot",value:function(e){this._bindParameters.slot=e,this._renderPlugins.render()}},{key:"_renderEdges",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._edgeView;(0,Nu.r)(n)&&n.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((function(){return n.render(t._bindParameters,e)}),this._bindParameters,tj.Alpha,r)}},{key:"_renderShadowMap",value:function(e,t,r,n){var i=this,a=this._shadowMap;a.enabled&&(a.start(t,r,n),this._shadowHighlight.updateParameters(t,r),this._needsShadowHighlight?(this._renderShadowCascades(dc.O.ShadowHighlight,this._shadowMap,(function(e){return a.takeCascadeSnapshotTo(e,JO.Highlight)})),a.clear(),this._renderShadowCascades(dc.O.ShadowExludeHighlight,this._shadowMap,(function(e){a.takeCascadeSnapshotTo(e,JO.Default),i._renderGeometryAndTransparentTerrainPass(dc.O.ShadowHighlight)}))):this._renderShadowCascades(dc.O.Shadow),a.finish(e),t.setGLViewport(this._rctx))}},{key:"_renderShadowCascades",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){},i=(0,Cu.Z)(r.getCascades());try{for(i.s();!(t=i.n()).done;){var a=t.value;a.camera.setGLViewport(this._rctx),this._prepare(a.camera,a.camera),this._renderGeometryAndTransparentTerrainPass(e),n(a)}}catch(o){i.e(o)}finally{i.f()}}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.ready||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this._needsShadowHighlight||this._needsShadowCast}},{key:"_renderLinearDepth",value:function(){var e=this;this._needsLinearDepth?this._offscreenRendering.renderToTargets((function(){return e._renderGeometryAndTransparentTerrainPass(dc.O.Depth)}),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}},{key:"_renderTerrainLinearDepth",value:function(e){var t=this;if(e){var r=this._renderContext.output;this._renderContext.output=dc.O.Depth,this._offscreenRendering.renderToTargets((function(){return t._renderTransparentTerrain()}),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=r}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}},{key:"_renderGeometryLinearDepth",value:function(e){var t=this;if(e){var r=this._renderContext.output;this._offscreenRendering.renderToTargets((function(){return t._renderGeometryPass(dc.O.Depth)}),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=r}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}},{key:"_needsNormal",get:function(){return this._ssaoHelper.ready}},{key:"_renderNormal",value:function(){var e=this;this._needsNormal?this._offscreenRendering.renderToTargets((function(){e._renderGeometryAndTransparentTerrainPass(dc.O.Normal)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_computeDepthRange",value:function(e){if(!this._needsDepthRange)return BG;var t=_j(e,this._content,this._stage.layers);return UG(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}},{key:"_renderGeometryAndTransparentTerrainPass",value:function(e){this._renderContext.output=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}},{key:"_renderGeometryPass",value:function(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}},{key:"_renderSSAO",value:function(){this._ssaoHelper.loading?this._requestRender():this._ssaoHelper.computeSSAO(this._bindParameters,this._offscreenRendering.linearDepthTexture,this._offscreenRendering.normalTexture)}},{key:"_renderOpaqueGeometry",value:function(){this._renderSlot(dc.H.INTEGRATED_MESH),this._renderSlot(dc.H.OPAQUE_TERRAIN),this._renderInternalSlot(dc.H.OPAQUE_MATERIAL),this._renderSlot(dc.H.OPAQUE_MATERIAL),this._renderSlot(dc.H.POSTPROCESSING_ENVIRONMENT_OPAQUE)}},{key:"_renderTransparentGeometry",value:function(){this._renderInternalSlot(dc.H.TRANSPARENT_MATERIAL),this._renderSlot(dc.H.TRANSPARENT_MATERIAL)}},{key:"_renderTransparentTerrain",value:function(){this._renderSlot(dc.H.TRANSPARENT_TERRAIN)}},{key:"_renderHUDVisibility",value:function(e){var t=this,r=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((function(){t._bindParameters.hudVisibilityTexture=t._renderContext.offscreenRenderingHelper.hudVisibilityTexture,r=t._renderInternalSlot(dc.H.OCCLUSION_PIXELS)}),e),r}},{key:"_renderLineCallouts",value:function(e){var t=this;this._bindParameters.renderTransparentlyOccludedHUD=e,e===Lx.Occluded?this._offscreenRendering.renderToTargets((function(){return t._renderInternalSlot(dc.H.LINE_CALLOUTS)}),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(dc.H.LINE_CALLOUTS)}},{key:"_renderHUD",value:function(e,t){var r=this;this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((function(){return r._renderHUDElements(e)}),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,tj.PremultipliedAlpha)):e===Lx.Occluded?this._offscreenRendering.renderToTargets((function(){return r._renderHUDElements(Lx.Occluded)}),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}},{key:"_renderHUDElements",value:function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(dc.H.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(dc.H.HUD_MATERIAL),this._renderInternalSlot(dc.H.LABEL_MATERIAL)}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_renderHighlights",value:function(e,t){var r=this;if(this._needsHighlight){var n=this._highlight,i=this._offscreenRendering.renderToTargets((function(){r._renderGeometryAndTransparentTerrainPass(dc.O.Highlight),r._rctx.clearSafe(pc._.DEPTH_BUFFER_BIT),r._renderHUDElements(Lx.Both)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(t,e),n.render(this._bindParameters,i,e)}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"_accumulateShadows",value:function(e,t,r){this._needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,e,t,r)}},{key:"_renderOrderIndependentTransparency",value:function(e,t){var r=this,n=function(n){r._bindParameters.transparencyPassType=n,r._offscreenRendering.renderOITPass((function(){return e()}),n,t)},i=this._renderContext.output;this._renderContext.output=dc.O.Alpha,n(vc.o.Alpha),this._renderContext.output=dc.O.Color,n(vc.o.Color),n(vc.o.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,t),this._bindParameters.transparencyPassType=vc.o.NONE,this._renderContext.output=i,this._oitUsed=!0}},{key:"_disposeOITBuffers",value:function(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}},{key:"_renderOccluded",value:function(){var e=this,t=0;this._materialRenderers.forEach((function(e,r){r&&r.isVisible()&&r.renderOccluded===dc.ah.OccludeAndTransparentStencil&&(t|=r.renderOccluded,yX.push(r))}));var r=this._offscreenRendering,n=function(n,i,a,o,s){0!=(t&i)&&(r.renderToTargets(a,r.tmpColor,r.mainDepth,[0,0,0,0],o,s),r.compositeOccludedOntoMain(e._bindParameters,n))};0!==yX.length&&(this._renderInternalSlot(dc.H.OCCLUDER_MATERIAL,yX),n(.5,dc.ah.OccludeAndTransparentStencil,(function(){return e._renderInternalSlot(dc.H.TRANSPARENT_OCCLUDER_MATERIAL,yX)}),!1,!1),yX.length=0),this._materialRenderers.forEach((function(e,r){r&&r.isVisible()&&(r.renderOccluded===dc.ah.OccludeAndTransparent||r.renderOccluded===dc.ah.Transparent||r.renderOccluded===dc.ah.Opaque)&&(t|=r.renderOccluded,mX.push(r))}));var i=this._renderPlugins.renderOccludedFlags;if(t|=i){var a=function(t){e._renderContext.renderOccludedMask=t,i>dc.ah.Occlude&&e._renderSlot(dc.H.OCCLUDED_TERRAIN),e._renderInternalSlot(dc.H.OPAQUE_MATERIAL,mX),e._renderInternalSlot(dc.H.TRANSPARENT_MATERIAL,mX),e._renderInternalSlot(dc.H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,mX),e._renderContext.resetRenderOccludedMask()};this._renderContext.output=dc.O.Color,n(.5,dc.ah.OccludeAndTransparent,(function(){return a(dc.ah.OccludeAndTransparent)}),!0,vc.t.OutlineVisualElementMask),n(.5,dc.ah.Transparent,(function(){return a(dc.ah.Transparent)}),!0,vc.t.OutlineVisualElementMask),n(1,dc.ah.Opaque,(function(){return a(dc.ah.Opaque)}),!0,vc.t.OutlineVisualElementMask),mX.length=0}}},{key:"_renderAntiAliasing",value:function(e){var t=this;if(this._antialiasing){if(this._smaaPass.enable((function(){return t._requestRender()}))&&(0,Nu.r)(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}},{key:"_prepare",value:function(e,t){this._needsTransparentPass=(0,Eu.a9)(this._materialRenderers,(function(e){return e.requiresSlot(dc.H.TRANSPARENT_MATERIAL,dc.O.Color)})),this._bindParameters.camera=e,this._bindParameters.contentCamera=t}},{key:"_ensureBindParameters",value:function(e,t){var r;this._bindParameters.camera=e,this._bindParameters.contentCamera=t;var n=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=n.hudVisibilityTexture,this._bindParameters.mainColorTexture=n.mainColorTexture,this._bindParameters.highlightDepthTexture=null!==(r=n.depthTexture)&&void 0!==r?r:this._getFallbackDepthTexture()}},{key:"_ensureBindParametersSSR",value:function(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=hc.o:((0,Wu.h)(_X,this._bindParameters.camera.viewMatrix),(0,Wu.h)(gX,this._bindParameters.camera.projectionMatrix),(0,Wu.u)(bX,_X,gX),(0,Wu.u)(bX,this._renderContext.lastFrameCamera.viewMatrix,bX),(0,Wu.u)(bX,this._renderContext.lastFrameCamera.projectionMatrix,bX),this._reprojectionMatrix=bX),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null,this._bindParameters.ssr.enabled=this.hasWaterReflection}},{key:"_renderInternalSlot",value:function(e,t){var r=this,n=!1;return this._bindParameters.slot=e,(0,Nu.r)(t)?t.forEach((function(e){if(e.shouldRender(r._renderContext)){var t=r._materialRenderers.get(e);(0,Nu.r)(t)&&(n=t.render(r._renderContext.output,r._bindParameters)||n)}})):this._materialRenderers.forEach((function(e,t){t.shouldRender(r._renderContext)&&e.render(r._renderContext.output,r._bindParameters)&&(n=!0)})),n}},{key:"_getFallbackDepthTexture",value:function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=(0,dc.aR)(this._rctx)),this._fallbackDepthStencilTexture}},{key:"gpuMemoryUsage",get:function(){var e,t,r,n,i,a,o,s,l,u;return{offscreen:null!==(e=null===(t=this._offscreenRendering)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0,highlights:(null!==(r=null===(n=this._highlight)||void 0===n?void 0:n.gpuMemoryUsage)&&void 0!==r?r:0)+(null!==(i=null===(a=this._shadowHighlight)||void 0===a?void 0:a.gpuMemoryUsage)&&void 0!==i?i:0),shadows:null!==(o=null===(s=this._shadowMap)||void 0===s?void 0:s.gpuMemoryUsage)&&void 0!==o?o:0,ssao:null!==(l=null===(u=this._ssaoHelper)||void 0===u?void 0:u.gpuMemoryUsage)&&void 0!==l?l:0}}},{key:"test",get:function(){var e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,getFramebufferTexture:function(t){switch(t){case dX.Color:return e._offscreenRendering.colorTexture;case dX.LinearDepth:return e._offscreenRendering.linearDepthTexture;case dX.Normals:return e._offscreenRendering.normalTexture;case dX.ShadowMap:return e._shadowMap.depthTexture;case dX.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case dX.Highlight:return e._offscreenRendering.highlightTexture}}}}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],vX.prototype,"_shadowAccumulator",void 0),(0,Eu.e)([(0,Eu.y)()],vX.prototype,"_smaaPass",void 0),(0,Eu.e)([(0,Eu.y)()],vX.prototype,"_antialiasing",void 0),(0,Eu.e)([(0,Eu.y)()],vX.prototype,"_edgeView",void 0),(0,Eu.e)([(0,Eu.y)()],vX.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)()],vX.prototype,"isCameraFinal",null),vX=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.Renderer")],vX),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(dX||(dX={}));var mX=[],yX=[],gX=(0,hc.e)(),_X=(0,hc.e)(),bX=(0,hc.e)(),xX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,e,n)).newCache=i,a._refCount=1,a}return(0,ku.Z)(r,[{key:"dispose",value:function(){--this._refCount>0||(0,_u.Z)((0,bu.Z)(r.prototype),"dispose",this).call(this)}},{key:"ref",value:function(){++this._refCount}},{key:"bindTechnique",value:function(e,t,r,n){return this.useProgram(e.program),e.bindPipelineState(this,null===r||void 0===r?void 0:r.slot,n),e.program.bindPass(t,r),e.program}},{key:"test",get:function(){return this.programCache.test}}]),r}(_h.y),wX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i){var a;return(0,Au.Z)(this,r),(a=t.call(this,{}))._stage=e,a._techniqueRepository=n,a._rctx=i,a._textures=new Map,a._loadingCount=0,a._frameUpdates=new Map,a.events=new ec.n,a._frameTask=e.resourceController.scheduler.registerTask(bc.I.TEXTURE_UNLOAD),a}return(0,ku.Z)(r,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._frameTask.remove(),this._stage.forEachOfType(dc.ap.Texture,(function(e){return e.unload()}))}},{key:"updating",get:function(){return this._loadingCount>0||this._frameTask.updating}},{key:"textureTechnique",get:function(){return(0,Nu.t)(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(uA,new cA)),this._textureTechnique}},{key:"acquire",value:function(e){var t=this._textures.get(e);return t?(t.ref(),(0,Nu.v)(t.loadingPromise,t)):this._createNewRef(e)}},{key:"update",value:function(){var e=this,t=!1;this._frameUpdates.forEach((function(r){var n=r.texture.frameUpdate(e._rctx,e.textureTechnique,r.previousToken);n>=0&&n!==r.previousToken&&(r.previousToken=n,t=!0)})),t&&this.events.emit("changed",vc.N.BACKGROUND)}},{key:"_createNewRef",value:function(e){var t=this,r=this._stage.getObject(e);if((0,Nu.t)(r))return(0,Sc.e)(void 0!==r),null;var n=r.events.on("unloaded",(function(){n.remove(),t._onTextureUnloaded(e)})),i=new TX(e,(function(){t._frameTask.schedule((function(){i.isUnreferenced&&r.unload()}))}));return this._textures.set(e,i),i.ref(),(0,Nu.r)(r.glTexture)?(this._updateGLTexture(i,r.glTexture),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),i):(this._loadingCount++,i.loadingPromise=this._stage.schedule((function(){var n=r.load(t._rctx,(function(){return t.textureTechnique})),a=function(n){return t._loadingCount--,i.loadingPromise=null,t._updateGLTexture(i,n),r.requiresFrameUpdates&&t._frameUpdates.set(e,{texture:r,previousToken:-1}),i};return(0,Eu.V)(n)?n.then(a,(function(e){return t._loadingCount--,i.loadingPromise=null,(0,Eu.j)(e)||Eu.a.getLogger(t.declaredClass).error(e),null})):a(n)})),i.loadingPromise)}},{key:"_updateGLTexture",value:function(e,t){e.glTexture=t,this.events.emit("changed",vc.N.UPDATE)}},{key:"_onTextureUnloaded",value:function(e){this._textures.delete(e),this._frameUpdates.delete(e)}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],wX.prototype,"_loadingCount",void 0),(0,Eu.e)([(0,Eu.y)()],wX.prototype,"_frameTask",void 0),(0,Eu.e)([(0,Eu.y)()],wX.prototype,"updating",null),wX=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.lib.TextureRepository")],wX);var TX=function(){function e(t,r){(0,Au.Z)(this,e),this.id=t,this._release=r,this._refCount=0}return(0,ku.Z)(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}},{key:"ref",value:function(){++this._refCount}},{key:"release",value:function(){--this._refCount,this._refCount>0||(0!==this._refCount?(Eu.a.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}]),e}(),CX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){var e;return(0,Au.Z)(this,r),(e=t.apply(this,arguments))._passParameters=new OX,e._loading=0,e}return(0,ku.Z)(r,[{key:"passParameters",get:function(){return this._passParameters}},{key:"dispose",value:function(){this._passParameters.waveNormal=(0,Nu.G)(this._passParameters.waveNormal),this._passParameters.wavePertubation=(0,Nu.G)(this._passParameters.wavePertubation)}},{key:"updating",get:function(){return this._loading>0}},{key:"ensureResources",value:function(e){var t=this;if(this._loading>0)return vc.O.LOADING;if((0,Nu.r)(this._passParameters.waveNormal)&&(0,Nu.r)(this._passParameters.wavePertubation))return vc.O.LOADED;var r={target:pc.M.TEXTURE_2D,pixelFormat:pc.P.RGBA,dataType:pc.G.UNSIGNED_BYTE,wrapMode:pc.D.REPEAT,samplingMode:pc.L.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,(0,yh.t)((0,Pc.a)("esri/images/materials/water/normals.jpg")).then((function(n){return t._passParameters.waveNormal=new Oc.E(e,(0,Tu.Z)((0,Tu.Z)({},r),{},{width:n.width,height:n.height}),n)})).catch((function(e){return Eu.a.getLogger(t.declaredClass).error("Failed to load water material normal texture.",e)})).finally((function(){return--t._loading})),++this._loading,(0,yh.t)((0,Pc.a)("esri/images/materials/water/perturbation.jpg")).then((function(n){return t._passParameters.wavePertubation=new Oc.E(e,(0,Tu.Z)((0,Tu.Z)({},r),{},{width:n.width,height:n.height}),n)})).catch((function(e){return Eu.a.getLogger(t.declaredClass).error("Failed to load water material pertubation texture.",e)})).finally((function(){return--t._loading})),vc.O.LOADING}}]),r}(Eu.m);(0,Eu.e)([(0,Eu.y)()],CX.prototype,"_loading",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],CX.prototype,"updating",null),CX=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],CX);var SX,OX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(){return(0,Au.Z)(this,r),t.apply(this,arguments)}return(0,ku.Z)(r)}(dc.t),PX=(0,ku.Z)((function e(t,r){(0,Au.Z)(this,e),this.viewCamera=t,this.frameHasDecorations=r})),RX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e,n,i,a){var o;return(0,Au.Z)(this,r),(o=t.call(this))._rctx=e,o._renderFunctions=n,o._forceCameraHook=i,o._disposeOffscreenBuffers=a,o.supersample=!0,o._screenshotQueue=new Array,o}return(0,ku.Z)(r,[{key:"dispose",value:function(){this._rctx=null}},{key:"takeScreenshot",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._renderFunctions.prepareOverlay();case 2:return this._renderFunctions.requestRenderScene(vc.N.BACKGROUND),r=(0,Eu.ap)(),e.abrupt("return",(this._screenshotQueue.push({settings:t,resolver:r}),r.promise));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(e,t){var r,n=(0,Cu.Z)(this._screenshotQueue);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(this.isDisposed)i.resolver.reject();else{var a=(0,Tu.Z)((0,Tu.Z)({},i.settings),{},{pixelRatio:i.settings.pixelRatio*e.viewCamera.pixelRatio}),o=this._renderScreenshot(e,a,t);i.resolver(o)}}}catch(s){n.e(s)}finally{n.f()}this._screenshotQueue.length=0}},{key:"_renderScreenshotOverlay",value:function(e,t,r){e.width=t.width,e.height=t.height;var n=e.getContext("2d"),i=r.pixelRatio;return n.save(),n.translate(0,t.height),n.scale(1,-1),r.region&&n.translate(-r.region.x,-r.region.y),n.scale(i,i),t=this._renderFunctions.renderOverlay(e,t),n.restore(),t}},{key:"_readbackScreenshot",value:function(e,t){return e.resample?this._readbackScreenshotResampled(e,t):this._readbackScreenshotImmediate(e,t)}},{key:"_readbackScreenshotResampled",value:function(e,t){var r=e.framebufferWidth,n=e.framebufferHeight,i=e.region,a=e.resample,o=this._ensureScreenshotEncodeCanvas(),s=(0,bh.e)(r,n,o);this._rctx.gl.readPixels(0,0,r,n,pc.P.RGBA,pc.C.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),s=this._renderScreenshotOverlay(o,s,(0,Tu.Z)((0,Tu.Z)({},e),{},{region:null}));var l=(0,bh.e)(i.width,i.height,o);return(0,Ju.R)(s,l,!0,a.region.x,n-(a.region.y+a.region.height),a.region.width,a.region.height)}},{key:"_readbackScreenshotImmediate",value:function(e,t){var r=e.framebufferHeight,n=e.region,i=this._ensureScreenshotEncodeCanvas(),a=(0,bh.e)(n.width,n.height,i);return this._rctx.gl.readPixels(n.x,r-(n.y+n.height),n.width,n.height,pc.P.RGBA,pc.C.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(i,a,e)}},{key:"_renderScreenshot",value:function(e,t,r){var n=this,i=null,a=null,o=e.viewCamera,s=t.framebufferWidth,l=t.framebufferHeight,u=!1,c=t.disableDecorations&&e.frameHasDecorations,h=s!==o.fullWidth||l!==o.fullHeight,d=t.ignorePadding&&o.pixelRatio!==t.pixelRatio,f=h||c||d||t.objectAndLayerIdColor;if(t.objectAndLayerIdColor&&(a=new _c.x(this._rctx,{width:s,height:l,colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.DEPTH_STENCIL_RENDER_BUFFER})),f){var p=o.clone();if(t.ignorePadding){for(var v=(0,lc.t)(p.padding),m=0;m<4;m++)v[m]=Math.round(v[m]/p.pixelRatio*t.pixelRatio);p.padding=v}p.fullWidth=s,p.fullHeight=l,p.pixelRatio=t.pixelRatio;var y=o.fovX-p.fovX,g=o.fovY-p.fovY;y<0&&y<g?p.fovX=o.fovX:g<0&&g<y&&(p.fovY=o.fovY),this._forceCameraHook(p),u=!0,i=new _c.x(this._rctx,{width:p.fullWidth,height:p.fullHeight,colorTarget:pc.Y.TEXTURE,depthStencilTarget:pc.V.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(i,a,p,t.disableDecorations?vc.D.OFF:vc.D.ON,r),this._disposeOffscreenBuffers()}var _=function(){n._rctx.bindFramebuffer(null),(0,Nu.G)(i)},b=this._readbackScreenshot(t,_);_();var x=null;if(t.objectAndLayerIdColor){var w=function(){n._rctx.bindFramebuffer(null),(0,Nu.G)(a)};this._rctx.bindFramebuffer(a),x=this._readbackScreenshot(t,w),this._rctx.bindFramebuffer(null),w()}if(f&&!this._rctx.contextAttributes.alpha)for(var T=3;T<b.data.length;T+=4)b.data[T]=255;if(x&&!this._rctx.contextAttributes.alpha)for(var C=3;C<x.data.length;C+=4)x.data[C]=255;return u&&this._forceCameraHook(o),[b,x]}},{key:"_ensureScreenshotEncodeCanvas",value:function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}]),r}(hO),AX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;(0,Au.Z)(this,r),(n=t.call(this,{})).events=new ec.n,n.waterTextureRepository=new CX,n._magnifierHelper=new zj,n._objectAndLayerIdRenderHelper=(0,Nu.h)("enable-feature:objectAndLayerId-rendering")?new Vj:null,n._needsUpdate=!0,n._needsRender=!0,n._idleSuspend=!0,n._needsWaterReflectionUpdate=!1,n._lastAnimationUpdate=0,n._container=e.container,n._viewingMode=e.viewingMode,n._initializeContext(e),(0,Fu.l)((function(){var e;return null===(e=n.waterTextureRepository)||void 0===e?void 0:e.updating}),(function(){return n.requestRender()}),Fu.h),n._magnifierHelper.events.on("request-render",(function(){return n.requestRender()})),n._stippleTextureRepository=new TO(n._rctx),n._shaderTechniqueRepository=new oO({rctx:n._rctx,viewingMode:e.viewingMode,stippleTextureRepository:n._stippleTextureRepository,waterTextureRepository:n.waterTextureRepository}),n._textureRepository=new wX(e,n._shaderTechniqueRepository,n._rctx),n._textureRepository.events.on("changed",(function(e){return n.requestRender(e)})),n._materialRepository=new pO(n._textureRepository,n._shaderTechniqueRepository,(function(){return n.requestRender()}),(function(){return n.requestRender()})),n._compositingHelper=new yj(n._rctx,n._shaderTechniqueRepository),n._renderer=new vX(n._materialRepository,n._textureRepository,n._shaderTechniqueRepository,n._rctx,n._compositingHelper,n._magnifierHelper,(function(e){return n.requestRender(e)}),(function(t,r){return e.schedule(t,r)}),e);var i={renderScene:function(e,t,r,i,a){return n._renderer.render(e,t,{camera:r,contentCamera:r,mode:bc.a.IDLE},i,a)},requestRenderScene:function(e){return n.requestRender(e)},prepareOverlay:function(){return e.options.screenshot.prepareOverlay()},renderOverlay:function(t,r){return e.options.screenshot.renderOverlay(t,r)}};return n._screenshotManager=new RX(n._rctx,i,(function(e){return n.events.emit("force-camera-for-screenshot",e)}),(function(){return n._renderer.disposeOffscreenBuffers()})),n._registerFrameTask(e),n}return(0,ku.Z)(r,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=(0,Nu.f)(this._frameTask),this._shaderTechniqueRepository=(0,Nu.G)(this._shaderTechniqueRepository),(0,_u.Z)((0,bu.Z)(r.prototype),"dispose",this).call(this),this._tmpDepthBuffer=null,this._rctx=null}},{key:"performanceInfo",get:function(){var e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vc.N.UPDATE;this._needsRender=!0,e===vc.N.UPDATE&&(this._needsUpdate=!0)}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"ensureEdgeView",value:function(){return this._renderer.ensureEdgeView()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(e){this._magnifierHelper.magnifier=e}},{key:"setRenderParameters",value:function(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e)}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"modify",value:function(e){this._renderer.modify(e),e.clear()}},{key:"canvas",get:function(){return this._canvas}},{key:"takeScreenshot",value:function(e){return this._screenshotManager.takeScreenshot(e).then((function(e){return e[0]}))}},{key:"takeScreenshotWithOID",value:function(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}},{key:"getAlpha",value:function(){return this._rctx.contextAttributes.alpha}},{key:"shadowsEnabled",get:function(){return this._renderer.shadowsEnabled}},{key:"readAccumulatedShadow",value:function(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}},{key:"readHUDVisibility",value:function(e,t,r,n,i){this._renderer.readHUDVisibility(e,t,r,n,i)}},{key:"getMinimalDepthForArea",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:i,o=n.constrainWindowSize(t,r,i*n.pixelRatio,a*n.pixelRatio),s=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(n,o,s);for(var l=Number.MAX_VALUE,u=0;u<o[2]*o[3];u++){var c=gj(4*u,s,n.nearFar);l>c&&c!==n.nearFar[0]&&c!==n.nearFar[1]&&(l=c)}if((0,Nu.r)(e)){var h=e.pickDepth(t*n.pixelRatio,r*n.pixelRatio,n);(0,Nu.r)(h)&&l>h&&h!==n.nearFar[0]&&h!==n.nearFar[1]&&(l=h)}return l===Number.MAX_VALUE?void 0:l}},{key:"_ensureDepthBuffer",value:function(e){var t=4*e[2]*e[3];return((0,Nu.t)(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"gpuMemoryUsage",get:function(){return this._renderer.gpuMemoryUsage}},{key:"reloadShaders",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wz(),e.next=3,this._shaderTechniqueRepository.reloadAll();case 3:this.requestRender();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"animationTimestep",get:function(){return this._renderer.animationTimestep}},{key:"_registerFrameTask",value:function(e){var t=this,r=e.state,n=!1,i=vc.N.BACKGROUND,a=!1,o={preRender:function(a){var o=a.time;n=t.updating,i=t._needsUpdate?vc.N.UPDATE:vc.N.BACKGROUND,e.processSyncLayers(),(o-t._lastAnimationUpdate>t.animationTimestep||(0,Nu.r)(r.forcedAnimationTime)||n||t._needsRender)&&(o=(0,Nu.v)(r.forcedAnimationTime,o),t._renderer.updateAnimation({camera:r.camera,time:o})&&t.requestRender(vc.N.BACKGROUND),t._lastAnimationUpdate=o)},render:function(e){var n=e.time;if((t._needsRender||!t._idleSuspend||!t._renderer.isCameraFinal||t._needsWaterReflectionUpdate)&&r.camera.fullWidth>0&&r.camera.fullHeight>0){var i=t._needsUpdate&&t._idleSuspend&&t._renderer.isCameraFinal;t._needsRender=!1,t._needsUpdate=!1,t._needsWaterReflectionUpdate=!1,t._renderer.render(null,null,r,vc.D.ON,n),a=!0,i&&t._renderer.hasWaterReflection&&(t.requestRender(vc.N.BACKGROUND),t._needsWaterReflectionUpdate=!0)}},update:function(e){var n=e.time,i=new PX(r.camera,t._renderer.hasSlicePlane||t._magnifierHelper.enabled);t._textureRepository.update(),t._screenshotManager.update(i,n)},finish:function(){a&&(t._renderer.finish(r.mode===bc.a.IDLE?i:vc.N.UPDATE),a=!1)}};this._frameTask=(0,Eu.a7)(o)}},{key:"_initializeContext",value:function(e){var t,r=e.options;this._canvas=r.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var n={alpha:r.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==r.stencil||r.stencil,powerPreference:"high-performance",preserveDrawingBuffer:null!==(t=r.preserveDrawingBuffer)&&void 0!==t&&t},i=(0,Fc.o)("3d",this._canvas,n);if((0,Nu.t)(i)){var a=(0,Nu.h)("esri-force-webgl");Eu.a.getLogger(this.declaredClass).error(a)}else this._rctx=this._newRenderingContext(i,e),this._loadShaderOnlyExtensions(),!r.alpha&&this._rctx.contextAttributes.alpha&&Eu.a.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,Nu.h)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}},{key:"_newRenderingContext",value:function(e,t){var r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8};return new xX(e,r,(function(e,r){return t.resourceController.memoryController.newCache(e,r)}))}},{key:"_loadShaderOnlyExtensions",value:function(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}},{key:"_getObjectAndLayerIdColor",value:function(e){return this._objectAndLayerIdRenderHelper?this._objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}},{key:"componentObjectCollection",get:function(){return(0,Nu.t)(this._componentObjectCollection)&&(this._componentObjectCollection=new WH(this._renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e}}]),r}(cO(Eu.m));(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0})],AX.prototype,"updating",null),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_rctx",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_container",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_canvas",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_stippleTextureRepository",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)},(0,Eu.y)()],AX.prototype,"waterTextureRepository",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)},(0,Eu.y)()],AX.prototype,"_magnifierHelper",void 0),(0,Eu.e)([(0,Eu.y)()],AX.prototype,"_objectAndLayerIdRenderHelper",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)},(0,Eu.y)()],AX.prototype,"_textureRepository",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_compositingHelper",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_renderer",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_screenshotManager",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"componentObjectCollection",null),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)}],AX.prototype,"_componentObjectCollection",void 0),(0,Eu.e)([(0,Eu.y)()],AX.prototype,"_needsUpdate",void 0),(0,Eu.e)([(0,Eu.y)()],AX.prototype,"_needsWaterReflectionUpdate",void 0),AX=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.parts.RenderView")],AX);var kX=SX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e))._handles=new Eu.X,n._model=new SG,n._layers=new Eu.a6,n._changeSet=new sR,n._layerSyncSet=new Set,n}return(0,ku.Z)(r,[{key:"initialize",value:function(){this._set("renderView",new AX(this)),this._frameTask=this.resourceController.scheduler.registerTask(bc.I.STAGE,this),this._handles.add(this._frameTask)}},{key:"destroy",value:function(){$C.pool.prune(0),this._handles.destroy(),this.dispose()}},{key:"viewingMode",get:function(){return this.state.viewingMode}},{key:"updating",get:function(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}},{key:"add",value:function(e){this._model.add(e),bO(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}},{key:"remove",value:function(e){(0,Nu.t)(e)||(this.renderView.requestRender(),this._model.remove(e),bO(e)&&(this._removeLayer(e),e.detachStage()))}},{key:"addMany",value:function(e){(0,Nu.r)(e)&&(this._model.addMany(e),this.renderView.requestRender())}},{key:"removeMany",value:function(e){(0,Nu.r)(e)&&(this._model.removeMany(e),this.renderView.requestRender())}},{key:"load",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,Nu.t)(t),e.t0){e.next=5;break}return Array.isArray(t)||(t=[t]),e.next=5,Promise.all(t.filter((function(e){return(0,Nu.t)(e.glTexture)})).map((function(e){return r.schedule((function(){return r._model.has(e)?e.load(r.renderView.renderingContext,(function(){return r.renderView.textureRepository.textureTechnique})):null}))})));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadImmediate",value:function(e){var t=this;return e.load(this.renderView.renderingContext,(function(){return t.renderView.textureRepository.textureTechnique}))}},{key:"forEachOfType",value:function(e,t){this._model.forEachOfType(e,t)}},{key:"handleEvent",value:function(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}},{key:"running",get:function(){return this._model.dirtySet.dirty}},{key:"runTask",value:function(e){this._frameTask.processQueue(e),e.done||this._commit()}},{key:"_commit",value:function(){var e=this._model.dirtySet;SX.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),SX.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((function(e){return e.id}))),console.log("RGs remove: "+this._changeSet.removes.map((function(e){return e.id})))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}},{key:"schedule",value:function(e,t){return this._frameTask.schedule(e,t)}},{key:"syncLayer",value:function(e){this._layerSyncSet.add(e),this.renderView.requestRender()}},{key:"processSyncLayers",value:function(){var e=this,t=this._model.dirtySet;this._layers.forAll((function(r){(e._layerSyncSet.has(r.id)||r.updatePolicy===vc.i.SYNC)&&(t.commitLayer(r.id,e._changeSet),e._layerSyncSet.delete(r.id))}));var r,n=(0,Cu.Z)(this._layerSyncSet);try{for(n.s();!(r=n.n()).done;){var i=r.value;t.commitLayer(i,this._changeSet)}}catch(a){n.e(a)}finally{n.f()}this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}},{key:"getObject",value:function(e){return this._model.getObject(e)}},{key:"layers",get:function(){return this._layers}},{key:"_addLayer",value:function(e){this._layers.includes(e)||this._layers.push(e)}},{key:"_removeLayer",value:function(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}},{key:"addRenderPlugin",value:function(e,t,r){var n=this,i=this.renderView.renderPlugins.add(e,t,r),a=function(){JZ(t)&&n.sceneIntersectionHelper.addIntersectionHandler(t)};if((0,Eu.V)(i))return i.then(a);a()}},{key:"removeRenderPlugin",value:function(e){JZ(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}},{key:"performanceInfo",get:function(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}},{key:"test",get:function(){var e=this;return{getCount:function(t){return e._model.test.content.filter((function(e){return e.type===t})).length},model:e._model}}}]),r}(cO(Eu.m));function EX(e){return(0,qu.P)(e)&&e.intersector===qu.M.PCL&&!!e.target}function DX(e){return(0,qu.P)(e)&&e.intersector===qu.M.I3S&&!!e.target}function MX(e){return(0,qu.P)(e)&&e.intersector===qu.M.TERRAIN&&!!e.target}function IX(e){return(0,qu.P)(e)&&e.intersector===qu.M.OVERLAY&&!!e.target}function LX(e){return(0,qu.P)(e)&&e.intersector===qu.M.LOD&&!!e.target}function ZX(e,t){var r;return(0,qu.a0)(e)||(0,qu.a1)(e)?UX(e.target.object.metadata,t):MX(e)?null===(r=t.map)||void 0===r?void 0:r.ground:EX(e)||DX(e)||IX(e)?UX(e.target,t):null}function NX(e,t){var r=FX(e,t);return(0,Nu.r)(r)&&"graphic"===r.type?r.graphic:null}function FX(e,t){if((0,Nu.t)(e))return null;if((0,qu.a0)(e)||(0,qu.a1)(e))return zX(e.target.object.metadata,t);if(EX(e)){var r=e.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return IX(e)||LX(e)?zX(e.target,t):DX(e)?function(e,t){var r=UX(e,t);if((0,Nu.t)(r))return null;var n=t.allLayerViews.find((function(e){return e.layer===r}));return n&&!n.suspended&&"getGraphicFromIntersectorTarget"in n?function(e){return(0,Nu.r)(e)?{type:"graphic",graphic:e,layer:e.layer}:null}(n.getGraphicFromIntersectorTarget(e)):null}(e.target,t):null}function zX(e,t){if((0,Nu.t)(e)||(0,Nu.t)(e.graphicUid))return null;var r=UX(e,t);if((0,Nu.t)(r))return null;if(r===t.graphics)return(0,Nu.t)(t.graphicsView)||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid);var n=t.allLayerViews.find((function(e){return e.layer===r}));return!n||n.suspended||(0,Nu.t)(e.graphicUid)?null:"getHit"in n?n.getHit(e.graphicUid):null}function UX(e,t){return(0,Nu.t)(e.layerUid)?null:(0,Nu.r)(t.graphicsView)&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}function VX(e,t){if((0,qu.a0)(e)||(0,qu.a1)(e))return(0,Qu.T)(e.target.object.boundingVolumeWorldSpace.bounds);if(LX(e)){(0,Wu.v)(GX,e.transformation);var r=Math.max(GX[0],GX[1],GX[2]);return e.target.baseBoundingSphere.radius*r}return DX(e)?(0,Nu.n)(function(e,t){var r=UX(e,t);if((0,Nu.t)(r))return null;var n=t.allLayerViews.find((function(e){return e.layer===r}));return n&&!n.suspended&&"getAABBFromIntersectorTarget"in n?n.getAABBFromIntersectorTarget(e):null}(e.target,t),(function(e){return.5*(0,Gc.g)(e)})):null}function BX(e){return!(0,qu.a0)(e)&&!(0,qu.a1)(e)&&(LX(e)?e.target.numLodLevels>1:!!DX(e))}kX.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"resourceController",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"options",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"state",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"sceneIntersectionHelper",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],kX.prototype,"viewingMode",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"container",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"renderSR",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"_handles",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],kX.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],kX.prototype,"_model",void 0),(0,Eu.e)([function(e,t){var r,n,i;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(r=null===(n=e._managedDisposables)||void 0===n?void 0:n.slice())&&void 0!==r?r:[]),null===(i=e._managedDisposables)||void 0===i||i.unshift(t)},(0,Eu.y)()],kX.prototype,"renderView",void 0),kX=SX=(0,Eu.e)([(0,Eu.n)("esri.views.3d.webgl-engine.Stage")],kX);var GX=(0,Vu.n)();function HX(e,t){return jX.apply(this,arguments)}function jX(){return jX=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n,i,a,o;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("2d"!==t.type){e.next=2;break}return e.abrupt("return",t.hitTest(r));case 2:return e.next=4,t.hitTest(r);case 4:if(0!==(n=e.sent).results.length){e.next=7;break}return e.abrupt("return",n);case 7:return i=n.results[0],a=(0,Nu.r)(i.distance)?i.distance*(1+qX):i.distance,o=n.results.findIndex((function(e){return e.distance>a})),e.abrupt("return",(-1!==o&&(n.results=n.results.slice(0,o)),n));case 9:case"end":return e.stop()}}),e)}))),jX.apply(this,arguments)}var qX=.05,WX=function(e){(0,Pu.Z)(r,e);var t=(0,Ru.Z)(r);function r(e){var n;return(0,Au.Z)(this,r),(n=t.call(this,e)).components=["attribution","zoom","navigation-toggle","compass"],n}return(0,ku.Z)(r)}(Ju.n);(0,Eu.e)([(0,Eu.y)()],WX.prototype,"components",void 0);var XX,YX=WX=(0,Eu.e)([(0,Eu.n)("esri.views.ui.3d.DefaultUI3D")],WX),QX=function(e){(0,Pu.Z)(n,e);var t=(0,Ru.Z)(n);function n(e){var r;(0,Au.Z)(this,n),(r=t.call(this,e))._userClippingArea=null,r._clippingArea=null,r._initialDefaultSpatialReference=null,r._defaults={},r._externallySet={environment:!1},r._createGraphicsViewController=null,r._resolveWhenReady=[],r._propertiesPool=new Ju.M({slicePlane:qu.a2},(0,gu.Z)(r)),r._resourceController=function(e){return new NN({view:e})}((0,gu.Z)(r)),r._defaultToMapOptions={include:new Set},r._defaultHitTestOptions={exclude:new Set},r.deconflictor=new mT({view:(0,gu.Z)(r)}),r.labeler=new KL({view:(0,gu.Z)(r),deconflictor:r.deconflictor.labels}),r.sharedSymbolResources=null,r.analyses=new Ju.T,r.basemapTerrain=null,r.elevationProvider=null,r.canvas=null,r.constraints=new pd,r.environmentManager=new tm,r.floors=new Lu.j,r.fullOpacity=1,r.graphicsView=null,r.analysisViewManager=new nd({view:(0,gu.Z)(r)}),r.groundView=null,r.map=null,r.screenSizePerspectiveEnabled=!0,r.state=new BZ,r.spatialReference=null,r.alphaCompositingEnabled=!1,r.preserveDrawingBufferEnabled=!1,r.supersampleScreenshotsEnabled=!0,r.type="3d",r.ui=new YX,r._numUpdating=0,r._lastUpdateTime=0,r.updatingProgress=.5,r.highlightOptions=new uN,r.voxelWasm=null,r.voxelWasmPromise=null,(0,Uu.l)(),e&&e.environment||(r._defaults.environment=new Pd,r.environment=r._defaults.environment);var i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,Nu.r)(e)&&e.type===Lu.E.MOVE||(r._updatingChanged(),r.map&&r.map.allLayers.forEach(function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:r._updatingChanged();case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()))};return r.handles.add([(0,Fu.a)((function(){var e;return null===(e=r.map)||void 0===e?void 0:e.allLayers}),"after-changes",(function(e){return i(e)}),{onListenerAdd:function(){return i()},onListenerRemove:function(){return i()},sync:!0}),r.allLayerViews.on("after-changes",(function(e){return r._updateUpdatingMonitors(e)})),(0,Fu.l)((function(){return r.map}),(function(e){e&&"load"in e&&e.load&&e.load().catch((function(){}))}))]),r.inputManager=new Nx({view:(0,gu.Z)(r)}),r.stateManager=new _b({view:(0,gu.Z)(r)}),r}return(0,ku.Z)(n,[{key:"initialize",value:function(){var e=this;this.groundView=new qh({view:this}),this._updateUpdatingMonitors();var t=function(){return e._updateDefaultToMapOptions()};this.handles.add((0,Fu.a)((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.allLayers}),"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add((function(){return e.qualitySettings.memoryLimit}),(function(t){e.resourceController&&(e.resourceController.memoryController.maxMemory=t)}),Fu.h),this.updatingHandles.add((function(){return e.qualitySettings.additionalCacheMemory}),(function(t){e.resourceController&&(e.resourceController.memoryController.additionalCacheMemory=t)}),Fu.h),this.updatingHandles.add((function(){return e.qualitySettings.frameRate}),(function(e){return(0,Eu.aw)(e>0?1e3/Math.ceil(e):0)}),Fu.h),this.updatingHandles.add((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.ground}),t,Fu.w),this.updatingHandles.add((function(){var t,r;return null===(t=e.map)||void 0===t||null===(r=t.ground)||void 0===r?void 0:r.opacity}),(function(){return e._updateDefaultHitTestOptions()}),Fu.w),this.handles.add((0,Fu.l)((function(){return e.spatialReference}),(function(){return e.notifyChange("clippingArea")}),Fu.U))}},{key:"destroy",value:function(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,Nu.g)(this.sharedSymbolResources),this._set("labeler",(0,Nu.g)(this.labeler)),this._set("deconflictor",(0,Nu.g)(this.deconflictor)),this._resourceController=(0,Nu.g)(this._resourceController),this._set("stateManager",(0,Nu.g)(this.stateManager)),this._set("inputManager",(0,Nu.g)(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",(0,Nu.g)(this.environmentManager)),this.groundView=(0,Nu.g)(this.groundView))}},{key:"renderSpatialReference",get:function(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}},{key:"basemapSpatialReference",get:function(){var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.spatialReference}},{key:"animation",get:function(){var e;return null===(e=this.state)||void 0===e?void 0:e.animation}},{key:"camera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.camera},set:function(e){this.stateManager&&(this.stateManager.camera=e)}},{key:"contentCamera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.contentCamera},set:function(e){this.stateManager&&(this.stateManager.contentCamera=e)}},{key:"installContentCameraReset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}},{key:"center",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.center},set:function(e){this.stateManager&&(this.stateManager.center=e)}},{key:"clippingArea",get:function(){if("global"===this.viewingMode)return null;var e=this._userClippingArea||this.get("map.clippingArea");return!this._userClippingArea&&!this.get("map.clippingEnabled")||(0,Nu.t)(e)?(this._clippingArea=null,null):e instanceof tc.w?this.spatialReference&&(e=$X(e,this.spatialReference),(0,Nu.t)(e))?(Eu.a.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),(0,Nu.t)(e.intersection(this._groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Eu.a.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)},set:function(e){this.ready&&"global"===this.viewingMode&&(0,Nu.r)(e)?Eu.a.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}},{key:"renderDataExtent",get:function(){if(this.state.viewingMode===ic.l.Global)return null;var e=this.renderSpatialReference,t=this.dataExtent;return(0,Nu.t)(t)||(0,Nu.t)(e)||t.spatialReference.equals(e)?t:$X(t,e)}},{key:"dataExtent",get:function(){var e=this._groundAndLayersExtent,t=this.spatialReference||Yu.k.WGS84,r=$X(this.clippingArea,t);(0,Nu.r)(r)&&(e=(0,Nu.r)(e)?e.intersection(r):r);var n=this._get("dataExtent");return(0,Nu.r)(e)&&e.equals(n)?n:e}},{key:"_groundAndLayersExtent",get:function(){var e,t=this.spatialReference||Yu.k.WGS84,r=function(r){var n=$X(r,t);(0,Nu.t)(n)||((0,Nu.r)(e)?e.union(n):e=n.clone())},n=this.basemapTerrain;if(null!==n&&void 0!==n&&n.spatialReference){var i=n.groundExtent;r(new tc.w({xmin:i[0],ymin:i[1],zmin:0,xmax:i[2],ymax:i[3],zmax:0,spatialReference:n.spatialReference}))}if(this.map){this.map.allLayers.forEach((function(e){return function(e){!(0,Nu.r)(e.fullExtent)||"graphics"===e.type&&e.internal||r(e.fullExtent)}(e)}))}if((0,Nu.t)(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin),e.zmax=Math.max(0,e.zmax)):(e.zmin=0,e.zmax=0);var a=this._get("_groundAndLayersExtent");return e.equals(a)?a:e}},{key:"environment",set:function(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}},{key:"castEnvironment",value:function(e){return e?e instanceof Pd?e:e instanceof qu.j?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Pd.fromWebsceneEnvironment(e):(0,Eu.b)(Pd,e):new Pd}},{key:"extent",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.extent},set:function(e){this.stateManager&&(this.stateManager.extent=e)}},{key:"screenCenter",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.screenCenter}},{key:"frustum",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.frustum}},{key:"initialExtentRequired",get:function(){return this.stateManager&&!this.stateManager.hasInitialView}},{key:"_defaultsFromMapSettings",get:function(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}},{key:"interacting",get:function(){return this.navigating||(0,Nu.r)(this.activeTool)}},{key:"stationary",get:function(){return!this.animation&&!this.resizing&&((0,Nu.t)(this.state)||this.state.stationary)}},{key:"navigating",get:function(){var e,t;return null!==(e=null===(t=this.state)||void 0===t?void 0:t.navigating)&&void 0!==e&&e}},{key:"padding",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.padding},set:function(e){this.stateManager&&(this.stateManager.padding=e)}},{key:"qualityProfile",get:function(){return this._get("qualityProfile")||sN.getDefaultProfile()},set:function(e){sN.isValidProfile(e)&&(sN.apply(e,this.qualitySettings),this._set("qualityProfile",e))}},{key:"slicePlane",set:function(e){if((0,Nu.r)(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),(0,Nu.t)(e))this._set("slicePlane",null);else{var t=this._propertiesPool.get("slicePlane");(0,qu.X)(e,t),this._set("slicePlane",t)}}},{key:"typeSpecificPreconditionsReady",get:function(){return!!this.viewingMode}},{key:"resolution",get:function(){return null!=this.spatialReference?(0,Ku.r)(this.scale,this.spatialReference):0}},{key:"scale",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.scale},set:function(e){this.stateManager&&(this.stateManager.scale=e)}},{key:"heightModelInfo",get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?Gu.v.deriveUnitFromSR(e,this.spatialReference):null}},{key:"updating",get:function(){var e,t,r;if(this.destroyed)return!1;var n=0,i=this.layerViewManager.updating,a=i?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((function(e){if(e.isFulfilled()){if(e.updating){if(i=!0,e.suspended||sF(e))return;++a,n+=e.updatingProgress}}else++a}));for(var o=0,s=[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager];o<s.length;o++){var l=s[o];if((0,Nu.r)(l)&&l.updating){a+=.1,n+=.05}}for(var u=0,c=[this.deconflictor,this.labeler,this.basemapTerrain];u<c.length;u++){var h=c[u];(0,Nu.r)(h)&&h.updating&&(++a,n+=h.updatingProgress)}if(i=!!(i||a>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!==(e=this.inputManager)&&void 0!==e&&e.hasPendingInputs||null!==(t=this.map)&&void 0!==t&&null!==(r=t.allLayers)&&void 0!==r&&r.some((function(e){return!e.isFulfilled()}))),i?(this._numUpdating=Math.max(a,this._numUpdating),n+=this._numUpdating-a):this._numUpdating=0,this._numUpdating>0?n/=this._numUpdating:n=i?0:1,this._get("updatingProgress")!==n){var d=performance.now();if(n<1){var f=Math.min((d-this._lastUpdateTime)/2e3,1);n=this.updatingProgress*(1-f)+n*f}this._set("updatingProgress",n),this._lastUpdateTime=i&&n<1?d:0}return i}},{key:"viewingMode",get:function(){var e,t=this._predeterminedViewingMode;if((0,Nu.r)(t))return(0,ic.a)(t);var r=this.spatialReference;return r?(0,Nu.r)(null===(e=this.defaultsFromMap)||void 0===e?void 0:e.viewingMode)&&r.equals(this.defaultsFromMap.spatialReference)?(0,ic.a)(this.defaultsFromMap.viewingMode):(0,qu.r)(r,ic.l.Global)?"global":"local":"global"},set:function(e){this.ready?Eu.a.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}},{key:"viewpoint",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.viewpoint},set:function(e){this.stateManager&&(this.stateManager.viewpoint=e)}},{key:"zoom",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.zoom},set:function(e){this.stateManager&&(this.stateManager.zoom=e)}},{key:"resourceController",get:function(){return this._resourceController}},{key:"performanceInfo",get:function(){return new PF(this)}},{key:"on",value:function(e,t,r,i){return this.viewEvents.on(e,t,r,i)||(0,_u.Z)((0,bu.Z)(n.prototype),"on",this).call(this,e,t)}},{key:"hasEventListener",value:function(e){return(0,_u.Z)((0,bu.Z)(n.prototype),"hasEventListener",this).call(this,e)||this.viewEvents.hasHandler(e)}},{key:"toMap",value:function(e,t){if(!this.ready)return Eu.a.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;var r=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,n=(0,Nu.r)(r.graphics)&&((0,Nu.r)(r.graphics.include)||(0,Nu.r)(r.graphics.exclude)),i=(0,Ju.A)(e)?(0,Ju.B)(this,e):e,a=(0,zu.d)(i);r.enableDraped=r.include&&!r.include.has(Ic.j)||r.exclude&&r.exclude.has(Ic.j);var o=this.sceneIntersectionHelper,s=(0,qu.g)(this.state.viewingMode);if(s.options.selectionMode=!0,s.options.store=n?qu.J.ALL:qu.J.MIN,o.intersectIntersectorScreen(a,s,r),n){var l,u=(0,Cu.Z)(s.results.all);try{for(u.s();!(l=u.n()).done;){var c=l.value,h=FX(c,this);if((0,Nu.t)(h))return this._intersectResultToMapPoint(c);if("graphic"!==h.type||this._testGraphicUidFilter(r.graphics,h.graphic))return this._intersectResultToMapPoint(c)}}catch(d){u.e(d)}finally{u.f()}return null}return this._intersectResultToMapPoint(s.results.min)}},{key:"toScreen",value:function(e){if(!this.ready)return Eu.a.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;var t=(0,Nu.v)(null==e.z&&(0,qu.C)(this.elevationProvider,e),0);return(0,Hu.g)(e,eY,this.renderSpatialReference,t),this.state.camera.projectToScreen(eY,tY),(0,zu.c)(tY[0],tY[1])}},{key:"pixelSizeAt",value:function(e){return this.ready?e?((0,Hu.g)(e,eY,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(eY)):0:(Eu.a.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}},{key:"overlayPixelSizeInMapUnits",value:function(e){var t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}},{key:"hitTest",value:function(e,t){if(!this.ready)return Eu.a.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;var r=(0,Ju.A)(e)?(0,Ju.B)(this,e):e,n=(0,zu.i)(r.x,r.y),i=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;i.requiresGroundFeedback=!0,i.enableDraped=!0;var a=(0,qu.g)(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=qu.J.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(n,a,i);var o=this._intersectResultsToHits(a.results.all,i.graphics),s=a.results.ground,l=ZX(s,this),u=(0,Nu.r)(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,c={screenPoint:r,results:o,ground:{mapPoint:this._intersectResultToMapPoint(s),distance:(0,qu.P)(s)?s.distanceInRenderSpace:0,layer:u}};return Ac.t.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),Promise.resolve(c)}},{key:"popupHitTest",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,HX(this,t);case 2:return r=e.sent,n=r.results,i=r.ground,a=null,e.abrupt("return",(!(0===n.length||Math.abs((0,Nu.v)(n[0].distance,0)-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(a=i.mapPoint),{results:n,screenPoint:t,mapPoint:a}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"goTo",value:function(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}},{key:"whenAnalysisView",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,Nu.t)(t.parent)){e.next=2;break}throw new Eu.s("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 2:e.t0=t.parent.type,e.next="line-of-sight"===e.t0||"dimension"===e.t0?5:8;break;case 5:return e.next=7,this.whenLayerView(t.parent);case 7:return e.abrupt("return",e.sent.whenAnalysisView());case 8:return e.abrupt("return",this.analysisViewManager.whenAnalysisView(t));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"whenLayerView",value:function(e){return(0,_u.Z)((0,bu.Z)(n.prototype),"whenLayerView",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(r);case 5:return n=e.sent,e.abrupt("return",(0,Ju.C)(n,r,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_takeScreenshot",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(r);case 5:return n=e.sent,e.abrupt("return",(0,Ju.D)(n,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_completeSettings",value:function(e){var t=(0,Ju.V)(e,this);return t.pixelRatio/=this.state.pixelRatio,(0,Ju.W)(t,this.supersampleScreenshotsEnabled,this.padding)}},{key:"_pixelFormat",value:function(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}},{key:"test",get:function(){var e=this;return{takeScreenshot:function(t){return e._takeScreenshot(t)}}}},{key:"takeScreenshotWithObjectAndLayerId",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var r,n,i,a;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,Nu.h)("enable-feature:objectAndLayerId-rendering")){e.next=2;break}throw new Error("has enable-feature:objectAndLayerId-rendering must be true");case 2:return r=this._completeSettings(t),e.next=5,this.whenReady();case 5:return e.next=7,this._stage.renderView.takeScreenshotWithOID(r);case 7:return n=e.sent,i=(0,Ju.C)(n[0],r,this._pixelFormat()),(a=this._completeSettings(t)).format="png",e.abrupt("return",[i,(0,Ju.C)(n[1],a,this._pixelFormat())]);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getColorToObjectAndLayerIdMapping",value:function(){if(!(0,Nu.h)("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView._objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}},{key:"addUpdatingPromise",value:function(e){return this.updatingHandles.addPromise(e)}},{key:"importLayerView",value:function(e){return $h(e)}},{key:"hasLayerViewModule",value:function(e){return Jh(e)}},{key:"forceDOMReadyCycle",value:function(){this.forceReadyCycle()}},{key:"getDefaultSpatialReference",value:function(){var e,t,r,n;return this.map&&"initialViewProperties"in this.map&&(null===(e=this.map)||void 0===e||null===(t=e.initialViewProperties)||void 0===t?void 0:t.spatialReference)||(null===(r=this.defaultsFromMap)||void 0===r?void 0:r.spatialReference)||(null===(n=this.defaultsFromMap)||void 0===n?void 0:n.ready)&&this._initialDefaultSpatialReference||null}},{key:"validate",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){var t;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,Ju.E)(this.type),(0,Nu.h)("safari")&&(0,Nu.h)("safari")<9&&(t=new Eu.s("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:(0,Nu.h)("safari")})),!(0,Nu.r)(t)){e.next=3;break}throw Eu.a.getLogger(this.declaredClass).warn("#validate()",t.message),t;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_predeterminedViewingMode",get:function(){var e,t,r=this._isOverridden("viewingMode")?this._get("viewingMode"):null!==(e=this.map&&"initialViewProperties"in this.map?null===(t=this.map.initialViewProperties)||void 0===t?void 0:t.viewingMode:null)&&void 0!==e?e:null;return(0,Nu.r)(r)?(0,ic.o)(r):null}},{key:"getSpatialReferenceSupport",value:function(e){var t=e.spatialReference,r=e.layer,n=this._predeterminedViewingMode;if((0,Nu.r)(n))return this._validateSpatialReferenceForViewingMode(t,r,n)?{constraints:this._makeSpatialReferenceConstraints(t,r,n)}:null;var i=this._validateSpatialReferenceForViewingMode(t,r,ic.l.Local),a=this._validateSpatialReferenceForViewingMode(t,r,ic.l.Global);return i||a?i&&a?{constraints:this._makeSpatialReferenceConstraints(t,r,null)}:i?{constraints:this._makeSpatialReferenceConstraints(t,r,ic.l.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,r,ic.l.Global)}:null}},{key:"_validateSpatialReferenceForViewingMode",value:function(e,t,r){return!!(0,qu.r)(e,r)&&(!!(0,Nu.t)(t)||!!(0,$u.r)(t)||(!(0,$u.t)(t)||!(0,Nu.t)(hF(t,e,r)))&&(!(0,$u.n)(t)||r!==ic.l.Global))}},{key:"_makeSpatialReferenceConstraints",value:function(e,t,r){if((0,Nu.t)(t))return[{spatialReference:e,viewingMode:r}];var n=e.isWebMercator,i=e.isWGS84;return(0,$u.r)(t)&&(n||i)?i&&r!==ic.l.Local&&null!==cF(t.tileInfo,t.fullExtent,e,ic.l.Global)?[{spatialReference:n?Yu.k.WGS84:Yu.k.WebMercator,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:Yu.k.WebMercator,viewingMode:r}]:(0,$u.t)(t)||(0,$u.n)(t)||!n&&!i?(0,$u.t)(t)&&n&&r!==ic.l.Global?[{spatialReference:e,viewingMode:r},{spatialReference:Yu.k.WGS84,viewingMode:ic.l.Local}]:[{spatialReference:e,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:n?Yu.k.WGS84:Yu.k.WebMercator,viewingMode:r}]}},{key:"_validateSpatialReference",value:function(e){var t=(0,Nu.r)(this.getSpatialReferenceSupport({spatialReference:e})),r=this._predeterminedViewingMode;return t||((0,Nu.r)(r)?Eu.a.getLogger(this.declaredClass).warnOnce("Spatial reference defined on view not supported in ".concat((0,ic.a)(r)," viewing mode.")):e.isGeographic&&Eu.a.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),t}},{key:"whenReady",value:function(){var e=this;return new Promise((function(t){e.ready?t(e):e._resolveWhenReady.push(t)}))}},{key:"computeMapPointFromVec3d",value:function(e,t){var r=this.spatialReference||Yu.k.WGS84;return(0,Hu.j)(e,this.renderSpatialReference,e,r)||(r=Yu.k.WGS84,(0,Hu.j)(e,this.renderSpatialReference,e,r)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=r):t=new Yu.w(e,r),t}},{key:"trackGraphicState",value:function(e){if(!e.graphic)return Eu.a.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;var t=this.getViewForGraphic(e.graphic),r=null,n=!1,i=function(t){var i;!n&&(0,Nu.r)(t)&&"processor"in t&&"graphics-3d"===(null===(i=t.processor)||void 0===i?void 0:i.type)&&t.processor.graphicsCore&&(r=t.processor.graphicsCore.trackGraphicState(e))};return(0,Nu.r)(t)?i(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((function(e){return i(e)}),(function(){})).catch((function(){})),{remove:function(){n=!0,(0,Nu.r)(r)&&(r.remove(),r=null)}}}},{key:"highlight",value:function(e){var t=this;if(Array.isArray(e))return(0,Eu.F)(e.map((function(e){return t.highlight(e)})));if(Lu.j.isCollection(e))return(0,Eu.F)(e.toArray().map((function(e){return t.highlight(e)})));var r=this.getViewForGraphic(e);return r&&"highlight"in r?r.highlight(e):(0,Eu.D)()}},{key:"maskOccludee",value:function(e){if(!e)return Eu.a.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;var t=this.getViewForGraphic(e),r=null,n=!1,i=function(t){!n&&(0,Nu.r)(t)&&(0,xh.t)(t)&&(r=t.maskOccludee(e))};return(0,Nu.r)(t)?i(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((function(e){return i(e)}),(function(){})).catch((function(){})),{remove:function(){n=!0,(0,Nu.r)(r)&&(r.remove(),r=null)}}}},{key:"getViewForGraphic",value:function(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((function(t){return t.layer===e.layer})):null}},{key:"graphicChanged",value:function(e){(0,Nu.r)(this.graphicsView)&&this.graphicsView.graphicChanged(e)}},{key:"whenViewForGraphic",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t,r){var n=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.layer!==this){e.next=4;break}return e.next=3,(0,Fu.j)((function(){return n.graphicsView}));case 3:return e.abrupt("return",this.graphicsView);case 4:if(t.layer&&this.map){e.next=6;break}throw new Eu.s("no-view-for-graphic");case 6:return e.abrupt("return",r&&r.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((function(e,r){var i=n.map.allLayers.on("change",(function(a){a.added.includes(t.layer)&&(i.remove(),n.whenLayerView(t.layer).then(e,r))}))})):this.whenLayerView(t.layer));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"externalToInternalIntersectOptions",value:function(e){var t=this._externalToInternalRenderItems(e.include,XX.INCLUDE),r=this._externalToInternalRenderItems(e.exclude,XX.EXCLUDE);return{include:t.layerUids,exclude:r.layerUids,graphics:{include:t.graphicUids,exclude:r.graphicUids}}}},{key:"_intersectResultToMapPoint",value:function(e,t){return e.getIntersectionPoint(eY)?(t=this.computeMapPointFromVec3d(eY,t),e.intersector===qu.M.TERRAIN&&this.basemapTerrain&&(t.z=(0,Nu.v)((0,qu.C)(this.basemapTerrain,t),0)),t):null}},{key:"_intersectResultsToHits",value:function(e,t){for(var r=new Array,n=null,i=0;i<e.length;i++){var a=e[i],o=ZX(a,this);if((0,Nu.r)(o)&&(o===this.map.ground||"type"in o&&"integrated-mesh"===o.type))break;var s=FX(a,this);if(!(0,Nu.t)(s)){if("graphic"===s.type){if((0,Nu.t)(n)&&i!==e.length-1&&(n=new Set),(0,Nu.r)(n)){var l=this._getGraphicFilterUid(s.graphic);if(n.has(l))continue;n.add(l)}if(!this._testGraphicUidFilter(t,s.graphic))continue}var u=this._intersectResultToMapPoint(a),c=a.distanceInRenderSpace;r.push((0,Tu.Z)((0,Tu.Z)({},s),{},{mapPoint:u,distance:c}))}}return r}},{key:"_getGraphicFilterUid",value:function(e){var t=e.sourceLayer,r=e.layer,n=t&&"objectIdField"in t?t:r&&"objectIdField"in r?r:t;if(n){var i,a=null!==(i=n.objectIdField)&&void 0!==i?i:Ju.X,o=e.attributes[a];if(o)return"o-".concat(n.id,"-").concat(o)}return"u-".concat(e.uid)}},{key:"_testGraphicUidFilter",value:function(e,t){var r=this._getGraphicFilterUid(t);return(0,Nu.t)(e)||((0,Nu.t)(e.include)||e.include.has(r))&&((0,Nu.t)(e.exclude)||!e.exclude.has(r))}},{key:"_externalToInternalRenderItems",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{layerUids:null,graphicUids:null};if(!e)return r;if(e instanceof Iu.g)JX(r,this._getGraphicFilterUid(e)),t===XX.INCLUDE&&((0,Nu.r)(this.graphicsView)&&e.layer===this?KX(r,this.graphicsView.processor.layer.id):e.layer&&KX(r,e.layer.uid));else if((0,Eu.aa)(e)){var n,i=(0,Cu.Z)(e);try{for(i.s();!(n=i.n()).done;){var a=n.value;a===this.graphics&&(0,Nu.r)(this.graphicsView)?KX(r,this.graphicsView.processor.layer.id):a===this.map.ground?KX(r,Ic.j):this._externalToInternalRenderItems(a,t,r)}}catch(o){i.e(o)}finally{i.f()}}else"uid"in e&&KX(r,e.uid);return r}},{key:"_initBasemapTerrain",value:function(){this._set("basemapTerrain",new hG({view:this})),this._set("elevationProvider",new nN({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}},{key:"_exitBasemapTerrain",value:function(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}},{key:"_initGlobe",value:function(){var e=this;this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new iz({view:this})),this._set("featureTiles",new ZZ({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));var t=function(){var t,r=null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent;if(e.clippingArea||r)if(r&&e.basemapTerrain.spatialReference){var n=(0,Nu.r)(e.basemapTerrain.extent)&&(0,Nu.r)(e.basemapTerrain.spatialReference)?(0,Hu.r)((0,ju.f)(e.basemapTerrain.extent,e.basemapTerrain.spatialReference),e.spatialReference):null;(0,Nu.r)(e.clippingArea)?e.featureTiles.filterExtent=e.clippingArea.intersection(n):e.featureTiles.filterExtent=n}else e.featureTiles.filterExtent=e.clippingArea;else e.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add((function(){return Ac.t.FEATURE_TILE_TREE_SHOW_TILES}),(function(t){t&&e.featureTiles&&!e._featureTreeDebugger?e.updatingHandles.addPromise(r.e(2298).then(r.bind(r,62298))).then((function(t){var r=t.FeatureTileTree3DDebugger;!e._featureTreeDebugger&&Ac.t.FEATURE_TILE_TREE_SHOW_TILES&&(e._featureTreeDebugger=new r({view:e}))})):t||!e._featureTreeDebugger||Ac.t.FEATURE_TILE_TREE_SHOW_TILES||(e._featureTreeDebugger.destroy(),e._featureTreeDebugger=null)}),Fu.w),this.updatingHandles.add((function(){return e.clippingArea}),t,Fu.w),this.updatingHandles.add((function(){return e.basemapTerrain.extent}),t,Fu.w)],"feature-tiles"),this.stateManager.init()}},{key:"_exitGlobe",value:function(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}},{key:"_initCoordinateSystem",value:function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new cN(this.map,t));var r=this.state.isGlobal,n=Dh(r,t);n!==this.renderSpatialReference&&(this._set("renderCoordsHelper",xN.create(this.state.viewingMode,n)),r||this.handles.add((0,Fu.l)((function(){var t;return null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent}),(function(t){var r=e.renderCoordsHelper.spatialReference;t&&(0!==t[0]||0!==t[1]||0!==t[2]||0!==t[3])&&(0,Hu.v)(t,e.basemapTerrain.spatialReference,rY,r)&&(e.renderCoordsHelper.extent=rY)}),Fu.U),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(qu.O/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}},{key:"_exitCoordinateSystem",value:function(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}},{key:"_updatingChanged",value:function(){this.notifyChange("updating")}},{key:"_updateUpdatingMonitors",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,Nu.r)(t)&&t.type===Lu.E.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((function(t){t.destroyed||(e.handles.add((0,Fu.l)((function(){return[t.updating,t.updatingProgress]}),(function(){return e._updatingChanged()}),Fu.U),"updatingMonitors"),t.when((function(){return e._updatingChanged()}),(function(){return e._updatingChanged()})))})),this._updatingChanged())}},{key:"_prepareScreenshotOverlay",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(){return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.overlay,!e.t0){e.next=4;break}return e.next=4,this.overlay.prepare();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_renderScreenshotOverlay",value:function(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;var r=e.getContext("2d");return r.putImageData(t,0,0),this.overlay.renderCanvas(e),r.getImageData(0,0,t.width,t.height)}},{key:"_initStage",value:function(){var e=this,t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:function(){return e._prepareScreenshotOverlay()},renderOverlay:function(t,r){return e._renderScreenshotOverlay(t,r)}}},r=new qZ(this.state.viewingMode,(function(t){return e._stage.layers.forAll(t)}),this);this._set("sceneIntersectionHelper",r);var n=(0,Zu.a)(this.surface),i=this.resourceController,a=this.state,o=this.renderSpatialReference;this._stage=new kX({options:t,container:n,resourceController:i,state:a,sceneIntersectionHelper:r,renderSR:o}),this._stage.renderView.setRenderParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=(0,Eu.C)(this._stage.renderView.canvas,"webglcontextlost",(function(){return e.fatalError=new Eu.s("webgl-context-lost")})),this.handles.add([this.updatingHandles.add((function(){return e.qualitySettings.antialiasingEnabled}),(function(){return e._stage.renderView.setRenderParameters({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}),Fu.h),this.updatingHandles.add((function(){return e.qualitySettings.highQualityTransparency}),(function(){return e._stage.renderView.setRenderParameters({highQualityTransparency:e.qualitySettings.highQualityTransparency})}),Fu.h),(0,Fu.l)((function(){return e.magnifier}),(function(t){return e._stage.renderView.magnifier=t}),Fu.w)],"stage");var s=function(){e._stage.renderView.setRenderParameters({defaultHighlightOptions:uN.toEngineOptions(e.highlightOptions)})};this.handles.add(this.updatingHandles.add((function(){return[e.highlightOptions.color,e.highlightOptions.haloColor,e.highlightOptions.haloOpacity,e.highlightOptions.fillOpacity,e.highlightOptions.shadowOpacity,e.highlightOptions.shadowColor,e.highlightOptions.shadowDifference]}),s),"stage"),s(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(qu.O/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}},{key:"_exitStage",value:function(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}},{key:"_initSurface",value:function(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new kF({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}},{key:"_exitSurface",value:function(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}},{key:"_createGraphicsViewIfNeeded",value:function(){var e=this;if(!this.graphicsView&&!this._createGraphicsViewController&&0!==this.graphics.length){this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;var t=function(){e._createGraphicsViewController=null,e._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}}},{key:"_createGraphicsViewAsync",value:function(){var e=(0,Ou.Z)((0,Su.Z)().mark((function e(t){var n,i=this;return(0,Su.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(6419),r.e(9809),r.e(2002)]).then(r.bind(r,32002));case 2:return n=e.sent.default,(0,Eu.f)(t),e.next=6,(0,Fu.j)((function(){var e;return null===(e=i.basemapTerrain)||void 0===e?void 0:e.ready}),t);case 6:this._set("graphicsView",new n({view:this}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_disposeGraphicsView",value:function(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),(0,Nu.r)(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}},{key:"_startup",value:function(){var e=this,t=(0,ic.o)(this.viewingMode);if(t===ic.l.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.handles.add((0,Fu.a)((function(){return e.graphics}),"after-changes",(function(){return e._createGraphicsViewIfNeeded()})),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){var r=this.get("map.initialViewProperties.environment");r&&(this.environment=r)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();var n=this._resolveWhenReady;this._resolveWhenReady=[],n.forEach((function(t){return t(e)}))}},{key:"_teardown",value:function(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}},{key:"_updateDefaultToMapOptions",value:function(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Ic.j);var e,t=(0,Cu.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var r=e.value;"integrated-mesh"===r.type&&this._defaultToMapOptions.include.add(r.uid)}}catch(n){t.e(n)}finally{t.f()}}}},{key:"_updateDefaultHitTestOptions",value:function(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Ic.j);var e,t=(0,Cu.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var r=e.value;"integrated-mesh"===r.type&&r.opacity<1&&this._defaultToMapOptions.exclude.add(r.uid)}}catch(n){t.e(n)}finally{t.f()}}}},{key:"addVoxelLayerViewToWasm",value:function(e){var t=this;return(0,Nu.t)(this.voxelWasm)?((0,Nu.t)(this.voxelWasmPromise)&&(this.voxelWasmPromise=r.e(4692).then(r.bind(r,44692)).then((function(e){return t.voxelWasm=new e.default(t),t.voxelWasm}))),this.voxelWasmPromise.then((function(t){return t.addVoxelLayer(e)}))):this.voxelWasm.addVoxelLayer(e)}},{key:"removeVoxelLayerViewFromWasm",value:function(e){(0,Nu.r)(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(e)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}}]),n}((0,Ju.w)((0,Ju.z)((0,Ju.o)(Ju.J))));function KX(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function JX(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function $X(e,t){return(0,Nu.r)(e)&&(0,Hu.A)(e.spatialReference,t)?(0,Hu.r)(e,t):null}QX.type="3d",(0,Eu.e)([(0,Eu.y)()],QX.prototype,"_userClippingArea",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"_resourceController",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"_stage",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"deconflictor",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"labeler",void 0),(0,Eu.e)([(0,Eu.y)((0,Bu.a)(Ju.T,"analyses"))],QX.prototype,"analyses",void 0),(0,Eu.e)([(0,Eu.y)({type:Ju.p,readOnly:!0})],QX.prototype,"animation",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"basemapTerrain",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"elevationProvider",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"camera",null),(0,Eu.e)([(0,Eu.y)({type:Du.y})],QX.prototype,"contentCamera",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"canvas",void 0),(0,Eu.e)([(0,Eu.y)({type:Yu.w})],QX.prototype,"center",null),(0,Eu.e)([(0,Eu.y)({type:tc.w})],QX.prototype,"clippingArea",null),(0,Eu.e)([(0,Eu.y)({type:pd})],QX.prototype,"constraints",void 0),(0,Eu.e)([(0,Eu.y)({type:tc.w,readOnly:!0})],QX.prototype,"renderDataExtent",null),(0,Eu.e)([(0,Eu.y)({type:tc.w,readOnly:!0})],QX.prototype,"dataExtent",null),(0,Eu.e)([(0,Eu.y)({type:tc.w,readOnly:!0})],QX.prototype,"_groundAndLayersExtent",null),(0,Eu.e)([(0,Eu.y)({value:null,type:Pd})],QX.prototype,"environment",null),(0,Eu.e)([(0,Eu.c)("environment")],QX.prototype,"castEnvironment",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"environmentManager",void 0),(0,Eu.e)([(0,Eu.y)({type:tc.w})],QX.prototype,"extent",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"floors",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"screenCenter",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"frustum",null),(0,Eu.e)([(0,Eu.y)({type:Number,readOnly:!0})],QX.prototype,"fullOpacity",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"graphicsView",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"analysisViewManager",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"groundView",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],QX.prototype,"initialExtentRequired",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"_defaultsFromMapSettings",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"interacting",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"stationary",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"navigating",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"map",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"mapCoordsHelper",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"padding",null),(0,Eu.e)([(0,Eu.y)({type:iz,readOnly:!0})],QX.prototype,"pointsOfInterest",void 0),(0,Eu.e)([(0,Eu.y)({type:ZZ,readOnly:!0})],QX.prototype,"featureTiles",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"_featureTreeDebugger",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],QX.prototype,"screenSizePerspectiveEnabled",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],QX.prototype,"deactivatedWebGLExtensions",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],QX.prototype,"debugWebGLExtensions",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],QX.prototype,"renderCanvas",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],QX.prototype,"state",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"inputManager",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"stateManager",void 0),(0,Eu.e)([(0,Eu.y)({type:["low","medium","high"]})],QX.prototype,"qualityProfile",null),(0,Eu.e)([(0,Eu.y)({type:gN,get:function(){var e=this._get("qualitySettings");return e||(e=new gN,sN.apply(this.qualityProfile,e)),e}})],QX.prototype,"qualitySettings",void 0),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"slicePlane",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"typeSpecificPreconditionsReady",null),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"renderCoordsHelper",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"sceneIntersectionHelper",void 0),(0,Eu.e)([(0,Eu.y)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],QX.prototype,"resolution",null),(0,Eu.e)([(0,Eu.y)({type:Number})],QX.prototype,"scale",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"heightModelInfo",null),(0,Eu.e)([(0,Eu.y)()],QX.prototype,"spatialReference",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,constructOnly:!0})],QX.prototype,"alphaCompositingEnabled",void 0),(0,Eu.e)([(0,Eu.y)({constructOnly:!0})],QX.prototype,"preserveDrawingBufferEnabled",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean})],QX.prototype,"supersampleScreenshotsEnabled",void 0),(0,Eu.e)([(0,Eu.y)({readOnly:!0})],QX.prototype,"type",void 0),(0,Eu.e)([(0,Eu.y)({type:YX})],QX.prototype,"ui",void 0),(0,Eu.e)([(0,Eu.y)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],QX.prototype,"updating",null),(0,Eu.e)([(0,Eu.y)({type:Number,readOnly:!0,dependsOn:["updating"]})],QX.prototype,"updatingProgress",void 0),(0,Eu.e)([(0,Eu.y)({type:["global","local"]})],QX.prototype,"viewingMode",null),(0,Eu.e)([(0,Eu.y)({type:Du.u})],QX.prototype,"viewpoint",null),(0,Eu.e)([(0,Eu.y)({type:Number})],QX.prototype,"zoom",null),(0,Eu.e)([(0,Eu.y)({type:uN})],QX.prototype,"highlightOptions",void 0),QX=(0,Eu.e)([(0,Eu.n)("esri.views.SceneView")],QX),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(XX||(XX={}));var eY=(0,Vu.n)(),tY=(0,zu.i)(),rY=(0,ju.u)(),nY=QX,iY=Object.freeze({__proto__:null,default:nY})},58492:function(e,t,r){function n(e,t,r){return{objectId:e,target:t,distance:r,type:"vertex"}}function i(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];return{objectId:e,target:t,distance:r,type:"edge",start:n,end:i,draped:a}}r.d(t,{e:function(){return i},t:function(){return n}})},26789:function(e,t,r){r.d(t,{r:function(){return h}});var n=r(29439),i=r(15671),a=r(43144),o=r(60136),s=r(29388),l=r(26313),u=r(64095),c=r(51732),h=function(e){(0,o.Z)(r,e);var t=(0,s.Z)(r);function r(e,n,a,o,s,l){var u,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:s,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:l;return(0,i.Z)(this,r),(u=t.call(this)).triangleCountReportedInDebug=0,u.triangleCount=0,u.texture=null,u.key=new c.e(e),u.resolution=n,u.x=a,u.y=o,u.width=s,u.height=l,u.rangeX=h,u.rangeY=d,u}return(0,a.Z)(r,[{key:"destroy",value:function(){this.texture&&(this.texture.dispose(),this.texture=null)}},{key:"setTransform",value:function(e){var t=this.resolution/(e.resolution*e.pixelRatio),r=this.transforms.tileMat3,i=e.toScreenNoRotation([0,0],[this.x,this.y]),a=(0,n.Z)(i,2),o=a[0],s=a[1],u=this.width/this.rangeX*t,c=this.height/this.rangeY*t;(0,l.s)(r,u,0,0,0,c,0,o,s,1),(0,l.i)(this.transforms.dvs,e.displayViewMat3,r)}}]),r}(u.r)},2467:function(e,t,r){r.d(t,{c:function(){return C},i:function(){return w},l:function(){return x},m:function(){return E},p:function(){return M},s:function(){return b}});var n=r(11752),i=r(61120),a=r(60136),o=r(29388),s=r(29439),l=r(37762),u=r(43144),c=r(15671),h=r(93661),d=r(26313),f=r(43066),p=r(75257),v=r(31698),m=r(93122),y=r(65636),g=r(26789),_=(0,u.Z)((function e(t){(0,c.Z)(this,e),this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t})),b=(0,u.Z)((function e(){(0,c.Z)(this,e),this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}));function x(e,t,r,n,i,a){var o=r-i;if(o>=0)return(t>>o)+(n-(a<<o))*(e>>o);var s=-o;return t-(a-(n<<s))*(e>>s)<<s}var w=function(){function e(t,r,n){(0,c.Z)(this,e),this._rows=Math.ceil(r/n),this._columns=Math.ceil(t/n),this._cellSize=n,this.cells=new Array(this._rows);for(var i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(var a=0;a<this._columns;a++)this.cells[i][a]=[]}}return(0,u.Z)(e,[{key:"getCell",value:function(e,t){var r=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),n=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][n]||null}},{key:"getCellSpan",value:function(e,t,r,n){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(n/this._cellSize),0),this.rows-1)]}},{key:"cellSize",get:function(){return this._cellSize}},{key:"columns",get:function(){return this._columns}},{key:"rows",get:function(){return this._rows}}]),e}();function T(e,t,r,n,i,a){for(var o=t[n++],s=0;s<o;s++){var l=new _(a);l.xTile=t[n++],l.yTile=t[n++],l.hash=t[n++],l.priority=t[n++];for(var u=t[n++],c=0;c<u;c++){var h=t[n++],d=t[n++],f=t[n++],p=t[n++],v=!!t[n++],m=t[n++],y=r[n++],g=r[n++],b=t[n++],x=t[n++];l.colliders.push({xTile:h,yTile:d,dxPixels:f,dyPixels:p,hard:v,partIndex:m,width:b,height:x,minLod:y,maxLod:g})}for(var w=e[n++],T=0;T<w;T++)l.textVertexRanges.push([e[n++],e[n++]]);for(var C=e[n++],S=0;S<C;S++)l.iconVertexRanges.push([e[n++],e[n++]]);i.push(l)}return n}function C(e,t,r){var n,i=(0,l.Z)(e.symbols);try{for(i.s();!(n=i.n()).done;){var a=(0,s.Z)(n.value,2),o=a[0];S(e,t,r,a[1],o)}}catch(u){i.e(u)}finally{i.f()}}function S(e,t,r,n,i){var a=e.layerData.get(i);if(a.type===p.I.SYMBOL){var o,u=(0,l.Z)(n);try{for(u.s();!(o=u.n()).done;){var c=o.value,h=c.unique,d=void 0;if(c.selectedForRendering){var f=h.parts[0],v=f.startOpacity,m=f.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===m;var y=r?Math.floor(127*v)|m<<7:m?255:0;d=y<<24|y<<16|y<<8|y}else d=0;var g,_=(0,l.Z)(c.iconVertexRanges);try{for(_.s();!(g=_.n()).done;)for(var b=(0,s.Z)(g.value,2),x=b[0],w=b[1],T=x;T<x+w;T+=4)a.iconOpacity[T/4]=d}catch(I){_.e(I)}finally{_.f()}if(c.selectedForRendering){var C=h.parts[1],S=C.startOpacity,O=C.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===O;var P=r?Math.floor(127*S)|O<<7:O?255:0;d=P<<24|P<<16|P<<8|P}else d=0;var R,A=(0,l.Z)(c.textVertexRanges);try{for(A.s();!(R=A.n()).done;)for(var k=(0,s.Z)(R.value,2),E=k[0],D=k[1],M=E;M<E+D;M+=4)a.textOpacity[M/4]=d}catch(I){A.e(I)}finally{A.f()}}}catch(I){u.e(I)}finally{u.f()}a.lastOpacityUpdate=t,a.opacityChanged=!0}}var O=function(){function e(t,r){(0,c.Z)(this,e),this.layerUIDs=[],this.isDestroyed=!1,this._data=t,this.memoryUsed=t.byteLength;var n=1,i=new Uint32Array(t);this.layerUIDs=[];for(var a=i[n++],o=0;o<a;o++)this.layerUIDs[o]=i[n++];this.bufferDataOffset=n,r&&(this.layer=r.getStyleLayerByUID(this.layerUIDs[0]))}return(0,u.Z)(e,[{key:"isPreparedForRendering",get:function(){return(0,h.t)(this._data)}},{key:"offset",get:function(){return this.bufferDataOffset}},{key:"destroy",value:function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}},{key:"prepareForRendering",value:function(e){(0,h.t)(this._data)||(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}]),e}(),P=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n){var i;(0,c.Z)(this,r),(i=t.call(this,e,n)).type=p.I.LINE,i.lineIndexStart=0,i.lineIndexCount=0;var a=new Uint32Array(e),o=i.bufferDataOffset;i.lineIndexStart=a[o++],i.lineIndexCount=a[o++];var s=a[o++];if(s>0){for(var l=new Map,u=0;u<s;u++){var h=a[o++],d=a[o++],f=a[o++];l.set(h,[d,f])}i.patternMap=l}return i.bufferDataOffset=o,i}return(0,u.Z)(r,[{key:"hasData",value:function(){return this.lineIndexCount>0}},{key:"triangleCount",value:function(){return this.lineIndexCount/3}},{key:"doDestroy",value:function(){(0,h.r)(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),(0,h.r)(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),(0,h.r)(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,r){var n=new Uint32Array(t),i=new Int32Array(n.buffer),a=n[r++];this.lineVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,a)),r+=a;var o=n[r++];this.lineIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,o)),r+=o;var s=this.layer.lineMaterial;this.lineVertexArrayObject=new v.b(e,s.getAttributeLocations(),s.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}]),r}(O),R=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n){var i;(0,c.Z)(this,r),(i=t.call(this,e,n)).type=p.I.FILL,i.fillIndexStart=0,i.fillIndexCount=0,i.outlineIndexStart=0,i.outlineIndexCount=0;var a=new Uint32Array(e),o=i.bufferDataOffset;i.fillIndexStart=a[o++],i.fillIndexCount=a[o++],i.outlineIndexStart=a[o++],i.outlineIndexCount=a[o++];var s=a[o++];if(s>0){for(var l=new Map,u=0;u<s;u++){var h=a[o++],d=a[o++],f=a[o++];l.set(h,[d,f])}i.patternMap=l}return i.bufferDataOffset=o,i}return(0,u.Z)(r,[{key:"hasData",value:function(){return this.fillIndexCount>0||this.outlineIndexCount>0}},{key:"triangleCount",value:function(){return(this.fillIndexCount+this.outlineIndexCount)/3}},{key:"doDestroy",value:function(){(0,h.r)(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),(0,h.r)(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),(0,h.r)(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,(0,h.r)(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),(0,h.r)(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),(0,h.r)(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,r){var n=new Uint32Array(t),i=new Int32Array(n.buffer),a=n[r++];this.fillVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,a)),r+=a;var o=n[r++];this.fillIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,o)),r+=o;var s=n[r++];this.outlineVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,s)),r+=s;var l=n[r++];this.outlineIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l)),r+=l;var u=this.layer,c=u.fillMaterial,h=u.outlineMaterial;this.fillVertexArrayObject=new v.b(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new v.b(e,h.getAttributeLocations(),h.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}]),r}(O),A=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,i){var a;(0,c.Z)(this,r),(a=t.call(this,e,n)).type=p.I.SYMBOL,a.iconPerPageElementsMap=new Map,a.glyphPerPageElementsMap=new Map,a.symbolInstances=[],a.isIconSDF=!1,a.opacityChanged=!1,a.lastOpacityUpdate=0,a.symbols=[];var o=new Uint32Array(e),s=new Int32Array(e),l=new Float32Array(e),u=a.bufferDataOffset;a.isIconSDF=!!o[u++];for(var h=o[u++],d=0;d<h;d++){var f=o[u++],v=o[u++],m=o[u++];a.iconPerPageElementsMap.set(f,[v,m])}for(var y=o[u++],g=0;g<y;g++){var _=o[u++],b=o[u++],x=o[u++];a.glyphPerPageElementsMap.set(_,[b,x])}var w=o[u++],C=o[u++];return a.iconOpacity=new Int32Array(w),a.textOpacity=new Int32Array(C),u=T(o,s,l,u,a.symbols,i),a.bufferDataOffset=u,a}return(0,u.Z)(r,[{key:"hasData",value:function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}},{key:"triangleCount",value:function(){var e,t=0,r=(0,l.Z)(this.iconPerPageElementsMap);try{for(r.s();!(e=r.n()).done;){var n=(0,s.Z)(e.value,2);n[0];t+=n[1][1]}}catch(u){r.e(u)}finally{r.f()}var i,a=(0,l.Z)(this.glyphPerPageElementsMap);try{for(a.s();!(i=a.n()).done;){var o=(0,s.Z)(i.value,2);o[0];t+=o[1][1]}}catch(u){a.e(u)}finally{a.f()}return t/3}},{key:"doDestroy",value:function(){(0,h.r)(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),(0,h.r)(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),(0,h.r)(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),(0,h.r)(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,(0,h.r)(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),(0,h.r)(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),(0,h.r)(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),(0,h.r)(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}},{key:"updateOpacityInfo",value:function(){if(this.opacityChanged){this.opacityChanged=!1;var e=(0,h.e)(this.iconOpacity),t=(0,h.e)(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e,0,0,e.length);var r=(0,h.e)(this.textOpacity),n=(0,h.e)(this.textOpacityBuffer);r.length>0&&r.byteLength===n.size&&n.setSubData(r,0,0,r.length)}}},{key:"doPrepareForRendering",value:function(e,t,r){var n=new Uint32Array(t),i=new Int32Array(n.buffer),a=n[r++];this.iconVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,a)),r+=a;var o=n[r++];this.iconIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,o)),r+=o;var s=n[r++];this.textVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,s)),r+=s;var l=n[r++];this.textIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l)),r+=l,this.iconOpacityBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,(0,h.e)(this.iconOpacity).buffer),this.textOpacityBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,(0,h.e)(this.textOpacity).buffer);var u=this.layer,c=u.iconMaterial,d=u.textMaterial;this.iconVertexArrayObject=new v.b(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new v.b(e,d.getAttributeLocations(),d.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}]),r}(O),k=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n){var i;(0,c.Z)(this,r),(i=t.call(this,e,n)).type=p.I.CIRCLE,i.circleIndexStart=0,i.circleIndexCount=0;var a=new Uint32Array(e),o=i.bufferDataOffset;return i.circleIndexStart=a[o++],i.circleIndexCount=a[o++],i.bufferDataOffset=o,i}return(0,u.Z)(r,[{key:"hasData",value:function(){return this.circleIndexCount>0}},{key:"triangleCount",value:function(){return this.circleIndexCount/3}},{key:"doDestroy",value:function(){(0,h.r)(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),(0,h.r)(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),(0,h.r)(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,r){var n=new Uint32Array(t),i=new Int32Array(n.buffer),a=n[r++];this.circleVertexBuffer=v.E.createVertex(e,m.F.STATIC_DRAW,new Int32Array(i.buffer,4*r,a)),r+=a;var o=n[r++];this.circleIndexBuffer=v.E.createIndex(e,m.F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,o)),r+=o;var s=this.layer.circleMaterial;this.circleVertexArrayObject=new v.b(e,s.getAttributeLocations(),s.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}]),r}(O),E=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,i,a,o,s,l){var u,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;return(0,c.Z)(this,r),(u=t.call(this,e,n,i,a,o,s,4096,4096))._memCache=h,u.type="vector-tile",u._referenced=0,u._hasSymbolBuckets=!1,u._memoryUsedByLayerData=0,u.layerData=new Map,u.layerCount=0,u.status="loading",u.allSymbolsFadingOut=!1,u.lastOpacityUpdate=0,u.symbols=new Map,u.isCoverage=!1,u.neededForCoverage=!1,u.decluttered=!1,u.invalidating=!1,u.parentTile=null,u.childrenTiles=new Set,u._processed=!1,u._referenced=1,u.styleRepository=l,u.id=e.id,u}return(0,u.Z)(r,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<y.e}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<y.e)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"setData",value:function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}},{key:"deleteLayerData",value:function(e){var t,r=!1,n=(0,l.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(this.layerData.has(i)){var a=this.layerData.get(i);this._memoryUsedByLayerData-=a.memoryUsed,a.type===p.I.SYMBOL&&this.symbols.has(i)&&(this.symbols.delete(i),r=!0),a.destroy(),this.layerData.delete(i),this.layerCount--}}}catch(o){n.e(o)}finally{n.f()}(0,h.r)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),r&&this.emit("symbols-changed"),this.requestRender()}},{key:"processed",value:function(){return this._processed}},{key:"hasData",value:function(){return this.layerCount>0}},{key:"dispose",value:function(){"unloaded"!==this.status&&(D.delete(this),r._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}},{key:"release",value:function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}},{key:"retain",value:function(){++this._referenced}},{key:"referenced",get:function(){return this._referenced}},{key:"memoryUsage",get:function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}},{key:"changeDataImpl",value:function(e){var t=!1;if(e){var r=e.bucketsWithData,n=e.emptyBuckets,i=this._createRenderBuckets(r);if(n&&n.byteLength>0){var a,o=new Uint32Array(n),u=(0,l.Z)(o);try{for(u.s();!(a=u.n()).done;){var c=a.value;this._deleteLayerData(c)}}catch(x){u.e(x)}finally{u.f()}}var d,f=(0,l.Z)(i);try{for(f.s();!(d=f.n()).done;){var v=(0,s.Z)(d.value,2),m=v[0],y=v[1];this._deleteLayerData(m),y.type===p.I.SYMBOL&&(this.symbols.set(m,y.symbols),t=!0),this._memoryUsedByLayerData+=y.memoryUsed,this.layerData.set(m,y),this.layerCount++}}catch(x){f.e(x)}finally{f.f()}(0,h.r)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;var g,_=(0,l.Z)(this.layerData);try{for(_.s();!(g=_.n()).done;){var b=(0,s.Z)(g.value,2);b[0];b[1].type===p.I.SYMBOL&&(this._hasSymbolBuckets=!0)}}catch(x){_.e(x)}finally{_.f()}t&&this.emit("symbols-changed")}},{key:"attachWithContext",value:function(e){this.stage={context:e,trashDisplayObject:function(e){e.processDetach()},untrashDisplayObject:function(){return!1}}}},{key:"setTransform",value:function(e){(0,n.Z)((0,i.Z)(r.prototype),"setTransform",this).call(this,e);var t=this.resolution/(e.resolution*e.pixelRatio),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t,s=[0,0];e.toScreen(s,[this.x,this.y]);var l=this.transforms.tileUnitsToPixels;(0,d.r)(l),(0,d.M)(l,l,s),(0,d.h)(l,l,Math.PI*e.rotation/180),(0,d.f)(l,l,[a,o,1])}},{key:"_createTransforms",value:function(){return{dvs:(0,f.e)(),tileMat3:(0,f.e)(),tileUnitsToPixels:(0,f.e)()}}},{key:"_createRenderBuckets",value:function(e){var t,r=new Map,n=new Map,i=(0,l.Z)(e);try{for(i.s();!(t=i.n()).done;){var a,o=t.value,s=this._deserializeBucket(o,n),u=(0,l.Z)(s.layerUIDs);try{for(u.s();!(a=u.n()).done;){var c=a.value;r.set(c,s)}}catch(h){u.e(h)}finally{u.f()}}}catch(h){i.e(h)}finally{i.f()}return r}},{key:"_deserializeBucket",value:function(e,t){var r=t.get(e);if(r)return r;switch(new Uint32Array(e)[0]){case p.I.FILL:r=new R(e,this.styleRepository);break;case p.I.LINE:r=new P(e,this.styleRepository);break;case p.I.SYMBOL:r=new A(e,this.styleRepository,this);break;case p.I.CIRCLE:r=new k(e,this.styleRepository)}return t.set(e,r),r}},{key:"_deleteLayerData",value:function(e){if(this.layerData.has(e)){var t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}}}],[{key:"_destroyRenderBuckets",value:function(e){if(e){var t=new Set;e.forEach((function(e){t.has(e)||(e.destroy(),t.add(e))})),e.clear()}}}]),r}(g.r),D=new Map;function M(){D.forEach((function(e,t){console.log("\n".concat(t.key,":")),e[0].forEach((function(e){return console.log(e)})),console.log("========"),e[1].forEach((function(e){return console.log(e)}))}))}},63999:function(e,t,r){r.d(t,{i:function(){return s}});var n=r(1413),i=r(48848),a=r(93661),o=r(45184);function s(e,t,r,o,s){if((0,a.t)(e))return null;var l=e.referencesGeometry()&&s?u(t,o,s):t,c=e.repurposeFeature(l);try{return e.evaluate((0,n.Z)((0,n.Z)({},r),{},{$feature:c}))}catch(h){return i.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",h),null}}var l=new Map;function u(e,t,r){var a=r.transform,s=r.hasZ,u=r.hasM;l.has(t)||l.set(t,function(e){var t={};switch(e){case"esriGeometryPoint":return function(e,r,n,i){return(0,o.v)(r,t,e,n,i)};case"esriGeometryPolygon":return function(e,r,n,i){return(0,o.B)(r,t,e,n,i)};case"esriGeometryPolyline":return function(e,r,n,i){return(0,o.C)(r,t,e,n,i)};case"esriGeometryMultipoint":return function(e,r,n,i){return(0,o.q)(r,t,e,n,i)};default:return i.a.getLogger("esri.views.2d.support.arcadeOnDemand").error(new i.s("mapview-arcade","Unable to handle geometryType: ".concat(e))),function(e){return e}}}(t));var c=l.get(t)(e.geometry,a,s,u);return(0,n.Z)((0,n.Z)({},e),{},{geometry:c})}},65636:function(e,t,r){r.d(t,{c:function(){return a},e:function(){return o},o:function(){return n},t:function(){return i}});var n=!0,i=32,a=1.5,o=200},21744:function(e,t,r){r.d(t,{n:function(){return i}});var n=r(71802);function i(e,t,r){var i,u=e.byteLength/(4*t),c=new Uint32Array(e,0,u*t),h=new Uint32Array(u),d=null!==(i=null===r||void 0===r?void 0:r.minReduction)&&void 0!==i?i:0,f=(null===r||void 0===r?void 0:r.originalIndices)||null,p=f?f.length:0,v=(null===r||void 0===r?void 0:r.componentOffsets)||null,m=0;if(v)for(var y=0;y<v.length-1;y++){var g=v[y+1]-v[y];g>m&&(m=g)}else m=u;var _=Math.floor(1.1*m)+1;(null==l||l.length<2*_)&&(l=new Uint32Array((0,n.a8)(2*_)));for(var b=0;b<2*_;b++)l[b]=0;for(var x=0,w=!!v&&!!f,T=w?p:u,C=w?new Uint32Array(p):null,S=1.96,O=0!==d?Math.ceil(4*S*S/(d*d)*d*(1-d)):T,P=1,R=v?v[1]:T,A=0;A<T;A++){if(A===O){var k=1-x/A;if(k+S*Math.sqrt(k*(1-k)/A)<d)return null;O*=2}if(A===R){for(var E=0;E<2*_;E++)l[E]=0;if(f)for(var D=v[P-1];D<v[P];D++)C[D]=h[f[D]];R=v[++P]}for(var M=w?f[A]:A,I=M*t,L=s(c,I,t),Z=L%_,N=x;0!==l[2*Z+1];){if(l[2*Z]===L){var F=l[2*Z+1]-1;if(a(c,I,F*t,t)){N=h[F];break}}++Z>=_&&(Z-=_)}N===x&&(l[2*Z]=L,l[2*Z+1]=M+1,x++),h[M]=N}if(0!==d&&1-x/u<d)return null;if(w){for(var z=v[P-1];z<C.length;z++)C[z]=h[f[z]];h=C}var U=new Uint32Array(t*x);x=0;for(var V=0;V<T;V++)h[V]===x&&(o(c,(w?f[V]:V)*t,U,x*t,t),x++);if(f&&!w){for(var B=new Uint32Array(p),G=0;G<B.length;G++)B[G]=h[f[G]];h=B}return{buffer:U.buffer,indices:h,uniqueCount:x}}function a(e,t,r,n){for(var i=0;i<n;i++)if(e[t+i]!==e[r+i])return!1;return!0}function o(e,t,r,n,i){for(var a=0;a<i;a++)r[n+a]=e[t+a]}function s(e,t,r){for(var n=0,i=0;i<r;i++)n=(n=e[t+i]+n|0)+(n<<11)+(n>>>2)|0;return n>>>0}var l=null},43406:function(e,t,r){r.d(t,{A:function(){return x},J:function(){return S},M:function(){return m},N:function(){return y},O:function(){return O},S:function(){return T},T:function(){return C},j:function(){return v},v:function(){return b},w:function(){return w},z:function(){return g}});var n=r(37762),i=r(43144),a=r(15671),o=r(43955),s=r(93661),l=r(48848),u=r(82474),c=r(93209),h=r(25456),d=r(45184),f=r(74384),p=r(69641),v=(0,i.Z)((function e(t,r,n){(0,a.Z)(this,e),this.uid=t,this.geometry=r,this.attributes=n,this.visible=!0,this.objectId=null,this.centroid=null}));function m(e){return(0,s.r)(e.geometry)}var y=(0,i.Z)((function e(){(0,a.Z)(this,e),this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}));function g(e){var t=f.a.fromJSON(e.geometryType),r=u.k.fromJSON(e.spatialReference),n=e.transform,i=e.features.map((function(i){var a=function(e,t,r,n){return{uid:(0,l.a4)(),objectId:n&&e.attributes?e.attributes[n]:null,attributes:e.attributes,geometry:_(e.geometry,t,r),visible:!0}}(i,t,r,e.objectIdFieldName),o=a.geometry;if((0,s.r)(o)&&n)switch(o.type){case"point":a.geometry=(0,d.v)(n,o,o,o.hasZ,o.hasM);break;case"multipoint":a.geometry=(0,d.q)(n,o,o,o.hasZ,o.hasM);break;case"polygon":a.geometry=(0,d.B)(n,o,o,o.hasZ,o.hasM);break;case"polyline":a.geometry=(0,d.C)(n,o,o,o.hasZ,o.hasM);break;case"extent":case"mesh":a.geometry=o}return a}));return{geometryType:t,features:i,spatialReference:r,fields:e.fields?e.fields.map((function(e){return p.y.fromJSON(e)})):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function _(e,t,r){if((0,s.t)(e))return null;switch(t){case"point":var n=e;return{x:n.x,y:n.y,z:n.z,m:n.m,hasZ:null!=n.z,hasM:null!=n.m,type:"point",spatialReference:r};case"polyline":var i=e;return{paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:r};case"polygon":var a=e;return{rings:a.rings,hasZ:!!a.hasZ,hasM:!!a.hasM,type:"polygon",spatialReference:r};case"multipoint":var o=e;return{points:o.points,hasZ:!!o.hasZ,hasM:!!o.hasM,type:"multipoint",spatialReference:r}}}function b(e,t,r,n){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:n,type:"point"}}function x(e){var t=32;return t+=(0,o.t)(e.attributes),t+=3,t+=8+function(e){if((0,s.t)(e))return 0;var t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":var r,i=0,a=2+(e.hasZ?1:0)+(e.hasM?1:0),o="polyline"===e.type?e.paths:e.rings,l=(0,n.Z)(o);try{for(l.s();!(r=l.n()).done;)i+=r.value.length}catch(h){l.e(h)}finally{l.f()}t+=8*i*a+64,t+=128*i,t+=34,t+=32*(o.length+1);break;case"multipoint":var u=2+(e.hasZ?1:0)+(e.hasM?1:0),c=e.points.length;t+=8*c*u+64,t+=128*c,t+=34,t+=32;break;case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=(0,s.T)(e.vertexAttributes.position),t+=(0,s.T)(e.vertexAttributes.normal),t+=(0,s.T)(e.vertexAttributes.uv),t+=(0,s.T)(e.vertexAttributes.tangent)}return t}(e.geometry)}function w(e){if((0,s.t)(e))return 0;switch(e.type){case"point":return 1;case"polyline":var t,r=0,i=(0,n.Z)(e.paths);try{for(i.s();!(t=i.n()).done;){r+=t.value.length}}catch(c){i.e(c)}finally{i.f()}return r;case"polygon":var a,o=0,l=(0,n.Z)(e.rings);try{for(l.s();!(a=l.n()).done;){o+=a.value.length}}catch(c){l.e(c)}finally{l.f()}return o;case"multipoint":return e.points.length;case"extent":return 2;case"mesh":var u=e.vertexAttributes&&e.vertexAttributes.position;return u?u.length/3:0;default:return}}function T(e){if((0,s.t)(e))return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":var t,r=(0,n.Z)(e.paths);try{for(r.s();!(t=r.n()).done;){if(t.value.length>0)return!0}}catch(o){r.e(o)}finally{r.f()}return!1;case"polygon":var i,a=(0,n.Z)(e.rings);try{for(a.s();!(i=a.n()).done;){if(i.value.length>0)return!0}}catch(o){a.e(o)}finally{a.f()}return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function C(e,t){switch((0,c.A)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(var r=0;r<e.paths.length;r++)(0,c.s)(t,e.paths[r],e.hasZ);break;case"polygon":for(var n=0;n<e.rings.length;n++)(0,c.s)(t,e.rings[n],e.hasZ);break;case"multipoint":(0,c.s)(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function S(e,t){switch((0,h.D)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(var r=0;r<e.paths.length;r++)(0,h.x)(t,e.paths[r]);break;case"polygon":for(var n=0;n<e.rings.length;n++)(0,h.x)(t,e.rings[n]);break;case"multipoint":(0,h.x)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function O(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}},87917:function(e,t,r){r.d(t,{x:function(){return s}});var n,i,a,o={exports:{}};n=o,i=function(){function e(e,r,i){i=i||2;var a,o,s,u,c,h,d,f=r&&r.length,p=f?r[0]*i:e.length,v=t(e,0,p,i,!0),m=[];if(!v||v.next===v.prev)return m;if(f&&(v=l(e,r,v,i)),e.length>80*i){a=s=e[0],o=u=e[1];for(var y=i;y<p;y+=i)(c=e[y])<a&&(a=c),(h=e[y+1])<o&&(o=h),c>s&&(s=c),h>u&&(u=h);d=0!==(d=Math.max(s-a,u-o))?1/d:0}return n(v,m,i,a,o,d),m}function t(e,t,r,n,i){var a,o;if(i===R(e,t,r,n)>0)for(a=t;a<r;a+=n)o=S(a,e[a],e[a+1],o);else for(a=r-n;a>=t;a-=n)o=S(a,e[a],e[a+1],o);if(o&&_(o,o.next)){var s=o.next;O(o),o=s}return o}function r(e,t){if(!e)return e;t||(t=e);var r,n=e;do{if(r=!1,n.steiner||!_(n,n.next)&&0!==g(n.prev,n,n.next))n=n.next;else{var i=n.prev;if(O(n),(n=t=i)===n.next)break;r=!0}}while(r||n!==t);return t}function n(e,t,l,u,c,h,d){if(e){!d&&h&&f(e,u,c,h);for(var p,v,m=e;e.prev!==e.next;)if(p=e.prev,v=e.next,h?a(e,u,c,h):i(e))t.push(p.i/l),t.push(e.i/l),t.push(v.i/l),O(e),e=v.next,m=v.next;else if((e=v)===m){d?1===d?n(e=o(r(e),t,l),t,l,u,c,h,2):2===d&&s(e,t,l,u,c,h):n(r(e),t,l,u,c,h,1);break}}}function i(e){var t=e.prev,r=e,n=e.next;if(g(t,r,n)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(m(t.x,t.y,r.x,r.y,n.x,n.y,i.x,i.y)&&g(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function a(e,t,r,n){var i=e.prev,a=e,o=e.next;if(g(i,a,o)>=0)return!1;for(var s=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,l=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,u=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,c=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,h=p(s,l,t,r,n),d=p(u,c,t,r,n),f=e.prevZ,v=e.nextZ;f&&f.z>=h&&v&&v.z<=d;){if(f!==e.prev&&f!==e.next&&m(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,v!==e.prev&&v!==e.next&&m(i.x,i.y,a.x,a.y,o.x,o.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&m(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;v&&v.z<=d;){if(v!==e.prev&&v!==e.next&&m(i.x,i.y,a.x,a.y,o.x,o.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function o(e,t,n){var i=e;do{var a=i.prev,o=i.next.next;!_(a,o)&&b(a,i,i.next,o)&&T(a,o)&&T(o,a)&&(t.push(a.i/n),t.push(i.i/n),t.push(o.i/n),O(i),O(i.next),i=e=o),i=i.next}while(i!==e);return r(i)}function s(e,t,i,a,o,s){var l=e;do{for(var u=l.next.next;u!==l.prev;){if(l.i!==u.i&&y(l,u)){var c=C(l,u);return l=r(l,l.next),c=r(c,c.next),n(l,t,i,a,o,s),void n(c,t,i,a,o,s)}u=u.next}l=l.next}while(l!==e)}function l(e,n,i,a){var o,s,l,c=[];for(o=0,s=n.length;o<s;o++)(l=t(e,n[o]*a,o<s-1?n[o+1]*a:e.length,a,!1))===l.next&&(l.steiner=!0),c.push(v(l));for(c.sort(u),o=0;o<c.length;o++)i=r(i=h(c[o],i),i.next);return i}function u(e,t){return e.x-t.x}function c(e){if(e.next.prev===e)return e;for(var t=e;;){var r=t.next;if(r.prev===t||r===t||r===e)break;t=r}return t}function h(e,t){var n=function(e,t){var r,n=t,i=e.x,a=e.y,o=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){var s=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(a===n.y)return n;if(a===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!r)return null;if(i===o)return r;var l,u=r,c=r.x,h=r.y,f=1/0;n=r;do{i>=n.x&&n.x>=c&&i!==n.x&&m(a<h?i:o,a,c,h,a<h?o:i,a,n.x,n.y)&&(l=Math.abs(a-n.y)/(i-n.x),T(n,e)&&(l<f||l===f&&(n.x>r.x||n.x===r.x&&d(r,n)))&&(r=n,f=l)),n=n.next}while(n!==u);return r}(e,t);if(!n)return t;var i=C(n,e),a=r(n,n.next),o=c(i);return r(o,o.next),a=c(a),c(t===n?a:t)}function d(e,t){return g(e.prev,e,t.prev)<0&&g(t.next,e,e.next)<0}function f(e,t,r,n){var i=e;do{null===i.z&&(i.z=p(i.x,i.y,t,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,r,n,i,a,o,s,l,u=1;do{for(r=e,e=null,a=null,o=0;r;){for(o++,n=r,s=0,t=0;t<u&&(s++,n=n.nextZ);t++);for(l=u;s>0||l>0&&n;)0!==s&&(0===l||!n||r.z<=n.z)?(i=r,r=r.nextZ,s--):(i=n,n=n.nextZ,l--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;r=n}a.nextZ=null,u*=2}while(o>1)}(i)}function p(e,t,r,n,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function v(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function m(e,t,r,n,i,a,o,s){return(i-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(n-s)-(r-o)*(t-s)>=0&&(r-o)*(a-s)-(i-o)*(n-s)>=0}function y(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&b(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(T(e,t)&&T(t,e)&&function(e,t){var r=e,n=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}(e,t)&&(g(e.prev,e,t.prev)||g(e,t.prev,t))||_(e,t)&&g(e.prev,e,e.next)>0&&g(t.prev,t,t.next)>0)}function g(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function _(e,t){return e.x===t.x&&e.y===t.y}function b(e,t,r,n){var i=w(g(e,t,r)),a=w(g(e,t,n)),o=w(g(r,n,e)),s=w(g(r,n,t));return i!==a&&o!==s||!(0!==i||!x(e,r,t))||!(0!==a||!x(e,n,t))||!(0!==o||!x(r,e,n))||!(0!==s||!x(r,t,n))}function x(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function w(e){return e>0?1:e<0?-1:0}function T(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function C(e,t){var r=new P(e.i,e.x,e.y),n=new P(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function S(e,t,r,n){var i=new P(e,t,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function O(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function P(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,r,n){for(var i=0,a=t,o=r-n;a<r;a+=n)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}return e.deviation=function(e,t,r,n){var i=t&&t.length,a=i?t[0]*r:e.length,o=Math.abs(R(e,0,a,r));if(i)for(var s=0,l=t.length;s<l;s++){var u=t[s]*r,c=s<l-1?t[s+1]*r:e.length;o-=Math.abs(R(e,u,c,r))}var h=0;for(s=0;s<n.length;s+=3){var d=n[s]*r,f=n[s+1]*r,p=n[s+2]*r;h+=Math.abs((e[d]-e[p])*(e[f+1]-e[d+1])-(e[d]-e[f])*(e[p+1]-e[d+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},n=0,i=0;i<e.length;i++){for(var a=0;a<e[i].length;a++)for(var o=0;o<t;o++)r.vertices.push(e[i][a][o]);i>0&&(n+=e[i-1].length,r.holes.push(n))}return r},e},void 0!==(a=i())&&(n.exports=a);var s=o.exports},87440:function(e,t,r){r.d(t,{A:function(){return v},T:function(){return y},a:function(){return x},b:function(){return q},c:function(){return Q},d:function(){return k},e:function(){return m},f:function(){return j},h:function(){return Z},m:function(){return K},o:function(){return d},u:function(){return D},w:function(){return E}});var n=r(15671),i=r(43144),a=r(21744),o=r(94777),s=r(43345),l=r(93122),u=r(11448),c=r(93661),h=r(71802);function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e.stride;return e.fieldNames.filter((function(t){var r=e.fields.get(t).optional;return!(r&&r.glPadding)})).map((function(n){var i=e.fields.get(n),a=i.constructor.ElementCount,o=f(i.constructor.ElementType),s=i.offset,l=!(!i.optional||!i.optional.glNormalized);return new u.t(n,a,o,s,r,l,t)}))}function f(e){var t=p[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}var p={u8:l.C.UNSIGNED_BYTE,u16:l.C.UNSIGNED_SHORT,u32:l.C.UNSIGNED_INT,i8:l.C.BYTE,i16:l.C.SHORT,i32:l.C.INT,f32:l.C.FLOAT},v=(0,o.T)().vec3f(s.O.POSITION).u16(s.O.COMPONENTINDEX).u16(s.O.U16PADDING),m=(0,o.T)().vec2u8(s.O.SIDENESS),y=d(m),g=(0,o.T)().vec3f(s.O.POSITION0).vec3f(s.O.POSITION1).u16(s.O.COMPONENTINDEX).u8(s.O.VARIANTOFFSET,{glNormalized:!0}).u8(s.O.VARIANTSTROKE).u8(s.O.VARIANTEXTENSION,{glNormalized:!0}).u8(s.O.U8PADDING,{glPadding:!0}).u16(s.O.U16PADDING,{glPadding:!0}),_=g.clone().vec3f(s.O.NORMAL),b=g.clone().vec3f(s.O.NORMALA).vec3f(s.O.NORMALB),x=new Map([[s.O.POSITION0,0],[s.O.POSITION1,1],[s.O.COMPONENTINDEX,2],[s.O.VARIANTOFFSET,3],[s.O.VARIANTSTROKE,4],[s.O.VARIANTEXTENSION,5],[s.O.NORMAL,6],[s.O.NORMALA,6],[s.O.NORMALB,7],[s.O.SIDENESS,8]]);function w(e,t,r){for(var n=t/3,i=new Uint32Array(r+1),a=new Uint32Array(r+1),o=function(e,t){e<t?i[e+1]++:a[t+1]++},s=0;s<n;s++){var l=e[3*s],u=e[3*s+1],c=e[3*s+2];o(l,u),o(u,c),o(c,l)}for(var h=0,d=0,f=0;f<r;f++){var p=i[f+1],v=a[f+1];i[f+1]=h,a[f+1]=d,h+=p,d+=v}for(var m=new Uint32Array(6*n),y=i[r],g=function(e,t,r){if(e<t){var n=i[e+1]++;m[2*n]=t,m[2*n+1]=r}else{var o=a[t+1]++;m[2*y+2*o]=e,m[2*y+2*o+1]=r}},_=0;_<n;_++){var b=e[3*_],x=e[3*_+1],w=e[3*_+2];g(b,x,_),g(x,w,_),g(w,b,_)}for(var T=function(e,t){for(var r=2*e,n=t-e,i=1;i<n;i++){for(var a=m[r+2*i],o=m[r+2*i+1],s=i-1;s>=0&&m[r+2*s]>a;s--)m[r+2*s+2]=m[r+2*s],m[r+2*s+3]=m[r+2*s+1];m[r+2*s+2]=a,m[r+2*s+3]=o}},C=0;C<r;C++)T(i[C],i[C+1]),T(y+a[C],y+a[C+1]);for(var S=new Int32Array(3*n),O=function(t,r){return t===e[3*r]?0:t===e[3*r+1]?1:t===e[3*r+2]?2:-1},P=function(e,t){var r=O(e,t);S[3*t+r]=-1},R=function(e,t,r,n){var i=O(e,t);S[3*t+i]=n;var a=O(r,n);S[3*n+a]=t},A=0;A<r;A++){for(var k=i[A],E=i[A+1],D=a[A],M=a[A+1];k<E&&D<M;){var I=m[2*k],L=m[2*y+2*D];I===L?(R(A,m[2*k+1],L,m[2*y+2*D+1]),k++,D++):I<L?(P(A,m[2*k+1]),k++):(P(L,m[2*y+2*D+1]),D++)}for(;k<E;)P(A,m[2*k+1]),k++;for(;D<M;)P(m[2*y+2*D],m[2*y+2*D+1]),D++}return S}var T=function(){function e(){(0,n.Z)(this,e)}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?R:P}},{key:"write",value:function(e,t,r){var n=this._edgeHashFunction(r);I.seed=n;var i=I.getIntRange(0,255),a=I.getIntRange(0,this.settings.variants-1),o=I.getFloat(),s=255*(.5*function(e,t){var r=e<0?-1:1;return Math.pow(Math.abs(e),t)*r}(-(1-Math.min(o/.7,1))+Math.max(0,o-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,r.position0),e.position1.setVec(t,r.position1),e.componentIndex.set(t,r.componentIndex),e.variantOffset.set(t,i),e.variantStroke.set(t,a),e.variantExtension.set(t,s)}},{key:"trim",value:function(e,t){return e.slice(0,t)}}]),e}(),C=new Float32Array(6),S=new Uint32Array(C.buffer),O=new Uint32Array(1);function P(e){var t=C;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],O[0]=5381;for(var r=0;r<S.length;r++)O[0]=31*O[0]+S[r];return O[0]}function R(e){var t=C;t[0]=A(e.position0[0]),t[1]=A(e.position0[1]),t[2]=A(e.position0[2]),t[3]=A(e.position1[0]),t[4]=A(e.position1[1]),t[5]=A(e.position1[2]),O[0]=5381;for(var r=0;r<S.length;r++)O[0]=31*O[0]+S[r];return O[0]}function A(e){return Math.round(1e4*e)/1e4}var k=function(){function e(){(0,n.Z)(this,e),this._commonWriter=new T}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return _.createBuffer(e)}},{key:"write",value:function(e,t,r){this._commonWriter.write(e,t,r),(0,h.u)(M,r.faceNormal0,r.faceNormal1),(0,h.z)(M,M),e.normal.setVec(t,M)}},{key:"trim",value:function(e,t){return this._commonWriter.trim(e,t)}}]),e}();k.Layout=_,k.glLayout=d(_,1);var E=function(){function e(){(0,n.Z)(this,e),this._commonWriter=new T}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return b.createBuffer(e)}},{key:"write",value:function(e,t,r){this._commonWriter.write(e,t,r),e.normalA.setVec(t,r.faceNormal0),e.normalB.setVec(t,r.faceNormal1)}},{key:"trim",value:function(e,t){return this._commonWriter.trim(e,t)}}]),e}();E.Layout=b,E.glLayout=d(b,1);var D,M=(0,h.n)(),I=new c.W,L=-1;function Z(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:H,i=e.vertices.position,a=e.vertices.componentIndex,o=(0,h.m)(n.anglePlanar),s=(0,h.m)(n.angleSignificantEdge),l=Math.cos(s),u=Math.cos(o),d=B.edge,f=d.position0,p=d.position1,v=d.faceNormal0,m=d.faceNormal1,y=V(e),g=U(e),_=g.length/4,b=t.allocate(_),x=0,w=_,T=r.allocate(w),C=0,S=0,O=0,P=(0,c.X)(0,_),R=new Float32Array(_);(0,c.Y)(R,(function(e,t,r){i.getVec(g[4*t+0],f),i.getVec(g[4*t+1],p),r[t]=(0,h.x)(f,p)})),P.sort((function(e,t){return R[t]-R[e]}));for(var A=new Array,k=new Array,E=0;E<_;E++){var D=P[E],M=R[D],I=g[4*D+0],Z=g[4*D+1],G=g[4*D+2],j=g[4*D+3],q=j===L;if(i.getVec(I,f),i.getVec(Z,p),q)(0,h.o)(v,y[3*G+0],y[3*G+1],y[3*G+2]),(0,h.r)(m,v),d.componentIndex=a.get(I),d.cosAngle=(0,h.P)(v,m);else{if((0,h.o)(v,y[3*G+0],y[3*G+1],y[3*G+2]),(0,h.o)(m,y[3*j+0],y[3*j+1],y[3*j+2]),d.componentIndex=a.get(I),d.cosAngle=(0,h.P)(v,m),F(d,u))continue;d.cosAngle<-.9999&&(0,h.r)(m,v)}S+=M,O++,q||N(d,l)?(t.write(b,x++,d),A.push(M)):z(d,o)&&(r.write(T,C++,d),k.push(M))}var W=new Float32Array(A.reverse()),X=new Float32Array(k.reverse());return{regular:{instancesData:t.trim(b,x),lodInfo:{lengths:W}},silhouette:{instancesData:r.trim(T,C),lodInfo:{lengths:X}},averageEdgeLength:S/O}}function N(e,t){return e.cosAngle<t}function F(e,t){return e.cosAngle>t}function z(e,t){var r=(0,h.i)(e.cosAngle),n=B.fwd,i=B.ortho;return(0,h.H)(n,e.position1,e.position0),r*((0,h.P)((0,h._)(i,e.faceNormal0,e.faceNormal1),n)>0?-1:1)>t}function U(e){for(var t=e.faces.length/3,r=e.faces,n=e.neighbors,i=0,a=0;a<t;a++){var o=n[3*a+0],s=n[3*a+1],l=n[3*a+2],u=r[3*a+0],c=r[3*a+1],h=r[3*a+2];i+=o===L||u<c?1:0,i+=s===L||c<h?1:0,i+=l===L||h<u?1:0}for(var d=new Int32Array(4*i),f=0,p=0;p<t;p++){var v=n[3*p+0],m=n[3*p+1],y=n[3*p+2],g=r[3*p+0],_=r[3*p+1],b=r[3*p+2];(v===L||g<_)&&(d[f++]=g,d[f++]=_,d[f++]=p,d[f++]=v),(m===L||_<b)&&(d[f++]=_,d[f++]=b,d[f++]=p,d[f++]=m),(y===L||b<g)&&(d[f++]=b,d[f++]=g,d[f++]=p,d[f++]=y)}return d}function V(e){for(var t=e.faces.length/3,r=e.vertices.position,n=e.faces,i=G.v0,a=G.v1,o=G.v2,s=new Float32Array(3*t),l=0;l<t;l++){var u=n[3*l+0],c=n[3*l+1],d=n[3*l+2];r.getVec(u,i),r.getVec(c,a),r.getVec(d,o),(0,h.e)(a,a,i),(0,h.e)(o,o,i),(0,h._)(i,a,o),(0,h.z)(i,i),s[3*l+0]=i[0],s[3*l+1]=i[1],s[3*l+2]=i[2]}return s}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"}(D||(D={}));var B={edge:{position0:(0,h.n)(),position1:(0,h.n)(),faceNormal0:(0,h.n)(),faceNormal1:(0,h.n)(),componentIndex:0,cosAngle:0},ortho:(0,h.n)(),fwd:(0,h.n)()},G={v0:(0,h.n)(),v1:(0,h.n)(),v2:(0,h.n)()},H={anglePlanar:4,angleSignificantEdge:35};function j(e){var t=q(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return X.updateSettings(e.writerSettings),Y.updateSettings(e.writerSettings),Z(t,X,Y)}function q(e,t,r,n){if(t){var i=w(r,n,e.count);return new W(r,n,i,e)}var o=(0,a.n)(e.buffer,e.stride/4,{originalIndices:r,originalIndicesLength:n}),s=w(o.indices,n,o.uniqueCount);return{faces:o.indices,facesLength:o.indices.length,neighbors:s,vertices:v.createView(o.buffer)}}var W=(0,i.Z)((function e(t,r,i,a){(0,n.Z)(this,e),this.faces=t,this.facesLength=r,this.neighbors=i,this.vertices=a})),X=new k,Y=new E,Q=(0,o.T)().vec3f(s.O.POSITION0).vec3f(s.O.POSITION1),K=(0,o.T)().vec3f(s.O.POSITION0).vec3f(s.O.POSITION1).u16(s.O.COMPONENTINDEX).u16(s.O.U16PADDING,{glPadding:!0})},75257:function(e,t,r){var n,i,a,o,s;r.d(t,{I:function(){return i},L:function(){return s},T:function(){return o}}),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FILL_VERTEX=1]="FILL_VERTEX",e[e.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",e[e.FILL_INDEX=3]="FILL_INDEX",e[e.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",e[e.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",e[e.OUTLINE_INDEX=6]="OUTLINE_INDEX",e[e.LINE_VERTEX=7]="LINE_VERTEX",e[e.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",e[e.LINE_INDEX=9]="LINE_INDEX",e[e.ICON_VERTEX=10]="ICON_VERTEX",e[e.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",e[e.ICON_INDEX=12]="ICON_INDEX",e[e.TEXT_VERTEX=13]="TEXT_VERTEX",e[e.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",e[e.TEXT_INDEX=15]="TEXT_INDEX",e[e.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",e[e.CIRCLE_INDEX=17]="CIRCLE_INDEX"}(n||(n={})),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(i||(i={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.OPAQUE=1]="OPAQUE",e[e.TRANSLUCENT=2]="TRANSLUCENT",e[e.SYMBOLS=3]="SYMBOLS",e[e.HITTEST=4]="HITTEST"}(a||(a={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(o||(o={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(s||(s={}))},25217:function(e,t,r){r.d(t,{o:function(){return i},r:function(){return a}});var n=r(71802);function i(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=(0,n.a)(e,0,l),a=0;a<4;a++)t[r+a]=Math.floor(256*u(i*o[a]))}function a(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0,n=0;n<4;n++)r+=e[t+n]*s[n];return r}var o=[1,256,65536,16777216],s=[1/256,1/65536,1/16777216,1/4294967296],l=a(new Uint8ClampedArray([255,255,255,255]));function u(e){return e-Math.floor(e)}},5526:function(e,t,r){r.r(t),r.d(t,{getGeometryServiceURL:function(){return u},projectGeometry:function(){return h}});var n=r(74165),i=r(15861),a=r(93661),o=r(48848),s=r(93116),l=r(2473);r(40558),r(40114),r(65094),r(82474),r(46817),r(56162),r(74384),r(39994),r(69717);function u(){return c.apply(this,arguments)}function c(){return c=(0,i.Z)((0,n.Z)().mark((function e(){var t,r,i,l,u,c,h=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=h.length>0&&void 0!==h[0]?h[0]:null,l=h.length>1?h[1]:void 0,!a.s.geometryServiceUrl){e.next=4;break}return e.abrupt("return",a.s.geometryServiceUrl);case 4:if(i){e.next=6;break}throw new o.s("internal:geometry-service-url-not-configured");case 6:return u="portal"in i?i.portal||s.j.getDefault():i,e.next=9,u.load({signal:l});case 9:if(c=null===(t=u.helperServices)||void 0===t||null===(r=t.geometry)||void 0===r?void 0:r.url){e.next=12;break}throw new o.s("internal:geometry-service-url-not-configured");case 12:return e.abrupt("return",c);case 13:case"end":return e.stop()}}),e)}))),c.apply(this,arguments)}function h(e,t){return d.apply(this,arguments)}function d(){return d=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,c,h,d=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=d.length>2&&void 0!==d[2]?d[2]:null,a=d.length>3?d[3]:void 0,e.next=4,u(i,a);case 4:return s=e.sent,(c=new l.a).geometries=[t],c.outSpatialReference=r,e.next=9,(0,l.n)(s,c,{signal:a});case 9:if(!(h=e.sent)||!Array.isArray(h)||1!==h.length){e.next=12;break}return e.abrupt("return",h[0]);case 12:throw new o.s("internal:geometry-service-projection-failed");case 13:case"end":return e.stop()}}),e)}))),d.apply(this,arguments)}},16599:function(e,t,r){r.d(t,{e:function(){return a},r:function(){return o}});var n=null,i=!0;function a(e,t,r){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(i)try{return new ImageData(e,t)}catch(s){i=!1}return l(e,t,r)}function o(e,t,r,n){if(!t||!r)throw new Error("Cannot construct image data without dimensions");if(i)try{return new ImageData(e,t,r)}catch(o){i=!1}var a=l(t,r,n);return a.data.set(e,0),a}function s(){return n||((n=document.createElement("canvas")).width=1,n.height=1),n}function l(e,t,r){return r||(r=s()),r.getContext("2d").createImageData(e,t)}},72361:function(e,t,r){r.r(t),r.d(t,{createLabelFunction:function(){return p},formatField:function(){return m}});var n=r(74165),i=r(37762),a=r(15861),o=r(48848),s=r(93661),l=r(53586),u=r(59984),c=r(90442),h=(r(40558),r(65094),r(74384),r(46817),r(82474),r(40114),o.a.getLogger("esri.layers.support.labelFormatUtils")),d={type:"simple",evaluate:function(){return null}},f={getAttribute:function(e,t){return e.field(t)}};function p(e,t,r){return v.apply(this,arguments)}function v(){return v=(0,a.Z)((0,n.Z)().mark((function e(t,i,a){var l,p,v,y,g,_,b;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.symbol){e.next=2;break}return e.abrupt("return",d);case 2:if(l=t.where,p=(0,c.x)(t),!l){e.next=10;break}return e.next=7,r.e(2470).then(r.bind(r,62470));case 7:e.t0=e.sent,e.next=11;break;case 10:e.t0=null;case 11:if(v=e.t0,"arcade"!==p.type){e.next=21;break}return e.next=15,(0,u.n)(p.expression,a,i);case 15:if(g=e.sent,!(0,s.t)(g)){e.next=18;break}return e.abrupt("return",d);case 18:y={type:"arcade",evaluate:function(e){try{var t=g.evaluate({$feature:"attributes"in e?g.repurposeFeature(e):e});if(null!=t)return t.toString()}catch(i){h.error(new o.s("arcade-expression-error","Encountered an error when evaluating label expression for feature",{feature:e,expression:p}))}return null},needsHydrationToEvaluate:function(){return null==(0,c._)(p.expression)}},e.next=22;break;case 21:y={type:"simple",evaluate:function(e){return p.expression.replace(/{[^}]*}/g,(function(t){var r=t.slice(1,-1),n=i.get(r);if(!n)return t;var a=null;return"attributes"in e?e&&e.attributes&&(a=e.attributes[n.name]):a=e.field(n.name),null==a?"":m(a,n)}))}};case 22:if(!l){e.next=32;break}e.prev=23,_=v.WhereClause.create(l,i),e.next=30;break;case 27:return e.prev=27,e.t1=e.catch(23),e.abrupt("return",(h.error(new o.s("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:l,error:e.t1})),d));case 30:b=y.evaluate,y.evaluate=function(e){var t="attributes"in e?void 0:f;try{if(_.testFeature(e,t))return b(e)}catch(r){h.error(new o.s("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:l,feature:e,error:r}))}return null};case 32:return e.abrupt("return",y);case 33:case"end":return e.stop()}}),e,null,[[23,27]])}))),v.apply(this,arguments)}function m(e,t){if(null==e)return"";var r=t.domain;if(r)if("codedValue"===r.type||"coded-value"===r.type){var n,a=e,o=(0,i.Z)(r.codedValues);try{for(o.s();!(n=o.n()).done;){var s=n.value;if(s.code===a)return s.name}}catch(p){o.e(p)}finally{o.f()}}else if("range"===r.type){var c=+e,h="range"in r?r.range[0]:r.minValue,d="range"in r?r.range[1]:r.maxValue;if(h<=c&&c<=d)return r.name}var f=e;return"date"===t.type||"esriFieldTypeDate"===t.type?f=(0,l.L)(f,(0,l.S)("short-date")):(0,u.b)(t)&&(f=(0,l.m)(+f)),f||""}},2473:function(e,t,r){r.d(t,{a:function(){return y},n:function(){return _}});var n=r(74165),i=r(1413),a=r(15861),o=r(15671),s=r(43144),l=r(60136),u=r(29388),c=r(40558),h=r(48848),d=r(56162),f=r(39994),p=r(69717),v=r(40114),m=(r(93661),function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e)).geometries=null,n.outSpatialReference=null,n.transformation=null,n.transformForward=null,n}return(0,s.Z)(r,[{key:"toJSON",value:function(){var e=this.geometries.map((function(e){return e.toJSON()})),t=this.geometries[0],r={};return r.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),r.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),r.geometries=JSON.stringify({geometryType:(0,d.c)(t),geometries:e}),this.transformation&&(r.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(r.transformForward=this.transformForward),r}}]),r}(v.l));(0,h.e)([(0,h.y)()],m.prototype,"geometries",void 0),(0,h.e)([(0,h.y)({json:{read:{source:"outSR"}}})],m.prototype,"outSpatialReference",void 0),(0,h.e)([(0,h.y)()],m.prototype,"transformation",void 0),(0,h.e)([(0,h.y)()],m.prototype,"transformForward",void 0);var y=m=(0,h.e)([(0,h.n)("esri.rest.support.ProjectParameters")],m),g=(0,h.b)(y);function _(e,t,r){return b.apply(this,arguments)}function b(){return b=(0,a.Z)((0,n.Z)().mark((function e(t,r,a){var o,s,l,u,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=g(r),o=(0,f.f)(t),s=(0,i.Z)((0,i.Z)({},o.query),{},{f:"json"},r.toJSON()),l=r.outSpatialReference,u=(0,d.c)(r.geometries[0]),h=(0,f.i)(s,a),e.abrupt("return",(0,c.U)(o.path+"/project",h).then((function(e){var t=e.data.geometries;return(0,p.o)(t,u,l)})));case 3:case"end":return e.stop()}}),e)}))),b.apply(this,arguments)}},18936:function(e,t,r){r.d(t,{L:function(){return N},M:function(){return E},O:function(){return D},R:function(){return M},V:function(){return L},a:function(){return m},b:function(){return _},c:function(){return y},g:function(){return b},h:function(){return k},j:function(){return A},k:function(){return Z},q:function(){return g},v:function(){return I},x:function(){return x}});var n=r(71802),i=r(67430),a=r(76291),o=r(48848),s=r(93661),l=r(26313),u=r(37077),c=r(49228),h=r(95249),d=r(47855),f=r(82474),p=r(85026),v=r(33973);function m(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:S;return[e[0],e[1],e[2],e[3]]}function y(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m();return(0,n.r)(r,e),r[3]=t,r}function g(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m();return(0,n._)(r,e,t),(0,n.z)(r,r),r[3]=-(0,n.ah)(e,t),r}function _(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m();return(0,i.v)(O,e,x(e)),(0,i.v)(P,t,x(t)),(0,i.y)(O,P,O),w(r,(0,n.b)((0,i.x)(r,O)))}function b(e){return e}function x(e){return(0,n.m)(e[3])}function w(e,t){return e[3]=t,e}var T,C,S=[0,0,1,0],O=(0,a.e)(),P=(0,a.e)(),R=o.a.getLogger("esri.geometry.support.meshUtils.normalProjection");function A(e,t,r,n,i){return z(n)?(F(T.TO_PCPF,p.i.fromTypedArray(e),p.T.fromTypedArray(t),p.T.fromTypedArray(r),n,p.i.fromTypedArray(i)),i):(R.error("Cannot convert spatial reference to PCPF"),i)}function k(e,t,r,n,i){return z(n)?(F(T.FROM_PCPF,p.i.fromTypedArray(e),p.T.fromTypedArray(t),p.T.fromTypedArray(r),n,p.i.fromTypedArray(i)),i):(R.error("Cannot convert to spatial reference from PCPF"),i)}function E(e,t,r){return(0,h.x)(e,t,0,r,(0,d.c)(t),0,e.length/3),r}function D(e,t,r){return(0,h.x)(e,(0,d.c)(r),0,t,r,0,e.length/3),t}function M(e,t,r){if((0,s.t)(e))return t;var n=p.T.fromTypedArray(e),i=p.T.fromTypedArray(t);return(0,v.t)(i,n,r),t}function I(e,t,r){if((0,s.t)(e))return t;(0,l.g)(H,r);var n=p.i.fromTypedArray(e),i=p.i.fromTypedArray(t);return(0,v.r)(i,n,H),(0,l.B)(H)||(0,v.o)(i,i),t}function L(e,t,r){if((0,s.t)(e))return t;(0,l.g)(H,r);var n=p.i.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),i=p.i.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if((0,v.r)(i,n,H),(0,l.B)(H)||(0,v.o)(i,i),e!==t)for(var a=3;a<e.length;a+=4)t[a]=e[a];return t}function Z(e,t,r,n,i){if(!z(n))return R.error("Cannot convert spatial reference to PCPF"),i;F(T.TO_PCPF,p.i.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),p.T.fromTypedArray(t),p.T.fromTypedArray(r),n,p.i.fromTypedArray(i,4*Float32Array.BYTES_PER_ELEMENT));for(var a=3;a<e.length;a+=4)i[a]=e[a];return i}function N(e,t,r,n,i){if(!z(n))return R.error("Cannot convert to spatial reference from PCPF"),i;F(T.FROM_PCPF,p.i.fromTypedArray(e,16),p.T.fromTypedArray(t),p.T.fromTypedArray(r),n,p.i.fromTypedArray(i,16));for(var a=3;a<e.length;a+=4)i[a]=e[a];return i}function F(e,t,r,i,a,o){if(t){var s=r.count,u=(0,d.c)(a);if(U(a))for(var c=0;c<s;c++)i.getVec(c,V),t.getVec(c,B),(0,h.Z)(u,V,G,u),(0,l.a)(H,G),e===T.FROM_PCPF&&(0,l.o)(H,H),(0,n.S)(B,B,H),o.setVec(c,B);else for(var p=0;p<s;p++){i.getVec(p,V),t.getVec(p,B),(0,h.Z)(u,V,G,u),(0,l.a)(H,G);var v=(0,f.l)(r.get(p,1)),m=Math.cos(v);e===T.TO_PCPF&&(m=1/m),H[0]*=m,H[1]*=m,H[2]*=m,H[3]*=m,H[4]*=m,H[5]*=m,e===T.FROM_PCPF&&(0,l.o)(H,H),(0,n.S)(B,B,H),(0,n.z)(B,B),o.setVec(p,B)}return o}}function z(e){return U(e)||function(e){return e.isWebMercator}(e)}function U(e){return e.isWGS84||(0,f.u)(e)||(0,f.P)(e)||(0,f.c)(e)}(C=T||(T={}))[C.TO_PCPF=0]="TO_PCPF",C[C.FROM_PCPF=1]="FROM_PCPF";var V=(0,n.n)(),B=(0,n.n)(),G=(0,c.e)(),H=(0,u.e)()},45184:function(e,t,r){r.d(t,{B:function(){return C},C:function(){return S},O:function(){return g},U:function(){return x},q:function(){return w},s:function(){return u},v:function(){return T}});var n=r(29439),i=r(93661),a=r(56162),o=function(e,t,r){return[t,r]},s=function(e,t,r){return[t,r,e[2]]},l=function(e,t,r){return[t,r,e[2],e[3]]};function u(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:(0,i.r)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function c(e,t){var r=e.scale,n=e.translate;return Math.round((t-n[0])/r[0])}function h(e,t){var r=e.scale,n=e.translate;return Math.round((n[1]-t)/r[1])}function d(e,t,r){for(var n,i,a,o,s=[],l=0;l<r.length;l++){var u=r[l];l>0?(a=c(e,u[0]),o=h(e,u[1]),a===n&&o===i||(s.push(t(u,a-n,o-i)),n=a,i=o)):(n=c(e,u[0]),i=h(e,u[1]),s.push(t(u,n,i)))}return s.length>0?s:null}function f(e,t){var r=e.scale,n=e.translate;return t*r[0]+n[0]}function p(e,t){var r=e.scale;return e.translate[1]-t*r[1]}function v(e,t,r){var i=new Array(r.length);if(!r.length)return i;var a=(0,n.Z)(e.scale,2),o=a[0],s=a[1],l=f(e,r[0][0]),u=p(e,r[0][1]);i[0]=t(r[0],l,u);for(var c=1;c<r.length;c++){var h=r[c];l+=h[0]*o,u-=h[1]*s,i[c]=t(h,l,u)}return i}function m(e,t,r){for(var n=new Array(r.length),i=0;i<r.length;i++)n[i]=v(e,t,r[i]);return n}function y(e,t,r,n,i){var a;return t.points=null!==(a=function(e,t,r,n){return d(e,r?n?l:s:n?s:o,t)}(e,r.points,n,i))&&void 0!==a?a:[],t}function g(e,t,r,n,i){return t.x=c(e,r.x),t.y=h(e,r.y),t!==r&&(n&&(t.z=r.z),i&&(t.m=r.m)),t}function _(e,t,r,n,i){var a=function(e,t,r,n){for(var i=[],a=r?n?l:s:n?s:o,u=0;u<t.length;u++){var c=d(e,a,t[u]);c&&c.length>=3&&i.push(c)}return i.length?i:null}(e,r.rings,n,i);return a?(t.rings=a,t):null}function b(e,t,r,n,i){var a=function(e,t,r,n){for(var i=[],a=r?n?l:s:n?s:o,u=0;u<t.length;u++){var c=d(e,a,t[u]);c&&c.length>=2&&i.push(c)}return i.length?i:null}(e,r.paths,n,i);return a?(t.paths=a,t):null}function x(e,t){return e&&t?(0,a.s)(t)?g(e,{},t,!1,!1):(0,a.f)(t)?b(e,{},t,!1,!1):(0,a.y)(t)?_(e,{},t,!1,!1):(0,a.l)(t)?y(e,{},t,!1,!1):(0,a.u)(t)?function(e,t,r,n,i){return t.xmin=c(e,r.xmin),t.ymin=h(e,r.ymin),t.xmax=c(e,r.xmax),t.ymax=h(e,r.ymax),t!==r&&(n&&(t.zmin=r.zmin,t.zmax=r.zmax),i&&(t.mmin=r.mmin,t.mmax=r.mmax)),t}(e,{},t,!1,!1):null:null}function w(e,t,r,n,a){return(0,i.r)(r)&&(t.points=function(e,t,r,n){return v(e,r?n?l:s:n?s:o,t)}(e,r.points,n,a)),t}function T(e,t,r,n,a){return(0,i.t)(r)||(t.x=f(e,r.x),t.y=p(e,r.y),t!==r&&(n&&(t.z=r.z),a&&(t.m=r.m))),t}function C(e,t,r,n,a){return(0,i.r)(r)&&(t.rings=function(e,t,r,n){return m(e,r?n?l:s:n?s:o,t)}(e,r.rings,n,a)),t}function S(e,t,r,n,a){return(0,i.r)(r)&&(t.paths=function(e,t,r,n){return m(e,r?n?l:s:n?s:o,t)}(e,r.paths,n,a)),t}},4397:function(e,t,r){r.d(t,{a:function(){return v},b:function(){return _},c:function(){return w},l:function(){return y},s:function(){return x},t:function(){return p}});var n=r(74165),i=r(15861),a=r(11752),o=r(61120),s=r(60136),l=r(29388),u=r(15671),c=r(43144),h=r(71802),d=r(48848),f=r(95414),p=function(){function e(t){(0,u.Z)(this,e),this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}return(0,c.Z)(e,[{key:"update",value:function(e){if(this.hasLastValue()){var t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}},{key:"reset",value:function(){this.lastValue=void 0,this.filteredDelta=void 0}},{key:"hasLastValue",value:function(){return void 0!==this.lastValue}},{key:"hasFilteredDelta",value:function(){return void 0!==this.filteredDelta}},{key:"computeDelta",value:function(e){return void 0===this.lastValue?NaN:e-this.lastValue}},{key:"_updateDelta",value:function(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}]),e}(),v=function(){function e(t,r,n){(0,u.Z)(this,e),this._initialVelocity=t,this._stopVelocity=r,this._friction=n,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}return(0,c.Z)(e,[{key:"duration",get:function(){return this._duration}},{key:"isFinished",value:function(e){return e>this.duration}},{key:"friction",get:function(){return this._friction}},{key:"value",value:function(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}},{key:"valueDelta",value:function(e,t){var r=this.value(e);return this.value(e+t)-r}},{key:"valueFromInitialVelocity",value:function(e,t){t=Math.min(t,this.duration);var r=1-this.friction;return e*(Math.pow(r,t)-1)/Math.log(r)}}]),e}(),m=function(e){(0,s.Z)(r,e);var t=(0,l.Z)(r);function r(e,n,i,a,o){var s;return(0,u.Z)(this,r),(s=t.call(this,e,n,i))._sceneVelocity=a,s.direction=o,s}return(0,c.Z)(r,[{key:"value",value:function(e){return(0,a.Z)((0,o.Z)(r.prototype),"valueFromInitialVelocity",this).call(this,this._sceneVelocity,e)}}]),r}(v),y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,u.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=r,this._friction=n,this.enabled=!0,this._time=new p(.6),this._screen=[new p(.4),new p(.4)],this._scene=[new p(.6),new p(.6),new p(.6)],this._tmpDirection=(0,h.n)()}return(0,c.Z)(e,[{key:"add",value:function(e,t,r){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(r)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(r)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?0:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,i=null==n||null==r?0:r/n;return Math.abs(i)<this._minimumInitialVelocity?null:this.createMomentum(i,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,r){var n,i,a;(0,h.o)(this._tmpDirection,null!==(n=this._scene[0].filteredDelta)&&void 0!==n?n:0,null!==(i=this._scene[1].filteredDelta)&&void 0!==i?i:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);var o=(0,h.s)(this._tmpDirection);o>0&&(0,h.g)(this._tmpDirection,this._tmpDirection,1/o);var s=this._time.filteredDelta;return new m(e,t,r,null==s?0:o/s,this._tmpDirection)}}]),e}(),g=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;(0,u.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=r,this._friction=n,this._maxVelocity=i,this.enabled=!0,this.value=new p(.8),this.time=new p(.3)}return(0,c.Z)(e,[{key:"add",value:function(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){var r=this.value.computeDelta(e);this.value.filteredDelta*r<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}},{key:"reset",value:function(){this.value.reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;var e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,h.a)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,r){return new v(e,t,r)}}]),e}(),_=function(e){(0,s.Z)(r,e);var t=(0,l.Z)(r);function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,u.Z)(this,r),t.call(this,e,n,i,a)}return(0,c.Z)(r,[{key:"add",value:function(e,t){var n=this.value.lastValue;if(null!=n){for(var i=e-n;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=n+i}(0,a.Z)((0,o.Z)(r.prototype),"add",this).call(this,e,t)}}]),r}(g),b=function(e){(0,s.Z)(r,e);var t=(0,l.Z)(r);function r(e,n,i){return(0,u.Z)(this,r),t.call(this,e,n,i)}return(0,c.Z)(r,[{key:"value",value:function(e){var t=(0,a.Z)((0,o.Z)(r.prototype),"value",this).call(this,e);return Math.exp(t)}},{key:"valueDelta",value:function(e,t){var n=(0,a.Z)((0,o.Z)(r.prototype),"value",this).call(this,e),i=(0,a.Z)((0,o.Z)(r.prototype),"value",this).call(this,e+t)-n;return Math.exp(i)}}]),r}(v),x=function(e){(0,s.Z)(r,e);var t=(0,l.Z)(r);function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,u.Z)(this,r),t.call(this,e,n,i,a)}return(0,c.Z)(r,[{key:"add",value:function(e,t){(0,a.Z)((0,o.Z)(r.prototype),"add",this).call(this,Math.log(e),t)}},{key:"createMomentum",value:function(e,t,r){return new b(e,t,r)}}]),r}(g);function w(e){return T.apply(this,arguments)}function T(){return T=(0,i.Z)((0,n.Z)().mark((function e(t){var i,a,o,s,l;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r.e(221).then(r.bind(r,70221)),a=r.e(2008).then(r.bind(r,62008)),e.t0=f.t,e.next=5,i;case 5:return e.t1=e.sent.default,e.t2={signal:t},o=(0,e.t0)(e.t1,e.t2),e.t3=f.t,e.next=11,a;case 11:return e.t4=e.sent.default,e.t5={signal:t},s=(0,e.t3)(e.t4,e.t5),e.next=16,o;case 16:return e.t6=e.sent,e.next=19,s;case 19:return e.t7=e.sent,l={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,d.f)(t),l));case 22:case"end":return e.stop()}}),e)}))),T.apply(this,arguments)}},33973:function(e,t,r){r.d(t,{a:function(){return n},b:function(){return c},e:function(){return u},f:function(){return o},n:function(){return l},o:function(){return s},r:function(){return a},t:function(){return i}});var n=r(48848).a.getLogger("esri.views.3d.support.buffer.math");function i(e,t,r){if(e.count===t.count)for(var i=e.count,a=r[0],o=r[1],s=r[2],l=r[4],u=r[5],c=r[6],h=r[8],d=r[9],f=r[10],p=r[12],v=r[13],m=r[14],y=e.typedBuffer,g=e.typedBufferStride,_=t.typedBuffer,b=t.typedBufferStride,x=0;x<i;x++){var w=x*g,T=x*b,C=_[T],S=_[T+1],O=_[T+2];y[w]=a*C+l*S+h*O+p,y[w+1]=o*C+u*S+d*O+v,y[w+2]=s*C+c*S+f*O+m}else n.error("source and destination buffers need to have the same number of elements")}function a(e,t,r){if(e.count===t.count)for(var i=e.count,a=r[0],o=r[1],s=r[2],l=r[3],u=r[4],c=r[5],h=r[6],d=r[7],f=r[8],p=e.typedBuffer,v=e.typedBufferStride,m=t.typedBuffer,y=t.typedBufferStride,g=0;g<i;g++){var _=g*v,b=g*y,x=m[b],w=m[b+1],T=m[b+2];p[_]=a*x+l*w+h*T,p[_+1]=o*x+u*w+d*T,p[_+2]=s*x+c*w+f*T}else n.error("source and destination buffers need to have the same number of elements")}function o(e,t,r){for(var n=Math.min(e.count,t.count),i=e.typedBuffer,a=e.typedBufferStride,o=t.typedBuffer,s=t.typedBufferStride,l=0;l<n;l++){var u=l*a,c=l*s;i[u]=r*o[c],i[u+1]=r*o[c+1],i[u+2]=r*o[c+2]}}function s(e,t){for(var r=Math.min(e.count,t.count),n=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=0;s<r;s++){var l=s*i,u=s*o,c=a[u],h=a[u+1],d=a[u+2],f=c*c+h*h+d*d;if(f>0){var p=1/Math.sqrt(f);n[l]=p*c,n[l+1]=p*h,n[l+2]=p*d}}}function l(e,t,r){for(var n=Math.min(e.count,t.count),i=e.typedBuffer,a=e.typedBufferStride,o=t.typedBuffer,s=t.typedBufferStride,l=0;l<n;l++){var u=l*a,c=l*s;i[u]=o[c]>>r,i[u+1]=o[c+1]>>r,i[u+2]=o[c+2]>>r}}function u(e,t,r){for(var n=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=r?r.count:t.count,l=(r&&r.dstIndex?r.dstIndex:0)*i,u=(r&&r.srcIndex?r.srcIndex:0)*o,c=0;c<s;++c)n[l]=a[u],n[l+1]=a[u+1],n[l+2]=a[u+2],l+=i,u+=o}function c(e,t,r,n,i){for(var a,o,s=e.typedBuffer,l=e.typedBufferStride,u=null!==(a=null===i||void 0===i?void 0:i.count)&&void 0!==a?a:e.count,c=(null!==(o=null===i||void 0===i?void 0:i.dstIndex)&&void 0!==o?o:0)*l,h=0;h<u;++h)s[c]=t,s[c+1]=r,s[c+2]=n,c+=l}Object.freeze(Object.defineProperty({__proto__:null,transformMat4:i,transformMat3:a,scale:o,normalize:s,shiftRight:l},Symbol.toStringTag,{value:"Module"})),Object.freeze(Object.defineProperty({__proto__:null,copy:u,fill:c},Symbol.toStringTag,{value:"Module"}))},2851:function(e,t,r){r.d(t,{D:function(){return s},z:function(){return o}});var n=r(1413),i=r(85026),a=r(94777);function o(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:l(e.layout)}}function s(e){return function(e){var t=(0,a.T)();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach((function(e){return t.fields.set(e[0],(0,n.Z)((0,n.Z)({},e[1]),{},{constructor:h(e[1].constructor)}))})),t}(e.layout).createView(e.buffer)}function l(e){var t=new Array;return e.fields.forEach((function(e,r){var i=(0,n.Z)((0,n.Z)({},e),{},{constructor:c(e.constructor)});t.push([r,i])})),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}var u=[i.y,i.u,i.i,i.c,i.l,i.p,i.o,i.m,i.T,i.h,i.a,i.b,i.d,i.A,i.O,i.x,i.g,i.w,i.E,i.L,i.B,i.F,i.I,i.U,i.j,i.V,i.M,i.S,i.k,i.q,i.v,i.z,i.C,i.D,i.G,i.H];function c(e){return"".concat(e.ElementType,"_").concat(e.ElementCount)}function h(e){return d.get(e)}var d=new Map;u.forEach((function(e){return d.set(c(e),e)}))}}]);
//# sourceMappingURL=4566.0a49c371.chunk.js.map