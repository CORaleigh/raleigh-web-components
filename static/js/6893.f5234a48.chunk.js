"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[6893],{36893:function(e,t,r){r.r(t);var n=r(1413),i=r(74165),s=r(93433),a=r(37762),u=r(15861),o=r(15671),l=r(43144),c=r(60136),p=r(29388),h=r(50165),d=r(89031),f=(r(33530),r(40133)),y=r(73627),v=r(3096),g=r(56389),_=r(82046),m=r(53089),k=r(45578),b=r(35744),w=r(51386),x=r(22494),Z=r(52155),R=r(49796),S=r(88533),q=r(49510),E=r(61490),C=r(60470),I=r(1894),O=r(99057),T=r(96263),F=(r(98496),r(32335),r(77322),r(4483),r(13994),r(79747),r(42),r(75662),r(17493),r(62980),r(16377),r(9887),r(88406),r(66307),r(2760),r(42488),r(9330),r(79146),r(3029),r(42687),r(78330),r(78697),r(78664),r(31278),r(36235),r(61340),r(83172),r(49350),r(84539),r(89354),r(16897),r(47642),r(63334),r(73428),r(38419),r(84231),r(97823),r(38665),r(32717),r(59075),r(17691),r(39853),r(94872),r(3969),r(86738),r(69205),r(50338),r(49961),r(31412),r(14527),r(68634),r(69738),r(73393),r(87110),r(72577),r(61772),r(92870),r(26079),r(22984),r(15508),r(48561),r(55269),r(86931),r(51613),r(80392),r(10489),r(62298),r(2815),r(2326),r(90339),r(76375),r(66270),r(60418),r(75366),r(5233),r(57439),r(43895),r(30594),r(73267),r(22628),r(24982),r(46584),r(7093),r(85966),r(28003),r(58428),r(8049),r(80933),r(40858),r(95076),r(33074),r(31134),r(41524),r(68668),r(55916),r(66319),r(24781),r(2329),r(37243),r(97345),r(39001),r(84913),r(84823),r(9411),r(14826),r(64620),r(22225),r(75272),r(4197),r(86905),r(64997),r(26208),r(2816),r(46237),r(98428),r(5792),r(42094),r(67871),r(75097),r(47672),r(98643),r(83745),r(96401),r(87833),r(21523),r(84192),r(26995),r(99797),r(3441),r(6819),r(47692),r(66281),r(27969),r(77372),r(82909),r(81044),r(33265),r(20592),r(44365),r(77006),r(20422),r(38969),r(75105),r(40100),r(18392),r(33117),function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).isAggregate=!0,e}return(0,l.Z)(r,[{key:"getEffectivePopupTemplate",value:function(){if(this.popupTemplate)return this.popupTemplate;var e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}},{key:"getObjectId",value:function(){return this.objectId}}]),r}(d.g));(0,h.e)([(0,h.d)({type:Boolean})],F.prototype,"isAggregate",void 0),(0,h.e)([(0,h.d)({type:[String,Number],json:{read:!0}})],F.prototype,"objectId",void 0);var U=F=(0,h.e)([(0,h.n)("esri.AggregateGraphic")],F),V=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._filter=null,n.duration=(0,h.c)("mapview-transitions-duration"),n._excludedEffectView=new v.h(e),n._includedEffectView=new v.h(e),n}return(0,l.Z)(r,[{key:"excludedEffects",get:function(){return this._excludedEffectView.effects}},{key:"featureEffect",set:function(e){this._get("featureEffect")!==e&&this._transitionTo(e)}},{key:"filter",get:function(){var e;return this._filter||(null===(e=(0,h.g)(this.featureEffect))||void 0===e?void 0:e.filter)||null}},{key:"hasEffects",get:function(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}},{key:"includedEffects",get:function(){return this._includedEffectView.effects}},{key:"scale",set:function(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}},{key:"transitioning",get:function(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}},{key:"transitionStep",value:function(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}},{key:"end",value:function(){this._includedEffectView.end(),this._excludedEffectView.end(),this._filter=null}},{key:"_transitionTo",value:function(e){var t=this._get("featureEffect"),r=(0,h.g)(e),n=(0,h.g)(null===r||void 0===r?void 0:r.includedEffect),i=(0,h.g)(null===r||void 0===r?void 0:r.excludedEffect),s=this._includedEffectView.canTransitionTo(n)&&this._excludedEffectView.canTransitionTo(i);this._includedEffectView.effect=n,this._excludedEffectView.effect=i,this._set("featureEffect",r),this._filter=(null===r||void 0===r?void 0:r.filter)||(null===t||void 0===t?void 0:t.filter)||null,s||this.end()}}]),r}(h.y);(0,h.e)([(0,h.d)()],V.prototype,"_filter",void 0),(0,h.e)([(0,h.d)()],V.prototype,"_excludedEffectView",void 0),(0,h.e)([(0,h.d)()],V.prototype,"_includedEffectView",void 0),(0,h.e)([(0,h.d)()],V.prototype,"duration",void 0),(0,h.e)([(0,h.d)()],V.prototype,"excludedEffects",null),(0,h.e)([(0,h.d)()],V.prototype,"featureEffect",null),(0,h.e)([(0,h.d)()],V.prototype,"filter",null),(0,h.e)([(0,h.d)()],V.prototype,"hasEffects",null),(0,h.e)([(0,h.d)()],V.prototype,"includedEffects",null),(0,h.e)([(0,h.d)({value:0})],V.prototype,"scale",null),(0,h.e)([(0,h.d)()],V.prototype,"transitioning",null);var P=V=(0,h.e)([(0,h.n)("esri.layers.effects.FeatureEffectView")],V);function N(e,t){return A.apply(this,arguments)}function A(){return A=(0,u.Z)((0,i.Z)().mark((function e(t,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:e.t0=t.type,e.next="symbol"===e.t0?5:"heatmap"===e.t0?10:15;break;case 5:return e.next=7,Promise.all([r.e(5346),r.e(8968),r.e(4023),r.e(5341),r.e(9514),r.e(8606),r.e(8925)]).then(r.bind(r,78925));case 7:return e.t1=e.sent.default,e.t2=n,e.abrupt("return",new e.t1(e.t2));case 10:return e.next=12,Promise.all([r.e(5346),r.e(8968),r.e(4023),r.e(5341),r.e(9514),r.e(9521)]).then(r.bind(r,39521));case 12:return e.t3=e.sent.default,e.t4=n,e.abrupt("return",new e.t3(e.t4));case 15:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function J(e){return e.some((function(e){return e.globalId}))}function j(e){return e.filter((function(e){return!e.error})).map((function(e){var t;return null!==(t=e.objectId)&&void 0!==t?t:e.globalId}))}function z(e,t){var r,n=new Set(e),i=(0,a.Z)(t.values());try{for(i.s();!(r=i.n()).done;){var s=r.value;n.add(s)}}catch(u){i.e(u)}finally{i.f()}return n}function L(e,t){var r,n=new Set(e),i=(0,a.Z)(t.values());try{for(i.s();!(r=i.n()).done;){var s=r.value;n.delete(s)}}catch(u){i.e(u)}finally{i.f()}return n}var H=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._hasGlobalIds=!1,n}return(0,l.Z)(r,[{key:"normalizeCtorArgs",value:function(e){return this._queueProcessor=new x.a({concurrency:1,process:e.process}),{}}},{key:"destroy",value:function(){this.clear()}},{key:"updating",get:function(){return this._queueProcessor.length>0}},{key:"clear",value:function(){this._queueProcessor.clear()}},{key:"push",value:function(e){var t=this,r=this._queueProcessor,n=r.last();switch(e.type){case"update":case"refresh":if((null===n||void 0===n?void 0:n.type)===e.type)return;r.push(e).finally((function(){return t.notifyChange("updating")}));break;case"edit":var i="processed-edit"===(null===n||void 0===n?void 0:n.type)?n:null;i&&r.popLast();var s,u=this._mergeEdits(i,e),o=(0,a.Z)(u);try{for(o.s();!(s=o.n()).done;){var l=s.value;r.push(l).finally((function(){return t.notifyChange("updating")}))}}catch(c){o.e(c)}finally{o.f()}}this.notifyChange("updating")}},{key:"_mergeEdits",value:function(e,t){var r,n,i=t.edits,a=i.addedFeatures,u=i.deletedFeatures,o=i.updatedFeatures;if(this._hasGlobalIds=this._hasGlobalIds||J(a)||J(o)||J(u),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[].concat((0,s.Z)(a),(0,s.Z)(o)),removed:u}}];var l=new Set(j(null!==(r=null===e||void 0===e?void 0:e.edits.addOrModified)&&void 0!==r?r:[])),c=new Set(j(null!==(n=null===e||void 0===e?void 0:e.edits.removed)&&void 0!==n?n:[])),p=new Set([].concat((0,s.Z)(j(a)),(0,s.Z)(j(o)))),h=new Set(j(u));return[{type:"processed-edit",edits:{addOrModified:Array.from(z(L(l,h),p)).map((function(e){return{objectId:e}})),removed:Array.from(z(L(c,p),h)).map((function(e){return{objectId:e}}))}}]}}]),r}(h.y);(0,h.e)([(0,h.d)({readOnly:!0})],H.prototype,"updating",null);var M=H=(0,h.e)([(0,h.n)("esri.views.2d.layers.support.FeatureCommandQueue")],H);function Q(e){return Array.isArray(e)}var D=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e))._startupResolver=(0,h.aO)(),n.isReady=!1,n}return(0,l.Z)(r,[{key:"initialize",value:function(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}},{key:"destroy",value:function(){this._controller.abort(),this._connection&&this._connection.close()}},{key:"tileRenderer",set:function(e){this.client.tileRenderer=e}},{key:"closed",get:function(){return this._connection.closed}},{key:"startup",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n,s){var a,u,o;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.when();case 2:return a=this._controller.signal,u=Q(n.source)?{transferList:n.source,signal:a}:void 0,o={service:n,config:r,tileInfo:t.tileInfo.toJSON(),tiles:s},e.next=5,this._connection.invoke("startup",o,u);case 5:this._startupResolver.resolve(),this._set("isReady",!0);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,h.av)(this._connection.invoke("updateTiles",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={config:t},e.next=3,this._startupResolver.promise;case 3:return e.abrupt("return",this._connection.invoke("update",r));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("applyUpdate",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setHighlight",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,h.av)(this._connection.invoke("controller.setHighlight",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:if(this.closed){e.next=4;break}return e.abrupt("return",(0,h.av)(this._connection.invoke("stop")));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,h.av)(this._connection.invoke("controller.refresh",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"querySummaryStatistics",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatures",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryVisibleFeatures",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryVisibleFeatures",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryObjectIds",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryObjectIds",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryFeatureCount",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatureCount",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._connection.invoke("controller.queryExtent",t.toJSON(),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryLatestObservations",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryLatestObservations",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryStatistics",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryStatistics",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getObjectId",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getDisplayId",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getDisplayId",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFeatures",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getFeatures",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getAggregates",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregates"));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getAggregateValueRanges",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregateValueRanges"));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"mapValidDisplayIds",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.mapValidDisplayIds",t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onEdits",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,h.av)(this._connection.invoke("controller.onEdits",t)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"enableEvent",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,h.av)(this._connection.invoke("controller.enableEvent",{name:t,value:r})));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"pauseStream",value:function(){return(0,h.av)(this._connection.invoke("controller.pauseStream"))}},{key:"resumeStream",value:function(){return(0,h.av)(this._connection.invoke("controller.resumeStream"))}},{key:"_startWorker",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,R.u)("Pipeline",{client:this.client,strategy:"dedicated",signal:t});case 3:this._connection=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),(0,h.F)(e.t0);case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(Z._);(0,h.e)([(0,h.d)()],D.prototype,"isReady",void 0),(0,h.e)([(0,h.d)()],D.prototype,"client",void 0),(0,h.e)([(0,h.d)()],D.prototype,"tileRenderer",null);var B=D=(0,h.e)([(0,h.n)("esri.views.2d.layers.support.FeatureLayerProxy")],D),G=function(){function e(t){(0,o.Z)(this,e),this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}return(0,l.Z)(e,[{key:"destroy",value:function(){}},{key:"clear",value:function(){var e=this;this._tiles.forEach((function(t){return e._releaseTile(t)}))}},{key:"tileKeys",value:function(){var e=[];return this._tiles.forEach((function(t,r){return e.push(r)})),e}},{key:"update",value:function(e){var t,r=this,n=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),i=n.spans,s=n.lodInfo,u=s.level,o=[],l=[],c=new Set,p=new Set,h=(0,a.Z)(i);try{for(h.s();!(t=h.n()).done;)for(var d=t.value,f=d.row,y=d.colFrom,v=d.colTo,g=y;g<=v;g++){var _=q.e.getId(u,f,s.normalizeCol(g),s.getWorldForColumn(g)),m=this._getOrAcquireTile(o,_);c.add(_),m.isReady?m.visible=!0:p.add(m.key)}}catch(k){h.e(k)}finally{h.f()}return p.forEach((function(e){return r._addPlaceholders(c,e)})),this._tiles.forEach((function(e){c.has(e.key.id)||(l.push(e.key.id),r._releaseTile(e))})),x.b.pool.release(n),{hasMissingTiles:p.size>0,added:o,removed:l}}},{key:"_getOrAcquireTile",value:function(e,t){if(!this._tiles.has(t)){var r=this.acquireTile(new q.e(t));e.push(t),this._tiles.set(t,r),r.visible=!1}return this._tiles.get(t)}},{key:"_getTile",value:function(e){return this._tiles.get(e)}},{key:"_releaseTile",value:function(e){this._tiles.delete(e.key.id),this.releaseTile(e)}},{key:"_addPlaceholders",value:function(e,t){var r=this._addPlaceholderChildren(e,t);Math.abs(1-r)<1e-6||this._addPlaceholderParent(e,t)||(this._getTile(t.id).visible=!0)}},{key:"_addPlaceholderChildren",value:function(e,t){var r=this,n=0;return this._tiles.forEach((function(i){n+=r._addPlaceholderChild(e,i,t)})),n}},{key:"_addPlaceholderChild",value:function(e,t,r){return t.key.level<=r.level||!t.hasData||!r.contains(t.key)?0:(t.visible=!0,e.add(t.key.id),1/(1<<2*(t.key.level-r.level)))}},{key:"_addPlaceholderParent",value:function(e,t){for(var r=t.getParentKey(),n=0,i=null;(0,h.r)(r);){if(e.has(r.id))return!0;var s=this._getTile(r.id);if(null!==s&&void 0!==s&&s.isReady)return s.visible=!0,e.add(s.key.id),!0;null!==s&&void 0!==s&&s.hasData&&s.patchCount>n&&(n=s.patchCount,i=s),r=r.getParentKey()}return!!i&&(i.visible=!0,e.add(i.key.id),!0)}}]),e}();function K(e){return e&&"openPorts"in e}var W=h.s.getLogger("esri.views.2d.layers.FeatureLayerView2D"),X=function(e){(0,c.Z)(r,e);var t=(0,p.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments))._pipelineIsUpdating=!0,e._commandsQueue=new M({process:function(t){switch(t.type){case"processed-edit":return e._doEdit(t);case"refresh":return e._doRefresh(t.dataChanged);case"update":return e._doUpdate()}}}),e._visibilityOverrides=new Set,e._highlightIds=new Map,e._updateHighlight=(0,h.B)((0,u.Z)((0,i.Z)().mark((function t(){return(0,i.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e._proxy.setHighlight(Array.from(e._highlightIds.keys())));case 1:case"end":return t.stop()}}),t)})))),e._uploadsLocked=!1,e._needsClusterSizeUpdate=!1,e.featureEffectView=new P,e._lastDefinitionExpression=null,e}return(0,l.Z)(r,[{key:"destroy",value:function(){var e;(0,h.aq)(this._updateClusterSizeTask,(function(e){return e.remove()})),null!==(e=this._proxy)&&void 0!==e&&e.destroy(),this._commandsQueue.destroy()}},{key:"initialize",value:function(){var e=this;this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",(function(t){e._set("_aggregateValueRanges",t.valueRanges)})),(0,y.l)((function(){return e.featureEffect}),(function(t){e.featureEffectView.featureEffect=t}),{initial:!0,sync:!0})])}},{key:"_initProxy",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){var t,r,n,s;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("isTable"in(t=this.layer))||!t.isTable){e.next=3;break}throw new h.a("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});case 3:if(r="feature"===t.type||"subtype-group"===t.type,n="capabilities"in t&&t.capabilities.operations.supportsQuery,!r||n){e.next=6;break}throw new h.a("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t});case 6:return this._proxy&&this._proxy.destroy(),s=this._createClientOptions(),e.abrupt("return",(this._set("_proxy",new B({client:s})),this._proxy.when()));case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initServiceOptions",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this._createServiceOptions();case 3:return e.t1=e.sent,e.t0._set.call(e.t0,"_serviceOptions",e.t1),e.abrupt("return",this._serviceOptions);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"orderByFields",get:function(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}},{key:"labelsVisible",get:function(){var e="subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer];return!this.suspended&&e.some((function(e){return e.labelingInfo&&e.labelsVisible}))}},{key:"queryMode",get:function(){return this._serviceOptions.type}},{key:"renderingConfigHash",get:function(){if(!this.layer)return null;var e=this.availableFields,t=this.layer,r=this.view.floors,n=t.definitionExpression,i="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,s="renderer"in t&&t.renderer,a="feature"===t.type?t.gdbVersion:void 0,u="feature"===t.type&&t.historicMoment?t.historicMoment.getTime():void 0,o=this.timeExtent,l="customParameters"in t?JSON.stringify(t.customParameters):void 0,c="apiKey"in t?t.apiKey:void 0,p="stream"===t.type?"".concat(JSON.stringify(t.geometryDefinition)).concat(t.definitionExpression):null,d=JSON.stringify(this.clips),f=t.featureReduction&&t.featureReduction.toJSON(),y="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),v="sublayers"in this.layer&&this.layer.sublayers.items.reduce((function(e,t){return e+"".concat(t.visible?1:0,".").concat(JSON.stringify(t.renderer),".").concat(t.labelsVisible,"\n.").concat(JSON.stringify(t.labelingInfo))}),""),g="subtypeCode"in this.layer&&this.layer.subtypeCode;return JSON.stringify({orderBy:y,sublayerHash:v,subtypeCode:g,filterHash:(0,h.r)(this.filter)&&this.filter.toJSON(),effectHash:(0,h.r)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:p,gdbVersion:a,definitionExpression:n,historicMoment:u,availableFields:e,renderer:s,labelingInfo:i,timeExtent:o,floors:r,clipsHash:d,featureReduction:f,customParameters:l,apiKey:c})}},{key:"highlight",value:function(e){var t,r,n=this;return e instanceof d.g?r=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?r=[e]:Array.isArray(e)&&e.length>0?r="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((function(e){return null===e||void 0===e?void 0:e.getObjectId()})):f.j.isCollection(e)&&e.length>0&&(r=e.map((function(e){return null===e||void 0===e?void 0:e.getObjectId()})).toArray()),r=null===(t=r)||void 0===t?void 0:t.filter((function(e){return null!=e})),r&&r.length?(this._addHighlight(r),{remove:function(){return n._removeHighlight(r)}}):{remove:function(){}}}},{key:"hasHighlight",value:function(){return!!this._highlightIds.size}},{key:"hitTest",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){var n,a,u,o,l=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.tileRenderer){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this.tileRenderer.hitTest(r);case 4:if(0!==(n=e.sent).length){e.next=7;break}return e.abrupt("return",null);case 7:return e.next=9,this._proxy.getFeatures(n);case 9:return a=e.sent,u=a.features,o=a.aggregates,e.abrupt("return",[].concat((0,s.Z)(o.map((function(e){return l._createGraphicHit(t,U.fromJSON(e))}))),(0,s.Z)(u.map((function(e){return l._createGraphicHit(t,d.g.fromJSON(e))})))));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryAggregates",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._proxy.getAggregates();case 2:return e.abrupt("return",e.sent.map((function(e){return U.fromJSON(e)})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"queryStatistics",value:function(){return this._proxy.queryStatistics()}},{key:"querySummaryStatistics",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,s){var a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,n.Z)((0,n.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.querySummaryStatistics(this._cleanUpQuery(t),a,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,s){var a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,n.Z)((0,n.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryUniqueValues(this._cleanUpQuery(t),a,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,s){var a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,n.Z)((0,n.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryClassBreaks(this._cleanUpQuery(t),a,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,s){var a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,n.Z)((0,n.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryHistogram(this._cleanUpQuery(t),a,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){var r=this;return this.queryFeaturesJSON(e,t).then((function(e){var t=_.default.fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryVisibleFeatures",value:function(e,t){var r=this;return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then((function(e){var t=_.default.fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryFeaturesJSON",value:function(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}},{key:"queryObjectIds",value:function(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}},{key:"queryFeatureCount",value:function(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}},{key:"queryExtent",value:function(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((function(e){return{count:e.count,extent:T.M.fromJSON(e.extent)}}))}},{key:"setVisibility",value:function(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}},{key:"update",value:function(e){if(this._tileStrategy&&this.tileRenderer){var t=this._tileStrategy.update(e),r=t.hasMissingTiles,n=t.added,i=t.removed;(n.length||i.length)&&this._proxy.updateTiles({added:n,removed:i}),r&&this.requestUpdate(),this.notifyChange("updating")}}},{key:"attach",value:function(){var e=this;this.view.timeline.record("".concat(this.layer.title," (FeatureLayer) Attach")),this._tileStrategy=new G({acquireTile:function(t){return e._acquireTile(t)},releaseTile:function(t){return e._releaseTile(t)},tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,y.l)((function(){return e.renderingConfigHash}),(function(){return e._update()}),y.h),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(function(t){return e._edit(t)})),"attach")}},{key:"detach",value:function(){var e;this._commandsQueue.clear(),null!==(e=this._proxy)&&void 0!==e&&e.stop(),this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"isUpdating",value:function(){var e,t="renderer"in this.layer&&null!=this.layer.renderer,r=this._commandsQueue.updating,n=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,a=null==this.tileRenderer||(null===(e=this.tileRenderer)||void 0===e?void 0:e.updating),u=t&&(r||n||i||s||a);return(0,h.c)("esri-2d-log-updating")&&console.log("Updating FLV2D: ".concat(u,"\n  -> hasRenderer ").concat(t,"\n  -> hasPendingCommand ").concat(r,"\n  -> updatingRequiredFields ").concat(n,"\n  -> updatingProxy ").concat(i,"\n  -> updatingPipeline ").concat(s,"\n  -> updatingTileRenderer ").concat(a,"\n")),u}},{key:"_createClientOptions",value:function(){var e=this;return{setUpdating:function(t){e._set("_pipelineIsUpdating",t)},emitEvent:function(t){e.emit(t.name,t.event)}}}},{key:"_detectQueryMode",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){var r,n,s,a,u,o,l,c,p,d,f,y,v,g;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="path"in t,s="editingInfo"in this.layer&&(null===(r=this.layer.editingInfo)||void 0===r?void 0:r.lastEditDate),a=!!this.layer.refreshInterval,u=!s&&a,!n||"feature"!==this.layer.type&&"subtype-group"!==this.layer.type||"point"!==this.layer.geometryType||!this.layer.capabilities.query.supportsPagination||this.layer.capabilities.operations.supportsEditing||u||!(0,h.c)("featurelayer-snapshot-enabled")){e.next=16;break}return e.prev=2,e.next=5,this.layer.queryFeatureCount();case 5:if(!((o=e.sent)<=(0,h.c)("featurelayer-snapshot-point-min-threshold"))){e.next=8;break}return e.abrupt("return",{mode:"snapshot",featureCount:o});case 8:if(l=(0,h.c)("featurelayer-snapshot-point-max-threshold"),c=(0,h.c)("featurelayer-snapshot-point-coverage"),p=this.view.extent,d=(0,h.g)(this.layer.fullExtent),f=null===d||void 0===d?void 0:d.clone().intersection(p),y=(0,h.r)(f)?f.width*f.height:0,v=(null===d||void 0===d?void 0:d.width)*(null===d||void 0===d?void 0:d.height),g=0===v?0:y/v,!(o<=l&&g>=c)){e.next=11;break}return e.abrupt("return",{mode:"snapshot",featureCount:o});case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),W.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:e.t0});case 16:return e.abrupt("return",{mode:"on-demand"});case 17:case"end":return e.stop()}}),e,this,[[2,13]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_createServiceOptions",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){var t,r,n,s,a,u,o,l,c,p,d,f,y,v,g,_,m,k;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("stream"!==(r=this.layer).type){e.next=3;break}return e.abrupt("return",null);case 3:if(n=r.capabilities,s=r.objectIdField,a=r.fields.map((function(e){return e.toJSON()})),u=(0,h.r)(r.fullExtent)&&r.fullExtent.toJSON(),o=(0,S.e)(r.geometryType),l=r.timeInfo&&r.timeInfo.toJSON()||null,c=r.spatialReference?r.spatialReference.toJSON():null,p="feature"===r.type?r.globalIdField:null,"ogc-feature"!==r.type){e.next=8;break}d=r.source.getFeatureDefinition(),e.next=15;break;case 8:if(!K(r.source)){e.next=14;break}return e.next=11,r.source.openPorts();case 11:d=e.sent,e.next=15;break;case 14:r.parsedUrl&&(d=(0,h.m)(r.parsedUrl),"dynamicDataSource"in r&&r.dynamicDataSource&&(d.query={layer:JSON.stringify({source:r.dynamicDataSource})}));case 15:return f="datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,y=null!==(t="subtypeField"in this.layer&&this.layer.subtypeField)&&void 0!==t?t:null,e.next=19,this._detectQueryMode(d);case 19:return v=e.sent,g=v.mode,_=v.featureCount,m=this.layer.objectIdField,"feature"===this.layer.type&&(0,h.r)(this.layer.orderBy)&&this.layer.orderBy.length&&(k=!this.layer.orderBy[0].valueExpression&&this.layer.orderBy[0].field)&&(m=k),e.abrupt("return",{type:g,timeReferenceUnknownClient:f,subtypeField:y,featureCount:_,globalIdField:p,maxRecordCount:n.query.maxRecordCount,tileMaxRecordCount:n.query.tileMaxRecordCount,capabilities:n,fields:a,fullExtent:u,geometryType:o,objectIdField:s,source:d,timeInfo:l,spatialReference:c,orderByFields:m});case 25:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_createMemoryServiceOptions",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.openPorts();case 2:return r=e.sent,e.abrupt("return",(0,n.Z)((0,n.Z)({},this._createServiceOptions()),{},{type:"memory",source:r}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_cleanUpQuery",value:function(e){var t=m.b.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}},{key:"_update",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._commandsQueue.push({type:"update"}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_edit",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended){e.next=2;break}return e.abrupt("return",void this._clearTiles());case 2:return e.abrupt("return",this._validateEdit(t)?this._commandsQueue.push({type:"edit",edits:t}):void 0);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"doRefresh",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._tileStrategy.tileKeys().length){e.next=2;break}return e.abrupt("return",this.suspended&&t?void this._clearTiles():this._commandsQueue.push({type:"refresh",dataChanged:t}));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_clearTiles",value:function(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}},{key:"_validateEdit",value:function(e){var t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some((function(e){return-1===e.objectId||!e.objectId})),n=t&&this.availableFields.includes(t);return r&&!n?(W.error(new h.a("mapview-apply-edits","Editing the specified service requires the layer's globalIdField, ".concat(t," to be included the layer's outFields for updates to be reflected on the map"))),null):e}},{key:"_doUpdate",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(){var t,r,n,s,a,u,o,l,c,p,d,f,y;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.destroyed&&this._hasRequiredSupport(this.layer)&&this._tileStrategy){e.next=3;break}return e.abrupt("return");case 3:return t=this.featureEffectView,r=this.filter,e.next=6,this._updateRequiredFields();case 6:if(n=this._getEffectiveRenderer(),s=n.renderer,this._set("_effectiveRenderer",s),a=this._createSchemaConfig(),u=this._createConfiguration(a,r,t.filter),o=this._lastDefinitionExpression!==u.schema.source.definitionExpression,this._lastDefinitionExpression=u.schema.source.definitionExpression,l=u.schema.tileRenderer,c=this._createTileRendererHash(l),"snapshot"===this._serviceOptions.type&&(u.schema.source.featureCount=this._serviceOptions.featureCount),c===this._tileRendererHash){e.next=41;break}return e.next=14,this._initTileRenderer(l,s);case 14:if("stream"!==(p=this.layer).type){e.next=21;break}return e.next=18,this._initServiceOptions();case 18:e.t0=e.sent,e.next=22;break;case 21:e.t0=this._serviceOptions;case 22:if(d=e.t0,this.tileRenderer.onConfigUpdate(s),e.t1="stream"!==p.type&&K(p.source),!e.t1){e.next=29;break}return e.next=28,p.source.openPorts();case 28:d.source=e.sent;case 29:return f={added:this._tileStrategy.tileKeys(),removed:[]},e.next=32,this._proxy.startup(this.view.featuresTilingScheme,u,d,f);case 32:if(e.t2=this.hasHighlight(),!e.t2){e.next=36;break}return e.next=36,this._proxy.setHighlight(Array.from(this._highlightIds.keys()));case 36:return e.next=38,this._onceTilesUpdated();case 38:this.tileRenderer.onConfigUpdate(s),e.next=59;break;case 41:if(e.t3="snapshot"===this._serviceOptions.type&&o,!e.t3){e.next=46;break}return e.next=45,this.layer.queryFeatureCount();case 45:u.schema.source.featureCount=e.sent;case 46:return e.next=48,this._proxy.update(u);case 48:return((y=e.sent).mesh||y.targets.aggregate)&&this._lockGPUUploads(),e.prev=50,e.next=53,this._proxy.applyUpdate(y);case 53:e.next=58;break;case 55:e.prev=55,e.t4=e.catch(50),(0,h.I)(e.t4)||W.error(e.t4);case 58:(y.mesh||y.targets.aggregate)&&this._unlockGPUUploads(),this.tileRenderer.onConfigUpdate(s),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload();case 59:this._tileRendererHash=c,this.tileRenderer.invalidateLabels(),this.requestUpdate(),e.next=64;break;case 62:e.prev=62,e.t5=e.catch(0);case 64:case"end":return e.stop()}}),e,this,[[0,62],[50,55]])})));return function(){return e.apply(this,arguments)}}()},{key:"_doEdit",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._proxy.onEdits(t);case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_doRefresh",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._lockGPUUploads(),e.prev=1,e.next=4,this._proxy.refresh(t);case 4:e.next=8;break;case 6:e.prev=6,e.t0=e.catch(1);case 8:this._unlockGPUUploads(),(null===(r=this.layer)||void 0===r?void 0:r.featureReduction)&&this._updateClusterSizeVariable();case 9:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateClusterSizeVariable",value:function(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}},{key:"_createUpdateClusterSizeTask",value:function(e,t){var r=this;return(0,y.l)((function(){return r._aggregateValueRanges}),(function(n){r._updateClusterEffectiveRendererSizeVariable(e,t,n),r._needsClusterSizeUpdate=!0,r._uploadsLocked||r._updateClusterSizeVariable()}))}},{key:"_updateClusterEffectiveRendererSizeVariable",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r,n){var s,a,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables&&(s=(0,w.d)(t.visualVariables),(0,h.r)(s)&&"cluster_count"===s.field&&(a=t.visualVariables.indexOf(s),t.visualVariables[a]=(0,w.f)(r,n),(u=t.clone()).dynamicClusterSize=!0,this._set("_effectiveRenderer",u)));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_getEffectiveRenderer",value:function(){var e="renderer"in this.layer&&this.layer.renderer,t=this.layer.featureReduction;if((0,h.r)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),t&&"renderer"in t&&t.renderer){var r,n,i=[],s=(0,a.Z)(null!==(r=t.fields)&&void 0!==r?r:[]);try{for(s.s();!(n=s.n()).done;){var u=n.value;(0,w.x)(i,u)}}catch(p){s.e(p)}finally{s.f()}return{renderer:t.renderer,aggregateFields:i,featureReduction:t}}if(t&&"cluster"===t.type&&(0,w.m)(e)){var o=t,l=[],c=(0,w.c)(l,e,o,this._aggregateValueRanges);return(0,h.aq)(this._updateClusterSizeTask,(function(e){return e.remove()})),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(c,o),{renderer:c,aggregateFields:l,featureReduction:t}}return{renderer:e,aggregateFields:[],featureReduction:null}}},{key:"_acquireTile",value:function(e){var t=this,r=this.tileRenderer.acquireTile(e);return r.once("attach",(function(){t.requestUpdate()})),r}},{key:"_releaseTile",value:function(e){this.tileRenderer.releaseTile(e)}},{key:"_initTileRenderer",value:function(){var e=(0,u.Z)((0,i.Z)().mark((function e(t,r){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});case 2:return n=e.sent,e.abrupt("return",(this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer.destroy(),this.tileRenderer=null),this.destroyed?null:(this._proxy.tileRenderer=n,this._set("tileRenderer",n),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(r),this.requestUpdate(),this.tileRenderer)));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createTileRendererHash",value:function(e){return"".concat(e.type)}},{key:"hasFilter",get:function(){var e=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||e||!!this._visibilityOverrides.size||!!this.timeExtent}},{key:"_injectOverrides",value:function(e){var t=(0,h.r)(e)?e.timeExtent:null,r=(0,h.r)(this.timeExtent)&&(0,h.r)(t)?this.timeExtent.intersection(t):this.timeExtent||t,n=null,i="floorInfo"in this.layer&&this.layer.floorInfo;if(i){var s=(0,h.r)(e)&&e.where;n=this._addFloorFilterClause(s)}if(!this._visibilityOverrides.size&&!r&&!i)return(0,h.r)(e)?e.toJSON():null;(e=(0,h.r)(e)&&e.clone()||new g.y).timeExtent=r,n&&(e.where=n);var a=e.toJSON();return a.hiddenIds=Array.from(this._visibilityOverrides),a}},{key:"_addFloorFilterClause",value:function(e){var t=this.layer,r=e||"";if("floorInfo"in t&&t.floorInfo){var n,i=this.view.floors;if(!i||!i.length)return r;(null===(n=t.floorInfo.viewAllLevelIds)||void 0===n?void 0:n.length)&&(i=t.floorInfo.viewAllLevelIds);var s=i.filter((function(e){return""!==e})).map((function(e){return"'"+e+"'"}));s.push("''");var a=t.floorInfo.floorField,u="("+a+" IN ({ids}) OR "+a+" IS NULL)";if(u=u.replace("{ids}",s.join(", ")),(0,h.r)(r)&&r.includes(a)){var o=new RegExp("AND \\("+a+".*NULL\\)","g");r=r.replace(o,""),o=new RegExp("\\("+a+".*NULL\\)","g"),r=(r=r.replace(o,"")).replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+u:u}return""!==r?r:null}},{key:"_createConfiguration",value:function(e,t,r){var n="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,i="feature"===this.layer.type?this.layer.gdbVersion:void 0,s=new Array(k.S),a=this._injectOverrides(t);s[0]=a,s[1]=(0,h.r)(r)?r.toJSON():null;var u=(0,w.z)(e);if((0,h.t)(u))return null;var o=(0,O.l)("2d");return{availableFields:this.availableFields,gdbVersion:i,historicMoment:n,devicePixelRatio:window.devicePixelRatio||1,filters:s,schema:u,supportsTextureFloat:o.supportsTextureFloat,maxTextureSize:o.maxTextureSize}}},{key:"_hasRequiredSupport",value:function(e){return!("renderer"in e)||(0,w.v)(e.renderer)}},{key:"_onceTilesUpdated",value:function(){var e=this;return this.requestUpdate(),(0,y.j)((function(){return!e._pipelineIsUpdating}))}},{key:"_lockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}},{key:"_unlockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}},{key:"_forceAttributeTextureUpload",value:function(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}},{key:"_createSchemaConfig",value:function(){var e="feature"===this.layer.type?this.layer.historicMoment:null,t="feature"===this.layer.type?this.layer.gdbVersion:null;return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:e,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:t,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:(0,n.Z)((0,n.Z)({},"customParameters"in this.layer?this.layer.customParameters:void 0),{},{token:"apiKey"in this.layer?this.layer.apiKey:void 0}),subtypeCode:"subtypeCode"in this.layer?this.layer.subtypeCode:void 0,subtypeField:"subtypeField"in this.layer?this.layer.subtypeField:void 0}}},{key:"_addHighlight",value:function(e){var t,r=(0,a.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this._highlightIds.has(n)){var i=this._highlightIds.get(n);this._highlightIds.set(n,i+1)}else this._highlightIds.set(n,1)}}catch(s){r.e(s)}finally{r.f()}this._updateHighlight().catch((function(e){(0,h.I)(e)||W.error(e)}))}},{key:"_removeHighlight",value:function(e){var t,r=(0,a.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this._highlightIds.has(n)){var i=this._highlightIds.get(n)-1;0===i?this._highlightIds.delete(n):this._highlightIds.set(n,i)}}}catch(s){r.e(s)}finally{r.f()}this._updateHighlight().catch((function(e){(0,h.I)(e)||W.error(e)}))}},{key:"_setLayersForFeature",value:function(e){var t=this.layer;e.layer=t,e.sourceLayer=t}},{key:"_createGraphicHit",value:function(e,t){return this._setLayersForFeature(t),(0,h.r)(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}}]),r}((0,E.A)((0,I.i)((0,b.f)(C.u))));(0,h.e)([(0,h.d)()],X.prototype,"_serviceOptions",void 0),(0,h.e)([(0,h.d)()],X.prototype,"_proxy",void 0),(0,h.e)([(0,h.d)()],X.prototype,"_pipelineIsUpdating",void 0),(0,h.e)([(0,h.d)()],X.prototype,"_effectiveRenderer",void 0),(0,h.e)([(0,h.d)()],X.prototype,"_aggregateValueRanges",void 0),(0,h.e)([(0,h.d)()],X.prototype,"_commandsQueue",void 0),(0,h.e)([(0,h.d)()],X.prototype,"featureEffectView",void 0),(0,h.e)([(0,h.d)()],X.prototype,"labelsVisible",null),(0,h.e)([(0,h.d)({readOnly:!0})],X.prototype,"queryMode",null),(0,h.e)([(0,h.d)()],X.prototype,"renderingConfigHash",null),(0,h.e)([(0,h.d)()],X.prototype,"tileRenderer",void 0),(0,h.e)([(0,h.d)()],X.prototype,"updating",void 0);var Y=X=(0,h.e)([(0,h.n)("esri.views.2d.layers.FeatureLayerView2D")],X);t.default=Y},35744:function(e,t,r){r.d(t,{f:function(){return O}});var n,i=r(11752),s=r(61120),a=r(43144),u=r(15671),o=r(60136),l=r(29388),c=r(50165),p=r(40133),h=r(42687),d=r(73627),f=r(14527),y=r(32335),v=(r(33530),r(77322)),g=r(78664),_=r(96263),m=r(31278),k=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(){return(0,u.Z)(this,r),t.apply(this,arguments)}return(0,a.Z)(r)}(y.l),b=k=(0,c.e)([(0,c.n)("esri.views.layers.support.ClipArea")],k),w=n=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(){var e;return(0,u.Z)(this,r),(e=t.apply(this,arguments)).type="rect",e.left=null,e.right=null,e.top=null,e.bottom=null,e}return(0,a.Z)(r,[{key:"clone",value:function(){return new n({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}},{key:"version",get:function(){return(this._get("version")||0)+1}}]),r}(b);(0,c.e)([(0,c.d)({type:[Number,String],json:{write:!0}})],w.prototype,"left",void 0),(0,c.e)([(0,c.d)({type:[Number,String],json:{write:!0}})],w.prototype,"right",void 0),(0,c.e)([(0,c.d)({type:[Number,String],json:{write:!0}})],w.prototype,"top",void 0),(0,c.e)([(0,c.d)({type:[Number,String],json:{write:!0}})],w.prototype,"bottom",void 0),(0,c.e)([(0,c.d)({readOnly:!0})],w.prototype,"version",null);var x,Z=w=n=(0,c.e)([(0,c.n)("esri.views.layers.support.ClipRect")],w),R={base:v.p,key:"type",typeMap:{extent:_.M,polygon:m.v}},S=x=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(){var e;return(0,u.Z)(this,r),(e=t.apply(this,arguments)).type="geometry",e.geometry=null,e}return(0,a.Z)(r,[{key:"version",get:function(){return(this._get("version")||0)+1}},{key:"clone",value:function(){return new x({geometry:this.geometry.clone()})}}]),r}(b);(0,c.e)([(0,c.d)({types:R,json:{read:g.d,write:!0}})],S.prototype,"geometry",void 0),(0,c.e)([(0,c.d)({readOnly:!0})],S.prototype,"version",null);var q=S=x=(0,c.e)([(0,c.n)("esri.views.layers.support.Geometry")],S),E=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(){var e;return(0,u.Z)(this,r),(e=t.apply(this,arguments)).type="path",e.path=[],e}return(0,a.Z)(r,[{key:"version",get:function(){return(this._get("version")||0)+1}}]),r}(b);(0,c.e)([(0,c.d)({type:[[[Number]]],json:{write:!0}})],E.prototype,"path",void 0),(0,c.e)([(0,c.d)({readOnly:!0})],E.prototype,"version",null);var C=E=(0,c.e)([(0,c.n)("esri.views.layers.support.Path")],E),I=p.j.ofType({key:"type",base:b,typeMap:{rect:Z,path:C,geometry:q}}),O=function(e){var t=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(){var e;return(0,u.Z)(this,r),(e=t.apply(this,arguments)).attached=!1,e.clips=new I,e.lastUpdateId=-1,e.moving=!1,e.updateRequested=!1,e}return(0,a.Z)(r,[{key:"initialize",value:function(){var e,t,r,n,i=this,s=null===(e=null===(t=this.view)||void 0===t?void 0:t.spatialReferenceLocked)||void 0===e||e;(null===(r=this.view)||void 0===r?void 0:r.spatialReference)&&s&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new c.a("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new f.s),this.container.fadeTransitionEnabled=!0,this.container.opacity=0,this.container.clips=this.clips,this.handles.add([(0,d.l)((function(){return i.suspended}),(function(e){i.container&&(i.container.visible=!e),i.view&&!e&&i.updateRequested&&i.view.requestUpdate()}),d.w),(0,d.l)((function(){var e,t;return null!==(e=null===(t=i.layer)||void 0===t?void 0:t.opacity)&&void 0!==e?e:1}),(function(e){i.container&&(i.container.opacity=e)}),d.w),(0,d.l)((function(){return i.layer&&"blendMode"in i.layer?i.layer.blendMode:"normal"}),(function(e){i.container&&(i.container.blendMode=e)}),d.w),(0,d.l)((function(){return i.layer&&"effect"in i.layer?i.layer.effect:null}),(function(e){i.container&&(i.container.effect=e)}),d.w),(0,d.a)((function(){return i.clips}),"change",(function(){i.container&&(i.container.clips=i.clips)}))]),null!==(n=this.view)&&void 0!==n&&n.whenLayerView?this.view.whenLayerView(this.layer).then((function(e){e===i&&i.processAttach()}),(function(){})):this.when().then((function(){i.processAttach()}),(function(){})))}},{key:"destroy",value:function(){this.processDetach(),this.updateRequested=!1}},{key:"spatialReferenceSupported",get:function(){var e,t=null===(e=this.view)||void 0===e?void 0:e.spatialReference;return null==t||this.supportsSpatialReference(t)}},{key:"updating",get:function(){var e;return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!(null===(e=this.updatingHandles)||void 0===e||!e.updating))}},{key:"visibleAtCurrentScale",get:function(){return this.isVisibleAtScale(this.view.scale)}},{key:"processAttach",value:function(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}},{key:"processDetach",value:function(){this.attached&&(this.attached=!1,this.detach(),this.updateRequested=!1)}},{key:"isVisibleAtScale",value:function(e){var t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!t)return!0;var r=t.minScale,n=t.maxScale;return(0===r||e<=r)&&(0===n||e>=n)}},{key:"requestUpdate",value:function(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}},{key:"processUpdate",value:function(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}},{key:"hitTest",value:function(e,t){return Promise.resolve(null)}},{key:"supportsSpatialReference",value:function(e){return!0}},{key:"canResume",value:function(){return!!this.spatialReferenceSupported&&!!(0,i.Z)((0,s.Z)(r.prototype),"canResume",this).call(this)&&this.visibleAtCurrentScale}},{key:"getSuspendInfo",value:function(){var e=(0,i.Z)((0,s.Z)(r.prototype),"getSuspendInfo",this).call(this),t=!this.spatialReferenceSupported,n=this.visibleAtCurrentScale;return t&&(e.spatialReferenceNotSupported=t),n&&(e.outsideScaleRange=n),e}}]),r}(e);return(0,c.e)([(0,c.d)()],t.prototype,"attached",void 0),(0,c.e)([(0,c.d)({type:I,set:function(e){var t=(0,h.n)(e,this._get("clips"),I);this._set("clips",t)}})],t.prototype,"clips",void 0),(0,c.e)([(0,c.d)()],t.prototype,"container",void 0),(0,c.e)([(0,c.d)()],t.prototype,"moving",void 0),(0,c.e)([(0,c.d)({readOnly:!0})],t.prototype,"spatialReferenceSupported",null),(0,c.e)([(0,c.d)({readOnly:!0})],t.prototype,"updateParameters",void 0),(0,c.e)([(0,c.d)()],t.prototype,"updateRequested",void 0),(0,c.e)([(0,c.d)()],t.prototype,"updating",null),(0,c.e)([(0,c.d)()],t.prototype,"view",void 0),(0,c.e)([(0,c.d)({readOnly:!0})],t.prototype,"visibleAtCurrentScale",null),t=(0,c.e)([(0,c.n)("esri.views.2d.layers.LayerView2D")],t)}}}]);
//# sourceMappingURL=6893.f5234a48.chunk.js.map