"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[830],{81216:function(e,t,r){r.d(t,{r:function(){return d}});var i=r(93433),n=r(37762),a=r(15671),s=r(43144),u=r(60136),o=r(29388),l=r(37856),c=r(93314),h=r(48848),d=function(e){(0,u.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments))._set=new Set,e}return(0,s.Z)(r,[{key:"clear",value:function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:c.E.REMOVE}),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._set.size}},{key:"addMany",value:function(e){if(0!==e.length){var t,r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._set.add(i)}}catch(a){r.e(a)}finally{r.f()}this.emit("after-changes",{type:c.E.ADD}),this.emit("change",{added:e,removed:[]})}}},{key:"remove",value:function(e){this._set.delete(e)&&(this.emit("after-changes",{type:c.E.REMOVE}),this.emit("change",{added:[],removed:[e]}))}},{key:"removeMany",value:function(e){var t,r=[],i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;this._set.delete(a)&&r.push(a)}}catch(s){i.e(s)}finally{i.f()}r.length>0&&(this.emit("after-changes",{type:c.E.REMOVE}),this.emit("change",{added:[],removed:r}))}},{key:"toArray",value:function(){return(0,i.Z)(this._set)}},{key:"find",value:function(e){var t;return(0,h.at)(this._set,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._set.forEach((function(t){return e(t)}))}}]),r}(l.n)},41896:function(e,t,r){r.d(t,{F:function(){return it},L:function(){return Ve},O:function(){return Be},a:function(){return dt},n:function(){return $e},p:function(){return et},t:function(){return st},w:function(){return Ot}});var i,n,a,s,u,o,l,c,h=r(11752),d=r(61120),f=r(30168),p=r(1413),y=r(29439),v=r(74165),m=r(15861),g=r(60136),_=r(29388),F=r(37762),x=r(15671),b=r(43144),E=r(48848),k=r(93661),w=r(50690),R=r(28390),T=r(59389),S=r(93314),C=r(65094),O=r(630),Z=r(1685),I=r(5526),D=r(35237),P=r(25456),V=r(43406),M=r(17332),A=r(43955),N=r(82474),L=r(46817),U=r(71802),G=r(74384),q=(r(69641),r(40345)),H=r(47748),z=r(64998),j=r(37944),Q=r(32161),B=r(95643),W=r(96278),X=r(36479),J=r(33794),Y=r(2821),$=r(76419),K=r(51920),ee=r(17562),te=r(69838),re=r(68781),ie=r(57791),ne=r(77956),ae=r(95249),se=r(6189),ue=r(52559),oe=r(62466),le=r(26593),ce=r(59984),he=r(26151),de=r(70381),fe=r(93122),pe=r(31698),ye=r(75833),ve=r(43345),me=r(29048),ge=r(13239),_e=r(32043),Fe=r(94777),xe=r(85700),be=r(60491),Ee=r(3393),ke=function(){function e(t,r){(0,x.Z)(this,e),this._highestResolutionVersion=null,this.versions=[],this.ref(t,r)}return(0,b.Z)(e,[{key:"isReferenced",get:function(){return 0!==this.versions.length}},{key:"isSingle",get:function(){return 1===this.versions.length&&1===this.versions[0].refCount}},{key:"ref",value:function(e,t){var r=this.feature;Re.oldVersion=r,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});var i,n=(0,F.Z)(this.versions);try{for(n.s();!(i=n.n()).done;){var a=i.value;if(a.resolution===t){a.refCount++;var s=this._highestResolutionVersion===a&&!(0,q.h)(e,a.feature);return(s||this._highestResolutionVersion!==a)&&(a.feature=e),Re.newVersion=s?e:r,Re}}}catch(o){n.e(o)}finally{n.f()}var u={feature:e,resolution:t,refCount:1};return this.versions.push(u),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(Re.newVersion=e,this._highestResolutionVersion=u):Re.newVersion=r,Re}},{key:"unref",value:function(e){for(var t=0;t<this.versions.length;t++){var r=this.versions[t];if(r.resolution===e)return r.refCount--,Re.oldVersion=this.feature,0===r.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===r&&(this._recalculateHighestResolutionVersion(),Re.oldVersion=r.feature)),Re.newVersion=this.feature,Re}return null}},{key:"feature",get:function(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}},{key:"_recalculateHighestResolutionVersion",value:function(){if(0!==this.versions.length){for(var e=this.versions[0],t=1;t<this.versions.length;t++){var r=this.versions[t];r.resolution<e.resolution&&(e=r)}this._highestResolutionVersion=e}else this._highestResolutionVersion=null}}]),e}(),we=function(){function e(t){(0,x.Z)(this,e),this._feature=t,this._refCount=1}return(0,b.Z)(e,[{key:"isReferenced",get:function(){return 0!==this._refCount}},{key:"isSingle",get:function(){return 1===this._refCount}},{key:"ref",value:function(e){return++this._refCount,Re.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),(0,q.h)(this._feature,e)||(this._feature=e),Re.newVersion=this._feature,Re}},{key:"unref",value:function(){return Re.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(Re.newVersion=null,Re):(Re.newVersion=this._feature,Re)}},{key:"feature",get:function(){return this._feature}}]),e}(),Re={oldVersion:null,newVersion:null},Te=new Set,Se=function(){function e(t){(0,x.Z)(this,e),this.descriptor=t,this.fetchStatus=c.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=Ce,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Te,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}return(0,b.Z)(e,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"setFeatures",value:function(e,t,r){this._availableFields=(0,k.v)(r,Te),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+(0,V.w)(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>Ce}},{key:"needsFeatureCount",get:function(){return this._numFeatures===Ce}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"updateMemoryEstimates",value:function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=(0,V.A)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(var r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=(0,V.A)(this._features[r]);return!0}return!1}},{key:"isFetching",get:function(){return this.fetchStatus===c.FETCHING||this.fetchStatus===c.REFETCHING}},{key:"isRefetching",get:function(){return this.fetchStatus===c.REFETCHING}},{key:"needsFetching",get:function(){return this.fetchStatus===c.FETCH_NEEDED||this.fetchStatus===c.REFETCH_NEEDED}},{key:"needsRefetching",get:function(){return this.fetchStatus===c.REFETCH_NEEDED}},{key:"isFetched",get:function(){return this.fetchStatus===c.DONE||this.fetchStatus===c.FULL}},{key:"resetFetching",value:function(){this.fetchStatus=this.fetchStatus===c.REFETCHING?c.REFETCH_NEEDED:c.FETCH_NEEDED}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!function(e,t,r){if((0,k.t)(t)||(0,k.t)(e)||r!==t.length||r>e.length)return!1;for(var i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}},{key:"intersects",value:function(e){return!e||!this.descriptor.extent||((0,P.c)(e,Oe),(0,P.E)(this.descriptor.extent,Oe))}},{key:"intersectionIncludingBorrowed",value:function(e,t){var r=(0,k.r)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?(e?((0,P.c)(e,t),(0,P.U)(t,r,t)):(0,P.a)(t,r),t):((0,P.a)(t,P.J),t)}},{key:"_shuffle",value:function(e){this._features.sort((function(t,r){return(0,V.O)(t,e)-(0,V.O)(r,e)})),(0,k.a5)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}},{key:"reduceFeatures",value:function(e,t,r){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;var i=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===c.DONE&&this._features.length>0&&(this.fetchStatus=c.REFETCH_NEEDED,i=!0)),!this._shuffled&&e<1&&this._shuffle(r);var n=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>n&&(this._features.length=n,this.featuresMissing=!0,this.fetchStatus===c.FULL&&(this.fetchStatus=c.DONE)),i}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),e}(),Ce=-1;!function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"}(c||(c={}));var Oe=(0,P.u)(),Ze="esri.views.3d.layers.support.FeatureTileFetcher3D",Ie=E.a.getLogger(Ze),De=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e))._useTileCount=!1,i.updating=!1,i.updatingTotal=0,i.updatingRemaining=0,i.expectedFeatureDiff=0,i.maximumNumberOfFeaturesExceeded=!1,i.maximumNumberOfFeaturesExceededThrottle=1e3,i._fullRatio=1,i._farRatio=1,i._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},i._handles=new E.X,i._frameTask=H.y,i._dirty=!1,i._featureTiles=new Map,i._displayingFeatureReferences=new Map,i._numDisplayingFeatureReferences=0,i._suspended=!0,i._pendingEdits=null,i}return(0,b.Z)(r,[{key:"maximumNumberOfFeatures",set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}},{key:"memoryFactor",set:function(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}},{key:"lodFactor",set:function(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&(0,k.r)(this.context.query.queryFeatureCount)},set:function(e){this._useTileCount=e,this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.estimatedUnusedSize})),e}},{key:"totalVertices",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numVertices})),e}},{key:"totalFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numFeatures})),e}},{key:"filterExtent",set:function(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))Ie.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");else{var t=this._get("filterExtent");if(!(t===e||t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("filterExtent",r),this._reclip(r,t)}}}},{key:"initialize",value:function(){var e=this;this._handles.add((0,w.a)((function(){return e.tileDescriptors}),"change",(function(){return e._setDirty()}),{onListenerAdd:function(){return e._setDirty()}})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?ke:we;var t=this.context.scheduler;(0,k.r)(t)&&(this._frameTask=t.registerTask(H.I.FEATURE_TILE_FETCHER,this)),this._setDirty()}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this._handles=(0,k.g)(this._handles),this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._removeTile(t)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits&&(this._pendingEdits.controller.abort(),this._pendingEdits=null)}},{key:"_paused",get:function(){return this._suspended||!!this._pendingEdits}},{key:"restart",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._clearTile(t),e._resetFetchTile(t)})),(0,k.r)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"refetch",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._resetFetchTile(t)})),(0,k.r)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,this._unpause())}},{key:"_pause",value:function(){var e=this;this._paused&&(this._featureTiles.forEach((function(t){return e._cancelFetchTile(t)})),this._updated())}},{key:"_unpause",value:function(){this._paused||(this._setDirty(),this._updated())}},{key:"availableFields",get:function(){var e=null;return this._featureTiles.forEach((function(t){(0,k.t)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,k.t)(e)?e=new Set(t.availableFields):e.forEach((function(r){t.availableFields.has(r)||(0,k.e)(e).delete(r)})))})),(0,k.r)(e)?e:new Set}},{key:"applyEdits",value:function(e){var t=this;this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());var r=this._pendingEdits;r.count++;var i=r.edits.then((function(){return e.result.catch((function(e){if((0,E.j)(e))throw e;return null})).then((function(e){return e?(t._applyEditsDeleteFeatures(e.deletedFeatures),t._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,r.controller.signal).then((function(){return e}))):e})).then((function(e){return 0==--r.count&&(t._pendingEdits===r&&(t._pendingEdits=null),(0,k.r)(t.context.memoryCache)&&t.context.memoryCache.clear(),t._unpause(),t._updated()),e}))}));return r.edits=i,this._updated(),i}},{key:"_applyEditsDeleteFeatures",value:function(e){var t=this;if(0!==e.length){var r=this.context.globalIdField,i=r&&this.availableFields.has(r),n=new Set,a=this._objectIdField;e.forEach((function(e){var s=e.objectId,u=e.globalId;if((!s||s<0)&&r){i||Ie.errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(r," to be included the layer's outFields for updates to be reflected in the view"));var o=t.features.find((function(e){return e.attributes&&e.attributes[r]===u}));o&&n.add((0,V.O)(o,a))}else n.add(s)})),this._featureTiles.forEach((function(e){if(e.features){var r=e.features.filter((function(e){return!n.has((0,V.O)(e,t._objectIdField))}));r.length!==e.features.length&&(e.setFeatures(r,0,e.availableFields),t._invalidateCounts())}}))}}},{key:"_applyEditsAddUpdateFeatures",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r,i){var n,a,s,u=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],a=new Set,t.forEach((function(e){return n.push(e.objectId)})),r.forEach((function(e){n.push(e.objectId),a.add(e.objectId)})),0!==n.length){e.next=3;break}return e.abrupt("return");case 3:return s=[],this._featureTiles.forEach((function(e){var t=u._applyEditsAddUpdateTile(e,n,a,i);t&&s.push(t)})),e.next=7,(0,E.E)(s);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_applyEditsAddUpdateTile",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r,i,n){var a,s,u,o,l,c,h,d=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.features){e.next=2;break}return e.abrupt("return");case 2:return(a=this._createQuery(t)).resultType=void 0,a.cacheHint=!1,a.objectIds=r,e.next=6,this._queryFeatures(a,n);case 6:if(s=e.sent,u=null,i.size>0&&(o=t.features.filter((function(e){return!i.has((0,V.O)(e,d._objectIdField))}))).length!==t.features.length&&(u=o),s.features.length>0){u||(u=t.features.slice()),l=(0,F.Z)(s.features);try{for(l.s();!(c=l.n()).done;)h=c.value,u.push(h)}catch(f){l.e(f)}finally{l.f()}}u&&(t.hasPreciseFeatureCount&&(t.numFeatures=Math.max(t.numFeatures,u.length)),t.setFeatures(u,0,Le(t.availableFields,s.fields)),this._invalidateCounts());case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"_queryFeatures",value:function(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:He})}},{key:"_setDirty",value:function(){this._dirty=!0,this._updated()}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=this;if(this._frameTask.processQueue(e),this._dirty&&this.initialized){this._dirty=!1;var r=this._getListOfTiles();if(this._markTilesNotAlive(r),e.run((function(){return t._addTiles(r,e)}))&&e.run((function(){return t._filterExtentTiles(r,e)}))&&e.run((function(){return t._removeTiles(r,e)}))&&!e.done){var i=this._sortTiles(r);e.run((function(){return t._displayTiles(i,e)}))&&e.run((function(){return t._fetchTiles(i,e)}))&&e.run((function(){return t._updateMemoryEstimates(i,e)}))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}else this._setDirty()}}},{key:"_markTilesNotAlive",value:function(e){var t,r=(0,F.Z)(e);try{for(r.s();!(t=r.n()).done;){t.value.alive=!1}}catch(i){r.e(i)}finally{r.f()}}},{key:"_addTiles",value:function(e,t){var r=this;return!this._suspended&&(this.tileDescriptors.forEach((function(i){var n=r._featureTiles.get(i.id);n?n.alive=!0:t.done||(e.push(r._addTile(i)),t.madeProgress())})),t.hasProgressed)}},{key:"_filterExtentTiles",value:function(e,t){var r,i=(0,F.Z)(e);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(t.done)break;n.alive&&(n.filtered=!n.intersects(this.filterExtent),n.filtered&&(this._clearTile(n),t.madeProgress()))}}catch(a){i.e(a)}finally{i.f()}return t.hasProgressed}},{key:"_removeTiles",value:function(e,t){for(var r=e.length-1;r>=0&&!t.done;r--){var i=e[r];i.alive||(this._removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}},{key:"_sortTiles",value:function(e){return e.sort((function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority})),e}},{key:"_displayTiles",value:function(e,t){var r,i=this,n=this._updateRatio(e),a=(0,F.Z)(e);try{var s=function(){var e=r.value;if(!t.run((function(){return function(e){var t=i._fullRatio<1?n(e)*i._farRatio:1;return e.reduceFeatures(t,i.memoryFactor,i._objectIdField)&&i._setDirty(),i._showTile(e)}(e)})))return i._setDirty(),"break"};for(a.s();!(r=a.n()).done;){if("break"===s())break}}catch(u){a.e(u)}finally{a.f()}return t.hasProgressed}},{key:"_fetchTiles",value:function(e,t){var r=this;if(this._paused)return!1;var i,n=!1,a=(0,F.Z)(e);try{var s=function(){var e=i.value;if(!e.needsFetching)return"continue";var a=(0,k.r)(r.context.memoryCache)?r.context.memoryCache.pop(e.id):null;if((0,k.r)(a))e.cache=a,r._setDirty(),r._scheduleUpdated(),t.madeProgress();else{if(r._needsNumFeatures(e)){var s=new AbortController,u=r._fetchTileCount(e,s.signal);r._handleRequest(e,u,s,(function(){return e.numFeatures=-2})),n=!0,t.madeProgress()}if(t.done)return{v:!0}}};for(a.s();!(i=a.n()).done;){var u=s();if("continue"!==u&&"object"===typeof u)return u.v}}catch(d){a.e(d)}finally{a.f()}if(n)return t.hasProgressed;var o,l=(0,F.Z)(e);try{var c=function(){var e=o.value;if(e.needsFetching){var i=new AbortController,n=r._fetchTile(e,i.signal);if(r._handleRequest(e,n,i,(function(t){e.setFeatures([],0,null),r._invalidateCounts(),e.featuresMissing=!1,r.context.logFetchError(Ie,t)})),t.madeProgress(),t.done)return{v:!0}}};for(l.s();!(o=l.n()).done;){var h=c();if("object"===typeof h)return h.v}}catch(d){l.e(d)}finally{l.f()}return t.hasProgressed}},{key:"_updateMemoryEstimates",value:function(e,t){var r=this;return e.some((function(e){return!t.run((function(){return e.updateMemoryEstimates()}))&&(r._setDirty(),!0)})),t.hasProgressed}},{key:"_reclip",value:function(e,t){if(this.initialized){var r=new Array;this._featureTiles.forEach((function(i){(0,k.t)(i.displayingFeatures)||0===i.displayingFeatures.length||(i.intersectionIncludingBorrowed(t,Ge),i.intersectionIncludingBorrowed(e,qe),(0,P.I)(Ge,qe)||r.push(i))})),this._refreshDisplayingFeatures(r),this._updated()}}},{key:"_refreshDisplayingFeatures",value:function(e){var t,r=new Set,i=this._changes.updates,n=(0,F.Z)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;if(!(0,k.t)(a.displayingFeatures)){var s,u=(0,F.Z)(a.displayingFeatures);try{for(u.s();!(s=u.n()).done;){var o=s.value,l=(0,V.O)(o,this._objectIdField);if(!r.has(l)){r.add(l);var c=this._displayingFeatureReferences.get(l).feature;i.removes.push(c),i.adds.push(c)}}}catch(h){u.e(h)}finally{u.f()}}}}catch(h){n.e(h)}finally{n.f()}this._applyChanges()}},{key:"_updated",value:function(){var e=this,t=0;this._paused||this._featureTiles.forEach((function(e){return e.isFetching?++t:0}));var r=this._dirty||t>0||!!this._pendingEdits;if(this._set("updating",r),r){var i=0,n=0,a=0,s=0,u=0,o=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((function(t){if(++n,t.isFetching&&t.hasPreciseFeatureCount){var r=e._maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),l=(0,k.r)(t.displayingFeatures)?t.displayingFeatures.length*o:0;u+=r-l}t.needsFetching?++s:t.numFeatures>0&&(++a,i+=t.numFeatures)})),s+=t;var l=0,c=0;i?(c=i,l=Math.min(s*i/a,i)):(c=n,l=s),u=Math.min(this.maximumNumberOfFeatures-this.features.length,u),this._set("updatingTotal",c),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",u)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}},{key:"_updateMaximumNumberOfFeaturesExceeded",value:function(){var e=(0,E.a9)(this._featureTiles,(function(e){return e.perTileMaximumNumberOfFeaturesExceeded}));this._set("maximumNumberOfFeaturesExceeded",e)}},{key:"_updateRatio",value:function(e){var t,r=function(e){var t,r=0,i=(0,F.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;n.features&&n.features.length>0&&n.alive&&(r=Math.max(r,n.descriptor.lij[0]))}}catch(a){i.e(a)}finally{i.f()}return r}(e),i=function(e){return 1/(1<<Math.max(0,r-e.descriptor.lij[0]))},n=0,a=0,s=(0,F.Z)(e);try{for(s.s();!(t=s.n()).done;){var u=t.value,o=u.numFeatures;n+=o,a+=o*i(u)}}catch(l){s.e(l)}finally{s.f()}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/n),this._farRatio=this.maximumNumberOfFeatures/a,this._scheduleUpdated(),i}},{key:"_maximumFeaturesUpdated",value:function(e,t){var r=this;e!==t&&(t>e&&this._featureTiles.forEach((function(e){if(e.featuresMissing){var t=r._maximumFeaturesForTile(e);e.features&&(e.features.length>=t||e.fetchStatus===c.FULL)||(r._cancelFetchTile(e),r._resetFetchTile(e))}})),this._setDirty())}},{key:"_addTile",value:function(e){var t=new Se(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}},{key:"_referenceDisplayingFeaturesFromRelatedTiles",value:function(e){var t=this,r=e.descriptor.resolution;this._featureTiles.forEach((function(i){if(!((0,k.t)(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!(0,R.S)(e.descriptor.lij,i.descriptor.lij))){(0,k.t)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&((0,k.t)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,P.e)(e.descriptor.extent)),(0,P.h)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));var n,a=(0,F.Z)(i.displayingFeatures);try{for(a.s();!(n=a.n()).done;){var s=n.value;e.displayingFeatures.push(s);var u=t._displayingFeatureReferences.get((0,V.O)(s,t._objectIdField));u.ref(u.feature,r),t._numDisplayingFeatureReferences++}}catch(o){a.e(o)}finally{a.f()}}})),e.featureLimit=(0,k.r)(e.displayingFeatures)?e.displayingFeatures.length:0}},{key:"_removeTile",value:function(e){this._clearTile(e),this._featureTiles.delete(e.id)}},{key:"_resetFetchTile",value:function(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=c.DONE):e.fetchStatus=c.FETCH_NEEDED}},{key:"_cancelFetchTile",value:function(e){var t=e.requestController;(0,k.r)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}},{key:"_fetchTileCount",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchCount(t,r);case 2:return t.numFeatures=e.sent,this._updateRatio(this._getListOfTiles()),e.abrupt("return",t.fetchStatus===c.REFETCHING?c.REFETCH_NEEDED:c.FETCH_NEEDED);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchTile",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a,s,u,o,l,h,d,f,p=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=this._maximumFeaturesForTile(t))<=0)){e.next=3;break}return e.abrupt("return",Ae(t));case 3:if(n=this._getMaxRecordCount(t),a=Math.ceil(i/n),!(Pe(t)||!this.context.capabilities.supportsMaxRecordCountFactor||t.numFeatures<=i&&a>D.x.MAX_MAX_RECORD_COUNT_FACTOR)){e.next=6;break}return e.abrupt("return",this._fetchPagedTile(t,r));case 6:return(s=this._createQuery(t)).maxRecordCountFactor=Math.ceil(i/n),t.isRefetching&&t.features&&t.features.length>0&&(u=Math.ceil(t.features.length/(1-t.emptyFeatureRatio)/n),s.maxRecordCountFactor=Math.max(u+1,s.maxRecordCountFactor)),e.next=10,this._queryFeatures(s,r);case 10:return o=e.sent,l=o.features,h=o.exceededTransferLimit,d=o.fields,f=h?s.maxRecordCountFactor>=D.x.MAX_MAX_RECORD_COUNT_FACTOR?c.FULL:c.DONE:c.FULL,e.next=17,this._frameTask.schedule((function(){t.featuresMissing=l.length<t.numFeatures||h;var e=p._removeEmptyFeatures(l);t.setFeatures(l,e,Ne(d))}),r);case 17:return(0,E.f)(r),this._invalidateCounts(),e.abrupt("return",f);case 20:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchCount",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.context.query.queryFeatureCount(this._createFeatureCountQuery(t),{signal:r}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchPagedTile",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a,s,u,o,l,h,d,f=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0,a=0,s=0,u=this._maximumFeaturesForTile(t)-s,o=this._getMaxRecordCount(t),l=null,h=(0,v.Z)().mark((function e(){var h,d,p,y,m,g;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=f._createQuery(t),d=f._setPagingParameters(h,n,u,o),e.next=4,f._queryFeatures(h,r);case 4:return p=e.sent,y=p.features,m=p.exceededTransferLimit,g=p.fields,e.next=10,f._frameTask.schedule((function(){d&&(n+=(0,k.e)(h.num)),s+=y.length,a+=f._removeEmptyFeatures(y),t.featuresMissing=n<t.numFeatures||m,i=i?i.concat(y):y,l=Le(l,g),t.setFeatures(i,a,l)}),r);case 10:if((0,E.f)(r),f._invalidateCounts(),f._setDirty(),u=f._maximumFeaturesForTile(t)-s,d&&m&&!(u<=0)){e.next=16;break}return e.abrupt("return",{v:m?c.DONE:c.FULL});case 16:case"end":return e.stop()}}),e)}));case 4:return e.delegateYield(h(),"t0",5);case 5:if("object"!==typeof(d=e.t0)){e.next=8;break}return e.abrupt("return",d.v);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createFeatureCountQuery",value:function(e){var t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}},{key:"_createQuery",value:function(e){var t=this.context.createQuery(),r=e.descriptor.extent;if(r){var i=this.context.tilingScheme.spatialReference;t.geometry=(0,P.f)(r,i)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"_setPagingParameters",value:function(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}},{key:"_getEffectiveTileResolution",value:function(e){if(null==e.descriptor.resolution)return null;var t=this.context.viewingMode===M.l.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}},{key:"_supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"_setResolutionParams",value:function(e,t){if(this._supportsResolution){var r=this._getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new D.a({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}}},{key:"_removeEmptyFeatures",value:function(e){for(var t=e.length,r=0;r<e.length;){var i=e[r];(0,V.S)(i.geometry)?++r:(e[r]=e[e.length-1],--e.length)}return t-e.length}},{key:"_needsNumFeatures",value:function(e){return this.useTileCount&&e.needsFeatureCount&&!Pe(e)}},{key:"_getMaxRecordCount",value:function(e){var t=this.context,r=t.tileMaxRecordCount,i=t.maxRecordCount;return this._useTileQuery(e)&&(0,k.r)(r)&&r>0&&this.context.capabilities.supportsResultType?r:(0,k.r)(i)&&i>0?i:Ue}},{key:"_useTileQuery",value:function(e){return(!Pe(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}},{key:"_handleRequest",value:function(e,t,r,i){var n=this;e.fetchStatus=e.needsRefetching?c.REFETCHING:c.FETCHING,e.requestController=r;var a=!1;t.then((function(t){e.requestController=null,e.fetchStatus=t})).catch((function(t){e.requestController===r&&(e.requestController=null,e.fetchStatus=c.DONE),(0,E.j)(t)?a=!0:i(t)})).then((function(){a||n._setDirty(),n._scheduleUpdated()}))}},{key:"_scheduleUpdated",value:function(){var e=this;this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add((0,E.k)((function(){e._handles.remove("scheduleUpdated"),e._updated()})),"scheduleUpdated")}},{key:"_showTile",value:function(e){if((0,k.r)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;var t=e.features;if(0===e.featureLimit||!t){var r=(0,k.r)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],r}var i=e.descriptor.resolution,n=this._changes.updates,a=this._changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(var u=0;u<s;++u){var o=t[u],l=(0,V.O)(o,this._objectIdField),c=this._displayingFeatureReferences.get(l);if(c){var h=c.ref(o,i);h.oldVersion!==h.newVersion&&(n.removes.push(h.oldVersion),n.adds.push(h.newVersion))}else this._displayingFeatureReferences.set(l,new this.FeatureReferenceClass(o,i)),a.push(o);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,s),!0}},{key:"_hideTile",value:function(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}},{key:"_hideTileFeatures",value:function(e){if(!(0,k.t)(e.displayingFeatures)){var t,r=this._changes.updates,i=this._changes.removes,n=(0,F.Z)(e.displayingFeatures);try{for(n.s();!(t=n.n()).done;){var a=t.value,s=(0,V.O)(a,this._objectIdField),u=this._displayingFeatureReferences.get(s);if(u){var o=u.unref(e.descriptor.resolution);this._numDisplayingFeatureReferences--,o?o.oldVersion!==o.newVersion&&(null==o.newVersion?(this._displayingFeatureReferences.delete(s),i.push(o.oldVersion)):(r.adds.push(o.newVersion),r.removes.push(o.oldVersion))):console.error("Hiding unreferenced feature")}}}catch(l){n.e(l)}finally{n.f()}this._applyChanges(),e.displayingFeatures=null}}},{key:"_applyChanges",value:function(){var e=this._changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this._changes.adds,r=this._changes.removes,i=Math.min(t.length,r.length),n=0;n<i;){var a=Math.min(n+ze,i);this.features.addMany(t.slice(n,a)),this.features.removeMany(r.slice(n,a)),n=a}t.length>i&&this.features.addMany(0===n?t:t.slice(n)),r.length>i&&this.features.removeMany(0===n?r:r.slice(n)),t.length=0,r.length=0}},{key:"_clearTile",value:function(e){if(this._hideTile(e),e.features&&(0,k.r)(this.context.memoryCache)){var t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this._invalidateCounts()}},{key:"_invalidateCounts",value:function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}},{key:"_getListOfTiles",value:function(){return Array.from(this._featureTiles.values())}},{key:"storedFeatures",get:function(){return this._getListOfTiles().reduce((function(e,t){return e+(t.features?t.features.length:0)}),0)}},{key:"_maximumFeaturesForTile",value:function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:1/0,r=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(r*i/(1-e.emptyFeatureRatio)),t)}},{key:"test",get:function(){var e=this;return{process:function(t){return e.runTask(t)},getFeatureTileById:function(t){return e._featureTiles.get(t)},forEachFeatureTile:function(t){return e._featureTiles.forEach(t)}}}}]),r}(E.m);function Pe(e){return"dummy-tile-full-extent"===e.id}function Ve(e){var t=e.capabilities.query;return{supportsMultipleResolutions:Me(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function Me(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function Ae(e){return e.setFeatures([],0,null),e.featuresMissing=!1,c.DONE}function Ne(e){return(0,k.t)(e)?new Set:new Set(e.map((function(e){return e.name})))}function Le(e,t){if((0,k.t)(e)||(0,k.t)(t))return Ne(t);var r,i=new Set,n=(0,F.Z)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value.name;e.has(a)&&i.add(a)}}catch(s){n.e(s)}finally{n.f()}return i}(0,E.e)([(0,E.y)({constructOnly:!0})],De.prototype,"features",void 0),(0,E.e)([(0,E.y)()],De.prototype,"tileDescriptors",void 0),(0,E.e)([(0,E.y)({value:1/0})],De.prototype,"maximumNumberOfFeatures",null),(0,E.e)([(0,E.y)({value:1})],De.prototype,"memoryFactor",null),(0,E.e)([(0,E.y)({value:1})],De.prototype,"lodFactor",null),(0,E.e)([(0,E.y)()],De.prototype,"useTileCount",null),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"updating",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"updatingTotal",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"updatingRemaining",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"expectedFeatureDiff",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"memoryForUnusedFeatures",null),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],De.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"totalVertices",null),(0,E.e)([(0,E.y)({readOnly:!0})],De.prototype,"totalFeatures",null),(0,E.e)([(0,E.y)()],De.prototype,"filterExtent",null),(0,E.e)([(0,E.y)({constructOnly:!0})],De.prototype,"context",void 0),De=(0,E.e)([(0,E.n)(Ze)],De);var Ue=2e3,Ge=(0,P.u)(),qe=(0,P.u)(),He=6e5,ze=200,je=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],Qe=function(){function e(t,r,i){(0,x.Z)(this,e),this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._enabled=!0,this._tileFetcher=t,this._view=i,this._tilingScheme=new R.U(r),this._loadedSymbols=je.map((function(e){return new j.S(new j.G({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}}))})),this._loadingSymbols=[new j.S(new j.G({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this._pendingSymbols=[new j.S(new j.G({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this._dataExtentSymbol=new j.S(new j.G({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}return(0,b.Z)(e,[{key:"destroy",value:function(){this.enabled=!1}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()}},{key:"update",value:function(){var e=this;this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:function(e){return e.isFetching},symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:function(e){return!e.isFetching},symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:function(e){return!e.isFetching},symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}},{key:"showDataExtent",value:function(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),e){var t=G.v.fromExtent(e);this._dataExtentGraphic=new z.g({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}}},{key:"_synchronizeMaps",value:function(e,t){var r=this,i=[];e.forEach((function(e,n){var a=r._tileFetcher.test.getFeatureTileById(n);a&&t.filter(a)||(r._view.graphics.removeMany(e),i.push(n))})),i.forEach((function(t){return e.delete(t)})),this._tileFetcher.test.forEachFeatureTile((function(i){if(t.filter(i)&&!e.has(i.id)){var n=(0,y.Z)(i.descriptor.lij,3),a=n[0],s=n[1],u=n[2];r._tilingScheme.ensureMaxLod(a);var o=r._tilingScheme.getExtentGeometry(a,s,u),l=[new z.g({geometry:o,symbol:t.symbols[a%t.symbols.length]}),new z.g({geometry:o.center,symbol:new j.d({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new j.A({text:"".concat(a,"/").concat(s,"/").concat(u),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(i.id,l),r._view.graphics.addMany(l)}}))}}]),e}(),Be=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e)).type="feature-tile-3d",i._watchUpdatingTracking=new O.c,i.serviceDataExtent=null,i.serviceDataCount=We.NO_SERVICE_DATA_COUNT,i.vertexLimitExceeded=!1,i.displayFeatureLimit=null,i._suspended=!1,i._tileFetcher=null,i._handles=new E.X,i._fetchDataInfoPromise=null,i._fetchDataInfoAbortController=null,i._lifeCycleAbortController=new AbortController,i}return(0,b.Z)(r,[{key:"extent",set:function(e){if(!e||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}}else E.a.getLogger(this.declaredClass).error("#extent=","extent needs to be in the same spatial reference as the view")}},{key:"updating",get:function(){return!!((0,k.r)(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&(0,k.r)(this._tileFetcher)?this._tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&(0,k.r)(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&(0,k.r)(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return(0,k.r)(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!(0,k.r)(this._tileFetcher)||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return(0,k.r)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var e,t,r=this.layerView.layer;if("feature"===r.type&&(0,k.r)(r.infoFor3D))return"snapshot";if(!1===(null===(e=this.layerView.view.qualitySettings)||void 0===e||null===(t=e.graphics3D)||void 0===t?void 0:t.snapshotAvailable)||this.serviceDataCount===We.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var i=this.layerView.view,n=i&&i.featureTiles,a=n&&n.tilingScheme;if(r&&r.minScale&&this.serviceDataExtent&&a){var s=this._approximateExtentSizeAtScale(r.minScale,a);if((this.serviceDataExtent.width/s+this.serviceDataExtent.height/s)/2>We.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&(0,k.r)(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"_approximateExtentSizeAtScale",value:function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),n=t.levels[0];return i*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new S.j([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new S.j}},{key:"test",get:function(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}},{key:"initialize",value:function(){var e=this;this._watchUpdatingTracking.add((function(){return e.vertexLimitInfo}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))})),this._watchUpdatingTracking.add((function(){return e.mode}),(function(){return e._modeChanged()}),w.h),this.addResolvingPromise(Promise.resolve().then((function(){return e._verifyCapabilities()})).then((function(){return e._watchUpdatingTracking.addPromise(e._fetchServiceDataInfo())})).then((function(){return e._initializeTileFetcher()})))}},{key:"_verifyCapabilities",value:function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==e.type)throw new E.s("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}},{key:"destroy",value:function(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,k.g)(this._tileFetcher),this._handles=(0,k.g)(this._handles),this._tilesHandle=(0,k.f)(this._tilesHandle),this._lifeCycleAbortController&&(this._lifeCycleAbortController.abort(),this._lifeCycleAbortController=null),this._watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,(0,k.r)(this._tileFetcher)&&this._tileFetcher.suspend())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,(0,k.r)(this._tileFetcher)&&this._tileFetcher.resume())}},{key:"restart",value:function(){var e=this,t=function(){(0,k.r)(e._tileFetcher)&&e._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"refetch",value:function(){var e=this,t=function(){(0,k.r)(e._tileFetcher)&&e._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"_initializeTileFetcher",value:function(){var e=this,t=this.layerView.view;if(t){var r=(0,w.j)((function(){var e;return null===(e=t.featureTiles)||void 0===e?void 0:e.tilingScheme}),this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(r),r.then((function(){var r=e.layerView,i=e.tileDescriptors,n=r.layer,a=new De({context:e.context,filterExtent:e.extent,tileDescriptors:i,features:e.graphics});e._tileFetcher=a,e._suspended?e._tileFetcher.suspend():e._tileFetcher.resume();var s=e.layerView.view.resourceController;s&&e._handles.add((0,w.l)((function(){return s.memoryController.memoryFactor}),(function(e){return a.memoryFactor=e}),w.w));var u="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;u&&e._handles.add((0,w.l)((function(){var t,r,i;return null===(t=e.layerView.view)||void 0===t||null===(r=t.qualitySettings)||void 0===r||null===(i=r.graphics3D)||void 0===i?void 0:i[u]}),(function(e){return a.lodFactor=e||1}),w.h));"ogc-feature"!==n.type&&e._watchUpdatingTracking.add((function(){return n.createQueryVersion}),(function(){return e._dataFilterChanged()})),e._watchUpdatingTracking.add((function(){return r.availableFields}),(function(t,r){return e._availableFieldsChanged(r,t)})),e._watchUpdatingTracking.add((function(){return r.requiredFields}),(function(t,r){return e._requiredFieldsChanged(r,t)})),e._handles.add([n.on("apply-edits",(function(t){return e._applyEdits(t)})),(0,w.l)((function(){return e.extent}),(function(e){return a.filterExtent=e}),w.U),(0,w.l)((function(){return e.tileDescriptors}),(function(e){return a.tileDescriptors=e}),w.U),(0,w.l)((function(){return e.maximumNumberOfFeatures}),(function(t){a.maximumNumberOfFeatures=t,a.useTileCount=e.serviceDataCount>t}),w.w),(0,w.l)((function(){return e.serviceDataCount}),(function(t){return a.useTileCount=t>e.maximumNumberOfFeatures}),w.w),(0,w.l)((function(){return Q.t.FEATURE_TILE_FETCH_SHOW_TILES}),(function(r){r&&a&&!a.debugger?(a.debugger=new Qe(a,t.featureTiles.tilingScheme.toTileInfo(),t),a.debugger.update()):!r&&e._tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)}),w.w)]),e._supportsExceedsLimitQuery||e._watchUpdatingTracking.add((function(){return e.maxTotalSnapshotVertices}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))}))})).catch((function(){}))}}},{key:"_modeChanged",value:function(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:E.a.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,k.r)(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}}},{key:"_dataFilterChanged",value:function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}},{key:"_applyEdits",value:function(e){var t=this;(0,k.t)(this._tileFetcher)||this._tileFetcher.applyEdits(e).then((function(e){e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t._watchUpdatingTracking.addPromise(t._updateServiceDataExtent(t._lifeCycleAbortController.signal))})).catch((function(e){if(!(0,E.j)(e))throw e}))}},{key:"_availableFieldsChanged",value:function(e,t){(0,k.r)(this._tileFetcher)&&Ye(this._tileFetcher.availableFields,t)&&this.refetch()}},{key:"_requiredFieldsChanged",value:function(e,t){(0,k.r)(this._tileFetcher)&&Ye(this._tileFetcher.availableFields,t)&&this.restart()}},{key:"_createVertexLimitExceededQuery",value:function(e){var t=this.layerView.layer,r=t.createQuery();return r.outStatistics=[new D.m({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(r.cacheHint=!0),r}},{key:"_createDataInfoQuery",value:function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"_fullExtentIsAccurate",value:function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":case"oriented-imagery":return(0,Z.g)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}},{key:"_updateServiceDataExtent",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._tryUpdateServiceDataExtent(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),(0,E.j)(e.t0)||this._set("serviceDataExtent",(0,k.y)(this.layerView.fullExtentInLocalViewSpatialReference));case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_tryUpdateServiceDataExtent",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var r,i,n,a,s,u,o,l,c,h,d;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.layerView,i=r.layer,n=i.capabilities.query.supportsExtent,a=(0,k.y)(r.fullExtentInLocalViewSpatialReference),s=i.fullExtent,u=this._fullExtentIsAccurate(),o=this.serviceDataCount,!(n&&o<=We.MAX_FEATURE_COUNT_FOR_EXTENT)||a&&u||!("queryExtent"in i)){e.next=9;break}return l=this._createDataInfoQuery(),e.next=5,i.queryExtent(l,{timeout:We.QUERY_EXTENT_TIMEOUT,signal:t});case 5:c=e.sent,this._set("serviceDataExtent",c.extent),e.next=22;break;case 9:if(!a){e.next=13;break}this._set("serviceDataExtent",a),e.next=22;break;case 13:if(!(0,k.r)(s)){e.next=21;break}return h="portalItem"in i?i.portalItem:null,e.next=17,(0,I.projectGeometry)(s,r.view.spatialReference,h,t);case 17:d=e.sent,this._set("serviceDataExtent",d),e.next=22;break;case 21:this._set("serviceDataExtent",null);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateServiceDataCount",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var r,i;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("queryFeatureCount"in(r=this.layerView.layer)){e.next=3;break}return e.abrupt("return",void this._set("serviceDataCount",We.NO_SERVICE_DATA_COUNT));case 3:return e.next=5,(0,T.b)(r.queryFeatureCount(this._createDataInfoQuery(),{timeout:We.QUERY_STATISTICS_TIMEOUT,signal:t}));case 5:if(!0!==(i=e.sent).ok){e.next=10;break}this._set("serviceDataCount",i.value),e.next=13;break;case 10:if(!(0,E.j)(i.error)){e.next=12;break}throw i.error;case 12:this._set("serviceDataCount",We.NO_SERVICE_DATA_COUNT);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"vertexLimitInfo",get:function(){if((0,k.t)(this.displayFeatureLimit)||(0,k.t)(this.displayFeatureLimit.averageSymbolComplexity))return null;var e=this.displayFeatureLimit,t=e.averageSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,n=t.primitivesPerFeature,a=this._get("vertexLimitInfo");return(0,k.t)(a)||a.maximumTotalNumberOfPrimitives!==r||a.primitivesPerCoordinate!==i||a.primitivesPerFeature!==n?{primitivesPerCoordinate:i,primitivesPerFeature:n,maximumTotalNumberOfPrimitives:r}:a}},{key:"_supportsExceedsLimitQuery",get:function(){var e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"_minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"_updateVertexLimitExceeded",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a,s,u,o,l,c,h,d,f;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.vertexLimitInfo,!(0,k.t)(i)){e.next=3;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 3:if(n=i.primitivesPerFeature<=0,a=this._minimumNumberOfVerticesForGeometry>1,n||a){e.next=6;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 6:if(s=i.primitivesPerFeature,u=i.primitivesPerCoordinate,o=i.maximumTotalNumberOfPrimitives,e.t0=0!==s&&(0,k.r)(t),!e.t0){e.next=11;break}return e.next=11,t;case 11:if(c=this.serviceDataCount,h=c!==We.NO_SERVICE_DATA_COUNT,l=h?Math.ceil((o-c*s)/(u||1)):Math.ceil(o/(u||1)),a&&(l=Math.min(l,Je)),!(h&&this._minimumNumberOfVerticesForGeometry*c>l)){e.next=14;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!0));case 14:if(this._supportsExceedsLimitQuery){e.next=16;break}return e.abrupt("return",void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>l));case 16:return e.next=18,(0,T.b)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(l),{timeout:We.QUERY_STATISTICS_TIMEOUT,signal:r}));case 18:if(!1!==(d=e.sent).ok){e.next=23;break}if(!(0,E.j)(d.error)){e.next=22;break}throw d.error;case 22:return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 23:(f=d.value.features[0])&&f.attributes?this._set("vertexLimitExceeded",!!f.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchServiceDataInfo",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t,r,i,n,a,s=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._cancelFetchServiceDataInfo(),t=new AbortController,r=t.signal,i=this._updateServiceDataCount(r),n=(0,E.E)([i,this._updateVertexLimitExceeded(i,r)]),a=n.then((function(){return s._updateServiceDataExtent(r)})).catch((function(e){(0,E.j)(e)||E.a.getLogger(s.declaredClass).error("#fetchServiceDataInfo()",e)})).then((function(){a===s._fetchDataInfoPromise&&(s._fetchDataInfoPromise=null,s._fetchDataInfoAbortController=null),t=null})),e.abrupt("return",(t&&(this._fetchDataInfoPromise=a),this._fetchDataInfoAbortController=t,n.then((function(){}),(function(){}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_cancelFetchServiceDataInfo",value:function(){var e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}},{key:"debug",get:function(){return{storedFeatures:(0,k.r)(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:(0,k.r)(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:(0,k.r)(this._tileFetcher)?this._tileFetcher.totalVertices:0}}}]),r}((0,C.m)(E.m));(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"type",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],Be.prototype,"graphics",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],Be.prototype,"layerView",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],Be.prototype,"context",void 0),(0,E.e)([(0,E.y)()],Be.prototype,"extent",null),(0,E.e)([(0,E.y)()],Be.prototype,"updating",null),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"_watchUpdatingTracking",void 0),(0,E.e)([(0,E.y)()],Be.prototype,"updatingTotal",null),(0,E.e)([(0,E.y)()],Be.prototype,"updatingRemaining",null),(0,E.e)([(0,E.y)()],Be.prototype,"expectedFeatureDiff",null),(0,E.e)([(0,E.y)()],Be.prototype,"memoryForUnusedFeatures",null),(0,E.e)([(0,E.y)()],Be.prototype,"maximumNumberOfFeaturesExceeded",null),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"serviceDataExtent",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"serviceDataCount",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"vertexLimitExceeded",void 0),(0,E.e)([(0,E.y)()],Be.prototype,"displayFeatureLimit",void 0),(0,E.e)([(0,E.y)({type:Number})],Be.prototype,"maximumNumberOfFeatures",null),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"mode",null),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"maxTotalSnapshotVertices",null),(0,E.e)([(0,E.y)({readOnly:!0,dependsOn:["mode"]})],Be.prototype,"tileDescriptors",null),(0,E.e)([(0,E.y)()],Be.prototype,"_tileFetcher",void 0),(0,E.e)([(0,E.y)()],Be.prototype,"_fetchDataInfoPromise",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],Be.prototype,"vertexLimitInfo",null),Be=(0,E.e)([(0,E.n)("esri.layers.graphics.controllers.FeatureTileController3D")],Be);var We,Xe,Je=5e6;function Ye(e,t){if(!t)return!1;var r,i=(0,F.Z)(t);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(!e.has(n))return!0}}catch(a){i.e(a)}finally{i.f()}return!1}function $e(e,t,r){if(!r||null==t)return null;if(!e)return function(e,t){var r=t.toLowerCase();for(var i in e)if(i.toLowerCase()===r)return e[i];return null}(t,r);var i=e.get(r);return i?t[i.name]:null}(Xe=We||(We={})).NO_SERVICE_DATA_COUNT=1/0,Xe.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,Xe.reset=function(){Xe.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,Xe.QUERY_STATISTICS_TIMEOUT=12e3,Xe.QUERY_EXTENT_TIMEOUT=1e4},We.reset();var Ke=te.Y,et=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e))._dataQueryEngineInstance=null,i}return(0,b.Z)(r,[{key:"layer",get:function(){return this.context.layer}},{key:"spatialReference",get:function(){return this.context.spatialReference}},{key:"_queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new D.x({outSpatialReference:this.spatialReference}).toJSON()}},{key:"_dataQueryEngine",get:function(){return this._ensureDataQueryEngine()}},{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}},{key:"executeQueryForIdSet",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r,i){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t,r),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),r);case 2:return i=e.sent,n=i.count,a=i.extent,e.abrupt("return",{count:n,extent:L.w.fromJSON(a)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),r);case 2:return i=e.sent,n=re.default.fromJSON(i),e.abrupt("return",(n.features.forEach((function(e){e.layer=a.layer,e.sourceLayer=a.layer})),n));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i,n,a=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQuery(this._ensureQueryJSON(t),r);case 2:return i=e.sent,n=re.default.fromJSON(i),e.abrupt("return",(n.features.forEach((function(e){e.layer=a.layer,e.sourceLayer=a.layer})),n));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e,t){var r=this.defaultQueryJSON;if((0,k.r)(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON()),(0,k.r)(t)){var i=t.geometries.map((function(e){return e.toJSON()})).reduce((function(e,t){return e.rings=e.rings.concat(t.rings),e}));r=(0,p.Z)((0,p.Z)({},r),{},{sceneFilter:(0,p.Z)((0,p.Z)({},t),{},{geometry:i})})}return r}},{key:"_ensureDataQueryEngine",value:function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,r=G.a.toJSON(this._queryGeometryType),i=this.layer.fields.map((function(e){return e.toJSON()})),n=this.priority,a=this.spatialReference.toJSON(),s=this.context,u=s.hasZ,o=s.hasM,l=s.featureStore,c=s.scheduler;return this._dataQueryEngineInstance=new Ke({hasZ:u,hasM:o,geometryType:r,fields:i,timeInfo:e,spatialReference:a,objectIdField:t,featureStore:l,scheduler:c,priority:n}),this._dataQueryEngineInstance}}]),r}(E.m);(0,E.e)([(0,E.y)({constructOnly:!0})],et.prototype,"context",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],et.prototype,"priority",void 0),(0,E.e)([(0,E.y)()],et.prototype,"layer",null),(0,E.e)([(0,E.y)()],et.prototype,"spatialReference",null),(0,E.e)([(0,E.y)()],et.prototype,"_queryGeometryType",null),(0,E.e)([(0,E.y)()],et.prototype,"defaultQueryJSON",null),et=(0,E.e)([(0,E.n)("esri.views.3d.layers.graphics.QueryEngine")],et);var tt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e))._updateTask=null,i._frameTask=null,i._queryEngine=null,i._updateRequested=!0,i._updateVisibility=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((0,k.t)(i._compositedFeatureFilter)&&(0,k.t)(i._sceneFilter)||0===i.context.getFeatureCount())){e.next=2;break}return e.abrupt("return",i._frameTask.schedule((function(){return i.clear()}),t));case 2:return e.prev=2,e.next=5,i._queryEngine.executeQueryForIdSet(i._compositedFeatureFilter,i._sceneFilter,t);case 5:return r=e.sent,e.abrupt("return",i._frameTask.schedule((function(){i.context.updateFeatureVisibilities((function(e){return r.has(e)}))}),t));case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return",((0,E.w)(e.t0),E.a.getLogger(i.declaredClass).warn("FeatureFilter query failed: ".concat(e.t0),{error:e.t0}),i._frameTask.schedule((function(){i.context.setAllFeaturesVisibility(!0)}),t)));case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t){return e.apply(this,arguments)}}(),i}return(0,b.Z)(r,[{key:"initialize",value:function(){var e=this,t=H.I.FILTER_VISIBILITY,r=this._layerView,i=r.layer,n=r.view,a=this.context.featureStore,s="hasZ"in this._layerView&&this._layerView.hasZ,u="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new et({context:{spatialReference:n.spatialReference,layer:i,scheduler:n.resourceController.scheduler,featureStore:a,hasM:u,hasZ:s},priority:t}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(t,this),this.updatingHandles.add((function(){return[e._compositedFeatureFilter,e._sceneFilter]}),(function(){return e.reapply()}),w.h)}},{key:"destroy",value:function(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=(0,k.l)(this._updateTask),this._frameTask=(0,k.f)(this._frameTask),this._queryEngine=(0,k.g)(this._queryEngine),this._set("context",null)}},{key:"updating",get:function(){return this.running||this.updatingHandles.updating||(0,k.r)(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return(0,k.t)(this._compositedFeatureFilter)&&(0,k.t)(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return(0,ee.o)(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){var e=this._featureFilter,t=this._timeExtent,r=this._floorFilter;if((0,k.t)(t)&&(0,k.t)(r))return e;var i=(0,k.r)(e)?e.clone():new K.y;if((0,k.r)(t)&&(i.timeExtent=(0,k.r)(i.timeExtent)?i.timeExtent.intersection(t):t),(0,k.r)(r)){var n=(0,k.t)(i.where)||""===i.where;i.where=n?r:"(".concat(i.where,") AND (").concat(r,")")}return i}},{key:"_layerView",get:function(){return this.context.layerView}},{key:"reapply",value:function(){this._updateRequested=!0}},{key:"clear",value:function(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}},{key:"runTask",value:function(e){this._updateRequested&&(this._updateTask=(0,k.l)(this._updateTask),this._updateTask=(0,T.j)(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)}}]),r}(O.d);(0,E.e)([(0,E.y)({constructOnly:!0})],tt.prototype,"context",void 0),(0,E.e)([(0,E.y)()],tt.prototype,"updating",null),(0,E.e)([(0,E.y)()],tt.prototype,"running",null),(0,E.e)([(0,E.y)()],tt.prototype,"defaultVisibility",null),(0,E.e)([(0,E.y)()],tt.prototype,"_featureFilter",null),(0,E.e)([(0,E.y)()],tt.prototype,"_sceneFilter",null),(0,E.e)([(0,E.y)()],tt.prototype,"_floorFilter",null),(0,E.e)([(0,E.y)()],tt.prototype,"_timeExtent",null),(0,E.e)([(0,E.y)()],tt.prototype,"_compositedFeatureFilter",null),(0,E.e)([(0,E.y)()],tt.prototype,"_layerView",null),(0,E.e)([(0,E.y)()],tt.prototype,"_updateTask",void 0),(0,E.e)([(0,E.y)()],tt.prototype,"_updateRequested",void 0),tt=(0,E.e)([(0,E.n)("esri.views.3d.layers.support.FeatureVisibilityFilter")],tt);var rt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e)).type="graphics-3d",i._randomRotationRenderers=null,i.elevationFeatureExpressionEnabled=!1,i.scaleVisibilityEnabled=!1,i.filterVisibilityEnabled=!1,i.frustumVisibilityEnabled=!1,i.elevationAlignmentEnabled=!1,i.timeExtentEnabled=!1,i.setUidToIdOnAdd=!0,i.dataExtent=null,i.drapeSourceType=R.e.Features,i.preferredUpdatePolicy=ie.i.ASYNC,i._suspendResumeExtent=null,i}return(0,b.Z)(r,[{key:"initialize",value:function(){var e=this,t=this.owner,r=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==t.layer.geometryType,i=new $.F({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.hasZ,hasM:t.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:function(e){return t.view.deconflictor.addGraphicsOwner(e)},labeler:function(e,r){return t.view.labeler.addGraphicsOwner(e,r)},elevationAlignment:this.elevationAlignmentEnabled?function(r,i){return new $.l({graphicsCoreOwner:e,graphicsCore:r,queryGraphicUIDsInExtent:i,elevationProvider:t.view.elevationProvider})}:null,scaleVisibility:this.scaleVisibilityEnabled?function(r,i){return new $.S({graphicsCoreOwner:e,layer:e.layer,queryGraphicUIDsInExtent:i,graphicsCore:r,basemapTerrain:t.view.basemapTerrain})}:null,filterVisibility:r?function(e){return new tt({context:(0,p.Z)({layerView:t},e)})}:null,objectStates:function(e){return new $.s(e)}}});this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new $._({graphicsCoreOwner:this})),this.elevationAlignment&&this.updatingHandles.add((function(){return e.layer.elevationInfo}),(function(t,r){(0,J.m)(t,r)&&e.updatingHandles.addPromise(e.graphicsCore.elevationInfoChange())})),this.updatingHandles.add((function(){return e.layer.labelsVisible}),(function(){return e.graphicsCore.updateVisibilityInfo()})),this.updatingHandles.add((function(){return e.layer.labelingInfo}),(function(t,r){(0,J.m)(t,r)&&e.graphicsCore.updateLabelingInfo()})),this.updatingHandles.add((function(){return e.preferredUpdatePolicy}),(function(t){return e.graphicsCore.preferredUpdatePolicy=t})),this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}},{key:"_initializeAsync",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t,r=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,E.aD)(this.graphicsCore.initializePromise);case 2:if(t=this.owner,this.updatingHandles.add((function(){return r.renderer}),(function(e){return r.updatingHandles.addPromise(r.graphicsCore.rendererChange(e))})),this.updatingHandles.add((function(){return t.fullOpacity}),(function(){return r.graphicsCore.opacityChange()})),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((function(){return t.view.clippingArea}),(function(){return r._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),e.t0=this.graphicsCore.labelsEnabled,!e.t0){e.next=12;break}return e.next=12,(0,E.aD)(this.graphicsCore.updateLabelingInfo());case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,k.g)(this.frustumVisibility)),this._set("graphicsCore",(0,k.g)(this.graphicsCore)),this._set("owner",null)}},{key:"layer",get:function(){return this.owner.layer}},{key:"renderer",get:function(){var e=this.layer,t=e.renderer,r=e.objectIdField;if(!t||!r||"heatmap"===t.type||!t.visualVariables)return t;var i=t.visualVariables.findIndex((function(e){return"rotation"===e.type&&null!=e.valueExpression&&(0,Y.e)(e.valueExpression)===r&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType}));if(i<0)return t;var n=t.clone();return n.visualVariables.splice(i,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(n,r),n}},{key:"scaleVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.scaleVisibility}},{key:"filterVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.filterVisibility}},{key:"elevationAlignment",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.elevationAlignment}},{key:"objectStates",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.objectStates}},{key:"suspendResumeExtentMode",get:function(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}},{key:"scaleVisibilitySuspended",get:function(){return(0,k.r)(this.scaleVisibility)&&this.scaleVisibility.suspended}},{key:"suspended",get:function(){return this.owner.suspended}},{key:"legendEnabled",get:function(){return(0,k.t)(this.frustumVisibility)||!this.frustumVisibility.suspended}},{key:"suspendInfo",get:function(){var e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),(0,k.r)(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}},{key:"updating",get:function(){var e,t;return!!(null!==(e=this.graphicsCore)&&void 0!==e&&e.updating||(0,k.r)(this.frustumVisibility)&&this.frustumVisibility.updating||null!==(t=this.updatingHandles)&&void 0!==t&&t.updating)}},{key:"updatingRemaining",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.updatingRemaining)&&void 0!==e?e:0}},{key:"featureStore",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.featureStore}},{key:"view",get:function(){return this.owner.view}},{key:"loadedGraphics",get:function(){return this.owner.loadedGraphics}},{key:"fullOpacity",get:function(){var e;return null===(e=this.owner)||void 0===e?void 0:e.fullOpacity}},{key:"filter",get:function(){return"filter"in this.owner?this.owner.filter:null}},{key:"slicePlaneEnabled",get:function(){return this.owner.slicePlaneEnabled}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"featureSpatialReference",get:function(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}},{key:"graphics3DGraphics",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphics}},{key:"graphics3DGraphicsByObjectID",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphicsByObjectID}},{key:"symbolUpdateType",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.symbolUpdateType}},{key:"displayFeatureLimit",get:function(){var e,t=this.view.resourceController.memoryController.memoryFactor,r=null===(e=this.graphicsCore)||void 0===e?void 0:e.displayFeatureLimit;if(1===t)return r;var i=Math.ceil(r.maximumNumberOfFeatures*t),n=Math.ceil(r.maximumTotalNumberOfFeatures*t),a=Math.ceil(r.minimumTotalNumberOfFeatures*t);return(0,p.Z)((0,p.Z)({},r),{},{maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:n,minimumTotalNumberOfFeatures:a})}},{key:"usedMemory",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}},{key:"loadedFeatures",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.numberOfGraphics)&&void 0!==e?e:0}},{key:"usedMemoryPerFeature",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemoryPerGraphic)&&void 0!==e?e:0}},{key:"unprocessedMemoryEstimate",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.unprocessedMemoryEstimate)&&void 0!==e?e:0}},{key:"performanceInfo",get:function(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:(0,k.t)(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibilitySuspended}}},{key:"maskOccludee",value:function(e){var t=this.objectStates.acquireSet(ie.u.MaskOccludee,null),r=t.set,i=t.handle;return this.objectStates.setUid(r,e.uid),i}},{key:"highlight",value:function(e,t){var r=this;if(e instanceof D.x){var i=this.objectStates.acquireSet(ie.u.Highlight,t),n=i.set,a=i.handle;return this.owner.queryObjectIds(e).then((function(e){return r.objectStates.setObjectIds(n,e)})),a}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof z.g)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof z.g){var s=e;if(null==$e(this.layer.fieldsIndex,s[0].attributes,t)){var u=s.map((function(e){return e.uid})),o=this.objectStates.acquireSet(ie.u.Highlight,null),l=o.set,c=o.handle;return this.objectStates.setUids(l,u),c}e=s.map((function(e){return $e(r.layer.fieldsIndex,e.attributes,t)}))}if("number"==typeof e[0]||"string"==typeof e[0]){var h=e,d=this.objectStates.acquireSet(ie.u.Highlight,t),f=d.set,p=d.handle;return this.objectStates.setObjectIds(f,h),p}}return at}},{key:"whenGraphicBounds",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.computeAttachmentOrigin(e,t)}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"getRenderingInfo",value:function(e,t,r){var i,n=(0,R.a)(e,{renderer:t,arcade:r});if((0,k.r)(n)&&n.color){var a=n.color;a[0]=a[0]/255,a[1]=a[1]/255,a[2]=a[2]/255}if((0,k.r)(n)&&(0,k.r)(t)&&null!==(i=this._randomRotationRenderers)&&void 0!==i&&i.has(t)){var s=this._randomRotationRenderers.get(t),u=e.attributes[s],o=new X.i(0);o.updateFloatArray([u]),o.updateUint8Array([173]),n.heading=8.381e-8*o.digest()}return n}},{key:"getRenderingInfoAsync",value:function(e,t,r,i){return(0,R.s)(e,(0,p.Z)({renderer:t,arcade:r},i))}},{key:"getSymbolLayerSize",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.getSymbolLayerSize(e,t)}},{key:"setObjectIdVisibility",value:function(e,t){var r;null===(r=this.graphicsCore)||void 0===r||r.setObjectIdVisibility(e,t)}},{key:"refreshFilter",value:function(){(0,k.r)(this.filterVisibility)&&this.filterVisibility.reapply()}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null===(t=this.graphicsCore)||void 0===t?void 0:t.getGraphics3DGraphicByObjectId(e)}},{key:"_updateClippingExtent",value:function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}},{key:"_setupSuspendResumeExtent",value:function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this.handles.add((0,w.l)((function(){return e.suspendResumeExtentMode}),(function(){switch(e.handles.remove(nt),e.suspendResumeExtentMode){case"computed":e.handles.add([(0,w.l)((function(){return e.graphicsCore.computedExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),w.h),(0,w.l)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent(e.graphicsCore.computedExtent)}))],nt);break;case"data":e.handles.add([(0,w.f)((function(){return e.dataExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),w.h),(0,w.l)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent((0,k.e)(e.dataExtent))}))],nt)}}),w.h))}},{key:"_updateSuspendResumeExtent",value:function(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}},{key:"_extentToSuspendResumeRect",value:function(e,t){var r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!(0,N.g)(e,r))return;e=(0,N.M)(e,r)}return(0,R.z)(e,t,R.b,this.graphicsCore.extentPadding)}},{key:"_suspendResumeExtentChanged",value:function(e){(0,k.r)(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),(0,k.r)(this.scaleVisibility)&&this.scaleVisibility.setExtent(e)}}]),r}(O.d);(0,E.e)([(0,E.y)()],rt.prototype,"type",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"owner",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"layer",null),(0,E.e)([(0,E.y)()],rt.prototype,"renderer",null),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"updateClippingExtent",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"elevationFeatureExpressionEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"graphicsCore",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"scaleVisibilityEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"filterVisibilityEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"frustumVisibilityEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"elevationAlignmentEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"timeExtentEnabled",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"setUidToIdOnAdd",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"scaleVisibility",null),(0,E.e)([(0,E.y)()],rt.prototype,"filterVisibility",null),(0,E.e)([(0,E.y)()],rt.prototype,"elevationAlignment",null),(0,E.e)([(0,E.y)({constructOnly:!0})],rt.prototype,"frustumVisibility",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"objectStates",null),(0,E.e)([(0,E.y)()],rt.prototype,"initializePromise",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"suspendResumeExtentMode",null),(0,E.e)([(0,E.y)()],rt.prototype,"dataExtent",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"scaleVisibilitySuspended",null),(0,E.e)([(0,E.y)()],rt.prototype,"suspended",null),(0,E.e)([(0,E.y)()],rt.prototype,"legendEnabled",null),(0,E.e)([(0,E.y)()],rt.prototype,"suspendInfo",null),(0,E.e)([(0,E.y)()],rt.prototype,"updating",null),(0,E.e)([(0,E.y)()],rt.prototype,"updatingRemaining",null),(0,E.e)([(0,E.y)()],rt.prototype,"featureStore",null),(0,E.e)([(0,E.y)()],rt.prototype,"view",null),(0,E.e)([(0,E.y)()],rt.prototype,"loadedGraphics",null),(0,E.e)([(0,E.y)()],rt.prototype,"fullOpacity",null),(0,E.e)([(0,E.y)()],rt.prototype,"filter",null),(0,E.e)([(0,E.y)()],rt.prototype,"slicePlaneEnabled",null),(0,E.e)([(0,E.y)()],rt.prototype,"drapeSourceType",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"updatePolicy",null),(0,E.e)([(0,E.y)()],rt.prototype,"preferredUpdatePolicy",void 0),(0,E.e)([(0,E.y)()],rt.prototype,"displayFeatureLimit",null);var it=rt=(0,E.e)([(0,E.n)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],rt),nt="suspendResumeExtentMode",at={remove:function(){},pause:function(){},resume:function(){}};function st(e){var t=new de.o;t.include(de.F),t.include(de.bR);var r=e.usesHalfFloat;return t.fragment.uniforms.add([new de.h("densityMap",(function(e){return e.densityMap})),new de.h("tex",(function(e){return e.colorRamp})),new de.g("densityNormalizer",(function(e){return 1/(e.maxDensity-e.minDensity)})),new de.g("minDensity",(function(e){return e.minDensity}))]),t.fragment.uniforms.add(new de.g("densityMultiplier",(function(e){return 3/(e.searchRadius*e.searchRadius*Math.PI)}))),r&&t.constants.add("compressionFactor","float",4),t.fragment.code.add((0,de.n)(i||(i=(0,f.Z)(["\n    void main() {\n      float density = texture2D(densityMap, uv).r * densityMultiplier",";\n      float densityRatio = (density - minDensity) * densityNormalizer;\n\n      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));\n\n      discardOrAdjustAlpha(color);\n      gl_FragColor = color;\n    }\n  "])),r?(0,de.n)(n||(n=(0,f.Z)([" * compressionFactor"]))):"")),t}var ut=Object.freeze(Object.defineProperty({__proto__:null,build:st},Symbol.toStringTag,{value:"Module"})),ot=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).colorRamp=null,e.densityMap=null,e.searchRadius=1,e.fieldTotal=0,e.minDensity=0,e.maxDensity=100,e}return(0,b.Z)(r)}(de.t),lt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e,i){var n;return(0,x.Z)(this,r),n=t.call(this,e,i,(function(){return n.destroy()}))}return(0,b.Z)(r,[{key:"initializeProgram",value:function(e){return new de.l(e.rctx,r.shader.get().build(this.configuration),de.E)}},{key:"initializePipeline",value:function(){return(0,ie.W)({blending:ie.d,colorWrite:ie._,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return fe.E.TRIANGLE_STRIP}}]),r}(de.k);lt.shader=new de.m(ut,(function(){return r.e(4042).then(r.bind(r,24042))}));var ct=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).usesHalfFloat=!1,e}return(0,b.Z)(r)}(de.J);(0,E.e)([(0,de.p)()],ct.prototype,"usesHalfFloat",void 0);var ht=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e)).pixelRatio=1,i._colorRampData=new Uint8ClampedArray(4),i.type="draped-heatmap",i._heatmapParameters=new ot,i}return(0,b.Z)(r,[{key:"initialize",value:function(){var e=this,t={colorTarget:fe.Y.TEXTURE,depthStencilTarget:fe.V.NONE,width:0,height:0},r={target:fe.M.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:fe.D.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new pe.x(this.rctx,t,r),this._quad=(0,de.u)(this.rctx);var i=this._colorRampData,n={target:fe.M.TEXTURE_2D,pixelFormat:fe.P.RGBA,dataType:fe.G.UNSIGNED_BYTE,samplingMode:fe.L.LINEAR,wrapMode:fe.D.CLAMP_TO_EDGE,width:i.length/4,height:1};this._colorRamp=new ye.E(this.rctx,n,i);var a=new ct;a.usesHalfFloat=this.dataType!==fe.G.FLOAT,this._technique=new lt({rctx:this.rctx,viewingMode:M.l.Local},a),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,w.l)((function(){return[e.colorRampData,e.minDensity,e.maxDensity,e.fieldTotal,e.pixelRatio,e.searchRadius]}),(function(){return e.rendererContext.notifyContentChanged()})))}},{key:"destroy",value:function(){this._technique=(0,k.F)(this._technique),this._densityMap=(0,k.G)(this._densityMap),this._quad=(0,k.G)(this._quad),this._colorRamp=(0,k.G)(this._colorRamp)}},{key:"searchRadius",get:function(){return this._heatmapParameters.searchRadius},set:function(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}},{key:"minDensity",get:function(){return this._heatmapParameters.minDensity},set:function(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}},{key:"maxDensity",get:function(){return this._heatmapParameters.maxDensity},set:function(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}},{key:"fieldTotal",get:function(){return this._heatmapParameters.fieldTotal},set:function(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}},{key:"colorRampData",get:function(){return this._colorRampData},set:function(e){var t=this._heatmapParameters.colorRamp;if((0,k.r)(t)&&e!==this._colorRampData){var r=t.descriptor.width,i=e.length/4;i!==r&&t.resize(i,1),t.setData(e)}this._colorRampData=e}},{key:"_colorRamp",get:function(){return this._heatmapParameters.colorRamp},set:function(e){this._heatmapParameters.colorRamp=e}},{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}},{key:"render",value:function(e,t){var r=this._sortedMaterialRenderers,i=r.length;if(!(i<1)){var n=this.rctx.getBoundFramebufferObject(),a=this.rctx.getViewport(),s=this.pixelRatio,u=Math.ceil(a.width*s),o=Math.ceil(a.height*s);this._densityMap.resize(u,o),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,u,o),this.rctx.clear(fe._.COLOR_BUFFER_BIT);for(var l=!1,c=0;c<i;c++){var h=r.getItemAt(c);h.material.shouldRender(e)&&(l=l||h.materialRenderer.render(e.output,t))}this.rctx.bindFramebuffer(n),this.rctx.setViewport(a.x,a.y,a.width,a.height),l&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,pe.n)(this._quad,"geometry")))}}}]),r}(R.V);function dt(e){var t=new de.o,r=t.vertex,i=t.fragment;(0,de.T)(r,e);var n=e.isAttributeDriven,c=e.usesHalfFloat;return t.attributes.add(ve.O.POSITION,"vec3"),t.attributes.add(ve.O.UV0,"vec2"),n&&(t.attributes.add(ve.O.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),c&&t.constants.add("compressionFactor","float",.25),t.varyings.add("unitCirclePos","vec2"),r.uniforms.add(new de.g("radius",(function(e,t){var r=e.resolutionForScale,i=e.searchRadius,n=t.camera,a=t.screenToWorldRatio;return 2*i*(0===r?1:r/a)*n.pixelRatio/n.fullViewport[2]}))),r.code.add((0,de.n)(a||(a=(0,f.Z)(["\n    void main() {\n      unitCirclePos = uv0;\n\n      vec4 posProj = proj * (view * vec4(",", 1.0));\n      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);\n\n      ","\n      gl_Position = posProj + quadOffset;\n    }\n  "])),ve.O.POSITION,n?(0,de.n)(s||(s=(0,f.Z)(["attributeValue = ",";"])),ve.O.FEATUREATTRIBUTE):"")),i.code.add((0,de.n)(u||(u=(0,f.Z)(["\n    void main() {\n      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);\n      if (radiusRatioSquared > 1.0) {\n        discard;\n      }\n\n      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;\n      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared "," ",";\n      gl_FragColor = vec4(density);\n    }\n  "])),n?(0,de.n)(o||(o=(0,f.Z)([" * attributeValue"]))):"",c?(0,de.n)(l||(l=(0,f.Z)([" * compressionFactor"]))):"")),t}(0,E.e)([(0,E.y)()],ht.prototype,"searchRadius",null),(0,E.e)([(0,E.y)()],ht.prototype,"minDensity",null),(0,E.e)([(0,E.y)()],ht.prototype,"maxDensity",null),(0,E.e)([(0,E.y)()],ht.prototype,"fieldTotal",null),(0,E.e)([(0,E.y)()],ht.prototype,"pixelRatio",void 0),(0,E.e)([(0,E.y)()],ht.prototype,"colorRampData",null),(0,E.e)([(0,E.y)({constructOnly:!0})],ht.prototype,"dataType",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],ht.prototype,"samplingMode",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],ht.prototype,"pixelFormat",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],ht.prototype,"internalFormat",void 0),(0,E.e)([(0,E.y)()],ht.prototype,"_colorRampData",void 0),ht=(0,E.e)([(0,E.n)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],ht);var ft,pt=Object.freeze(Object.defineProperty({__proto__:null,build:dt},Symbol.toStringTag,{value:"Module"}));!function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"}(ft||(ft={}));var yt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).searchRadius=128,e.resolutionForScale=0,e}return(0,b.Z)(r)}(de.ar),vt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){return(0,x.Z)(this,r),t.apply(this,arguments)}return(0,b.Z)(r,[{key:"initializeProgram",value:function(e){return new de.l(e.rctx,r.shader.get().build(this.configuration),de.E)}},{key:"initializePipeline",value:function(){return(0,ie.W)({blending:(0,ie.s)(fe.R.ONE,fe.R.ONE,fe.T.ADD),colorWrite:ie._,depthTest:null,depthWrite:null})}},{key:"destroy",value:function(){(0,h.Z)((0,d.Z)(r.prototype),"destroy",this).call(this)}}]),r}(de.k);vt.shader=new de.m(pt,(function(){return r.e(8422).then(r.bind(r,78422))}));var mt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloat=!1,e}return(0,b.Z)(r)}(de.J);(0,E.e)([(0,de.p)()],mt.prototype,"isAttributeDriven",void 0),(0,E.e)([(0,de.p)()],mt.prototype,"usesHalfFloat",void 0);var gt=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloats=!1,e}return(0,b.Z)(r)}(yt),_t=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e,new gt))._configuration=new mt,i}return(0,b.Z)(r,[{key:"requiresSlot",value:function(e,t){return e===de.H.DRAPED_MATERIAL&&t===de.O.Color}},{key:"getConfiguration",value:function(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}},{key:"createGLMaterial",value:function(e){return new Ft(e)}},{key:"intersect",value:function(e,t,r,i,n,a,s,u,o){if(!(0,k.t)(o)&&(0,_e.a3)(a))for(var l=e.vertexAttributes.get(ve.O.POSITION),c=this.parameters.searchRadius,h=e.screenToWorldRatio,d=c*h+2*h,f=d*d,p=l.data.length/l.size,y=0;y<p;y++){var v=y*l.size,m=(0,me.r)(wt,l.data[v],l.data[v+1]);(0,me.b)(m,a)<f&&s(o.dist,o.normal,-1,!1)}}},{key:"createBufferWriter",value:function(){return new xt(this.parameters.isAttributeDriven?Et:bt)}}]),r}(de.aa),Ft=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){return(0,x.Z)(this,r),t.apply(this,arguments)}return(0,b.Z)(r,[{key:"beginSlot",value:function(e){return this.ensureTechnique(vt,e)}}]),r}(de.aq),xt=function(){function e(t){(0,x.Z)(this,e),this.vertexBufferLayout=t}return(0,b.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(ve.O.POSITION).length*kt}},{key:"write",value:function(e,t,r,i,n){(0,de.ai)(r.indices.get(ve.O.POSITION),r.vertexAttributes.get(ve.O.POSITION).data,e,i.position,n,kt);for(var a=r.indices.get(ve.O.POSITION).length,s=i.uv0,u=n,o=0;o<a;++o)s.setValues(u++,-1,-1),s.setValues(u++,1,-1),s.setValues(u++,1,1),s.setValues(u++,1,1),s.setValues(u++,-1,1),s.setValues(u++,-1,-1);var l="featureAttribute"in i?i.featureAttribute:null;l&&(0,de.bS)(r.indices.get(ve.O.FEATUREATTRIBUTE),r.vertexAttributes.get(ve.O.FEATUREATTRIBUTE).data,l,n,kt)}}]),e}(),bt=(0,Fe.T)().vec3f(ve.O.POSITION).vec2f(ve.O.UV0),Et=bt.clone().f32(ve.O.FEATUREATTRIBUTE),kt=6,wt=(0,ge.n)(),Rt="esri.views.3d.layers.support.HeatmapFeatureProcessor",Tt=E.a.getLogger(Rt),St=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(e){var i;return(0,x.Z)(this,r),(i=t.call(this,e)).type="heatmap",i.preferredUpdatePolicy=ie.i.ASYNC,i.dataExtent=null,i.drapeSourceType=R.e.Features,i._renderGeometries=new Map,i._fieldTotal=0,i._drapeSourceRenderer=null,i._dataType=fe.G.HALF_FLOAT,i._pixelFormat=fe.P.RGBA,i.initializePromise=Promise.resolve(),i}return(0,b.Z)(r,[{key:"initialize",value:function(){var e=this;this._featureStore=new le.u({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});var t=(0,be.n)(this._renderView.renderingContext,Tt),r=t.dataType,i=t.samplingMode,n=t.pixelFormat,a=t.internalFormat;this._dataType=r,this._pixelFormat=n;var s=r!==fe.G.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,ht,(0,p.Z)((0,p.Z)({},this._rendererParameters),{},{dataType:r,samplingMode:i,pixelFormat:n,internalFormat:a})),this._material=new _t({usesHalfFloats:s}),this._materialWithField=new _t({usesHalfFloats:s,isAttributeDriven:!0}),this._filterVisibility=new tt({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:function(){return e._loadedPointGraphics.length},setAllFeaturesVisibility:function(t){return e._setAllFeaturesVisibility(t)},clearFeaturesVisibility:function(){return e._setAllFeaturesVisibility(!0)},updateFeatureVisibilities:function(t){return e._updateFeatureVisibilities(t)}}}),this.updatingHandles.addOnCollectionChange((function(){return e._loadedPointGraphics}),(function(t){return e._onLoadedFeaturesChange(t)}),w.h),this.updatingHandles.addWhen((function(){return e._materialParameters}),(function(t){return e._forEachMaterial((function(e){return e.setParameters(t)}))}),w.h),this.updatingHandles.add((function(){return e._rendererParameters}),(function(t){return e._drapeSourceRenderer.set(t)})),this.updatingHandles.add((function(){return e._heatmapRendererField}),(function(){e._recreate()}),w.U),this.updatingHandles.add((function(){return{fieldName:e._heatmapRendererFieldName,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var r=t.fieldName,i=t.numeric;if((0,k.r)(r)&&i){var n=0;e._featureStore.forEach((function(e){var t;return n+=null!==(t=e.attributes[r])&&void 0!==t?t:0})),e._fieldTotal=n}else e._fieldTotal=e._featureStore.numFeatures}),w.h),this.handles.add([(0,w.l)((function(){return{fieldName:e._heatmapRendererFieldName,field:e._heatmapRendererField}}),(function(t){var r,i=t.fieldName,n=t.field;i&&!n&&Tt.warn("Heatmap renderer field '".concat(i,"' for layer '").concat(null!==(r=e.layer.title)&&void 0!==r?r:e.layer.id,"' not found"))})),(0,w.l)((function(){return{field:e._heatmapRendererField,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var r,i=t.field,n=t.numeric;(0,k.r)(i)&&!n&&Tt.warn("Heatmap renderer field '".concat(i.name,"' for layer '").concat(null!==(r=e.layer.title)&&void 0!==r?r:e.layer.id,"' does not contain numeric values and cannot be used to drive the heatmap density"))})),(0,E.D)((function(){return e.view.basemapTerrain.overlayManager.unregisterDrapeSource(e)}))])}},{key:"destroy",value:function(){this._renderGeometries.clear(),this._material=(0,k.G)(this._material),this._materialWithField=(0,k.G)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}},{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating||this.filterVisibility.updating}},{key:"updatingRemaining",get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"displayFeatureLimit",get:function(){var e,t,r,i,n,a,s,u=null!==(e=null===(t=this.owner)||void 0===t||null===(r=t.view)||void 0===r||null===(i=r.resourceController)||void 0===i||null===(n=i.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1,o=null===(a=this.owner)||void 0===a||null===(s=a.view)||void 0===s?void 0:s.qualitySettings,l=o?Math.ceil(o.heatmap.maxTotalNumberOfFeatures*u):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:l,maximumTotalNumberOfPrimitives:2*l,maximumNumberOfFeatures:l}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"view",get:function(){return this.owner.view}},{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"scaleVisibilitySuspended",get:function(){if(!this._isScaleRangeActive)return!1;var e=this.layer.effectiveScaleRange,t=e.minScale,r=e.maxScale,i=this.view.scale;return!(0,xe.c)(i,null!==t&&void 0!==t?t:0,null!==r&&void 0!==r?r:0)}},{key:"usedMemory",get:function(){var e,t,r,i=this.usedMemoryPerFeature*this._featureStore.numFeatures,n=this._pixelFormat===fe.P.RED?1:4,a=this._dataType===fe.G.FLOAT?4:2,s=null!==(e=Math.ceil((null===(t=this._overlayRenderer)||void 0===t||null===(r=t.overlays[0])||void 0===r?void 0:r.resolution)*this._densityMapPixelRatio))&&void 0!==e?e:0;return s*s*n*a+i}},{key:"usedMemoryPerFeature",get:function(){var e=this._loadedPointGraphics.find((function(){return!0}));if((0,k.t)(e))return 0;var t=(0,A.t)(e),r=(0,A.r)();return 6*(0,A.c)([0,0,0],r)+6*(0,A.c)([0,0],r)+(this._heatmapRendererFieldIsNumeric?6*r:0)+t}},{key:"loadedFeatures",get:function(){return this._featureStore.numFeatures}},{key:"unprocessedMemoryEstimate",get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"renderer",get:function(){return this._heatmapRenderer}},{key:"_overlayRenderer",get:function(){return this.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return(0,k.e)(this._overlayRenderer.spatialReference)}},{key:"_rendererParameters",get:function(){return(0,p.Z)((0,p.Z)((0,p.Z)((0,p.Z)({},this._radiusParameter),this._densityParameters),this._colorRampParameter),this._pixelRatioParameter)}},{key:"_materialParameters",get:function(){return(0,p.Z)((0,p.Z)({},this._radiusParameter),this._resolutionForScaleParameter)}},{key:"_densityParameters",get:function(){var e=this._heatmapRenderer;return(0,k.t)(e)?null:{minDensity:e.minDensity,maxDensity:e.maxDensity,fieldTotal:this._fieldTotal}}},{key:"_radiusParameter",get:function(){var e=this;return(0,k.n)(this._heatmapRenderer,(function(t){var r=t.radius;return{searchRadius:(0,ne.u)(e._clampSearchRadius(r))}}))}},{key:"_resolutionForScaleParameter",get:function(){var e=this;return(0,k.n)(this._heatmapRenderer,(function(t){var r=t.referenceScale;return{resolutionForScale:0===r?0:(0,se.r)(r,e.view.spatialReference)}}))}},{key:"_colorRampParameter",get:function(){return(0,k.n)(this._heatmapRenderer,(function(e){return{colorRampData:(0,he.u)(e.colorStops)}}))}},{key:"_pixelRatioParameter",get:function(){return{pixelRatio:this._densityMapPixelRatio}}},{key:"_densityMapPixelRatio",get:function(){var e,t,r,i,n,a,s,u,o=null!==(e=null===(t=this.owner)||void 0===t||null===(r=t.view)||void 0===r||null===(i=r.resourceController)||void 0===i||null===(n=i.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1;return(null!==(a=null===(s=this.owner)||void 0===s||null===(u=s.view)||void 0===u?void 0:u.qualitySettings.heatmap.pixelRatio)&&void 0!==a?a:1)*Math.sqrt(o)}},{key:"_renderView",get:function(){return this.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){var e=this.layer.renderer;return"heatmap"===(null===e||void 0===e?void 0:e.type)?e:null}},{key:"_heatmapRendererFieldName",get:function(){return(0,k.n)(this._heatmapRenderer,(function(e){return e.field}))}},{key:"_heatmapRendererField",get:function(){var e=this;return(0,k.n)(this._heatmapRendererFieldName,(function(t){return e.layer.fieldsIndex.get(t)}))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){var e=this._heatmapRendererField;return!(0,k.t)(e)&&(0,ce.b)(e)}},{key:"_isScaleRangeActive",get:function(){var e=this.layer;if(!("effectiveScaleRange"in e))return!1;var t=e.effectiveScaleRange,r=t.minScale,i=t.maxScale;return(0,xe.o)(r,i)}},{key:"_visibleFeatures",get:function(){var e=0;return this._renderGeometries.forEach((function(t){t.instanceParameters.visible&&++e})),e}},{key:"whenGraphicBounds",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(){return null}},{key:"highlight",value:function(){return Ct}},{key:"maskOccludee",value:function(){return Ct}},{key:"setObjectIdVisibility",value:function(){}},{key:"refreshFilter",value:function(){this.filterVisibility.reapply()}},{key:"_onLoadedFeaturesChange",value:function(e){var t=this;if(this._featuresArePoints){var r=this.layer.objectIdField;this._featureStore.removeManyById(e.removed.map((function(e){return(0,V.O)(e,r)}))),this._featureStore.addMany(e.added.map((function(e){var t=new oe.s((0,ue._)(new oe.t,e.geometry),e.attributes,(0,k.n)(e.centroid,(function(e){return(0,ue._)(new oe.t,e)})),(0,V.O)(e,r));return t.displayId=e.uid,t})));var i=e.added,n=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,n);var a=(0,k.a6)(n,(function(e){var r=e.uid,i=t._renderGeometries.get(r);return t._renderGeometries.delete(r),i})),s=i.map((function(e){var r=t._pointGraphicToRenderGeometry(e);return t._renderGeometries.set(e.uid,r),r}));a.length>0&&this._drapeSourceRenderer.removeGeometries(a,R.w.REMOVE),s.length>0&&this._drapeSourceRenderer.addGeometries(s,R.w.ADD),(s.length>0||a.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}}},{key:"_recreate",value:function(){if(this._loadedPointGraphics){var e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}}},{key:"_pointGraphicToRenderGeometry",value:function(e){var t,r=this._heatmapRendererFieldName,i=(0,k.r)(r)?this._materialWithField:this._material,n=(0,U.n)();(0,ae.g)(e.geometry,n,this._overlaySpatialReference),n[2]=R.W;var a=[[ve.O.POSITION,{data:n,size:n.length}]],s=this._heatmapRendererFieldIsNumeric;(0,k.r)(r)&&a.push([ve.O.FEATUREATTRIBUTE,{data:[s&&null!==(t=e.attributes[r])&&void 0!==t?t:0],size:1}]);var u=new R.B(new de.M(a,null,ie.a.Point),i,{layerUid:this.layer.uid,graphicUid:e.uid});return(0,U.r)(u.boundingSphere,n),u.instanceParameters.visible=this.filterVisibility.defaultVisibility,u}},{key:"_forEachMaterial",value:function(e){e(this._material),e(this._materialWithField)}},{key:"_computeFieldTotalChange",value:function(e,t){if((0,k.t)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;var r=this._heatmapRendererFieldName,i=function(e,t){var i;return e+(null!==(i=t.attributes[r])&&void 0!==i?i:0)};return e.reduce(i,0)-t.reduce(i,0)}},{key:"_clampSearchRadius",value:function(e){return e>112&&Tt.warnOnce("SceneView supports a maximum radius of ".concat(112," pt for HeatmapRenderer.")),Math.min(e,112)}},{key:"_updateFeatureVisibilities",value:function(e){var t=this,r=[];this._featureStore.forEach((function(i){var n=i.objectId,a=i.displayId,s=e(n),u=t._renderGeometries.get(a);u.instanceParameters.visible!==s&&(r.push(u),u.instanceParameters.visible=s)})),this._drapeSourceRenderer.modifyGeometries(r,R.X.VISIBILITIES)}},{key:"_setAllFeaturesVisibility",value:function(e){var t,r=[],i=(0,F.Z)(this._renderGeometries.values());try{for(i.s();!(t=i.n()).done;){var n=t.value;n.instanceParameters.visible!==e&&(r.push(n),n.instanceParameters.visible=e)}}catch(a){i.e(a)}finally{i.f()}this._drapeSourceRenderer.modifyGeometries(r,R.X.VISIBILITIES)}},{key:"test",get:function(){return{visibleFeatureCount:this._visibleFeatures}}}]),r}(O.d);(0,E.e)([(0,E.y)()],St.prototype,"type",void 0),(0,E.e)([(0,E.y)({constructOnly:!0})],St.prototype,"owner",void 0),(0,E.e)([(0,E.y)()],St.prototype,"layer",null),(0,E.e)([(0,E.y)()],St.prototype,"featureStore",null),(0,E.e)([(0,E.y)()],St.prototype,"updating",null),(0,E.e)([(0,E.y)()],St.prototype,"updatingRemaining",null),(0,E.e)([(0,E.y)()],St.prototype,"suspendInfo",null),(0,E.e)([(0,E.y)()],St.prototype,"legendEnabled",null),(0,E.e)([(0,E.y)()],St.prototype,"filterVisibility",null),(0,E.e)([(0,E.y)()],St.prototype,"displayFeatureLimit",null),(0,E.e)([(0,E.y)()],St.prototype,"preferredUpdatePolicy",void 0),(0,E.e)([(0,E.y)()],St.prototype,"hasZ",null),(0,E.e)([(0,E.y)()],St.prototype,"hasM",null),(0,E.e)([(0,E.y)()],St.prototype,"dataExtent",void 0),(0,E.e)([(0,E.y)()],St.prototype,"view",null),(0,E.e)([(0,E.y)()],St.prototype,"fullOpacity",null),(0,E.e)([(0,E.y)()],St.prototype,"updatePolicy",null),(0,E.e)([(0,E.y)()],St.prototype,"drapeSourceType",void 0),(0,E.e)([(0,E.y)()],St.prototype,"scaleVisibilitySuspended",null),(0,E.e)([(0,E.y)()],St.prototype,"renderer",null),(0,E.e)([(0,E.y)()],St.prototype,"_featureStore",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_filterVisibility",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_overlayRenderer",null),(0,E.e)([(0,E.y)()],St.prototype,"_overlaySpatialReference",null),(0,E.e)([(0,E.y)()],St.prototype,"_rendererParameters",null),(0,E.e)([(0,E.y)()],St.prototype,"_materialParameters",null),(0,E.e)([(0,E.y)()],St.prototype,"_densityParameters",null),(0,E.e)([(0,E.y)()],St.prototype,"_radiusParameter",null),(0,E.e)([(0,E.y)()],St.prototype,"_resolutionForScaleParameter",null),(0,E.e)([(0,E.y)()],St.prototype,"_colorRampParameter",null),(0,E.e)([(0,E.y)()],St.prototype,"_pixelRatioParameter",null),(0,E.e)([(0,E.y)()],St.prototype,"_densityMapPixelRatio",null),(0,E.e)([(0,E.y)()],St.prototype,"_renderGeometries",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_material",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_materialWithField",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_renderView",null),(0,E.e)([(0,E.y)()],St.prototype,"_featuresArePoints",null),(0,E.e)([(0,E.y)()],St.prototype,"_loadedPointGraphics",null),(0,E.e)([(0,E.y)()],St.prototype,"_heatmapRenderer",null),(0,E.e)([(0,E.y)()],St.prototype,"_heatmapRendererFieldName",null),(0,E.e)([(0,E.y)()],St.prototype,"_heatmapRendererField",null),(0,E.e)([(0,E.y)()],St.prototype,"_heatmapRendererFieldIsNumeric",null),(0,E.e)([(0,E.y)()],St.prototype,"_fieldTotal",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_drapeSourceRenderer",void 0),(0,E.e)([(0,E.y)()],St.prototype,"_isScaleRangeActive",null),St=(0,E.e)([(0,E.n)(Rt)],St);var Ct=(0,E.D)(),Ot=function(e){var t=function(e){(0,g.Z)(r,e);var t=(0,_.Z)(r);function r(){var e;return(0,x.Z)(this,r),(e=t.apply(this,arguments)).controller=null,e.updatePolicy=ie.i.SYNC,e.suspendResumeExtentMode="computed",e.slicePlaneEnabled=!1,e.fullExtentInLocalViewSpatialReference=null,e.suspendResumeExtent=null,e._controllerCreated=!1,e.clippingExtent=null,e.supportsHeightUnitConversion=!0,e._pendingController=null,e.queryEngine=null,e}return(0,b.Z)(r,[{key:"initialize",value:function(){var e=this,t=this.layer;if("isTable"in t&&t.isTable)this.addResolvingPromise(Promise.reject(new E.s("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t})));else{this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((function(){return e.layer.renderer}),(function(t){return e._recreateProcessor(t)}),w.h),this.addResolvingPromise((0,m.Z)((0,v.Z)().mark((function t(){var r;return(0,v.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,Ee.l)(e);case 2:return r=t.sent,e.fullExtentInLocalViewSpatialReference=r,t.next=6,e._initializeController();case 6:case"end":return t.stop()}}),t)})))()),this.updatingHandles.add((function(){return e.updatePolicy}),(function(t){return e.processor.preferredUpdatePolicy=t}));this.queryEngine=new et({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return e.processor.featureStore},hasZ:this.hasZ,hasM:this.hasM},priority:H.I.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}}},{key:"destroy",value:function(){this._destroyPendingController(),this.controller=(0,k.g)(this.controller),this._set("processor",(0,k.g)(this.processor)),this.queryEngine=(0,k.g)(this.queryEngine),this.loadedGraphics=null}},{key:"_destroyPendingController",value:function(){this._pendingController=(0,k.g)(this._pendingController)}},{key:"legendEnabled",get:function(){var e;return this.canResume()&&(null===(e=this.processor)||void 0===e?void 0:e.legendEnabled)}},{key:"graphics3DProcessor",get:function(){var e;return"graphics-3d"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"heatmapProcessor",get:function(){var e;return"heatmap"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"symbologySnappingSupported",get:function(){var e,t,r,i=null===(e=this.layer)||void 0===e||null===(t=e.renderer)||void 0===t?void 0:t.getSymbols();return null!==(r=null===i||void 0===i?void 0:i.some(B.B))&&void 0!==r&&r}},{key:"getHit",value:function(e){var t,r=this,i=null;return null!==(t=this.loadedGraphics)&&void 0!==t&&t.forEach((function(t){t.uid===e&&(i=(0,R.f)(t,r.layer))})),i?{type:"graphic",graphic:i,layer:i.layer}:null}},{key:"whenGraphicBounds",value:function(e,t){var r;return null===(r=this.processor)||void 0===r?void 0:r.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var r;return null===(r=this.processor)||void 0===r?void 0:r.computeAttachmentOrigin(e,t)}},{key:"elevationAlignPointsInFeatures",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){var i;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.graphics3DProcessor,!(0,k.t)(i)){e.next=3;break}throw new E.s("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");case 3:return e.abrupt("return",(0,W.m)(this.view,this.layer,(function(e){return i.getGraphics3DGraphicByObjectId(e)}),t,r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryForSymbologySnapping",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t,r){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.symbologySnappingSupported?(0,W.a)(this.graphics3DProcessor,t,r):{candidates:[],sourceCandidateIndices:[]});case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),(0,k.q)(t,"signal"))}},{key:"queryObjectIds",value:function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),(0,k.q)(t,"signal"))}},{key:"queryFeatureCount",value:function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),(0,k.q)(t,"signal"))}},{key:"queryExtent",value:function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),(0,k.q)(t,"signal"))}},{key:"_ensureQuery",value:function(e){return(0,k.t)(e)?this.createQuery():D.x.from(e)}},{key:"highlight",value:function(e){return this.processor.highlight(e,this.layer.objectIdField)}},{key:"maskOccludee",value:function(e){return this.processor.maskOccludee(e)}},{key:"canResume",value:function(){var e;return(0,h.Z)((0,d.Z)(r.prototype),"canResume",this).call(this)&&!(null!==(e=this.processor)&&void 0!==e&&e.scaleVisibilitySuspended)}},{key:"getSuspendInfo",value:function(){var e=(0,h.Z)((0,d.Z)(r.prototype),"getSuspendInfo",this).call(this);return this.processor?(0,p.Z)((0,p.Z)({},e),this.processor.suspendInfo):e}},{key:"isUpdating",value:function(){var e,t,r;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null===(e=this.controller)||void 0===e||!e.updating)&&null!==(t=this.view)&&void 0!==t&&null!==(r=t.basemapTerrain)&&void 0!==r&&r.ready&&!this.processor.updating)}},{key:"_initializeController",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.createController(),this._pendingController=t,e.next=4,t.when();case 4:this._setControllerWhenInitialized(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_setControllerWhenInitialized",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var r=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:if(this._controllerCreated=!0,this.notifyChange("updating"),!this.isResolved()||this.destroyed){e.next=19;break}return e.next=12,(0,w.j)((function(){var e,t;return null===(e=r.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.ready}));case 12:this.beforeSetController(t),this._pendingController=null,this.controller=t,this.loadedGraphics=t.graphics,this.notifyChange("updating"),e.next=20;break;case 19:this._destroyPendingController();case 20:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateClippingExtent",value:function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}},{key:"_validateGeometryType",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=this.layer.geometryType,e.next="multipatch"===e.t0||"multipoint"===e.t0?3:4;break;case 3:throw new E.s("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType});case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_recreateProcessor",value:function(e){var t,r,i=this,n="heatmap"===(null===e||void 0===e?void 0:e.type),a="heatmap"===(null===(t=this.processor)||void 0===t?void 0:t.type),s=this.processor;if(!s||n!==a){var u=n?new St({owner:this}):new it({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:function(e){return i._updateClippingExtent(e)}});this._set("processor",u),null!==s&&void 0!==s&&s.destroy(),null!==(r=this.queryEngine)&&void 0!==r&&r.clear(),this.addResolvingPromise(u.initializePromise)}}},{key:"_getResourceInfo",value:function(){var e,t,r=this.controller instanceof Be?this.controller:null;return(0,p.Z)({displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:null!==(e=null===r||void 0===r?void 0:r.maximumNumberOfFeatures)&&void 0!==e?e:-1,totalNumberOfFeatures:null!==(t=null===r||void 0===r?void 0:r.serviceDataCount)&&void 0!==t?t:-1,nodes:0},this.processor.performanceInfo)}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return(0,E.e)([(0,E.y)()],t.prototype,"loadedGraphics",void 0),(0,E.e)([(0,E.y)()],t.prototype,"suspended",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,E.e)([(0,E.y)()],t.prototype,"updating",void 0),(0,E.e)([(0,E.y)()],t.prototype,"controller",void 0),(0,E.e)([(0,E.y)()],t.prototype,"processor",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,E.e)([(0,E.y)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,E.e)([(0,E.y)({readOnly:!0})],t.prototype,"suspendInfo",void 0),(0,E.e)([(0,E.y)()],t.prototype,"graphics3DProcessor",null),(0,E.e)([(0,E.y)()],t.prototype,"heatmapProcessor",null),(0,E.e)([(0,E.y)()],t.prototype,"symbologySnappingSupported",null),t=(0,E.e)([(0,E.n)("esri.views.3d.layers.FeatureLikeLayerView3D")],t)}},72770:function(e,t,r){r.d(t,{n:function(){return p}});var i=r(74165),n=r(15861),a=r(15671),s=r(43144),u=r(11752),o=r(61120),l=r(60136),c=r(29388),h=r(48848),d=r(50690),f=(r(93661),r(70522)),p=function(e){var t=function(e){(0,l.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments)).slicePlaneEnabled=!1,e.supportsHeightUnitConversion=!1,e}return(0,s.Z)(r,[{key:"postscript",value:function(e){(0,u.Z)((0,o.Z)(r.prototype),"postscript",this).call(this,e),(0,f.g)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}},{key:"_validateHeightModelInfo",value:function(){var e=(0,n.Z)((0,i.Z)().mark((function e(){var t,r,n,a=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new AbortController,r=t.signal,this.handles.add((0,h.D)((function(){return t.abort()}))),e.next=4,(0,d.j)((function(){var e;return null===(e=a.view.defaultsFromMap)||void 0===e?void 0:e.heightModelInfoReady}),r);case 4:if((0,h.f)(r),!(n=(0,f.o)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion))){e.next=8;break}throw n;case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"canResume",value:function(){var e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return(0,u.Z)((0,o.Z)(r.prototype),"canResume",this).call(this)&&(!e||!e.minScale||!e.maxScale||e.minScale>=e.maxScale)}},{key:"getSuspendInfo",value:function(){var e=(0,u.Z)((0,o.Z)(r.prototype),"getSuspendInfo",this).call(this),t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return t&&t.minScale&&t.maxScale&&t.minScale<t.maxScale&&(e.outsideScaleRange=!0),e}}]),r}(e);return(0,h.e)([(0,h.y)()],t.prototype,"view",void 0),(0,h.e)([(0,h.y)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,h.e)([(0,h.n)("esri.views.3d.layers.LayerView3D")],t)}},40345:function(e,t,r){r.d(t,{h:function(){return l},i:function(){return u}});var i=r(93661),n=r(82474);function a(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++){var i=e[r],n=t[r];if(i.length!==n.length)return!1;for(var a=0;a<i.length;a++)if(i[a]!==n[a])return!1}return!0}function s(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!a(e[r],t[r]))return!1;return!0}function u(e,t){return e===t||(0,i.r)(e)&&(0,i.r)(t)&&(0,n.E)(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function o(e,t){if(e===t)return!0;if((0,i.t)(e)||(0,i.t)(t))return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return u(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,n.E)(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,n.E)(e.spatialReference,t.spatialReference)&&s(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,n.E)(e.spatialReference,t.spatialReference)&&s(e.rings,t.rings)}(e,t);case"multipoint":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,n.E)(e.spatialReference,t.spatialReference)&&a(e.points,t.points)}(e,t);case"mesh":return!1;default:return}}function l(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!o(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;var r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(var n=0,a=r;n<a.length;n++){var s=a[n];if(e[s]!==t[s])return!1}return!0}(e.attributes,t.attributes)}},52638:function(e,t,r){r.d(t,{E:function(){return y},a:function(){return u},b:function(){return d},f:function(){return o},g:function(){return l},h:function(){return c},i:function(){return s},x:function(){return m},y:function(){return p}});var i=r(93661),n=r(15529);function a(e){return e?y:v}function s(e,t){return function(e,t){return(0,i.t)(t)||!t.mode?a(e).mode:t.mode}(!!(0,i.r)(e)&&e.hasZ,t)}function u(e,t){return function(e,t){return(0,i.r)(t)?t:a(e)}(!!(0,i.r)(e)&&e.hasZ,t)}function o(e){var t=function(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}(e),r=s(e.geometry,t);return{mode:r,offset:(0,i.r)(t)&&"on-the-ground"!==r?(0,i.v)(t.offset,0)*(0,n.r)((0,i.v)(t.unit,"meters")):0}}function l(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return h(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,r,i)}function c(e,t,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return h(e,t[0],t[1],t.length>2?t[2]:0,r,i,n)}function h(e,t,r,n,a,s){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(!(0,i.t)(s)){var o=(0,i.r)(u)?u.mode:"absolute-height";if("on-the-ground"===o)return 0;var l=d(t,r,n,a,e,s),c=l.absoluteZ;return f(c,t,r,n,a,e,u,o)}}function d(e,t,r,n,a,s){var u=(0,i.r)(s.offset)?s.offset:0;switch(s.mode){case"absolute-height":return{absoluteZ:r+u,elevation:0};case"on-the-ground":var o=(0,i.v)(a.elevationProvider.getElevation(e,t,0,n,"ground"),0);return{absoluteZ:o,elevation:o};case"relative-to-ground":var l=(0,i.v)(a.elevationProvider.getElevation(e,t,r,n,"ground"),0);return{absoluteZ:r+l+u,elevation:l};case"relative-to-scene":var c=(0,i.v)(a.elevationProvider.getElevation(e,t,r,n,"scene"),0);return{absoluteZ:r+c+u,elevation:c}}}function f(e,t,r,n,a,s,u,o){var l=(0,i.r)(u)&&(0,i.r)(u.offset)?u.offset:0;switch(o){case"absolute-height":return e-l;case"relative-to-ground":return e-((0,i.v)(s.elevationProvider.getElevation(t,r,n,a,"ground"),0)+l);case"relative-to-scene":return e-((0,i.v)(s.elevationProvider.getElevation(t,r,n,a,"scene"),0)+l)}}function p(e,t){if((0,i.t)(t))return!1;var r=t.mode;return(0,i.r)(r)&&("scene"===e&&"relative-to-scene"===r||"ground"===e&&"absolute-height"!==r)}var y={mode:"absolute-height",offset:0},v={mode:"on-the-ground",offset:null};function m(e,t){return e===t||(0,i.r)(e)&&(0,i.r)(t)&&e.mode===t.mode&&e.offset===t.offset}},36479:function(e,t,r){r.d(t,{i:function(){return d}});var i=r(37762),n=r(15671),a=r(43144),s=2654435761,u=2246822519,o=3266489917,l=668265263,c=374761393;function h(e){for(var t=[],r=0,i=e.length;r<i;r++){var n=e.charCodeAt(r);n<128?t.push(n):n<2048?t.push(192|n>>6,128|63&n):n<55296||n>=57344?t.push(224|n>>12,128|n>>6&63,128|63&n):(r++,n=65536+((1023&n)<<10|1023&e.charCodeAt(r)),t.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return new Uint8Array(t)}var d=function(){function e(t){(0,n.Z)(this,e),this._seed=t,this._totallen=0,this._bufs=[],this.init()}return(0,a.Z)(e,[{key:"init",value:function(){return this._bufs=[],this._totallen=0,this}},{key:"updateFloatArray",value:function(e){var t,r=[],n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;isNaN(a)?r.push("NaN"):a===1/0?r.push("Infinity"):a===-1/0?r.push("-Infinity"):0===a?r.push("0"):r.push(a.toString(16))}}catch(s){n.e(s)}finally{n.f()}this.update(h(r.join("")))}},{key:"updateIntArray",value:function(e){var t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}},{key:"updateUint8Array",value:function(e){this.update(Uint8Array.from(e))}},{key:"updateWithString",value:function(e){return this.update(h(e))}},{key:"update",value:function(e){return this._bufs.push(e),this._totallen+=e.length,this}},{key:"digest",value:function(){var e,t=new Uint8Array(this._totallen),r=0,n=(0,i.Z)(this._bufs);try{for(n.s();!(e=n.n()).done;){var a=e.value;t.set(a,r),r+=a.length}}catch(s){n.e(s)}finally{n.f()}return this.init(),this._xxHash32(t,this._seed)}},{key:"_xxHash32",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e,i=t+c&4294967295,n=0;if(r.length>=16){var a=[t+s+u&4294967295,t+u&4294967295,t+0&4294967295,t-s&4294967295],h=e,d=h.length-16,f=0;for(n=0;(4294967280&n)<=d;n+=4){var p=n,y=h[p+0]+(h[p+1]<<8),v=h[p+2]+(h[p+3]<<8),m=y*u+(v*u<<16),g=a[f]+m&4294967295,_=65535&(g=g<<13|g>>>19),F=g>>>16;a[f]=_*s+(F*s<<16)&4294967295,f=f+1&3}i=(a[0]<<1|a[0]>>>31)+(a[1]<<7|a[1]>>>25)+(a[2]<<12|a[2]>>>20)+(a[3]<<18|a[3]>>>14)&4294967295}i=i+e.length&4294967295;for(var x=e.length-4;n<=x;n+=4){var b=n,E=r[b+0]+(r[b+1]<<8),k=r[b+2]+(r[b+3]<<8);i=(65535&(i=(i=i+(E*o+(k*o<<16))&4294967295)<<17|i>>>15))*l+((i>>>16)*l<<16)&4294967295}for(;n<r.length;++n)i=(65535&(i=(i+=r[n]*c)<<11|i>>>21))*s+((i>>>16)*s<<16)&4294967295;return i=((65535&(i^=i>>>15))*u&4294967295)+((i>>>16)*u<<16),i=((65535&(i^=i>>>13))*o&4294967295)+((i>>>16)*o<<16),(i^=i>>>16)<0?i+4294967296:i}}]),e}()},60491:function(e,t,r){r.d(t,{n:function(){return s}});var i=r(48848),n=r(93661),a=r(93122);function s(e,t){var r=e.capabilities,s=r.textureFloat,u=r.colorBufferFloat,o=null===s||void 0===s?void 0:s.textureFloat,l=null===s||void 0===s?void 0:s.textureFloatLinear,c=null===s||void 0===s?void 0:s.textureHalfFloat,h=null===s||void 0===s?void 0:s.textureHalfFloatLinear,d=null===s||void 0===s?void 0:s.HALF_FLOAT,f=null===u||void 0===u?void 0:u.textureFloat,p=null===u||void 0===u?void 0:u.textureHalfFloat,y=null===u||void 0===u?void 0:u.floatBlend,v=(0,n.i)(e.driverTest).floatBufferBlendWorking;if(!o&&!c)throw new i.s("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float or OES_texture_half_float.");if(!f&&!p)throw new i.s("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(y&&v||p))throw new i.s("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(v?"":" This device claims support for EXT_float_blend, but does not actually support it."));var m=o&&f&&y&&v,g=c&&p,_=l,F=h,x=!(null===u||void 0===u||!u.R32F),b=!(null===u||void 0===u||!u.R16F);if(m&&(_||!F))return _||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),{dataType:a.G.FLOAT,samplingMode:_?a.L.LINEAR:a.L.NEAREST,pixelFormat:x?a.P.RED:a.P.RGBA,internalFormat:x?a.U.R32F:a.P.RGBA};if(g)return F||t.warnOnce("Missing WebGL extension OES_texture_half_float_linear. Heatmap quality may be reduced."),{dataType:d,samplingMode:F?a.L.LINEAR:a.L.NEAREST,pixelFormat:b?a.P.RED:a.P.RGBA,internalFormat:b?a.U.R16F:a.P.RGBA};throw new i.s("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}},3393:function(e,t,r){r.d(t,{l:function(){return s}});var i=r(93661),n=r(82474),a=r(5526);function s(e){var t=e.view.spatialReference,r=e.layer.fullExtent,s=(0,i.r)(r)&&r.spatialReference;if((0,i.t)(r)||!s)return Promise.resolve(null);if(s.equals(t))return Promise.resolve(r.clone());var u=(0,n.M)(r,t);return(0,i.r)(u)?Promise.resolve(u):e.view.state.isLocal?(0,a.projectGeometry)(r,t,e.layer.portalItem).then((function(t){return!e.destroyed&&t?t:void 0})).catch((function(){return null})):Promise.resolve(null)}},96278:function(e,t,r){r.d(t,{a:function(){return g},m:function(){return f}});var i=r(74165),n=r(37762),a=r(15861),s=(r(74384),r(93661)),u=r(48848),o=r(43406),l=r(52638),c=r(28390),h=r(82474),d=r(59984);function f(e,t,r,i,n){return p.apply(this,arguments)}function p(){return p=(0,a.Z)((0,i.Z)().mark((function e(t,r,a,o,h){var d,f,p,g,_,F,x,b,E,k,w,R,T,S,C,O,Z,I,D,P,V,M,A,N,L;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=t.elevationProvider,f=t.renderCoordsHelper,p=t.spatialReference,g=r.elevationInfo,_=(0,c.m)(g,!0),e.next=7,(0,c.u)(_,p,h);case 7:F=e.sent,(0,u.f)(h),x=[],b=new Set,E=new Set,k=(0,n.Z)(o),e.prev=11,k.s();case 13:if((w=k.n()).done){e.next=28;break}if(R=w.value,T=R.objectId,S=R.points,C=a(T),!(0,s.t)(C)){e.next=21;break}O=(0,n.Z)(S);try{for(O.s();!(Z=O.n()).done;)I=Z.value,x.push(I[2])}catch(i){O.e(i)}finally{O.f()}return b.add(T),e.abrupt("continue",26);case 21:C.isDraped&&E.add(T),D=C.graphic.geometry,y.setFromElevationInfo((0,l.a)(D,g)),y.updateFeatureExpressionInfoContext(F,C.graphic,r),v.spatialReference=t.spatialReference,P=(0,n.Z)(S);try{for(P.s();!(V=P.n()).done;)M=V.value,A=M.x,N=M.y,L=M.z,v.x=A,v.y=N,v.z=null!==L&&void 0!==L?L:0,(0,c.Z)(v,d,y,f,m),x.push(m.z)}catch(i){P.e(i)}finally{P.f()}case 26:e.next=13;break;case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(11),k.e(e.t0);case 33:return e.prev=33,k.f(),e.finish(33);case 36:return e.abrupt("return",{elevations:x,drapedObjectIds:E,failedObjectIds:b});case 37:case"end":return e.stop()}}),e,null,[[11,30,33,36]])}))),p.apply(this,arguments)}var y=new c.M,v=(0,o.v)(0,0,0,h.k.WGS84),m=new c._;function g(e,t,r){return _.apply(this,arguments)}function _(){return _=(0,a.Z)((0,i.Z)().mark((function e(t,r,o){var l,c,h,f,p,y,v,m,g,_,x,b,E,k,w,R,T,S,C,O,Z,I;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,s.t)(t)&&0!==r.candidates.length){e.next=2;break}return e.abrupt("return",F);case 2:c=null!==(l=t.graphics3DGraphicsByObjectID)&&void 0!==l?l:t.graphics3DGraphics,h=[],f=[],p=t.renderer,y=(0,s.r)(p)&&"arcadeRequired"in p&&p.arcadeRequired?(0,d.i)():null,v=function(){var e=(0,a.Z)((0,i.Z)().mark((function e(r,n){var a,u,l,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.graphic,u=n.graphics3DSymbol,e.next=3,y;case 3:return l=e.sent,e.next=6,t.getRenderingInfoAsync(a,p,l,{signal:o});case 6:return c=e.sent,e.abrupt("return",(0,s.t)(c)?[]:u.queryForSnapping(r,g,c,o));case 8:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),m=r.candidates,g=r.spatialReference,_=0;case 4:if(!(_<m.length)){e.next=13;break}if(x=m[_],b=x.objectId,E="number"==typeof b?c.get(b):void 0,!(0,s.t)(E)){e.next=8;break}return e.abrupt("continue",10);case 8:E.graphics3DSymbol.symbologySnappingSupported&&(h.push(v(x,E)),f.push(_));case 10:++_,e.next=4;break;case 13:if(0!==h.length){e.next=15;break}return e.abrupt("return",F);case 15:return e.next=17,Promise.all(h);case 17:for(k=e.sent,(0,u.f)(o),w=[],R=[],T=0;T<k.length;++T){S=k[T],C=f[T],O=(0,n.Z)(S);try{for(O.s();!(Z=O.n()).done;)I=Z.value,w.push(I),R.push(C)}catch(D){O.e(D)}finally{O.f()}}return e.abrupt("return",{candidates:w,sourceCandidateIndices:R});case 22:case"end":return e.stop()}}),e)}))),_.apply(this,arguments)}var F={candidates:[],sourceCandidateIndices:[]}}}]);
//# sourceMappingURL=830.d3bfc800.chunk.js.map