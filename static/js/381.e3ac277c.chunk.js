"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[381],{94777:function(e,t,n){n.d(t,{T:function(){return l}});var r=n(37762),i=n(15671),a=n(43144),o=n(85026),s=n(54017),u=function(){function e(t,n){(0,i.Z)(this,e),this.layout=t,this.buffer="number"==typeof n?new ArrayBuffer(n*t.stride):n;var a,o=(0,r.Z)(t.fieldNames);try{for(o.s();!(a=o.n()).done;){var s=a.value,u=t.fields.get(s);this[s]=new u.constructor(this.buffer,u.offset,this.stride)}}catch(c){o.e(c)}finally{o.f()}}return(0,a.Z)(e,[{key:"stride",get:function(){return this.layout.stride}},{key:"count",get:function(){return this.buffer.byteLength/this.stride}},{key:"byteLength",get:function(){return this.buffer.byteLength}},{key:"getField",value:function(e,t){var n=this[e];return n&&n.elementCount===t.ElementCount&&n.elementType===t.ElementType?n:null}},{key:"slice",value:function(t,n){return new e(this.layout,this.buffer.slice(t*this.stride,n*this.stride))}},{key:"copyFrom",value:function(e,t,n,r){var i=this.stride;if(i%4==0){var a=new Uint32Array(e.buffer,t*i,r*i/4);new Uint32Array(this.buffer,n*i,r*i/4).set(a)}else{var o=new Uint8Array(e.buffer,t*i,r*i);new Uint8Array(this.buffer,n*i,r*i).set(o)}}}]),e}(),c=function(){function e(){(0,i.Z)(this,e),this.stride=0,this.fields=new Map,this.fieldNames=[]}return(0,a.Z)(e,[{key:"vec2f",value:function(e,t){return this._appendField(e,o.u,t),this}},{key:"vec2f64",value:function(e,t){return this._appendField(e,o.m,t),this}},{key:"vec3f",value:function(e,t){return this._appendField(e,o.i,t),this}},{key:"vec3f64",value:function(e,t){return this._appendField(e,o.T,t),this}},{key:"vec4f",value:function(e,t){return this._appendField(e,o.c,t),this}},{key:"vec4f64",value:function(e,t){return this._appendField(e,o.h,t),this}},{key:"mat3f",value:function(e,t){return this._appendField(e,o.l,t),this}},{key:"mat3f64",value:function(e,t){return this._appendField(e,o.a,t),this}},{key:"mat4f",value:function(e,t){return this._appendField(e,o.p,t),this}},{key:"mat4f64",value:function(e,t){return this._appendField(e,o.b,t),this}},{key:"vec4u8",value:function(e,t){return this._appendField(e,o.x,t),this}},{key:"f32",value:function(e,t){return this._appendField(e,o.y,t),this}},{key:"f64",value:function(e,t){return this._appendField(e,o.o,t),this}},{key:"u8",value:function(e,t){return this._appendField(e,o.d,t),this}},{key:"u16",value:function(e,t){return this._appendField(e,o.g,t),this}},{key:"i8",value:function(e,t){return this._appendField(e,o.j,t),this}},{key:"vec2i8",value:function(e,t){return this._appendField(e,o.V,t),this}},{key:"vec2i16",value:function(e,t){return this._appendField(e,o.q,t),this}},{key:"vec2u8",value:function(e,t){return this._appendField(e,o.A,t),this}},{key:"vec4u16",value:function(e,t){return this._appendField(e,o.L,t),this}},{key:"u32",value:function(e,t){return this._appendField(e,o.B,t),this}},{key:"_appendField",value:function(e,t,n){var r=t.ElementCount*(0,s.e)(t.ElementType),i=this.stride;this.fields.set(e,{size:r,constructor:t,offset:i,optional:n}),this.stride+=r,this.fieldNames.push(e)}},{key:"alignTo",value:function(e){return this.stride=Math.floor((this.stride+e-1)/e)*e,this}},{key:"hasField",value:function(e){return this.fieldNames.includes(e)}},{key:"createBuffer",value:function(e){return new u(this,e)}},{key:"createView",value:function(e){return new u(this,e)}},{key:"clone",value:function(){var t=new e;return t.stride=this.stride,t.fields=new Map,this.fields.forEach((function(e,n){return t.fields.set(n,e)})),t.fieldNames=this.fieldNames.slice(),t.BufferType=this.BufferType,t}}]),e}();function l(){return new c}},87750:function(e,t,n){n.d(t,{A:function(){return p},B:function(){return g},M:function(){return h},a:function(){return E},b:function(){return f},c:function(){return x},d:function(){return A},e:function(){return S},f:function(){return P},g:function(){return I},h:function(){return Z},i:function(){return M},j:function(){return v},k:function(){return F},l:function(){return L},m:function(){return R},n:function(){return m},o:function(){return l},p:function(){return d},s:function(){return O},u:function(){return C},v:function(){return c}});var r=n(15671),i=n(43144),a=n(71802),o=n(64772),s=n(13239),u=n(91681);function c(e){return e?{origin:(0,a.t)(e.origin),vector:(0,a.t)(e.vector)}:{origin:(0,a.n)(),vector:(0,a.n)()}}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c();return d(e.origin,e.vector,t)}function d(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c();return(0,a.r)(n.origin,e),(0,a.r)(n.vector,t),n}function f(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c();return(0,a.r)(n.origin,e),(0,a.e)(n.vector,t,e),n}function h(e,t){var n=(0,a.e)(o.c.get(),t,e.origin),r=(0,a.P)(e.vector,n),i=(0,a.P)(e.vector,e.vector),s=(0,a.a)(r/i,0,1),u=(0,a.e)(o.c.get(),(0,a.g)(o.c.get(),e.vector,s),n);return(0,a.P)(u,u)}function v(e,t,n){return p(e,t,0,1,n)}function m(e,t,n){return(0,a.u)(n,e.origin,(0,a.g)(n,e.vector,t))}function p(e,t,n,r,i){var s=e.vector,u=e.origin,c=(0,a.e)(o.c.get(),t,u),l=(0,a.P)(s,c)/(0,a.v)(s);return(0,a.g)(i,s,(0,a.a)(l,n,r)),(0,a.u)(i,i,e.origin)}function g(e,t){if(_(e,function(e,t){var n=y.get();return n.origin=e,n.vector=t,n}(t.origin,t.direction),!1,b)){var n=b.tA,r=b.pB,i=b.distance2;if(n>=0&&n<=1)return i;if(n<0)return(0,a.p)(e.origin,r);if(n>1)return(0,a.p)((0,a.u)(o.c.get(),e.origin,e.vector),r)}return null}function x(e,t,n){return!!_(e,t,!0,b)&&((0,a.r)(n,b.pA),!0)}function _(e,t,n,r){var i=1e-6,s=e.origin,u=(0,a.u)(o.c.get(),s,e.vector),c=t.origin,l=(0,a.u)(o.c.get(),c,t.vector),d=o.c.get(),f=o.c.get();if(d[0]=s[0]-c[0],d[1]=s[1]-c[1],d[2]=s[2]-c[2],f[0]=l[0]-c[0],f[1]=l[1]-c[1],f[2]=l[2]-c[2],Math.abs(f[0])<i&&Math.abs(f[1])<i&&Math.abs(f[2])<i)return!1;var h=o.c.get();if(h[0]=u[0]-s[0],h[1]=u[1]-s[1],h[2]=u[2]-s[2],Math.abs(h[0])<i&&Math.abs(h[1])<i&&Math.abs(h[2])<i)return!1;var v=d[0]*f[0]+d[1]*f[1]+d[2]*f[2],m=f[0]*h[0]+f[1]*h[1]+f[2]*h[2],p=d[0]*h[0]+d[1]*h[1]+d[2]*h[2],g=f[0]*f[0]+f[1]*f[1]+f[2]*f[2],x=(h[0]*h[0]+h[1]*h[1]+h[2]*h[2])*g-m*m;if(Math.abs(x)<i)return!1;var _=(v*m-p*g)/x,b=(v+m*_)/g;n&&(_=(0,a.a)(_,0,1),b=(0,a.a)(b,0,1));var y=o.c.get(),T=o.c.get();return y[0]=s[0]+_*h[0],y[1]=s[1]+_*h[1],y[2]=s[2]+_*h[2],T[0]=c[0]+b*f[0],T[1]=c[1]+b*f[1],T[2]=c[2]+b*f[2],r.tA=_,r.tB=b,r.pA=y,r.pB=T,r.distance2=(0,a.p)(y,T),!0}var b={tA:0,tB:0,pA:(0,a.n)(),pB:(0,a.n)(),distance2:0},y=new o.s((function(){return c()})),T=(0,u.n)(),w=function(){function e(t){(0,r.Z)(this,e),this.message=t}return(0,i.Z)(e,[{key:"toString",value:function(){return"AssertException: ".concat(this.message)}}]),e}();function S(e,t){if(!e)throw t=t||"assert",console.log(new Error(t).stack),new w(t)}function O(e,t){e||(t=t||"",console.warn("Verify failed: "+t+"\n"+new Error("verify").stack))}function A(e,t,n,r){var i,a=(n[0]-e[0])/t[0],o=(r[0]-e[0])/t[0];a>o&&(i=a,a=o,o=i);var s=(n[1]-e[1])/t[1],u=(r[1]-e[1])/t[1];if(s>u&&(i=s,s=u,u=i),a>u||s>o)return!1;s>a&&(a=s),u<o&&(o=u);var c=(n[2]-e[2])/t[2],l=(r[2]-e[2])/t[2];return c>l&&(i=c,c=l,l=i),!(a>l||c>o)&&(l<o&&(o=l),!(o<0))}function C(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:(0,s.n)(),o=(r[i]-n[i])*(t[0]-e[0])-(r[0]-n[0])*(t[i]-e[i]),u=(r[0]-n[0])*(e[i]-n[i])-(r[i]-n[i])*(e[0]-n[0]);if(0===o)return!1;var c=u/o;return a[0]=e[0]+c*(t[0]-e[0]),a[1]=e[i]+c*(t[i]-e[i]),!0}function M(e,t,n,r,i){i||(i=e),T[0]=e[0],T[1]=e[1],T[2]=e[2],T[3]=1,(0,a.w)(T,T,t),i.length>2&&(i[2]=-T[2]),(0,a.w)(T,T,n),S(0!==T[3]),i[0]=T[0]/T[3],i[1]=T[1]/T[3],i[2]=T[2]/T[3],i[0]=(.5*i[0]+.5)*r[2]+r[0],i[1]=(.5*i[1]+.5)*r[3]+r[1]}function P(e,t){return Math.log(e)/Math.log(t)}function Z(e,t,n,r){e[12]=t,e[13]=n,e[14]=r}function E(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&1===e[15]}function L(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/t)}function R(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/n)}function I(e,t,n){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}function F(e,t,n){return 2*Math.atan(n*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}},11448:function(e,t,n){n.d(t,{t:function(){return a}});var r=n(43144),i=n(15671),a=(0,r.Z)((function e(t,n,r,a,o){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(0,i.Z)(this,e),this.name=t,this.count=n,this.type=r,this.offset=a,this.stride=o,this.normalized=s,this.divisor=u}))},20675:function(e,t,n){function r(e){return e=e||globalThis.location.hostname,c.some((function(t){var n;return null!=(null===(n=e)||void 0===n?void 0:n.match(t))}))}function i(e,t){return e&&(t=t||globalThis.location.hostname)?null!=t.match(a)||null!=t.match(s)?e.replace("static.arcgis.com","staticdev.arcgis.com"):null!=t.match(o)||null!=t.match(u)?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}n.d(t,{a:function(){return i},c:function(){return r}});var a=/^devext.arcgis.com$/,o=/^qaext.arcgis.com$/,s=/^[\w-]*\.mapsdevext.arcgis.com$/,u=/^[\w-]*\.mapsqa.arcgis.com$/,c=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,a,o,/^jsapps.esri.com$/,s,u]},70381:function(e,t,n){n.r(t),n.d(t,{$:function(){return va},A:function(){return La},B:function(){return Wa},C:function(){return to},D:function(){return ta},E:function(){return Ca},F:function(){return io},G:function(){return ao},H:function(){return so},I:function(){return uo},J:function(){return Ro},K:function(){return Wo},L:function(){return Eo},M:function(){return ss},N:function(){return Ra},O:function(){return yo},P:function(){return fo},Q:function(){return co},R:function(){return lo},S:function(){return ys},T:function(){return Ms},U:function(){return Cs},V:function(){return Is},W:function(){return Es},X:function(){return ws},Y:function(){return zu},Z:function(){return wa},_:function(){return ya},a:function(){return ji},a$:function(){return Bs},a0:function(){return Gu},a1:function(){return sc},a2:function(){return Ju},a3:function(){return Ts},a4:function(){return rc},a5:function(){return oc},a6:function(){return ic},a7:function(){return cc},a8:function(){return uc},a9:function(){return nc},aA:function(){return hc},aB:function(){return yc},aC:function(){return mc},aD:function(){return bc},aE:function(){return fc},aF:function(){return ns},aG:function(){return ac},aH:function(){return Ac},aI:function(){return Fc},aJ:function(){return Ho},aK:function(){return Lc},aL:function(){return No},aM:function(){return fu},aN:function(){return Ns},aO:function(){return xu},aP:function(){return vu},aQ:function(){return Jc},aR:function(){return ka},aS:function(){return Fl},aT:function(){return es},aU:function(){return sl},aV:function(){return Ks},aW:function(){return Xl},aX:function(){return Ml},aY:function(){return Bl},aZ:function(){return Js},a_:function(){return fd},aa:function(){return tu},ab:function(){return hs},ac:function(){return ms},ad:function(){return ts},ae:function(){return vs},af:function(){return Xa},ag:function(){return Ya},ah:function(){return $s},ai:function(){return su},aj:function(){return uu},ak:function(){return lu},al:function(){return ou},am:function(){return du},an:function(){return js},ao:function(){return Yo},ap:function(){return qo},aq:function(){return ja},ar:function(){return nu},as:function(){return ba},at:function(){return lc},au:function(){return Vo},av:function(){return Uo},aw:function(){return oo},ax:function(){return vc},ay:function(){return _c},az:function(){return xc},b:function(){return na},b$:function(){return xd},b0:function(){return Io},b1:function(){return Go},b2:function(){return xl},b3:function(){return ml},b4:function(){return el},b5:function(){return pl},b6:function(){return gl},b7:function(){return Xc},b8:function(){return Ws},b9:function(){return Ko},bA:function(){return Ec},bB:function(){return gc},bC:function(){return Ea},bD:function(){return Ga},bE:function(){return Ua},bF:function(){return Zc},bG:function(){return zc},bH:function(){return tc},bI:function(){return Fa},bJ:function(){return zo},bK:function(){return Bo},bL:function(){return Do},bM:function(){return Fo},bN:function(){return Va},bO:function(){return jo},bP:function(){return Tu},bQ:function(){return Ka},bR:function(){return ul},bS:function(){return ru},bT:function(){return Bu},bU:function(){return Xs},bV:function(){return Ys},bW:function(){return mu},bX:function(){return Ol},bY:function(){return Ll},bZ:function(){return Nc},b_:function(){return Uc},ba:function(){return Ql},bb:function(){return cs},bc:function(){return ls},bd:function(){return Cc},be:function(){return Oc},bf:function(){return wc},bg:function(){return As},bh:function(){return pc},bi:function(){return qs},bj:function(){return Da},bk:function(){return Na},bl:function(){return Us},bm:function(){return dc},bn:function(){return Hs},bo:function(){return Ha},bp:function(){return al},bq:function(){return Sl},br:function(){return cl},bs:function(){return ko},bt:function(){return Sc},bu:function(){return Ba},bv:function(){return za},bw:function(){return dl},bx:function(){return Vu},by:function(){return Qa},bz:function(){return vl},c:function(){return Qi},d:function(){return Ur},e:function(){return ia},f:function(){return ra},g:function(){return $i},h:function(){return Ta},i:function(){return Ji},j:function(){return Yi},k:function(){return Aa},l:function(){return Ma},m:function(){return Oa},n:function(){return qi},o:function(){return sa},p:function(){return Za},q:function(){return Pa},r:function(){return Ki},s:function(){return Hr},t:function(){return Wi},u:function(){return Ia},v:function(){return no},w:function(){return ea},x:function(){return ro},y:function(){return Xi},z:function(){return $a}});var r,i,a,o,s,u,c,l,d,f,h,v,m,p,g,x,_,b,y,T,w,S,O,A,C,M,P,Z,E,L,R,I,F,N,D,k,z,B,V,G,U,H,W,q,j,X,Y,K,Q,$,J,ee,te,ne,re,ie,ae,oe,se,ue,ce,le,de,fe,he,ve,me,pe,ge,xe,_e,be,ye,Te,we,Se,Oe,Ae,Ce,Me,Pe,Ze,Ee,Le,Re,Ie,Fe,Ne,De,ke,ze,Be,Ve,Ge,Ue,He,We,qe,je,Xe,Ye,Ke,Qe,$e,Je,et,tt,nt,rt,it,at,ot,st,ut,ct,lt,dt,ft,ht,vt,mt,pt,gt,xt,_t,bt,yt,Tt,wt,St,Ot,At,Ct,Mt,Pt,Zt,Et,Lt,Rt,It,Ft,Nt,Dt,kt,zt,Bt,Vt,Gt,Ut,Ht,Wt,qt,jt,Xt,Yt,Kt,Qt,$t,Jt,en,tn,nn,rn,an,on,sn,un,cn,ln,dn,fn,hn,vn,mn,pn,gn,xn,_n,bn,yn,Tn,wn,Sn,On,An,Cn,Mn,Pn,Zn,En,Ln,Rn,In,Fn,Nn,Dn,kn,zn,Bn,Vn,Gn,Un,Hn,Wn,qn,jn,Xn,Yn,Kn,Qn,$n,Jn,er,tr,nr,rr,ir,ar,or,sr,ur,cr,lr,dr,fr,hr,vr,mr,pr,gr,xr,_r,br,yr,Tr,wr,Sr,Or,Ar,Cr,Mr,Pr,Zr,Er,Lr,Rr,Ir,Fr,Nr,Dr,kr,zr,Br,Vr,Gr,Ur,Hr,Wr=n(11752),qr=n(61120),jr=n(93433),Xr=n(1413),Yr=n(29439),Kr=n(74165),Qr=n(15861),$r=n(37762),Jr=n(60136),ei=n(29388),ti=n(4942),ni=n(30168),ri=n(43144),ii=n(15671),ai=n(20675),oi=n(93661),si=n(26313),ui=n(37077),ci=n(79557),li=n(49228),di=n(71802),fi=n(93209),hi=n(85026),vi=n(33973),mi=n(42233),pi=n(43066),gi=n(68136),xi=n(40558),_i=n(59389),bi=n(43955),yi=n(48848),Ti=n(70288),wi=n(95414),Si=n(57791),Oi=n(87750),Ai=n(64772),Ci=n(43345),Mi=n(37856),Pi=n(91681),Zi=n(29048),Ei=n(13239),Li=n(75255),Ri=n(93122),Ii=n(75833),Fi=n(31698),Ni=n(11448),Di=n(17332),ki=n(94777),zi=n(87424),Bi=n(20846),Vi=n(33795),Gi=n(10464),Ui=n(4937),Hi=n(27205),Wi=(0,ri.Z)((function e(){(0,ii.Z)(this,e)}));function qi(e){for(var t="",n=0;n<(arguments.length<=1?0:arguments.length-1);n++)t+=e[n]+(n+1<1||arguments.length<=n+1?void 0:arguments[n+1]);return t+=e[e.length-1]}function ji(e,t){switch(t.textureCoordinateType){case Ur.Default:return e.attributes.add(Ci.O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(qi(r||(r=(0,ni.Z)(["void forwardTextureCoordinates() {\nvuv0 = uv0;\n}"]))));case Ur.Compressed:return e.attributes.add(Ci.O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(qi(i||(i=(0,ni.Z)(["vec2 getUV0() {\nreturn uv0 / 16384.0;\n}\nvoid forwardTextureCoordinates() {\nvuv0 = getUV0();\n}"]))));case Ur.Atlas:return e.attributes.add(Ci.O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(Ci.O.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(qi(a||(a=(0,ni.Z)(["void forwardTextureCoordinates() {\nvuv0 = uv0;\nvuvRegion = uvRegion;\n}"]))));default:case Ur.None:return void e.vertex.code.add(qi(o||(o=(0,ni.Z)(["void forwardTextureCoordinates() {}"]))));case Ur.COUNT:return}}function Xi(e){e.code.add(qi(s||(s=(0,ni.Z)(["const float MAX_RGBA_FLOAT =\n255.0 / 256.0 +\n255.0 / 256.0 / 256.0 +\n255.0 / 256.0 / 256.0 / 256.0 +\n255.0 / 256.0 / 256.0 / 256.0 / 256.0;\nconst vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\nvec4 float2rgba(const float value) {\nfloat valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\nvec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\nconst float toU8AsFloat = 1.0 / 255.0;\nreturn fixedPointU8 * toU8AsFloat;\n}\nconst vec4 RGBA_2_FLOAT_FACTORS = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, RGBA_2_FLOAT_FACTORS);\n}"]))))}function Yi(e){e.include(Xi),e.code.add(qi(u||(u=(0,ni.Z)(["float linearDepthFromFloat(float depth, vec2 nearFar) {\nreturn -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);\n}\nfloat linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {\nreturn linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);\n}"]))))}!function(e){e.int=function(e){return Math.round(e).toString()},e.float=function(e){return e.toPrecision(8)}}(qi||(qi={})),function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.Compressed=3]="Compressed",e[e.COUNT=4]="COUNT"}(Ur||(Ur={})),function(e){e[e.Pass=0]="Pass",e[e.Draw=1]="Draw"}(Hr||(Hr={}));var Ki=function(){function e(t,n,r,i){var a,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,ii.Z)(this,e),this.name=t,this.type=n,this.arraySize=o,this.bind=(a={},(0,ti.Z)(a,Hr.Pass,null),(0,ti.Z)(a,Hr.Draw,null),a),(0,oi.r)(r)&&(0,oi.r)(i)&&(this.bind[r]=i)}return(0,ri.Z)(e,[{key:"equals",value:function(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}}]),e}(),Qi=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"vec3",Hr.Pass,(function(t,n,i){return t.setUniform3fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki),$i=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"float",Hr.Pass,(function(t,n,i){return t.setUniform1f(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function Ji(e){e.uniforms.add(new Qi("mainLightDirection",(function(e,t){return t.lighting.mainLight.direction})))}function ea(e){e.uniforms.add(new Qi("mainLightIntensity",(function(e,t){return t.lighting.mainLight.intensity})))}function ta(e,t){var n=e.fragment;Ji(n),ea(n),function(e,t){t.useLegacyTerrainShading?e.uniforms.add(new $i("lightingFixedFactor",(function(e,t){return t.lighting.noonFactor*(1-t.lighting.globalFactor)}))):e.constants.add("lightingFixedFactor","float",0)}(n,t),n.code.add(qi(c||(c=(0,ni.Z)(["vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {\nfloat dotVal = clamp(dot(normal_global, mainLightDirection), 0.0, 1.0);\ndotVal = mix(dotVal, 1.0, lightingFixedFactor);\nreturn mainLightIntensity * ((1.0 - shadowing) * dotVal);\n}"]))))}var na=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"vec2",Hr.Pass,(function(t,n,i){return t.setUniform2fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki),ra=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"vec4",Hr.Pass,(function(t,n,i){return t.setUniform4fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki),ia=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"mat4",Hr.Pass,(function(t,n,i){return t.setUniformMatrix4fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki),aa=yi.a.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder"),oa=function(){function e(){(0,ii.Z)(this,e),this._includedModules=new Map}return(0,ri.Z)(e,[{key:"include",value:function(e,t){if(this._includedModules.has(e)){var n=this._includedModules.get(e);if(n!==t){aa.error("Trying to include shader module multiple times with different sets of options.");for(var r=new Set,i=0,a=Object.keys(n);i<a.length;i++){var o=a[i];n[o]!==e[o]&&r.add(o)}for(var s=0,u=Object.keys(e);s<u.length;s++){var c=u[s];n[c]!==e[c]&&r.add(c)}r.forEach((function(t){return console.error("  ".concat(t,": current ").concat(n[t]," new ").concat(e[t]))}))}}else this._includedModules.set(e,t),e(this.builder,t)}}]),e}(),sa=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).vertex=new la,e.fragment=new la,e.attributes=new da,e.varyings=new fa,e.extensions=new ha,e.constants=new ma,e}return(0,ri.Z)(n,[{key:"fragmentUniforms",get:function(){return this.fragment.uniforms.entries}},{key:"builder",get:function(){return this}},{key:"generate",value:function(e){var t=this.extensions.generateSource(e),n=this.attributes.generateSource(e),r=this.varyings.generateSource(),i="vertex"===e?this.vertex:this.fragment,a=i.uniforms.generateSource(),o=i.code.generateSource(),s="vertex"===e?ga:pa,u=this.constants.generateSource().concat(i.constants.generateSource());return"\n".concat(t.join("\n"),"\n\n").concat(s,"\n\n").concat(u.join("\n"),"\n\n").concat(a.join("\n"),"\n\n").concat(n.join("\n"),"\n\n").concat(r.join("\n"),"\n\n").concat(o.join("\n"))}},{key:"generateBind",value:function(e,t){var n=new Map;this.vertex.uniforms.entries.forEach((function(t){var r=t.bind[e];(0,oi.r)(r)&&n.set(t.name,r)})),this.fragment.uniforms.entries.forEach((function(t){var r=t.bind[e];(0,oi.r)(r)&&n.set(t.name,r)}));var r=Array.from(n.values()),i=r.length;return function(e,n,a){for(var o=0;o<i;++o)r[o](t,e,n,a)}}}]),n}(oa),ua=function(){function e(){(0,ii.Z)(this,e),this._entries=new Map}return(0,ri.Z)(e,[{key:"add",value:function(e){if(!Array.isArray(e))return this._add(e);var t,n=(0,$r.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._add(r)}}catch(i){n.e(i)}finally{n.f()}}},{key:"get",value:function(e){return this._entries.get(e)}},{key:"_add",value:function(e){if((0,oi.t)(e))aa.error("Trying to add null Uniform from ".concat((new Error).stack,"."));else{if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new yi.s("Duplicate uniform name ".concat(e.name," for different uniform type"));this._entries.set(e.name,e)}}},{key:"generateSource",value:function(){return Array.from(this._entries.values()).map((function(e){return(0,oi.r)(e.arraySize)?"uniform ".concat(e.type," ").concat(e.name,"[").concat(e.arraySize,"];"):"uniform ".concat(e.type," ").concat(e.name,";")}))}},{key:"entries",get:function(){return Array.from(this._entries.values())}}]),e}(),ca=function(){function e(){(0,ii.Z)(this,e),this._entries=new Array}return(0,ri.Z)(e,[{key:"add",value:function(e){this._entries.push(e)}},{key:"generateSource",value:function(){return this._entries}}]),e}(),la=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).uniforms=new ua,e.code=new ca,e.constants=new ma,e}return(0,ri.Z)(n,[{key:"builder",get:function(){return this}}]),n}(oa),da=function(){function e(){(0,ii.Z)(this,e),this._entries=new Array}return(0,ri.Z)(e,[{key:"add",value:function(e,t){this._entries.push([e,t])}},{key:"generateSource",value:function(e){return"fragment"===e?[]:this._entries.map((function(e){return"attribute ".concat(e[1]," ").concat(e[0],";")}))}}]),e}(),fa=function(){function e(){(0,ii.Z)(this,e),this._entries=new Array}return(0,ri.Z)(e,[{key:"add",value:function(e,t){this._entries.push([e,t])}},{key:"generateSource",value:function(){return this._entries.map((function(e){return"varying ".concat(e[1]," ").concat(e[0],";")}))}}]),e}(),ha=function(){function e(){(0,ii.Z)(this,e),this._entries=new Set}return(0,ri.Z)(e,[{key:"add",value:function(e){this._entries.add(e)}},{key:"generateSource",value:function(t){var n="vertex"===t?e.ALLOWLIST_VERTEX:e.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((function(e){return n.includes(e)})).map((function(e){return"#extension ".concat(e," : enable")}))}}]),e}();ha.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],ha.ALLOWLIST_VERTEX=[];var va,ma=function(){function e(){(0,ii.Z)(this,e),this._entries=new Set}return(0,ri.Z)(e,[{key:"add",value:function(t,n,r){var i="ERROR_CONSTRUCTOR_STRING";switch(n){case"float":i=e._numberToFloatStr(r);break;case"int":i=e._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i="vec2(".concat(e._numberToFloatStr(r[0]),",                            ").concat(e._numberToFloatStr(r[1]),")");break;case"vec3":i="vec3(".concat(e._numberToFloatStr(r[0]),",                            ").concat(e._numberToFloatStr(r[1]),",                            ").concat(e._numberToFloatStr(r[2]),")");break;case"vec4":i="vec4(".concat(e._numberToFloatStr(r[0]),",                            ").concat(e._numberToFloatStr(r[1]),",                            ").concat(e._numberToFloatStr(r[2]),",                            ").concat(e._numberToFloatStr(r[3]),")");break;case"ivec2":i="ivec2(".concat(e._numberToIntStr(r[0]),",                             ").concat(e._numberToIntStr(r[1]),")");break;case"ivec3":i="ivec3(".concat(e._numberToIntStr(r[0]),",                             ").concat(e._numberToIntStr(r[1]),",                             ").concat(e._numberToIntStr(r[2]),")");break;case"ivec4":i="ivec4(".concat(e._numberToIntStr(r[0]),",                             ").concat(e._numberToIntStr(r[1]),",                             ").concat(e._numberToIntStr(r[2]),",                             ").concat(e._numberToIntStr(r[3]),")");break;case"mat2":case"mat3":case"mat4":i="".concat(n,"(").concat(Array.prototype.map.call(r,(function(t){return e._numberToFloatStr(t)})).join(", "),")")}return this._entries.add("const ".concat(n," ").concat(t," = ").concat(i,";")),this}},{key:"generateSource",value:function(){return Array.from(this._entries)}}],[{key:"_numberToIntStr",value:function(e){return e.toFixed(0)}},{key:"_numberToFloatStr",value:function(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}}]),e}(),pa="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif",ga="precision highp float;\nprecision highp sampler2D;",xa="Size",_a="InvSize";function ba(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e.hasWebGL2Context){var i=qi(l||(l=(0,ni.Z)(["vec2(textureSize(",", ","))"])),t,qi.int(r));return n?"(1.0 / "+i+")":i}return n?t+_a:t+xa}function ya(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(e.hasWebGL2Context)return qi(d||(d=(0,ni.Z)(["texelFetch(",", ivec2(","), ",")"])),t,n,qi.int(i));var a=qi(f||(f=(0,ni.Z)(["texture2D(",", "," * "])),t,n);return a+=r?qi(h||(h=(0,ni.Z)(["(","))"])),r):qi(v||(v=(0,ni.Z)(["",")"])),t+_a)}!function(e){e[e.None=0]="None",e[e.Size=1]="Size",e[e.InvSize=2]="InvSize"}(va||(va={}));var Ta=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"sampler2D",Hr.Pass,(function(t,n,i){return t.bindTexture(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function wa(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:va.None,r=[new Ta(e,t)];if(n&va.Size){var i=e+xa;r.push(new na(i,(function(e,n){var r=t(e,n);return(0,oi.r)(r)?(0,Zi.r)(Sa,r.descriptor.width,r.descriptor.height):Ei.f})))}if(n&va.InvSize){var a=e+_a;r.push(new na(a,(function(e,n){var r=t(e,n);return(0,oi.r)(r)?(0,Zi.r)(Sa,1/r.descriptor.width,1/r.descriptor.height):Ei.f})))}return r}var Sa=(0,Ei.n)(),Oa=function(){function e(t,n){(0,ii.Z)(this,e),this._module=t,this._loadModule=n}return(0,ri.Z)(e,[{key:"get",value:function(){return this._module}},{key:"reload",value:function(){var e=(0,Qr.Z)((0,Kr.Z)().mark((function e(){return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._loadModule();case 2:return this._module=e.sent,e.abrupt("return",this._module);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),Aa=function(){function e(t,n,r){(0,ii.Z)(this,e),this.release=r,this.initializeConfiguration(t,n),this._configuration=n.snapshot(),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t.rctx.capabilities)}return(0,ri.Z)(e,[{key:"destroy",value:function(){this._program=(0,oi.G)(this._program),this._pipeline=this._configuration=null}},{key:"reload",value:function(e){(0,oi.G)(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}},{key:"program",get:function(){return this._program}},{key:"compiled",get:function(){return this.program.isCompiled}},{key:"key",get:function(){return this._configuration.key}},{key:"configuration",get:function(){return this._configuration}},{key:"bindPipelineState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2?arguments[2]:void 0;e.setPipelineState(this.getPipelineState(t,n))}},{key:"ensureAttributeLocations",value:function(e){this.program.assertCompatibleVertexAttributeLocations(e)}},{key:"primitiveType",get:function(){return Ri.E.TRIANGLES}},{key:"getPipelineState",value:function(e,t){return this._pipeline}},{key:"initializeConfiguration",value:function(e,t){}}]),e}(),Ca=new Map([[Ci.O.POSITION,0],[Ci.O.NORMAL,1],[Ci.O.UV0,2],[Ci.O.COLOR,3],[Ci.O.SIZE,4],[Ci.O.TANGENT,4],[Ci.O.AUXPOS1,5],[Ci.O.SYMBOLCOLOR,5],[Ci.O.AUXPOS2,6],[Ci.O.FEATUREATTRIBUTE,6],[Ci.O.INSTANCEFEATUREATTRIBUTE,6],[Ci.O.INSTANCECOLOR,7],[Ci.O.OBJECTANDLAYERIDCOLOR,7],[Ci.O.OBJECTANDLAYERIDCOLOR_INSTANCED,7],[Ci.O.MODEL,8],[Ci.O.MODELNORMAL,12],[Ci.O.MODELORIGINHI,11],[Ci.O.MODELORIGINLO,15]]),Ma=function(){function e(t,n,r){(0,ii.Z)(this,e),this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new yi.a6({deallocator:null}),this._glProgram=t.programCache.acquire(n.generate("vertex"),n.generate("fragment"),r),this._glProgram.stop=function(){throw new Error("Wrapped _glProgram used directly")},this.bindPass=n.generateBind(Hr.Pass,this),this.bindDraw=n.generateBind(Hr.Draw,this),this._fragmentUniforms=(0,Ii.a)()?n.fragmentUniforms:null}return(0,ri.Z)(e,[{key:"dispose",value:function(){this._glProgram.dispose()}},{key:"glName",get:function(){return this._glProgram.glName}},{key:"isCompiled",get:function(){return this._glProgram.isCompiled}},{key:"setUniform1b",value:function(e,t){this._glProgram.setUniform1i(e,t?1:0)}},{key:"setUniform1i",value:function(e,t){this._glProgram.setUniform1i(e,t)}},{key:"setUniform1f",value:function(e,t){this._glProgram.setUniform1f(e,t)}},{key:"setUniform2fv",value:function(e,t){this._glProgram.setUniform2fv(e,t)}},{key:"setUniform3fv",value:function(e,t){this._glProgram.setUniform3fv(e,t)}},{key:"setUniform4fv",value:function(e,t){this._glProgram.setUniform4fv(e,t)}},{key:"setUniformMatrix3fv",value:function(e,t){this._glProgram.setUniformMatrix3fv(e,t)}},{key:"setUniformMatrix4fv",value:function(e,t){this._glProgram.setUniformMatrix4fv(e,t)}},{key:"setUniform1fv",value:function(e,t){this._glProgram.setUniform1fv(e,t)}},{key:"setUniform1iv",value:function(e,t){this._glProgram.setUniform1iv(e,t)}},{key:"setUniform2iv",value:function(e,t){this._glProgram.setUniform3iv(e,t)}},{key:"setUniform3iv",value:function(e,t){this._glProgram.setUniform3iv(e,t)}},{key:"setUniform4iv",value:function(e,t){this._glProgram.setUniform4iv(e,t)}},{key:"assertCompatibleVertexAttributeLocations",value:function(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}},{key:"stop",value:function(){this._textures.clear(),this._freeTextureUnits.clear()}},{key:"bindTexture",value:function(e,t){if((0,oi.t)(t)||null==t.glName){var n=this._textures.get(e);return n&&(this._context.bindTexture(null,n.unit),this._freeTextureUnit(n),this._textures.delete(e)),null}var r=this._textures.get(e);return null==r?(r=this._allocTextureUnit(t),this._textures.set(e,r)):r.texture=t,this._context.useProgram(this),this.setUniform1i(e,r.unit),this._context.bindTexture(t,r.unit),r.unit}},{key:"rebindTextures",value:function(){var e=this;this._context.useProgram(this),this._textures.forEach((function(t,n){e._context.bindTexture(t.texture,t.unit),e.setUniform1i(n,t.unit)})),(0,oi.r)(this._fragmentUniforms)&&this._fragmentUniforms.forEach((function(t){"sampler2D"!==t.type&&"samplerCube"!==t.type||e._textures.has(t.name)||console.error("Texture sampler ".concat(t.name," has no bound texture"))}))}},{key:"_allocTextureUnit",value:function(e){return{texture:e,unit:0===this._freeTextureUnits.length?this._textures.size:this._freeTextureUnits.pop()}}},{key:"_freeTextureUnit",value:function(e){this._freeTextureUnits.push(e.unit)}}]),e}(),Pa=function(){function e(){(0,ii.Z)(this,e),this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map((function(){return 0})):[],this._parameterNames||(this._parameterNames=[])}return(0,ri.Z)(e,[{key:"key",get:function(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}},{key:"snapshot",value:function(){var e,t=this._parameterNames,n={key:this.key},r=(0,$r.Z)(t);try{for(r.s();!(e=r.n()).done;){var i=e.value;n[i]=this[i]}}catch(a){r.e(a)}finally{r.f()}return n}}]),e}();function Za(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,n){var r;if(t._parameterNames=null!==(r=t._parameterNames)&&void 0!==r?r:[],t._parameterNames.push(n),null!=e.constValue)Object.defineProperty(t,n,{get:function(){return e.constValue}});else{for(var i,a=t._parameterNames.length-1,o=e.count||2,s=Math.ceil(Math.log2(o)),u=null!==(i=t._parameterBits)&&void 0!==i?i:[0],c=0;u[c]+s>16;)++c>=u.length&&u.push(0);t._parameterBits=u;var l=u[c],d=(1<<s)-1<<l;u[c]+=s,Object.defineProperty(t,n,{get:function(){return this[a]},set:function(e){if(this[a]!==e&&(this[a]=e,this._keyDirty=!0,this._parameterBits[c]=this._parameterBits[c]&~d|+e<<l&d,"number"!=typeof e&&"boolean"!=typeof e))throw"Configuration value for "+n+" must be boolean or number, got "+typeof e}})}}}var Ea=[new Ni.t(Ci.O.POSITION,2,Ri.C.FLOAT,0,8)],La=[new Ni.t(Ci.O.POSITION,2,Ri.C.FLOAT,0,16),new Ni.t(Ci.O.UV0,2,Ri.C.FLOAT,8,16)],Ra=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n)}(Fi.b);function Ia(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ea,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ca,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=null;return a=t===La?new Float32Array([r,r,0,0,i,r,1,0,r,i,0,1,i,i,1,1]):new Float32Array([r,r,i,r,r,i,i,i]),new Ra(e,n,{geometry:t},{geometry:Fi.E.createVertex(e,Ri.F.STATIC_DRAW,a)})}function Fa(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ea,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ca,r=new Float32Array([-1,-1,3,-1,-1,3]);return new Ra(e,n,{geometry:t},{geometry:Fi.E.createVertex(e,Ri.F.STATIC_DRAW,r)})}function Na(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;return new Ii.E(e,{target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,samplingMode:Ri.L.NEAREST,width:t,height:t})}function Da(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,r=new Uint8Array(n*n*4),i=0;i<r.length;i+=4)r[i+0]=255*t[0],r[i+1]=255*t[1],r[i+2]=255*t[2],r[i+3]=255*t[3];return new Ii.E(e,{target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,samplingMode:Ri.L.NEAREST,width:n,height:n},r)}function ka(e){return new Ii.E(e,{target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,samplingMode:Ri.L.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}function za(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(qi(m||(m=(0,ni.Z)(["#ifndef GL_EXT_shader_texture_lod\nfloat calcMipMapLevel(const vec2 ddx, const vec2 ddy) {\nfloat deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));\nreturn max(0.0, 0.5 * log2(deltaMaxSqr));\n}\n#endif\nvec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {\nvec2 atlasScale = atlasRegion.zw - atlasRegion.xy;\nvec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;\nfloat maxdUV = 0.125;\nvec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;\nvec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);\n#else\nvec2 dUVdxAuto = dFdx(uvAtlas);\nvec2 dUVdyAuto = dFdy(uvAtlas);\nfloat mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);\nfloat autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);\nreturn texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);\n#endif\n}"]))))}function Ba(e,t){switch(e.include(ji,t),e.fragment.code.add(qi(p||(p=(0,ni.Z)(["\n  struct TextureLookupParameter {\n    vec2 uv;\n    ","\n  } vtc;\n  "])),t.supportsTextureAtlas?"vec2 size;":"")),t.textureCoordinateType){case Ur.Default:case Ur.Compressed:return void e.fragment.code.add(qi(g||(g=(0,ni.Z)(["vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {\nreturn texture2D(texture, params.uv);\n}"]))));case Ur.Atlas:return e.include(za),void e.fragment.code.add(qi(x||(x=(0,ni.Z)(["vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {\nreturn textureAtlasLookup(texture, params.size, params.uv, vuvRegion);\n}"]))));default:case Ur.None:case Ur.COUNT:return}}var Va=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"vec3",Hr.Draw,(function(t,n,i,a){return t.setUniform3fv(e,r(n,i,a))}))}return(0,ri.Z)(n)}(Ki),Ga=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"vec2",Hr.Draw,(function(t,n,i,a){return t.setUniform2fv(e,r(n,i,a))}))}return(0,ri.Z)(n)}(Ki),Ua=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"sampler2D",Hr.Draw,(function(t,n,i){return t.bindTexture(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function Ha(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:va.None,r=[new Ua(e,t)];if(n&va.Size){var i=e+xa;r.push(new Ga(i,(function(e,n){var r=t(e,n);return(0,oi.r)(r)?(0,Zi.r)(qa,r.descriptor.width,r.descriptor.height):Ei.f})))}if(n&va.InvSize){var a=e+_a;r.push(new Ga(a,(function(e,n){var r=t(e,n);return(0,oi.r)(r)?(0,Zi.r)(qa,1/r.descriptor.width,1/r.descriptor.height):Ei.f})))}return r}var Wa,qa=(0,Ei.n)(),ja=function(){function e(t){(0,ii.Z)(this,e),this._material=t.material,this._techniqueRepository=t.techniqueRep,this._output=t.output}return(0,ri.Z)(e,[{key:"dispose",value:function(){this._techniqueRepository.release(this._technique)}},{key:"technique",get:function(){return this._technique}},{key:"_stippleTextureRepository",get:function(){return this._techniqueRepository.constructionContext.stippleTextureRepository}},{key:"ensureTechnique",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._output;return this._technique=this._techniqueRepository.releaseAndAcquire(e,this._material.getConfiguration(n,t),this._technique),this._technique}},{key:"ensureResources",value:function(e){return Si.O.LOADED}}]),e}(),Xa=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e){var r;return(0,ii.Z)(this,n),(r=t.call(this,e))._numLoading=0,r._disposed=!1,r._textureRepository=e.textureRep,r._textureId=e.textureId,r._acquire(e.textureId,(function(e){return r._texture=e})),r._acquire(e.normalTextureId,(function(e){return r._textureNormal=e})),r._acquire(e.emissiveTextureId,(function(e){return r._textureEmissive=e})),r._acquire(e.occlusionTextureId,(function(e){return r._textureOcclusion=e})),r._acquire(e.metallicRoughnessTextureId,(function(e){return r._textureMetallicRoughness=e})),r}return(0,ri.Z)(n,[{key:"dispose",value:function(){this._texture=(0,oi.F)(this._texture),this._textureNormal=(0,oi.F)(this._textureNormal),this._textureEmissive=(0,oi.F)(this._textureEmissive),this._textureOcclusion=(0,oi.F)(this._textureOcclusion),this._textureMetallicRoughness=(0,oi.F)(this._textureMetallicRoughness),this._disposed=!0}},{key:"ensureResources",value:function(e){return 0===this._numLoading?Si.O.LOADED:Si.O.LOADING}},{key:"textureBindParameters",get:function(){return new Ya((0,oi.r)(this._texture)?this._texture.glTexture:null,(0,oi.r)(this._textureNormal)?this._textureNormal.glTexture:null,(0,oi.r)(this._textureEmissive)?this._textureEmissive.glTexture:null,(0,oi.r)(this._textureOcclusion)?this._textureOcclusion.glTexture:null,(0,oi.r)(this._textureMetallicRoughness)?this._textureMetallicRoughness.glTexture:null)}},{key:"updateTexture",value:function(e){var t=this;((0,oi.t)(this._texture)||e!==this._texture.id)&&(this._texture=(0,oi.F)(this._texture),this._textureId=e,this._acquire(this._textureId,(function(e){return t._texture=e})))}},{key:"_acquire",value:function(e,t){var n=this;if((0,oi.t)(e))t(null);else{var r=this._textureRepository.acquire(e);if((0,yi.V)(r))return++this._numLoading,void r.then((function(e){if(n._disposed)return(0,oi.F)(e),void t(null);t(e)})).finally((function(){return--n._numLoading}));t(r)}}}]),n}(ja),Ya=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,ii.Z)(this,n),(e=t.call(this)).texture=r,e.textureNormal=i,e.textureEmissive=a,e.textureOcclusion=o,e.textureMetallicRoughness=s,e}return(0,ri.Z)(n)}(Wi),Ka=(0,zi.r)(0,.6,.2);function Qa(e,t){var n=e.fragment,r=t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;if(t.pbrMode===Wa.Normal&&r&&e.include(Ba,t),t.pbrMode!==Wa.Schematic)if(t.pbrMode!==Wa.Disabled){if(t.pbrMode===Wa.Normal){n.code.add(qi(_||(_=(0,ni.Z)(["vec3 mrr;\nvec3 emission;\nfloat occlusion;"]))));var i=t.supportsTextureAtlas?t.hasWebGL2Context?va.None:va.Size:va.None,a=t.pbrTextureBindType;t.hasMetallicRoughnessTexture&&(n.uniforms.add(a===Hr.Pass?wa("texMetallicRoughness",(function(e){return e.textureMetallicRoughness}),i):Ha("texMetallicRoughness",(function(e){return e.textureMetallicRoughness}),i)),n.code.add(qi(b||(b=(0,ni.Z)(["void applyMetallnessAndRoughness(TextureLookupParameter params) {\nvec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;\nmrr[0] *= metallicRoughness.b;\nmrr[1] *= metallicRoughness.g;\n}"]))))),t.hasEmissionTexture&&(n.uniforms.add(a===Hr.Pass?wa("texEmission",(function(e){return e.textureEmissive}),i):Ha("texEmission",(function(e){return e.textureEmissive}),i)),n.code.add(qi(y||(y=(0,ni.Z)(["void applyEmission(TextureLookupParameter params) {\nemission *= textureLookup(texEmission, params).rgb;\n}"]))))),t.hasOcclusionTexture?(n.uniforms.add(a===Hr.Pass?wa("texOcclusion",(function(e){return e.textureOcclusion}),i):Ha("texOcclusion",(function(e){return e.textureOcclusion}),i)),n.code.add(qi(T||(T=(0,ni.Z)(["void applyOcclusion(TextureLookupParameter params) {\nocclusion *= textureLookup(texOcclusion, params).r;\n}\nfloat getBakedOcclusion() {\nreturn occlusion;\n}"]))))):n.code.add(qi(w||(w=(0,ni.Z)(["float getBakedOcclusion() { return 1.0; }"])))),n.uniforms.add(a===Hr.Pass?[new Qi("emissionFactor",(function(e){return e.emissiveFactor})),new Qi("mrrFactors",(function(e){return e.mrrFactors}))]:[new Va("emissionFactor",(function(e){return e.emissiveFactor})),new Va("mrrFactors",(function(e){return e.mrrFactors}))]),n.code.add(qi(S||(S=(0,ni.Z)(["\n    void applyPBRFactors() {\n      mrr = mrrFactors;\n      emission = emissionFactor;\n      occlusion = 1.0;\n      ","\n      ","\n      ","\n      ","\n      ","\n      ","\n      ","\n    }\n  "])),r?qi(O||(O=(0,ni.Z)(["vtc.uv = vuv0;"]))):"",t.hasMetallicRoughnessTextureTransform?qi(A||(A=(0,ni.Z)(["vtc.uv = metallicRoughnessUV;"]))):"",t.hasMetallicRoughnessTexture?t.supportsTextureAtlas?qi(C||(C=(0,ni.Z)(["\n                vtc.size = ",";\n                applyMetallnessAndRoughness(vtc);"])),ba(t,"texMetallicRoughness")):qi(M||(M=(0,ni.Z)(["applyMetallnessAndRoughness(vtc);"]))):"",t.hasEmissiveTextureTransform?qi(P||(P=(0,ni.Z)(["vtc.uv = emissiveUV;"]))):"",t.hasEmissionTexture?t.supportsTextureAtlas?qi(Z||(Z=(0,ni.Z)(["\n                vtc.size = ",";\n                applyEmission(vtc);"])),ba(t,"texEmission")):qi(E||(E=(0,ni.Z)(["applyEmission(vtc);"]))):"",t.hasOcclusionTextureTransform?qi(L||(L=(0,ni.Z)(["vtc.uv = occlusionUV;"]))):"",t.hasOcclusionTexture?t.supportsTextureAtlas?qi(R||(R=(0,ni.Z)(["\n                vtc.size = ",";\n                applyOcclusion(vtc);"])),ba(t,"texOcclusion")):qi(I||(I=(0,ni.Z)(["applyOcclusion(vtc);"]))):""))}}else n.code.add(qi(F||(F=(0,ni.Z)(["float getBakedOcclusion() { return 1.0; }"]))));else n.code.add(qi(N||(N=(0,ni.Z)(["vec3 mrr = vec3(0.0, 0.6, 0.2);\nvec3 emission = vec3(0.0);\nfloat occlusion = 1.0;\nvoid applyPBRFactors() {}\nfloat getBakedOcclusion() { return 1.0; }"]))))}function $a(e,t){var n=e.fragment,r=void 0!==t.lightingSphericalHarmonicsOrder?t.lightingSphericalHarmonicsOrder:2;0===r?(n.uniforms.add(new Qi("lightingAmbientSH0",(function(e,t){return(0,di.o)(Ja,t.lighting.sh.r[0],t.lighting.sh.g[0],t.lighting.sh.b[0])}))),n.code.add(qi(D||(D=(0,ni.Z)(["vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {\nvec3 ambientLight = 0.282095 * lightingAmbientSH0;\nreturn ambientLight * (1.0 - ambientOcclusion);\n}"]))))):1===r?(n.uniforms.add([new ra("lightingAmbientSH_R",(function(e,t){return(0,di.C)(eo,t.lighting.sh.r[0],t.lighting.sh.r[1],t.lighting.sh.r[2],t.lighting.sh.r[3])})),new ra("lightingAmbientSH_G",(function(e,t){return(0,di.C)(eo,t.lighting.sh.g[0],t.lighting.sh.g[1],t.lighting.sh.g[2],t.lighting.sh.g[3])})),new ra("lightingAmbientSH_B",(function(e,t){return(0,di.C)(eo,t.lighting.sh.b[0],t.lighting.sh.b[1],t.lighting.sh.b[2],t.lighting.sh.b[3])}))]),n.code.add(qi(k||(k=(0,ni.Z)(["vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {\nvec4 sh0 = vec4(\n0.282095,\n0.488603 * normal.x,\n0.488603 * normal.z,\n0.488603 * normal.y\n);\nvec3 ambientLight = vec3(\ndot(lightingAmbientSH_R, sh0),\ndot(lightingAmbientSH_G, sh0),\ndot(lightingAmbientSH_B, sh0)\n);\nreturn ambientLight * (1.0 - ambientOcclusion);\n}"]))))):2===r&&(n.uniforms.add([new Qi("lightingAmbientSH0",(function(e,t){return(0,di.o)(Ja,t.lighting.sh.r[0],t.lighting.sh.g[0],t.lighting.sh.b[0])})),new ra("lightingAmbientSH_R1",(function(e,t){return(0,di.C)(eo,t.lighting.sh.r[1],t.lighting.sh.r[2],t.lighting.sh.r[3],t.lighting.sh.r[4])})),new ra("lightingAmbientSH_G1",(function(e,t){return(0,di.C)(eo,t.lighting.sh.g[1],t.lighting.sh.g[2],t.lighting.sh.g[3],t.lighting.sh.g[4])})),new ra("lightingAmbientSH_B1",(function(e,t){return(0,di.C)(eo,t.lighting.sh.b[1],t.lighting.sh.b[2],t.lighting.sh.b[3],t.lighting.sh.b[4])})),new ra("lightingAmbientSH_R2",(function(e,t){return(0,di.C)(eo,t.lighting.sh.r[5],t.lighting.sh.r[6],t.lighting.sh.r[7],t.lighting.sh.r[8])})),new ra("lightingAmbientSH_G2",(function(e,t){return(0,di.C)(eo,t.lighting.sh.g[5],t.lighting.sh.g[6],t.lighting.sh.g[7],t.lighting.sh.g[8])})),new ra("lightingAmbientSH_B2",(function(e,t){return(0,di.C)(eo,t.lighting.sh.b[5],t.lighting.sh.b[6],t.lighting.sh.b[7],t.lighting.sh.b[8])}))]),n.code.add(qi(z||(z=(0,ni.Z)(["vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {\nvec3 ambientLight = 0.282095 * lightingAmbientSH0;\nvec4 sh1 = vec4(\n0.488603 * normal.x,\n0.488603 * normal.z,\n0.488603 * normal.y,\n1.092548 * normal.x * normal.y\n);\nvec4 sh2 = vec4(\n1.092548 * normal.y * normal.z,\n0.315392 * (3.0 * normal.z * normal.z - 1.0),\n1.092548 * normal.x * normal.z,\n0.546274 * (normal.x * normal.x - normal.y * normal.y)\n);\nambientLight += vec3(\ndot(lightingAmbientSH_R1, sh1),\ndot(lightingAmbientSH_G1, sh1),\ndot(lightingAmbientSH_B1, sh1)\n);\nambientLight += vec3(\ndot(lightingAmbientSH_R2, sh2),\ndot(lightingAmbientSH_G2, sh2),\ndot(lightingAmbientSH_B2, sh2)\n);\nreturn ambientLight * (1.0 - ambientOcclusion);\n}"])))),t.pbrMode!==Wa.Normal&&t.pbrMode!==Wa.Schematic||n.code.add(qi(B||(B=(0,ni.Z)(["const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);\nvec3 calculateAmbientRadiance(float ambientOcclusion)\n{\nvec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;\nreturn ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;\n}"])))))}!function(e){e[e.Disabled=0]="Disabled",e[e.Normal=1]="Normal",e[e.Schematic=2]="Schematic",e[e.Water=3]="Water",e[e.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",e[e.COUNT=5]="COUNT"}(Wa||(Wa={}));var Ja=(0,di.n)(),eo=(0,Pi.n)();function to(e){e.vertex.code.add(qi(V||(V=(0,ni.Z)(["const float PI = 3.141592653589793;"])))),e.fragment.code.add(qi(G||(G=(0,ni.Z)(["const float PI = 3.141592653589793;\nconst float LIGHT_NORMALIZATION = 1.0 / PI;\nconst float INV_PI = 0.3183098861837907;\nconst float HALF_PI = 1.570796326794897;"]))))}var no=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"bool",Hr.Pass,(function(t,n,i){return t.setUniform1b(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function ro(e){e.code.add(qi(U||(U=(0,ni.Z)(["vec4 premultiplyAlpha(vec4 v) {\nreturn vec4(v.rgb * v.a, v.a);\n}\nvec3 rgb2hsv(vec3 c) {\nvec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nvec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);\nvec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);\nfloat d = q.x - min(q.w, q.y);\nfloat e = 1.0e-10;\nreturn vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);\n}\nvec3 hsv2rgb(vec3 c) {\nvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\nreturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nfloat rgb2v(vec3 c) {\nreturn max(c.x, max(c.y, c.z));\n}"]))))}function io(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.attributes.add(Ci.O.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(qi(H||(H=(0,ni.Z)(["\n    void main(void) {\n      gl_Position = vec4(position, 0.0, 1.0);\n      ","\n    }\n  "])),t?qi(W||(W=(0,ni.Z)(["uv = position * 0.5 + vec2(0.5);"]))):""))}var ao=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"mat3",Hr.Draw,(function(t,n,i){return t.setUniformMatrix3fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function oo(e,t){t.hasMultipassTerrain&&(e.fragment.include(Yi),e.fragment.uniforms.add(new Ta("terrainDepthTexture",(function(e,t){return t.multipassTerrain.linearDepthTexture}))),e.fragment.uniforms.add(new na("nearFar",(function(e,t){return t.camera.nearFar}))),e.fragment.uniforms.add(new na("inverseViewport",(function(e,t){return t.inverseViewport}))),e.fragment.code.add(qi(q||(q=(0,ni.Z)(["\n    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){\n      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);\n      if(fragmentDepth "," terrainDepth){\n        discard;\n      }\n    }\n  "])),t.cullAboveGround?">":"<=")))}var so,uo=(0,ri.Z)((function e(){(0,ii.Z)(this,e),this.enabled=!1,this.cullAboveGround=!1}));!function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.TRANSPARENT_MATERIAL=3]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_TERRAIN=4]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=5]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=6]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=7]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=8]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_ENVIRONMENT_OPAQUE=10]="POSTPROCESSING_ENVIRONMENT_OPAQUE",e[e.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=11]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",e[e.LASERLINES=12]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=13]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=14]="HUD_MATERIAL",e[e.LABEL_MATERIAL=15]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=16]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=18]="DRAPED_MATERIAL",e[e.DRAPED_WATER=19]="DRAPED_WATER",e[e.VOXEL=20]="VOXEL",e[e.MAX_SLOTS=21]="MAX_SLOTS"}(so||(so={}));var co=(0,ri.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,di.n)();(0,ii.Z)(this,e),this.intensity=t})),lo=(0,ri.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,di.n)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,di.c)(.57735,.57735,.57735);(0,ii.Z)(this,e),this.intensity=t,this.direction=n})),fo=(0,ri.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,di.n)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,di.c)(.57735,.57735,.57735),r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(0,ii.Z)(this,e),this.intensity=t,this.direction=n,this.castShadows=r,this.specularStrength=i,this.environmentStrength=a})),ho=(0,ri.Z)((function e(){(0,ii.Z)(this,e),this.r=[0],this.g=[0],this.b=[0]}));function vo(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]*t[r];return n}function mo(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]*t;return n}function po(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]+t[r];return n}function go(e){return(e+1)*(e+1)}function xo(e,t,n){var r=e[0],i=e[1],a=e[2],o=n||[];return o.length=go(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*i),t>=2&&(o[4]=1.09254843059*r*i,o[5]=1.09254843059*i*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-i*i)),o}function _o(e,t){var n,r=function(e){return(0,di.a)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length),i=(0,$r.Z)(e);try{for(i.s();!(n=i.n()).done;){var a=n.value;(0,di.q)(Co,a.direction),xo(Co,r,Oo),vo(Oo,Mo),mo(Oo,a.intensity[0],Ao),po(t.r,Ao),mo(Oo,a.intensity[1],Ao),po(t.g,Ao),mo(Oo,a.intensity[2],Ao),po(t.b,Ao)}}catch(o){i.e(o)}finally{i.f()}return t}function bo(e,t,n,r){(function(e,t){var n=go(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=n;for(var i=0;i<n;i++)r.r[i]=r.g[i]=r.b[i]=0})(t,r),(0,di.o)(n.intensity,0,0,0);var i=!1,a=To,o=wo,s=So;a.length=0,o.length=0,s.length=0;var u,c=(0,$r.Z)(e);try{for(c.s();!(u=c.n()).done;){var l=u.value;l instanceof fo&&!i?((0,di.r)(n.direction,l.direction),(0,di.r)(n.intensity,l.intensity),n.specularStrength=l.specularStrength,n.environmentStrength=l.environmentStrength,n.castShadows=l.castShadows,i=!0):l instanceof fo||l instanceof lo?a.push(l):l instanceof co?o.push(l):l instanceof ho&&s.push(l)}}catch(v){c.e(v)}finally{c.f()}_o(a,r),function(e,t){xo(Co,0,Oo);var n,r=(0,$r.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;t.r[0]+=Oo[0]*Mo[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Oo[0]*Mo[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Oo[0]*Mo[0]*i.intensity[2]*4*Math.PI}}catch(v){r.e(v)}finally{r.f()}}(o,r);var d,f=(0,$r.Z)(s);try{for(f.s();!(d=f.n()).done;){var h=d.value;po(r.r,h.r),po(r.g,h.g),po(r.b,h.b)}}catch(v){f.e(v)}finally{f.f()}}var yo,To=[],wo=[],So=[],Oo=[0],Ao=[0],Co=(0,di.n)(),Mo=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],Po=(0,ri.Z)((function e(){(0,ii.Z)(this,e),this.color=(0,di.n)(),this.intensity=1})),Zo=(0,ri.Z)((function e(){(0,ii.Z)(this,e),this.direction=(0,di.n)(),this.ambient=new Po,this.diffuse=new Po})),Eo=function(){function e(){(0,ii.Z)(this,e),this._shOrder=2,this._legacy=new Zo,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new ho,this._mainLight=new fo((0,di.n)(),(0,di.c)(1,0,0),!1)}return(0,ri.Z)(e,[{key:"legacy",get:function(){return this._legacy}},{key:"sh",get:function(){return this._sphericalHarmonics}},{key:"mainLight",get:function(){return this._mainLight}},{key:"set",value:function(e){bo(e,this._shOrder,this._mainLight,this._sphericalHarmonics),(0,di.r)(this._legacy.direction,this._mainLight.direction);var t=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,(0,di.g)(this._legacy.diffuse.color,this._mainLight.intensity,t),(0,di.r)(Lo,this._legacy.diffuse.color),(0,di.g)(Lo,Lo,.4*this.globalFactor),(0,di.u)(this._legacy.ambient.color,this._legacy.ambient.color,Lo)}},{key:"copyFrom",value:function(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),this._mainLight.direction=(0,di.t)(e.mainLight.direction),this._mainLight.intensity=(0,di.t)(e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}},{key:"lerpLighting",value:function(e,t,n){if((0,di.A)(this._mainLight.intensity,e.mainLight.intensity,t.mainLight.intensity,n),this._mainLight.environmentStrength=(0,di.Z)(e.mainLight.environmentStrength,t.mainLight.environmentStrength,n),this._mainLight.specularStrength=(0,di.Z)(e.mainLight.specularStrength,t.mainLight.specularStrength,n),(0,di.r)(this._mainLight.direction,t.mainLight.direction),this._mainLight.castShadows=t.mainLight.castShadows,this.globalFactor=(0,di.Z)(e.globalFactor,t.globalFactor,n),this.noonFactor=(0,di.Z)(e.noonFactor,t.noonFactor,n),e.sh.r.length===t.sh.r.length)for(var r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=(0,di.Z)(e.sh.r[r],t.sh.r[r],n),this._sphericalHarmonics.g[r]=(0,di.Z)(e.sh.g[r],t.sh.g[r],n),this._sphericalHarmonics.b[r]=(0,di.Z)(e.sh.b[r],t.sh.b[r],n);else for(var i=0;i<t.sh.r.length;i++)this._sphericalHarmonics.r[i]=t.sh.r[i],this._sphericalHarmonics.g[i]=t.sh.g[i],this._sphericalHarmonics.b[i]=t.sh.b[i]}}]),e}(),Lo=(0,di.n)(),Ro=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).hasWebGL2Context=!1,e}return(0,ri.Z)(n)}(Pa);function Io(e){e.attributes.add(Ci.O.POSITION,"vec3"),e.vertex.code.add(qi(j||(j=(0,ni.Z)(["vec3 positionModel() { return position; }"]))))}function Fo(e,t){var n=e.code;t.doublePrecisionRequiresObfuscation?n.add(qi(X||(X=(0,ni.Z)(["vec3 dpPlusFrc(vec3 a, vec3 b) {\nreturn mix(a, a + b, vec3(notEqual(b, vec3(0))));\n}\nvec3 dpMinusFrc(vec3 a, vec3 b) {\nreturn mix(vec3(0), a - b, vec3(notEqual(a, b)));\n}\nvec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\nvec3 t1 = dpPlusFrc(hiA, hiB);\nvec3 e = dpMinusFrc(t1, hiA);\nvec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;\nreturn t1 + t2;\n}"])))):n.add(qi(Y||(Y=(0,ni.Z)(["vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\nvec3 t1 = hiA + hiB;\nvec3 e = t1 - hiA;\nvec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;\nreturn t1 + t2;\n}"]))))}function No(e){return!!(0,oi.h)("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}(0,yi.e)([Za({constValue:!0})],Ro.prototype,"hasSliceHighlight",void 0),(0,yi.e)([Za({constValue:!1})],Ro.prototype,"hasSliceInVertexProgram",void 0),(0,yi.e)([Za({constValue:!1})],Ro.prototype,"instancedDoublePrecision",void 0),(0,yi.e)([Za({constValue:!1})],Ro.prototype,"useLegacyTerrainShading",void 0),(0,yi.e)([Za({constValue:!1})],Ro.prototype,"hasModelTransformation",void 0),(0,yi.e)([Za({constValue:Hr.Pass})],Ro.prototype,"pbrTextureBindType",void 0),(0,yi.e)([Za()],Ro.prototype,"hasWebGL2Context",void 0),function(e){e[e.Color=0]="Color",e[e.Depth=1]="Depth",e[e.Normal=2]="Normal",e[e.Shadow=3]="Shadow",e[e.ShadowHighlight=4]="ShadowHighlight",e[e.ShadowExludeHighlight=5]="ShadowExludeHighlight",e[e.Highlight=6]="Highlight",e[e.Alpha=7]="Alpha",e[e.ObjectAndLayerIdColor=8]="ObjectAndLayerIdColor",e[e.COUNT=9]="COUNT"}(yo||(yo={}));var Do=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"mat3",Hr.Pass,(function(t,n,i){return t.setUniformMatrix3fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function ko(e,t){e.include(Io);var n=e.vertex;n.include(Fo,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),n.uniforms.add([new Qi("transformWorldFromViewTH",(function(e){return e.transformWorldFromViewTH})),new Qi("transformWorldFromViewTL",(function(e){return e.transformWorldFromViewTL})),new Do("transformViewFromCameraRelativeRS",(function(e){return e.transformViewFromCameraRelativeRS})),new ia("transformProjFromView",(function(e){return e.transformProjFromView})),new ao("transformWorldFromModelRS",(function(e){return e.transformWorldFromModelRS})),new Va("transformWorldFromModelTH",(function(e){return e.transformWorldFromModelTH})),new Va("transformWorldFromModelTL",(function(e){return e.transformWorldFromModelTL}))]),n.code.add(qi(K||(K=(0,ni.Z)(["vec3 positionWorldCameraRelative() {\nvec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();\nvec3 transform_CameraRelativeFromModel = dpAdd(\ntransformWorldFromModelTL,\ntransformWorldFromModelTH,\n-transformWorldFromViewTL,\n-transformWorldFromViewTH\n);\nreturn transform_CameraRelativeFromModel + rotatedModelPosition;\n}"])))),n.code.add(qi(Q||(Q=(0,ni.Z)(["\n    void forwardPosition(float fOffset) {\n      vPositionWorldCameraRelative = positionWorldCameraRelative();\n      if (fOffset != 0.0) {\n        vPositionWorldCameraRelative += fOffset * ",";\n      }\n\n      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;\n      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);\n    }\n  "])),t.spherical?qi($||($=(0,ni.Z)(["normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)"]))):qi(J||(J=(0,ni.Z)(["vec3(0.0, 0.0, 1.0)"]))))),e.fragment.uniforms.add(new Qi("transformWorldFromViewTL",(function(e){return e.transformWorldFromViewTL}))),n.code.add(qi(ee||(ee=(0,ni.Z)(["vec3 positionWorld() {\nreturn transformWorldFromViewTL + vPositionWorldCameraRelative;\n}"])))),e.fragment.code.add(qi(te||(te=(0,ni.Z)(["vec3 positionWorld() {\nreturn transformWorldFromViewTL + vPositionWorldCameraRelative;\n}"]))))}var zo=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).transformWorldFromViewTH=(0,di.n)(),e.transformWorldFromViewTL=(0,di.n)(),e.transformViewFromCameraRelativeRS=(0,ui.e)(),e.transformProjFromView=(0,li.e)(),e}return(0,ri.Z)(n)}(Wi),Bo=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).transformWorldFromModelRS=(0,ui.e)(),e.transformWorldFromModelTH=(0,zi.n)(),e.transformWorldFromModelTL=(0,zi.n)(),e}return(0,ri.Z)(n)}(Wi);function Vo(e){e.varyings.add("linearDepth","float")}function Go(e){e.vertex.uniforms.add(new na("nearFar",(function(e,t){return t.camera.nearFar})))}function Uo(e){e.vertex.code.add(qi(ne||(ne=(0,ni.Z)(["float calculateLinearDepth(vec2 nearFar,float z) {\nreturn (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);\n}"]))))}function Ho(e,t){var n=e.vertex;switch(t.output){case yo.Color:if(t.receiveShadows)return Vo(e),void n.code.add(qi(re||(re=(0,ni.Z)(["void forwardLinearDepth() { linearDepth = gl_Position.w; }"]))));break;case yo.Depth:case yo.Shadow:case yo.ShadowHighlight:case yo.ShadowExludeHighlight:return e.include(ko,t),Vo(e),Go(e),Uo(e),void n.code.add(qi(ie||(ie=(0,ni.Z)(["void forwardLinearDepth() {\nlinearDepth = calculateLinearDepth(nearFar, vPosition_view.z);\n}"]))))}n.code.add(qi(ae||(ae=(0,ni.Z)(["void forwardLinearDepth() {}"]))))}function Wo(e,t){if(Uo(e),t.hasModelTransformation)return e.vertex.code.add(qi(oe||(oe=(0,ni.Z)(["vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {\nvec4 eye = view * (model * vec4(pos, 1.0));\ndepth = calculateLinearDepth(nearFar, eye.z);\nreturn proj * eye;\n}"])))),void e.vertex.code.add(qi(se||(se=(0,ni.Z)(["vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {\nreturn proj * (view * (model * vec4(pos, 1.0)));\n}"]))));e.vertex.code.add(qi(ue||(ue=(0,ni.Z)(["vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {\nvec4 eye = view * vec4(pos, 1.0);\ndepth = calculateLinearDepth(nearFar,eye.z);\nreturn proj * eye;\n}"])))),e.vertex.code.add(qi(ce||(ce=(0,ni.Z)(["vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {\nreturn proj * (view * vec4(pos, 1.0));\n}"]))))}var qo,jo=function(){function e(t,n,r,i){(0,ii.Z)(this,e),this.primitiveIndices=t,this._numIndexPerPrimitive=n,this.indices=r,this.position=i,this.center=(0,di.n)(),this._children=void 0,(0,Oi.e)(t.length>=1),(0,Oi.e)(r.length%this._numIndexPerPrimitive==0),(0,Oi.e)(r.length>=t.length*this._numIndexPerPrimitive),(0,Oi.e)(3===i.size||4===i.size);var a=i.data,o=i.size,s=t.length,u=o*r[this._numIndexPerPrimitive*t[0]];Xo.clear(),Xo.push(u),this.bbMin=(0,di.c)(a[u],a[u+1],a[u+2]),this.bbMax=(0,di.t)(this.bbMin);for(var c=0;c<s;++c)for(var l=this._numIndexPerPrimitive*t[c],d=0;d<this._numIndexPerPrimitive;++d){u=o*r[l+d],Xo.push(u);var f=a[u];this.bbMin[0]=Math.min(f,this.bbMin[0]),this.bbMax[0]=Math.max(f,this.bbMax[0]),f=a[u+1],this.bbMin[1]=Math.min(f,this.bbMin[1]),this.bbMax[1]=Math.max(f,this.bbMax[1]),f=a[u+2],this.bbMin[2]=Math.min(f,this.bbMin[2]),this.bbMax[2]=Math.max(f,this.bbMax[2])}(0,di.A)(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);for(var h=this.radius*this.radius,v=0;v<Xo.length;++v){var m=a[u=Xo.getItemAt(v)]-this.center[0],p=a[u+1]-this.center[1],g=a[u+2]-this.center[2],x=m*m+p*p+g*g;if(!(x<=h)){var _=Math.sqrt(x),b=.5*(_-this.radius);this.radius=this.radius+b,h=this.radius*this.radius;var y=b/_;this.center[0]+=m*y,this.center[1]+=p*y,this.center[2]+=g*y}}Xo.clear()}return(0,ri.Z)(e,[{key:"getCenter",value:function(){return this.center}},{key:"getBSRadius",value:function(){return this.radius}},{key:"getBBMin",value:function(){return this.bbMin}},{key:"getBBMax",value:function(){return this.bbMax}},{key:"getChildren",value:function(){if(this._children)return this._children;if((0,di.p)(this.bbMin,this.bbMax)>1){for(var t=(0,di.A)((0,di.n)(),this.bbMin,this.bbMax,.5),n=this.primitiveIndices.length,r=new Uint8Array(n),i=new Array(8),a=0;a<8;++a)i[a]=0;for(var o=this.position,s=o.data,u=o.size,c=0;c<n;++c){for(var l=0,d=this._numIndexPerPrimitive*this.primitiveIndices[c],f=u*this.indices[d],h=s[f],v=s[f+1],m=s[f+2],p=1;p<this._numIndexPerPrimitive;++p){var g=s[f=u*this.indices[d+p]],x=s[f+1],_=s[f+2];g<h&&(h=g),x<v&&(v=x),_<m&&(m=_)}h<t[0]&&(l|=1),v<t[1]&&(l|=2),m<t[2]&&(l|=4),r[c]=l,++i[l]}for(var b=0,y=0;y<8;++y)i[y]>0&&++b;if(b<2)return;for(var T=new Array(8),w=0;w<8;++w)T[w]=i[w]>0?new Uint32Array(i[w]):void 0;for(var S=0;S<8;++S)i[S]=0;for(var O=0;O<n;++O){var A=r[O];T[A][i[A]++]=this.primitiveIndices[O]}this._children=new Array(8);for(var C=0;C<8;++C)void 0!==T[C]&&(this._children[C]=new e(T[C],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}}],[{key:"prune",value:function(){Xo.prune()}}]),e}(),Xo=new yi.a6({deallocator:null}),Yo=function(){function e(){(0,ii.Z)(this,e),this.id=(0,yi.a4)()}return(0,ri.Z)(e,[{key:"unload",value:function(){}}]),e}();function Ko(e,t,n){var r=t[0]-e[0],i=t[1]-e[1],a=n[0]-e[0],o=n[1]-e[1];return.5*Math.abs(r*o-i*a)}function Qo(e,t,n){return(0,di.e)($o,t,e),(0,di.e)(Jo,n,e),(0,di.s)((0,di._)($o,$o,Jo))/2}!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"}(qo||(qo={})),new Ai.s(Oi.v),new Ai.s((function(){return function(e){return e?{p0:(0,di.t)(e.p0),p1:(0,di.t)(e.p1),p2:(0,di.t)(e.p2)}:{p0:(0,di.n)(),p1:(0,di.n)(),p2:(0,di.n)()}}()}));var $o=(0,di.n)(),Jo=(0,di.n)();function es(e,t,n){if(!e||!t)return!1;var r=e.size,i=e.data;(0,di.o)(n,0,0,0),(0,di.o)(os,0,0,0);for(var a=0,o=0,s=0;s<t.length-2;s+=3){var u=t[s+0]*r,c=t[s+1]*r,l=t[s+2]*r;(0,di.o)(rs,i[u+0],i[u+1],i[u+2]),(0,di.o)(is,i[c+0],i[c+1],i[c+2]),(0,di.o)(as,i[l+0],i[l+1],i[l+2]);var d=Qo(rs,is,as);d?((0,di.u)(rs,rs,is),(0,di.u)(rs,rs,as),(0,di.g)(rs,rs,1/3*d),(0,di.u)(n,n,rs),a+=d):((0,di.u)(os,os,rs),(0,di.u)(os,os,is),(0,di.u)(os,os,as),o+=3)}return(0!==o||0!==a)&&(0!==a?((0,di.g)(n,n,1/a),!0):0!==o&&((0,di.g)(n,os,1/o),!0))}function ts(e,t,n){if(!e||!t)return!1;var r=e.size,i=e.data;(0,di.o)(n,0,0,0);for(var a=-1,o=0,s=0;s<t.length;s++){var u=t[s]*r;a!==u&&(n[0]+=i[u+0],n[1]+=i[u+1],n[2]+=i[u+2],o++),a=u}return o>1&&(0,di.g)(n,n,1/o),o>0}function ns(e,t,n,r){if(!e)return!1;var i=e.size,a=e.data;(0,di.o)(r,0,0,0),(0,di.o)(os,0,0,0);for(var o=0,s=0,u=t?t.length-1:a.length/i-1,c=u+(n?2:0),l=0;l<c;l+=2){var d=l<u?l:u,f=l<u?l+1:0,h=(t?t[d]:d)*i,v=(t?t[f]:f)*i;rs[0]=a[h+0],rs[1]=a[h+1],rs[2]=a[h+2],is[0]=a[v+0],is[1]=a[v+1],is[2]=a[v+2],(0,di.g)(rs,(0,di.u)(rs,rs,is),.5);var m=(0,di.U)(rs,is);m>0?((0,di.u)(r,r,(0,di.g)(rs,rs,m)),o+=m):((0,di.u)(os,os,rs),s++)}return 0!==o?((0,di.g)(r,r,1/o),!0):0!==s&&((0,di.g)(r,os,1/s),!0)}var rs=(0,di.n)(),is=(0,di.n)(),as=(0,di.n)(),os=(0,di.n)(),ss=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Si.a.Triangle,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1;(0,ii.Z)(this,n),(r=t.call(this))._primitiveType=a,r.objectAndLayerIdColor=o,r.edgeIndicesLength=s,r.type=qo.Geometry,r._vertexAttributes=new Map,r._indices=new Map,r._boundingInfo=null;var u,c=(0,$r.Z)(e);try{for(c.s();!(u=c.n()).done;){var l=(0,Yr.Z)(u.value,2),d=l[0],f=l[1];f&&r._vertexAttributes.set(d,(0,Xr.Z)({},f))}}catch(w){c.e(w)}finally{c.f()}if(null==i||0===i.length){var h=us(r._vertexAttributes),v=(0,mi.u)(h);r.edgeIndicesLength=r.edgeIndicesLength<0?h:r.edgeIndicesLength;var m,p=(0,$r.Z)(r._vertexAttributes.keys());try{for(p.s();!(m=p.n()).done;){var g=m.value;r._indices.set(g,v)}}catch(w){p.e(w)}finally{p.f()}}else{var x,_=(0,$r.Z)(i);try{for(_.s();!(x=_.n()).done;){var b=(0,Yr.Z)(x.value,2),y=b[0],T=b[1];T&&(r._indices.set(y,(0,mi.a)(T)),y===Ci.O.POSITION&&(r.edgeIndicesLength=r.edgeIndicesLength<0?r._indices.get(y).length:r.edgeIndicesLength))}}catch(w){_.e(w)}finally{_.f()}}return r}return(0,ri.Z)(n,[{key:"cloneShallow",value:function(){var e=new n([],void 0,this._primitiveType,this.objectAndLayerIdColor,void 0),t=e._vertexAttributes,r=e._indices;return this._vertexAttributes.forEach((function(e,n){return t.set(n,e)})),this._indices.forEach((function(e,t){return r.set(t,e)})),e.screenToWorldRatio=this.screenToWorldRatio,e._boundingInfo=this._boundingInfo,e}},{key:"vertexAttributes",get:function(){return this._vertexAttributes}},{key:"getMutableAttribute",value:function(e){var t=this._vertexAttributes.get(e);return t&&!t.exclusive&&(t.data=Array.from(t.data),t.exclusive=!0),t}},{key:"indices",get:function(){return this._indices}},{key:"indexCount",get:function(){var e=this._indices.values().next().value;return e?e.length:0}},{key:"primitiveType",get:function(){return this._primitiveType}},{key:"faceCount",get:function(){return this.indexCount/3}},{key:"boundingInfo",get:function(){return(0,oi.t)(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}},{key:"computeAttachmentOrigin",value:function(e){return this.primitiveType===Si.a.Triangle?this._computeAttachmentOriginTriangles(e):this._computeAttachmentOriginPoints(e)}},{key:"_computeAttachmentOriginTriangles",value:function(e){var t=this.indices.get(Ci.O.POSITION);return es(this.vertexAttributes.get(Ci.O.POSITION),t,e)}},{key:"_computeAttachmentOriginPoints",value:function(e){var t=this.indices.get(Ci.O.POSITION);return ts(this.vertexAttributes.get(Ci.O.POSITION),t,e)}},{key:"invalidateBoundingInfo",value:function(){this._boundingInfo=null}},{key:"_calculateBoundingInfo",value:function(){var e=this.indices.get(Ci.O.POSITION);if(!e||0===e.length)return null;var t=this.primitiveType===Si.a.Triangle?3:1;(0,Oi.e)(e.length%t==0,"Indexing error: "+e.length+" not divisible by "+t);var n=(0,mi.u)(e.length/t),r=this.vertexAttributes.get(Ci.O.POSITION);return r?new jo(n,t,e,r):null}}]),n}(Yo);function us(e){var t=e.values().next().value;return null==t?0:t.data.length/t.size}function cs(e,t){return new ps(e,gs,t)}function ls(e,t){var n=gs.curvatureDependent,r=gs.scaleStart,i=gs.scaleFallOffRange;return new ps(e,{curvatureDependent:{min:{curvature:n.min.curvature,tiltAngle:n.min.tiltAngle,scaleFallOffFactor:xs.curvatureDependent.min.scaleFallOffFactor},max:{curvature:n.max.curvature,tiltAngle:n.max.tiltAngle,scaleFallOffFactor:xs.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:i,minPixelSize:xs.minPixelSize},t)}function ds(e,t,n){var r=n.parameters,i=n.paddingPixelsOverride;return _s.scale=Math.min(r.divisor/(t-r.offset),1),_s.factor=function(e){return Math.abs(e*e*e)}(e),_s.minPixelSize=r.minPixelSize,_s.paddingPixels=i,_s}function fs(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function hs(e,t){return Math.max((0,di.Z)(e*t.scale,e,t.factor),fs(e,t))}function vs(e,t,n,r){r.scale=function(e,t,n){var r=ds(e,t,n);return r.minPixelSize=0,r.paddingPixels=0,hs(1,r)}(e,t,n),r.factor=0,r.minPixelSize=n.parameters.minPixelSize,r.paddingPixels=n.paddingPixelsOverride}function ms(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0],r=Math.min(Math.max(t.scale,fs(e[1],t)/Math.max(1e-5,e[1])),1);return n[0]=e[0]*r,n[1]=e[1]*r,n}var ps=function(){function e(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0},a=arguments.length>4?arguments[4]:void 0;(0,ii.Z)(this,e),this._viewingMode=t,this._description=n,this._ellipsoidRadius=r,this.parameters=i,this._paddingPixelsOverride=a,this._viewingMode===Di.l.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}return(0,ri.Z)(e,[{key:"paddingPixelsOverride",get:function(){return this._paddingPixelsOverride||this.parameters.paddingPixels}},{key:"update",value:function(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}},{key:"overridePadding",value:function(t){return t!==this.paddingPixelsOverride?new e(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,t):this}},{key:"_calculateParameters",value:function(e,t,n){var r=this._description,i=r.scaleStart,a=r.scaleFallOffRange,o=r.minPixelSize,s=e.fovY,u=e.distance,c=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,c),d=c.tiltAngle,f=c.scaleFallOffFactor,h=Math.sin(d)*u,v=.5*Math.PI-d-s*(.5-i*l),m=h/Math.cos(v),p=v+s*a*l,g=(m-f*(h/Math.cos(p)))/(1-f);return n.camera.fovY=e.fovY,n.camera.distance=e.distance,n.offset=g,n.divisor=m-g,n.minPixelSize=o,n}},{key:"_calculateCurvatureDependentParametersLocal",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:bs;return n.tiltAngle=this._description.curvatureDependent.min.tiltAngle,n.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,n}},{key:"_calculateCurvatureDependentParametersGlobal",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:bs,r=this._description.curvatureDependent,i=1+e.distance/t,a=Math.sqrt(i*i-1),o=[r.min.curvature,r.max.curvature],s=o[0],u=o[1],c=(0,di.a)((a-s)/(u-s),0,1),l=[r.min,r.max],d=l[0],f=l[1];return n.tiltAngle=(0,di.Z)(d.tiltAngle,f.tiltAngle,c),n.scaleFallOffFactor=(0,di.Z)(d.scaleFallOffFactor,f.scaleFallOffFactor,c),n}},{key:"_surfaceCoverageCompensationLocal",value:function(e,t,n){return(e.fovY-n.tiltAngle)/e.fovY}},{key:"_surfaceCoverageCompensationGlobal",value:function(e,t,n){var r=t*t,i=n.tiltAngle+.5*Math.PI,a=e.fovY,o=e.distance,s=o*o+r-2*Math.cos(i)*o*t,u=Math.sqrt(s),c=Math.sqrt(s-r);return(Math.acos(c/u)-Math.asin(t/(u/Math.sin(i)))+.5*a)/a}}]),e}(),gs={curvatureDependent:{min:{curvature:(0,di.m)(10),tiltAngle:(0,di.m)(12),scaleFallOffFactor:.5},max:{curvature:(0,di.m)(70),tiltAngle:(0,di.m)(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},xs={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};var _s={scale:0,factor:0,minPixelSize:0,paddingPixels:0},bs={tiltAngle:0,scaleFallOffFactor:0};function ys(e){e.vertex.code.add(qi(le||(le=(0,ni.Z)(["float screenSizePerspectiveMinSize(float size, vec4 factor) {\nfloat nonZeroSize = 1.0 - step(size, 0.0);\nreturn (\nfactor.z * (\n1.0 +\nnonZeroSize *\n2.0 * factor.w / (\nsize + (1.0 - nonZeroSize)\n)\n)\n);\n}"])))),e.vertex.code.add(qi(de||(de=(0,ni.Z)(["float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {\nreturn absCosAngle * absCosAngle * absCosAngle;\n}"])))),e.vertex.code.add(qi(fe||(fe=(0,ni.Z)(["vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {\nreturn vec4(\nmin(params.x / (distanceToCamera - params.y), 1.0),\nscreenSizePerspectiveViewAngleDependentFactor(absCosAngle),\nparams.z,\nparams.w\n);\n}"])))),e.vertex.code.add(qi(he||(he=(0,ni.Z)(["float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {\nreturn max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));\n}"])))),e.vertex.code.add(qi(ve||(ve=(0,ni.Z)(["float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {\nreturn applyScreenSizePerspectiveScaleFactorFloat(\nsize,\nscreenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)\n);\n}"])))),e.vertex.code.add(qi(me||(me=(0,ni.Z)(["vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {\nreturn mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);\n}"])))),e.vertex.code.add(qi(pe||(pe=(0,ni.Z)(["vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {\nreturn applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));\n}"]))))}function Ts(e){e.uniforms.add(new ra("screenSizePerspective",(function(e){return Ss(e.screenSizePerspective)})))}function ws(e){e.uniforms.add(new ra("screenSizePerspectiveAlignment",(function(e){return Ss(e.screenSizePerspectiveAlignment||e.screenSizePerspective)})))}function Ss(e){return(0,di.C)(Os,e.parameters.divisor,e.parameters.offset,e.parameters.minPixelSize,e.paddingPixelsOverride)}var Os=(0,Pi.n)(),As=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"mat4",Hr.Draw,(function(t,n,i){return t.setUniformMatrix4fv(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function Cs(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",di.a7):e.uniforms.add(new Va("cameraPosition",(function(e,t){return(0,di.o)(Zs,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2])})))}function Ms(e,t){if(t.instancedDoublePrecision){var n=function(e){return(0,di.o)(Zs,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11])};e.uniforms.add([new ia("proj",(function(e,t){return t.camera.projectionMatrix})),new ia("view",(function(e,t){return(0,ci.c)(Ps,t.camera.viewMatrix,n(t))})),new Qi("localOrigin",(function(e,t){return n(t)}))])}else e.uniforms.add([new ia("proj",(function(e,t){return t.camera.projectionMatrix})),new As("view",(function(e,t){return(0,ci.c)(Ps,t.camera.viewMatrix,e.origin)})),new Va("localOrigin",(function(e){return e.origin}))])}var Ps=(0,Vi.e)(),Zs=(0,di.n)();function Es(e){e.uniforms.add(new ia("viewNormal",(function(e,t){return t.camera.viewInverseTransposeMatrix})))}function Ls(e,t){var n=e.vertex;t.hasVerticalOffset?(Is(n),t.hasScreenSizePerspective&&(e.include(ys),ws(n),Cs(e.vertex,t)),n.code.add(qi(ge||(ge=(0,ni.Z)(["\n      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {\n        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);\n        ","\n        ","\n        // Screen sized offset in world space, used for example for line callouts\n        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);\n        return worldNormal * worldOffset;\n      }\n\n      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {\n        return worldPos + calculateVerticalOffset(worldPos, localOrigin);\n      }\n    "])),t.spherical?qi(xe||(xe=(0,ni.Z)(["vec3 worldNormal = normalize(worldPos + localOrigin);"]))):qi(_e||(_e=(0,ni.Z)(["vec3 worldNormal = vec3(0.0, 0.0, 1.0);"]))),t.hasScreenSizePerspective?qi(be||(be=(0,ni.Z)(["\n            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));\n            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);"]))):qi(ye||(ye=(0,ni.Z)(["\n            float verticalOffsetScreenHeight = verticalOffset.x;"])))))):n.code.add(qi(Te||(Te=(0,ni.Z)(["vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }"]))))}var Rs=(0,Pi.n)();function Is(e){e.uniforms.add(new ra("verticalOffset",(function(e,t){var n=e.verticalOffset,r=n.minWorldLength,i=n.maxWorldLength,a=n.screenLength,o=Math.tan(.5*t.camera.fovY)/(.5*t.camera.fullViewport[3]),s=t.camera.pixelRatio||1;return(0,di.C)(Rs,a*s,o,r,i)})))}var Fs=(0,fi.a)();function Ns(e,t,n,r,i,a,o){if(!(0,Bi.a)(t))if(e.boundingInfo){(0,Oi.e)(e.primitiveType===Si.a.Triangle);var s=n.tolerance;ks(e.boundingInfo,r,i,s,a,o)}else{var u=e.indices.get(Ci.O.POSITION),c=e.vertexAttributes.get(Ci.O.POSITION);Bs(r,i,0,u.length/3,u,c,void 0,a,o)}}var Ds=(0,di.n)();function ks(e,t,n,r,i,a){if(!(0,oi.t)(e)){var o=Hs(t,n,Ds);if((0,fi.d)(Fs,e.getBBMin()),(0,fi.q)(Fs,e.getBBMax()),(0,oi.r)(i)&&i.applyToAabb(Fs),Ws(Fs,t,o,r)){var s=e.primitiveIndices,u=e.indices,c=e.position,l=s?s.length:u.length/3;if(l>eu){var d=e.getChildren();if(void 0!==d){for(var f=0;f<8;++f)void 0!==d[f]&&ks(d[f],t,n,r,i,a);return}}Bs(t,n,0,l,u,c,s,i,a)}}}var zs=(0,di.n)();function Bs(e,t,n,r,i,a,o,s,u){if(o)return function(e,t,n,r,i,a,o,s,u){for(var c=a.data,l=a.stride||a.size,d=e[0],f=e[1],h=e[2],v=t[0]-d,m=t[1]-f,p=t[2]-h,g=n;g<r;++g){var x,_,b,y,T,w,S=o[g],O=3*S,A=l*i[O++],C=c[A++],M=c[A++],P=c[A];A=l*i[O++];var Z=c[A++],E=c[A++],L=c[A];A=l*i[O];var R=c[A++],I=c[A++],F=c[A];(0,oi.r)(s)&&(x=s.applyToVertex(C,M,P,g),C=(_=(0,Yr.Z)(x,3))[0],M=_[1],P=_[2],b=s.applyToVertex(Z,E,L,g),Z=(y=(0,Yr.Z)(b,3))[0],E=y[1],L=y[2],T=s.applyToVertex(R,I,F,g),R=(w=(0,Yr.Z)(T,3))[0],I=w[1],F=w[2]);var N=Z-C,D=E-M,k=L-P,z=R-C,B=I-M,V=F-P,G=m*V-B*p,U=p*z-V*v,H=v*B-z*m,W=N*G+D*U+k*H;if(!(Math.abs(W)<=Number.EPSILON)){var q=d-C,j=f-M,X=h-P,Y=q*G+j*U+X*H;if(W>0){if(Y<0||Y>W)continue}else if(Y>0||Y<W)continue;var K=j*k-D*X,Q=X*N-k*q,$=q*D-N*j,J=v*K+m*Q+p*$;if(W>0){if(J<0||Y+J>W)continue}else if(J>0||Y+J<W)continue;var ee=(z*K+B*Q+V*$)/W;ee>=0&&u(ee,Us(N,D,k,z,B,V,zs),S,!1)}}}(e,t,n,r,i,a,o,s,u);for(var c=a.data,l=a.stride||a.size,d=e[0],f=e[1],h=e[2],v=t[0]-d,m=t[1]-f,p=t[2]-h,g=n,x=3*n;g<r;++g){var _,b,y,T,w,S,O=l*i[x++],A=c[O++],C=c[O++],M=c[O];O=l*i[x++];var P=c[O++],Z=c[O++],E=c[O];O=l*i[x++];var L=c[O++],R=c[O++],I=c[O];(0,oi.r)(s)&&(_=s.applyToVertex(A,C,M,g),A=(b=(0,Yr.Z)(_,3))[0],C=b[1],M=b[2],y=s.applyToVertex(P,Z,E,g),P=(T=(0,Yr.Z)(y,3))[0],Z=T[1],E=T[2],w=s.applyToVertex(L,R,I,g),L=(S=(0,Yr.Z)(w,3))[0],R=S[1],I=S[2]);var F=P-A,N=Z-C,D=E-M,k=L-A,z=R-C,B=I-M,V=m*B-z*p,G=p*k-B*v,U=v*z-k*m,H=F*V+N*G+D*U;if(!(Math.abs(H)<=Number.EPSILON)){var W=d-A,q=f-C,j=h-M,X=W*V+q*G+j*U;if(H>0){if(X<0||X>H)continue}else if(X>0||X<H)continue;var Y=q*D-N*j,K=j*F-D*W,Q=W*N-F*q,$=v*Y+m*K+p*Q;if(H>0){if($<0||X+$>H)continue}else if($>0||X+$<H)continue;var J=(k*Y+z*K+B*Q)/H;J>=0&&u(J,Us(F,N,D,k,z,B,zs),g,!1)}}}var Vs=(0,di.n)(),Gs=(0,di.n)();function Us(e,t,n,r,i,a,o){return(0,di.o)(Vs,e,t,n),(0,di.o)(Gs,r,i,a),(0,di._)(o,Vs,Gs),(0,di.z)(o,o),o}function Hs(e,t,n){return(0,di.o)(n,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function Ws(e,t,n,r){return qs(e,t,n,r,1/0)}function qs(e,t,n,r,i){var a=(e[0]-r-t[0])*n[0],o=(e[3]+r-t[0])*n[0],s=Math.min(a,o),u=Math.max(a,o),c=(e[1]-r-t[1])*n[1],l=(e[4]+r-t[1])*n[1];if((u=Math.min(u,Math.max(c,l)))<0)return!1;if((s=Math.max(s,Math.min(c,l)))>u)return!1;var d=(e[2]-r-t[2])*n[2],f=(e[5]+r-t[2])*n[2];return!((u=Math.min(u,Math.max(d,f)))<0)&&(!((s=Math.max(s,Math.min(d,f)))>u)&&s<i)}function js(e,t,n,r,i){var a=(n.screenLength||0)*e.pixelRatio;(0,oi.r)(i)&&(a=function(e,t,n,r){return hs(e,ds(t,n,r))}(a,r,t,i));var o=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return(0,di.a)(o*t,n.minWorldLength||0,null!=n.maxWorldLength?n.maxWorldLength:1/0)}function Xs(e,t){var n=t?Xs(t):{};for(var r in e){var i=e[r];i&&i.forEach&&(i=Qs(i)),null==i&&r in n||(n[r]=i)}return n}function Ys(e,t){var n=!1;for(var r in t){var i=t[r];void 0!==i&&(Array.isArray(i)?null===e[r]?(e[r]=i.slice(),n=!0):(0,oi.Q)(e[r],i)&&(n=!0):e[r]!==i&&(n=!0,e[r]=i))}return n}function Ks(e,t,n,r,i,a){if(t.options.selectionMode){for(var o=e.vertexAttributes.get(Ci.O.POSITION).data,s=e.vertexAttributes.get(Ci.O.SIZE),u=s&&s.data[0],c=r[0],l=r[1],d=((u+i)/2+4)*e.screenToWorldRatio,f=Number.MAX_VALUE,h=0,v=0;v<o.length-5;v+=3){var m=o[v],p=o[v+1],g=c-m,x=l-p,_=o[v+3]-m,b=o[v+4]-p,y=(0,di.a)((_*g+b*x)/(_*_+b*b),0,1),T=_*y-g,w=b*y-x,S=T*T+w*w;S<f&&(f=S,h=v/3)}f<d*d&&a(n.dist,n.normal,h,!1)}}function Qs(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}var $s,Js={multiply:1,ignore:2,replace:3,tint:4},eu=1e3,tu=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){var i;return(0,ii.Z)(this,n),(i=t.call(this)).type=qo.Material,i.supportsEdges=!1,i._visible=!0,i._renderPriority=0,i._insertOrder=0,i._vertexAttributeLocations=Ca,i._parameters=Xs(e,r),i.validateParameters(i._parameters),i}return(0,ri.Z)(n,[{key:"dispose",value:function(){}},{key:"parameters",get:function(){return this._parameters}},{key:"update",value:function(e){return!1}},{key:"setParameters",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Ys(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this.parametersChanged())}},{key:"validateParameters",value:function(e){}},{key:"visible",get:function(){return this._visible},set:function(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}},{key:"shouldRender",value:function(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&0!=(this.renderOccluded&e.renderOccludedMask)}},{key:"isVisibleForOutput",value:function(e){return!0}},{key:"renderOccluded",get:function(){return this.parameters.renderOccluded}},{key:"renderPriority",get:function(){return this._renderPriority},set:function(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}},{key:"insertOrder",get:function(){return this._insertOrder},set:function(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}},{key:"vertexAttributeLocations",get:function(){return this._vertexAttributeLocations}},{key:"isVisible",value:function(){return this._visible}},{key:"parametersChanged",value:function(){(0,oi.r)(this.repository)&&this.repository.materialChanged(this)}}]),n}(Yo);!function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}($s||($s={}));var nu=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).renderOccluded=$s.Occlude,e}return(0,ri.Z)(n)}(Wi);function ru(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=n.typedBuffer,o=n.typedBufferStride,s=e.length;if(r*=o,1===i)for(var u=0;u<s;++u)a[r]=t[e[u]],r+=o;else for(var c=0;c<s;++c)for(var l=t[e[c]],d=0;d<i;d++)a[r]=l,r+=o}function iu(e,t,n,r){var i=n.typedBuffer,a=n.typedBufferStride,o=e.length;r*=a;for(var s=0;s<o;++s){var u=2*e[s];i[r]=t[u],i[r+1]=t[u+1],r+=a}}function au(e,t,n,r,i){var a=n.typedBuffer,o=n.typedBufferStride,s=e.length;if(r*=o,null==i||1===i)for(var u=0;u<s;++u){var c=3*e[u];a[r]=t[c],a[r+1]=t[c+1],a[r+2]=t[c+2],r+=o}else for(var l=0;l<s;++l)for(var d=3*e[l],f=0;f<i;++f)a[r]=t[d],a[r+1]=t[d+1],a[r+2]=t[d+2],r+=o}function ou(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=n.typedBuffer,o=n.typedBufferStride,s=e.length;if(r*=o,1===i)for(var u=0;u<s;++u){var c=4*e[u];a[r]=t[c],a[r+1]=t[c+1],a[r+2]=t[c+2],a[r+3]=t[c+3],r+=o}else for(var l=0;l<s;++l)for(var d=4*e[l],f=0;f<i;++f)a[r]=t[d],a[r+1]=t[d+1],a[r+2]=t[d+2],a[r+3]=t[d+3],r+=o}function su(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(n){var o=r.typedBuffer,s=r.typedBufferStride,u=e.length,c=n[0],l=n[1],d=n[2],f=n[4],h=n[5],v=n[6],m=n[8],p=n[9],g=n[10],x=n[12],_=n[13],b=n[14];i*=s;var y=0,T=0,w=0,S=hu(n)?function(e){y=t[e]+x,T=t[e+1]+_,w=t[e+2]+b}:function(e){var n=t[e],r=t[e+1],i=t[e+2];y=c*n+f*r+m*i+x,T=l*n+h*r+p*i+_,w=d*n+v*r+g*i+b};if(1===a)for(var O=0;O<u;++O)S(3*e[O]),o[i]=y,o[i+1]=T,o[i+2]=w,i+=s;else for(var A=0;A<u;++A){S(3*e[A]);for(var C=0;C<a;++C)o[i]=y,o[i+1]=T,o[i+2]=w,i+=s}}else au(e,t,r,i,a)}function uu(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(n){var o=n,s=r.typedBuffer,u=r.typedBufferStride,c=e.length,l=o[0],d=o[1],f=o[2],h=o[4],v=o[5],m=o[6],p=o[8],g=o[9],x=o[10],_=!(0,ci.G)(o),b=1e-6,y=1-b;i*=u;var T=0,w=0,S=0,O=hu(o)?function(e){T=t[e],w=t[e+1],S=t[e+2]}:function(e){var n=t[e],r=t[e+1],i=t[e+2];T=l*n+h*r+p*i,w=d*n+v*r+g*i,S=f*n+m*r+x*i};if(1===a)if(_)for(var A=0;A<c;++A){O(3*e[A]);var C=T*T+w*w+S*S;if(C<y&&C>b){var M=1/Math.sqrt(C);s[i]=T*M,s[i+1]=w*M,s[i+2]=S*M}else s[i]=T,s[i+1]=w,s[i+2]=S;i+=u}else for(var P=0;P<c;++P)O(3*e[P]),s[i]=T,s[i+1]=w,s[i+2]=S,i+=u;else for(var Z=0;Z<c;++Z){if(O(3*e[Z]),_){var E=T*T+w*w+S*S;if(E<y&&E>b){var L=1/Math.sqrt(E);T*=L,w*=L,S*=L}}for(var R=0;R<a;++R)s[i]=T,s[i+1]=w,s[i+2]=S,i+=u}}else au(e,t,r,i,a)}function cu(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(n){var o=n,s=r.typedBuffer,u=r.typedBufferStride,c=e.length,l=o[0],d=o[1],f=o[2],h=o[4],v=o[5],m=o[6],p=o[8],g=o[9],x=o[10],_=!(0,ci.G)(o),b=1e-6,y=1-b;if(i*=u,1===a)for(var T=0;T<c;++T){var w=4*e[T],S=t[w],O=t[w+1],A=t[w+2],C=t[w+3],M=l*S+h*O+p*A,P=d*S+v*O+g*A,Z=f*S+m*O+x*A;if(_){var E=M*M+P*P+Z*Z;if(E<y&&E>b){var L=1/Math.sqrt(E);M*=L,P*=L,Z*=L}}s[i]=M,s[i+1]=P,s[i+2]=Z,s[i+3]=C,i+=u}else for(var R=0;R<c;++R){var I=4*e[R],F=t[I],N=t[I+1],D=t[I+2],k=t[I+3],z=l*F+h*N+p*D,B=d*F+v*N+g*D,V=f*F+m*N+x*D;if(_){var G=z*z+B*B+V*V;if(G<y&&G>b){var U=1/Math.sqrt(G);z*=U,B*=U,V*=U}}for(var H=0;H<a;++H)s[i]=z,s[i+1]=B,s[i+2]=V,s[i+3]=k,i+=u}}else ou(e,t,r,i,a)}function lu(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=r.typedBuffer,s=r.typedBufferStride,u=e.length;if(i*=s,n!==t.length||4!==n)if(1!==a)if(4!==n)for(var c=0;c<u;++c)for(var l=3*e[c],d=0;d<a;++d)o[i]=t[l],o[i+1]=t[l+1],o[i+2]=t[l+2],o[i+3]=255,i+=s;else for(var f=0;f<u;++f)for(var h=4*e[f],v=0;v<a;++v)o[i]=t[h],o[i+1]=t[h+1],o[i+2]=t[h+2],o[i+3]=t[h+3],i+=s;else{if(4===n){for(var m=0;m<u;++m){var p=4*e[m];o[i]=t[p],o[i+1]=t[p+1],o[i+2]=t[p+2],o[i+3]=t[p+3],i+=s}return}for(var g=0;g<u;++g){var x=3*e[g];o[i]=t[x],o[i+1]=t[x+1],o[i+2]=t[x+2],o[i+3]=255,i+=s}}else{o[i]=t[0],o[i+1]=t[1],o[i+2]=t[2],o[i+3]=t[3];var _=new Uint32Array(r.typedBuffer.buffer,r.start),b=s/4,y=_[i/=4];i+=b;for(var T=u*a,w=1;w<T;++w)_[i]=y,i+=b}}function du(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=t.typedBuffer,o=t.typedBufferStride;if(r*=o,1===i)for(var s=0;s<n;++s)a[r]=e[0],a[r+1]=e[1],a[r+2]=e[2],a[r+3]=e[3],r+=o;else for(var u=0;u<n;++u)for(var c=0;c<i;++c)a[r]=e[0],a[r+1]=e[1],a[r+2]=e[2],a[r+3]=e[3],r+=o}function fu(e,t,n,r,i,a){var o,s=(0,$r.Z)(t.fieldNames);try{for(s.s();!(o=s.n()).done;){var u=o.value,c=e.vertexAttributes.get(u),l=e.indices.get(u);if(c&&l)switch(u){case Ci.O.POSITION:(0,Oi.e)(3===c.size);var d=i.getField(u,hi.i);d&&su(l,c.data,n,d,a);break;case Ci.O.NORMAL:(0,Oi.e)(3===c.size);var f=i.getField(u,hi.i);f&&uu(l,c.data,r,f,a);break;case Ci.O.UV0:(0,Oi.e)(2===c.size);var h=i.getField(u,hi.u);h&&iu(l,c.data,h,a);break;case Ci.O.COLOR:(0,Oi.e)(3===c.size||4===c.size);var v=i.getField(u,hi.x);v&&lu(l,c.data,c.size,v,a);break;case Ci.O.SYMBOLCOLOR:(0,Oi.e)(3===c.size||4===c.size);var m=i.getField(u,hi.x);m&&lu(l,c.data,c.size,m,a);break;case Ci.O.TANGENT:(0,Oi.e)(4===c.size);var p=i.getField(u,hi.c);p&&cu(l,c.data,r,p,a)}else if(u===Ci.O.OBJECTANDLAYERIDCOLOR&&(0,oi.r)(e.objectAndLayerIdColor)&&4===e.objectAndLayerIdColor.length){var g=e.indices.get(Ci.O.POSITION);if(g){var x=g.length,_=i.getField(u,hi.x);du(e.objectAndLayerIdColor,_,x,a)}}}}catch(b){s.e(b)}finally{s.f()}}function hu(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[8]&&0===e[9]&&1===e[10]}var vu=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).color=(0,Pi.r)(1,1,1,1),e}return(0,ri.Z)(n)}(Wi);function mu(){var e=new sa;return e.include(io),e.fragment.uniforms.add([new Ta("tex",(function(e){return e.texture})),new ra("uColor",(function(e){return e.color}))]),e.fragment.code.add(qi(we||(we=(0,ni.Z)(["void main() {\nvec4 texColor = texture2D(tex, uv);\ngl_FragColor = texColor * uColor;\n}"])))),e}var pu,gu,xu=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:vu,build:mu},Symbol.toStringTag,{value:"Module"}));function _u(){if((0,oi.t)(pu)){var e=function(e){return(0,Li.a)("esri/libs/basisu/".concat(e))};pu=n.e(7285).then(n.bind(n,87285)).then((function(e){return e.b})).then((function(t){return(0,t.default)({locateFile:e}).then((function(e){return e.initializeBasis(),delete e.then,e}))}))}return pu}!function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"}(gu||(gu={}));var bu=null,yu=null;function Tu(){return wu.apply(this,arguments)}function wu(){return(wu=(0,Qr.Z)((0,Kr.Z)().mark((function e(){return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,oi.t)(yu),!e.t0){e.next=6;break}return yu=_u(),e.next=5,yu;case 5:bu=e.sent;case 6:return e.abrupt("return",yu);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Su(e,t,n,r,i){var a=(0,Fi._)(t?Ri.u.COMPRESSED_RGBA8_ETC2_EAC:Ri.u.COMPRESSED_RGB8_ETC2),o=i&&e>1?(Math.pow(4,e)-1)/(3*Math.pow(4,e-1)):1;return Math.ceil(n*r*a*o)}function Ou(e){return e.getNumImages()>=1&&!e.isUASTC()}function Au(e){return e.getFaces()>=1&&e.isETC1S()}function Cu(){return Cu=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n,r){var i,a;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,oi.t)(bu),!e.t0){e.next=5;break}return e.next=4,Tu();case 4:bu=e.sent;case 5:if(Ou(i=new bu.BasisFile(new Uint8Array(r)))){e.next=8;break}return e.abrupt("return",null);case 8:return i.startTranscoding(),a=Pu(t,n,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(function(e,t){return i.getImageTranscodedSizeInBytes(0,e,t)}),(function(e,t,n){return i.transcodeImage(n,0,e,t,0,0)})),e.abrupt("return",(i.close(),i.delete(),a));case 11:case"end":return e.stop()}}),e)}))),Cu.apply(this,arguments)}function Mu(){return Mu=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n,r){var i,a;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,oi.t)(bu),!e.t0){e.next=5;break}return e.next=4,Tu();case 4:bu=e.sent;case 5:if(Au(i=new bu.KTX2File(new Uint8Array(r)))){e.next=8;break}return e.abrupt("return",null);case 8:return i.startTranscoding(),a=Pu(t,n,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(function(e,t){return i.getImageTranscodedSizeInBytes(e,0,0,t)}),(function(e,t,n){return i.transcodeImage(n,e,0,0,t,0,-1,-1)})),e.abrupt("return",(i.close(),i.delete(),a));case 11:case"end":return e.stop()}}),e)}))),Mu.apply(this,arguments)}function Pu(e,t,n,r,i,a,o,s){for(var u=e.capabilities,c=u.compressedTextureETC,l=u.compressedTextureS3TC,d=c?r?[gu.ETC2_RGBA,Ri.u.COMPRESSED_RGBA8_ETC2_EAC]:[gu.ETC1_RGB,Ri.u.COMPRESSED_RGB8_ETC2]:l?r?[gu.BC3_RGBA,Ri.u.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[gu.BC1_RGB,Ri.u.COMPRESSED_RGB_S3TC_DXT1_EXT]:[gu.RGBA32,Ri.P.RGBA],f=(0,Yr.Z)(d,2),h=f[0],v=f[1],m=t.hasMipmap?n:Math.min(1,n),p=[],g=0;g<m;g++)p.push(new Uint8Array(o(g,h))),s(g,h,p[g]);var x=p.length>1,_=x?Ri.L.LINEAR_MIPMAP_LINEAR:Ri.L.LINEAR,b=(0,Xr.Z)((0,Xr.Z)({},t),{},{samplingMode:_,hasMipmap:x,internalFormat:v,width:i,height:a});return new Ii.E(e,b,{type:"compressed",levels:p})}var Zu=yi.a.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Eu=542327876,Lu=131072;function Ru(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var Iu=Ru("DXT1"),Fu=Ru("DXT3"),Nu=Ru("DXT5");function Du(e,t,n){var r,i=(0,oi.i)(function(e,t){var n=new Int32Array(e,0,31);if(n[0]!==Eu)return Zu.error("Invalid magic number in DDS header"),null;if(!(4&n[20]))return Zu.error("Unsupported format, must contain a FourCC code"),null;var r,i,a=n[21];switch(a){case Iu:r=8,i=Ri.u.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Fu:r=16,i=Ri.u.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Nu:r=16,i=Ri.u.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Zu.error("Unsupported FourCC code:",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(a)),null}var o=1,s=n[4],u=n[3];0==(3&s)&&0==(3&u)||(Zu.warn("Rounding up compressed texture size to nearest multiple of 4."),s=s+3&-4,u=u+3&-4);var c,l,d=s,f=u;n[2]&Lu&&!1!==t&&(o=Math.max(1,n[7])),1===o||(0,di.ad)(s)&&(0,di.ad)(u)||(Zu.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);for(var h=n[1]+4,v=[],m=0;m<o;++m)l=(s+3>>2)*(u+3>>2)*r,c=new Uint8Array(e,h,l),v.push(c),h+=l,s=Math.max(1,s>>1),u=Math.max(1,u>>1);return{textureData:{type:"compressed",levels:v},internalFormat:i,width:d,height:f}}(n,null!==(r=t.hasMipmap)&&void 0!==r&&r)),a=i.textureData,o=i.internalFormat,s=i.width,u=i.height;return t.samplingMode=a.levels.length>1?Ri.L.LINEAR_MIPMAP_LINEAR:Ri.L.LINEAR,t.hasMipmap=a.levels.length>1,t.internalFormat=o,t.width=s,t.height=u,new Ii.E(e,t,a)}var ku,zu=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){var i;return(0,ii.Z)(this,n),(i=t.call(this))._data=e,i.type=qo.Texture,i._glTexture=null,i._powerOfTwoStretchInfo=null,i._loadingPromise=null,i._loadingController=null,i.events=new Mi.n,i._passParameters=new vu,i.params=r||{},i.params.mipmap=!1!==i.params.mipmap,i.params.noUnpackFlip=i.params.noUnpackFlip||!1,i.params.preMultiplyAlpha=i.params.preMultiplyAlpha||!1,i.params.wrap=i.params.wrap||{s:Ri.D.REPEAT,t:Ri.D.REPEAT},i.params.powerOfTwoResizeMode=i.params.powerOfTwoResizeMode||Si.h.STRETCH,i.estimatedTexMemRequired=n._estimateTexMemRequired(i._data,i.params),i._startPreload(),i}return(0,ri.Z)(n,[{key:"_startPreload",value:function(){var e=this._data;(0,oi.t)(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}},{key:"_startPreloadVideoElement",value:function(e){if(!((0,xi.V)(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";var t=!e.paused;if(e.src=e.src,t&&e.autoplay){e.addEventListener("canplay",(function t(){e.removeEventListener("canplay",t),e.play()}))}}}},{key:"_startPreloadImageElement",value:function(e){(0,xi.X)(e.src)||(0,xi.V)(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}},{key:"dispose",value:function(){this._data=void 0}},{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"_createDescriptor",value:function(e){var t;return{target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?Ri.L.LINEAR_MIPMAP_LINEAR:Ri.L.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!==(t=this.params.maxAnisotropy)&&void 0!==t?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}},{key:"glTexture",get:function(){return this._glTexture}},{key:"load",value:function(e,t){if((0,oi.r)(this._glTexture))return this._glTexture;if((0,oi.r)(this._loadingPromise))return this._loadingPromise;var r=this._data;return(0,oi.t)(r)?(this._glTexture=new Ii.E(e,this._createDescriptor(e),null),this._glTexture):"string"==typeof r?this._loadFromURL(e,t,r):r instanceof Image?this._loadFromImageElement(e,t,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r,t):((0,oi.R)(r)||(0,oi.S)(r))&&this.params.encoding===n.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,r)):((0,oi.R)(r)||(0,oi.S)(r))&&this.params.encoding===n.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,r)):((0,oi.R)(r)||(0,oi.S)(r))&&this.params.encoding===n.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,r)):(0,oi.S)(r)?this._loadFromPixelData(e,r):(0,oi.R)(r)?this._loadFromPixelData(e,new Uint8Array(r)):null}},{key:"requiresFrameUpdates",get:function(){return this._data instanceof HTMLVideoElement}},{key:"frameUpdate",value:function(e,t,n){if(!(this._data instanceof HTMLVideoElement)||(0,oi.t)(this._glTexture))return n;if(this._data.readyState<ku.HAVE_CURRENT_DATA||n===this._data.currentTime)return n;if((0,oi.r)(this._powerOfTwoStretchInfo)){var r=this._powerOfTwoStretchInfo,i=r.framebuffer,a=r.vao,o=r.sourceTexture;o.setData(this._data),this._drawStretchedTexture(e,t,i,a,o,this._glTexture)}else{var s=this._data,u=s.videoWidth,c=s.videoHeight,l=this._glTexture.descriptor,d=l.width,f=l.height;u!==d||c!==f?this._glTexture.updateData(0,0,0,Math.min(u,d),Math.min(c,f),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}},{key:"_loadFromDDSData",value:function(e,t){return this._glTexture=Du(e,this._createDescriptor(e),t),this._glTexture}},{key:"_loadFromKTX2",value:function(e,t){var n=this;return this._loadAsync((function(){return function(e,t,n){return Mu.apply(this,arguments)}(e,n._createDescriptor(e),t).then((function(e){return n._glTexture=e,e}))}))}},{key:"_loadFromBasis",value:function(e,t){var n=this;return this._loadAsync((function(){return function(e,t,n){return Cu.apply(this,arguments)}(e,n._createDescriptor(e),t).then((function(e){return n._glTexture=e,e}))}))}},{key:"_loadFromPixelData",value:function(e,t){(0,Oi.e)(this.params.width>0&&this.params.height>0);var n=this._createDescriptor(e);return n.pixelFormat=1===this.params.components?Ri.P.LUMINANCE:3===this.params.components?Ri.P.RGB:Ri.P.RGBA,n.width=this.params.width,n.height=this.params.height,this._glTexture=new Ii.E(e,n,t),this._glTexture}},{key:"_loadFromURL",value:function(e,t,n){var r=this;return this._loadAsync(function(){var i=(0,Qr.Z)((0,Kr.Z)().mark((function i(a){var o;return(0,Kr.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,(0,wi.t)(n,{signal:a});case 2:return o=i.sent,i.abrupt("return",((0,yi.f)(a),r._loadFromImage(e,o,t)));case 4:case"end":return i.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}())}},{key:"_loadFromImageElement",value:function(e,t,n){var r=this;return n.complete?this._loadFromImage(e,n,t):this._loadAsync(function(){var i=(0,Qr.Z)((0,Kr.Z)().mark((function i(a){var o;return(0,Kr.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,(0,xi.g)(n,n.src,!1,a);case 2:return o=i.sent,i.abrupt("return",((0,yi.f)(a),r._loadFromImage(e,o,t)));case 4:case"end":return i.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}())}},{key:"_loadFromVideoElement",value:function(e,t,n){return n.readyState>=ku.HAVE_CURRENT_DATA?this._loadFromImage(e,n,t):this._loadFromVideoElementAsync(e,t,n)}},{key:"_loadFromVideoElementAsync",value:function(e,t,n){var r=this;return this._loadAsync((function(i){return new Promise((function(a,o){var s=function(){n.removeEventListener("loadeddata",u),n.removeEventListener("error",c),(0,oi.f)(l)},u=function(){n.readyState>=ku.HAVE_CURRENT_DATA&&(s(),a(r._loadFromImage(e,n,t)))},c=function(e){s(),o(e||new yi.s("Failed to load video"))};n.addEventListener("loadeddata",u),n.addEventListener("error",c);var l=(0,yi.v)(i,(function(){return c((0,yi.d)())}))}))}))}},{key:"_loadFromImage",value:function(e,t,r){var i=n._getDataDimensions(t);this.params.width=i.width,this.params.height=i.height;var a=this._createDescriptor(e);return a.pixelFormat=3===this.params.components?Ri.P.RGB:Ri.P.RGBA,!this._requiresPowerOfTwo(e,a)||(0,di.ad)(i.width)&&(0,di.ad)(i.height)?(a.width=i.width,a.height=i.height,this._glTexture=new Ii.E(e,a,t),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,t,i,a,r),this._glTexture)}},{key:"_loadAsync",value:function(e){var t=this,n=new AbortController;this._loadingController=n;var r=e(n.signal);this._loadingPromise=r;var i=function(){t._loadingController===n&&(t._loadingController=null),t._loadingPromise===r&&(t._loadingPromise=null)};return r.then(i,i),r}},{key:"_requiresPowerOfTwo",value:function(e,t){var n=Ri.D.CLAMP_TO_EDGE,r="number"==typeof t.wrapMode?t.wrapMode===n:t.wrapMode.s===n&&t.wrapMode.t===n;return!(0,Ii.n)(e.gl)&&(t.hasMipmap||!r)}},{key:"_makePowerOfTwoTexture",value:function(e,t,n,r,i){var a,o=n.width,s=n.height,u=(0,di.a8)(o),c=(0,di.a8)(s);switch(r.width=u,r.height=c,this.params.powerOfTwoResizeMode){case Si.h.PAD:r.textureCoordinateScaleFactor=[o/u,s/c],(a=new Ii.E(e,r)).updateData(0,0,0,o,s,t);break;case Si.h.STRETCH:case null:case void 0:a=this._stretchToPowerOfTwo(e,t,r,i())}return r.hasMipmap&&a.generateMipmap(),a}},{key:"_stretchToPowerOfTwo",value:function(e,t,n,r){var i=new Ii.E(e,n),a=new Fi.x(e,{colorTarget:Ri.Y.TEXTURE,depthStencilTarget:Ri.V.NONE},i),o=new Ii.E(e,{target:Ri.M.TEXTURE_2D,pixelFormat:n.pixelFormat,dataType:Ri.G.UNSIGNED_BYTE,wrapMode:Ri.D.CLAMP_TO_EDGE,samplingMode:Ri.L.LINEAR,flipped:!!n.flipped,maxAnisotropy:8,preMultiplyAlpha:n.preMultiplyAlpha},t),s=Ia(e),u=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,r,a,s,o,i),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:s,sourceTexture:o,framebuffer:a}:(s.dispose(!0),o.dispose(),a.detachColorTexture(),a.dispose()),e.bindFramebuffer(u),i}},{key:"_drawStretchedTexture",value:function(e,t,n,r,i,a){this._passParameters.texture=i,e.bindFramebuffer(n);var o=e.getViewport();e.setViewport(0,0,a.descriptor.width,a.descriptor.height),e.bindTechnique(t,this._passParameters,null),e.bindVAO(r),e.drawArrays(Ri.E.TRIANGLE_STRIP,0,(0,Fi.n)(r,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height),this._passParameters.texture=null}},{key:"unload",value:function(){if((0,oi.r)(this._powerOfTwoStretchInfo)){var e=this._powerOfTwoStretchInfo,t=e.framebuffer,n=e.vao,r=e.sourceTexture;n.dispose(!0),r.dispose(),t.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if((0,oi.r)(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),(0,oi.r)(this._loadingController)){var i=this._loadingController;this._loadingController=null,this._loadingPromise=null,i.abort()}this.events.emit("unloaded")}}],[{key:"_getDataDimensions",value:function(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}},{key:"_estimateTexMemRequired",value:function(e,t){if((0,oi.t)(e))return 0;if((0,oi.R)(e)||(0,oi.S)(e))return t.encoding===n.KTX2_ENCODING?function(e,t){if((0,oi.t)(bu))return e.byteLength;var n=new bu.KTX2File(new Uint8Array(e)),r=Au(n)?Su(n.getLevels(),n.getHasAlpha(),n.getWidth(),n.getHeight(),t):0;return n.close(),n.delete(),r}(e,t.mipmap):t.encoding===n.BASIS_ENCODING?function(e,t){if((0,oi.t)(bu))return e.byteLength;var n=new bu.BasisFile(new Uint8Array(e)),r=Ou(n)?Su(n.getNumLevels(0),n.getHasAlpha(),n.getImageWidth(0,0),n.getImageHeight(0,0),t):0;return n.close(),n.delete(),r}(e,t.mipmap):e.byteLength;var r=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?n._getDataDimensions(e):t,i=r.width,a=r.height;return(t.mipmap?4/3:1)*i*a*(t.components||4)||0}}]),n}(Yo);zu.DDS_ENCODING="image/vnd-ms.dds",zu.KTX2_ENCODING="image/ktx2",zu.BASIS_ENCODING="image/x.basis",function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(ku||(ku={}));var Bu=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e){var r;return(0,ii.Z)(this,n),(r=t.call(this)).slicePlaneLocalOrigin=e,r}return(0,ri.Z)(n)}(Wi);function Vu(e,t){Uu(e,t,[new Qi("slicePlaneOrigin",(function(e,n){return ju(t,e,n)})),new Qi("slicePlaneBasis1",(function(e,n){var r;return Xu(t,e,n,null===(r=(0,oi.e)(n.slicePlane))||void 0===r?void 0:r.basis1)})),new Qi("slicePlaneBasis2",(function(e,n){var r;return Xu(t,e,n,null===(r=(0,oi.e)(n.slicePlane))||void 0===r?void 0:r.basis2)}))])}function Gu(e,t){Uu(e,t,[new Va("slicePlaneOrigin",(function(e,n){return ju(t,e,n)})),new Va("slicePlaneBasis1",(function(e,n){var r;return Xu(t,e,n,null===(r=(0,oi.e)(n.slicePlane))||void 0===r?void 0:r.basis1)})),new Va("slicePlaneBasis2",(function(e,n){var r;return Xu(t,e,n,null===(r=(0,oi.e)(n.slicePlane))||void 0===r?void 0:r.basis2)}))])}function Uu(e,t,n){if(!t.hasSlicePlane){var r=qi(Se||(Se=(0,ni.Z)(["#define rejectBySlice(_pos_) false\n#define discardBySlice(_pos_) {}\n#define highlightSlice(_color_, _pos_) (_color_)"])));return t.hasSliceInVertexProgram&&e.vertex.code.add(r),void e.fragment.code.add(r)}e.extensions.add("GL_OES_standard_derivatives"),t.hasSliceInVertexProgram&&e.vertex.uniforms.add(n),e.fragment.uniforms.add(n);var i=qi(Oe||(Oe=(0,ni.Z)(["struct SliceFactors {\nfloat front;\nfloat side0;\nfloat side1;\nfloat side2;\nfloat side3;\n};\nSliceFactors calculateSliceFactors(vec3 pos) {\nvec3 rel = pos - slicePlaneOrigin;\nvec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);\nfloat slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);\nfloat basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);\nfloat basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);\nfloat basis1Dot = dot(slicePlaneBasis1, rel);\nfloat basis2Dot = dot(slicePlaneBasis2, rel);\nreturn SliceFactors(\ndot(slicePlaneNormal, pos) + slicePlaneW,\n-basis1Dot - basis1Len2,\nbasis1Dot - basis1Len2,\n-basis2Dot - basis2Len2,\nbasis2Dot - basis2Len2\n);\n}\nbool sliceByFactors(SliceFactors factors) {\nreturn factors.front < 0.0\n&& factors.side0 < 0.0\n&& factors.side1 < 0.0\n&& factors.side2 < 0.0\n&& factors.side3 < 0.0;\n}\nbool sliceEnabled() {\nreturn dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;\n}\nbool sliceByPlane(vec3 pos) {\nreturn sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));\n}\n#define rejectBySlice(_pos_) sliceByPlane(_pos_)\n#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }"]))),a=qi(Ae||(Ae=(0,ni.Z)(["vec4 applySliceHighlight(vec4 color, vec3 pos) {\nSliceFactors factors = calculateSliceFactors(pos);\nconst float HIGHLIGHT_WIDTH = 1.0;\nconst vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);\nfactors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);\nfactors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);\nfactors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);\nfactors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);\nfactors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);\nif (sliceByFactors(factors)) {\nreturn color;\n}\nfloat highlightFactor = (1.0 - step(0.5, factors.front))\n* (1.0 - step(0.5, factors.side0))\n* (1.0 - step(0.5, factors.side1))\n* (1.0 - step(0.5, factors.side2))\n* (1.0 - step(0.5, factors.side3));\nreturn mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);\n}"]))),o=t.hasSliceHighlight?qi(Ce||(Ce=(0,ni.Z)(["\n        ","\n        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))\n      "])),a):qi(Me||(Me=(0,ni.Z)(["#define highlightSlice(_color_, _pos_) (_color_)"])));t.hasSliceInVertexProgram&&e.vertex.code.add(i),e.fragment.code.add(i),e.fragment.code.add(o)}function Hu(e,t,n){return e.instancedDoublePrecision?(0,di.o)(Yu,n.camera.viewInverseTransposeMatrix[3],n.camera.viewInverseTransposeMatrix[7],n.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function Wu(e,t){return(0,oi.r)(e)?(0,di.e)(Ku,t.origin,e):t.origin}function qu(e,t,n){return e.hasSliceTranslatedView?(0,oi.r)(t)?(0,ci.c)($u,n.camera.viewMatrix,t):n.camera.viewMatrix:null}function ju(e,t,n){if((0,oi.t)(n.slicePlane))return di.a7;var r=Hu(e,t,n),i=Wu(r,n.slicePlane),a=qu(e,r,n);return(0,oi.r)(a)?(0,di.O)(Ku,i,a):i}function Xu(e,t,n,r){if((0,oi.t)(r)||(0,oi.t)(n.slicePlane))return di.a7;var i=Hu(e,t,n),a=Wu(i,n.slicePlane),o=qu(e,i,n);return(0,oi.r)(o)?((0,di.u)(Qu,r,a),(0,di.O)(Ku,a,o),(0,di.O)(Qu,Qu,o),(0,di.e)(Qu,Qu,Ku)):r}var Yu=(0,di.n)(),Ku=(0,di.n)(),Qu=(0,di.n)(),$u=(0,li.e)();function Ju(e,t){var n=t.output===yo.ObjectAndLayerIdColor,r=t.objectAndLayerIdColorInstanced;n&&(e.varyings.add("objectAndLayerIdColorVarying","vec4"),r?e.attributes.add(Ci.O.OBJECTANDLAYERIDCOLOR_INSTANCED,"vec4"):e.attributes.add(Ci.O.OBJECTANDLAYERIDCOLOR,"vec4")),e.vertex.code.add(qi(Pe||(Pe=(0,ni.Z)(["\n     void forwardObjectAndLayerIdColor() {\n      "," }"])),qi(n?r?Ze||(Ze=(0,ni.Z)(["objectAndLayerIdColorVarying = objectAndLayerIdColor_instanced * 0.003921568627451;"])):Ee||(Ee=(0,ni.Z)(["objectAndLayerIdColorVarying = objectAndLayerIdColor * 0.003921568627451;"])):Le||(Le=(0,ni.Z)([""]))))),e.fragment.code.add(qi(Re||(Re=(0,ni.Z)(["\n      void outputObjectAndLayerIdColor() {\n        "," }"])),qi(n?Ie||(Ie=(0,ni.Z)(["gl_FragColor = objectAndLayerIdColorVarying;"])):Fe||(Fe=(0,ni.Z)([""])))))}var ec=(0,Pi.r)(1,1,0,1),tc=(0,Pi.r)(1,0,1,1);function nc(e,t){e.fragment.uniforms.add(wa("depthTex",(function(e,t){return t.highlightDepthTexture}),t.hasWebGL2Context?va.None:va.InvSize)),e.fragment.constants.add("occludedHighlightFlag","vec4",ec).add("unoccludedHighlightFlag","vec4",tc),e.fragment.code.add(qi(Ne||(Ne=(0,ni.Z)(["\n    void outputHighlight() {\n      vec3 fragCoord = gl_FragCoord.xyz;\n\n      float sceneDepth = ",".x;\n      if (fragCoord.z > sceneDepth + 5e-7) {\n        gl_FragColor = occludedHighlightFlag;\n      }\n      else {\n        gl_FragColor = unoccludedHighlightFlag;\n      }\n    }\n  "])),ya(t,"depthTex","fragCoord.xy")))}var rc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r,i){return(0,ii.Z)(this,n),t.call(this,e,"vec4",Hr.Pass,(function(t,n,i){return t.setUniform4fv(e,r(n,i))}),i)}return(0,ri.Z)(n)}(Ki),ic=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r,i){return(0,ii.Z)(this,n),t.call(this,e,"float",Hr.Pass,(function(t,n,i){return t.setUniform1fv(e,r(n,i))}),i)}return(0,ri.Z)(n)}(Ki),ac=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).vvSizeEnabled=!1,e.vvSizeMinSize=(0,di.c)(1,1,1),e.vvSizeMaxSize=(0,di.c)(100,100,100),e.vvSizeOffset=(0,di.c)(0,0,0),e.vvSizeFactor=(0,di.c)(1,1,1),e.vvSizeValue=(0,di.c)(1,1,1),e.vvColorEnabled=!1,e.vvColorValues=[0,0,0,0,0,0,0,0],e.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],e.vvOpacityEnabled=!1,e.vvOpacityValues=[0,0,0,0,0,0,0,0],e.vvOpacityOpacities=[1,1,1,1,1,1,1,1],e.vvSymbolAnchor=[0,0,0],e.vvSymbolRotationMatrix=(0,ui.e)(),e}return(0,ri.Z)(n)}(nu),oc=8;function sc(e,t){t.hasVvInstancing&&(t.vvSize||t.vvColor)&&e.attributes.add(Ci.O.INSTANCEFEATUREATTRIBUTE,"vec4");var n=e.vertex;t.vvSize?(n.uniforms.add(new Qi("vvSizeMinSize",(function(e){return e.vvSizeMinSize}))),n.uniforms.add(new Qi("vvSizeMaxSize",(function(e){return e.vvSizeMaxSize}))),n.uniforms.add(new Qi("vvSizeOffset",(function(e){return e.vvSizeOffset}))),n.uniforms.add(new Qi("vvSizeFactor",(function(e){return e.vvSizeFactor}))),n.uniforms.add(new Do("vvSymbolRotationMatrix",(function(e){return e.vvSymbolRotationMatrix}))),n.uniforms.add(new Qi("vvSymbolAnchor",(function(e){return e.vvSymbolAnchor}))),n.code.add(qi(De||(De=(0,ni.Z)(["vec3 vvScale(vec4 _featureAttribute) {\nreturn clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);\n}\nvec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {\nreturn vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);\n}"])))),n.code.add(qi(ke||(ke=(0,ni.Z)(["\n      const float eps = 1.192092896e-07;\n      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {\n        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);\n        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);\n      }\n\n      ","\n    "])),t.hasVvInstancing?qi(ze||(ze=(0,ni.Z)(["\n      vec4 vvLocalNormal(vec3 _normal) {\n        return vvTransformNormal(_normal, instanceFeatureAttribute);\n      }\n\n      vec4 localPosition() {\n        return vvTransformPosition(position, instanceFeatureAttribute);\n      }"]))):""))):n.code.add(qi(Be||(Be=(0,ni.Z)(["vec4 localPosition() { return vec4(position, 1.0); }\nvec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }"])))),t.vvColor?(n.constants.add("vvColorNumber","int",oc),t.hasVvInstancing&&n.uniforms.add([new ic("vvColorValues",(function(e){return e.vvColorValues}),oc),new rc("vvColorColors",(function(e){return e.vvColorColors}),oc)]),n.code.add(qi(Ve||(Ve=(0,ni.Z)(["\n      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {\n        float value = featureAttribute.y;\n        if (value <= values[0]) {\n          return colors[0];\n        }\n\n        for (int i = 1; i < vvColorNumber; ++i) {\n          if (values[i] >= value) {\n            float f = (value - values[i-1]) / (values[i] - values[i-1]);\n            return mix(colors[i-1], colors[i], f);\n          }\n        }\n        return colors[vvColorNumber - 1];\n      }\n\n      ","\n    "])),t.hasVvInstancing?qi(Ge||(Ge=(0,ni.Z)(["\n      vec4 vvColor() {\n        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);\n      }"]))):""))):n.code.add(qi(Ue||(Ue=(0,ni.Z)(["vec4 vvColor() { return vec4(1.0); }"]))))}var uc=.1,cc=.001;function lc(e,t){switch(e.fragment.include(Xi),t.output){case yo.Shadow:case yo.ShadowHighlight:case yo.ShadowExludeHighlight:e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(qi(He||(He=(0,ni.Z)(["float _calculateFragDepth(const in float depth) {\nconst float SLOPE_SCALE = 2.0;\nconst float BIAS = 20.0 * .000015259;\nfloat m = max(abs(dFdx(depth)), abs(dFdy(depth)));\nfloat result = depth + SLOPE_SCALE * m + BIAS;\nreturn clamp(result, .0, .999999);\n}\nvoid outputDepth(float _linearDepth) {\ngl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));\n}"]))));break;case yo.Depth:e.fragment.code.add(qi(We||(We=(0,ni.Z)(["void outputDepth(float _linearDepth) {\ngl_FragColor = float2rgba(_linearDepth);\n}"]))))}}var dc,fc={func:Ri.I.LESS},hc={func:Ri.I.ALWAYS},vc={mask:255},mc={mask:0},pc=function(e){return{function:{func:Ri.I.NOTEQUAL,ref:e,mask:e},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.KEEP}}},gc=function(e){return{function:{func:Ri.I.ALWAYS,ref:e,mask:e},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.REPLACE}}},xc={function:{func:Ri.I.ALWAYS,ref:Si.t.OutlineVisualElementMask,mask:Si.t.OutlineVisualElementMask},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.ZERO}},_c={function:{func:Ri.I.ALWAYS,ref:Si.t.OutlineVisualElementMask,mask:Si.t.OutlineVisualElementMask},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.REPLACE}},bc={function:{func:Ri.I.EQUAL,ref:Si.t.OutlineVisualElementMask,mask:Si.t.OutlineVisualElementMask},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.KEEP}},yc={function:{func:Ri.I.NOTEQUAL,ref:Si.t.OutlineVisualElementMask,mask:Si.t.OutlineVisualElementMask},operation:{fail:Ri.O.KEEP,zFail:Ri.O.KEEP,zPass:Ri.O.KEEP}};function Tc(e){var t=qi(qe||(qe=(0,ni.Z)(["vec3 decodeNormal(vec2 f) {\nfloat z = 1.0 - abs(f.x) - abs(f.y);\nreturn vec3(f + sign(f) * min(z, 0.0), z);\n}"])));e.vertex.code.add(t)}function wc(e,t){t.normalType===dc.Attribute&&(e.attributes.add(Ci.O.NORMAL,"vec3"),e.vertex.code.add(qi(je||(je=(0,ni.Z)(["vec3 normalModel() {\nreturn normal;\n}"]))))),t.normalType===dc.CompressedAttribute&&(e.include(Tc),e.attributes.add(Ci.O.NORMALCOMPRESSED,"vec2"),e.vertex.code.add(qi(Xe||(Xe=(0,ni.Z)(["vec3 normalModel() {\nreturn decodeNormal(normalCompressed);\n}"]))))),t.normalType===dc.ScreenDerivative&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(qi(Ye||(Ye=(0,ni.Z)(["vec3 screenDerivativeNormal(vec3 positionView) {\nreturn normalize(cross(dFdx(positionView), dFdy(positionView)));\n}"])))))}function Sc(e,t){t.normalType===dc.Attribute||t.normalType===dc.CompressedAttribute?(e.include(wc,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add([new ao("transformNormalGlobalFromModel",(function(e){return e.transformNormalGlobalFromModel})),new Do("transformNormalViewFromGlobal",(function(e){return e.transformNormalViewFromGlobal}))]),e.vertex.code.add(qi(Ke||(Ke=(0,ni.Z)(["void forwardNormal() {\nvNormalWorld = transformNormalGlobalFromModel * normalModel();\nvNormalView = transformNormalViewFromGlobal * vNormalWorld;\n}"]))))):t.normalType===dc.Ground?(e.include(ko,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(qi(Qe||(Qe=(0,ni.Z)(["\n    void forwardNormal() {\n      vNormalWorld = ","\n    }\n    "])),t.spherical?qi($e||($e=(0,ni.Z)(["normalize(vPositionWorldCameraRelative);"]))):qi(Je||(Je=(0,ni.Z)(["vec3(0.0, 0.0, 1.0);"])))))):e.vertex.code.add(qi(et||(et=(0,ni.Z)(["void forwardNormal() {}"]))))}!function(e){e[e.Attribute=0]="Attribute",e[e.CompressedAttribute=1]="CompressedAttribute",e[e.Ground=2]="Ground",e[e.ScreenDerivative=3]="ScreenDerivative",e[e.COUNT=4]="COUNT"}(dc||(dc={}));var Oc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).transformNormalViewFromGlobal=(0,ui.e)(),e}return(0,ri.Z)(n)}(zo),Ac=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).transformNormalGlobalFromModel=(0,ui.e)(),e.toMapSpace=(0,Pi.n)(),e}return(0,ri.Z)(n)}(Bo),Cc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"int",Hr.Pass,(function(t,n,i){return t.setUniform1i(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki),Mc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r,i){return(0,ii.Z)(this,n),t.call(this,e,"mat4",Hr.Draw,(function(t,n,i){return t.setUniformMatrix4fv(e,r(n,i))}),i)}return(0,ri.Z)(n)}(Ki),Pc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r,i){return(0,ii.Z)(this,n),t.call(this,e,"mat4",Hr.Pass,(function(t,n,i){return t.setUniformMatrix4fv(e,r(n,i))}),i)}return(0,ri.Z)(n)}(Ki),Zc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).origin=(0,di.n)(),e}return(0,ri.Z)(n)}(Wi);function Ec(e,t){t.receiveShadows&&(e.fragment.uniforms.add(new Pc("shadowMapMatrix",(function(e,t){return t.shadowMap.getShadowMapMatrices(e.origin)}),4)),Rc(e,t))}function Lc(e,t){t.receiveShadows&&(e.fragment.uniforms.add(new Mc("shadowMapMatrix",(function(e,t){return t.shadowMap.getShadowMapMatrices(e.origin)}),4)),Rc(e,t))}function Rc(e,t){var n=e.fragment;n.include(Xi),n.uniforms.add([].concat((0,jr.Z)(wa("shadowMapTex",(function(e,t){return t.shadowMap.depthTexture}),t.hasWebGL2Context?va.None:va.Size)),[new Cc("numCascades",(function(e,t){return t.shadowMap.numCascades})),new ra("cascadeDistances",(function(e,t){return t.shadowMap.cascadeDistances}))])),n.code.add(qi(tt||(tt=(0,ni.Z)(["\n    int chooseCascade(float depth, out mat4 mat) {\n      vec4 distance = cascadeDistances;\n\n      // choose correct cascade\n      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\n\n      mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];\n\n      return i;\n    }\n\n    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {\n      vec4 lv = mat * vec4(_vpos, 1.0);\n      lv.xy /= lv.w;\n      return 0.5 * lv.xyz + vec3(0.5);\n    }\n\n    vec2 cascadeCoordinates(int i, vec3 lvpos) {\n      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n    }\n\n    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {\n      return rgba2float(texture2D(_depthTex, uv));\n    }\n\n    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {\n      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;\n    }\n\n    float filterShadow(vec2 uv, vec3 lvpos, float textureSize, sampler2D _depthTex) {\n      float halfPixelSize = 0.5 / textureSize;\n\n      // filter, offset by half pixels\n      vec2 st = fract((vec2(halfPixelSize) + uv) * textureSize);\n\n      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);\n      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);\n\n      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n    }\n\n    float readShadowMap(const in vec3 _vpos, float _linearDepth) {\n      mat4 mat;\n      int i = chooseCascade(_linearDepth, mat);\n\n      if (i >= numCascades) { return 0.0; }\n\n      vec3 lvpos = lightSpacePosition(_vpos, mat);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0) { return 0.0; }\n      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\n\n      // calc coord in cascade texture\n      vec2 uv = cascadeCoordinates(i, lvpos);\n\n      vec2 textureSize = ",";\n\n      return filterShadow(uv, lvpos, textureSize.x, shadowMapTex);\n    }\n  "])),ba(t,"shadowMapTex")))}function Ic(e){var t=e.fragment.code;t.add(qi(nt||(nt=(0,ni.Z)(["vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n{\nreturn ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n}"])))),t.add(qi(rt||(rt=(0,ni.Z)(["float integratedRadiance(float cosTheta2, float roughness)\n{\nreturn (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n}"])))),t.add(qi(it||(it=(0,ni.Z)(["vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n{\nfloat cosTheta2 = 1.0 - RdotNG * RdotNG;\nfloat intRadTheta = integratedRadiance(cosTheta2, roughness);\nfloat ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\nfloat sky = 2.0 - ground;\nreturn (ground * ambientGround + sky * ambientSky) * 0.5;\n}"]))))}function Fc(e,t){var n=e.fragment.code;e.include(to),t.pbrMode===Wa.Water||t.pbrMode===Wa.WaterOnIntegratedMesh?(n.add(qi(at||(at=(0,ni.Z)(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),n.add(qi(ot||(ot=(0,ni.Z)(["vec3 fresnelReflection(float angle, vec3 f0, float f90) {\nreturn f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n}"])))),n.add(qi(st||(st=(0,ni.Z)(["float normalDistributionWater(float NdotH, float roughness)\n{\nfloat r2 = roughness * roughness;\nfloat NdotH2 = NdotH * NdotH;\nfloat denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\nreturn r2 / denom;\n}"])))),n.add(qi(ut||(ut=(0,ni.Z)(["float geometricOcclusionKelemen(float LoH)\n{\nreturn 0.25 / (LoH * LoH);\n}"])))),n.add(qi(ct||(ct=(0,ni.Z)(["vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n{\nvec3  F = fresnelReflection(props.VdotH, F0, F0Max);\nfloat dSun = normalDistributionWater(props.NdotH, roughness);\nfloat V = geometricOcclusionKelemen(props.LdotH);\nfloat diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\nfloat strengthSunHaze  = 1.2;\nfloat dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\nreturn ((dSun + dSunHaze) * V) * F;\n}\nvec3 tonemapACES(const vec3 x) {\nreturn (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n}"]))))):t.pbrMode!==Wa.Normal&&t.pbrMode!==Wa.Schematic||(e.include(Ic),n.add(qi(lt||(lt=(0,ni.Z)(["struct PBRShadingInfo\n{\nfloat NdotL;\nfloat NdotV;\nfloat NdotH;\nfloat VdotH;\nfloat LdotH;\nfloat NdotNG;\nfloat RdotNG;\nfloat NdotAmbDir;\nfloat NdotH_Horizon;\nvec3 skyRadianceToSurface;\nvec3 groundRadianceToSurface;\nvec3 skyIrradianceToSurface;\nvec3 groundIrradianceToSurface;\nfloat averageAmbientRadiance;\nfloat ssao;\nvec3 albedoLinear;\nvec3 f0;\nvec3 f90;\nvec3 diffuseColor;\nfloat metalness;\nfloat roughness;\n};"])))),n.add(qi(dt||(dt=(0,ni.Z)(["float normalDistribution(float NdotH, float roughness)\n{\nfloat a = NdotH * roughness;\nfloat b = roughness / (1.0 - NdotH * NdotH + a * a);\nreturn b * b * INV_PI;\n}"])))),n.add(qi(ft||(ft=(0,ni.Z)(["const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\nconst vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\nconst vec2 c2 = vec2(-1.04, 1.04);\nvec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\nreturn c2 * a004 + r.zw;\n}"])))),n.add(qi(ht||(ht=(0,ni.Z)(["vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\nvec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\nvec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\nvec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\nvec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\nvec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\nvec3 specularComponent = specularColor * indirectSpecular;\nreturn (diffuseComponent + specularComponent);\n}"])))),n.add(qi(vt||(vt=(0,ni.Z)(["float gamutMapChanel(float x, vec2 p){\nreturn (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n}"])))),n.add(qi(mt||(mt=(0,ni.Z)(["vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\nvec3 outColor;\nvec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\noutColor.x = gamutMapChanel(inColor.x, p) ;\noutColor.y = gamutMapChanel(inColor.y, p) ;\noutColor.z = gamutMapChanel(inColor.z, p) ;\nreturn outColor;\n}"])))))}function Nc(){var e=new sa,t=e.fragment;e.include(io);return t.include(Yi),t.uniforms.add([new Ta("depthMap",(function(e){return e.depthTexture})),new Ua("tex",(function(e){return e.colorTexture})),new Ga("blurSize",(function(e){return e.blurSize})),new $i("projScale",(function(e,t){var n=(0,di.x)(t.camera.eye,t.camera.center);return n>5e4?Math.max(0,e.projScale-(n-5e4)):e.projScale})),new na("nearFar",(function(e,t){return t.camera.nearFar}))]),t.code.add(qi(pt||(pt=(0,ni.Z)(["\n    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {\n      float c = texture2D(tex, uv).r;\n      float d = linearDepthFromTexture(depthMap, uv, nearFar);\n\n      float ddiff = d - center_d;\n\n      float w = exp(-r * r * "," - ddiff * ddiff * sharpness);\n      wTotal += w;\n      bTotal += w * c;\n    }\n  "])),qi.float(.08))),t.code.add(qi(gt||(gt=(0,ni.Z)(["\n    void main(void) {\n      float b = 0.0;\n      float w_total = 0.0;\n\n      float center_d = linearDepthFromTexture(depthMap, uv, nearFar);\n\n      float sharpness = -0.05 * projScale / center_d;\n      for (int r = -","; r <= ","; ++r) {\n        float rf = float(r);\n        vec2 uvOffset = uv + rf * blurSize;\n        blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);\n      }\n\n      gl_FragColor = vec4(b / w_total);\n    }\n  "])),qi.int(4),qi.int(4))),e}var Dc=Object.freeze(Object.defineProperty({__proto__:null,build:Nc},Symbol.toStringTag,{value:"Module"})),kc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n,[{key:"initializeProgram",value:function(e){return new Ma(e.rctx,n.shader.get().build(),Ca)}},{key:"initializePipeline",value:function(){return(0,Si.W)({colorWrite:Si._})}}]),n}(Aa);function zc(e){e.fragment.uniforms.add(new ra("projInfo",(function(e,t){return function(e){var t=e.camera.projectionMatrix;return 0===t[11]?(0,di.C)(Bc,2/(e.camera.fullWidth*t[0]),2/(e.camera.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):(0,di.C)(Bc,-2/(e.camera.fullWidth*t[0]),-2/(e.camera.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}(t)}))),e.fragment.uniforms.add(new na("zScale",(function(e,t){return Vc(t)}))),e.fragment.code.add(qi(xt||(xt=(0,ni.Z)(["vec3 reconstructPosition(vec2 fragCoord, float depth) {\nreturn vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);\n}"]))))}kc.shader=new Oa(Dc,(function(){return n.e(2838).then(n.bind(n,12838))}));var Bc=(0,Pi.n)();function Vc(e){return 0===e.camera.projectionMatrix[11]?(0,Zi.r)(Gc,0,1):(0,Zi.r)(Gc,1,0)}var Gc=(0,Ei.n)();function Uc(){var e=new sa,t=e.fragment;return e.include(io),t.include(Yi),e.include(zc),t.uniforms.add(new $i("radius",(function(e,t){return Hc(t)}))),t.code.add(qi(_t||(_t=(0,ni.Z)(["vec3 sphere[16];\nvoid fillSphere() {\nsphere[0] = vec3(0.186937, 0.0, 0.0);\nsphere[1] = vec3(0.700542, 0.0, 0.0);\nsphere[2] = vec3(-0.864858, -0.481795, -0.111713);\nsphere[3] = vec3(-0.624773, 0.102853, -0.730153);\nsphere[4] = vec3(-0.387172, 0.260319, 0.007229);\nsphere[5] = vec3(-0.222367, -0.642631, -0.707697);\nsphere[6] = vec3(-0.01336, -0.014956, 0.169662);\nsphere[7] = vec3(0.122575, 0.1544, -0.456944);\nsphere[8] = vec3(-0.177141, 0.85997, -0.42346);\nsphere[9] = vec3(-0.131631, 0.814545, 0.524355);\nsphere[10] = vec3(-0.779469, 0.007991, 0.624833);\nsphere[11] = vec3(0.308092, 0.209288,0.35969);\nsphere[12] = vec3(0.359331, -0.184533, -0.377458);\nsphere[13] = vec3(0.192633, -0.482999, -0.065284);\nsphere[14] = vec3(0.233538, 0.293706, -0.055139);\nsphere[15] = vec3(0.417709, -0.386701, 0.442449);\n}\nfloat fallOffFunction(float vv, float vn, float bias) {\nfloat f = max(radius * radius - vv, 0.0);\nreturn f * f * f * max(vn-bias, 0.0);\n}"])))),t.code.add(qi(bt||(bt=(0,ni.Z)(["float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {\nvec3 v = Q - C;\nfloat vv = dot(v, v);\nfloat vn = dot(normalize(v), n_C);\nreturn fallOffFunction(vv, vn, 0.1);\n}"])))),t.uniforms.add([new na("nearFar",(function(e,t){return t.camera.nearFar})),new Ta("normalMap",(function(e){return e.normalTexture})),new Ta("depthMap",(function(e){return e.depthTexture})),new na("zScale",(function(e,t){return Vc(t)})),new $i("projScale",(function(e){return e.projScale})),new Ta("rnm",(function(e){return e.noiseTexture})),new na("rnmScale",(function(e,t){return(0,Zi.r)(Wc,t.camera.fullWidth/(0,oi.e)(e.noiseTexture).descriptor.width,t.camera.fullHeight/(0,oi.e)(e.noiseTexture).descriptor.height)})),new $i("intensity",(function(e,t){return 2/Math.pow(Hc(t),6)})),new na("screenSize",(function(e,t){return(0,Zi.r)(Wc,t.camera.fullWidth,t.camera.fullHeight)}))]),t.code.add(qi(yt||(yt=(0,ni.Z)(["\n    void main(void) {\n      fillSphere();\n      vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));\n      float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);\n\n      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {\n        gl_FragColor = vec4(0.0);\n        return;\n      }\n\n      vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);\n\n      // get the normal of current fragment\n      vec4 norm4 = texture2D(normalMap, uv);\n      vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;\n      bool isTerrain = norm4.w<0.5;\n\n      float sum = .0;\n      vec3 tapPixelPos;\n\n      // note: the factor 2.0 should not be necessary, but makes ssao much nicer.\n      // bug or deviation from CE somewhere else?\n      float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);\n\n      for(int i = 0; i < ","; ++i) {\n        vec2 unitOffset = reflect(sphere[i], fres).xy;\n        vec2 offset = vec2(-unitOffset * radius * ps);\n\n        //don't use current or very nearby samples\n        if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;\n\n        vec2 tc = vec2(gl_FragCoord.xy + offset);\n        if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;\n        vec2 tcTap = tc / screenSize;\n        float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);\n\n        if (isTerrain) {\n          bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;\n          if (isTerrainTap) {\n            continue;\n          }\n        }\n\n        tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);\n\n        sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);\n      }\n\n      // output the result\n      float A = max(1.0 - sum * intensity / float(","),0.0);\n\n      // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2\n      A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;\n      gl_FragColor = vec4(A);\n    }\n  "])),qi.int(16),qi.int(16))),e}function Hc(e){return Math.max(10,20*e.camera.computeRenderPixelSizeAtDist(Math.abs(4*e.camera.relativeElevation)))}var Wc=(0,Ei.n)(),qc=Object.freeze(Object.defineProperty({__proto__:null,build:Uc},Symbol.toStringTag,{value:"Module"})),jc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n,[{key:"initializeProgram",value:function(e){return new Ma(e.rctx,n.shader.get().build(),Ca)}},{key:"initializePipeline",value:function(){return(0,Si.W)({colorWrite:Si._})}}]),n}(Aa);jc.shader=new Oa(qc,(function(){return n.e(6621).then(n.bind(n,86621))}));var Xc,Yc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).projScale=1,e}return(0,ri.Z)(n)}(Wi),Kc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n)}(Yc),Qc=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n)}(Wi),$c=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).blurSize=(0,Ei.n)(),e}return(0,ri.Z)(n)}(Qc),Jc=function(){function e(t,n,r){(0,ii.Z)(this,e),this._techniqueRepository=t,this._rctx=n,this._requestRender=r,this._enabled=!1,this._quadVAO=null,this._passParameters=new Kc,this._drawParameters=new $c}return(0,ri.Z)(e,[{key:"dispose",value:function(){this._quadVAO=(0,oi.G)(this._quadVAO)}},{key:"disposeOffscreenBuffers",value:function(){(0,oi.n)(this._ssaoFBO,(function(e){return e.resize(0,0)})),(0,oi.n)(this._blur0FBO,(function(e){return e.resize(0,0)})),(0,oi.n)(this._blur1FBO,(function(e){return e.resize(0,0)}))}},{key:"enabled",get:function(){return this._enabled},set:function(e){e?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&(0,oi.r)(this._passParameters.noiseTexture)&&(0,oi.r)(this._ssaoFBO)&&(0,oi.r)(this._blur0FBO)&&(0,oi.r)(this._blur1FBO)}},{key:"loading",get:function(){return this.enabled&&!this.ready}},{key:"colorTexture",get:function(){return(0,oi.r)(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"width",get:function(){return(0,oi.r)(this._ssaoFBO)?this._ssaoFBO.width:-1}},{key:"height",get:function(){return(0,oi.r)(this._ssaoFBO)?this._ssaoFBO.height:-1}},{key:"computeSSAO",value:function(e,t,n){if(!(!this.enabled||(0,oi.t)(t)||(0,oi.t)(n)||(0,oi.t)(this._passParameters.noiseTexture)||(0,oi.t)(this._ssaoFBO)||(0,oi.t)(this._blur0FBO)||(0,oi.t)(this._blur1FBO))){var r=this._rctx,i=e.camera;this._passParameters.normalTexture=n,this._passParameters.depthTexture=t,this._passParameters.projScale=1/i.computeRenderPixelSizeAtDist(1);var a=i.fullViewport,o=a[2],s=a[3],u=o/2,c=s/2;this._ssaoFBO.resize(o,s),this._blur0FBO.resize(u,c),this._blur1FBO.resize(u,c),(0,oi.t)(this._quadVAO)&&(this._quadVAO=Ia(this._rctx)),r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,o,s),r.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),r.bindVAO(this._quadVAO),r.drawArrays(Ri.E.TRIANGLE_STRIP,0,(0,Fi.n)(this._quadVAO,"geometry"));var l=r.bindTechnique(this._blurTechnique,this._passParameters,e);r.setViewport(0,0,u,c),r.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,(0,Zi.r)(this._drawParameters.blurSize,0,2/s),l.bindDraw(this._drawParameters,e,this._passParameters),r.setViewport(0,0,u,c),r.drawArrays(Ri.E.TRIANGLE_STRIP,0,(0,Fi.n)(this._quadVAO,"geometry")),r.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,(0,Zi.r)(this._drawParameters.blurSize,2/o,0),l.bindDraw(this._drawParameters,e,this._passParameters),r.drawArrays(Ri.E.TRIANGLE_STRIP,0,(0,Fi.n)(this._quadVAO,"geometry")),r.setViewport(a[0],a[1],a[2],a[3])}}},{key:"_selectPrograms",value:function(){(0,oi.t)(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(jc)),(0,oi.t)(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(kc))}},{key:"_enable",value:function(){var e=this;this.enabled||(this._enabled=!0,this._loadResources((function(){e._enabled&&e._initialize()})))}},{key:"_loadResources",value:function(e){var t=this;this._data?e():n.e(4073).then(n.bind(n,54073)).then((function(n){t._data=n,e()}))}},{key:"_initialize",value:function(){var e=this,t={target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,samplingMode:Ri.L.LINEAR,wrapMode:Ri.D.CLAMP_TO_EDGE,width:0,height:0},n={colorTarget:Ri.Y.TEXTURE,depthStencilTarget:Ri.V.NONE};(0,wi.t)(this._data.noiseTexture).then((function(r){e._enabled&&(e._ssaoFBO=new Fi.x(e._rctx,n,t),e._blur0FBO=new Fi.x(e._rctx,n,t),e._blur1FBO=new Fi.x(e._rctx,n,t),e._passParameters.noiseTexture=new Ii.E(e._rctx,{target:Ri.M.TEXTURE_2D,pixelFormat:Ri.P.RGBA,dataType:Ri.G.UNSIGNED_BYTE,hasMipmap:!0,width:r.width,height:r.height},r),e._requestRender())})),this._selectPrograms()}},{key:"_disable",value:function(){this._enabled=!1,this._passParameters.noiseTexture=(0,oi.G)(this._passParameters.noiseTexture),this._blur1FBO=(0,oi.G)(this._blur1FBO),this._blur0FBO=(0,oi.G)(this._blur0FBO),this._ssaoFBO=(0,oi.G)(this._ssaoFBO)}},{key:"gpuMemoryUsage",get:function(){return((0,oi.r)(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+((0,oi.r)(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+((0,oi.r)(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),e}();function el(e,t){var n=e.fragment;switch(n.code.add(qi(Tt||(Tt=(0,ni.Z)(["struct ShadingNormalParameters {\nvec3 normalView;\nvec3 viewDirection;\n} shadingParams;"])))),t.doubleSidedMode){case Xc.None:n.code.add(qi(wt||(wt=(0,ni.Z)(["vec3 shadingNormal(ShadingNormalParameters params) {\nreturn normalize(params.normalView);\n}"]))));break;case Xc.View:n.code.add(qi(St||(St=(0,ni.Z)(["vec3 shadingNormal(ShadingNormalParameters params) {\nreturn dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);\n}"]))));break;case Xc.WindingOrder:n.code.add(qi(Ot||(Ot=(0,ni.Z)(["vec3 shadingNormal(ShadingNormalParameters params) {\nreturn gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);\n}"]))));default:case Xc.COUNT:}}function tl(e){e.vertex.code.add(qi(At||(At=(0,ni.Z)(["vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {\nvec3 camToVert = posWorld - camPosWorld;\nbool isBackface = dot(camToVert, normalWorld) > 0.0;\nif (isBackface) {\nposClip.z += 0.0000003 * posClip.w;\n}\nreturn posClip;\n}"]))))}!function(e){e[e.None=0]="None",e[e.View=1]="View",e[e.WindingOrder=2]="WindingOrder",e[e.COUNT=3]="COUNT"}(Xc||(Xc={}));var nl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).instancedDoublePrecision=!1,e}return(0,ri.Z)(n)}(Pa);function rl(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add(Ci.O.MODELORIGINHI,"vec3"),e.attributes.add(Ci.O.MODELORIGINLO,"vec3"),e.attributes.add(Ci.O.MODEL,"mat3"),e.attributes.add(Ci.O.MODELNORMAL,"mat3"));var n=e.vertex;t.instancedDoublePrecision&&(n.include(Fo,t),n.uniforms.add(new Va("viewOriginHi",(function(e,t){return(0,Gi.o)((0,di.o)(il,t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]),il)}))),n.uniforms.add(new Va("viewOriginLo",(function(e,t){return(0,Gi.r)((0,di.o)(il,t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]),il)})))),n.code.add(qi(Ct||(Ct=(0,ni.Z)(["\n    vec3 calculateVPos() {\n      ","\n    }\n    "])),t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;")),n.code.add(qi(Mt||(Mt=(0,ni.Z)(["\n    vec3 subtractOrigin(vec3 _pos) {\n      ","\n    }\n    "])),t.instancedDoublePrecision?qi(Pt||(Pt=(0,ni.Z)(["\n          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);\n          return _pos - originDelta;"]))):"return vpos;")),n.code.add(qi(Zt||(Zt=(0,ni.Z)(["\n    vec3 dpNormal(vec4 _normal) {\n      ","\n    }\n    "])),t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);")),t.output===yo.Normal&&(Es(n),n.code.add(qi(Et||(Et=(0,ni.Z)(["\n    vec3 dpNormalView(vec4 _normal) {\n      ","\n    }\n    "])),t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"))),t.hasVertexTangents&&n.code.add(qi(Lt||(Lt=(0,ni.Z)(["\n    vec4 dpTransformVertexTangent(vec4 _tangent) {\n      ","\n\n    }\n    "])),t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"))}(0,yi.e)([Za()],nl.prototype,"instancedDoublePrecision",void 0);var il=(0,di.n)();function al(e){e.vertex.code.add(qi(Rt||(Rt=(0,ni.Z)(["\n    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {\n      float symbolAlpha = 0.0;\n\n      const float maxTint = 85.0;\n      const float maxReplace = 170.0;\n      const float scaleAlpha = 3.0;\n\n      if (symbolColor.a > maxReplace) {\n        colorMixMode = ",";\n        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);\n      } else if (symbolColor.a > maxTint) {\n        colorMixMode = ",";\n        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);\n      } else if (symbolColor.a > 0.0) {\n        colorMixMode = ",";\n        symbolAlpha = scaleAlpha * symbolColor.a;\n      } else {\n        colorMixMode = ",";\n        symbolAlpha = 0.0;\n      }\n\n      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);\n    }\n  "])),qi.int(Ui.r.Multiply),qi.int(Ui.r.Replace),qi.int(Ui.r.Tint),qi.int(Ui.r.Multiply)))}function ol(e,t){t.hasSymbolColors?(e.include(al),e.attributes.add(Ci.O.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float"),e.vertex.code.add(qi(It||(It=(0,ni.Z)(["int symbolColorMixMode;\nvec4 getSymbolColor() {\nreturn decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;\n}\nvoid forwardColorMixMode() {\ncolorMixMode = float(symbolColorMixMode) + 0.5;\n}"]))))):(e.fragment.uniforms.add(new Cc("colorMixMode",(function(e){return Js[e.colorMixMode]}))),e.vertex.code.add(qi(Ft||(Ft=(0,ni.Z)(["vec4 getSymbolColor() { return vec4(1.0); }\nvoid forwardColorMixMode() {}"])))))}function sl(e,t){t.hasVertexColors?(e.attributes.add(Ci.O.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(qi(Nt||(Nt=(0,ni.Z)(["void forwardVertexColor() { vColor = color; }"])))),e.vertex.code.add(qi(Dt||(Dt=(0,ni.Z)(["void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }"]))))):e.vertex.code.add(qi(kt||(kt=(0,ni.Z)(["void forwardVertexColor() {}\nvoid forwardNormalizedVertexColor() {}"]))))}function ul(e){e.fragment.code.add(qi(zt||(zt=(0,ni.Z)(["\n    #define discardOrAdjustAlpha(color) { if (color.a < ",") { discard; } }\n  "])),qi.float(cc)))}var cl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e,r){return(0,ii.Z)(this,n),t.call(this,e,"float",Hr.Draw,(function(t,n,i){return t.setUniform1f(e,r(n,i))}))}return(0,ri.Z)(n)}(Ki);function ll(e,t){fl(e,t,new $i("textureAlphaCutoff",(function(e){return e.textureAlphaCutoff})))}function dl(e,t){fl(e,t,new cl("textureAlphaCutoff",(function(e){return e.textureAlphaCutoff})))}function fl(e,t,n){var r=e.fragment;switch(t.alphaDiscardMode!==Si.C.Mask&&t.alphaDiscardMode!==Si.C.MaskBlend||r.uniforms.add(n),t.alphaDiscardMode){case Si.C.Blend:return e.include(ul);case Si.C.Opaque:r.code.add(qi(Bt||(Bt=(0,ni.Z)(["void discardOrAdjustAlpha(inout vec4 color) {\ncolor.a = 1.0;\n}"]))));break;case Si.C.Mask:r.code.add(qi(Vt||(Vt=(0,ni.Z)(["#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }"]))));break;case Si.C.MaskBlend:e.fragment.code.add(qi(Gt||(Gt=(0,ni.Z)(["#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }"]))))}}function hl(e,t){var n=e.vertex,r=e.fragment,i=t.hasModelTransformation;i&&n.uniforms.add(new ia("model",(function(e){return(0,oi.r)(e.modelTransformation)?e.modelTransformation:li.o})));var a=t.hasColorTexture&&t.alphaDiscardMode!==Si.C.Opaque;switch(t.output){case yo.Depth:case yo.Shadow:case yo.ShadowHighlight:case yo.ShadowExludeHighlight:case yo.ObjectAndLayerIdColor:Ms(n,t),e.include(Wo,t),e.include(ji,t),e.include(sc,t),e.include(lc,t),e.include(Gu,t),e.include(Ju,t),Go(e),e.varyings.add("depth","float"),a&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),n.code.add(qi(Ut||(Ut=(0,ni.Z)(["\n          void main(void) {\n            vpos = calculateVPos();\n            vpos = subtractOrigin(vpos);\n            vpos = addVerticalOffset(vpos, localOrigin);\n            gl_Position = transformPositionWithDepth(proj, view, "," vpos, nearFar, depth);\n            forwardTextureCoordinates();\n            forwardObjectAndLayerIdColor();\n          }\n        "])),i?"model,":"")),e.include(ll,t),r.code.add(qi(Ht||(Ht=(0,ni.Z)(["\n          void main(void) {\n            discardBySlice(vpos);\n            ","\n            ","\n          }\n        "])),a?qi(Wt||(Wt=(0,ni.Z)(["\n                    vec4 texColor = texture2D(tex, ",");\n                    discardOrAdjustAlpha(texColor);"])),t.hasColorTextureTransform?qi(qt||(qt=(0,ni.Z)(["colorUV"]))):qi(jt||(jt=(0,ni.Z)(["vuv0"])))):"",t.output===yo.ObjectAndLayerIdColor?qi(Xt||(Xt=(0,ni.Z)(["outputObjectAndLayerIdColor();"]))):qi(Yt||(Yt=(0,ni.Z)(["outputDepth(depth);"])))));break;case yo.Normal:Ms(n,t),e.include(Wo,t),e.include(wc,t),e.include(Sc,t),e.include(ji,t),e.include(sc,t),a&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),e.varyings.add("vPositionView","vec3"),n.code.add(qi(Kt||(Kt=(0,ni.Z)(["\n          void main(void) {\n            vpos = calculateVPos();\n            vpos = subtractOrigin(vpos);\n            ","\n            vpos = addVerticalOffset(vpos, localOrigin);\n            gl_Position = transformPosition(proj, view, "," vpos);\n            forwardTextureCoordinates();\n          }\n        "])),t.normalType===dc.Attribute?qi(Qt||(Qt=(0,ni.Z)(["\n            vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));"]))):"",i?"model,":"")),e.include(Gu,t),e.include(ll,t),r.code.add(qi($t||($t=(0,ni.Z)(["\n          void main() {\n            discardBySlice(vpos);\n            ","\n\n            ","\n            gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n          }\n        "])),a?qi(Jt||(Jt=(0,ni.Z)(["\n                    vec4 texColor = texture2D(tex, ",");\n                    discardOrAdjustAlpha(texColor);"])),t.hasColorTextureTransform?qi(en||(en=(0,ni.Z)(["colorUV"]))):qi(tn||(tn=(0,ni.Z)(["vuv0"])))):"",t.normalType===dc.ScreenDerivative?qi(nn||(nn=(0,ni.Z)(["\n                vec3 normal = screenDerivativeNormal(vPositionView);"]))):qi(rn||(rn=(0,ni.Z)(["\n                vec3 normal = normalize(vNormalWorld);\n                if (gl_FrontFacing == false) normal = -normal;"])))));break;case yo.Highlight:Ms(n,t),e.include(Wo,t),e.include(ji,t),e.include(sc,t),a&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),n.code.add(qi(an||(an=(0,ni.Z)(["\n          void main(void) {\n            vpos = calculateVPos();\n            vpos = subtractOrigin(vpos);\n            vpos = addVerticalOffset(vpos, localOrigin);\n            gl_Position = transformPosition(proj, view, "," vpos);\n            forwardTextureCoordinates();\n          }\n        "])),i?"model,":"")),e.include(Gu,t),e.include(ll,t),e.include(nc,t),r.code.add(qi(on||(on=(0,ni.Z)(["\n          void main() {\n            discardBySlice(vpos);\n            ","\n            outputHighlight();\n          }\n        "])),a?qi(sn||(sn=(0,ni.Z)(["\n                    vec4 texColor = texture2D(tex, ",");\n                    discardOrAdjustAlpha(texColor);"])),t.hasColorTextureTransform?qi(un||(un=(0,ni.Z)(["colorUV"]))):qi(cn||(cn=(0,ni.Z)(["vuv0"])))):""))}}function vl(e,t){var n=e.fragment;if(t.hasVertexTangents?(e.attributes.add(Ci.O.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),t.doubleSidedMode===Xc.WindingOrder?n.code.add(qi(ln||(ln=(0,ni.Z)(["mat3 computeTangentSpace(vec3 normal) {\nfloat tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;\nvec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);\nvec3 bitangent = cross(normal, tangent) * tangentHeadedness;\nreturn mat3(tangent, bitangent, normal);\n}"])))):n.code.add(qi(dn||(dn=(0,ni.Z)(["mat3 computeTangentSpace(vec3 normal) {\nfloat tangentHeadedness = vTangent.w;\nvec3 tangent = normalize(vTangent.xyz);\nvec3 bitangent = cross(normal, tangent) * tangentHeadedness;\nreturn mat3(tangent, bitangent, normal);\n}"]))))):(e.extensions.add("GL_OES_standard_derivatives"),n.code.add(qi(fn||(fn=(0,ni.Z)(["mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {\nvec3 Q1 = dFdx(pos);\nvec3 Q2 = dFdy(pos);\nvec2 stx = dFdx(st);\nvec2 sty = dFdy(st);\nfloat det = stx.t * sty.s - sty.t * stx.s;\nvec3 T = stx.t * Q2 - sty.t * Q1;\nT = T - normal * dot(normal, T);\nT *= inversesqrt(max(dot(T,T), 1.e-10));\nvec3 B = sign(det) * cross(normal, T);\nreturn mat3(T, B, normal);\n}"]))))),t.textureCoordinateType!==Ur.None){e.include(Ba,t);var r=t.supportsTextureAtlas?t.hasWebGL2Context?va.None:va.Size:va.None;n.uniforms.add(t.pbrTextureBindType===Hr.Pass?wa("normalTexture",(function(e){return e.textureNormal}),r):Ha("normalTexture",(function(e){return e.textureNormal}),r)),n.code.add(qi(hn||(hn=(0,ni.Z)(["\n    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {\n      vtc.uv = uv;\n      ","\n      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;\n      return tangentSpace * rawNormal;\n    }\n  "])),t.supportsTextureAtlas?qi(vn||(vn=(0,ni.Z)(["vtc.size = ",";"])),ba(t,"normalTexture")):""))}}function ml(e,t){var n=e.fragment;t.receiveAmbientOcclusion?(n.uniforms.add(wa("ssaoTex",(function(e,t){return t.ssaoHelper.colorTexture}),t.hasWebGL2Context?va.None:va.InvSize)),n.constants.add("blurSizePixelsInverse","float",.5),n.code.add(qi(mn||(mn=(0,ni.Z)(["\n      float evaluateAmbientOcclusionInverse() {\n        vec2 ssaoTextureSizeInverse = ",";\n        return texture2D(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).a;\n      }\n\n      float evaluateAmbientOcclusion() {\n        return 1.0 - evaluateAmbientOcclusionInverse();\n      }\n    "])),ba(t,"ssaoTex",!0)))):n.code.add(qi(pn||(pn=(0,ni.Z)(["float evaluateAmbientOcclusionInverse() { return 1.0; }\nfloat evaluateAmbientOcclusion() { return 0.0; }"]))))}function pl(e){e.constants.add("ambientBoostFactor","float",.4)}function gl(e){e.uniforms.add(new $i("lightingGlobalFactor",(function(e,t){return t.lighting.globalFactor})))}function xl(e,t){var n=e.fragment;switch(e.include(ml,t),t.pbrMode!==Wa.Disabled&&e.include(Fc,t),e.include($a,t),e.include(to),n.code.add(qi(gn||(gn=(0,ni.Z)(["\n    const float GAMMA_SRGB = 2.1;\n    const float INV_GAMMA_SRGB = 0.4761904;\n    ","\n  "])),t.pbrMode===Wa.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);")),pl(n),gl(n),Ji(n),n.code.add(qi(xn||(xn=(0,ni.Z)(["\n    float additionalDirectedAmbientLight(vec3 vPosWorld) {\n      float vndl = dot(",", mainLightDirection);\n      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));\n    }\n  "])),t.spherical?qi(_n||(_n=(0,ni.Z)(["normalize(vPosWorld)"]))):qi(bn||(bn=(0,ni.Z)(["vec3(0.0, 0.0, 1.0)"]))))),ea(n),n.code.add(qi(yn||(yn=(0,ni.Z)(["vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {\nfloat additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);\nreturn (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;\n}"])))),t.pbrMode){case Wa.Disabled:case Wa.WaterOnIntegratedMesh:case Wa.Water:e.include(ta,t),n.code.add(qi(Tn||(Tn=(0,ni.Z)(["vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)\n{\nvec3 mainLighting = evaluateMainLighting(normalWorld, shadow);\nvec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);\nvec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));\nvec3 totalLight = mainLighting + ambientLighting + additionalLight;\ntotalLight = min(totalLight, vec3(PI));\nvec3 outColor = vec3((albedoLinear / PI) * totalLight);\nreturn pow(outColor, vec3(INV_GAMMA_SRGB));\n}"]))));break;case Wa.Normal:case Wa.Schematic:n.code.add(qi(wn||(wn=(0,ni.Z)(["const float fillLightIntensity = 0.25;\nconst float horizonLightDiffusion = 0.4;\nconst float additionalAmbientIrradianceFactor = 0.02;\nvec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)\n{\nvec3 viewDirection = -viewDir;\nvec3 mainLightDirection = mainLightDirection;\nvec3 h = normalize(viewDirection + mainLightDirection);\nPBRShadingInfo inputs;\ninputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);\ninputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);\ninputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);\ninputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);\ninputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);\nvec3 reflectedView = normalize(reflect(viewDirection, normal));\ninputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);\ninputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));\ninputs.ssao = ssao;\ninputs.metalness = mrr[0];\ninputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);"])))),n.code.add(qi(Sn||(Sn=(0,ni.Z)(["inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;\ninputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));\ninputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);"])))),t.useFillLights?n.uniforms.add(new no("hasFillLights",(function(e,t){return t.enableFillLights}))):n.constants.add("hasFillLights","bool",!1),n.code.add(qi(On||(On=(0,ni.Z)(["vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);\nambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));\ninputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;\nvec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;\nvec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;\nvec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;\ninputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;\ninputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;"])))),n.uniforms.add([new $i("lightingSpecularStrength",(function(e,t){return t.lighting.mainLight.specularStrength})),new $i("lightingEnvironmentStrength",(function(e,t){return t.lighting.mainLight.environmentStrength}))]),n.code.add(qi(An||(An=(0,ni.Z)(["vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;\nvec3 horizonRingH = normalize(viewDirection + horizonRingDir);\ninputs.NdotH_Horizon = dot(normal, horizonRingH);\nvec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);\nvec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;\nvec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;\ninputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;\ninputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;\ninputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);"])))),n.code.add(qi(Cn||(Cn=(0,ni.Z)(["\n        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);\n        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;\n        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));\n        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;\n        ","\n        return outColor;\n      }\n    "])),t.pbrMode===Wa.Schematic?qi(Mn||(Mn=(0,ni.Z)(["vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));"]))):qi(Pn||(Pn=(0,ni.Z)(["vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));"])))));default:case Wa.COUNT:}}function _l(e){e.vertex.uniforms.add(new Do("colorTextureTransformMatrix",(function(e){return(0,oi.r)(e.colorTextureTransformMatrix)?e.colorTextureTransformMatrix:(0,pi.e)()}))),e.varyings.add("colorUV","vec2"),e.vertex.code.add(qi(Zn||(Zn=(0,ni.Z)(["void forwardColorUV(){\ncolorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;\n}"]))))}function bl(e){e.vertex.uniforms.add(new Do("normalTextureTransformMatrix",(function(e){return(0,oi.r)(e.normalTextureTransformMatrix)?e.normalTextureTransformMatrix:(0,pi.e)()}))),e.varyings.add("normalUV","vec2"),e.vertex.code.add(qi(En||(En=(0,ni.Z)(["void forwardNormalUV(){\nnormalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;\n}"]))))}function yl(e){e.vertex.uniforms.add(new Do("emissiveTextureTransformMatrix",(function(e){return(0,oi.r)(e.emissiveTextureTransformMatrix)?e.emissiveTextureTransformMatrix:(0,pi.e)()}))),e.varyings.add("emissiveUV","vec2"),e.vertex.code.add(qi(Ln||(Ln=(0,ni.Z)(["void forwardEmissiveUV(){\nemissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;\n}"]))))}function Tl(e){e.vertex.uniforms.add(new Do("occlusionTextureTransformMatrix",(function(e){return(0,oi.r)(e.occlusionTextureTransformMatrix)?e.occlusionTextureTransformMatrix:(0,pi.e)()}))),e.varyings.add("occlusionUV","vec2"),e.vertex.code.add(qi(Rn||(Rn=(0,ni.Z)(["void forwardOcclusionUV(){\nocclusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;\n}"]))))}function wl(e){e.vertex.uniforms.add(new Do("metallicRoughnessTextureTransformMatrix",(function(e){return(0,oi.r)(e.metallicRoughnessTextureTransformMatrix)?e.metallicRoughnessTextureTransformMatrix:(0,pi.e)()}))),e.varyings.add("metallicRoughnessUV","vec2"),e.vertex.code.add(qi(In||(In=(0,ni.Z)(["void forwardMetallicRoughnessUV(){\nmetallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;\n}"]))))}function Sl(e){e.include(ro),e.code.add(qi(Fn||(Fn=(0,ni.Z)(["\n    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {\n      // workaround for artifacts in OSX using Intel Iris Pro\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475\n      vec3 internalMixed = internalColor * textureColor;\n      vec3 allMixed = internalMixed * externalColor;\n\n      if (mode == ",") {\n        return allMixed;\n      }\n      if (mode == ",") {\n        return internalMixed;\n      }\n      if (mode == ",") {\n        return externalColor;\n      }\n\n      // tint (or something invalid)\n      float vIn = rgb2v(internalMixed);\n      vec3 hsvTint = rgb2hsv(externalColor);\n      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);\n      return hsv2rgb(hsvOut);\n    }\n\n    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {\n      // workaround for artifacts in OSX using Intel Iris Pro\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475\n      float internalMixed = internalOpacity * textureOpacity;\n      float allMixed = internalMixed * externalOpacity;\n\n      if (mode == ",") {\n        return internalMixed;\n      }\n      if (mode == ",") {\n        return externalOpacity;\n      }\n\n      // multiply or tint (or something invalid)\n      return allMixed;\n    }\n  "])),qi.int(Ui.r.Multiply),qi.int(Ui.r.Ignore),qi.int(Ui.r.Replace),qi.int(Ui.r.Ignore),qi.int(Ui.r.Replace)))}function Ol(e){var t=new sa,n=t.vertex,r=t.fragment,i=t.varyings;return Ms(n,e),t.include(Io),i.add("vpos","vec3"),t.include(sc,e),t.include(rl,e),t.include(Ls,e),e.hasColorTextureTransform&&t.include(_l),e.output!==yo.Color&&e.output!==yo.Alpha||(e.hasNormalTextureTransform&&t.include(bl),e.hasEmissionTextureTransform&&t.include(yl),e.hasOcclusionTextureTransform&&t.include(Tl),e.hasMetallicRoughnessTextureTransform&&t.include(wl),Cs(n,e),t.include(wc,e),t.include(Wo,e),e.normalType===dc.Attribute&&e.offsetBackfaces&&t.include(tl),t.include(vl,e),t.include(Sc,e),e.instancedColor&&t.attributes.add(Ci.O.INSTANCECOLOR,"vec4"),i.add("localvpos","vec3"),t.include(ji,e),t.include(Ho,e),t.include(ol,e),t.include(sl,e),n.uniforms.add(new ra("externalColor",(function(e){return e.externalColor}))),i.add("vcolorExt","vec4"),e.hasMultipassTerrain&&i.add("depth","float"),e.hasModelTransformation&&n.uniforms.add(new ia("model",(function(e){return(0,oi.r)(e.modelTransformation)?e.modelTransformation:li.o}))),n.code.add(qi(Nn||(Nn=(0,ni.Z)(["\n      void main(void) {\n        forwardNormalizedVertexColor();\n        vcolorExt = externalColor;\n        ","\n        vcolorExt *= vvColor();\n        vcolorExt *= getSymbolColor();\n        forwardColorMixMode();\n\n        if (vcolorExt.a < ",") {\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        } else {\n          vpos = calculateVPos();\n          localvpos = vpos - view[3].xyz;\n          vpos = subtractOrigin(vpos);\n          ","\n          vpos = addVerticalOffset(vpos, localOrigin);\n          ","\n          gl_Position = transformPosition(proj, view, "," vpos);\n          ","\n        }\n\n        ","\n        forwardLinearDepth();\n        forwardTextureCoordinates();\n        ","\n        ","\n        ","\n        ","\n        ","\n      }\n    "])),e.instancedColor?"vcolorExt *= instanceColor;":"",qi.float(cc),e.normalType===dc.Attribute?qi(Dn||(Dn=(0,ni.Z)(["vNormalWorld = dpNormal(vvLocalNormal(normalModel()));"]))):"",e.hasVertexTangents?"vTangent = dpTransformVertexTangent(tangent);":"",e.hasModelTransformation?"model,":"",e.normalType===dc.Attribute&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":"",e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":"",e.hasColorTextureTransform?qi(kn||(kn=(0,ni.Z)(["forwardColorUV();"]))):"",e.hasNormalTextureTransform?qi(zn||(zn=(0,ni.Z)(["forwardNormalUV();"]))):"",e.hasEmissionTextureTransform?qi(Bn||(Bn=(0,ni.Z)(["forwardEmissiveUV();"]))):"",e.hasOcclusionTextureTransform?qi(Vn||(Vn=(0,ni.Z)(["forwardOcclusionUV();"]))):"",e.hasMetallicRoughnessTextureTransform?qi(Gn||(Gn=(0,ni.Z)(["forwardMetallicRoughnessUV();"]))):""))),e.output===yo.Alpha&&(t.include(Gu,e),t.include(ll,e),t.include(oo,e),r.uniforms.add([new $i("opacity",(function(e){return e.opacity})),new $i("layerOpacity",(function(e){return e.layerOpacity}))]),e.hasColorTexture&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),r.include(Sl),r.code.add(qi(Un||(Un=(0,ni.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        ","\n        ","\n        gl_FragColor = vec4(opacity_);\n      }\n    "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":"",e.hasColorTexture?qi(Hn||(Hn=(0,ni.Z)(["\n                vec4 texColor = texture2D(tex, ",");\n                ","\n                discardOrAdjustAlpha(texColor);"])),e.hasColorTextureTransform?qi(Wn||(Wn=(0,ni.Z)(["colorUV"]))):qi(qn||(qn=(0,ni.Z)(["vuv0"]))),e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""):qi(jn||(jn=(0,ni.Z)(["vec4 texColor = vec4(1.0);"]))),e.hasVertexColors?qi(Xn||(Xn=(0,ni.Z)(["float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))):qi(Yn||(Yn=(0,ni.Z)(["float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));"])))))),e.output===yo.Color&&(t.include(Gu,e),t.include(xl,e),t.include(ml,e),t.include(ll,e),t.include(e.instancedDoublePrecision?Ec:Lc,e),t.include(oo,e),Cs(r,e),r.uniforms.add([n.uniforms.get("localOrigin"),new Qi("ambient",(function(e){return e.ambient})),new Qi("diffuse",(function(e){return e.diffuse})),new $i("opacity",(function(e){return e.opacity})),new $i("layerOpacity",(function(e){return e.layerOpacity}))]),e.hasColorTexture&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),t.include(Qa,e),t.include(Fc,e),r.include(Sl),t.include(el,e),pl(r),gl(r),ea(r),r.code.add(qi(Kn||(Kn=(0,ni.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        ","\n        shadingParams.viewDirection = normalize(vpos - cameraPosition);\n        ","\n        ","\n        float ssao = evaluateAmbientOcclusionInverse();\n        ssao *= getBakedOcclusion();\n\n        vec3 posWorld = vpos + localOrigin;\n\n        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);\n        float shadow = ",";\n\n        vec3 matColor = max(ambient, diffuse);\n        ","\n        ","\n        vec3 normalGround = ","\n\n        ","\n\n        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n        ","\n        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);\n        ","\n      }\n    "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":"",e.hasColorTexture?qi(Qn||(Qn=(0,ni.Z)(["\n                vec4 texColor = texture2D(tex, ",");\n                ","\n                discardOrAdjustAlpha(texColor);"])),e.hasColorTextureTransform?qi($n||($n=(0,ni.Z)(["colorUV"]))):qi(Jn||(Jn=(0,ni.Z)(["vuv0"]))),e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""):qi(er||(er=(0,ni.Z)(["vec4 texColor = vec4(1.0);"]))),e.normalType===dc.ScreenDerivative?qi(tr||(tr=(0,ni.Z)(["\n                vec3 normal = screenDerivativeNormal(localvpos);"]))):qi(nr||(nr=(0,ni.Z)(["\n                shadingParams.normalView = vNormalWorld;\n                vec3 normal = shadingNormal(shadingParams);"]))),e.pbrMode===Wa.Normal?"applyPBRFactors();":"",e.receiveShadows?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",e.hasVertexColors?qi(rr||(rr=(0,ni.Z)(["\n                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));\n                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))):qi(ir||(ir=(0,ni.Z)(["\n                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));\n                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))),e.hasNormalTexture?qi(ar||(ar=(0,ni.Z)(["\n                mat3 tangentSpace = ","\n                vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])),e.hasVertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"):qi(or||(or=(0,ni.Z)(["vec3 shadingNormal = normal;"]))),e.spherical?qi(sr||(sr=(0,ni.Z)(["normalize(posWorld);"]))):qi(ur||(ur=(0,ni.Z)(["vec3(0.0, 0.0, 1.0);"]))),e.snowCover?qi(cr||(cr=(0,ni.Z)(["\n                float snow = smoothstep(0.5, 0.55, dot(normal, normalGround));\n                albedo = mix(albedo, vec3(1), snow);\n                shadingNormal = mix(shadingNormal, normal, snow);\n                ssao = mix(ssao, 1.0, snow);"]))):"",e.pbrMode===Wa.Normal||e.pbrMode===Wa.Schematic?qi(lr||(lr=(0,ni.Z)(["\n                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];\n                ","\n\n                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);"])),e.snowCover?qi(dr||(dr=(0,ni.Z)(["\n                        mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);\n                        emission = mix(emission, vec3(0.0), snow);"]))):""):qi(fr||(fr=(0,ni.Z)(["vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);"]))),e.transparencyPassType===Si.o.Color?qi(hr||(hr=(0,ni.Z)(["gl_FragColor = premultiplyAlpha(gl_FragColor);"]))):""))),t.include(hl,e),t}var Al=Object.freeze(Object.defineProperty({__proto__:null,build:Ol},Symbol.toStringTag,{value:"Module"})),Cl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).isSchematic=!1,e.usePBR=!1,e.mrrFactors=(0,di.c)(0,1,.5),e.hasVertexColors=!1,e.hasSymbolColors=!1,e.doubleSided=!1,e.doubleSidedType="normal",e.cullFace=Si.n.Back,e.emissiveFactor=(0,di.c)(0,0,0),e.instancedDoublePrecision=!1,e.normals="default",e.receiveSSAO=!0,e.receiveShadows=!0,e.castShadows=!0,e.shadowMappingEnabled=!1,e.ambient=(0,di.c)(.2,.2,.2),e.diffuse=(0,di.c)(.8,.8,.8),e.externalColor=(0,Pi.r)(1,1,1,1),e.colorMixMode="multiply",e.opacity=1,e.layerOpacity=1,e.origin=(0,di.n)(),e.hasSlicePlane=!1,e.hasSliceHighlight=!0,e.offsetTransparentBackfaces=!1,e.vvSizeEnabled=!1,e.vvSizeMinSize=[1,1,1],e.vvSizeMaxSize=[100,100,100],e.vvSizeOffset=[0,0,0],e.vvSizeFactor=[1,1,1],e.vvSizeValue=[1,1,1],e.vvColorEnabled=!1,e.vvColorValues=[0,0,0,0,0,0,0,0],e.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],e.vvSymbolAnchor=[0,0,0],e.vvSymbolRotationMatrix=(0,ui.e)(),e.vvOpacityEnabled=!1,e.vvOpacityValues=[],e.vvOpacityOpacities=[],e.transparent=!1,e.writeDepth=!0,e.customDepthTest=Si.m.Less,e.textureAlphaMode=Si.C.Blend,e.textureAlphaCutoff=uc,e.textureAlphaPremultiplied=!1,e.hasOccludees=!1,e.renderOccluded=$s.Occlude,e}return(0,ri.Z)(n)}(Oc),Ml=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).origin=(0,di.n)(),e.slicePlaneLocalOrigin=e.origin,e}return(0,ri.Z)(n)}(Ac),Pl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===Hi.r.WEBGL2,t.spherical=e.viewingMode===Di.l.Global,t.doublePrecisionRequiresObfuscation=No(e.rctx),t.textureCoordinateType=t.hasColorTexture||t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture||t.hasNormalTexture?Ur.Default:Ur.None,t.objectAndLayerIdColorInstanced=t.instanced}},{key:"initializeProgram",value:function(e){return this._initializeProgram(e,n.shader)}},{key:"_initializeProgram",value:function(e,t){return new Ma(e.rctx,t.get().build(this.configuration),Ca)}},{key:"_convertDepthTestFunction",value:function(e){return e===Si.m.Lequal?Ri.I.LEQUAL:Ri.I.LESS}},{key:"_makePipeline",value:function(e,t){var n=this.configuration,r=e===Si.o.NONE,i=e===Si.o.FrontFace;return(0,Si.W)({blending:n.output!==yo.Color&&n.output!==yo.Alpha||!n.transparent?null:r?Si.d:(0,Si.A)(e),culling:Zl(n)&&(0,Si.k)(n.cullFace),depthTest:{func:(0,Si.e)(e,this._convertDepthTestFunction(n.customDepthTest))},depthWrite:r||i?n.writeDepth&&Si.b:null,colorWrite:Si._,stencilWrite:n.hasOccludees?vc:null,stencilTest:n.hasOccludees?t?_c:xc:null,polygonOffset:r||i?null:(0,Si.g)(n.enableOffset)})}},{key:"initializePipeline",value:function(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,Wr.Z)((0,qr.Z)(n.prototype),"getPipelineState",this).call(this,e,t)}}]),n}(Aa);function Zl(e){return e.cullFace!==Si.n.None||!e.hasSlicePlane&&!e.transparent&&!e.doubleSidedMode}Pl.shader=new Oa(Al,(function(){return n.e(6351).then(n.bind(n,56351))}));var El=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).output=yo.Color,e.alphaDiscardMode=Si.C.Opaque,e.doubleSidedMode=Xc.None,e.pbrMode=Wa.Disabled,e.cullFace=Si.n.None,e.transparencyPassType=Si.o.NONE,e.normalType=dc.Attribute,e.textureCoordinateType=Ur.None,e.customDepthTest=Si.m.Less,e.spherical=!1,e.hasVertexColors=!1,e.hasSymbolColors=!1,e.hasVerticalOffset=!1,e.hasSlicePlane=!1,e.hasSliceHighlight=!0,e.hasColorTexture=!1,e.hasMetallicRoughnessTexture=!1,e.hasEmissionTexture=!1,e.hasOcclusionTexture=!1,e.hasNormalTexture=!1,e.hasScreenSizePerspective=!1,e.hasVertexTangents=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.hasModelTransformation=!1,e.offsetBackfaces=!1,e.vvSize=!1,e.vvColor=!1,e.receiveShadows=!1,e.receiveAmbientOcclusion=!1,e.textureAlphaPremultiplied=!1,e.instanced=!1,e.instancedColor=!1,e.objectAndLayerIdColorInstanced=!1,e.instancedDoublePrecision=!1,e.doublePrecisionRequiresObfuscation=!1,e.writeDepth=!0,e.transparent=!1,e.enableOffset=!0,e.cullAboveGround=!1,e.snowCover=!1,e.hasColorTextureTransform=!1,e.hasEmissionTextureTransform=!1,e.hasNormalTextureTransform=!1,e.hasOcclusionTextureTransform=!1,e.hasMetallicRoughnessTextureTransform=!1,e}return(0,ri.Z)(n)}(Ro);function Ll(e){var t=new sa,n=t.vertex,r=t.fragment,i=t.varyings;return Ms(n,e),t.include(Io),i.add("vpos","vec3"),t.include(sc,e),t.include(rl,e),t.include(Ls,e),e.output!==yo.Color&&e.output!==yo.Alpha||(Cs(t.vertex,e),t.include(wc,e),t.include(Wo,e),e.offsetBackfaces&&t.include(tl),e.instancedColor&&t.attributes.add(Ci.O.INSTANCECOLOR,"vec4"),i.add("vNormalWorld","vec3"),i.add("localvpos","vec3"),e.hasMultipassTerrain&&i.add("depth","float"),t.include(ji,e),t.include(Ho,e),t.include(ol,e),t.include(sl,e),n.uniforms.add(new ra("externalColor",(function(e){return e.externalColor}))),i.add("vcolorExt","vec4"),n.code.add(qi(vr||(vr=(0,ni.Z)(["\n        void main(void) {\n          forwardNormalizedVertexColor();\n          vcolorExt = externalColor;\n          ","\n          vcolorExt *= vvColor();\n          vcolorExt *= getSymbolColor();\n          forwardColorMixMode();\n\n          if (vcolorExt.a < ",") {\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          } else {\n            vpos = calculateVPos();\n            localvpos = vpos - view[3].xyz;\n            vpos = subtractOrigin(vpos);\n            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));\n            vpos = addVerticalOffset(vpos, localOrigin);\n            gl_Position = transformPosition(proj, view, vpos);\n            ","\n          }\n          ","\n          forwardLinearDepth();\n          forwardTextureCoordinates();\n        }\n      "])),e.instancedColor?"vcolorExt *= instanceColor;":"",qi.float(cc),e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":"",e.hasMultipassTerrain?qi(mr||(mr=(0,ni.Z)(["depth = (view * vec4(vpos, 1.0)).z;"]))):""))),e.output===yo.Alpha&&(t.include(Gu,e),t.include(ll,e),t.include(oo,e),r.uniforms.add([new $i("opacity",(function(e){return e.opacity})),new $i("layerOpacity",(function(e){return e.layerOpacity}))]),e.hasColorTexture&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),r.include(Sl),r.code.add(qi(pr||(pr=(0,ni.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        ","\n        ","\n\n        gl_FragColor = vec4(opacity_);\n      }\n    "])),e.hasMultipassTerrain?qi(gr||(gr=(0,ni.Z)(["terrainDepthTest(gl_FragCoord, depth);"]))):"",e.hasColorTexture?qi(xr||(xr=(0,ni.Z)(["\n                vec4 texColor = texture2D(tex, ",");\n                ","\n                discardOrAdjustAlpha(texColor);"])),e.hasColorTextureTransform?qi(_r||(_r=(0,ni.Z)(["colorUV"]))):qi(br||(br=(0,ni.Z)(["vuv0"]))),e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""):qi(yr||(yr=(0,ni.Z)(["vec4 texColor = vec4(1.0);"]))),e.hasVertexColors?qi(Tr||(Tr=(0,ni.Z)(["float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))):qi(wr||(wr=(0,ni.Z)(["float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));"])))))),e.output===yo.Color&&(t.include(Gu,e),t.include(xl,e),t.include(ml,e),t.include(ll,e),t.include(e.instancedDoublePrecision?Ec:Lc,e),t.include(oo,e),Cs(t.fragment,e),Ji(r),pl(r),gl(r),r.uniforms.add([n.uniforms.get("localOrigin"),n.uniforms.get("view"),new Qi("ambient",(function(e){return e.ambient})),new Qi("diffuse",(function(e){return e.diffuse})),new $i("opacity",(function(e){return e.opacity})),new $i("layerOpacity",(function(e){return e.layerOpacity}))]),e.hasColorTexture&&r.uniforms.add(new Ta("tex",(function(e){return e.texture}))),t.include(Qa,e),t.include(Fc,e),r.include(Sl),t.extensions.add("GL_OES_standard_derivatives"),ea(r),r.code.add(qi(Sr||(Sr=(0,ni.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        ","\n        vec3 viewDirection = normalize(vpos - cameraPosition);\n        ","\n        float ssao = evaluateAmbientOcclusionInverse();\n        ssao *= getBakedOcclusion();\n\n        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);\n        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n        ","\n        vec3 matColor = max(ambient, diffuse);\n        ","\n        ","\n        ","\n        ","\n        ","\n        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);\n        ","\n      }\n    "])),e.hasMultipassTerrain?qi(Or||(Or=(0,ni.Z)(["terrainDepthTest(gl_FragCoord, depth);"]))):"",e.hasColorTexture?qi(Ar||(Ar=(0,ni.Z)(["\n                vec4 texColor = texture2D(tex, ",");\n                ","\n                discardOrAdjustAlpha(texColor);"])),e.hasColorTextureTransform?qi(Cr||(Cr=(0,ni.Z)(["colorUV"]))):qi(Mr||(Mr=(0,ni.Z)(["vuv0"]))),e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""):qi(Pr||(Pr=(0,ni.Z)(["vec4 texColor = vec4(1.0);"]))),e.pbrMode===Wa.Normal?"applyPBRFactors();":"",e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;",e.hasVertexColors?qi(Zr||(Zr=(0,ni.Z)(["\n                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));\n                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))):qi(Er||(Er=(0,ni.Z)(["\n                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));\n                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));"]))),e.snowCover?qi(Lr||(Lr=(0,ni.Z)(["albedo = mix(albedo, vec3(1), 0.9);"]))):qi(Rr||(Rr=(0,ni.Z)([""]))),qi(Ir||(Ir=(0,ni.Z)(["\n            vec3 shadingNormal = normalize(vNormalWorld);\n            albedo *= 1.2;\n            vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);\n            float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);\n            float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);\n            float treeRadialFalloff = vColor.r;\n            float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);\n            additionalLight += backLightFactor * mainLightIntensity;"]))),e.pbrMode===Wa.Normal||e.pbrMode===Wa.Schematic?e.spherical?qi(Fr||(Fr=(0,ni.Z)(["vec3 normalGround = normalize(vpos + localOrigin);"]))):qi(Nr||(Nr=(0,ni.Z)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))):qi(Dr||(Dr=(0,ni.Z)([""]))),e.pbrMode===Wa.Normal||e.pbrMode===Wa.Schematic?qi(kr||(kr=(0,ni.Z)(["\n                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];\n                ","\n\n                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);"])),e.snowCover?qi(zr||(zr=(0,ni.Z)(["\n                        mrr = vec3(0.0, 1.0, 0.04);\n                        emission = vec3(0.0);"]))):""):qi(Br||(Br=(0,ni.Z)(["vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);"]))),e.transparencyPassType===Si.o.Color?qi(Vr||(Vr=(0,ni.Z)(["gl_FragColor = premultiplyAlpha(gl_FragColor);"]))):qi(Gr||(Gr=(0,ni.Z)([""])))))),t.include(hl,e),t}(0,yi.e)([Za({count:yo.COUNT})],El.prototype,"output",void 0),(0,yi.e)([Za({count:Si.C.COUNT})],El.prototype,"alphaDiscardMode",void 0),(0,yi.e)([Za({count:Xc.COUNT})],El.prototype,"doubleSidedMode",void 0),(0,yi.e)([Za({count:Wa.COUNT})],El.prototype,"pbrMode",void 0),(0,yi.e)([Za({count:Si.n.COUNT})],El.prototype,"cullFace",void 0),(0,yi.e)([Za({count:Si.o.COUNT})],El.prototype,"transparencyPassType",void 0),(0,yi.e)([Za({count:dc.COUNT})],El.prototype,"normalType",void 0),(0,yi.e)([Za({count:Ur.COUNT})],El.prototype,"textureCoordinateType",void 0),(0,yi.e)([Za({count:Si.m.COUNT})],El.prototype,"customDepthTest",void 0),(0,yi.e)([Za()],El.prototype,"spherical",void 0),(0,yi.e)([Za()],El.prototype,"hasVertexColors",void 0),(0,yi.e)([Za()],El.prototype,"hasSymbolColors",void 0),(0,yi.e)([Za()],El.prototype,"hasVerticalOffset",void 0),(0,yi.e)([Za()],El.prototype,"hasSlicePlane",void 0),(0,yi.e)([Za()],El.prototype,"hasSliceHighlight",void 0),(0,yi.e)([Za()],El.prototype,"hasColorTexture",void 0),(0,yi.e)([Za()],El.prototype,"hasMetallicRoughnessTexture",void 0),(0,yi.e)([Za()],El.prototype,"hasEmissionTexture",void 0),(0,yi.e)([Za()],El.prototype,"hasOcclusionTexture",void 0),(0,yi.e)([Za()],El.prototype,"hasNormalTexture",void 0),(0,yi.e)([Za()],El.prototype,"hasScreenSizePerspective",void 0),(0,yi.e)([Za()],El.prototype,"hasVertexTangents",void 0),(0,yi.e)([Za()],El.prototype,"hasOccludees",void 0),(0,yi.e)([Za()],El.prototype,"hasMultipassTerrain",void 0),(0,yi.e)([Za()],El.prototype,"hasModelTransformation",void 0),(0,yi.e)([Za()],El.prototype,"offsetBackfaces",void 0),(0,yi.e)([Za()],El.prototype,"vvSize",void 0),(0,yi.e)([Za()],El.prototype,"vvColor",void 0),(0,yi.e)([Za()],El.prototype,"receiveShadows",void 0),(0,yi.e)([Za()],El.prototype,"receiveAmbientOcclusion",void 0),(0,yi.e)([Za()],El.prototype,"textureAlphaPremultiplied",void 0),(0,yi.e)([Za()],El.prototype,"instanced",void 0),(0,yi.e)([Za()],El.prototype,"instancedColor",void 0),(0,yi.e)([Za()],El.prototype,"objectAndLayerIdColorInstanced",void 0),(0,yi.e)([Za()],El.prototype,"instancedDoublePrecision",void 0),(0,yi.e)([Za()],El.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,yi.e)([Za()],El.prototype,"writeDepth",void 0),(0,yi.e)([Za()],El.prototype,"transparent",void 0),(0,yi.e)([Za()],El.prototype,"enableOffset",void 0),(0,yi.e)([Za()],El.prototype,"cullAboveGround",void 0),(0,yi.e)([Za()],El.prototype,"snowCover",void 0),(0,yi.e)([Za()],El.prototype,"hasColorTextureTransform",void 0),(0,yi.e)([Za()],El.prototype,"hasEmissionTextureTransform",void 0),(0,yi.e)([Za()],El.prototype,"hasNormalTextureTransform",void 0),(0,yi.e)([Za()],El.prototype,"hasOcclusionTextureTransform",void 0),(0,yi.e)([Za()],El.prototype,"hasMetallicRoughnessTextureTransform",void 0),(0,yi.e)([Za({constValue:!0})],El.prototype,"hasVvInstancing",void 0),(0,yi.e)([Za({constValue:!1})],El.prototype,"useCustomDTRExponentForWater",void 0),(0,yi.e)([Za({constValue:!1})],El.prototype,"supportsTextureAtlas",void 0),(0,yi.e)([Za({constValue:!0})],El.prototype,"useFillLights",void 0);var Rl=Object.freeze(Object.defineProperty({__proto__:null,build:Ll},Symbol.toStringTag,{value:"Module"})),Il=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){return(0,ii.Z)(this,n),t.apply(this,arguments)}return(0,ri.Z)(n,[{key:"initializeConfiguration",value:function(e,t){(0,Wr.Z)((0,qr.Z)(n.prototype),"initializeConfiguration",this).call(this,e,t),t.hasMetallicRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.hasModelTransformation=!1,t.normalType=dc.Attribute,t.doubleSidedMode=Xc.WindingOrder,t.hasVertexTangents=!1}},{key:"initializeProgram",value:function(e){return this._initializeProgram(e,n.shader)}}]),n}(Pl);Il.shader=new Oa(Rl,(function(){return n.e(8249).then(n.bind(n,18249))}));var Fl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e){var r;return(0,ii.Z)(this,n),(r=t.call(this,e,kl)).supportsEdges=!0,r._configuration=new El,r._vertexBufferLayout=function(e){var t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,n=(0,ki.T)().vec3f(Ci.O.POSITION).vec3f(Ci.O.NORMAL);return e.hasVertexTangents&&n.vec4f(Ci.O.TANGENT),t&&n.vec2f(Ci.O.UV0),e.hasVertexColors&&n.vec4u8(Ci.O.COLOR),e.hasSymbolColors&&n.vec4u8(Ci.O.SYMBOLCOLOR),(0,oi.h)("enable-feature:objectAndLayerId-rendering")&&n.vec4u8(Ci.O.OBJECTANDLAYERIDCOLOR),n}(r.parameters),r._instanceBufferLayout=e.instanced?Bl(r.parameters):null,r}return(0,ri.Z)(n,[{key:"isVisibleForOutput",value:function(e){return e!==yo.Shadow&&e!==yo.ShadowExludeHighlight&&e!==yo.ShadowHighlight||this.parameters.castShadows}},{key:"isVisible",value:function(){var e=this.parameters;if(!(0,Wr.Z)((0,qr.Z)(n.prototype),"isVisible",this).call(this)||0===e.layerOpacity)return!1;var t=e.instanced,r=e.hasVertexColors,i=e.hasSymbolColors,a=e.vvColorEnabled,o=(0,oi.r)(t)&&t.includes("color"),s="replace"===e.colorMixMode,u=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return r&&(o||a||i)?!!s||u:r?s?c:u:o||a||i?!!s||u:s?c:u}},{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=!!this.parameters.instanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.hasVerticalOffset=(0,oi.r)(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=(0,oi.r)(this.parameters.screenSizePerspective),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType="screenDerivative"===this.parameters.normals?dc.ScreenDerivative:dc.Attribute,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,(0,oi.r)(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?Si.n.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=(0,oi.r)(this.parameters.modelTransformation),e!==yo.Color&&e!==yo.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=Xc.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?Xc.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?Xc.WindingOrder:Xc.None,this._configuration.instancedColor=(0,oi.r)(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.ready&&this.parameters.receiveSSAO,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?Wa.Schematic:Wa.Normal:Wa.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Si.S,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}},{key:"hasSnowCover",value:function(e){return(0,oi.r)(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}},{key:"intersect",value:function(e,t,n,r,i,a,o){if((0,oi.r)(this.parameters.verticalOffset)){var s=r.camera;(0,di.o)(ql,n[12],n[13],n[14]);var u=null;switch(r.viewingMode){case Di.l.Global:u=(0,di.z)(Hl,ql);break;case Di.l.Local:u=(0,di.r)(Hl,Ul)}var c=0,l=(0,di.e)(jl,ql,s.eye),d=(0,di.s)(l),f=(0,di.g)(l,l,1/d),h=null;this.parameters.screenSizePerspective&&(h=(0,di.P)(u,f)),c+=js(s,d,this.parameters.verticalOffset,h,this.parameters.screenSizePerspective),(0,di.g)(u,u,c),(0,di.S)(Wl,u,r.transform.inverseRotation),i=(0,di.e)(Vl,i,Wl),a=(0,di.e)(Gl,a,Wl)}Ns(e,t,r,i,a,(0,Bi.y)(r.verticalOffset),o)}},{key:"requiresSlot",value:function(e,t){return(t===yo.Color||t===yo.Alpha||t===yo.Depth||t===yo.Normal||t===yo.Shadow||t===yo.ShadowHighlight||t===yo.ShadowExludeHighlight||t===yo.Highlight||t===yo.ObjectAndLayerIdColor)&&(e===(this.parameters.transparent?this.parameters.writeDepth?so.TRANSPARENT_MATERIAL:so.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:so.OPAQUE_MATERIAL)||e===so.DRAPED_MATERIAL||t===yo.ObjectAndLayerIdColor)}},{key:"createGLMaterial",value:function(e){return new Nl(e)}},{key:"createBufferWriter",value:function(){return new zl(this._vertexBufferLayout,this._instanceBufferLayout)}}]),n}(tu),Nl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(e){return(0,ii.Z)(this,n),t.call(this,(0,Xr.Z)((0,Xr.Z)({},e),e.material.parameters))}return(0,ri.Z)(n,[{key:"_updateParameters",value:function(e){var t=this._material.parameters;this.updateTexture(t.textureId);var n=e.camera.viewInverseTransposeMatrix;return(0,di.o)(t.origin,n[3],n[7],n[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?Il:Pl,e)}},{key:"_updateShadowState",value:function(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==yo.Color&&this._output!==yo.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this._updateParameters(e)}}]),n}(Xa),Dl=function(e){(0,Jr.Z)(n,e);var t=(0,ei.Z)(n);function n(){var e;return(0,ii.Z)(this,n),(e=t.apply(this,arguments)).initTextureTransparent=!1,e.treeRendering=!1,e.hasVertexTangents=!1,e}return(0,ri.Z)(n)}(Cl),kl=new Dl,zl=function(){function e(t,n){(0,ii.Z)(this,e),this.vertexBufferLayout=t,this.instanceBufferLayout=n}return(0,ri.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(Ci.O.POSITION).length}},{key:"write",value:function(e,t,n,r,i){fu(n,this.vertexBufferLayout,e,t,r,i)}}]),e}();function Bl(e){var t=(0,ki.T)();return t=e.instancedDoublePrecision?t.vec3f(Ci.O.MODELORIGINHI).vec3f(Ci.O.MODELORIGINLO).mat3f(Ci.O.MODEL).mat3f(Ci.O.MODELNORMAL):t.mat4f(Ci.O.MODEL).mat4f(Ci.O.MODELNORMAL),(0,oi.r)(e.instanced)&&e.instanced.includes("color")&&(t=t.vec4f(Ci.O.INSTANCECOLOR)),(0,oi.r)(e.instanced)&&e.instanced.includes("featureAttribute")&&(t=t.vec4f(Ci.O.INSTANCEFEATUREATTRIBUTE)),(0,oi.r)(e.instanced)&&e.instanced.includes("objectAndLayerIdColor")&&(t=t.vec4u8(Ci.O.OBJECTANDLAYERIDCOLOR_INSTANCED)),t}var Vl=(0,di.n)(),Gl=(0,di.n)(),Ul=(0,di.c)(0,0,1),Hl=(0,di.n)(),Wl=(0,di.n)(),ql=(0,di.n)(),jl=(0,di.n)();function Xl(e){if((0,oi.t)(e))return null;var t=(0,oi.r)(e.offset)?e.offset:gi.c,n=(0,oi.r)(e.rotation)?e.rotation:0,r=(0,oi.r)(e.scale)?e.scale:gi.i,i=(0,pi.t)(1,0,0,0,1,0,t[0],t[1],1),a=(0,pi.t)(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=(0,pi.t)(r[0],0,0,0,r[1],0,0,0,1),s=(0,pi.e)();return(0,si.i)(s,a,o),(0,si.i)(s,i,s),s}var Yl=(0,ri.Z)((function e(t,n,r,i,a){(0,ii.Z)(this,e),this.name=t,this.stageResources=n,this.lodThreshold=r,this.pivotOffset=i,this.numberOfVertices=a})),Kl=yi.a.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function Ql(e,t){return $l.apply(this,arguments)}function $l(){return $l=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n){var r,i,a,o,s;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jl(t,n);case 2:return r=e.sent,e.next=5,sd(r.textureDefinitions,n);case 5:for(o in i=e.sent,a=0,i)i.hasOwnProperty(o)&&(s=i[o],a+=null!==s&&void 0!==s&&s.image?s.image.width*s.image.height*4:0);return e.abrupt("return",{resource:r,textures:i,size:a+(0,bi.e)(r)});case 9:case"end":return e.stop()}}),e)}))),$l.apply(this,arguments)}function Jl(e,t){return ed.apply(this,arguments)}function ed(){return ed=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n){var r,i;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=(0,oi.r)(n)&&n.streamDataRequester)){e.next=3;break}return e.abrupt("return",td(t,r,n));case 3:return e.next=5,(0,_i.b)((0,xi.U)(t,(0,oi.e)(n)));case 5:if(!0!==(i=e.sent).ok){e.next=8;break}return e.abrupt("return",i.value.data);case 8:(0,yi.w)(i.error),rd(i.error);case 9:case"end":return e.stop()}}),e)}))),ed.apply(this,arguments)}function td(e,t,n){return nd.apply(this,arguments)}function nd(){return nd=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n,r){var i;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_i.b)(n.request(t,"json",r));case 2:if(!0!==(i=e.sent).ok){e.next=5;break}return e.abrupt("return",i.value);case 5:(0,yi.w)(i.error),rd(i.error.details.url);case 6:case"end":return e.stop()}}),e)}))),nd.apply(this,arguments)}function rd(e){throw new yi.s("","Request for object resource failed: ".concat(e))}function id(e){var t=e.params,n=t.topology,r=!0;switch(t.vertexAttributes||(Kl.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var i=t.faces;if(i){if(t.vertexAttributes)for(var a in t.vertexAttributes){var o=i[a];o&&o.values?(null!=o.valueType&&"UInt32"!==o.valueType&&(Kl.warn("Unsupported indexed geometry indices type '".concat(o.valueType,"', only UInt32 is currently supported")),r=!1),null!=o.valuesPerElement&&1!==o.valuesPerElement&&(Kl.warn("Unsupported indexed geometry values per element '".concat(o.valuesPerElement,"', only 1 is currently supported")),r=!1)):(Kl.warn("Indexed geometry does not specify face indices for '".concat(a,"' attribute")),r=!1)}}else Kl.warn("Indexed geometries must specify faces"),r=!1;break;default:Kl.warn("Unsupported topology '".concat(n,"'")),r=!1}e.params.material||(Kl.warn("Geometry requires material"),r=!1);var s=e.params.vertexAttributes;for(var u in s)s[u].values||(Kl.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function ad(e,t){var n=[],r=[],i=[],a=[],o=e.resource,s=Ti.r.parse(o.version||"1.0","wosr");dd.validate(s);for(var u=o.model.name,c=o.model.geometries,l=o.materialDefinitions,d=e.textures,f=0,h=new Map,v=0;v<c.length;v++){var m=c[v];if(id(m)){var p=ld(m),g=m.params.vertexAttributes,x=[];for(var _ in g){var b=g[_],y=b.values;x.push([_,{data:y,size:b.valuesPerElement,exclusive:!0}])}var T=[];if("PerAttributeArray"!==m.params.topology){var w=m.params.faces;for(var S in w)T.push([S,w[S].values])}var O=d&&d[p.texture];if(O&&!h.has(p.texture)){var A=O.image,C=O.params,M=new zu(A,C);a.push(M),h.set(p.texture,M)}var P=h.get(p.texture),Z=P?P.id:void 0,E=i[p.material]?i[p.material][p.texture]:null;if(!E){var L=l[p.material.substring(p.material.lastIndexOf("/")+1)].params;1===L.transparency&&(L.transparency=0);var R=O&&O.alphaChannelUsage,I=L.transparency>0||"transparency"===R||"maskAndTransparency"===R,F=O?cd(O.alphaChannelUsage):void 0,N={ambient:(0,di.a6)(L.diffuse),diffuse:(0,di.a6)(L.diffuse),opacity:1-(L.transparency||0),transparent:I,textureAlphaMode:F,textureAlphaCutoff:.33,textureId:Z,initTextureTransparent:!0,doubleSided:!0,cullFace:Si.n.None,colorMixMode:L.externalColorMixMode||"tint",textureAlphaPremultiplied:!!O&&!!O.params.preMultiplyAlpha};(0,oi.r)(t)&&t.materialParamsMixin&&Object.assign(N,t.materialParamsMixin),E=new Fl(N),i[p.material]||(i[p.material]={}),i[p.material][p.texture]=E}r.push(E);var D=new ss(x,T);f+=T.position?T.position.length:0,n.push(D)}}return{engineResources:[{name:u,stageResources:{textures:a,materials:r,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:od(n)}}function od(e){var t=(0,fi.A)();return e.forEach((function(e){var n=e.boundingInfo;(0,oi.r)(n)&&((0,fi.c)(t,n.getBBMin()),(0,fi.c)(t,n.getBBMax()))})),t}function sd(e,t){return ud.apply(this,arguments)}function ud(){return ud=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n){var r,i,a,o,s,u,c,l;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],i=function(e){var i=t[e],a=i.images[0].data;if(!a)return Kl.warn("Externally referenced texture data is not yet supported"),"continue";var o=i.encoding+";base64,"+a,s="/textureDefinitions/"+e,u="rgba"===i.channels?i.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:Ri.D.REPEAT,t:Ri.D.REPEAT},preMultiplyAlpha:cd(u)!==Si.C.Opaque},l=(0,oi.r)(n)&&n.disableTextures?Promise.resolve(null):(0,wi.t)(o,n);r.push(l.then((function(e){return{refId:s,image:e,params:c,alphaChannelUsage:u}})))},e.t0=(0,Kr.Z)().keys(t);case 3:if((e.t1=e.t0()).done){e.next=10;break}if(a=e.t1.value,"continue"!==i(a)){e.next=8;break}return e.abrupt("continue",3);case 8:e.next=3;break;case 10:return e.next=12,Promise.all(r);case 12:o=e.sent,s={},u=(0,$r.Z)(o);try{for(u.s();!(c=u.n()).done;)l=c.value,s[l.refId]=l}catch(d){u.e(d)}finally{u.f()}return e.abrupt("return",s);case 17:case"end":return e.stop()}}),e)}))),ud.apply(this,arguments)}function cd(e){switch(e){case"mask":return Si.C.Mask;case"maskAndTransparency":return Si.C.MaskBlend;case"none":return Si.C.Opaque;default:return Si.C.Blend}}function ld(e){var t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}var dd=new Ti.r(1,2,"wosr");function fd(e,t){return hd.apply(this,arguments)}function hd(){return hd=(0,Qr.Z)((0,Kr.Z)().mark((function e(t,n){var r,i,a,o,s,u,c,l,d,f,h,v,m;return(0,Kr.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("wosr"!==(r=vd((0,ai.a)(t))).fileType){e.next=9;break}return e.next=4,n.cache?n.cache.loadWOSR(r.url,n):Ql(r.url,n);case 4:return i=e.sent,a=ad(i,n),o=a.engineResources,s=a.referenceBoundingBox,e.abrupt("return",{lods:o,referenceBoundingBox:s,isEsriSymbolResource:!1,isWosr:!0});case 9:return e.next=11,n.cache?n.cache.loadGLTF(r.url,n,n.usePBR):(0,mi.m)(new mi.n(n.streamDataRequester),r.url,n,n.usePBR);case 11:return u=e.sent,c=(0,oi.q)(u.model.meta,"ESRI_proxyEllipsoid"),(l=u.meta.isEsriSymbolResource&&(0,oi.r)(c)&&u.meta.uri.includes("/RealisticTrees/"))&&!u.customMeta.esriTreeRendering&&(u.customMeta.esriTreeRendering=!0,gd(u,c)),d=u.meta.isEsriSymbolResource?{usePBR:n.usePBR,isSchematic:!1,treeRendering:l,mrrFactors:[0,1,.2]}:{usePBR:n.usePBR,isSchematic:!1,treeRendering:!1,mrrFactors:[0,1,.5]},f=(0,Xr.Z)((0,Xr.Z)({},n.materialParamsMixin),{},{treeRendering:l}),h=md(u,d,f,n.skipHighLods&&null==r.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:r.specifiedLodIndex}),v=h.engineResources,m=h.referenceBoundingBox,e.abrupt("return",{lods:v,referenceBoundingBox:m,isEsriSymbolResource:u.meta.isEsriSymbolResource,isWosr:!1});case 17:case"end":return e.stop()}}),e)}))),hd.apply(this,arguments)}function vd(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function md(e,t,n,r){var i=e.model,a=new Array,o=new Map,s=new Map,u=i.lods.length,c=(0,fi.A)();return i.lods.forEach((function(e,l){var d=!0===r.skipHighLods&&(u>1&&0===l||u>3&&1===l)||!1===r.skipHighLods&&null!=r.singleLodIndex&&l!==r.singleLodIndex;if(!d||0===l){var f=new Array,h=0;if(e.parts.forEach((function(e){var t=function(e){var t=function(e,t){switch(t){case Ri.E.TRIANGLES:return(0,mi.g)(e);case Ri.E.TRIANGLE_STRIP:return(0,mi.f)(e);case Ri.E.TRIANGLE_FAN:return(0,mi.i)(e)}}(e.indices||e.attributes.position.count,e.primitiveType),n=e.attributes.position.count,r=(0,mi.r)(hi.i,n);(0,vi.t)(r,e.attributes.position,e.transform);var i=[[Ci.O.POSITION,{data:r.typedBuffer,size:r.elementCount,exclusive:!0}]],a=[[Ci.O.POSITION,t]];if((0,oi.r)(e.attributes.normal)){var o=(0,mi.r)(hi.i,n);(0,si.g)(pd,e.transform),(0,vi.r)(o,e.attributes.normal,pd),i.push([Ci.O.NORMAL,{data:o.typedBuffer,size:o.elementCount,exclusive:!0}]),a.push([Ci.O.NORMAL,t])}if((0,oi.r)(e.attributes.tangent)){var s=(0,mi.r)(hi.c,n);(0,si.g)(pd,e.transform),(0,mi.b)(s,e.attributes.tangent,pd),i.push([Ci.O.TANGENT,{data:s.typedBuffer,size:s.elementCount,exclusive:!0}]),a.push([Ci.O.TANGENT,t])}if((0,oi.r)(e.attributes.texCoord0)){var u=(0,mi.r)(hi.u,n);(0,mi.c)(u,e.attributes.texCoord0),i.push([Ci.O.UV0,{data:u.typedBuffer,size:u.elementCount,exclusive:!0}]),a.push([Ci.O.UV0,t])}if((0,oi.r)(e.attributes.color)){var c=(0,mi.r)(hi.x,n);if(4===e.attributes.color.elementCount)e.attributes.color instanceof hi.c?(0,mi.d)(c,e.attributes.color,255):e.attributes.color instanceof hi.x?(0,mi.e)(c,e.attributes.color):e.attributes.color instanceof hi.L&&(0,mi.d)(c,e.attributes.color,1/256);else{(0,mi.t)(c,255,255,255,255);var l=new hi.O(c.buffer,0,4);e.attributes.color instanceof hi.i?(0,vi.f)(l,e.attributes.color,255):e.attributes.color instanceof hi.O?(0,vi.e)(l,e.attributes.color):e.attributes.color instanceof hi.E&&(0,vi.f)(l,e.attributes.color,1/256)}i.push([Ci.O.COLOR,{data:c.typedBuffer,size:c.elementCount,exclusive:!0}]),a.push([Ci.O.COLOR,t])}return{geometry:new ss(i,a),vertexCount:n}}(e),n=t.geometry,r=t.vertexCount;f.push(n),h+=r;var i=n.boundingInfo;(0,oi.r)(i)&&0===l&&((0,fi.c)(c,i.getBBMin()),(0,fi.c)(c,i.getBBMax()))})),!d){var v=new Yl(e.name,{textures:new Array,materials:new Array,geometries:f},e.lodThreshold,[0,0,0],h);a.push(v),e.parts.forEach((function(e){var r=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),a=i.materials.get(e.material),u=(0,oi.r)(e.attributes.texCoord0),c=(0,oi.r)(e.attributes.normal);if(!(0,oi.t)(a)){var l=function(e){switch(e){case"BLEND":return Si.C.Blend;case"MASK":return Si.C.Mask;case"OPAQUE":case null:case void 0:return Si.C.Opaque}}(a.alphaMode);if(!o.has(r)){if(u){var d=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if((0,oi.r)(e)&&!s.has(e)){var n=i.textures.get(e);(0,oi.r)(n)&&s.set(e,new zu(n.data,t?(0,Xr.Z)((0,Xr.Z)({},n.parameters),{},{preMultiplyAlpha:t}):n.parameters))}};d(a.textureColor,l!==Si.C.Opaque),d(a.textureNormal),d(a.textureOcclusion),d(a.textureEmissive),d(a.textureMetallicRoughness)}var f=Math.pow(a.color[0],1/mi.o),h=Math.pow(a.color[1],1/mi.o),m=Math.pow(a.color[2],1/mi.o),p=Math.pow(a.emissiveFactor[0],1/mi.o),g=Math.pow(a.emissiveFactor[1],1/mi.o),x=Math.pow(a.emissiveFactor[2],1/mi.o),_=(0,oi.r)(a.textureColor)&&u?s.get(a.textureColor):null;o.set(r,new Fl((0,Xr.Z)((0,Xr.Z)({},t),{},{transparent:l===Si.C.Blend,customDepthTest:Si.m.Lequal,textureAlphaMode:l,textureAlphaCutoff:a.alphaCutoff,diffuse:[f,h,m],ambient:[f,h,m],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?Si.n.None:Si.n.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normals:c?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:(0,oi.r)(_)?_.id:void 0,colorMixMode:a.colorMixMode,normalTextureId:(0,oi.r)(a.textureNormal)&&u?s.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:(0,oi.r)(_)&&!!_.params.preMultiplyAlpha,occlusionTextureId:(0,oi.r)(a.textureOcclusion)&&u?s.get(a.textureOcclusion).id:void 0,emissiveTextureId:(0,oi.r)(a.textureEmissive)&&u?s.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:(0,oi.r)(a.textureMetallicRoughness)&&u?s.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[p,g,x],mrrFactors:[a.metallicFactor,a.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,colorTextureTransformMatrix:Xl(a.colorTextureTransform),normalTextureTransformMatrix:Xl(a.normalTextureTransform),occlusionTextureTransformMatrix:Xl(a.occlusionTextureTransform),emissiveTextureTransformMatrix:Xl(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:Xl(a.metallicRoughnessTextureTransform)},n)))}if(v.stageResources.materials.push(o.get(r)),u){var b=function(e){(0,oi.r)(e)&&v.stageResources.textures.push(s.get(e))};b(a.textureColor),b(a.textureNormal),b(a.textureOcclusion),b(a.textureEmissive),b(a.textureMetallicRoughness)}}}))}}})),{engineResources:a,referenceBoundingBox:c}}var pd=(0,ui.e)();function gd(e,t){for(var n=0;n<e.model.lods.length;++n){var r,i=e.model.lods[n],a=(0,$r.Z)(i.parts);try{for(a.s();!(r=a.n()).done;){var o=r.value,s=o.attributes.normal;if((0,oi.t)(s))return;for(var u=o.attributes.position,c=u.count,l=(0,di.n)(),d=(0,di.n)(),f=(0,di.n)(),h=(0,mi.r)(hi.x,c),v=(0,mi.r)(hi.i,c),m=(0,ci.h)((0,li.e)(),o.transform),p=0;p<c;p++){u.getVec(p,d),s.getVec(p,l),(0,di.O)(d,d,o.transform),(0,di.e)(f,d,t.center),(0,di.ag)(f,f,t.radius);var g=f[2],x=(0,di.s)(f),_=Math.min(.45+.55*x*x,1);(0,di.ag)(f,f,t.radius),null!==m&&(0,di.O)(f,f,m),(0,di.z)(f,f),n+1!==e.model.lods.length&&e.model.lods.length>1&&(0,di.A)(f,f,l,g>-1?.2:Math.min(-4*g-3.8,1)),v.setVec(p,f),h.set(p,0,255*_),h.set(p,1,255*_),h.set(p,2,255*_),h.set(p,3,255)}o.attributes.normal=v,o.attributes.color=h}}catch(b){a.e(b)}finally{a.f()}}}var xd=Object.freeze({__proto__:null,fetch:fd,gltfToEngineResources:md,parseUrl:vd})},95414:function(e,t,n){n.d(t,{t:function(){return s}});var r=n(74165),i=n(1413),a=n(15861),o=n(40558);function s(e,t){return u.apply(this,arguments)}function u(){return u=(0,a.Z)((0,r.Z)().mark((function e(t,n){var a,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.U)(t,(0,i.Z)({responseType:"image"},n));case 2:return a=e.sent,s=a.data,e.abrupt("return",s);case 5:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},20846:function(e,t,n){n.d(t,{L:function(){return Z},V:function(){return M},a:function(){return F},c:function(){return R},f:function(){return I},j:function(){return E},l:function(){return N},p:function(){return D},u:function(){return g},y:function(){return A}});var r=n(15671),i=n(43144),a=n(93661),o=n(26313),s=n(37077),u=n(79557),c=n(49228),l=n(67430),d=n(76291),f=n(71802),h=n(87424),v=n(64772),m=n(87750),p=n(10464),g=function(){function e(){(0,r.Z)(this,e),this._transform=(0,c.e)(),this._transformInverse=new x({value:this._transform},u.h,c.e),this._transformInverseTranspose=new x(this._transformInverse,u.o,c.e),this._transformTranspose=new x({value:this._transform},u.o,c.e),this._transformInverseRotation=new x({value:this._transform},o.y,s.e)}return(0,i.Z)(e,[{key:"_invalidateLazyTransforms",value:function(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}},{key:"transform",get:function(){return this._transform}},{key:"inverse",get:function(){return this._transformInverse.value}},{key:"inverseTranspose",get:function(){return this._transformInverseTranspose.value}},{key:"inverseRotation",get:function(){return this._transformInverseRotation.value}},{key:"transpose",get:function(){return this._transformTranspose.value}},{key:"setTransformMatrix",value:function(e){(0,u.n)(this._transform,e)}},{key:"multiplyTransform",value:function(e){(0,u.u)(this._transform,this._transform,e)}},{key:"set",value:function(e){(0,u.n)(this._transform,e),this._invalidateLazyTransforms()}},{key:"setAndInvalidateLazyTransforms",value:function(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}}]),e}(),x=function(){function e(t,n,i){(0,r.Z)(this,e),this._original=t,this._update=n,this._dirty=!0,this._transform=i()}return(0,i.Z)(e,[{key:"invalidate",value:function(){this._dirty=!0}},{key:"value",get:function(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}}]),e}(),_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,r.Z)(this,e),this.offset=t,this.tmpVertex=(0,f.n)()}return(0,i.Z)(e,[{key:"applyToVertex",value:function(e,t,n){var r=e+this.localOrigin[0],i=t+this.localOrigin[1],a=n+this.localOrigin[2],o=this.offset/Math.sqrt(r*r+i*i+a*a);return this.tmpVertex[0]=e+r*o,this.tmpVertex[1]=t+i*o,this.tmpVertex[2]=n+a*o,this.tmpVertex}},{key:"applyToAabb",value:function(e){for(var t=this,n=0;n<3;++n)b[n]=e[0+n]+this.localOrigin[n],y[n]=e[3+n]+this.localOrigin[n],T[n]=b[n];for(var r=this.applyToVertex(b[0],b[1],b[2]),i=0;i<3;++i)e[i]=r[i],e[i+3]=r[i];for(var a=function(n){for(var r=t.applyToVertex(n[0],n[1],n[2]),i=0;i<3;++i)e[i+0]=Math.min(e[i+0],r[i]),e[i+3]=Math.max(e[i+3],r[i])},o=1;o<8;++o){for(var s=0;s<3;++s)T[s]=0==(o&1<<s)?b[s]:y[s];a(T)}for(var u=0,c=0;c<3;++c)b[c]*y[c]<0&&(u|=1<<c);if(0!==u&&7!==u)for(var l=0;l<8;++l)if(0==(u&l)){for(var d=0;d<3;++d)u[d]?T[d]=0:T[d]=0!=(l&1<<d)?b[d]:y[d];a(T)}for(var f=0;f<3;++f)e[f+0]-=this.localOrigin[f],e[f+3]-=this.localOrigin[f];return e}}]),e}(),b=(0,f.n)(),y=(0,f.n)(),T=(0,f.n)(),w=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,r.Z)(this,e),this.componentLocalOriginLength=0,this._tmpVertex=(0,f.n)(),this._mbs=(0,v.R)(),this._obb={center:(0,f.n)(),halfSize:(0,h.n)(),quaternion:null},this._totalOffset=0,this._offset=0,this._resetOffset(t)}return(0,i.Z)(e,[{key:"_resetOffset",value:function(e){this._offset=e,this._totalOffset=e}},{key:"offset",get:function(){return this._offset},set:function(e){this._resetOffset(e)}},{key:"componentOffset",set:function(e){this._totalOffset=this._offset+e}},{key:"localOrigin",set:function(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}},{key:"applyToVertex",value:function(e,t,n){var r=e,i=t,a=n+this.componentLocalOriginLength,o=this._totalOffset/Math.sqrt(r*r+i*i+a*a);return this._tmpVertex[0]=e+r*o,this._tmpVertex[1]=t+i*o,this._tmpVertex[2]=n+a*o,this._tmpVertex}},{key:"applyToAabb",value:function(e){var t=e[0],n=e[1],r=e[2]+this.componentLocalOriginLength,i=e[3],a=e[4],o=e[5]+this.componentLocalOriginLength,s=t*i<0?0:Math.min(Math.abs(t),Math.abs(i)),u=n*a<0?0:Math.min(Math.abs(n),Math.abs(a)),c=r*o<0?0:Math.min(Math.abs(r),Math.abs(o)),l=Math.sqrt(s*s+u*u+c*c);if(l<this._totalOffset)return e[0]-=t<0?this._totalOffset:0,e[1]-=n<0?this._totalOffset:0,e[2]-=r<0?this._totalOffset:0,e[3]+=i>0?this._totalOffset:0,e[4]+=a>0?this._totalOffset:0,e[5]+=o>0?this._totalOffset:0,e;var d=Math.max(Math.abs(t),Math.abs(i)),f=Math.max(Math.abs(n),Math.abs(a)),h=Math.max(Math.abs(r),Math.abs(o)),v=Math.sqrt(d*d+f*f+h*h),m=this._totalOffset/v,p=this._totalOffset/l;return e[0]+=t*(t>0?m:p),e[1]+=n*(n>0?m:p),e[2]+=r*(r>0?m:p),e[3]+=i*(i<0?m:p),e[4]+=a*(a<0?m:p),e[5]+=o*(o<0?m:p),e}},{key:"applyToMbs",value:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),n=this._totalOffset/t;return this._mbs[0]=e[0]+e[0]*n,this._mbs[1]=e[1]+e[1]*n,this._mbs[2]=e[2]+e[2]*n,this._mbs[3]=e[3]+e[3]*this._totalOffset/t,this._mbs}},{key:"applyToObb",value:function(e){var t=e.center,n=this._totalOffset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this._obb.center[0]=t[0]+t[0]*n,this._obb.center[1]=t[1]+t[1]*n,this._obb.center[2]=t[2]+t[2]*n,(0,f.E)(this._obb.halfSize,e.halfSize,e.quaternion),(0,f.u)(this._obb.halfSize,this._obb.halfSize,e.center);var r=this._totalOffset/Math.sqrt(this._obb.halfSize[0]*this._obb.halfSize[0]+this._obb.halfSize[1]*this._obb.halfSize[1]+this._obb.halfSize[2]*this._obb.halfSize[2]);return this._obb.halfSize[0]+=this._obb.halfSize[0]*r,this._obb.halfSize[1]+=this._obb.halfSize[1]*r,this._obb.halfSize[2]+=this._obb.halfSize[2]*r,(0,f.e)(this._obb.halfSize,this._obb.halfSize,e.center),(0,l.S)(L,e.quaternion),(0,f.E)(this._obb.halfSize,this._obb.halfSize,L),this._obb.halfSize[0]*=this._obb.halfSize[0]<0?-1:1,this._obb.halfSize[1]*=this._obb.halfSize[1]<0?-1:1,this._obb.halfSize[2]*=this._obb.halfSize[2]<0?-1:1,this._obb.quaternion=e.quaternion,this._obb}}]),e}(),S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,r.Z)(this,e),this.offset=t,this.sphere=(0,v.R)(),this.tmpVertex=(0,f.n)()}return(0,i.Z)(e,[{key:"applyToVertex",value:function(e,t,n){var r=this.objectTransform.transform,i=r[0]*e+r[4]*t+r[8]*n+r[12],a=r[1]*e+r[5]*t+r[9]*n+r[13],o=r[2]*e+r[6]*t+r[10]*n+r[14],s=this.offset/Math.sqrt(i*i+a*a+o*o);i+=i*s,a+=a*s,o+=o*s;var u=this.objectTransform.inverse;return this.tmpVertex[0]=u[0]*i+u[4]*a+u[8]*o+u[12],this.tmpVertex[1]=u[1]*i+u[5]*a+u[9]*o+u[13],this.tmpVertex[2]=u[2]*i+u[6]*a+u[10]*o+u[14],this.tmpVertex}},{key:"applyToMinMax",value:function(e,t){var n=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*n,e[1]+=e[1]*n,e[2]+=e[2]*n;var r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r}},{key:"applyToAabb",value:function(e){var t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;var n=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*n,e[4]+=e[4]*n,e[5]+=e[5]*n,e}},{key:"applyToBoundingSphere",value:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),n=this.offset/t;return this.sphere[0]=e[0]+e[0]*n,this.sphere[1]=e[1]+e[1]*n,this.sphere[2]=e[2]+e[2]*n,this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}}]),e}(),O=new S;function A(e){return(0,a.r)(e)?(O.offset=e,O):null}var C=new w;function M(e){return(0,a.r)(e)?(C.offset=e,C):null}var P=new _;function Z(e){return(0,a.r)(e)?(P.offset=e,P):null}var E="terrain",L=(0,d.e)();function R(e,t){return(0,a.t)(e)&&(e=[]),e.push(t),e}function I(e,t){if((0,a.t)(e))return null;var n=e.filter((function(e){return e!==t}));return 0===n.length?null:n}function F(e){return!!(0,a.r)(e)&&!e.visible}function N(e,t,n){var r=e.origin.vec3;(0,m.h)(B,-r[0],-r[1],-r[2]),(0,a.r)(e.transformation)?(0,u.u)(t,B,e.transformation):(0,u.n)(t,B),(0,u.h)(n,t),(0,u.o)(n,n)}function D(e,t,n,r,i){k[0]=e.get(t,0),k[1]=e.get(t,1),k[2]=e.get(t,2),(0,p.t)(k,z,3),n.set(i,0,z[0]),r.set(i,0,z[1]),n.set(i,1,z[2]),r.set(i,1,z[3]),n.set(i,2,z[4]),r.set(i,2,z[5])}var k=new Float64Array(3),z=new Float32Array(6),B=(0,c.e)()},30168:function(e,t,n){function r(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}n.d(t,{Z:function(){return r}})}}]);
//# sourceMappingURL=381.e3ac277c.chunk.js.map