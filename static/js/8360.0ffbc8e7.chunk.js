"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[8360],{28360:function(e,t,i){i.d(t,{b:function(){return Ee},j:function(){return me}});var r=i(93433),n=i(29439),a=i(97326),s=i(74165),o=i(15861),l=i(11752),h=i(61120),c=i(37762),u=i(15671),d=i(43144),p=i(60136),y=i(29388),f=i(50165),g=(i(33530),i(49350)),v=(i(97823),i(62980)),m=i(69738),b=i(73627),_=i(89354),S=i(2760),C=i(98643),x=i(9330),w=i(79146),G=i(28003),k=i(27670),E=i(35691),R=i(8180),I=i(4483),D=i(86738),O=i(50338),P=i(38419),A=i(40133),L=i(2326),U=i(43750),Z=i(5233),V=i(55985),M=i(73428),B=i(63334),F=i(44217),T=i(68634),j=i(24695),W=i(67871),Y=i(96263),z=i(77322),N=i(75272),H=v.e.fromSimpleMarkerSymbol(D.c),X=v.f.fromSimpleLineSymbol(D.u),q=v.b.fromSimpleFillSymbol(D.b),J=new v.E({symbolLayers:[new v.G({material:{color:O.e},edges:new v.H({size:"1px",color:O.i})})]});function Q(e){if((0,f.t)(e))return null;switch(e.type){case"mesh":return J;case"point":case"multipoint":return H;case"polyline":return X;case"polygon":case"extent":return q}return null}var $=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e)).events=new A.n,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.viewSpatialReference=null,r.featureAdapter={getAttribute:function(e,t){return"graphic"in e?e.graphic.attributes[t]:U.i.getAttribute(e,t)},getAttributes:function(e){return"graphic"in e?e.graphic.attributes:U.i.getAttributes(e)},getObjectId:function(e){return"graphic"in e?(0,k.O)(e.graphic,r.objectIdField):U.i.getObjectId(e)},getGeometry:function(e){return"graphic"in e?e.getAsOptimizedGeometry(r.hasZ,r.hasM):U.i.getGeometry(e)},getCentroid:function(e,t){if("graphic"in e){var i=null;(0,f.r)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&(0,C.P)(e.graphic.geometry,K,r.viewSpatialReference)&&(i=K);var n=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return(0,f.t)(i)?(n[0]=0,n[1]=0,n[2]=0,n[3]=0):(n[0]=i.x,n[1]=i.y,t.hasZ&&(n[2]=i.hasZ?i.z:0),t.hasM&&(n[t.hasZ?3:2]=i.hasM?i.m:0)),new L.t([],n)}return U.i.getCentroid(e,t)},cloneWithGeometry:function(e,t){return"graphic"in e?new L.s(t,r.featureAdapter.getAttributes(e),null,r.featureAdapter.getObjectId(e)):U.i.cloneWithGeometry(e,t)}},r}return(0,d.Z)(i,[{key:"forEachInBounds",value:function(e,t){this.getSpatialIndex().forEachInBounds(e,t)}},{key:"forEachBounds",value:function(e,t,i){var r,n=this.getSpatialIndex(),a=(0,c.Z)(e);try{for(a.s();!(r=a.n()).done;){var s=r.value,o=this.featureAdapter.getObjectId(s);(0,f.r)(n.getBounds(o,i))&&t(i)}}catch(l){a.e(l)}finally{a.f()}}}]),i}(f.y);(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"getSpatialIndex",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"toArray",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"forEach",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"hasZ",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"hasM",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"objectIdField",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"viewSpatialReference",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],$.prototype,"featureSpatialReference",void 0),$=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],$);var K={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},ee=(0,d.Z)((function e(t){(0,u.Z)(this,e),this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1})),te=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e,r,n){var a;return(0,u.Z)(this,i),(a=t.call(this,e,r,n)).calloutSymbolLayer=null,a.symbol.hasVisibleCallout()&&(a.calloutSymbolLayer=(0,E.b)(a.symbol,r)),a}return(0,d.Z)(i,[{key:"doLoad",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var r,n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.calloutSymbolLayer?(0,Z.a)(this.calloutSymbolLayer.load()):null,e.prev=1,e.next=4,(0,l.Z)((0,h.Z)(i.prototype),"doLoad",this).call(this,t);case 4:(0,f.W)(t),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(1),null!==(n=this.calloutSymbolLayer)&&void 0!==n&&n.abortLoad(),e.t0;case 10:if(e.t1=r,!e.t1){e.next=14;break}return e.next=14,r;case 14:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,l.Z)((0,h.Z)(i.prototype),"destroy",this).call(this),this.calloutSymbolLayer=(0,f.G)(this.calloutSymbolLayer)}},{key:"createGraphics3DGraphic",value:function(e,t){var r=(0,l.Z)((0,h.Z)(i.prototype),"createGraphics3DGraphic",this).call(this,e,t);if((0,f.r)(this.calloutSymbolLayer)&&(0,f.r)(r)){var n=this._createCalloutGraphic(e);(0,f.r)(n)&&r.addAuxiliaryGraphic(n)}return r}},{key:"globalPropertyChanged",value:function(e,t){var r=this;return!!(0,l.Z)((0,h.Z)(i.prototype),"globalPropertyChanged",this).call(this,e,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(e,t,(function(e){return r._getCalloutGraphicLayer(e)})))}},{key:"updateGeometry",value:function(e,t){var r=(0,l.Z)((0,h.Z)(i.prototype),"updateGeometry",this).call(this,e,t);if(r&&this.calloutSymbolLayer){var n=this._getCalloutGraphicLayer(e);if(n)return this.calloutSymbolLayer.updateGeometry(n,t)}return r}},{key:"_createCalloutGraphic",value:function(e){var t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)}},{key:"_getCalloutGraphicLayer",value:function(e){var t,i=(0,c.Z)(e._auxiliaryGraphics);try{for(i.s();!(t=i.n()).done;){var r=t.value;if(r.graphics3DSymbolLayer===this.calloutSymbolLayer)return r}}catch(n){i.e(n)}finally{i.f()}}}]),i}(E.d);var ie=function(){function e(t){var i=this;(0,u.Z)(this,e),this.graphicsCore=t,this.idToState=new Map,this.states=new Set;var r=t.owner.layer&&t.owner.layer.objectIdField;r?(this.getGraphicId=function(e){return(0,k.O)(e,r)},this.getGraphics3DGraphicById=function(e){return i.graphicsCore.getGraphics3DGraphicByObjectId(e)}):(this.getGraphicId=function(e){return e.uid},this.getGraphics3DGraphicById=function(e){return i.graphicsCore.getGraphics3DGraphicById(e)})}return(0,d.Z)(e,[{key:"destroy",value:function(){var e=this;this.idToState.clear(),this.states.forEach((function(t,i){return e.remove(i)}))}},{key:"add",value:function(e){var t=this,i={remove:function(){return t.remove(e)}};if(this.states.has(e))return i;var r=this.getGraphicId(e.graphic),n=this.getGraphics3DGraphicById(r);return this.states.has(e)||this.states.add(e),this._ensureStateList(r).push(e),e.displaying=!!(0,f.r)(n)&&n.isVisible(),e.isDraped=!!(0,f.r)(n)&&n.isDraped,e.tracking=!0,(0,f.r)(n)&&e.emit("changed",{}),i}},{key:"remove",value:function(e){if(this.states.has(e)){if(this.idToState.size){var t=this.getGraphicId(e.graphic),i=this.idToState.get(t);i&&((0,f.a$)(i,e),0===i.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}}},{key:"addGraphic",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}},{key:"removeGraphic",value:function(e){this._forEachState(e,(function(e){e.displaying=!1,e.isDraped=!1}))}},{key:"updateGraphicGeometry",value:function(e){this._forEachState(e,(function(e){e.emit("changed",{})}))}},{key:"updateGraphicVisibility",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible()}))}},{key:"allGraphicsDeleted",value:function(){this.states.forEach((function(e){e.displaying=!1}))}},{key:"_ensureStateList",value:function(e){var t=this.idToState.get(e);if(t)return t;var i=new Array;return this.idToState.set(e,i),i}},{key:"_forEachState",value:function(e,t){if(0!==this.states.size&&0!==this.idToState.size){var i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}}}]),e}(),re=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e))._index=new V.h(9,(0,f.c)("esri-csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),r._missing=new Set,r._boundsByFeature=new Map,r.spatialReference=null,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.updating=!1,r}return(0,d.Z)(i,[{key:"setup",value:function(e){this._addMany(e)}},{key:"destroy",value:function(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}},{key:"update",value:function(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}},{key:"updatingRemaining",get:function(){return this._missing.size}},{key:"queryGraphicUIDsInExtent",value:function(e,t,i){t.equals(this.spatialReference)&&(ne.minX=e[0],ne.minY=e[1],ne.maxX=e[2],ne.maxY=e[3],this.update(),this._index.search(ne,(function(e){return i(e.graphic.uid)})))}},{key:"add",value:function(e){this._missing.add(e),this.updating=!0}},{key:"remove",value:function(e){if(this._missing.delete(e))this.updating=this._missing.size>0;else{this._index.remove(e);var t=(0,k.O)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}}},{key:"_addMany",value:function(e){if(0!==e.length){var t,i=this._get("objectIdField"),r=(0,c.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.computeExtent(this.spatialReference);var a=(0,k.O)(n.graphic,i);null!=a&&this._boundsByFeature.set(a,n.extent)}}catch(s){r.e(s)}finally{r.f()}this._index.load(e)}}},{key:"clear",value:function(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}},{key:"forEachInBounds",value:function(e,t){ne.minX=e[0],ne.minY=e[1],ne.maxX=e[2],ne.maxY=e[3],this.update(),this._index.search(ne,(function(e){t(e)}))}},{key:"getBounds",value:function(e,t){this.update();var i=this._boundsByFeature.get(e);return i?(0,x.O)(t,i):null}}]),i}(f.y);(0,f.e)([(0,f.d)({constructOnly:!0})],re.prototype,"spatialReference",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],re.prototype,"hasZ",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],re.prototype,"hasM",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],re.prototype,"objectIdField",void 0),(0,f.e)([(0,f.d)()],re.prototype,"updating",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],re.prototype,"updatingRemaining",null),re=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.SpatialIndex2D")],re);var ne={minX:0,minY:0,maxX:0,maxY:0},ae=f.s.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider"),se=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e)).elevationOffset=0,r._layerHandes=new m.u,r}return(0,d.Z)(i,[{key:"initialize",value:function(){var e=this;this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=(0,F.g)(this.view.state.viewingMode),this.intersector.options.store=F.w.MIN;var t=this._computeLayerExtent(this.stageLayer);this.zmin=t[2],this.zmax=t[5];var i=this.stageLayer.events;this._layerHandes.add([i.on("layerObjectAdded",(function(t){return e._objectChanged(t.object)})),i.on("layerObjectRemoved",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryAdded",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryRemoved",(function(t){return e._objectChanged(t.object)})),i.on("vertexAttrsUpdated",(function(t){return e._objectChanged(t.object)})),i.on("objectTransformation",(function(t){return e._objectChanged(t)}))])}},{key:"dispose",value:function(){this._layerHandes.destroy()}},{key:"elevationInfoChanged",value:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t=(0,M.W)(this.layer.spatialReference),i=(0,B.r)(e.unit);this.elevationOffset=(0,f.af)(e.offset,0)*i/t}else this.elevationOffset=0}},{key:"getElevation",value:function(e,t,i,r){if(de[0]=e,de[1]=t,de[2]=i,!this.renderCoordsHelper.toRenderCoords(de,r,de))return ae.error("could not project point for elevation alignment"),null;var n=this.elevationOffset,a=this.zmin+n,s=this.zmax+n;this.renderCoordsHelper.setAltitude(pe,s,de),this.renderCoordsHelper.setAltitude(ye,a,de);return this.intersector.reset(pe,ye,null),this.intersector.intersect(this.intersectLayers,null,1,null,(function(e){return e.metadata&&e.metadata.isElevationSource})),this.intersector.results.min.getIntersectionPoint(de)?this.renderCoordsHelper.getAltitude(de):null}},{key:"_objectChanged",value:function(e){var t;if(null!==(t=e.metadata)&&void 0!==t&&t.isElevationSource&&this.spatialReference){(0,x.B)(he),e.metadata.lastValidElevationBB.isEmpty()||this._expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,he);var i=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this._expandExtent(i,r,he),(0,x.G)(he,ce),this.zmin=Math.min(this.zmin,he[2]),this.zmax=Math.max(this.zmax,he[5]),ue.extent=ce,ue.spatialReference=this.spatialReference,this.emit("elevation-change",ue),(0,S.a)(e.metadata.lastValidElevationBB.min,i),(0,S.a)(e.metadata.lastValidElevationBB.max,r)}}},{key:"_computeLayerExtent",value:function(e){var t=this;return(0,x.B)(he),e.objects.forAll((function(e){return t._expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,he)})),he}},{key:"_expandExtent",value:function(e,t,i){for(var r=0;r<8;++r)de[0]=1&r?e[0]:t[0],de[1]=2&r?e[1]:t[1],de[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(de,de,this.spatialReference),(0,x.h)(i,de);return i}}]),i}(A.n.EventedMixin(f.y));(0,f.e)([(0,f.d)({constructOnly:!0})],se.prototype,"layer",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],se.prototype,"stageLayer",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],se.prototype,"view",void 0),(0,f.e)([(0,f.d)({readOnly:!0,aliasOf:"view.spatialReference"})],se.prototype,"spatialReference",void 0),se=(0,f.e)([(0,f.n)("esri.views.3d.layers.support.StageLayerElevationProvider")],se);var oe,le,he=(0,x.B)(),ce=(0,w.D)(),ue={spatialReference:null,extent:ce,context:"scene"},de=(0,S.n)(),pe=(0,S.n)(),ye=(0,S.n)(),fe=(0,S.n)(),ge=(0,x.a)(),ve=f.s.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),me=oe=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,u.Z)(this,i),(r=t.call(this,e)).propertiesPool=new T.J({computedExtent:Y.M},(0,a.Z)(r)),r.computedExtent=null,r.currentRenderer=null,r.rendererHasGeometryOperations=!1,r.graphicStateTracking=null,r.symbolCreationContext=new ee((function(e,t){return r._frameTask.schedule(e,t)})),r.graphics3DGraphics=new Map,r.stageLayer=null,r.stage=null,r.graphicsDrapedUids=new Set,r.graphicsBySymbol=new Map,r.symbolConversionCache=new Map,r.symbols=new Map,r.graphicsWithoutSymbol=new Map,r.graphicsWaitingForSymbol=new Map,r.graphicsUpdateId=0,r._handles=new m.u,r._frameTask=W.Q,r.suspendSymbolCleanup=!1,r._viewSpatialReference=null,r.arcadeOnDemand=null,r.rendererChangeAbortController=null,r.elevationInfoChangeAbortController=null,r.setupAbortController=null,r.elevationAlignment=null,r.scaleVisibility=null,r._spatialIndex=null,r.extentPadding=0,r._updatingPendingLoadedGraphicsChange=null,r.featureStore=null,r.deconflictor=null,r.labeler=null,r.objectStates=null,r.viewElevationProvider=null,r.stageLayerElevationProvider=null,r.sharedSymbolResourcesOwnerHandle=null,r.whenGraphics3DGraphicRequests={},r.pendingUpdates=new Map,r.numberOfGraphics=0,r.numberOfGraphicsProvidingElevation=0,r.pendingAdds=0,r.pendingRemoves=0,r._loadingSymbols=0,r.pendingUpdatesPool=new f.ay({allocator:function(e){return e||new be},deallocator:function(e){return e.clear(),e}}),r.symbolWarningLogged=!1,r.geometryWarningLogged=!1,r.objectIdInvisibleSet=new Set,r._whenSymbolRemoved=new f.ay,r.preferredUpdatePolicy=j.o.SYNC,r.forcedUpdatePolicy=null,r.elevationFeatureExpressionEnabled=!0,r.owner=null,r.layer=null,r.graphicSymbolSupported=!0,r.getRenderingInfoWithoutRenderer=!1,r.hasZ=null,r.hasM=null,r._usedMemory=0,r._visible=void 0,r._startCreateGraphics=!1,r}return(0,d.Z)(i,[{key:"spatialIndex",get:function(){var e;return this._spatialIndex||(this._spatialIndex=new re({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}},{key:"effectiveUpdatePolicy",get:function(){return(0,f.r)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?j.o.ASYNC:(0,f.af)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"updating",get:function(){var e;return!!(this.graphicsWaitingForSymbol.size>0||this.running||null!==(e=this.elevationAlignment)&&void 0!==e&&e.updating||(0,f.r)(this.scaleVisibility)&&this.scaleVisibility.updating||(0,f.r)(this.filterVisibility)&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}},{key:"running",get:function(){var e;return this.pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var e;return this.owner.suspended||(null===(e=this.owner.suspendInfo)||void 0===e?void 0:e.outsideOfView)}},{key:"updatingRemaining",get:function(){var e,t;return this.updating?this.pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this.elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.averageSymbolComplexity,a=Math.max(1,(0,f.r)(n)?n.primitivesPerFeature:1),s=(0,f.r)(n)&&n.drawCallsPerFeature>0?i/n.drawCallsPerFeature*.3:i,o=Math.ceil(r/a),l=Math.max(t,Math.min(i,o,s)),h=this._get("displayFeatureLimit");return h&&h.minimumTotalNumberOfFeatures===t&&h.maximumTotalNumberOfFeatures===i&&h.maximumTotalNumberOfPrimitives===r&&h.averageSymbolComplexity===n&&h.maximumNumberOfFeatures===l?h:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:n,maximumNumberOfFeatures:l}}},{key:"averageSymbolComplexity",get:function(){var e=(0,E.y)(this.symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||(0,f.r)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}},{key:"usedMemory",get:function(){var e=(0,f.r)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}},{key:"usedMemoryPerGraphic",get:function(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if((0,f.r)(this.averageSymbolComplexity)){var e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"_getConvertedSymbol",value:function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if((0,f.r)(t))return t;var i=(0,P.a)(e,{retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=i.symbol||null;return(0,f.t)(r)&&i.error&&ve.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}},{key:"_getSymbolComplexitiesUsedOrRenderer",value:function(e){if((0,f.t)(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],n=this._getSymbolComplexityUsedOrRenderer(i);(0,f.r)(n)&&r.push(n);var a,s=(0,c.Z)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value,l=this._getSymbolComplexityUsedOrRenderer(o);(0,f.r)(l)&&r.push(l)}}catch(h){s.e(h)}finally{s.f()}return r}},{key:"_getSymbolComplexityUsedOrRenderer",value:function(e){if((0,f.t)(e))return null;var t=this.symbols.get(e.id);if((0,f.r)(t))return t.complexity;var i=this._getConvertedSymbol(e);return(0,f.r)(i)?(0,E.P)(i):null}},{key:"_getSymbolComplexitiesUsed",value:function(){var e=[];return this.symbols.forEach((function(t){(0,f.r)(t)&&e.push(t.complexity)})),e}},{key:"initialize",value:function(){var e=this;this._viewSpatialReference=this.owner.view.spatialReference,this._set("featureStore",new $({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:function(){return e.spatialIndex},forEach:function(t){return e.graphics3DGraphics.forEach(t)},toArray:function(){return Array.from(e.graphics3DGraphics.values())}}))}},{key:"setup",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i,r,n,a,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupAbortController=new AbortController,i=this.setupAbortController.signal,this._set("elevationAlignment",t.elevationAlignment),this._set("scaleVisibility",t.scaleVisibility),this._set("filterVisibility",t.filterVisibility),this._set("deconflictor",t.deconflictor),this._set("labeler",t.labeler),this._set("objectStates",t.objectStates),r=this.owner.view,this.viewElevationProvider=new E.n(this._viewSpatialReference,r),this._initializeStage(r,this.layer.uid),this.symbolCreationContext.sharedResources=r.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=r.sharedSymbolResources.addGraphicsOwner(this.owner),(0,f.r)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=r.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new E.j(r.renderSpatialReference),this.symbolCreationContext.elevationProvider=r.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=function(e){return o.notifyGraphicGeometryChanged(e)},this.symbolCreationContext.notifyGraphicVisibilityChanged=function(e){return o.notifyGraphicVisibilityChanged(e)},n=(0,E.o)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=8,(0,E.f)(n,this._viewSpatialReference,ve);case 8:if(this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,f.W)(i),this.symbolCreationContext.screenSizePerspectiveEnabled=r.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,!("drapeSourceType"in this.owner)){e.next=16;break}a=this.owner,this.symbolCreationContext.drapeSourceRenderer=r.basemapTerrain.overlayManager.registerGeometryDrapeSource(a),this._handles.add((0,f.p)((function(){return r.basemapTerrain.overlayManager.unregisterDrapeSource(a)})));case 16:return this._handles.add([(0,b.l)((function(){return o.suspendedOrOutsideOfView}),(function(){return o._frameTask.reschedule((function(){return o._updateLayerVisibility()}))})),(0,b.l)((function(){var e;return[null===(e=o.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,o.owner.view.screenSizePerspectiveEnabled]}),(function(){var e,t=r.screenSizePerspectiveEnabled&&o.layer.screenSizePerspectiveEnabled;t!==o.symbolCreationContext.screenSizePerspectiveEnabled&&(o.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=o.labeler)&&void 0!==e&&e.reset(),o.recreateAllGraphicsAndSymbols())})),(0,b.l)((function(){return o.owner.slicePlaneEnabled}),(function(e){return o._slicePlaneEnabledChange(!!e)})),(0,b.l)((function(){var e;return null===(e=o.owner.view.state)||void 0===e?void 0:e.pixelRatio}),(function(){return o._pixelRatioChange()})),(0,b.l)((function(){var e;return null===(e=o.owner.view.qualitySettings)||void 0===e?void 0:e.physicallyBasedRenderingEnabled}),(function(e){return o._physicalBasedRenderingChange(e)})),(0,b.f)((function(){var e;return null===(e=r.basemapTerrain)||void 0===e?void 0:e.tilingScheme}),(function(e){if(e.spatialReference.equals(o.symbolCreationContext.overlaySR)||(o.symbolCreationContext.overlaySR=r.basemapTerrain.spatialReference),o._handles.has("loaded-graphics"))o.recreateAllGraphics();else{o._handles.add([(0,b.a)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}),"change",(function(e){o._graphicsCollectionChanged(e),o._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:function(){o.recreateAllGraphics(),o._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,b.l)((function(){return o.effectiveUpdatePolicy}),(function(e){(0,f.r)(o.stageLayer)&&(o.stageLayer.updatePolicy=e),o.symbolCreationContext.isAsync=o.effectiveUpdatePolicy===j.o.ASYNC,e===j.o.SYNC&&o.runTask(W.w)}),b.w)]),this._frameTask=r.resourceController.scheduler.registerTask(W.L.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add((0,b.l)((function(){return o.layer.featureReduction}),(function(){return o.deconflictor.featureReductionChange()}))),this.notifyChange("averageSymbolComplexity"),e.prev=17,e.next=20,this.rendererChange(this.layer.renderer);case 20:e.next=24;break;case 22:e.prev=22,e.t0=e.catch(17);case 24:(0,f.W)(i),this.setupAbortController=null;case 25:case"end":return e.stop()}}),e,this,[[17,22]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_abortSetup",value:function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)}},{key:"destroy",value:function(){for(var e in this._abortSetup(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange=(0,f.z)(this._updatingPendingLoadedGraphicsChange),this.clear(),this.graphicStateTracking=(0,f.G)(this.graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,f.G)(this._handles),this._frameTask.remove(),this._frameTask=W.Q,this._viewSpatialReference=null,this._set("owner",null),this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new f.a("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=(0,f.z)(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=(0,f.G)(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=(0,f.G)(this._spatialIndex),this._set("featureStore",(0,f.G)(this.featureStore))}},{key:"clear",value:function(){var e,t;null!==(e=this.objectStates)&&void 0!==e&&e.allGraphicsDeleted(),(0,f.r)(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this.symbols.forEach(f.G),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")}},{key:"_initializeStage",value:function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new E.l({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);var r=this.stageLayer.events;r.on("objectTransformation",(function(e){return i.notifyGraphicGeometryChanged(e.metadata.graphicUid)})),r.on("visibilityChanged",(function(e){return i.notifyGraphicVisibilityChanged(e.metadata.graphicUid)})),r.on("objectGeometryAdded",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("objectGeometryRemoved",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("vertexAttrsUpdated",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)}))}},{key:"notifyGraphicGeometryChanged",value:function(e){if(!(0,f.t)(this.graphicStateTracking)&&!(0,f.t)(e)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}}},{key:"notifyGraphicVisibilityChanged",value:function(e){if(!(0,f.t)(this.graphicStateTracking)&&!(0,f.t)(e)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}}},{key:"_updateLayerVisibility",value:function(){var e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*_e,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}},{key:"_updateStageLayerVisibility",value:function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}},{key:"getGraphics3DGraphicById",value:function(e){return this.graphics3DGraphics.get(e)}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}},{key:"_getGraphicObjectID",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.owner.layer&&this.owner.layer.objectIdField;return(0,k.O)(e,t)}},{key:"graphics3DGraphicsByObjectID",get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);(0,f.r)(a)&&i.set(a,r)}})),i}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"updateLabelingInfo",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.deconflictor&&this.deconflictor.labelingInfoChange(t),r=this.labeler&&this.labeler.labelingInfoChange(t),e.next=3,(0,f.E)([i,r]);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateVisibilityInfo",value:function(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()}},{key:"symbolUpdateType",get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return(0,f.aD)(this.symbols,(function(r,n){if((0,f.r)(r)){var a=r.getFastUpdateStatus();if(a.loading>0)return!0;e.graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"}},{key:"runTask",value:function(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}},{key:"setObjectIdVisibility",value:function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);(0,f.r)(i)&&this._updateUserVisibility(i)}},{key:"_findGraphics3DGraphicByObjectId",value:function(e){var t=this;return(0,f.br)(this.graphics3DGraphics,(function(i){return t._getGraphicObjectID(i.graphic)===e}))}},{key:"_updateUserVisibility",value:function(e){if((0,f.t)(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&((0,f.t)(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(E.C.USER_SETTING,r,E.E.GRAPHIC)}},{key:"_whenGraphics3DGraphic",value:function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=(0,f.T)();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}},{key:"_boundsForGraphics3DGraphic",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r,n,a,o,l,h,c,u,d,p;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._viewSpatialReference,n=this.owner.view.renderSpatialReference,a=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return(0,C.U)(e,n,t,e,r,t,i)},l=function(e,t,i){return(0,C.U)(e,a,t,e,r,t,i)},h=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:(0,f.r)(i)&&i.useViewElevation,minDemResolution:(0,f.r)(i)&&i.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,e.next=8,t.getProjectedBoundingBox(o,l,h,(0,f.aj)(i,"signal"));case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:return u=c.boundingBox,c.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&((0,x.p)(u,fe),p=(0,f.af)(d.getElevation(fe[0],fe[1],0,r,"ground"),0),u[2]=Math.min(u[2],p),u[5]=Math.max(u[5],p)),e.abrupt("return",{boundingBox:u,screenSpaceObjects:c.screenSpaceObjects});case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"whenGraphicBounds",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r,n,a,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,b.j)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}));case 2:if(r=this.owner.layer&&this.owner.layer.objectIdField,n=this.owner.loadedGraphics.find((function(e){return e===t||r&&e.attributes&&t.attributes&&e.attributes[r]===t.attributes[r]})),n){e.next=5;break}throw new f.a("internal:graphic-not-part-of-view","Graphic is not part of this view");case 5:return e.next=7,this._whenGraphics3DGraphic(n);case 7:return a=e.sent,e.abrupt("return",this._boundsForGraphics3DGraphic(a,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,S.f)(Se,0,0,0);var a=0;if(r.render.num>0){if(!(0,C.B)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Ce,t))return null;(0,S.u)(Se,Se,Ce),a++}if(r.draped.num>0){var s=(0,n.Z)(r.draped.origin,2),o=s[0],l=s[1],h=(0,f.af)(this.viewElevationProvider.getElevation(o,l,"ground"),0);if((0,S.f)(Ce,o,l,h),!(0,C.B)(Ce,this.viewElevationProvider.spatialReference,Ce,t))return null;(0,S.u)(Se,Se,Ce),a++}return a>1&&(0,S.q)(Se,Se,1/a),new z.j({x:Se[0],y:Se[1],z:Se[2],spatialReference:t})}},{key:"getSymbolLayerSize",value:function(e,t){var i=this.symbols.get(e.id);if((0,f.t)(i))throw new f.a("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new f.a("internal:missing-symbol-layer","Symbol layer is not in symbol");var n=i.getSymbolLayerSize(r);if(null==n)throw new f.a("internal:missing-size","Symbol layer has no valid size");return n}},{key:"_graphicsCollectionChanged",value:function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}},{key:"graphicUpdateHandler",value:function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!(0,f.t)(i)||!(0,f.t)(this.graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e)}}},{key:"_graphicUpdateGeometryHandler",value:function(e,t){var i=t.graphic.geometry;if((0,f.t)(i))this._recreateGraphic(t.graphic);else if((0,f.t)(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this.symbols.get(r);if((0,f.r)(n)&&n.loadStatus===E.g.LOADING)return}this._recreateGraphic(t.graphic)}else{var a=e.graphics3DSymbol;!(0,f.t)(t.newValue)&&a.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i)}}},{key:"_graphicUpdateSymbolHandler",value:function(e,t){var i=t.graphic,r=(0,f.r)(e)?e.graphics3DSymbol:(0,f.r)(t.oldValue)?this.symbols.get(t.oldValue.id):null;if((0,f.t)(r)||(0,f.t)(t.newValue))this._recreateGraphic(i);else{var n=r.symbol,a=this._getConvertedSymbol(t.newValue);if((0,f.r)(a)&&(a.type!==n.type||"web-style"===a.type)||"web-style"===n.type)this._recreateGraphic(i);else{var s=this.graphicsBySymbol.get(n.id);if(s&&1!==s.size)this._recreateGraphic(i);else{var o=(0,_.m)(n,a);if((0,f.t)(o))this._updateSymbolMapping(n.id,a);else{var l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),(0,_.d)(l.diff)){var h=this._getRenderingInfo(i);if((0,f.t)(h))this._recreateGraphic(i);else{var u,d=r.extentPadding,p=(0,c.Z)(l.symbolStatePatches);try{for(p.s();!(u=p.n()).done;){(0,u.value)()}}catch(v){p.e(v)}finally{p.f()}if(d!==r.extentPadding&&this._recomputeExtentPadding(),(0,f.r)(e)){var y,g=(0,c.Z)(l.graphics3DGraphicPatches);try{for(g.s();!(y=g.n()).done;){(0,y.value)(e,h)}}catch(v){g.e(v)}finally{g.f()}}this._updateSymbolMapping(n.id,a)}}else this._recreateGraphic(i)}}}}}},{key:"_graphicUpdateVisibleHandler",value:function(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"_graphicUpdateTransformHandler",value:function(e,t){}},{key:"recreateGraphics",value:function(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===j.o.SYNC&&this._cleanupSymbols()}},{key:"_recreateGraphic",value:function(e){this.recreateGraphics([e])}},{key:"_beginGraphicUpdate",value:function(e){var t=this.graphicsUpdateId;return this.graphicsUpdateId++,this.graphicsWaitingForSymbol.set(e.uid,t),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}},{key:"_endGraphicUpdate",value:function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}},{key:"_recomputeExtentPadding",value:function(){var e=0;this.symbols.forEach((function(t){(0,f.r)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}},{key:"_expandComputedExtent",value:function(e){var t=ge,i=e.spatialReference;(0,k.T)(e,t);var r=this._viewSpatialReference,n=oe.tmpVec;if(i.equals(r)||(0,C.h)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],(0,C.h)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])){var a=this.computedExtent,s=null,o=isFinite(t[2])&&isFinite(t[5]),l=o&&(!a||null==a.zmin||t[2]<a.zmin),h=o&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||h)&&((s=this.propertiesPool.get("computedExtent")).xmin=Math.min(t[0],a.xmin),s.ymin=Math.min(t[1],a.ymin),s.xmax=Math.max(t[3],a.xmax),s.ymax=Math.max(t[4],a.ymax),s.spatialReference=r):((s=this.propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(l&&(s.zmin=t[2]),h&&(s.zmax=t[5]),this._set("computedExtent",s))}}},{key:"_abortElevationInfoChange",value:function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)}},{key:"elevationInfoChange",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(){var t,i,r,n,a=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._abortElevationInfoChange(),r=new AbortController,this.elevationInfoChangeAbortController=r,n=(0,E.o)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=6,(0,E.f)(n,this._viewSpatialReference,ve);case 6:this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,f.W)(r),this.elevationInfoChangeAbortController=null,null!==(t=this.labeler)&&void 0!==t&&t.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){var t,i=e.graphic,r=e.labelGraphics,n=(0,c.Z)(r);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.graphics3DSymbolLayer.updateGraphicElevationContext(i,a)}}catch(s){n.e(s)}finally{n.f()}})):a._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null===(i=this.elevationAlignment)||void 0===i||i.elevationInfoChange();case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateStageLayerElevationProvider",value:function(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new se({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))}},{key:"_clearSymbolsAndGraphics",value:function(){var e,t,i,r;this.clear(),(0,f.r)(this.filterVisibility)&&this.filterVisibility.clear(),null!==(e=this.labeler)&&void 0!==e&&e.reset(),null!==(t=this.deconflictor)&&void 0!==t&&t.clear(),null!==(i=this.elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)}},{key:"startCreateGraphics",value:function(){this._startCreateGraphics=!0,this.recreateAllGraphics()}},{key:"recreateAllGraphics",value:function(){this._recreateAllGraphics(!1)}},{key:"recreateAllGraphicsAndSymbols",value:function(){this._recreateAllGraphics(!0)}},{key:"_recreateAllGraphics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._startCreateGraphics){var t=this.owner,i=t.loadedGraphics,r=t.view,n=r.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&n||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),n&&(e?this.add(n):this.recreateGraphics(n))}}},{key:"_recreateSymbol",value:function(e){var t=this,i=this.graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var n,a=e.usedMemory;t._conditionalRemove(e,i),null!==(n=t._spatialIndex)&&void 0!==n&&n.remove(e),r.push(e.graphic),e.destroy(),t._removeGraphics3DGraphic(i,a),t._updateLayerVisibility(),t.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));var n=this.symbols.get(e);(0,f.G)(n),this.symbols.delete(e),this.add(r)}},{key:"_recreateGraphicsForSymbol",value:function(e){var t=this.graphicsBySymbol.get(e);if(t){var i=[];t.forEach((function(e){return i.push(e.graphic)})),this.recreateGraphics(i)}}},{key:"_conditionalRemove",value:function(e,t){var i,r,n;this.graphicsDrapedUids.delete(t),null!==(i=this.objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this.labeler)&&void 0!==r&&r.removeGraphic(e),null!==(n=this.deconflictor)&&void 0!==n&&n.removeGraphic(e),(0,f.r)(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)}},{key:"add",value:function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===j.o.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):ve.error("#add()","Cannot add graphics before terrain surface has been initialized"))}},{key:"_updatePolicyForGraphics",value:function(e){if(this.effectiveUpdatePolicy===j.o.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType)){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;if((0,f.r)(r.geometry)&&"mesh"===r.geometry.type&&!r.geometry.loaded)return j.o.ASYNC}}catch(n){i.e(n)}finally{i.f()}}return this.effectiveUpdatePolicy}},{key:"_addImmediate",value:function(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._addGraphic(r,this._getRenderingInfo(r,ve),j.o.SYNC)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}},{key:"_addDelayed",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this.pendingUpdates.get(n);a?a.add?a.state!==le.NEW&&a.abortController.abort():this.pendingAdds++:(a=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(n,a)),a.add=r}}catch(s){i.e(s)}finally{i.f()}this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"remove",value:function(e){this.effectiveUpdatePolicy===j.o.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}},{key:"_removeImmediate",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._removeGraphic(r)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_removeDelayed",value:function(e){var t,i=(0,c.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this.pendingUpdates.get(n);if(a)a.add&&(a.remove?a.add=null:this.pendingUpdates.delete(n),a.state===le.LOADING&&a.abortController.abort(),this.pendingAdds--);else{var s=this.pendingUpdatesPool.pushNew();s.remove=r,this.pendingUpdates.set(n,s),this.pendingRemoves++}}}catch(o){i.e(o)}finally{i.f()}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"_finishPendingUpdates",value:function(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&ve.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0}},{key:"_applyPendingUpdates",value:function(e){var t;if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)this._spatialIndex.update();else{var i,r=(0,c.Z)(this.pendingUpdates);try{for(r.s();!(i=r.n()).done;){var a=(0,n.Z)(i.value,2),s=a[0],o=a[1];if(e.done)break;o.add&&o.state===le.NEW&&this._processPendingUpdateNew(o);var l=this.effectiveUpdatePolicy;if(!o.remove||o.add&&o.state!==le.READY||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(o.remove),o.remove=null,l=j.o.SYNC),o.add)switch(o.state){case le.READY:this._addGraphic(o.add,o.renderingInfo,l),o.add=null,this.pendingAdds--,e.madeProgress();break;case le.REJECTED:o.add=null,this.pendingAdds--}null==o.remove&&null==o.add&&this.pendingUpdates.delete(s)}}catch(h){r.e(h)}finally{r.f()}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}},{key:"_processPendingUpdateNew",value:function(e){if(e.add){var t=e.add.geometry;(0,f.r)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}else e.state=le.READY}},{key:"_processPendingUpdateNewMesh",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t,i){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.state=le.LOADING,t.abortController=new AbortController,r=t.abortController.signal,e.prev=2,e.next=5,i.load({signal:r});case 5:e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(2),e.abrupt("return",this._processPendingUpdateNewError(t,e.t0));case 10:t.abortController=null,this._processPendingUpdateNewRenderingInfo(t);case 11:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_processPendingUpdateNewError",value:function(e,t){e.abortController=null,(0,f.I)(t)?e.state=le.NEW:e.state=le.REJECTED}},{key:"_processPendingUpdateNewRenderingInfo",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,f.t)(this.layer.renderer)&&"dictionary"===this.layer.renderer.type){e.next=2;break}return e.abrupt("return",(t.renderingInfo=this._getRenderingInfo(t.add,ve),void(t.state=le.READY)));case 2:return t.state=le.LOADING,t.abortController=new AbortController,i=null,e.prev=4,e.next=7,this._getRenderingInfoAsync(t.add,{signal:t.abortController.signal});case 7:i=e.sent,e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(4),e.abrupt("return",(t.abortController=null,void((0,f.I)(e.t0)?t.state=le.NEW:t.state=le.REJECTED)));case 13:(0,f.t)(i)||(0,f.t)(i.symbol)?(ve&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,ve.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),t.renderingInfo=null):t.renderingInfo=i,t.state=le.READY;case 14:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_addGraphic",value:function(e,t,i){var r=this;if(this.graphicsWithoutSymbol.set(e.uid,e),!(0,f.t)(t)&&!(0,f.t)(t.symbol)&&(0,k.M)(e)){var n=t.symbol,a=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(!(0,f.t)(a)){this._expandComputedExtent(e.geometry);var s=this._beginGraphicUpdate(e),o=new E.p(e,t,this.layer),l=!1,h=function(e){e===a.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(h);var c=function(){if(--r._loadingSymbols,!r.destroyed){if(r._whenSymbolRemoved.removeUnordered(h),r.graphicsWaitingForSymbol.get(e.uid)!==s||l||a.destroyed||r.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,r._cleanupSymbols();else{var t=r._createGraphics3DGraphic(a,o);r._spatialIndex&&(0,f.r)(t)&&r._spatialIndex.add(t),--a.referenced,r._endGraphicUpdate(e)}r.featureStore.events.emit("changed"),r.labeler&&r.owner.view.labeler.setDirty()}},u=function(t){--r._loadingSymbols,r.destroyed||(r._whenSymbolRemoved.removeUnordered(h),l||((0,f.I)(t)?r.add([e]):a.destroyed||r._endGraphicUpdate(e)))};++this._loadingSymbols,i===j.o.ASYNC?a.load((function(){return r._frameTask.schedule(c)}),(function(e){return r._frameTask.schedule((function(){return u(e)}))})):a.load(c,u)}}}},{key:"_removeGraphic",value:function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);var n=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);var s=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(s).delete(t),this.graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,n,a),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}},{key:"_hasLabelingContext",value:function(e){if(e instanceof v.i||e instanceof v.a){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1}},{key:"_hasValidSymbolCreationContext",value:function(e){return!(e instanceof v.i&&!this._hasLabelingContext(e))||(ve.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}},{key:"_getRenderingInfo",value:function(e,t){var i=e.geometry;if((0,f.t)(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,C.A)(i.spatialReference,this._viewSpatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&(0,f.r)(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r,n=this.rendererHasGeometryOperations?(0,E.c)(e,this.layer):e;return r=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,f.r)(this.currentRenderer))?this.owner.getRenderingInfo(n,this.currentRenderer,(0,f.g)(this.arcadeOnDemand)):{symbol:n.symbol||Q(n.geometry)},(0,f.t)(r)||(0,f.t)(r.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):r}},{key:"_getRenderingInfoAsync",value:function(e,t){var i=e.geometry;if((0,f.t)(i))return ve&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,ve.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&(0,f.r)(e.symbol))return ve&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,ve.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r=this.rendererHasGeometryOperations?(0,E.c)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,(0,f.g)(this.currentRenderer),(0,f.g)(this.arcadeOnDemand),t)}},{key:"_createGraphics3DSymbol",value:function(e,t){var i=this;if(!this._hasValidSymbolCreationContext(e))return null;var r,n=this._getConvertedSymbol(e);if(!n)return null;if((0,f.r)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=(0,P.a)(t.backgroundFillSymbol,{ignoreDrivers:!0});(0,f.r)(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(r=a.symbol.symbolLayers)}var s=function(e,t,i){return new("point-3d"===e.type?te:E.d)(e,t,i)}(n,this.symbolCreationContext,r);return s.load((function(){var e=s.extentPadding;e>i.extentPadding&&i._set("extentPadding",e),i.notifyChange("averageSymbolComplexity")}),(function(){})),s}},{key:"getOrCreateGraphics3DSymbol",value:function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof v.c?new E.h(e,(function(e){return i._frameTask.schedule(e)}),(function(e){return i._createGraphics3DSymbol(e,t)})):this._createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),(0,f.r)(r)&&++r.referenced,r}},{key:"trackGraphicState",value:function(e){return(0,f.t)(this.graphicStateTracking)&&(this.graphicStateTracking=new ie(this)),this.graphicStateTracking.add(e)}},{key:"_addGraphics3DGraphic",value:function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_removeGraphics3DGraphic",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_createGraphics3DGraphic",value:function(e,t){var i,r,n,a=t.graphic;if(this.graphicsWithoutSymbol.delete(a.uid),!this.symbols.has(e.symbol.id))return this.add([a]),null;if(this.graphics3DGraphics.has(a.uid))return null;var s=e.createGraphics3DGraphic(t);if((0,f.t)(s))return null;this._addGraphics3DGraphic(s);var o=e.symbol.id;this.graphicsBySymbol.has(o)||this.graphicsBySymbol.set(o,new Map),this.graphicsBySymbol.get(o).set(a.uid,s),s.isDraped&&this.graphicsDrapedUids.add(a.uid),s.centroid=null,(0,f.r)(a.geometry)&&"point"!==a.geometry.type&&(s.centroid=(0,E.w)(a.geometry,this._viewSpatialReference)),this._updateUserVisibility(s),(0,f.r)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(s),(0,f.r)(this.filterVisibility)&&this.filterVisibility.updateVisibility(s),null!==(i=this.deconflictor)&&void 0!==i&&i.addGraphic(s),null!==(r=this.labeler)&&void 0!==r&&r.addGraphic(s),null!==(n=this.objectStates)&&void 0!==n&&n.addGraphic(s),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,s),s.initialize(this.stage,this.stageLayer,this.owner),(0,f.r)(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(s);var l=this.whenGraphics3DGraphicRequests[a.uid];return l&&(delete this.whenGraphics3DGraphicRequests[a.uid],l.resolve(s)),s}},{key:"_abortRendererChange",value:function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)}},{key:"rendererChange",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(t){var i,r,n,a,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._abortRendererChange(),t===this.currentRenderer){e.next=36;break}if(this._validateRenderer(t),(0,f.t)(t)&&this._currentRendererChange(null,!1),!(0,R.o)(t)){e.next=35;break}if(!(0,f.r)(t)||!t.arcadeRequired){e.next=24;break}return i=new AbortController,this.rendererChangeAbortController=i,e.next=7,this._ensureArcade();case 7:if(r=e.sent,n=r.arcadeUtils,(0,f.W)(i),e.t0=n.hasGeometryOperations(t),!e.t0){e.next=15;break}return e.next=14,n.enableGeometryOperations();case 14:(0,f.W)(i);case 15:if(this.effectiveUpdatePolicy!==j.o.ASYNC){e.next=20;break}return e.next=18,this._frameTask.schedule((function(){return o._currentRendererChange(t,!0)}),i.signal);case 18:e.next=21;break;case 20:this._currentRendererChange(t,!0);case 21:this.rendererChangeAbortController=null,e.next=33;break;case 24:if(this.effectiveUpdatePolicy!==j.o.ASYNC){e.next=32;break}return a=new AbortController,this.rendererChangeAbortController=a,e.next=29,this._frameTask.schedule((function(){return o._currentRendererChange(t,!1)}),a.signal);case 29:this.rendererChangeAbortController=null,e.next=33;break;case 32:this._currentRendererChange(t,!1);case 33:e.next=36;break;case 35:this._currentRendererChange(t,!1);case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_ensureArcade",value:function(){var e=(0,o.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,f.t)(this.arcadeOnDemand)){e.next=7;break}return e.next=3,(0,I.a)();case 3:this.arcadeOnDemand=e.sent,e.t0=this.arcadeOnDemand,e.next=8;break;case 7:e.t0=this.arcadeOnDemand;case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_currentRendererChange",value:function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=(0,f.g)(this.arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this.symbolConversionCache.clear(),(0,f.t)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();var r=(0,_.m)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,(0,f.t)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}},{key:"_diffHasSymbolChange",value:function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}},{key:"_applySymbolSetDiff",value:function(e,t,i){var r=this;e=e||[],t=t||[];var n,a=[],s=(0,c.Z)(t);try{var o=function(){var t=n.value,s=r.graphicsBySymbol.get(t.id);s&&s.forEach((function(n,o){var l=n.graphic,h=r.layer instanceof G.b?r.layer:null,c=(0,f.g)(r.arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol((0,E.c)(l,h),{arcade:c})!==i.defaultSymbol){var u=n.usedMemory;e.length||i.defaultSymbol?a.push(l):r.graphicsWithoutSymbol.set(o,l);var d=r.graphics3DGraphics.get(o);r._conditionalRemove(d,o),n.destroy(),s.delete(o),r._removeGraphics3DGraphic(o,u),r._updateLayerVisibility()}})),r._whenSymbolRemoved.forAll((function(e){return e(t.id)}))};for(s.s();!(n=s.n()).done;)o()}catch(l){s.e(l)}finally{s.f()}(e.length||a.length)&&(this.graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this.graphicsWithoutSymbol.clear(),this.add(a)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_applyUniqueValueRendererDiff",value:function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map((function(e){return e.symbol})):[],s=n?n.removed.map((function(e){return e.symbol})):[];if(n)for(var o=0;o<n.changed.length;o++)a.push(n.changed[o].newValue.symbol),s.push(n.changed[o].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&s.push(t.defaultSymbol),this._applySymbolSetDiff(a,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}},{key:"_calculateUnchangedSymbolMapping",value:function(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||(0,f.r)(e)&&"partial"!==e.type)return[];var r,n=function(e){return(0,f.r)(e)?e.id:null},a=e&&e.diff,s=a&&a.defaultSymbol,o=a&&a.uniqueValueInfos;if(o)r=o.unchanged.map((function(e){return{oldId:n(e.oldValue.symbol),newId:n(e.newValue.symbol)}}));else{r=[];var l,h=(0,c.Z)(i.uniqueValueInfos);try{var u=function(){var e=l.value,i=n(e.symbol),a=t.uniqueValueInfos.find((function(t){return t.value===e.value}));a&&i!==n(a.symbol)&&r.push({oldId:i,newId:n(a.symbol)})};for(h.s();!(l=h.n()).done;)u()}catch(d){h.e(d)}finally{h.f()}}return!s&&i.defaultSymbol&&r.push({oldId:n(i.defaultSymbol),newId:n(t.defaultSymbol)}),r}},{key:"_updateSymbolMapping",value:function(e,t){var i=(0,f.r)(t)&&t?"string"==typeof t?t:t.id:null;if(e&&e!==i){var r=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==r&&this.graphicsBySymbol.set(i,r);var n=this.symbols.get(e);if(void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),(0,f.r)(n))){var a="string"==typeof t?null:t;(0,f.r)(a)?n.symbol=a:n.symbol.id=i}}}},{key:"_updateUnchangedSymbolMappings",value:function(e,t,i){var r,n=this._calculateUnchangedSymbolMapping(e,t,i),a=(0,c.Z)(n);try{for(a.s();!(r=a.n()).done;){var s=r.value,o=s.oldId,l=s.newId;this._updateSymbolMapping(o,l)}}catch(h){a.e(h)}finally{a.f()}}},{key:"_applyRendererDiff",value:function(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof g.P&&i instanceof g.P&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;var r,a=(0,c.Z)(this.graphicsBySymbol);try{for(a.s();!(r=a.n()).done;){var s=(0,n.Z)(r.value,1)[0],o=this.symbols.get(s);if((0,f.r)(o))switch(o.applyRendererDiff(e,t)){case E.i.Recreate_Symbol:this._recreateSymbol(s);break;case E.i.Recreate_Graphics:this._recreateGraphicsForSymbol(s)}}}catch(l){a.e(l)}finally{a.f()}return!0}},{key:"opacityChange",value:function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this._updateStageLayerVisibility()}},{key:"_slicePlaneEnabledChange",value:function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())}},{key:"_physicalBasedRenderingChange",value:function(e){var t=this;e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,i,r){e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||t._recreateSymbol(r)})))}},{key:"_pixelRatioChange",value:function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))}},{key:"_signalUpdatingDuringAsyncLoadedGraphicsChange",value:function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,f.O)((function(){e._updatingPendingLoadedGraphicsChange=null}))}},{key:"setClippingExtent",value:function(e,t){var i=this.symbolCreationContext.clippingExtent,r=(0,w.u)();return(0,E.m)(e,r,t)?this.symbolCreationContext.clippingExtent=(0,x.O)((0,x.a)(),r):this.symbolCreationContext.clippingExtent=null,!(0,x.k)(this.symbolCreationContext.clippingExtent,i)}},{key:"modifyGraphics3DGraphicVisibilities",value:function(e){var t=!1;this.graphics3DGraphics.forEach((function(i){e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"forEachGraphics3DSymbol",value:function(e){var t,i=(0,c.Z)(this.symbols);try{for(i.s();!(t=i.n()).done;){var r=(0,n.Z)(t.value,2),a=r[0],s=r[1];if((0,f.t)(s))return;e(s,this.graphicsBySymbol.get(a)||xe,a)}}catch(o){i.e(o)}finally{i.f()}}},{key:"updateAllGraphicsVisibility",value:function(){var e=this;(0,f.r)(this.filterVisibility)&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=(0,f.r)(e.scaleVisibility)&&e.scaleVisibility.updateVisibility(t);return i||r}))}},{key:"_hideAllGraphics",value:function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(E.C.USER_SETTING,!1,E.E.GRAPHIC)}))}},{key:"_validateRenderer",value:function(e){var t=(0,R.t)(e);if(t){var i="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");ve.warn(i,t.message)}}},{key:"_volatileGraphicsUpdated",value:function(){var e;null!==(e=this.labeler)&&void 0!==e&&e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}},{key:"_cleanupSymbols",value:function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)){var t=!1;this.symbols.forEach((function(i,r){if(!((0,f.t)(i)||i.referenced>0)){var n=e.graphicsBySymbol.get(r);n&&0!==n.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),(0,f.G)(i),t=!0)}})),t&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}},{key:"test",get:function(){var e=this;return{snapshotInternals:function(){return{graphics:(0,r.Z)(e.graphics3DGraphics.keys()).sort(),symbols:(0,r.Z)(e.symbols.keys()).sort(),graphicsBySymbol:(0,r.Z)(e.graphicsBySymbol.keys()).sort().map((function(t){return{symbolId:t,graphics:(0,r.Z)(e.graphicsBySymbol.get(t).keys()).sort()}})),graphicsWithoutSymbol:(0,r.Z)(e.graphicsWithoutSymbol.keys()).sort(),graphicsDrapedUids:(0,r.Z)(e.graphicsDrapedUids).sort(),pendingUpdates:e.pendingUpdates}},symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:function(t){e.forcedUpdatePolicy=t}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]),i}(f.y);me.tmpVec=(0,S.n)(),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"computedExtent",void 0),(0,f.e)([(0,f.d)()],me.prototype,"currentRenderer",void 0),(0,f.e)([(0,f.d)()],me.prototype,"rendererHasGeometryOperations",void 0),(0,f.e)([(0,f.d)()],me.prototype,"_frameTask",void 0),(0,f.e)([(0,f.d)()],me.prototype,"rendererChangeAbortController",void 0),(0,f.e)([(0,f.d)()],me.prototype,"elevationInfoChangeAbortController",void 0),(0,f.e)([(0,f.d)()],me.prototype,"setupAbortController",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"elevationAlignment",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"scaleVisibility",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"filterVisibility",void 0),(0,f.e)([(0,f.d)()],me.prototype,"_spatialIndex",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"extentPadding",void 0),(0,f.e)([(0,f.d)()],me.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"featureStore",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"deconflictor",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"labeler",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"objectStates",void 0),(0,f.e)([(0,f.d)()],me.prototype,"_loadingSymbols",void 0),(0,f.e)([(0,f.d)()],me.prototype,"preferredUpdatePolicy",void 0),(0,f.e)([(0,f.d)()],me.prototype,"forcedUpdatePolicy",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"effectiveUpdatePolicy",null),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"elevationFeatureExpressionEnabled",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"owner",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"layer",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"graphicSymbolSupported",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"updating",null),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"running",null),(0,f.e)([(0,f.d)({readOnly:!0})],me.prototype,"suspendedOrOutsideOfView",null),(0,f.e)([(0,f.d)({readOnly:!0,dependsOn:[]})],me.prototype,"updatingRemaining",null),(0,f.e)([(0,f.d)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],me.prototype,"displayFeatureLimit",null),(0,f.e)([(0,f.d)({readOnly:!0,dependsOn:[]})],me.prototype,"averageSymbolComplexity",null),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"hasZ",void 0),(0,f.e)([(0,f.d)({constructOnly:!0})],me.prototype,"hasM",void 0),me=oe=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DCore")],me),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(le||(le={}));var be=function(){function e(){(0,u.Z)(this,e),this.add=null,this.renderingInfo=null,this.state=le.NEW,this.remove=null}return(0,d.Z)(e,[{key:"clear",value:function(){this.add=null,this.renderingInfo=null,this.state=le.NEW,this.abortController=null,this.remove=null}}]),e}(),_e=10,Se=(0,S.n)(),Ce=(0,S.n)(),xe=new Map,we=function(e){(0,p.Z)(i,e);var t=(0,y.Z)(i);function i(){var e;return(0,u.Z)(this,i),(e=t.apply(this,arguments))._scaleRangeActive=!1,e.layerScaleRangeVisibilityQuery=!1,e.handles=new m.u,e.graphicsCoreOwner=null,e.layer=null,e.queryGraphicUIDsInExtent=null,e.extent=null,e.graphicsCore=null,e.basemapTerrain=null,e.layerScaleEnabled=!0,e.suspended=!1,e.updating=!0,e}return(0,d.Z)(i,[{key:"setup",value:function(e,t,i,r,n){this.graphicsCoreOwner=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=n,this.updateScaleRangeActive();var a=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(a.registerTask(W.L.SCALE_VISIBILITY,this))}},{key:"destroy",value:function(){this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}},{key:"_setDirty",value:function(){this.updating||this._set("updating",!0)}},{key:"setExtent",value:function(e){var t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this.extent=e;else{var r=(0,w.u)();(0,C.z)(e,t,r,i)?this.extent=r:this.extent=null}this._setDirty()}},{key:"scaleRangeActive",value:function(){return this._scaleRangeActive}},{key:"updateScaleRangeActive",value:function(){var e=this,t=this.layer,i=t.effectiveScaleRange,r=this.layerScaleEnabled&&Ge(i.minScale,i.maxScale);t.labelingInfo&&!r&&(r=t.labelingInfo.some((function(e){return e&&Ge(e.minScale,e.maxScale)})));var n=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.handles.has(ke)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),ke),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(function(){return e._setDirty()})),ke)):!r&&this.handles.has(ke)&&this.handles.remove(ke),n}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}},{key:"runTask",value:function(){var e=this,t=this.graphicsCoreOwner.view.basemapTerrain;if(this.extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this.layerScaleRangeVisibilityQuery){this.layerScaleRangeVisibilityQuery=!0;var i=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this.extent,i.minScale,i.maxScale,(function(t){return e._finishUpdate(t)}))}}else this._finishUpdate(!0)}},{key:"_finishUpdate",value:function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}},{key:"_visibleAtLayerScale",value:function(e){var t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,N.c)(e,t.minScale||0,t.maxScale||0)}},{key:"_visibleAtLabelScale",value:function(e,t){return(0,N.c)(e,t.minScale||0,t.maxScale||0)}},{key:"_graphicScale",value:function(e){var t;return(0,f.r)(e.centroid)?t=e.centroid:(0,f.r)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}},{key:"_graphicVisible",value:function(e){if(!this.layerScaleEnabled)return!0;var t=this._graphicScale(e);return this._visibleAtLayerScale(t)}},{key:"updateVisibility",value:function(e){if(this._scaleRangeActive){var t=this._graphicVisible(e);return e.setVisibilityFlag(E.C.SCALE_RANGE,t,E.E.GRAPHIC)}return!1}},{key:"updateGraphicLabelScaleVisibility",value:function(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}},{key:"_updateLabelScaleVisibility",value:function(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(E.C.SCALE_RANGE,r,E.E.LABEL))return!0}return!1}},{key:"_scaleUpdateHandler",value:function(e){var t=this;if(this._setDirty(),!this.graphicsCoreOwner.suspended){var i=e.extent,r=e.scale,n=this._visibleAtLayerScale(r),a=!1;this.queryGraphicUIDsInExtent(i,e.spatialReference,(function(e){var s=t.graphicsCore.getGraphics3DGraphicById(e);if(!(0,f.t)(s)){var o=s.centroid;(0,f.r)(o)&&(i[0]>o.x||i[1]>o.y||i[2]<o.x||i[3]<o.y)||(s.setVisibilityFlag(E.C.SCALE_RANGE,n,E.E.GRAPHIC)&&(a=!0),t._updateLabelScaleVisibility(s,r)&&(a=!0))}})),a&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}}},{key:"layerMinMaxScaleChangeHandler",value:function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(E.C.SCALE_RANGE)})):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}}]),i}(f.y);function Ge(e,t){return e>0||t>0}(0,f.e)([(0,f.d)({constructOnly:!0})],we.prototype,"layerScaleEnabled",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],we.prototype,"suspended",void 0),(0,f.e)([(0,f.d)({readOnly:!0})],we.prototype,"updating",void 0),we=(0,f.e)([(0,f.n)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],we);var ke="terrain-events",Ee=we},55985:function(e,t,i){i.d(t,{h:function(){return c}});var r=i(60136),n=i(29388),a=i(37762),s=i(15671),o=i(43144),l=i(50165),h=i(18392),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,i=arguments.length>1?arguments[1]:void 0;(0,s.Z)(this,e),this.compareMinX=y,this.compareMinY=f,this._toBBox=function(e){return e},this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&("function"==typeof i?this._toBBox=i:this._initFormat(i)),this.clear()}return(0,o.Z)(e,[{key:"destroy",value:function(){this.clear(),x.prune(),w.prune(),G.prune(),k.prune()}},{key:"all",value:function(e){this._all(this.data,e)}},{key:"search",value:function(e,t){var i=this.data,r=this._toBBox;if(S(e,i))for(x.clear();i;){for(var n=0,a=i.children.length;n<a;n++){var s=i.children[n],o=i.leaf?r(s):s;S(e,o)&&(i.leaf?t(s):_(e,o)?this._all(s,t):x.push(s))}i=x.pop()}}},{key:"collides",value:function(e){var t=this.data,i=this._toBBox;if(!S(e,t))return!1;for(x.clear();t;){for(var r=0,n=t.children.length;r<n;r++){var a=t.children[r],s=t.leaf?i(a):a;if(S(e,s)){if(t.leaf||_(e,s))return!0;x.push(a)}}t=x.pop()}return!1}},{key:"load",value:function(e){if(!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var r=this._build(e.slice(0,e.length),0,e.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var n=this.data;this.data=r,r=n}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this}},{key:"insert",value:function(e){return e&&this._insert(e,this.data.height-1),this}},{key:"clear",value:function(){return this.data=new R([]),this}},{key:"remove",value:function(e){if(!e)return this;var t,i=this.data,r=null,n=0,a=!1,s=this._toBBox(e);for(G.clear(),k.clear();i||G.length>0;){var o;if(i||(i=(0,l.q)(G.pop()),r=G.data[G.length-1],n=null!==(o=k.pop())&&void 0!==o?o:0,a=!0),i.leaf&&-1!==(t=(0,l.bk)(i.children,e,i.children.length,i.indexHint)))return i.children.splice(t,1),G.push(i),this._condense(G),this;a||i.leaf||!_(i,s)?r?(n++,i=r.children[n],a=!1):i=null:(G.push(i),k.push(n),n=0,r=i,i=i.children[0])}return this}},{key:"toJSON",value:function(){return this.data}},{key:"fromJSON",value:function(e){return this.data=e,this}},{key:"_all",value:function(e,t){var i=e;for(w.clear();i;){var r;if(!0===i.leaf){var n,s=(0,a.Z)(i.children);try{for(s.s();!(n=s.n()).done;){t(n.value)}}catch(o){s.e(o)}finally{s.f()}}else w.pushArray(i.children);i=null!==(r=w.pop())&&void 0!==r?r:null}}},{key:"_build",value:function(e,t,i,r){var n=i-t+1,a=this._maxEntries;if(n<=a){var s=new R(e.slice(t,i+1));return u(s,this._toBBox),s}r||(r=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/Math.pow(a,r-1)));var o=new I([]);o.height=r;var l=Math.ceil(n/a),h=l*Math.ceil(Math.sqrt(a));C(e,t,i,h,this.compareMinX);for(var c=t;c<=i;c+=h){var d=Math.min(c+h-1,i);C(e,c,d,l,this.compareMinY);for(var p=c;p<=d;p+=l){var y=Math.min(p+l-1,d);o.children.push(this._build(e,p,y,r-1))}}return u(o,this._toBBox),o}},{key:"_chooseSubtree",value:function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){for(var n=void 0,a=1/0,s=1/0,o=0,l=t.children.length;o<l;o++){var h=t.children[o],c=g(h),u=m(e,h)-c;u<s?(s=u,a=c<a?c:a,n=h):u===s&&c<a&&(a=c,n=h)}t=n||t.children[0]}return t}},{key:"_insert",value:function(e,t,i){var r=this._toBBox,n=i?e:r(e);G.clear();var a=this._chooseSubtree(n,this.data,t,G);for(a.children.push(e),p(a,n);t>=0&&G.data[t].children.length>this._maxEntries;)this._split(G,t),t--;this._adjustParentBBoxes(n,G,t)}},{key:"_split",value:function(e,t){var i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);var a=this._chooseSplitIndex(i,n,r);if(a){var s=i.children.splice(a,i.children.length-a),o=i.leaf?new R(s):new I(s);o.height=i.height,u(i,this._toBBox),u(o,this._toBBox),t?e.data[t-1].children.push(o):this._splitRoot(i,o)}else console.log("  Error: assertion failed at PooledRBush._split: no valid split index")}},{key:"_splitRoot",value:function(e,t){this.data=new I([e,t]),this.data.height=e.height+1,u(this.data,this._toBBox)}},{key:"_chooseSplitIndex",value:function(e,t,i){var r,n,a;r=n=1/0;for(var s=t;s<=i-t;s++){var o=d(e,0,s,this._toBBox),l=d(e,s,i,this._toBBox),h=b(o,l),c=g(o)+g(l);h<r?(r=h,a=s,n=c<n?c:n):h===r&&c<n&&(n=c,a=s)}return a}},{key:"_chooseSplitAxis",value:function(e,t,i){var r=e.leaf?this.compareMinX:y,n=e.leaf?this.compareMinY:f;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)}},{key:"_allDistMargin",value:function(e,t,i,r){e.children.sort(r);for(var n=this._toBBox,a=d(e,0,t,n),s=d(e,i-t,i,n),o=v(a)+v(s),l=t;l<i-t;l++){var h=e.children[l];p(a,e.leaf?n(h):h),o+=v(a)}for(var c=i-t-1;c>=t;c--){var u=e.children[c];p(s,e.leaf?n(u):u),o+=v(s)}return o}},{key:"_adjustParentBBoxes",value:function(e,t,i){for(var r=i;r>=0;r--)p(t.data[r],e)}},{key:"_condense",value:function(e){for(var t=e.length-1;t>=0;t--){var i=e.data[t];if(0===i.children.length)if(t>0){var r=e.data[t-1],n=r.children;n.splice((0,l.bk)(n,i,n.length,r.indexHint),1)}else this.clear();else u(i,this._toBBox)}}},{key:"_initFormat",value:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}]),e}();function u(e,t){d(e,0,e.children.length,t,e)}function d(e,t,i,r,n){n||(n=new R([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var a,s=t;s<i;s++)a=e.children[s],p(n,e.leaf?r(a):a);return n}function p(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function y(e,t){return e.minX-t.minX}function f(e,t){return e.minY-t.minY}function g(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function v(e){return e.maxX-e.minX+(e.maxY-e.minY)}function m(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function b(e,t){var i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),a=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,a-r)}function _(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function S(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function C(e,t,i,r,n){for(var a=[t,i];a.length;){var s=(0,l.q)(a.pop()),o=(0,l.q)(a.pop());if(!(s-o<=r)){var c=o+Math.ceil((s-o)/r/2)*r;(0,h.a)(e,c,o,s,n),a.push(o,c,c,s)}}}var x=new l.ay,w=new l.ay,G=new l.ay,k=new l.ay({deallocator:void 0}),E=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).height=1,e.indexHint=new l.bl,e}return(0,o.Z)(i)}((0,o.Z)((function e(){(0,s.Z)(this,e),this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}))),R=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this)).children=e,r.leaf=!0,r}return(0,o.Z)(i)}(E),I=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this)).children=e,r.leaf=!1,r}return(0,o.Z)(i)}(E)},43750:function(e,t,i){i.d(t,{i:function(){return s}});var r=i(50165),n=i(13089),a=i(2326),s={getObjectId:function(e){return e.objectId},getAttributes:function(e){return e.attributes},getAttribute:function(e,t){return e.attributes[t]},cloneWithGeometry:function(e,t){return new a.s(t,e.attributes,null,e.objectId)},getGeometry:function(e){return e.geometry},getCentroid:function(e,t){return(0,r.t)(e.centroid)&&(e.centroid=(0,n.e)(new a.t,e.geometry,t.hasZ,t.hasM)),e.centroid}}},8180:function(e,t,i){i.d(t,{o:function(){return a},t:function(){return s}});var r=i(50165),n=i(38419);function a(e){return(0,r.t)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function s(e){if((0,r.t)(e))return null;if(!a(e))return new r.a("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(e.type||e.declaredClass,"'"),{renderer:e});switch(e.type){case"simple":return o(t=e,(0,n.a)(t.symbol).error);case"unique-value":return function(e){var t=e.uniqueValueInfos.map((function(e){return(0,n.a)(e.symbol).error})).filter((function(e){return!!e})),i=(0,n.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),o(e,t)}(e);case"class-breaks":return function(e){var t=e.classBreakInfos.map((function(e){return(0,n.a)(e.symbol).error})).filter((function(e){return!!e})),i=(0,n.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),o(e,t)}(e);case"dictionary":case"heatmap":return null}var t;return null}function o(e,t){if(!t)return null;var i;if((i=Array.isArray(t)?t:[t]).length>0){var n=i.map((function(e){return e.details.symbol.type||e.details.symbol.declaredClass})).filter((function(e){return!!e}));n.sort();var a=[];return n.forEach((function(e,t){0!==t&&e===n[t-1]||a.push(e)})),new r.a("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(a.join(", "),") which are not supported in 3D"),{renderer:e,symbolErrors:i})}return null}}}]);
//# sourceMappingURL=8360.0ffbc8e7.chunk.js.map