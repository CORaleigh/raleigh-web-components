"use strict";(self.webpackChunkraleighnc_web_component=self.webpackChunkraleighnc_web_component||[]).push([[3804],{17802:function(e,t,r){r.d(t,{s:function(){return a}});var n=r(37762),i=r(15671),s=r(43144),o=r(75610),a=function(){function e(t){(0,i.Z)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return(0,s.Z)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,r=(0,n.Z)(this._buffer);try{for(r.s();!(t=r.n()).done;){var i=t.value;if((0,o.r)(i)&&e(i))return i}}catch(s){r.e(s)}finally{r.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,o.r)(t);)e&&e(t),t=this.dequeue()}}]),e}()},53804:function(e,t,r){r.d(t,{h:function(){return I},t:function(){return A}});var n,i,s=r(1413),o=r(74165),a=r(15861),u=r(60136),c=r(29388),h=r(37762),f=r(15671),d=r(43144),l=r(17802),v=r(2760),p=r(75610),_=r(23132),y=(r(91204),r(57714)),k=r(69953),g=r(80175),b=r(97033),m=r(27597),w=r(34860),x=r(30604),S=r(30709),Z="__esri_stream_id__",F="__esri_timestamp__",I=function(){function e(t,r,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;(0,f.Z)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=i,this.store=t,this.objectIdField=r,this.purgeInterval=s,this._useGeneratedIds=this.objectIdField===Z}return(0,d.Z)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,p.t)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new l.s(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=(0,p.r)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,i=(0,v.o)(n,0,1e3);this._trackIdToObservations.set(r,new l.s(i))}var s=this._trackIdToObservations.get(r).enqueue(e.objectId);(0,p.r)(s)&&(this._addOrUpdated.has(s)?this._addOrUpdated.delete(s):this._removed.push(s))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if((0,p.r)(t)){var i,s=(0,h.Z)(t);try{for(s.s();!(i=s.n()).done;){var o=i.value,a=this.store.removeById(o);(0,p.r)(a)&&n.push(a)}}catch(d){s.e(d)}finally{s.f()}}if((0,p.r)(e)){var u,c=(0,h.Z)(e);try{for(c.s();!(u=c.n()).done;){var f=u.value;f.attributes[F]=r,this.store.add(f)}}catch(d){c.e(d)}finally{c.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;(0,p.r)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r,n=(0,h.Z)(this._trackIdToObservations.values());try{for(n.s();!(r=n.n()).done;){var i=r.value;if(t>e.displayCount&&i.size){var s=(0,p.e)(i.dequeue());this._removed.push(s),t--}}}catch(u){n.e(u)}finally{n.f()}}if((0,p.r)(this._trackIdLessObservations))for(var o=t-e.displayCount;o-- >0;){var a=this._trackIdLessObservations.dequeue();(0,p.r)(a)&&this._removed.push(a)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!==(t=this._timeInfo)&&void 0!==t&&t.startTimeField){var n=60*e.age*1e3,i=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<i&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes[F]<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}(),O=function(e){(0,u.Z)(r,e);var t=(0,c.Z)(r);function r(){return(0,f.Z)(this,r),t.apply(this,arguments)}return(0,d.Z)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(g.n.EventedMixin(b.d)),C=O=(0,_.e)([(0,_.n)("esri.layers.graphics.sources.connections.StreamConnection")],O),R=_.s.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(i=n||(n={}))[i.CONNECTING=0]="CONNECTING",i[i.OPEN=1]="OPEN",i[i.CLOSING=2]="CLOSING",i[i.CLOSED=3]="CLOSED";var T=function(e){(0,u.Z)(r,e);var t=(0,c.Z)(r);function r(e){var n;(0,f.Z)(this,r),(n=t.call(this)).errorString=null;var i=e.geometryType,s=e.spatialReference,o=e.sourceSpatialReference;return n._config=e,n._featureZScaler=(0,k.o)(i,o,s),n._open(),n}return(0,d.Z)(r,[{key:"_open",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(){return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,p.r)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if((0,p.t)(this._websocket))return"disconnected";switch(this._websocket.readyState){case n.CONNECTING:case n.OPEN:return"connected";case n.CLOSING:case n.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(){var t,r,n,i,s,a=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:this._config.source.path,r=a.length>1&&void 0!==a[1]?a[1]:1e3,n=a.length>2&&void 0!==a[2]?a[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return i=(0,y.B)(t,this._config.customParameters),e.next=9,this._createWebSocket(i);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),s=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(R.error(new _.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return R.error(new _.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(s,"s"),e.t0)),e.next=23,(0,_.L)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var i=new WebSocket(e);i.onopen=function(){if(i.onopen=null,t.destroyed)return i.onclose=null,void i.close();i.onclose=function(e){return t._onClose(e)},i.onerror=function(e){return t._onError(e)},i.onmessage=function(e){return t._onMessage(e)},r(i)},i.onclose=function(e){i.onopen=i.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(){var t,r,n,i,s,a,u,c,h=this,f=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=f.length>0&&void 0!==f[0]?f[0]:1e4,r=this._websocket,!(0,p.t)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=(0,_.ap)(),i=r.onmessage,s=this._config,a=s.filter,u=s.outFields,c=s.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,s=null;try{s=JSON.parse(e.data)}catch(C){}s&&"object"==typeof s||(R.error(new _.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),h.destroy()),(null===(t=s.spatialReference)||void 0===t?void 0:t.wkid)!==(null===c||void 0===c?void 0:c.wkid)&&(R.error(new _.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(c.wkid),e.data)),n.reject(),h.destroy()),"json"!==s.format&&(R.error(new _.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),h.destroy()),a&&s.filter!==a&&R.error(new _.a("websocket-connection","Tried to set filter, but server doesn't support it")),u&&s.outFields!==u&&R.error(new _.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i,n.resolve()},r.send(JSON.stringify({filter:a,outFields:u,format:"json",spatialReference:{wkid:c.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new _.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=(0,h.Z)(t.features);try{for(n.s();!(r=n.n()).done;){var i=r.value;(0,p.r)(this._featureZScaler)&&this._featureZScaler(i.geometry),this.onFeature(i)}}catch(s){n.e(s)}finally{n.f()}}catch(Z){return R.error(new _.a("websocket-connection","Failed to parse message",Z)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),R.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&R.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(C);(0,_.e)([(0,_.d)()],T.prototype,"connectionStatus",null),(0,_.e)([(0,_.d)()],T.prototype,"errorString",void 0),T=(0,_.e)([(0,_.n)("esri.layers.graphics.sources.connections.WebSocketConnection")],T);var E=_.s.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),j={maxQueryDepth:5,maxRecordCountFactor:3},q=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e){return(0,f.Z)(this,n),t.call(this,(0,s.Z)((0,s.Z)({},j),e))}return(0,d.Z)(n,[{key:"_open",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(){var t,r,n,i,s;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||E.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,i=n.filter,s=n.outFields,this.destroyed||this._setFilter(i,s);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),(0,p.r)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(Z){return void E.error(new _.a("geoevent-connection","Failed to parse message",Z))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t){var r,n,i;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,s.Z)({f:"json"},this._config.customParameters),n=(0,y.U)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return i=e.sent.data,e.abrupt("return",(this._serviceDefinition=i,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,i=r.token,s=this._inferWebSocketBaseUrl(n);return(0,y.B)("".concat(s,"/subscribe"),{outSR:""+t.wkid,token:i})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=(0,h.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.includes("wss"))return n}}catch(i){r.e(i)}finally{r.f()}return E.error(new _.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t,r){var n,i,s,a,u,c,h=this;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!((0,p.t)(n)||(0,p.t)(t)&&(0,p.t)(r))){e.next=3;break}return e.abrupt("return");case 3:return i=JSON.stringify({filter:this._serializeFilter(t,r)}),s=!1,a=(0,_.ap)(),u=function(){s||(h.destroyed||h._websocket!==n||E.error(new _.a("geoevent-connection","Server timed out when setting filter")),a.reject())},c=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(E.error(new _.a("geoevent-connection","Failed to set service filter",t.error)),h._set("errorString","Could not set service filter - ".concat(t.error)),a.reject(t.error)),n.onmessage=h._onMessage.bind(h),s=!0,a.resolve())},e.abrupt("return",(n.onmessage=c,n.send(i),setTimeout(u,1e4),a.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if((0,p.t)(e)&&(0,p.t)(t))return r;if((0,p.r)(e)&&e.geometry)try{var n=(0,x.d)(e.geometry);if("extent"!==n.type)throw new _.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(i){E.error(new _.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",i))}return(0,p.r)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),(0,p.r)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return E.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,s=n.geometry;for(var o in i)e.attributes[o]=i[o];return s&&(e.geometry=s),e.geometry||e.centroid||E.error(new _.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(){var t,r,n,i,s,a,u,c,f;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,i=this._queryRelatedFeatures(r),s=this._queryArchive(n),e.next=4,i;case 4:return e.next=6,s;case 6:if(a=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=(0,h.Z)(a.features);try{for(u.s();!(c=u.n()).done;)f=c.value,this.onFeature(this._enrich(f))}catch(o){u.e(o)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),E.error(new _.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t){var r;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t){return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t){var n,i,s,a,u,c,h,f,d,l,v;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(2029),r.e(3024),r.e(4980),r.e(1451),r.e(7154),r.e(407),r.e(9680),r.e(8392),r.e(3703),r.e(8875),r.e(4575),r.e(1099),r.e(7794)]).then(r.bind(r,74575)).then((function(e){return e.F}));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(i=e.sent,s=i.capabilities,a=s.query.supportsMaxRecordCountFactor,u=s.query.supportsPagination,c=s.query.supportsCentroid,h=this._config.maxRecordCountFactor,f=n.capabilities.query.maxRecordCount,d=a?f*h:f,(l=new w.b).outFields=(0,p.n)(this._config.outFields,["*"]),l.where=(0,p.n)((0,p.p)(this._config.filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=S.k.fromJSON(this._config.spatialReference),c&&(l.returnCentroid=!0),a&&(l.maxRecordCountFactor=h),!u){e.next=18;break}return e.abrupt("return",(l.num=d,n.destroy(),this._queryPages(t,l)));case 18:return e.next=20,(0,m.c)(t,l,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=(0,a.Z)((0,o.Z)().mark((function e(t,r){var n,i,s,a,u=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.length>2&&void 0!==u[2]?u[2]:[],i=u.length>3&&void 0!==u[3]?u[3]:0,r.start=(0,p.r)(r.num)?i*r.num:null,e.next=5,(0,m.c)(t,r,this._config.sourceSpatialReference);case 5:return s=e.sent,a=s.data,e.abrupt("return",a.exceededTransferLimit&&i<this._config.maxQueryDepth?(a.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,i+1)):(n.forEach((function(e){return a.features.push(e)})),a));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,i=this._serviceDefinition.relatedFeatures.joinField,s=(0,h.Z)(n);try{for(s.s();!(t=s.n()).done;){var o=t.value,a=o.attributes[i];r.set(a,o)}}catch(u){s.e(u)}finally{s.f()}this._relatedFeatures=r}}]),n}(T),N=q=(0,_.e)([(0,_.n)("esri.layers.graphics.sources.connections.GeoEventConnection")],q);function A(e,t,r,n,i,s,o,a){var u=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),c={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:i,maxReconnectionAttempts:s,maxReconnectionInterval:o,customParameters:a};return u?new T(c):new N(c)}}}]);
//# sourceMappingURL=3804.aa4ec9ef.chunk.js.map